// @ts-nocheck
/* eslint-disable */

import React, {
  useEffect,
  useMemo,
  useRef,
  useState,
  createContext,
  useContext,
  useCallback,
} from "react";
import {
  BrowserRouter as Router,
  Routes,
  Route,
  NavLink,
  useNavigate,
  useLocation,
  useParams,
} from "react-router-dom";
import { apiClient, inferRPCInputType, inferRPCOutputType } from "~/client/api";
import {
  useQuery,
  useMutation,
  useQueryClient,
  QueryClient,
  QueryClientProvider,
  Hydrate,
  dehydrate,
  type DehydratedState,
} from "@tanstack/react-query";
import {
  useAuth,
  useToast,
  encodeFileAsBase64DataURL,
  getBaseUrl,
  useRealtimeMutation,
  useRealtimeStore,
} from "~/client/utils";
import {
  Button,
  Card,
  CardHeader,
  CardTitle,
  CardDescription,
  CardContent,
  CardFooter,
  Input,
  Label,
  Textarea,
  Alert,
  AlertDescription,
  AlertTitle,
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
  Badge,
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
  DialogDescription,
  DialogTrigger,
  DialogClose,
  Switch,
  Checkbox,
  Table,
  TableBody,
  TableCaption,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
  ScrollArea,
  ScrollBar,
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
  Progress,
} from "~/components/ui";
import {
  ShieldCheck,
   Mail,
   User2,
   Building2,
   Briefcase,
   CalendarClock,
   CalendarDays,
   CalendarRange,
   TimerReset,
   AlertTriangle,
   Image as ImageIcon,
   Save,
   Search,
   Download,
   FileText,
   FolderPlus,
   Folder as FolderIcon,
   HardHat,} from "lucide-react";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
  Accordion,
  AccordionContent,
  AccordionItem,
  AccordionTrigger,
} from "~/components/ui";
import copy from "copy-to-clipboard";
import QRCode from "qrcode";
import { jsPDF } from "jspdf";
import html2canvas from "html2canvas";
// removed heavy html-docx-js-typescript from client bundle (moved to server)
import localforage from "localforage";
import ReactMarkdown from "react-markdown";
import debounce from "lodash/debounce";
import remarkGfm from "remark-gfm";
import * as pdfjsLib from "pdfjs-dist";

import * as XLSX from "xlsx";
import XLSX_CALC from "xlsx-calc";
import * as formulajs from "@formulajs/formulajs";
import { nanoid } from "nanoid";
/* Types from RPC */
type Profile = inferRPCOutputType<"getMyProfile">;
type UpsertProfileInput = inferRPCInputType<"upsertMyProfile">;
type SetUserAccessInput = inferRPCInputType<"setUserAccess">;
type Stats = inferRPCOutputType<"getViolationStats"> & {
  byHazardFactor?: { label: string; count: number }[];
  observationsByAuthorDetailed?: {
    key: string;
    label: string;
    total: number;
    resolved: number;
    inProgress: number;
    overdue: number;
  }[];
};
type ViolationsPage = inferRPCOutputType<"listViolations">;
type StatsDrillPage = inferRPCOutputType<"listViolationsForStatsDrilldown">;
type MyViolationsPage = inferRPCOutputType<"listMyViolations">;
type MyStats = inferRPCOutputType<"getMyViolationsStats">;
type VisitSessionsPage = inferRPCOutputType<"listVisitSessions">;
type PrescriptionPage = inferRPCOutputType<"listPrescriptionRegister">;
// type MyVisitSummary = inferRPCOutputType<"getMyVisitSummary">;
type Presence = inferRPCOutputType<"getPresenceSummary">;
type JobTitleStats = inferRPCOutputType<"getJobTitleStats">;
// Home customization types
type MyAssignedSummary = inferRPCOutputType<"getMyAssignedViolationsSummary">;
// helper: simple beep
function playAttentionBeep() {
  try {
    const Ctx =
      (window as any).AudioContext || (window as any).webkitAudioContext;
    if (!Ctx) return;
    const ctx = new Ctx();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.type = "sine";
    osc.frequency.value = 880; // A5
    osc.connect(gain);
    gain.connect(ctx.destination);
    const now = ctx.currentTime;
    gain.gain.setValueAtTime(0.0001, now);
    gain.gain.exponentialRampToValueAtTime(0.2, now + 0.03);
    osc.start(now);
    // quick decay
    gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.3);
    osc.stop(now + 0.32);
  } catch {
    /* ignore */
  }
}

/* Utility: format date/time Russian locale */
function useTicker(ms = 1000) {
  const [now, setNow] = useState<Date>(() => new Date());
  useEffect(() => {
    const id = setInterval(() => setNow(new Date()), ms);
    return () => clearInterval(id);
  }, [ms]);
  return now;
}

function AccessRestrictionNotice({ blocked }: { blocked: boolean }) {
  const navigate = useNavigate();
  const [showNotice, setShowNotice] = useState<boolean>(blocked);
  const { data: me } = useQuery([
    "me",
  ], () => apiClient.getMyProfile(), {
    // Загружаем профиль только тогда, когда пользователь действительно заблокирован,
    // чтобы не делать лишних запросов при обычном использовании приложения.
    enabled: Boolean(blocked),
    staleTime: 60_000,
  });

  useEffect(() => {
    if (blocked) setShowNotice(true);
  }, [blocked]);

  return (
    <div className="max-w-3xl mx-auto p-4 sm:p-6">
      {blocked && showNotice && (
        <div
          className="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4"
          onClick={() => setShowNotice(false)}
        >
          <div
            className="bg-card text-card-foreground w-full max-w-md rounded-lg shadow-lg p-5"
            onClick={(e) => e.stopPropagation()}
          >
            <div className="text-base font-medium mb-2">
              Если вы заблокированы или не можете войти в приложение АСУБТ,
              обязательно обратитесь в отдел ОТ и ПБ
            </div>
            {typeof (me as any)?.shortId !== "undefined" && (
              <div className="text-sm text-muted-foreground mb-3">
                Ваш ID№: {(me as any).shortId}
              </div>
            )}
            <div className="flex justify-end">
              <Button size="sm" onClick={() => setShowNotice(false)}>
                Понятно
              </Button>
            </div>
          </div>
        </div>
      )}

      <Card className="card-elevated h-full">
        <CardHeader>
          <CardTitle>Доступ ограничен</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="text-muted-foreground">
            {blocked
              ? "Ваш аккаунт заблокирован администратором."
              : "Вход разрешён только в заданные даты. Обратитесь к администратору."}
          </div>
        </CardContent>
        <CardFooter>
          <Button variant="secondary" onClick={() => navigate("/")}>
            На главную
          </Button>
        </CardFooter>
      </Card>
    </div>
  );
}

// Offline manager context and helpers
type OfflineTask = {
  id: string;
  type: "rpc";
  endpoint: keyof typeof apiClient;
  payload: any;
  createdAt: number;
};

type OfflineContextType = {
  isOnline: boolean;
  pending: number;
  syncing: boolean;
  enqueue: (task: OfflineTask) => Promise<void>;
  syncNow: () => Promise<void>;
};
const OfflineCtx = createContext<OfflineContextType | null>(null);
const useOffline = () => {
  const ctx = useContext(OfflineCtx);
  if (!ctx) throw new Error("Offline context not available");
  return ctx;
};
const lfGet = async <T,>(key: string, fallback: T): Promise<T> => {
  try {
    const v = await localforage.getItem<T>(key);
    return (v as T) ?? fallback;
  } catch {
    return fallback;
  }
};
const lfSet = async <T,>(key: string, val: T) => {
  try {
    await localforage.setItem(key, val as any);
  } catch {
    /* ignore */
  }
};

function OfflineProvider({ children }: { children: React.ReactNode }) {
  const [isOnline, setIsOnline] = useState<boolean>(
    typeof navigator !== "undefined" ? navigator.onLine : true,
  );
  const [pending, setPending] = useState<number>(0);
  const [syncing, setSyncing] = useState<boolean>(false);
  const queueKey = "offlineQueue.v1";
  const queryClient = useQueryClient();

  useEffect(() => {
    const on = () => setIsOnline(true);
    const off = () => setIsOnline(false);
    window.addEventListener("online", on);
    window.addEventListener("offline", off);
    return () => {
      window.removeEventListener("online", on);
      window.removeEventListener("offline", off);
    };
  }, []);

  useEffect(() => {
    (async () => {
      const q = await lfGet<OfflineTask[]>(queueKey, []);
      setPending(q.length);
    })();
  }, []);

  const enqueue = useCallback(async (task: OfflineTask) => {
    const q = await lfGet<OfflineTask[]>(queueKey, []);
    q.push(task);
    await lfSet(queueKey, q);
    setPending(q.length);
  }, []);

  const syncNow = useCallback(async () => {
    const q = await lfGet<OfflineTask[]>(queueKey, []);
    if (!q.length || !isOnline || syncing) return;
    setSyncing(true);
    let rest = q.slice();
    try {
      while (rest.length && isOnline) {
        const t = rest[0]!;
        try {
          // @ts-ignore dynamic rpc call
          await (apiClient as any)[t.endpoint](t.payload);
          rest.shift();
          await lfSet(queueKey, rest);
          setPending(rest.length);
        } catch {
          break;
        }
      }
    } finally {
      setSyncing(false);
    }
  }, [isOnline, syncing]);

  useEffect(() => {
    if (!isOnline) return;
    void syncNow();
    try {
      const nav: any = navigator as any;
      const c = nav?.connection || nav?.mozConnection || nav?.webkitConnection;
      const saveData = !!c?.saveData;
      const et = c?.effectiveType || "";
      const down = typeof c?.downlink === "number" ? c.downlink : 10;
      const low = saveData || et === "slow-2g" || et === "2g" || down < 1.5;
      if (!low) {
        void queryClient.refetchQueries({ type: "active", stale: true });
      }
    } catch {
      // On reconnect, avoid heavy global refetch if environment info is unavailable
    }
  }, [isOnline, syncNow, queryClient]);
  return (
    <OfflineCtx.Provider
      value={{ isOnline, pending, syncing, enqueue, syncNow }}
    >
      {children}
    </OfflineCtx.Provider>
  );
}

function OfflineStatus() {
  const { isOnline, pending, syncing, syncNow } = useOffline();
  return (
    <div className="flex items-center gap-2 text-xs">
      <span className={isOnline ? "text-green-600" : "text-red-600"}>
        {isOnline ? "Онлайн" : "Офлайн"}
      </span>
      {pending > 0 && (
        <button
          className="px-2 py-1 rounded border text-foreground bg-secondary hover:bg-accent"
          onClick={() => void syncNow()}
          disabled={!isOnline || syncing}
        >
          {syncing ? "Синхронизация…" : `Очередь: ${pending}`}
        </button>
      )}
    </div>
  );
}

function AppHeader() {
  const auth = useAuth();
  const navigate = useNavigate();
  const location = useLocation();
  const { isOnline } = useOffline();
  const { data: me } = useQuery<Profile>(
    ["me"],
    () => apiClient.getMyProfile(),
    {
      enabled: auth.status === "authenticated" && isOnline,
      staleTime: 60_000,
      refetchOnWindowFocus: false,
    },
  );

  async function handleGoHome() {
    try {
      sessionStorage.setItem("stayOnAuthAfterExit", "1");
      sessionStorage.removeItem("pendingSignIn");
    } catch {
      /* ignore */
    }
    try {
    } catch {
      /* ignore */
    }
    try {
      localStorage.removeItem("profileDraft");
    } catch {
      /* ignore */
    }
    navigate("/");
  }

  return (
    <header className="fixed inset-x-0 top-0 z-50 border-b bg-background/80 backdrop-blur supports-[backdrop-filter]:bg-background/60 print-hidden">
      <div className="max-w-5xl mx-auto px-4 h-14 flex items-center justify-between">
        <div className="flex items-center gap-2">
          <span className="hidden" />
          <ShieldCheck className="h-5 w-5 text-primary" />
          <span className="font-semibold tracking-tight">АСУБТ</span>
        </div>
        <nav className="hidden sm:flex items-center gap-2">
          <OfflineStatus />
          {auth.status !== "authenticated" ? (
            <>
              <Button
                variant="secondary"
                size="sm"
                onClick={() => auth.signIn({ provider: "AC1" })}
              >
                Войти
              </Button>
              <NavLink
                to="/"
                className="text-sm text-muted-foreground hover:text-foreground"
              >
                Страница входа
              </NavLink>
            </>
          ) : (
            <>
              {me?.isSuperAdmin && (
                <NavLink
                  to="/super-admin"
                  className="text-sm text-muted-foreground hover:text-foreground"
                >
                  Супер админ
                </NavLink>
              )}
              {me?.isAdmin && (
                <NavLink
                  to="/admin"
                  className="text-sm text-muted-foreground hover:text-foreground"
                >
                  Админ
                </NavLink>
              )}
              {false && (
                <NavLink
                  to="/super-admin"
                  className="text-sm text-muted-foreground hover:text-foreground"
                >
                  Супер-админ
                </NavLink>
              )}{" "}
              <Button
                variant="ghost"
                size="sm"
                className="text-sm"
                onClick={handleGoHome}
              >
                На главную              </Button>
            </>
          )}
          {location.pathname !== "/" && (
            <>
              <span className="text-muted-foreground/50">/</span>
              <NavLink
                to="/home"
                className="text-sm text-muted-foreground hover:text-foreground"
              >
                Главная
              </NavLink>
            </>
          )}
        </nav>
      </div>
    </header>
  );
}

/* AUTH SCREEN */
function AuthScreen() {
  const auth = useAuth(); // not required; shows unauthenticated by default
  const { toast } = useToast();
  const navigate = useNavigate();
  const { isOnline } = useOffline();

  const [linkSent, setLinkSent] = useState(false);
  const [authMode, setAuthMode] = useState<"login" | "register">("login");
  const [openingLogin, setOpeningLogin] = useState(false);
  const checkEmailMutation = useMutation(apiClient.isEmailRegistered);

  // Иллюстрация для мобильного экрана входа
  const { data: illustration } = useQuery(
    ["login-illustration"],
    () => apiClient.getLoginIllustrationUrl(),
    { staleTime: 3_600_000, enabled: isOnline },
  );
  const [hideIllustration, setHideIllustration] = useState(false);
  const sendLink = useMutation(apiClient.sendRegistrationLink, {
    onSuccess: (res: { ok: boolean; error?: string }) => {
      if (res?.ok) {
        setLinkSent(true);
        try {
          sessionStorage.setItem("pendingSignIn", "1");
        } catch {
          /* ignore */
        }
        // Открываем системную панель подтверждения кода (email‑OTP)
        // Отключаем автоматическое открытие OTP, т.к. теперь пользователь переходит по ссылке из письма на страницу приветствия
        // auth.signIn({ provider: "AC1", email });
        toast({
          title: "Ссылка отправлена",
          description:
            "Проверьте почту или подтвердите код в открывшемся окне, чтобы войти.",
        });
      } else {
        toast({
          title: "Не удалось отправить ссылку",
          description: "Проверьте данные и попробуйте ещё раз.",
        });
      }
    },
    onError: () => {
      toast({
        title: "Ошибка",
        description: "Не удалось отправить ссылку. Попробуйте позже.",
      });
    },
  });

  const [fullName, setFullName] = useState("");
  const [company, setCompany] = useState("");
  const [department, setDepartment] = useState("");
  const [jobTitle, setJobTitle] = useState("");
  const [email, setEmail] = useState("");
  const [emailRegistered, setEmailRegistered] = useState<boolean | null>(null);
  const debouncedCheckEmail = useMemo(
    () =>
      debounce(async (value: string) => {
        const valid = /\S+@\S+\.\S+/.test(value);
        if (!valid) {
          setEmailRegistered(null);
          return;
        }
        try {
          const res = await checkEmailMutation.mutateAsync({ email: value });
          setEmailRegistered(!!(res as any)?.exists);
        } catch {
          setEmailRegistered(null);
        }
      }, 500),
    [checkEmailMutation],
  );

  const isEmailValid = useMemo(() => /\S+@\S+\.\S+/.test(email), [email]);
  const isFormComplete = useMemo(
    () =>
      Boolean(fullName && company && department && jobTitle && isEmailValid),
    [fullName, company, department, jobTitle, isEmailValid],
  );

  const canQuickLogin = isEmailValid && emailRegistered === true;

  // Login-only form state

  // После подтверждения кода (успешного входа) перенаправляем на главную
  useEffect(() => {
    if (auth.status === "authenticated") {
      let stayOnAuth = false;
      try {
        stayOnAuth = sessionStorage.getItem("stayOnAuthAfterExit") === "1";
      } catch {
        /* ignore */
      }

      // Always clear temporary flags unrelated to auth flow
      try {
        sessionStorage.removeItem("pendingSignIn");
      } catch {
        /* ignore */
      }
      try {
        localStorage.removeItem("profileDraft");
      } catch {
        /* ignore */
      }

      // If the user pressed «На главную», keep them on the auth screen
      // so they can switch account or request a magic link, even if the
      // session is still authenticated.
      if (!stayOnAuth) {
        navigate("/home");
      }
    }
  }, [auth.status, navigate]);

  const onSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    const draft = { fullName, company, department, jobTitle, email };
    try {
      localStorage.setItem("profileDraft", JSON.stringify(draft));
      sessionStorage.removeItem("justLoggedOut");
    } catch {
      /* ignore */
    }

    if (!isEmailValid) {
      toast({
        title: "Неверный email",
        description: "Пожалуйста, введите корректный адрес электронной почты.",
      });
      return;
    }

    // Send magic login link via email and pre-save profile
    sendLink.mutate({ email, fullName, company, department, jobTitle });
  };

  return (
    <div className="min-h-[calc(100vh-3.5rem)] bg-background">
      <div className="max-w-lg mx-auto p-4 sm:p-6">
        {illustration?.url && !hideIllustration && (
          <div className="sm:hidden mb-4 flex justify-center">
            <img
              src={illustration.url}
              alt="Иллюстрация входа"
              className="w-full max-w-xs h-auto rounded-lg shadow"
              loading="lazy"
              onError={() => setHideIllustration(true)}
            />
          </div>
        )}
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle className="text-xl">Вход / Регистрация</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            {auth.status === "loading" && (
              <Alert>
                <AlertTitle>Загрузка сессии…</AlertTitle>
                <AlertDescription>
                  Пожалуйста, подождите. Проверяем состояние входа.
                </AlertDescription>
              </Alert>
            )}

            {/* Переключатель режимов: быстрый вход или регистрация */}
            {canQuickLogin ? (
              <div className="grid grid-cols-2 gap-2">
                <Button
                  variant={authMode === "login" ? "secondary" : "outline"}
                  onClick={() => setAuthMode("login")}
                >
                  Быстрый вход
                </Button>
                <Button
                  variant={authMode === "register" ? "secondary" : "outline"}
                  onClick={() => setAuthMode("register")}
                >
                  Регистрация
                </Button>
              </div>
            ) : (
              <div>
                <Button
                  variant={authMode === "register" ? "secondary" : "outline"}
                  onClick={() => setAuthMode("register")}
                  className="w-full"
                >
                  Регистрация
                </Button>
              </div>
            )}

            {authMode === "login" && canQuickLogin ? (
              <div className="space-y-4">
                <div className="space-y-1.5">
                  <Label htmlFor="email">E-mail</Label>
                  <div className="relative">
                    <Mail className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                    <Input
                      id="email"
                      className="pl-9"
                      placeholder="name@example.com"
                      type="email"
                      inputMode="email"
                      value={email}
                      onChange={(e) => {
                        const v = e.target.value;
                        setEmail(v);
                        debouncedCheckEmail(v);
                      }}
                    />
                  </div>
                </div>
                <Button
                  className="w-full touch-target"
                  disabled={openingLogin}
                  onClick={async () => {
                    setOpeningLogin(true);
                    try {
                      // Clean any flags from previous auth flows
                      try {
                        sessionStorage.removeItem("stayOnAuthAfterExit");
                      } catch {
                        /* ignore */
                      }

                      if (!isEmailValid) {
                        toast({
                          title: "Неверный e‑mail",
                          description:
                            "Введите корректный адрес или перейдите на вкладку Регистрация.",
                        });
                        return;
                      }

                      // If already authenticated, go straight to Home
                      if (auth.status === "authenticated") {
                        navigate("/home");
                        return;
                      }

                      // Check that the email is registered before opening the sign-in drawer
                      let registered = false;
                      try {
                        const res = await checkEmailMutation.mutateAsync({
                          email,
                        });
                        registered = !!res?.exists;
                      } catch {
                        // Treat errors as not registered for safety
                        registered = false;
                      }

                      if (!registered) {
                        toast({
                          title: "E‑mail не зарегистрирован",
                          description:
                            "Проверьте адрес или пройдите регистрацию во вкладке Регистрация.",
                        });
                        return;
                      }

                      // Open the platform auth drawer prefilled with the email
                      auth.signIn({ provider: "AC1", email });
                    } finally {
                      setOpeningLogin(false);
                    }
                  }}
                >
                  {openingLogin ? "Открываем…" : "Войти"}
                </Button>
                <p className="text-xs text-muted-foreground text-center">
                  Введите e‑mail и нажмите «Войти» — подтвердите код из письма.
                </p>
              </div>
            ) : (
              <form onSubmit={onSubmit} className="space-y-4">
                <div className="grid grid-cols-1 gap-3">
                  <div className="space-y-1.5">
                    <Label htmlFor="fullName">ФИО</Label>
                    <div className="relative">
                      <User2 className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                      <Input
                        id="fullName"
                        className="pl-9"
                        placeholder="Иванов Иван Иванович"
                        value={fullName}
                        onChange={(e) => setFullName(e.target.value)}
                      />
                    </div>
                  </div>
                  <div className="space-y-1.5">
                    <Label htmlFor="company">Наименование компании</Label>
                    <div className="relative">
                      <Building2 className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                      <Input
                        id="company"
                        className="pl-9"
                        placeholder="ООО «Пример»"
                        value={company}
                        onChange={(e) => setCompany(e.target.value)}
                      />
                    </div>
                  </div>
                  <div className="space-y-1.5">
                    <Label htmlFor="department">Подразделение</Label>
                    <div className="relative">
                      <FolderIcon className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                      <Input
                        id="department"
                        className="pl-9"
                        placeholder="Напр. ЗИФ"
                        value={department}
                        onChange={(e) => setDepartment(e.target.value)}
                      />
                    </div>
                  </div>
                  <div className="space-y-1.5">
                    <Label htmlFor="jobTitle">Должность</Label>
                    <div className="relative">
                      <Briefcase className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                      <Input
                        id="jobTitle"
                        className="pl-9"
                        placeholder="Специалист по охране труда"
                        value={jobTitle}
                        onChange={(e) => setJobTitle(e.target.value)}
                      />
                    </div>
                  </div>
                  <div className="space-y-1.5">
                    <Label htmlFor="emailRegister">E-mail</Label>
                    <div className="relative">
                      <Mail className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                      <Input
                        id="emailRegister"
                        className="pl-9"
                        placeholder="name@example.com"
                        type="email"
                        inputMode="email"
                        value={email}
                        onChange={(e) => {
                          const v = e.target.value;
                          setEmail(v);
                          debouncedCheckEmail(v);
                        }}
                        required
                      />
                    </div>
                  </div>
                </div>
                <Button
                  className="w-full touch-target"
                  type="submit"
                  disabled={sendLink.isLoading || !isFormComplete}
                >
                  {sendLink.isLoading ? "Отправляем…" : "Зарегистрироваться"}
                </Button>
                {linkSent ? (
                  <p className="text-sm text-muted-foreground text-center">
                    Мы отправили ссылку для входа на {email}. Откройте письмо и
                    перейдите по ссылке.
                  </p>
                ) : (
                  <p className="text-xs text-muted-foreground text-center">
                    После нажатия «Зарегистрироваться» мы отправим ссылку для
                    входа на указанный e‑mail.
                  </p>
                )}
              </form>
            )}
          </CardContent>
        </Card>
        <div className="mt-8 text-center text-sm text-muted-foreground">
          <div className="hr-muted w-full h-px mb-4" />
          <p>
            После подтверждения e-mail вы автоматически перейдёте на главную
            страницу.
          </p>
        </div>
      </div>
    </div>
  );
}

/* HOME SCREEN (protected) */
function HomeScreen() {
  useAuth({ required: true });
  const navigate = useNavigate();
  const { isOnline } = useOffline();
  useEffect(() => {
    try {
      sessionStorage.removeItem("pendingSignIn");
      sessionStorage.removeItem("stayOnAuthAfterExit");
    } catch {
      /* ignore */
    }
  }, []);
  const now = useTicker(1000);
  const queryClient = useQueryClient();
  const { toast } = useToast();

  const location = useLocation();
  const params = useMemo(
    () => new URLSearchParams(location.search),
    [location.search],
  );
  const asUserId = params.get("as");

  const meQueryKey: any = asUserId ? ["admin-user", asUserId] : ["me"];
  const { data: profile, isInitialLoading } = useQuery<Profile>(
    meQueryKey,
    () =>
      asUserId
        ? apiClient.getUserProfileAdmin({ userId: asUserId as string })
        : apiClient.getMyProfile(),
    { staleTime: 60_000, refetchOnWindowFocus: false, enabled: isOnline },
  );

  type PabJobTitles = inferRPCOutputType<"getPabJobTitles">;
  const { data: pabTitles } = useQuery<PabJobTitles>(
    ["pab-job-titles"],
    () => apiClient.getPabJobTitles(),
    { staleTime: 60_000, enabled: isOnline },
  );

  const [selectedJobTitle, setSelectedJobTitle] = useState<string | "">("");
  // Жёсткая привязка показателей к должности из профиля
  useEffect(() => {
    const jt = profile?.jobTitle ?? "";
    if (jt && jt !== selectedJobTitle) {
      setSelectedJobTitle(jt);
    }
  }, [profile?.jobTitle, pabTitles?.titles, selectedJobTitle]);

  type PabPlan = inferRPCOutputType<"getPabPlanForJobTitle">;
  const { data: pabPlan, isFetching: planLoading } = useQuery<PabPlan>(
    ["pab-plan", selectedJobTitle],
    () => apiClient.getPabPlanForJobTitle({ jobTitle: selectedJobTitle }),
    { enabled: !!selectedJobTitle && isOnline, staleTime: 60_000 },
  );

  type PabFact = inferRPCOutputType<"getMyPabFact">;
  const { data: pabFact, isFetching: factLoading } = useQuery<PabFact>(
    ["pab-fact", new Date().getFullYear(), new Date().getMonth()],
    () => apiClient.getMyPabFact(),
    {
      enabled: isOnline,
      refetchInterval: isOnline ? 60_000 : false,
      staleTime: 30_000,
    },
  );

  const [shiftFrom, setShiftFrom] = useState<string>("");
  const [shiftTo, setShiftTo] = useState<string>("");

  const {
    shiftDays,
    shiftPlanAudits,
    shiftPlanObservations,
  } = useMemo(() => {
    const y = now.getFullYear();
    const m = now.getMonth();
    const daysInMonth = new Date(y, m + 1, 0).getDate();

    if (!shiftFrom || !shiftTo || !pabPlan?.planAudits || !pabPlan?.planObservations) {
      return {
        shiftDays: null as number | null,
        shiftPlanAudits: null as number | null,
        shiftPlanObservations: null as number | null,
      };
    }

    const from = new Date(shiftFrom);
    const to = new Date(shiftTo);
    if (Number.isNaN(from.getTime()) || Number.isNaN(to.getTime()) || to < from) {
      return {
        shiftDays: null as number | null,
        shiftPlanAudits: null as number | null,
        shiftPlanObservations: null as number | null,
      };
    }

    const diffMs = to.getTime() - from.getTime();
    const days = Math.floor(diffMs / 86400000) + 1;
    if (daysInMonth <= 0 || days <= 0) {
      return {
        shiftDays: null as number | null,
        shiftPlanAudits: null as number | null,
        shiftPlanObservations: null as number | null,
      };
    }

    const factor = days / daysInMonth;
    const rawAudits = (pabPlan.planAudits as number) * factor;
    const rawObservations = (pabPlan.planObservations as number) * factor;

    const roundCustom = (value: number) => {
      const rounded = Math.round(value);
      const diff = Math.abs(value - rounded);
      if (diff === 0.5) {
        return value < rounded ? Math.floor(value) : Math.ceil(value);
      }
      return rounded;
    };

    const audits = roundCustom(rawAudits);
    const observations = roundCustom(rawObservations);

    return {
      shiftDays: days,
      shiftPlanAudits: audits,
      shiftPlanObservations: observations,
    };
  }, [now, shiftFrom, shiftTo, pabPlan?.planAudits, pabPlan?.planObservations]);

  // My assigned prescriptions/violations summary
  const { data: assigned } = useQuery<MyAssignedSummary>(
    ["my-assigned-summary"],
    () => apiClient.getMyAssignedViolationsSummary(),
    {
      staleTime: 30_000,
      refetchInterval: isOnline ? 60_000 : false,
      enabled: isOnline,
      retry: (failureCount) => isOnline && failureCount < 2,
    },
  );
  const prevOverdueRef = useRef<number>(0);
  useEffect(() => {
    const ov = assigned?.overdue ?? 0;
    if (ov > 0 && prevOverdueRef.current === 0) {
      playAttentionBeep();
    }
    prevOverdueRef.current = ov;
  }, [assigned?.overdue]);

  // Load my prescriptions list on demand for the expandable block
  type ListMyPrescriptionsOut = inferRPCOutputType<"listMyPrescriptions">;
  const [selectedPrescFilter, setSelectedPrescFilter] = useState<
    "all" | "open" | "overdue" | null
  >(null);
  const { data: prescList, isFetching: prescListLoading } =
    useQuery<ListMyPrescriptionsOut>(
      ["my-prescriptions", selectedPrescFilter],
      () =>
        apiClient.listMyPrescriptions({
          filter: selectedPrescFilter || undefined,
        }),
      { enabled: !!selectedPrescFilter && isOnline, staleTime: 30_000 },
    );

  const { data: myOverdueList } = useQuery<ListMyPrescriptionsOut>(
    ["my-prescriptions-overdue"],
    () => apiClient.listMyPrescriptions({ filter: 'overdue', page: 1, pageSize: 1000 }),
    { staleTime: 30_000, enabled: isOnline }
  );

  const nextDueDate = useMemo(() => (assigned?.nextDue ? new Date(assigned.nextDue as any) : null), [assigned?.nextDue]);
  const yellowWidthPercent = useMemo(() => {
    if (!nextDueDate) return 0;
    const end = new Date(nextDueDate);
    end.setHours(23,59,59,999);
    const diffMs = end.getTime() - now.getTime();
    const daysLeft = Math.ceil(diffMs / 86400000);
    if (daysLeft < 0 || daysLeft > 3) return 0;
    const ratio = (3 - daysLeft) / 3;
    const progress = 0.5 + ratio * 0.5;
    return Math.round(progress * 100);
  }, [nextDueDate, now]);

  const overdueDaysMax = useMemo(() => {
    const arr = myOverdueList?.items ?? [];
    const endOfDay = (d: any) => new Date(new Date(d as any).setHours(23,59,59,999));
    let max = 0;
    for (const it of arr as any[]) {
      const due = (it as any)?.violation?.dueDate;
      if (!due) continue;
      const diff = now.getTime() - endOfDay(due).getTime();
      const days = Math.floor(diff / 86400000);
      if (days > max) max = days;
    }
    return max;
  }, [myOverdueList?.items, now]);

  const isOverdueBtn = (myOverdueList?.items?.length ?? 0) > 0;
  const isSeverelyOverdue = overdueDaysMax > 1;
  const prevSevereRef = useRef<number>(0);
  useEffect(() => {
    if (isSeverelyOverdue && prevSevereRef.current <= 1) {
      playAttentionBeep();
    }
    prevSevereRef.current = overdueDaysMax;
  }, [isSeverelyOverdue, overdueDaysMax]);

  // All prescriptions stats for admins
  const { data: allStats, isFetching: allStatsLoading } = useQuery<any>(
    ["all-violation-stats"],
    () => apiClient.getViolationStats({}),
    {
      enabled: !!profile?.isAdmin && isOnline,
      staleTime: 30_000,
      refetchInterval: isOnline ? 60_000 : false,
    },
  );

  const [allPrescFilter, setAllPrescFilter] = useState<
    "all" | "in_progress" | "resolved" | "overdue" | null
  >(null);
  const {
    data: allPrescList,
    isFetching: allPrescListLoading,
    refetch: refetchAllPresc,
  } = useQuery<PrescriptionPage>(
    ["all-prescriptions", allPrescFilter],
    () => apiClient.listPrescriptionRegister({ page: 1, pageSize: 100 }),
    {
      enabled: !!allPrescFilter && !!profile?.isAdmin && isOnline,
      staleTime: 30_000,
    },
  );
  const filteredAllItems = useMemo(() => {
    const arr = allPrescList?.items ?? [];
    const now = new Date();
    return arr.filter((r: any) => {
      const v = r.violation || {};
      const status = (v.status || "").toLowerCase();
      const d = v.dueDate ? new Date(v.dueDate as any) : null;
      const isResolved = status.includes("устран");
      const isOverdue =
        !isResolved && d ? now > new Date(d.setHours(23, 59, 59, 999)) : false;
      if (allPrescFilter === "resolved") return isResolved;
      if (allPrescFilter === "overdue")
        return isOverdue || status.includes("просроч");
      if (allPrescFilter === "in_progress")
        return !isResolved && !isOverdue && !status.includes("просроч");
      return true;
    });
  }, [allPrescList?.items, allPrescFilter]);

  const deleteOneAll = useMutation(
    apiClient.deletePrescriptionRegisterEntries,
    {
      onSuccess: async () => {
        await refetchAllPresc();
        await queryClient.invalidateQueries({
          queryKey: ["all-violation-stats"],
        });
      },
    },
  );
  const setStatusAdmin = useMutation(apiClient.updateViolationAdmin, {
    onSuccess: async () => {
      await refetchAllPresc();
      await queryClient.invalidateQueries({
        queryKey: ["all-violation-stats"],
      });
    },
  });

  // Presence summary (online/offline)
  const { data: presence, isInitialLoading: presenceLoading, error: presenceError } =
    useQuery<Presence>(
      ["presence-summary"],
      () => apiClient.getPresenceSummary({ minutes: 7 }),
      {
        staleTime: 60_000,
        refetchInterval: isOnline ? 30_000 : false,
        enabled: !!profile?.canAccessNow && isOnline,
        retry: (failureCount, error: any) => {
          const msg = (error as any)?.message || "";
          if (typeof msg === "string" && msg.toLowerCase().includes("fetch failed")) {
            return false;
          }
          return isOnline && failureCount < 2;
        },
      },
    );
  const [showOnline, setShowOnline] = useState(false);
  const [showOffline, setShowOffline] = useState(false);

  // New users popup for admins
  const NEW_USERS_DAYS = 7;
  type NewUsersOutput = inferRPCOutputType<"listNewUsersAdmin">;
  const isAdmin = !!profile?.isAdmin;
  const isUdManager = (() => {
    const t = (profile?.jobTitle || "").toLowerCase();
    return (
      t.includes("управляющий директор") ||
      t.includes("заместитель управляющего директора")
    );
  })();
  const { data: newUsers, isFetching: newUsersLoading } =
    useQuery<NewUsersOutput>(
      ["new-users", NEW_USERS_DAYS],
      () =>
        apiClient.listNewUsersAdmin({ sinceDays: NEW_USERS_DAYS, limit: 50 }),
      { enabled: isAdmin && isOnline, staleTime: 30_000 },
    );
  const LAST_SEEN_NEW_USERS_KEY = "lastSeenNewUsersAt";
  const [lastSeenNewUsersAt, setLastSeenNewUsersAt] = useState<number>(() => {
    try {
      const raw = localStorage.getItem(LAST_SEEN_NEW_USERS_KEY);
      const n = raw ? parseInt(raw) : 0;
      return Number.isFinite(n) ? n : 0;
    } catch {
      return 0;
    }
  });
  const allNewUsers = useMemo(() => newUsers?.items ?? [], [newUsers?.items]);
  const freshNewUsers = useMemo(() => {
    const last = lastSeenNewUsersAt || 0;
    return allNewUsers.filter((u: any) => {
      const t = new Date((u as any)?.createdAt as any).getTime();
      return Number.isFinite(t) && t > last;
    });
  }, [allNewUsers, lastSeenNewUsersAt]);
  const latestCreatedAtMs = useMemo(() => {
    return allNewUsers.reduce((max: number, u: any) => {
      const t = new Date((u as any)?.createdAt as any).getTime();
      return Number.isFinite(t) && t > max ? t : max;
    }, lastSeenNewUsersAt || 0);
  }, [allNewUsers, lastSeenNewUsersAt]);
  const [newUsersOpen, setNewUsersOpen] = useState(false);
  useEffect(() => {
    if (isAdmin && !newUsersOpen && (freshNewUsers?.length ?? 0) > 0) {
      setNewUsersOpen(true);
    }
  }, [isAdmin, freshNewUsers?.length]);

  const upsertProfile = useMutation(apiClient.upsertMyProfile, {
    onSuccess: async () => {
      await queryClient.invalidateQueries({ queryKey: ["me"] });
      toast({ title: "Профиль обновлён" });
    },
    onError: () => {
      toast({ title: "Не удалось сохранить профиль" });
    },
  });

  const draft = useMemo(() => {
    try {
      const raw = localStorage.getItem("profileDraft");
      if (!raw) return null;
      return JSON.parse(raw) as UpsertProfileInput;
    } catch {
      return null;
    }
  }, []);

  const showSaveFromDraft =
    !!draft &&
    !asUserId &&
    (!profile?.fullName ||
      !profile?.company ||
      !profile?.department ||
      !profile?.jobTitle ||
      !profile?.email);

  if (!isInitialLoading && profile && !profile.canAccessNow) {
    return (
      <AccessRestrictionNotice blocked={(profile as any).isBlocked ?? false} />
    );
  }

  return (
    <div className="min-h-[calc(100vh-3.5rem)]">
      <div className="max-w-5xl mx-auto p-4 sm:p-6">
        {/* Admin popup: newly registered users */}
        {isAdmin && (
          <Dialog
            open={newUsersOpen}
            onOpenChange={(open) => {
              setNewUsersOpen(open);
              if (!open) {
                try {
                  localStorage.setItem(
                    LAST_SEEN_NEW_USERS_KEY,
                    String(latestCreatedAtMs),
                  );
                  setLastSeenNewUsersAt(latestCreatedAtMs);
                } catch {
                  /* ignore */
                }
              }
            }}
          >
            <DialogContent className="max-w-3xl">
              <DialogHeader>
                <DialogTitle>Новые регистрации</DialogTitle>
                <DialogDescription>
                  За последние {NEW_USERS_DAYS} дней
                </DialogDescription>
              </DialogHeader>
              {newUsersLoading ? (
                <div className="text-sm text-muted-foreground">Загрузка…</div>
              ) : (freshNewUsers?.length ?? 0) === 0 ? (
                <div className="text-sm text-muted-foreground">
                  Новых регистраций нет
                </div>
              ) : (
                <div className="overflow-x-auto">
                  <Table>
                    <TableHeader>
                      <TableRow>
                        <TableHead>ID№</TableHead>
                        <TableHead>ФИО</TableHead>
                        <TableHead>Подразделение</TableHead>
                        <TableHead>Должность</TableHead>
                        <TableHead>E-mail</TableHead>
                      </TableRow>
                    </TableHeader>
                    <TableBody>
                      {freshNewUsers?.map((u: any) => (
                        <TableRow key={u.id}>
                          <TableCell>{u.shortId ?? "—"}</TableCell>
                          <TableCell className="max-w-[220px] truncate">
                            {u.fullName ?? "—"}
                          </TableCell>
                          <TableCell className="max-w-[220px] truncate">
                            {u.department ?? "—"}
                          </TableCell>
                          <TableCell className="max-w-[220px] truncate">
                            {u.jobTitle ?? "—"}
                          </TableCell>
                          <TableCell className="max-w-[220px] truncate">
                            {u.email ?? "—"}
                          </TableCell>
                        </TableRow>
                      ))}
                    </TableBody>
                  </Table>
                </div>
              )}
              <div className="flex justify-end">
                <Button
                  variant="secondary"
                  onClick={() => setNewUsersOpen(false)}
                >
                  Закрыть
                </Button>
              </div>
            </DialogContent>
          </Dialog>
        )}
        <Card className="card-elevated mb-6">
          <CardHeader className="flex items-center justify-between">
            <CardTitle className="text-lg">Мои личные показатели ПАБ</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="flex flex-col sm:flex-row sm:items-center gap-2">
              <div className="text-sm text-muted-foreground">ФИО</div>
              <div className="text-sm font-medium">
                {profile?.fullName || "—"}
              </div>
            </div>
            <div className="flex flex-col sm:flex-row sm:items-center gap-2">
              <div className="text-sm text-muted-foreground">Должность</div>
              <div className="text-sm font-medium">
                {profile?.jobTitle || "—"}
              </div>
            </div>

            <div className="text-xs text-muted-foreground">
              Показатели за текущий месяц. План берётся из последнего Excel на
              странице «Личные показатели ПАБ».
            </div>

            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
              <div className="p-3 border rounded">
                <div className="text-xs text-muted-foreground">
                  План — Аудиты
                </div>
                <div className="text-2xl font-semibold">
                  {planLoading ? "…" : (pabPlan?.planAudits ?? "—")}
                </div>
              </div>
              <div className="p-3 border rounded">
                <div className="text-xs text-muted-foreground">
                  План — Наблюдения
                </div>
                <div className="text-2xl font-semibold">
                  {planLoading ? "…" : (pabPlan?.planObservations ?? "—")}
                </div>
              </div>
              <button
                className="p-3 border rounded text-left hover:bg-accent"
                title="Открыть статистику за месяц"
                onClick={() => {
                  const now = new Date();
                  const y = now.getFullYear();
                  const m = now.getMonth();
                  const pad = (n: number) => String(n).padStart(2, "0");
                  const from = `${y}-${pad(m + 1)}-01`;
                  const lastDay = new Date(y, m + 1, 0).getDate();
                  const to = `${y}-${pad(m + 1)}-${pad(lastDay)}`;
                  navigate(`/stats?from=${from}&to=${to}`);
                }}
              >
                <div className="text-xs text-muted-foreground">
                  Факт — Аудиты
                </div>
                <div className="text-2xl font-semibold text-blue-600">
                  {factLoading ? "…" : (pabFact?.factAudits ?? 0)}
                </div>
              </button>
              <button
                className="p-3 border rounded text-left hover:bg-accent"
                title="Открыть статистику за месяц"
                onClick={() => {
                  const now = new Date();
                  const y = now.getFullYear();
                  const m = now.getMonth();
                  const pad = (n: number) => String(n).padStart(2, "0");
                  const from = `${y}-${pad(m + 1)}-01`;
                  const lastDay = new Date(y, m + 1, 0).getDate();
                  const to = `${y}-${pad(m + 1)}-${pad(lastDay)}`;
                  navigate(`/stats?from=${from}&to=${to}`);
                }}
              >
                <div className="text-xs text-muted-foreground">
                  Факт — Наблюдения
                </div>
                <div className="text-2xl font-semibold text-blue-600">
                  {factLoading ? "…" : (pabFact?.factObservations ?? 0)}
                </div>
              </button>
            </div>

            <div className="mt-4 p-3 border rounded space-y-3">
              <div className="text-sm font-medium">Калькулятор вахты</div>
              <div className="grid sm:grid-cols-2 gap-3">
                <div className="space-y-1">
                  <div className="text-xs text-muted-foreground">Начало вахты</div>
                  <Input
                    type="date"
                    value={shiftFrom}
                    onChange={(e) => setShiftFrom(e.target.value)}
                  />
                </div>
                <div className="space-y-1">
                  <div className="text-xs text-muted-foreground">Окончание вахты</div>
                  <Input
                    type="date"
                    value={shiftTo}
                    onChange={(e) => setShiftTo(e.target.value)}
                  />
                </div>
              </div>
              <div className="grid sm:grid-cols-3 gap-3 text-sm">
                <div className="space-y-1">
                  <div className="text-xs text-muted-foreground">Длительность вахты</div>
                  <div className="text-base font-semibold">
                    {shiftDays != null ? `${shiftDays} дн.` : "—"}
                  </div>
                </div>
                <div className="space-y-1">
                  <div className="text-xs text-muted-foreground">План аудитов на вахту</div>
                  <div className="text-base font-semibold">
                    {shiftPlanAudits != null ? shiftPlanAudits : "—"}
                  </div>
                </div>
                <div className="space-y-1">
                  <div className="text-xs text-muted-foreground">План наблюдений на вахту</div>
                  <div className="text-base font-semibold">
                    {shiftPlanObservations != null ? shiftPlanObservations : "—"}
                  </div>
                </div>
              </div>
              <div className="text-xs text-muted-foreground">
                Расчёт ведётся пропорционально плану на текущий месяц.
              </div>
            </div>
          </CardContent>
        </Card>
        {/* Personal assigned prescriptions summary */}
        <Card className="card-elevated mb-6">
          <CardHeader className="flex items-center justify-between">
            <CardTitle className="text-lg">Мне выписаны предписания</CardTitle>
            <div className="flex gap-2">
              <Button
                variant="secondary"
                onClick={() => navigate("/prescriptions")}
              >
                Реестр
              </Button>
              <Button variant="secondary" onClick={() => navigate("/stats")}>
                Статистика
              </Button>
            </div>
          </CardHeader>
          <CardContent>
            {/* Кнопки-индикаторы */}
            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
              <button
                className="p-3 border rounded text-left hover:bg-accent"
                onClick={() =>
                  setSelectedPrescFilter((f) => (f === "all" ? null : "all"))
                }
                title="Показать все мои предписания"
              >
                <div className="text-xs text-muted-foreground">Назначено</div>
                <div className="text-2xl font-semibold">
                  {assigned?.totalAssigned ?? 0}
                </div>
              </button>
              <button
                className="p-3 border rounded text-left hover:bg-accent"
                onClick={() =>
                  setSelectedPrescFilter((f) => (f === "open" ? null : "open"))
                }
                title="Показать предписания в работе"
              >
                <div className="text-xs text-muted-foreground">В работе</div>
                <div className="text-2xl font-semibold text-blue-600">
                  {assigned?.open ?? 0}
                </div>
              </button>
              <button
                className={`p-3 border rounded text-left hover:bg-accent ${assigned && assigned.overdue > 0 ? "blink-red-white" : ""}`}
                onClick={() =>
                  setSelectedPrescFilter((f) =>
                    f === "overdue" ? null : "overdue",
                  )
                }
                title="Показать просроченные предписания"
              >
                <div className="text-xs text-muted-foreground">Просрочено</div>
                <div
                  className={`text-2xl font-semibold ${assigned && assigned.overdue > 0 ? "text-red-600" : "text-green-600"}`}
                >
                  {assigned?.overdue ?? 0}
                </div>
              </button>
              <div className="p-3 border rounded">
                <div className="text-xs text-muted-foreground">
                  Ближайший срок
                </div>
                <div className="text-base">
                  {assigned?.nextDue
                    ? new Date(assigned.nextDue as any).toLocaleDateString(
                        "ru-RU",
                      )
                    : "—"}
                </div>
              </div>
            </div>

            {/* Раскрывающийся список ниже по клику */}
            {selectedPrescFilter && (
              <div className="mt-4 border rounded p-3">
                <div className="flex items-center justify-between mb-2">
                  <div className="text-sm font-medium">
                    {selectedPrescFilter === "all"
                      ? "Все мои предписания"
                      : selectedPrescFilter === "open"
                        ? "В работе"
                        : "Просроченные"}
                  </div>
                  <Button
                    variant="ghost"
                    onClick={() => setSelectedPrescFilter(null)}
                  >
                    Скрыть
                  </Button>
                </div>
                {prescListLoading ? (
                  <div className="text-sm text-muted-foreground">Загрузка…</div>
                ) : (prescList?.items?.length ?? 0) === 0 ? (
                  <div className="text-sm text-muted-foreground">
                    Ничего не найдено
                  </div>
                ) : (
                  <div className="space-y-2">
                    {prescList?.items?.map((it) => (
                      <div key={it.id} className="p-3 rounded border">
                        <div className="flex flex-wrap gap-2 justify-between">
                          <div className="text-sm font-medium">
                            {it.violation?.code
                              ? `№ ${it.violation.code}`
                              : "Без номера"}
                          </div>
                          <div className="text-xs text-muted-foreground">
                            {new Date(it.createdAt as any).toLocaleDateString(
                              "ru-RU",
                            )}
                          </div>
                        </div>
                        <div className="mt-1 text-sm">
                          {it.violation?.shop || "—"} ·{" "}
                          {it.violation?.section || "—"} ·{" "}
                          {it.violation?.objectInspected || "—"}
                        </div>
                        <div className="mt-1 text-sm line-clamp-2">
                          {it.violation?.description || "Описание отсутствует"}
                        </div>
                        <div className="mt-2 text-xs text-muted-foreground flex gap-4">
                          <span>Выдал(а): {it.violation?.auditor || "—"}</span>
                          <span>
                            Срок:{" "}
                            {it.violation?.dueDate
                              ? new Date(
                                  it.violation.dueDate as any,
                                ).toLocaleDateString("ru-RU")
                              : "—"}
                          </span>
                          <span>Статус: {it.violation?.status || "—"}</span>
                        </div>
                        {it.docUrl && (
                          <div className="mt-2">
                            <a
                              href={it.docUrl}
                              target="_blank"
                              rel="noreferrer"
                              className="text-sm text-blue-600 hover:underline"
                            >
                              Открыть акт
                            </a>
                          </div>
                        )}
                      </div>
                    ))}
                    <div className="pt-1">
                      <Button
                        variant="link"
                        onClick={() => navigate("/prescriptions")}
                      >
                        Перейти в реестр
                      </Button>
                    </div>
                  </div>
                )}
              </div>
            )}
          </CardContent>
        </Card>
        {/* Все предписания (для админов) */}
        {isAdmin && (
          <Card className="card-elevated mb-6">
            <CardHeader className="flex items-center justify-between">
              <CardTitle className="text-lg">Все предписания</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                <button
                  className="p-3 border rounded text-left hover:bg-accent"
                  onClick={() =>
                    setAllPrescFilter((f) => (f === "all" ? null : "all"))
                  }
                >
                  <div className="text-xs text-muted-foreground">Выдано</div>
                  <div className="text-2xl font-semibold">
                    {allStatsLoading ? "…" : (allStats?.total ?? 0)}
                  </div>
                </button>
                <button
                  className="p-3 border rounded text-left hover:bg-accent"
                  onClick={() =>
                    setAllPrescFilter((f) =>
                      f === "in_progress" ? null : "in_progress",
                    )
                  }
                >
                  <div className="text-xs text-muted-foreground">В работе</div>
                  <div className="text-2xl font-semibold text-blue-600">
                    {allStatsLoading ? "…" : (allStats?.inProgress ?? 0)}
                  </div>
                </button>
                <button
                  className="p-3 border rounded text-left hover:bg-accent"
                  onClick={() =>
                    setAllPrescFilter((f) =>
                      f === "resolved" ? null : "resolved",
                    )
                  }
                >
                  <div className="text-xs text-muted-foreground">Устранено</div>
                  <div className="text-2xl font-semibold text-green-600">
                    {allStatsLoading ? "…" : (allStats?.resolved ?? 0)}
                  </div>
                </button>
                <button
                  className={`p-3 border rounded text-left hover:bg-accent ${allStats && (allStats.overdue ?? 0) > 0 ? "blink-red-white" : ""}`}
                  onClick={() =>
                    setAllPrescFilter((f) =>
                      f === "overdue" ? null : "overdue",
                    )
                  }
                >
                  <div className="text-xs text-muted-foreground">
                    Просрочено
                  </div>
                  <div
                    className={`text-2xl font-semibold ${allStats && (allStats.overdue ?? 0) > 0 ? "text-red-600" : "text-muted-foreground"}`}
                  >
                    {allStatsLoading ? "…" : (allStats?.overdue ?? 0)}
                  </div>
                </button>
              </div>

              {allPrescFilter && (
                <div className="mt-4 border rounded p-3">
                  <div className="flex items-center justify-between mb-2">
                    <div className="text-sm font-medium">
                      {allPrescFilter === "all"
                        ? "Все предписания"
                        : allPrescFilter === "in_progress"
                          ? "В работе"
                          : allPrescFilter === "resolved"
                            ? "Устранено"
                            : "Просрочено"}
                    </div>
                    <Button
                      variant="ghost"
                      onClick={() => setAllPrescFilter(null)}
                    >
                      Скрыть
                    </Button>
                  </div>
                  {allPrescListLoading ? (
                    <div className="text-sm text-muted-foreground">
                      Загрузка…
                    </div>
                  ) : (filteredAllItems?.length ?? 0) === 0 ? (
                    <div className="text-sm text-muted-foreground">
                      Ничего не найдено
                    </div>
                  ) : (
                    <div className="space-y-2">
                      {filteredAllItems.map((it: any) => (
                        <div key={it.id} className="p-3 rounded border">
                          <div className="flex flex-wrap gap-2 justify-between">
                            <div className="text-sm font-medium">
                              {it.violation?.code
                                ? `№ ${it.violation.code}`
                                : "Без номера"}
                            </div>
                            <div className="text-xs text-muted-foreground">
                              {new Date(it.createdAt as any).toLocaleDateString(
                                "ru-RU",
                              )}
                            </div>
                          </div>
                          <div className="mt-1 text-sm">
                            {it.violation?.shop || "—"} ·{" "}
                            {it.violation?.section || "—"} ·{" "}
                            {it.violation?.objectInspected || "—"}
                          </div>
                          <div className="mt-1 text-sm line-clamp-2">
                            {it.violation?.description ||
                              "Описание отсутствует"}
                          </div>
                          <div className="mt-2 text-xs text-muted-foreground flex flex-wrap gap-4">
                            <span>
                              Выдал(а): {it.violation?.auditor || "—"}
                            </span>
                            <span>
                              Срок:{" "}
                              {it.violation?.dueDate
                                ? new Date(
                                    it.violation.dueDate as any,
                                  ).toLocaleDateString("ru-RU")
                                : "—"}
                            </span>
                            <span>Статус: {it.violation?.status || "—"}</span>
                          </div>
                          <div className="mt-2 flex gap-2 items-center">
                            <Button
                              variant="destructive"
                              size="sm"
                              onClick={async () => {
                                if (
                                  !confirm(
                                    "Удалить предписание? Это действие необратимо.",
                                  )
                                )
                                  return;
                                await deleteOneAll.mutateAsync({
                                  ids: [it.id as string],
                                });
                              }}
                            >
                              Удалить
                            </Button>
                            {it.violation?.id ? (
                              <DropdownMenu>
                                <DropdownMenuTrigger asChild>
                                  <Button size="sm" variant="secondary">
                                    Изменить
                                  </Button>
                                </DropdownMenuTrigger>
                                <DropdownMenuContent align="end">
                                  {["Устранено", "В работе", "Просрочено"].map(
                                    (label) => (
                                      <DropdownMenuItem
                                        key={label}
                                        onClick={() =>
                                          setStatusAdmin.mutate({
                                            id: it.violation.id as string,
                                            status: label,
                                          })
                                        }
                                      >
                                        {label}
                                      </DropdownMenuItem>
                                    ),
                                  )}
                                </DropdownMenuContent>
                              </DropdownMenu>
                            ) : null}
                            <div className="ml-auto" />
                            {it.docUrl && (
                              <a
                                href={it.docUrl}
                                target="_blank"
                                rel="noreferrer"
                                className="text-sm text-blue-600 hover:underline"
                              >
                                Открыть акт
                              </a>
                            )}
                          </div>
                        </div>
                      ))}
                      <div className="pt-1">
                        <Button
                          variant="link"
                          onClick={() => navigate("/prescriptions")}
                        >
                          Перейти в реестр
                        </Button>
                      </div>
                    </div>
                  )}
                </div>
              )}
            </CardContent>
          </Card>
        )}
        {/* Presence summary card */}{" "}
        <Card className="card-elevated mb-6">
          <CardHeader className="flex items-center justify-between">
            <CardTitle className="text-lg">Состояние пользователей</CardTitle>
          </CardHeader>
            <CardContent>
              {presenceLoading ? (
                <div className="text-sm text-muted-foreground">Загрузка…</div>
              ) : presenceError ? (
                <div className="text-sm text-muted-foreground">
                  Не удалось загрузить данные о состоянии пользователей. Попробуйте позже.
                </div>
              ) : (
                <div className="space-y-3">
                <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                  <div className="p-3 border rounded">
                    <div className="text-xs text-muted-foreground">
                      Зарегистрировано в системе
                    </div>
                    <div className="text-2xl font-semibold">
                      {presence?.total ?? 0}
                    </div>
                  </div>
                  <button
                    className="p-3 border rounded text-left hover:bg-accent"
                    onClick={() => setShowOnline((v) => !v)}
                  >
                    <div className="text-xs text-muted-foreground">Онлайн</div>
                    <div className="text-2xl font-semibold text-green-600">
                      {presence?.online ?? 0}
                    </div>
                  </button>
                  <button
                    className="p-3 border rounded text-left hover:bg-accent"
                    onClick={() => setShowOffline((v) => !v)}
                  >
                    <div className="text-xs text-muted-foreground">Офлайн</div>
                    <div className="text-2xl font-semibold text-muted-foreground">
                      {presence?.offline ?? 0}
                    </div>
                  </button>
                </div>
                {showOnline && (
                  <div className="border rounded p-3">
                    <div className="text-sm font-medium mb-2">
                      Сейчас онлайн
                    </div>
                    {presence?.onlineUsers?.length ? (
                      <ul className="list-disc pl-5 space-y-1">
                        {presence.onlineUsers.map((u) => (
                          <li key={u.id} className="text-sm">
                            {u.name}
                          </li>
                        ))}
                      </ul>
                    ) : (
                      <div className="text-sm text-muted-foreground">
                        Никого нет онлайн
                      </div>
                    )}
                  </div>
                )}
                {showOffline && (
                  <div className="border rounded p-3">
                    <div className="text-sm font-medium mb-2">
                      Сейчас офлайн
                    </div>
                    {presence?.offlineUsers?.length ? (
                      <ul className="list-disc pl-5 space-y-1">
                        {presence.offlineUsers.map((u) => (
                          <li key={u.id} className="text-sm">
                            {u.name}
                          </li>
                        ))}
                      </ul>
                    ) : (
                      <div className="text-sm text-muted-foreground">
                        Все в онлайне
                      </div>
                    )}
                  </div>
                )}
              </div>
            )}
          </CardContent>
        </Card>
        <div className="grid md:grid-cols-[1fr,1fr] gap-6 items-stretch content-stretch">
          <Card className="card-elevated h-full">
            <CardHeader className="flex flex-col gap-1">
              <CardTitle className="text-lg">Профиль</CardTitle>
            </CardHeader>
            <CardContent className="space-y-3">
              {isInitialLoading ? (
                <div className="text-sm text-muted-foreground">Загрузка…</div>
              ) : (
                <div className="grid gap-3">
                  <div className="flex items-center gap-2">
                    <Badge variant="secondary">
                      ID№ {profile?.shortId ?? "—"}
                    </Badge>
                  </div>
                  <div className="flex items-center gap-3">
                    <User2 className="h-4 w-4 text-muted-foreground" />
                    <div className="text-sm">
                      <div className="text-muted-foreground">ФИО</div>
                      <div className="font-medium">
                        {profile?.fullName || "—"}
                      </div>
                    </div>
                  </div>
                  <div className="flex items-center gap-3">
                    <Building2 className="h-4 w-4 text-muted-foreground" />
                    <div className="text-sm">
                      <div className="text-muted-foreground">Компания</div>
                      <div className="font-medium">
                        {profile?.company || "—"}
                      </div>
                    </div>
                  </div>
                  <div className="flex items-center gap-3">
                    <FolderIcon className="h-4 w-4 text-muted-foreground" />
                    <div className="text-sm">
                      <div className="text-muted-foreground">Подразделение</div>
                      <div className="font-medium">
                        {profile?.department || "—"}
                      </div>
                    </div>
                  </div>
                  <div className="flex items-center gap-3">
                    <Briefcase className="h-4 w-4 text-muted-foreground" />
                    <div className="text-sm">
                      <div className="text-muted-foreground">Должность</div>
                      <div className="font-medium">
                        {profile?.jobTitle || "—"}
                      </div>
                    </div>
                  </div>{" "}
                  <div className="flex items-center gap-3">
                    <Mail className="h-4 w-4 text-muted-foreground" />
                    <div className="text-sm">
                      <div className="text-muted-foreground">E-mail</div>
                      <div className="font-medium">{profile?.email || "—"}</div>
                    </div>
                  </div>
                </div>
              )}
              <div className="mt-2">
                <div className="flex items-center gap-2 text-sm text-muted-foreground">
                  <CalendarClock className="h-4 w-4" />
                  <span suppressHydrationWarning>
                    {now.toLocaleString("ru-RU", {
                      dateStyle: "full",
                      timeStyle: "medium",
                    })}
                  </span>
                </div>
              </div>
              {showSaveFromDraft && (
                <div className="mt-4 p-3 rounded-md bg-accent text-accent-foreground">
                  <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                    <div className="text-sm">
                      Обнаружен черновик данных регистрации. Сохранить в
                      профиль?
                    </div>
                    <div className="flex gap-2">
                      <Button
                        variant="secondary"
                        disabled={!!asUserId}
                        onClick={() => {
                          if (!draft) return;
                          upsertProfile.mutate({
                            fullName: draft.fullName,
                            company: draft.company,
                            department: (draft as any).department,
                            jobTitle: draft.jobTitle,
                            email: draft.email,
                          });
                        }}
                      >
                        Сохранить
                      </Button>
                      <Button
                        variant="ghost"
                        onClick={() => {
                          try {
                            localStorage.removeItem("profileDraft");
                          } catch {
                            /* ignore */
                          }
                          toast({ title: "Черновик удалён" });
                        }}
                      >
                        Удалить
                      </Button>
                    </div>
                  </div>
                </div>
              )}
            </CardContent>
            <CardFooter className="relative flex items-end justify-between flex-wrap gap-2">
              {!asUserId && (
                <Button
                  variant="secondary"
                  onClick={() => {
                    const name =
                      prompt("ФИО", profile?.fullName ?? "") ?? undefined;
                    const comp =
                      prompt("Компания", profile?.company ?? "") ?? undefined;
                    const dept =
                      prompt("Подразделение", profile?.department ?? "") ??
                      undefined;
                    const job =
                      prompt("Должность", profile?.jobTitle ?? "") ?? undefined;
                    const mail =
                      prompt("E-mail", profile?.email ?? "") ?? undefined;
                    if (
                      typeof name === "undefined" &&
                      typeof comp === "undefined" &&
                      typeof job === "undefined" &&
                      typeof mail === "undefined"
                    ) {
                      return;
                    }
                    upsertProfile.mutate({
                      fullName: name,
                      company: comp,
                      department: dept,
                      jobTitle: job,
                      email: mail,
                    });
                  }}
                >
                  Редактировать
                </Button>
              )}
              <div
                className="ml-auto pointer-events-none select-none"
                aria-hidden="true"
              >
                <svg
                  viewBox="0 0 100 200"
                  xmlns="http://www.w3.org/2000/svg"
                  role="img"
                  aria-label="Рабочий надевает каску"
                  style={{ width: "1cm", height: "2cm", display: "block" }}
                >
                  <g
                    fill="none"
                    stroke="hsl(var(--foreground))"
                    strokeWidth="5"
                    strokeLinecap="round"
                  >
                    <circle cx="50" cy="42" r="14" fill="hsl(var(--card))" />
                    <line x1="50" y1="58" x2="50" y2="120" />
                    <line x1="50" y1="80" x2="30" y2="100" />
                    <line x1="50" y1="80" x2="70" y2="100" />
                    <line x1="50" y1="120" x2="35" y2="170" />
                    <line x1="50" y1="120" x2="65" y2="170" />
                  </g>
                  <g transform="translate(0,-24)">
                    <g>
                      <path
                        fill="hsl(var(--warning))"
                        d="M30 20 h40 a6 6 0 0 1 6 6 v10 H24 V26 a6 6 0 0 1 6 -6 z"
                      />
                      <rect
                        fill="hsl(var(--warning))"
                        x="26"
                        y="36"
                        width="48"
                        height="6"
                        rx="3"
                      />
                    </g>
                    <animateTransform
                      attributeName="transform"
                      type="translate"
                      dur="2.6s"
                      repeatCount="indefinite"
                      keyTimes="0;0.4;0.6;1"
                      values="0,-24;0,-24;0,0;0,0"
                    />
                  </g>
                </svg>
              </div>
            </CardFooter>
          </Card>

          {/* Классический набор действий на главной + кнопка «Дополнительно» */}
          <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 content-start">
            {/* Остались на главной */}
            <button
               className="w-full h-24 btn-3d text-base font-semibold touch-target flex flex-col items-center justify-center gap-2"
               onClick={() => navigate("/charts")}
             >
               Графики
             </button>
            <button
               className="w-full h-24 btn-3d-red text-base font-semibold touch-target flex flex-col items-center justify-center gap-2"
               onClick={() => navigate("/register-violation")}
             >
               Регистрация ПАБ
             </button>
             {(profile?.isAdmin || (profile as any)?.isSuperAdmin) && (
               <button
                 className="w-full h-24 btn-3d-red text-base font-semibold touch-target flex flex-col items-center justify-center gap-2"
                 onClick={() => navigate("/admin/pab-instruction")}
               >
                 Составление ПАБ
               </button>
             )}            <button
              className="w-full h-24 btn-3d-red text-base font-semibold touch-target flex flex-col items-center justify-center gap-2"
              onClick={() => navigate("/admin/pc-akt")}
            >
              Производственный контроль
            </button>
            <button
              className="w-full h-24 btn-3d text-base font-semibold touch-target flex flex-col items-center justify-center gap-2"
              onClick={() => navigate("/prescriptions")}
            >
              Реестр предписаний
            </button>
            <button
              className="w-full h-24 btn-3d text-base font-semibold touch-target flex flex-col items-center justify-center gap-2"
              onClick={() => navigate("/asubt")}
            >
              АСУБТ
            </button>
            <button
              className="w-full h-24 btn-3d text-base font-semibold touch-target flex flex-col items-center justify-center gap-2"
              onClick={() => navigate("/stats")}
            >
              Статистика нарушений
            </button>
            <button
               className="w-full h-24 btn-3d-brown text-base font-semibold touch-target flex flex-col items-center justify-center gap-2"
               onClick={() => navigate("/kbt")}
             >
               КБТ
             </button>
             <button
               className="w-full h-24 btn-3d text-base font-semibold touch-target flex items-center justify-center gap-2"
               onClick={() => navigate("/otpb")}
             >
               <HardHat className="h-6 w-6" />
               <span>ОТиПБ</span>
             </button>
             {/* Кнопки: Дополнительно и Журнал поручений (компактные, рядом) */}
             <div className="w-full sm:col-span-2 flex gap-2">
              <button
                className="flex-1 h-12 btn-3d-yellow text-base font-semibold touch-target flex items-center justify-center"
                onClick={() => navigate("/more")}
              >
                Дополнительно
              </button>
              <button
                 className={`flex-1 h-12 btn-3d text-base font-semibold touch-target flex items-center justify-center relative overflow-hidden ${isSeverelyOverdue ? 'blink-red-white' : ''}`}
                 onClick={() => navigate("/assignments")}
                 title="Журнал поручений"
               >
                 {!isOverdueBtn && yellowWidthPercent > 0 && (
                   <div className="absolute inset-y-0 left-0" style={{ width: `${yellowWidthPercent}%`, background: 'hsl(var(--warning))', opacity: 0.35 }} />
                 )}
                 {isOverdueBtn && (
                   <div className="absolute inset-0" style={{ background: 'hsl(var(--destructive))', opacity: 0.3 }} />
                 )}
                 <span className="relative z-10">Журнал поручений</span>
               </button>            </div>
            {(isAdmin || isUdManager) && (
              <button
                className="w-full btn-3d-metal sm:col-span-2 text-base font-semibold touch-target flex flex-col items-center justify-center gap-2"
                style={{ height: "1cm" }}
                onClick={() => navigate("/admin/ud-report")}
                title="Отчет для Управляющего директора"
              >
                Отчет для УД
              </button>
            )}
            <button
              className="w-full btn-3d-green sm:col-span-2 text-base font-semibold touch-target flex flex-col items-center justify-center gap-2"
              style={{ height: "2cm" }}
              onClick={() => navigate("/reports")}
            >
              Сформировать отчёт
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

/* WELCOME LOGIN SCREEN */
function WelcomeLoginScreen() {
  const auth = useAuth();
  const navigate = useNavigate();
  const location = useLocation();

  const params = new URLSearchParams(location.search);
  const expParam = params.get("exp");
  const orgParam = params.get("org") || "";
  const expTs = expParam ? Number(expParam) : NaN;
  const isExpired = !!expParam && (isNaN(expTs) || Date.now() > expTs);
  const expiresInMs = !!expParam && !isNaN(expTs) ? Math.max(0, expTs - Date.now()) : null;

  const expiresHuman = expiresInMs !== null
    ? new Date(Date.now() + (expiresInMs ?? 0)).toLocaleString()
    : null;

  const { data: publicLogin } = useQuery(
    ["public-client-login", orgParam],
    () => apiClient.getPublicClientLoginPage({ orgCode: orgParam }),
    { enabled: !!orgParam && !isExpired }
  );

  return (
    <div className="max-w-3xl mx-auto p-4 sm:p-6">
      <Card className="card-elevated h-full">
        <CardHeader>
          <CardTitle>{publicLogin?.name || "Добро пожаловать!"}</CardTitle>
        </CardHeader>
        <CardContent>
          {isExpired ? (
            <div className="text-destructive">
              Срок действия ссылки истёк. Попросите администратора выслать новую ссылку.
            </div>
          ) : publicLogin?.html ? (
            <div className="prose max-w-none" dangerouslySetInnerHTML={{ __html: publicLogin.html }} />
          ) : (
            <div className="text-muted-foreground">
              {auth.status === "authenticated"
                ? "Вы успешно вошли по ссылке. Нажмите кнопку ниже, чтобы перейти на главную страницу."
                : "Нажмите кнопку ниже, чтобы перейти на главную страницу."}
              {expiresHuman && (
                <div className="text-xs mt-2">Ссылка действует до: {new Date(expTs).toLocaleString()}</div>
              )}
            </div>
          )}
        </CardContent>
        <CardFooter>
          <Button
            className="w-full h-12 btn-3d"
            onClick={() => navigate("/home")}
            disabled={isExpired}
          >
            Продолжить
          </Button>
        </CardFooter>
      </Card>
    </div>
  );
}

/* PLACEHOLDER SCREENS (protected) */
function RegisterViolationScreen(props: any) {
  const auth = useAuth({ required: true });
  const navigate = useNavigate();
  const { data: me, isInitialLoading } = useQuery<Profile>(["me"], () =>
    apiClient.getMyProfile(),
  );
  const { toast } = useToast();

  const [sending, setSending] = useState(false);
  // const [saving, setSaving] = useState(false);

  const [date, setDate] = useState<string>(() =>
    new Date().toISOString().slice(0, 10),
  );
  const { data: codePreview, isFetching: codeLoading } = useQuery(
    ["violation-code", date],
    () => apiClient.previewNextViolationCode({ date }),
    { enabled: !!date },
  );
  const [shop, setShop] = useState("");
  const [section, setSection] = useState("");
  const [objectInspected, setObjectInspected] = useState("");
  const [description, setDescription] = useState("");
  const [extraObservations, setExtraObservations] = useState<string[]>([]);
  const [extraActions, setExtraActions] = useState<string[]>([]);
  const [extraPhotoBase64s, setExtraPhotoBase64s] = useState<string[]>([]);
  const [photoBase64, setPhotoBase64] = useState<string | undefined>(undefined);
  const [photoUploading, setPhotoUploading] = useState(false);
  const [auditorName, setAuditorName] = useState<string>("");
  const [auditorJobTitle, setAuditorJobTitle] = useState<string>("");
  const [category, setCategory] = useState<string>("-Не выбрано-");
  const [conditionType, setConditionType] = useState<string>("-Не выбрано-");
  const [hazardFactor, setHazardFactor] = useState<string>("-Не выбрано-");
  const [manualCategory, setManualCategory] = useState<string>("");
  const [extraCategories, setExtraCategories] = useState<string[]>([]);
  const [extraConditionTypes, setExtraConditionTypes] = useState<string[]>([]);
  const [extraHazards, setExtraHazards] = useState<string[]>([]);
  const [extraManualHazards, setExtraManualHazards] = useState<string[]>([]);
  const [extraManualCategories, setExtraManualCategories] = useState<string[]>(
    [],
  );

  // Опасные факторы: перечень без пункта «Не выбрано», уникализирован и отсортирован по алфавиту
  const [catalogs, setCatalogs] = useState<Array<{ kind: string; value: string }>>([]);

  useEffect(() => {
    void (async () => {
      try {
        const res = await apiClient.getSelfLearningPABContent();
        if ((res as any)?.catalogs) {
          setCatalogs((res as any).catalogs as Array<{ kind: string; value: string }>);
        }
      } catch {
        // ignore ошибки каталога, форма должна работать и без них
      }
    })();
  }, []);

  const baseHazardOptions: string[] = [
    ...Array.from(
      new Set([
        "БДД",
        "Вывал горной массы",
        "Загазованность",
        "Дым",
        "Затопление",
        "Заколообразование",
        "Не применение или отсутствие самоспасателя",
        "Неисправность ВГП",
        "Обучение и допуски (проверка знаний, аттестации, инструктажи)",
        "Отсутствие вентиляции",
        "Отсутствие на рабочем месте более 2 часов",
        "Отсутствие или неисправность освещения",
        "Отсутствие или неисправность заземления",
        "Отсутствие или нарушение крепления",
        "Подскальзывание",
        "Подъёмные сооружения (Погрузо-разгрузочные работы, перемещение груза)",
        "Погодные условия",
        "Пожарная безопасность",
        "ППР",
        "Превышение отставания вентиляции",
        "Превышение отставания крепления горной выработки",
        "Работа в замкнутом пространстве",
        "Работы на высоте",
        "Работы повышенной опасности (по наряду допуску)",
        "Санитарно-бытовые условия",
        "Скользкая поверхность",
        "Спотыкание",
        "Электричество",
      ]),
    ).sort((a, b) => a.localeCompare(b, "ru", { sensitivity: "base" })),
  ];

  const hazardOptions: string[] = [
    ...baseHazardOptions,
    ...catalogs
      .filter((c) => c.kind === "HAZARD" && !baseHazardOptions.includes(c.value))
      .map((c) => c.value),
    "-Нет в списке-",
  ];

  const note: string | undefined = undefined;
  const displayTitle = (props && props.title) || "Регистрация ПАБ";
  const isAdminOrSuper = !!me?.isAdmin || !!(me as any)?.isSuperAdmin;
  const [manualHazard, setManualHazard] = useState<string>("");
  const [actions, setActions] = useState<string>("");

  const [responsibleUserId, setResponsibleUserId] = useState<
    string | undefined
  >(undefined);
  const [responsibleName, setResponsibleName] = useState<string | undefined>(
    undefined,
  );
  const [dueDate, setDueDate] = useState<string>("");
  const status = "Новый";

  // Автозаполнение ФИО и должности проверяющего из профиля
  useEffect(() => {
    if (!isInitialLoading && me) {
      if (!auditorName && me.fullName) setAuditorName(me.fullName);
      if (!auditorJobTitle && me.jobTitle) setAuditorJobTitle(me.jobTitle);
    }
  }, [isInitialLoading, me, auditorName, auditorJobTitle]);

  const fileInputRef = useRef<HTMLInputElement | null>(null);
  const pdfRef = useRef<HTMLDivElement | null>(null);
  const [exportingPdf, setExportingPdf] = useState(false);

  // Dropdown list of registered users (auto-refreshable)
  const { data: dropdownUsers } = useQuery(
    ["mgrs-dropdown"],
    () => apiClient.searchManagers({ limit: 20000 }),
    { staleTime: 30_000 },
  );

  const createMutation = useMutation(apiClient.createViolation, {
    onSuccess: () => {
      toast({ title: "Сохранено" });
      navigate("/my-violations");
    },
    onError: (error: any) => {
      const rawMessage =
        error && typeof error.message === "string" ? error.message : "";
      const upper = rawMessage.toUpperCase();
      const message = upper.includes("INVALID_INPUT")
        ? "Проверьте дату и обязательные поля — данные не были переданы в систему."
        : "Не удалось сохранить";
      toast({ title: message });
    },
  });

  // Word generation
  const docxMutation = useMutation(apiClient.generateViolationDocx, {
    onSuccess: (res: { url: string }) => {
      setSending(false);
      if (res?.url) {
        const safe = (s: string) =>
          (s || "")
            .replace(/[\\/:*?"<>|]+/g, " ")
            .replace(/\s+/g, " ")
            .trim();
        const fileName = safe(
          `${codePreview?.code || displayTitle}_${date}_${safe(shop)}_${safe(section)}`,
        );
        const a = document.createElement("a");
        a.href = res.url;
        a.download = `${fileName}.docx`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        toast({ title: "Файл Word готов", description: "Файл скачан" });
      }
    },
    onError: () => {
      setSending(false);
      toast({ title: "Не удалось сформировать Word" });
    },
  });

  const excelMutation = useMutation(apiClient.generateViolationExcel, {
    onSuccess: (res: { url: string }) => {
      if (res?.url) {
        const safe = (s: string) =>
          (s || "")
            .replace(/[\\/:*?"<>|]+/g, " ")
            .replace(/\s+/g, " ")
            .trim();
        const fileName = safe(
          `${codePreview?.code || displayTitle}_${date}_${safe(shop)}_${safe(section)}`,
        );
        const a = document.createElement("a");
        a.href = res.url;
        a.download = `${fileName}.xlsx`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        toast({ title: "Файл готов", description: "Excel скачан" });
      }
    },
    onError: () => {
      toast({ title: "Не удалось сформировать Excel" });
    },
  });

  // Рассылка админам и ответственному
  const sendAllMutation = useMutation(
    apiClient.sendViolationToAdminsAndResponsible,
    {
      onSuccess: (res: {
        ok: boolean;
        adminSuccess?: number;
        adminFailures?: number;
        sentToResponsible?: boolean;
        error?: string;
      }) => {
        if (res?.ok) {
          const adminOk =
            typeof res.adminSuccess === "number" ? res.adminSuccess : 0;
          const adminFail =
            typeof res.adminFailures === "number" ? res.adminFailures : 0;
          toast({
            title: "Отправлено",
            description: `Админам: ${adminOk}${adminFail ? `, ошибок: ${adminFail}` : ""}${res.sentToResponsible ? ", ответственному: да" : ""}`,
          });
          // После отправки переходим к списку
          navigate("/my-violations");
        } else if (res?.error === "MISSING_SEND_EMAIL_PERMISSION") {
          toast({
            title: "Нужно разрешение на отправку писем",
            description:
              "Система запросит разрешение. Подтвердите, чтобы можно было отправлять уведомления по email.",
          });
          // Запрашиваем согласие на отправку писем у текущего пользователя
          try {
            auth.signIn({ provider: "AC1", scope: ["sendEmail"] });
          } catch (err) {
            // no-op
          }
        } else {
          toast({ title: "Не удалось отправить письма" });
        }
      },
      onError: () => toast({ title: "Ошибка отправки писем" }),
    },
  );

  const requiresManualHazard = hazardFactor === "-Нет в списке-";
  const requiresManualCategory = category === "Другое (ДР)";
  const categoryValid =
    category !== "-Не выбрано-" &&
    (!requiresManualCategory || !!manualCategory.trim());
  const hazardFactorValid =
    hazardFactor !== "-Не выбрано-" &&
    (!requiresManualHazard || !!manualHazard.trim());
  const extraObsValid = extraObservations.every((s) => !!s.trim());
  const [showValidation, setShowValidation] = useState(false);
  const extraActsValid =
    extraActions.length === extraObservations.length &&
    extraActions.every((s) => !!s.trim());
  const extraCatsValid =
    extraCategories.length === extraObservations.length &&
    extraCategories.every(
      (c, i) =>
        c !== "-Не выбрано-" &&
        (c !== "Другое (ДР)" || !!(extraManualCategories[i] ?? "").trim()),
    );
  const extraCondsValid =
    extraConditionTypes.length === extraObservations.length &&
    extraConditionTypes.every((c) => c !== "-Не выбрано-");
  const extraHazValid =
    extraHazards.length === extraObservations.length &&
    extraHazards.every(
      (h, idx) =>
        h !== "-Не выбрано-" &&
        (h !== "-Нет в списке-" || !!(extraManualHazards[idx] ?? "").trim()),
    );
  const minObsRequired =
    displayTitle === "Регистрация ПАБ" && !isAdminOrSuper ? 3 : 1;
  const obsCount = useMemo(
    () =>
      [description, ...extraObservations]
        .map((s) => (s ?? "").trim())
        .filter(Boolean).length,
    [description, extraObservations],
  );
  const [minObsWarningOpen, setMinObsWarningOpen] = useState(false);

  // Guards placed after all hooks to keep hook order stable across renders
  if (isInitialLoading) {
    return (
      <div className="max-w-3xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Загрузка…</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Проверяем статус доступа.
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }
  if (me && !me.canAccessNow) {
    return <AccessRestrictionNotice blocked={(me as any).isBlocked ?? false} />;
  }

  const canEdit = true;

  const canSave =
    Boolean(
      date &&
        shop &&
        section &&
        objectInspected &&
        description &&
        auditorName &&
        auditorJobTitle &&
        actions &&
        responsibleName &&
        dueDate,
    ) &&
    categoryValid &&
    conditionType !== "-Не выбрано-" &&
    hazardFactorValid &&
    extraObsValid &&
    extraActsValid &&
    extraCatsValid &&
    extraCondsValid &&
    extraHazValid;

  const baseCategories = [
    "Реакция работника (РР)",
    "Положение/поза работника, действие людей (ПР)",
    "Спецодежда и другие средства индивидуальной защиты (СИЗ)",
    "Состояние инструментов и оборудования (ИО)",
    "Инструкции, правила и процедуры (ИП)",
    "Порядок на рабочем месте (ПМ)",
    "Другое (ДР)",
  ];

  const categories = [
    ...baseCategories,
    ...catalogs
      .filter((c) => c.kind === "CATEGORY" && c.value && !baseCategories.includes(c.value))
      .map((c) => c.value),
  ];

  const conditionTypes = [
    "Безопасное действие",
    "Безопасное условие",
    "Опасное действие",
    "Опасное условие",
    "Опасная ситуация",
  ];

  return (
    <div className="max-w-3xl mx-auto p-4 sm:p-6">
      <Card className="card-elevated h-full">
        <div ref={pdfRef}>
          <CardHeader>
            <CardTitle>{`АКТ наблюдений ПАБ: ${displayTitle}`}</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            {/* Верхняя панель с названием листа и номером документа */}
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div className="space-y-1.5">
                <Label>Название листа</Label>
                  <Input
                    value={codePreview?.code || displayTitle}
                    readOnly
                    placeholder={codeLoading ? "Определяем…" : displayTitle}
                  />              </div>
              <div className="space-y-1.5">
                <Label>Номер документа</Label>
                <Input
                  value={codePreview?.code || ""}
                  readOnly
                  placeholder={codeLoading ? "Определяем номер…" : ""}
                />
              </div>
            </div>
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div className="space-y-1.5">
                <Label>Дата *</Label>
                <Input
                  type="date"
                  value={date}
                  onChange={(e) => setDate(e.target.value)}
                />
              </div>
              <div className="space-y-1.5">
                <Label>ФИО проверяющего *</Label>
                <Input
                  value={auditorName}
                  onChange={(e) => setAuditorName(e.target.value)}
                  placeholder="Иванов Иван Иванович"
                />
              </div>
              <div className="sm:col-span-2 space-y-1.5">
                <Label>Должность проверяющего *</Label>
                <Input
                  value={auditorJobTitle}
                  onChange={(e) => setAuditorJobTitle(e.target.value)}
                  placeholder="Инженер по охране труда"
                />
              </div>
              <div className="space-y-1.5">
                <Label>Участок *</Label>
                <Input
                  value={section}
                  onChange={(e) => setSection(e.target.value)}
                  placeholder="Участок"
                />
              </div>
              <div className="space-y-1.5">
                <Label>Проверяемый объект *</Label>
                <Input
                  value={objectInspected}
                  onChange={(e) => setObjectInspected(e.target.value)}
                  placeholder=""
                />
              </div>
              <div className="sm:col-span-2 space-y-1.5">
                <Label>Наблюдение №1 *</Label>
                <Textarea
                  value={description}
                  onChange={(e) => setDescription(e.target.value)}
                  placeholder="Кратко опишите ситуацию…"
                />
              </div>

              <div className="space-y-1.5">
                <Label>Фотография нарушения</Label>
                <div
                  className={`file-cell ${photoUploading ? "file-cell-uploading" : photoBase64 ? "file-cell-success" : ""}`}
                >
                  <ImageIcon className="h-5 w-5 text-muted-foreground" />
                  <span className="text-sm">
                    {photoUploading
                      ? "Загружается фото…"
                      : photoBase64
                        ? "Фото загружено"
                        : "Выберите файл"}
                  </span>
                  <Input
                    ref={fileInputRef}
                    type="file"
                    accept="image/*"
                    disabled={photoUploading}
                    onChange={async (e) => {
                      const inputEl = e.target as HTMLInputElement;
                      const f = inputEl.files?.[0];
                      if (!f) return;
                      setPhotoUploading(true);
                      try {
                        const base64 = await encodeFileAsBase64DataURL(f);
                        if (!base64) {
                          toast({ title: "Файл слишком большой" });
                          try {
                            inputEl.value = "";
                          } catch {
                            /* ignore */
                          }
                          return;
                        }
                        setPhotoBase64(base64);
                      } catch (err) {
                        console.error("Image encode failed", err);
                        toast({ title: "Не удалось прочитать файл" });
                        try {
                          inputEl.value = "";
                        } catch {
                          /* ignore */
                        }
                      } finally {
                        setPhotoUploading(false);
                      }
                    }}
                    className="flex-1"
                  />
                </div>
              </div>
              <div className="space-y-1.5">
                <Label>Подразделение *</Label>
                <Input
                  value={shop}
                  onChange={(e) => setShop(e.target.value)}
                  placeholder="Напр. ЗИФ"
                />
              </div>
              <div className="space-y-1.5">
                <Label
                  className={!categoryValid ? "text-destructive" : undefined}
                >
                  Категория наблюдений *
                </Label>
                <select
                  className={`w-full border rounded-md h-10 px-3 bg-background ${categoryValid ? "border-input focus:outline-none focus:ring-2 focus:ring-ring" : "border-destructive focus:outline-none focus:ring-2 focus:ring-destructive"}`}
                  value={category}
                  onChange={(e) => setCategory(e.target.value)}
                >
                  <option value="-Не выбрано-">-Не выбрано-</option>
                  {categories.map((c) => (
                    <option key={c} value={c}>
                      {c}
                    </option>
                  ))}
                </select>
                {requiresManualCategory && (
                  <div className="mt-2 space-y-1.5">
                    <Label className="text-destructive">
                      Укажите категорию*
                    </Label>
                    <Input
                      value={manualCategory}
                      onChange={(e) => setManualCategory(e.target.value)}
                      placeholder="Введите свою категорию"
                      className={`${!manualCategory.trim() ? "border-destructive focus:ring-destructive" : ""}`}
                    />
                  </div>
                )}
              </div>
              <div className="space-y-1.5">
                <Label>Вид условий и действий *</Label>
                <select
                  className={`w-full border rounded-md h-10 px-3 bg-background ${conditionType === "-Не выбрано-" ? "border-destructive focus:outline-none focus:ring-2 focus:ring-destructive" : "border-input focus:outline-none focus:ring-2 focus:ring-ring"}`}
                  value={conditionType}
                  onChange={(e) => setConditionType(e.target.value)}
                >
                  <option value="-Не выбрано-">-Не выбрано-</option>
                  {conditionTypes.map((c) => (
                    <option key={c} value={c}>
                      {c}
                    </option>
                  ))}
                </select>
              </div>
              <div className="sm:col-span-2 space-y-1.5">
                <Label
                  className={
                    !hazardFactorValid ? "text-destructive" : undefined
                  }
                >
                  Опасные факторы *
                </Label>
                <select
                  className={`w-full border rounded-md h-10 px-3 bg-background ${hazardFactorValid ? "border-input focus:outline-none focus:ring-2 focus:ring-ring" : "border-destructive focus:outline-none focus:ring-2 focus:ring-destructive"}`}
                  value={hazardFactor}
                  onChange={(e) => setHazardFactor(e.target.value)}
                >
                  <option value="-Не выбрано-">-Не выбрано-</option>
                  {hazardOptions.map((h) => (
                    <option key={h} value={h}>
                      {h}
                    </option>
                  ))}
                </select>
                {requiresManualHazard && (
                  <div className="mt-2 space-y-1.5">
                    <Label className="text-destructive">
                      Заполнить вручную*
                    </Label>
                    <Input
                      value={manualHazard}
                      onChange={(e) => setManualHazard(e.target.value)}
                      placeholder="Опишите опасный фактор"
                      className={`${!manualHazard.trim() ? "border-destructive focus:ring-destructive" : ""}`}
                    />
                  </div>
                )}
              </div>
              {/* Дополнительные поля для каждого добавленного наблюдения */}
              {extraObservations.map((_, idx) => {
                const extraCategory = extraCategories[idx] ?? "-Не выбрано-";
                const extraHazard = extraHazards[idx] ?? "-Не выбрано-";
                const requiresManualCat = extraCategory === "Другое (ДР)";
                const requiresManualHaz = extraHazard === "-Нет в списке-";
                return (
                  <React.Fragment key={`obs-fields-${idx}`}>
                    <div className="space-y-1.5">
                      <Label
                        className={`${((extraCategories[idx] ?? "-Не выбрано-") === "-Не выбрано-" || (requiresManualCat && !(extraManualCategories[idx] ?? "").trim())) && showValidation ? "text-destructive" : ""}`}
                      >{`Категория наблюдений №${idx + 2} *`}</Label>
                      <select
                        className={`w-full border rounded-md h-10 px-3 bg-background ${((extraCategories[idx] ?? "-Не выбрано-") === "-Не выбрано-" || (requiresManualCat && !(extraManualCategories[idx] ?? "").trim())) && showValidation ? "border-destructive focus:outline-none focus:ring-2 focus:ring-destructive" : "border-input focus:outline-none focus:ring-2 focus:ring-ring"}`}
                        value={extraCategories[idx] ?? "-Не выбрано-"}
                        onChange={(e) =>
                          setExtraCategories((prev) => {
                            const copy = [...prev];
                            copy[idx] = e.target.value;
                            return copy;
                          })
                        }
                      >
                        <option value="-Не выбрано-">-Не выбрано-</option>
                        {categories.map((c) => (
                          <option key={c} value={c}>
                            {c}
                          </option>
                        ))}
                      </select>
                      {requiresManualCat && (
                        <div className="mt-2 space-y-1.5">
                          <Label className="text-destructive">{`Укажите категорию №${idx + 2}*`}</Label>
                          <Input
                            value={extraManualCategories[idx] ?? ""}
                            onChange={(e) =>
                              setExtraManualCategories((prev) => {
                                const copy = [...prev];
                                copy[idx] = e.target.value;
                                return copy;
                              })
                            }
                            placeholder="Введите свою категорию"
                            className={`${!(extraManualCategories[idx] ?? "").trim() ? "border-destructive focus:ring-destructive" : ""}`}
                          />
                        </div>
                      )}
                    </div>

                    <div className="space-y-1.5">
                      <Label
                        className={`${(extraConditionTypes[idx] ?? "-Не выбрано-") === "-Не выбрано-" && showValidation ? "text-destructive" : ""}`}
                      >{`Вид условий и действий №${idx + 2} *`}</Label>
                      <select
                        className={`w-full border rounded-md h-10 px-3 bg-background ${(extraConditionTypes[idx] ?? "-Не выбрано-") === "-Не выбрано-" && showValidation ? "border-destructive focus:outline-none focus:ring-2 focus:ring-destructive" : "border-input focus:outline-none focus:ring-2 focus:ring-ring"}`}
                        value={extraConditionTypes[idx] ?? "-Не выбрано-"}
                        onChange={(e) =>
                          setExtraConditionTypes((prev) => {
                            const copy = [...prev];
                            copy[idx] = e.target.value;
                            return copy;
                          })
                        }
                      >
                        <option value="-Не выбрано-">-Не выбрано-</option>
                        {conditionTypes.map((c) => (
                          <option key={c} value={c}>
                            {c}
                          </option>
                        ))}
                      </select>
                    </div>

                    <div className="sm:col-span-2 space-y-1.5">
                      <Label
                        className={`${(extraHazards[idx] ?? "-Не выбрано-") === "-Не выбрано-" || (requiresManualHaz && !(extraManualHazards[idx] ?? "").trim()) ? "text-destructive" : ""}`}
                      >{`Опасные факторы №${idx + 2} *`}</Label>
                      <select
                        className={`w-full border rounded-md h-10 px-3 bg-background ${(extraHazards[idx] ?? "-Не выбрано-") === "-Не выбрано-" || (requiresManualHaz && !(extraManualHazards[idx] ?? "").trim()) ? "border-destructive focus:outline-none focus:ring-2 focus:ring-destructive" : "border-input focus:outline-none focus:ring-2 focus:ring-ring"}`}
                        value={extraHazards[idx] ?? "-Не выбрано-"}
                        onChange={(e) =>
                          setExtraHazards((prev) => {
                            const copy = [...prev];
                            copy[idx] = e.target.value;
                            return copy;
                          })
                        }
                      >
                        <option value="-Не выбрано-">-Не выбрано-</option>
                        {hazardOptions.map((h) => (
                          <option key={h} value={h}>
                            {h}
                          </option>
                        ))}
                      </select>
                      {requiresManualHaz && (
                        <div className="mt-2 space-y-1.5">
                          <Label className="text-destructive">
                            Заполнить вручную*
                          </Label>
                          <Input
                            value={extraManualHazards[idx] ?? ""}
                            onChange={(e) =>
                              setExtraManualHazards((prev) => {
                                const copy = [...prev];
                                copy[idx] = e.target.value;
                                return copy;
                              })
                            }
                            placeholder="Опишите опасный фактор"
                            className={`${!(extraManualHazards[idx] ?? "").trim() ? "border-destructive focus:ring-destructive" : ""}`}
                          />
                        </div>
                      )}
                    </div>
                    {/* Фото для наблюдения №{idx + 2} */}
                    <div className="space-y-1.5">
                      <Label>{`Фото для наблюдения №${idx + 2}`}</Label>
                      <div className="flex items-center gap-2">
                        <span className="hidden" />
                        <Input
                          type="file"
                          accept="image/*"
                          onChange={async (e) => {
                            const inputEl = e.target as HTMLInputElement;
                            const f = inputEl.files?.[0];
                            if (!f) return;
                            try {
                              const base64 = await encodeFileAsBase64DataURL(f);
                              if (!base64) {
                                toast({ title: "Файл слишком большой" });
                                try {
                                  inputEl.value = "";
                                } catch {}
                                return;
                              }
                              setExtraPhotoBase64s((prev) => {
                                const copy = [...prev];
                                copy[idx] = base64;
                                return copy;
                              });
                            } catch (err) {
                              console.error("Image encode failed", err);
                              toast({ title: "Не удалось прочитать файл" });
                              try {
                                inputEl.value = "";
                              } catch {}
                            }
                          }}
                        />
                        <ImageIcon className="h-5 w-5 text-muted-foreground" />
                      </div>
                      {extraPhotoBase64s[idx] && (
                        <div className="text-xs text-muted-foreground truncate">Файл выбран</div>
                      )}
                    </div>
                   </React.Fragment>                );
              })}
              {!extraCatsValid && showValidation && (
                <div className="text-sm text-destructive">
                  Заполните «Категория наблюдений» для каждого дополнительного
                  наблюдения
                </div>
              )}
              {!extraCondsValid && showValidation && (
                <div className="text-sm text-destructive">
                  Заполните «Вид условий и действий» для каждого дополнительного
                  наблюдения
                </div>
              )}
              {!extraHazValid && showValidation && (
                <div className="text-sm text-destructive">
                  Заполните «Опасные факторы» для каждого дополнительного
                  наблюдения
                </div>
              )}
              <div className="sm:col-span-2 space-y-1.5">
                <Label>Мероприятия *</Label>
                <Textarea
                  value={actions}
                  onChange={(e) => setActions(e.target.value)}
                  placeholder="Что нужно сделать…"
                />
              </div>
              {extraObservations.map((_, idx) => (
                <div key={`act-${idx}`} className="sm:col-span-2 space-y-1.5">
                  <Label
                    className={
                      !extraActions[idx]?.trim() && showValidation
                        ? "text-destructive"
                        : undefined
                    }
                  >{`Мероприятия для наблюдения №${idx + 2} *`}</Label>
                  <Textarea
                    value={extraActions[idx] ?? ""}
                    onChange={(e) =>
                      setExtraActions((prev) => {
                        const copy = [...prev];
                        copy[idx] = e.target.value;
                        return copy;
                      })
                    }
                    placeholder="Что нужно сделать…"
                    className={`${!extraActions[idx]?.trim() && showValidation ? "border-destructive focus:ring-destructive" : ""}`}
                  />
                </div>
              ))}
              {!extraActsValid && showValidation && (
                <div className="sm:col-span-2 text-sm text-destructive">
                  Заполните мероприятия для каждого дополнительного наблюдения
                </div>
              )}
              <div className="sm:col-span-2 space-y-2 mt-4">
                <Button
                  variant="secondary"
                  onClick={() => {
                    setExtraObservations((prev) => [...prev, ""]);
                    setExtraActions((prev) => [...prev, ""]);
                    setExtraCategories((prev) => [...prev, "-Не выбрано-"]);
                    setExtraConditionTypes((prev) => [...prev, "-Не выбрано-"]);
                    setExtraHazards((prev) => [...prev, "-Не выбрано-"]);
                    setExtraManualHazards((prev) => [...prev, ""]);
                    setExtraManualCategories((prev) => [...prev, ""]);
                    setExtraPhotoBase64s((prev) => [...prev, ""]);
                  }}
                >
                  Добавить наблюдение
                </Button>
                {extraObservations.map((obs, idx) => (
                  <div key={idx} className="space-y-1.5">
                    <Label
                      className={
                        !obs?.trim() && showValidation
                          ? "text-destructive"
                          : undefined
                      }
                    >{`Наблюдение №${idx + 2} *`}</Label>
                    <Textarea
                      value={obs}
                      onChange={(e) =>
                        setExtraObservations((prev) => {
                          const copy = [...prev];
                          copy[idx] = e.target.value;
                          return copy;
                        })
                      }
                      placeholder="Опишите наблюдение…"
                      className={`${!obs?.trim() && showValidation ? "border-destructive focus:ring-destructive" : ""}`}
                    />
                  </div>
                ))}
                {!extraObsValid && showValidation && (
                  <div className="text-sm text-destructive">
                    Заполните все дополнительные наблюдения
                  </div>
                )}
              </div>
              <div className="space-y-1.5">
                <Label>Ответственный за выполнение *</Label>
                {/* Быстрый выбор из выпадающего списка зарегистрированных пользователей */}
                <div className="space-y-2">
                  <div className="w-full">
                    <select
                      className="w-full border rounded-md h-10 px-3 bg-background"
                      value={responsibleUserId ?? ""}
                      onChange={(e) => {
                        const val = e.target.value;
                        const u = (dropdownUsers || []).find(
                          (x: any) => x.id === val,
                        );
                        setResponsibleUserId(val || undefined);
                        setResponsibleName(u?.fullName ?? u?.email ?? "");
                      }}
                    >
                      <option value="">Выберите из списка</option>
                      {(dropdownUsers || []).map((u: any) => (
                        <option key={u.id} value={u.id}>
                          {u.fullName || u.email || u.id}
                        </option>
                      ))}
                    </select>
                  </div>
                  {/* Ручной ввод (опционально) */}
                  <div className="flex items-center gap-2">
                    <span className="hidden" />
                    <Input
                      value={responsibleName ?? ""}
                      onChange={(e) =>
                        setResponsibleName(e.target.value || undefined)
                      }
                      placeholder="Ф.И.О. или оставьте пустым"
                    />
                  </div>
                </div>
              </div>{" "}
              <div className="space-y-1.5">
                <Label>Срок *</Label>
                <Input
                  type="date"
                  value={dueDate}
                  onChange={(e) => setDueDate(e.target.value)}
                />
              </div>
            </div>
          </CardContent>
        </div>
        <CardFooter className="flex flex-wrap gap-2">
                     {canEdit && (            <Button variant="secondary" onClick={() => navigate("/home")}>
              Назад на главную
            </Button>
          )}
                     {(canEdit && isAdminOrSuper) && (            <Button
               onClick={async () => {                if (obsCount < minObsRequired) {
                  setMinObsWarningOpen(true);
                  try {
                    playAttentionBeep();
                  } catch {
                    /* ignore */
                  }
                  return;
                }
                if (!canSave) {
                  setShowValidation(true);
                  toast({ title: "Заполните обязательные поля" });
                  return;
                }
                const auditorStr =
                  `${auditorJobTitle ? auditorJobTitle + ", " : ""}${auditorName}`.trim();
                const hazardFactorToSave =
                  hazardFactor === "-Нет в списке-"
                    ? manualHazard.trim()
                    : hazardFactor;
                const obsTexts = [description, ...extraObservations]
                  .map((s) => s.trim())
                  .filter(Boolean);
                const allCats = [
                  category,
                  ...extraCategories.map((c, i) =>
                    c === "Другое (ДР)"
                      ? (extraManualCategories[i] ?? "").trim()
                      : c,
                  ),
                ];
                const allConds = [conditionType, ...extraConditionTypes];
                const allHaz = [
                  hazardFactorToSave,
                  ...extraHazards.map((h, idx) =>
                    h === "-Нет в списке-"
                      ? (extraManualHazards[idx] ?? "").trim()
                      : h,
                  ),
                ];
                const combinedDescription = obsTexts
                  .map((t, i) =>
                    [
                      obsTexts.length > 1 ? `Наблюдение №${i + 1}: ${t}` : t,
                      `Категория наблюдений №${i + 1}: ${allCats[i]}`,
                      `Вид условий и действий №${i + 1}: ${allConds[i]}`,
                      `Опасные факторы №${i + 1}: ${allHaz[i]}`,
                    ].join("\n"),
                  )
                  .join("\n\n");
                const photosCombined = [photoBase64, ...extraPhotoBase64s].filter(Boolean) as string[];
                createMutation.mutate({
                  date,
                  shop,
                  section,
                  objectInspected,
                  description: combinedDescription,
                  photoBase64,
                  auditor: auditorStr,
                  category,
                  conditionType,
                  hazardFactor: hazardFactorToSave,
                  note,
                  actions: [actions, ...extraActions]
                    .map((s) => s.trim())
                    .filter(Boolean)
                    .map((t, i) => `Мероприятия для наблюдения №${i + 1}: ${t}`)
                    .join("\n\n"),
                  responsibleUserId,
                  responsibleName,
                  dueDate: dueDate || undefined,
                   status,
                   photoBase64List: ([photoBase64, ...extraPhotoBase64s].filter(Boolean) as string[]),                });
              }}
            >
              <Save className="h-4 w-4 mr-2" /> Сохранить
            </Button>
          )}{" "}
          <Button
            className="btn-3d"
            disabled={createMutation.isLoading || sendAllMutation.isLoading}
            onClick={async () => {
              if (obsCount < minObsRequired) {
                setMinObsWarningOpen(true);
                try {
                  playAttentionBeep();
                } catch {
                  /* ignore */
                }
                return;
              }
              if (!canSave) {
                setShowValidation(true);
                toast({ title: "Заполните обязательные поля" });
                return;
              }
              const auditorStr =
                `${auditorJobTitle ? auditorJobTitle + ", " : ""}${auditorName}`.trim();
              try {
                const hazardFactorToSave =
                  hazardFactor === "-Нет в списке-"
                    ? manualHazard.trim()
                    : hazardFactor;
                const obsTexts = [description, ...extraObservations]
                  .map((s) => s.trim())
                  .filter(Boolean);
                const categoryToSave = requiresManualCategory
                  ? manualCategory.trim()
                  : category;
                const allCats = [
                  categoryToSave,
                  ...extraCategories.map((c, i) =>
                    c === "Другое (ДР)"
                      ? (extraManualCategories[i] ?? "").trim()
                      : c,
                  ),
                ];
                const allConds = [conditionType, ...extraConditionTypes];
                const allHaz = [
                  hazardFactorToSave,
                  ...extraHazards.map((h, idx) =>
                    h === "-Нет в списке-"
                      ? (extraManualHazards[idx] ?? "").trim()
                      : h,
                  ),
                ];
                const combinedDescription = obsTexts
                  .map((t, i) =>
                    [
                      obsTexts.length > 1 ? `Наблюдение №${i + 1}: ${t}` : t,
                      `Категория наблюдений №${i + 1}: ${allCats[i]}`,
                      `Вид условий и действий №${i + 1}: ${allConds[i]}`,
                      `Опасные факторы №${i + 1}: ${allHaz[i]}`,
                    ].join("\n"),
                  )
                  .join("\n\n");
                 const photosCombined = [photoBase64, ...extraPhotoBase64s].filter(Boolean) as string[];
                 const created = await createMutation.mutateAsync({                  date,
                  shop,
                  section,
                  objectInspected,
                  description: combinedDescription,
                  photoBase64,
                  auditor: auditorStr,
                  category: categoryToSave,
                  conditionType,
                  hazardFactor: hazardFactorToSave,
                  note,
                  actions: [actions, ...extraActions]
                    .map((s) => s.trim())
                    .filter(Boolean)
                    .map((t, i) => `Мероприятия для наблюдения №${i + 1}: ${t}`)
                    .join("\n\n"),
                  responsibleUserId,
                  responsibleName,
                  dueDate: dueDate || undefined,
                   status,
                   photoBase64List: ([photoBase64, ...extraPhotoBase64s].filter(Boolean) as string[]),                } as any);
                const createdId = (created as any)?.id;
                if (!createdId) {
                  toast({
                    title: "Не удалось сохранить запись перед отправкой",
                  });
                  return;
                }
                await sendAllMutation.mutateAsync({ violationId: createdId });
              } catch {
                toast({ title: "Не удалось выполнить отправку" });
              }
            }}
          >
            Отправить
          </Button>
                     {canEdit && (            <Button
              variant="outline"
              disabled={!canSave || excelMutation.isLoading}
              onClick={() => {
                if (!canSave) {
                  setShowValidation(true);
                  toast({ title: "Заполните обязательные поля" });
                  return;
                }
                const auditorStr =
                  `${auditorJobTitle ? auditorJobTitle + ", " : ""}${auditorName}`.trim();
                const hazardFactorToSave =
                  hazardFactor === "-Нет в списке-"
                    ? manualHazard.trim()
                    : hazardFactor;
                const obsTexts = [description, ...extraObservations]
                  .map((s) => s.trim())
                  .filter(Boolean);
                const allCats = [
                  category,
                  ...extraCategories.map((c, i) =>
                    c === "Другое (ДР)"
                      ? (extraManualCategories[i] ?? "").trim()
                      : c,
                  ),
                ];
                const allConds = [conditionType, ...extraConditionTypes];
                const allHaz = [
                  hazardFactorToSave,
                  ...extraHazards.map((h, idx) =>
                    h === "-Нет в списке-"
                      ? (extraManualHazards[idx] ?? "").trim()
                      : h,
                  ),
                ];
                const combinedDescription = obsTexts
                  .map((t, i) =>
                    [
                      obsTexts.length > 1 ? `Наблюдение №${i + 1}: ${t}` : t,
                      `Категория наблюдений №${i + 1}: ${allCats[i]}`,
                      `Вид условий и действий №${i + 1}: ${allConds[i]}`,
                      `Опасные факторы №${i + 1}: ${allHaz[i]}`,
                    ].join("\n"),
                  )
                  .join("\n\n");
                 const photosCombined = [photoBase64, ...extraPhotoBase64s].filter(Boolean) as string[];
                 excelMutation.mutate({                  date,
                  shop,
                  section,
                  objectInspected,
                  description: combinedDescription,
                  auditor: auditorStr,
                  category,
                  conditionType,
                  hazardFactor: hazardFactorToSave,
                  note,
                  actions: [actions, ...extraActions]
                    .map((s) => s.trim())
                    .filter(Boolean)
                    .map((t, i) => `Мероприятия для наблюдения №${i + 1}: ${t}`)
                    .join("\n\n"),
                  responsibleUserId,
                  responsibleName,
                  dueDate: dueDate || undefined,
                  photoBase64: photoBase64,
                   code: codePreview?.code,
                   photoBase64List: photosCombined as any,                });
              }}
            >
              <Download className="h-4 w-4 mr-2" /> Скачать в Excel
            </Button>
          )}{" "}
                     {canEdit && (            <Button
              variant="outline"
              disabled={exportingPdf}
              onClick={async () => {
                if (obsCount < minObsRequired) {
                  setMinObsWarningOpen(true);
                  try {
                    playAttentionBeep();
                  } catch {
                    /* ignore */
                  }
                  return;
                }
                if (!pdfRef.current) return;
                try {
                  setExportingPdf(true);
                  const element = pdfRef.current as HTMLElement;

                  const canvas = await html2canvas(element, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: "#ffffff",
                  });
                  const imgData = canvas.toDataURL("image/png");
                  const pdf = new jsPDF("p", "mm", "a4");
                  const pageWidth = pdf.internal.pageSize.getWidth();
                  const pageHeight = pdf.internal.pageSize.getHeight();
                  const imgWidth = pageWidth;
                  const imgHeight = (canvas.height * imgWidth) / canvas.width;
                  let heightLeft = imgHeight;
                  let position = 0;
                  pdf.addImage(
                    imgData,
                    "PNG",
                    0,
                    position,
                    imgWidth,
                    imgHeight,
                  );
                  heightLeft -= pageHeight;
                  while (heightLeft > 0) {
                    pdf.addPage();
                    position -= pageHeight;
                    pdf.addImage(
                      imgData,
                      "PNG",
                      0,
                      position,
                      imgWidth,
                      imgHeight,
                    );
                    heightLeft -= pageHeight;
                  }
                  const safe = (s: string) =>
                    (s || "")
                      .replace(/[\\/:*?"<>|]+/g, " ")
                      .replace(/\s+/g, " ")
                      .trim();
                  const fileName =
                    safe(
                      `${codePreview?.code || displayTitle}_${date}_${safe(shop)}_${safe(section)}`,
                    ) || "pab";
                  if (codePreview?.code) {
                    try {
                      pdf.setFontSize(12);
                      pdf.setTextColor(0, 0, 0);
                      pdf.text(
                        `Номер предписания: ${codePreview.code}`,
                        10,
                        10,
                      );
                    } catch {
                      /* ignore */
                    }
                  }
                  pdf.save(`${fileName}.pdf`);
                } catch {
                  console.error("PDF export failed");
                  toast({ title: "Не удалось сформировать PDF" });
                } finally {
                  setExportingPdf(false);
                }
              }}
            >
              {exportingPdf ? "Готовим PDF…" : "Скачать в PDF"}
            </Button>
          )}{" "}
                     {canEdit && (            <Button
              variant="outline"
              disabled={!canSave || sending}
              onClick={async () => {
                if (!canSave) {
                  setShowValidation(true);
                  toast({ title: "Заполните обязательные поля" });
                  return;
                }
                setSending(true);
                const auditorStr =
                  `${auditorJobTitle ? auditorJobTitle + ", " : ""}${auditorName}`.trim();
                const hazardFactorToSave =
                  hazardFactor === "-Нет в списке-"
                    ? manualHazard.trim()
                    : hazardFactor;
                const res = await createMutation.mutateAsync({
                  date,
                  shop,
                  section,
                  objectInspected,
                  description: [description, ...extraObservations]
                    .map((s) => s.trim())
                    .filter(Boolean)
                    .map((t, i, arr) =>
                      arr.length > 1 ? `Наблюдение №${i + 1}: ${t}` : t,
                    )
                    .join("\n\n"),
                  photoBase64,
                  auditor: auditorStr,
                  category,
                  conditionType,
                  hazardFactor: hazardFactorToSave,
                  note,
                  actions: [actions, ...extraActions]
                    .map((s) => s.trim())
                    .filter(Boolean)
                    .map((t, i) => `Мероприятия для наблюдения №${i + 1}: ${t}`)
                    .join("\n\n"),
                  responsibleUserId,
                  responsibleName,
                  dueDate: dueDate || undefined,
                   status,
                   photoBase64List: ([photoBase64, ...extraPhotoBase64s].filter(Boolean) as string[]),                });
                void res;
                const auditorStr2 =
                  `${auditorJobTitle ? auditorJobTitle + ", " : ""}${auditorName}`.trim();
                const hazardFactorToSave2 =
                  hazardFactor === "-Нет в списке-"
                    ? manualHazard.trim()
                    : hazardFactor;
                const obsTexts2 = [description, ...extraObservations]
                  .map((s) => s.trim())
                  .filter(Boolean);
                const categoryToSave2 = requiresManualCategory
                  ? manualCategory.trim()
                  : category;
                const allCats2 = [
                  categoryToSave2,
                  ...extraCategories.map((c, i) =>
                    c === "Другое (ДР)"
                      ? (extraManualCategories[i] ?? "").trim()
                      : c,
                  ),
                ];
                const allConds2 = [conditionType, ...extraConditionTypes];
                const allHaz2 = [
                  hazardFactorToSave2,
                  ...extraHazards.map((h, idx) =>
                    h === "-Нет в списке-"
                      ? (extraManualHazards[idx] ?? "").trim()
                      : h,
                  ),
                ];
                const combinedDescription2 = obsTexts2
                  .map((t, i) =>
                    [
                      obsTexts2.length > 1 ? `Наблюдение №${i + 1}: ${t}` : t,
                      `Категория наблюдений №${i + 1}: ${allCats2[i]}`,
                      `Вид условий и действий №${i + 1}: ${allConds2[i]}`,
                      `Опасные факторы №${i + 1}: ${allHaz2[i]}`,
                    ].join("\n"),
                  )
                  .join("\n\n");
                 const photosCombined = [photoBase64, ...extraPhotoBase64s].filter(Boolean) as string[];
                 docxMutation.mutate({                  date,
                  shop,
                  section,
                  objectInspected,
                  description: combinedDescription2,
                  auditor: auditorStr2,
                  category,
                  conditionType,
                  hazardFactor: hazardFactorToSave2,
                  note,
                  actions: [actions, ...extraActions]
                    .map((s) => s.trim())
                    .filter(Boolean)
                    .map((t, i) => `Мероприятия для наблюдения №${i + 1}: ${t}`)
                    .join("\n\n"),
                  responsibleName,
                  dueDate: dueDate || undefined,
                  photoBase64: photoBase64,
                   code: codePreview?.code || undefined,
                   photoBase64List: photosCombined as any,                });
              }}
            >
              <FileText className="h-4 w-4 mr-2" /> Скачать в Word
            </Button>
          )}{" "}
        </CardFooter>
      </Card>
      <Dialog open={minObsWarningOpen} onOpenChange={setMinObsWarningOpen}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>
              {minObsRequired === 3
                ? "Требуется минимум 3 наблюдений"
                : "Требуется минимум 1 наблюдение"}
            </DialogTitle>
            <DialogDescription>
              {minObsRequired === 3
                ? "Вам необходимо заполнить не менее трёх наблюдений"
                : "Вам необходимо заполнить не менее одного наблюдения"}
              <br />
              Также проверьте, все ли поля заполнены
            </DialogDescription>
          </DialogHeader>
        </DialogContent>
      </Dialog>
    </div>
  );
}

function MyViolationsScreen() {
  useAuth({ required: true });
  const { data: me, isInitialLoading } = useQuery<Profile>(["me"], () =>
    apiClient.getMyProfile(),
  );

  const [from, setFrom] = useState<string>("");
  const [to, setTo] = useState<string>("");
  const [query, setQuery] = useState<string>("");
  const [status, setStatus] = useState<string>("");
  const [page, setPage] = useState<number>(1);

  const { data: stats, isInitialLoading: statsLoading } = useQuery<MyStats>(
    ["my-violation-stats", from, to],
    () =>
      apiClient.getMyViolationsStats({
        from: from || undefined,
        to: to || undefined,
      }),
    {
      enabled: !isInitialLoading && !!me?.canAccessNow,
      keepPreviousData: true,
      refetchInterval: 30000,
    },
  );

  const { data: list, isInitialLoading: listLoading } =
    useQuery<MyViolationsPage>(
      ["my-violations", query, status, from, to, page],
      () =>
        apiClient.listMyViolations({
          from: from || undefined,
          to: to || undefined,
          query: query || undefined,
          status: status || undefined,
          page,
          pageSize: 10,
        }),
      {
        enabled: !isInitialLoading && !!me?.canAccessNow,
        keepPreviousData: true,
      },
    );

  if (isInitialLoading) {
    return (
      <div className="max-w-5xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Загрузка…</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Проверяем статус доступа.
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }
  if (me && !me.canAccessNow) {
    return <AccessRestrictionNotice blocked={(me as any).isBlocked ?? false} />;
  }

  return (
    <div className="w-full max-w-[120rem] mx-auto px-4 sm:px-6 space-y-4">
      <Card className="card-elevated h-full">
        <CardHeader className="flex items-center justify-between">
          <CardTitle>Мои нарушения</CardTitle>
          <div className="flex gap-2">
            <Input
              type="date"
              value={from}
              onChange={(e) => setFrom(e.target.value)}
            />
            <Input
              type="date"
              value={to}
              onChange={(e) => setTo(e.target.value)}
            />
          </div>
        </CardHeader>
        <CardContent className="space-y-4">
          {/* Табло с цифрами */}
          <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
            <div className="p-3 border rounded">
              <div className="text-xs text-muted-foreground">Всего</div>
              <div className="text-2xl font-semibold text-stats-total">
                {statsLoading ? "…" : (stats?.total ?? 0)}
              </div>
            </div>
            <div className="p-3 border rounded">
              <div className="text-xs text-muted-foreground">Устранено</div>
              <div className="text-2xl font-semibold text-green-600">
                {statsLoading ? "…" : (stats?.resolved ?? 0)}
              </div>
            </div>
            <div className="p-3 border rounded">
              <div className="text-xs text-muted-foreground">В работе</div>
              <div className="text-2xl font-semibold text-blue-600">
                {statsLoading ? "…" : (stats?.inProgress ?? 0)}
              </div>
            </div>
            <div className="p-3 border rounded">
              <div className="text-xs text-muted-foreground">Просрочено</div>
              <div className="text-2xl font-semibold text-red-600">
                {statsLoading ? "…" : (stats?.overdue ?? 0)}
              </div>
            </div>
          </div>

          {/* Панель фильтров */}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-2">
            <Input
              placeholder="Поиск: где, что, описание, категория…"
              value={query}
              onChange={(e) => {
                setQuery(e.target.value);
                setPage(1);
              }}
            />
            <Input
              placeholder="Статус"
              value={status}
              onChange={(e) => {
                setStatus(e.target.value);
                setPage(1);
              }}
            />
          </div>

          {/* Список моих нарушений */}
          <div className="border rounded-md overflow-x-auto">
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead className="whitespace-nowrap">Дата</TableHead>
                  <TableHead className="whitespace-nowrap">Где</TableHead>
                  <TableHead className="whitespace-nowrap">Объект</TableHead>
                  <TableHead className="whitespace-nowrap">Описание</TableHead>
                  <TableHead className="whitespace-nowrap">Категория</TableHead>
                  <TableHead className="whitespace-nowrap">
                    Вид условий/действий
                  </TableHead>
                  <TableHead className="whitespace-nowrap">
                    Ответственный
                  </TableHead>
                  <TableHead className="whitespace-nowrap">Срок</TableHead>
                  <TableHead className="whitespace-nowrap">Статус</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {listLoading && (
                  <TableRow>
                    <TableCell
                      colSpan={9}
                      className="text-sm text-muted-foreground"
                    >
                      Загрузка…
                    </TableCell>
                  </TableRow>
                )}
                {!listLoading && list?.items?.length === 0 && (
                  <TableRow>
                    <TableCell
                      colSpan={9}
                      className="text-sm text-muted-foreground"
                    >
                      Нет данных. Перейдите к «Регистрация ПАБ», чтобы добавить
                      запись.
                    </TableCell>
                  </TableRow>
                )}
                {list?.items?.map((v: any) => (
                  <TableRow key={v.id}>
                    <TableCell className="align-top">
                      {new Date(v.date).toISOString().slice(0, 10)}
                    </TableCell>
                    <TableCell className="align-top truncate max-w-[200px]">
                      {v.shop}/{v.section}
                    </TableCell>
                    <TableCell className="align-top truncate max-w-[200px]">
                      {v.objectInspected}
                    </TableCell>
                    <TableCell className="align-top min-w-[260px]">
                      {v.description}
                    </TableCell>
                    <TableCell className="align-top">{v.category}</TableCell>
                    <TableCell className="align-top">
                      {v.conditionType}
                    </TableCell>
                    <TableCell className="align-top truncate max-w-[200px]">
                      {v.responsibleName || "—"}
                    </TableCell>
                    <TableCell className="align-top">
                      {v.dueDate
                        ? new Date(v.dueDate).toISOString().slice(0, 10)
                        : "—"}
                    </TableCell>
                    <TableCell className="align-top">
                      {v.status || "—"}
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
              {list?.items && list.items.length > 0 && (
                <TableCaption className="text-left">
                  Показаны {list.items.length} из {list.total}
                </TableCaption>
              )}
            </Table>
          </div>

          {/* Пагинация */}
          <div className="flex justify-between items-center text-sm text-muted-foreground">
            <div>Стр. {list?.page ?? page}</div>
            <div className="flex gap-2">
              <Button
                variant="secondary"
                disabled={(list?.page ?? 1) <= 1}
                onClick={() => setPage((p) => Math.max(1, p - 1))}
              >
                Назад
              </Button>
              <Button
                variant="secondary"
                disabled={!!list && list.page * list.pageSize >= list.total}
                onClick={() => setPage((p) => p + 1)}
              >
                Вперёд
              </Button>
            </div>
          </div>
        </CardContent>
        <CardFooter>
          <NavLink to="/home">
            <Button variant="outline">На главную</Button>
          </NavLink>
        </CardFooter>
      </Card>
    </div>
  );
}

function StatsScreen() {
  useAuth({ required: true });
  const { data: me, isInitialLoading } = useQuery<Profile>(["me"], () =>
    apiClient.getMyProfile(),
  );

  const [from, setFrom] = useState<string>("");
  const [to, setTo] = useState<string>("");

  const loc = useLocation();
  useEffect(() => {
    try {
      const sp = new URLSearchParams(loc.search);
      const f = sp.get("from") || "";
      const t = sp.get("to") || "";
      setFrom((prev) => (prev === f ? prev : f));
      setTo((prev) => (prev === t ? prev : t));
    } catch {
      /* ignore */
    }
  }, [loc.search]);

  const { data: stats, isInitialLoading: statsLoading } = useQuery<Stats>(
    ["violation-stats", from, to],
    () =>
      apiClient.getViolationStats({
        from: from || undefined,
        to: to || undefined,
      }),
    {
      enabled: !isInitialLoading && !!me?.canAccessNow,
      keepPreviousData: true,
      refetchInterval: 30000,
    },
  );

  const { toast } = useToast();
  const queryClient = useQueryClient();
  const canEdit = !!(((me as any)?.isAdmin) || ((me as any)?.isSuperAdmin));

  const excelExport = useMutation(apiClient.exportViolationStatsExcel, {
    onSuccess: (res: { url: string }) => {
      if (res?.url) {
        const a = document.createElement("a");
        const dateStr = new Date().toISOString().slice(0, 10);
        a.href = res.url;
        a.download = `Статистика_нарушений_${dateStr}.xlsx`;
        document.body.appendChild(a);
        a.click();
        a.remove();
      }
    },
  });

  // Save to storage (respecting chosen folder)
  const saveExcel = useMutation(apiClient.exportViolationStatsExcel, {
    onSuccess: () => {
      toast({
        title: "Сохранено в хранилище",
        description: "Файл Excel добавлен.",
      });
    },
    onError: () => toast({ title: "Не удалось сохранить файл" }),
  });

  // Admin-only: delete violations by hazard factor
  const deleteByFactor = useMutation(
    apiClient.deleteViolationsByHazardFactorAdmin,
    {
      onSuccess: async () => {
        toast({ title: "Удалено", description: "Обновляем статистику…" });
        await queryClient.invalidateQueries({ queryKey: ["violation-stats"] });
      },
      onError: () => toast({ title: "Не удалось удалить" }),
    },
  );
  const [selectedHazards, setSelectedHazards] = useState<Set<string>>(
    new Set(),
  );
  const toggleSelected = (label: string, checked: boolean) => {
    setSelectedHazards((prev) => {
      const next = new Set(prev);
      if (checked) next.add(label);
      else next.delete(label);
      return next;
    });
  };
  const bulkDeleteSelected = async () => {
    if (!canEdit || selectedHazards.size === 0) return;
    const items = Array.from(selectedHazards);
    const results = await Promise.allSettled(
      items.map((label) =>
        apiClient.deleteViolationsByHazardFactorAdmin({ hazardFactor: label }),
      ),
    );
    const ok = results.filter((r) => r.status === "fulfilled").length;
    const fail = results.length - ok;
    setSelectedHazards(new Set());
    toast({
      title: "Готово",
      description: `Удалено: ${ok}${fail ? ", ошибок: " + fail : ""}`,
    });
    await queryClient.invalidateQueries({ queryKey: ["violation-stats"] });
  };

  const exportStatsPdf = useCallback(async () => {
    try {
      const element = document.getElementById("stats-print");
      if (!element) {
        toast({ title: "Нет данных для PDF" });
        return;
      }

      // Временно центрируем весь текст и обеспечиваем перенос слов, чтобы
      // текст не выходил за пределы "ячеек" при рендере в PDF.
      element.classList.add("pdf-export-center");

      // Небольшая задержка, чтобы браузер применил стили перед снимком
      await new Promise((r) => setTimeout(r, 0));

      const canvas = await html2canvas(element as HTMLElement, {
        scale: 2,
        useCORS: true,
        backgroundColor: "#ffffff",
      });

      // Сняли центрированный вариант — возвращаем исходные стили
      element.classList.remove("pdf-export-center");

      const imgData = canvas.toDataURL("image/png");
      const pdf = new jsPDF("p", "mm", "a4");
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const margin = 10; // небольшие поля
      const imgWidth = pageWidth - margin * 2;
      const imgHeight = (canvas.height * imgWidth) / canvas.width;

      let heightLeft = imgHeight;
      let position = margin;

      pdf.addImage(imgData, "PNG", margin, position, imgWidth, imgHeight);
      heightLeft -= pageHeight - margin * 2;
      position = margin - (pageHeight - margin * 2);

      while (heightLeft > 0) {
        pdf.addPage();
        pdf.addImage(imgData, "PNG", margin, position, imgWidth, imgHeight);
        heightLeft -= pageHeight - margin * 2;
        position -= pageHeight - margin * 2;
      }

      const sanitize = (s: string) =>
        (s || "")
          .replace(/[\\/:*?"<>|]+/g, " ")
          .replace(/\s+/g, " ")
          .trim();
      const datePart = (() => {
        if (from && to) return `_${from}—${to}`;
        if (from) return `_с_${from}`;
        if (to) return `_по_${to}`;
        return `_${new Date().toISOString().slice(0, 10)}`;
      })();
      const fileName =
        sanitize(`Статистика нарушений${datePart}`) || "Статистика нарушений";
      pdf.save(`${fileName}.pdf`);
    } catch {
      console.error("PDF export failed (stats)");
      toast({ title: "Не удалось сформировать PDF" });
    }
  }, [from, to, toast]);

  // Drilldown state for clickable stats
  const [drillOpen, setDrillOpen] = useState(false);
  const [drillScope, setDrillScope] = useState<"responsible" | "author" | "hazard" | "category" | "condition">("responsible");
  const [drillStatus, setDrillStatus] = useState<"total" | "resolved" | "inProgress" | "overdue">("total");
  const [drillLabel, setDrillLabel] = useState<string>("");
  const [drillAuthorId, setDrillAuthorId] = useState<string | undefined>(undefined);
  const [drillResponsibleKey, setDrillResponsibleKey] = useState<string | undefined>(undefined);
  const [drillHazardLabel, setDrillHazardLabel] = useState<string | undefined>(undefined);
  const [drillCategoryLabel, setDrillCategoryLabel] = useState<string | undefined>(undefined);
  const [drillConditionLabel, setDrillConditionLabel] = useState<string | undefined>(undefined);
  const [drillPage, setDrillPage] = useState<number>(1);
  const [previewOpen, setPreviewOpen] = useState(false);
  const [previewItem, setPreviewItem] = useState<any | null>(null);

  // Admin actions for drilldown list
  const updateViolation = useMutation(apiClient.updateViolationAdmin, {
    onSuccess: async () => {
      toast({ title: "Сохранено" });
      await Promise.all([
        queryClient.invalidateQueries({ queryKey: ["violation-stats"] }),
        queryClient.invalidateQueries({ queryKey: ["stats-drill"] }),
      ]);
    },
    onError: () => toast({ title: "Не удалось сохранить" }),
  });
  const deleteViolation = useMutation(apiClient.deleteViolationsAdmin, {
    onSuccess: async (res: any) => {
      const cnt = res?.deleted ?? 0;
      toast({ title: cnt ? `Удалено: ${cnt}` : "Удалено" });
      await Promise.all([
        queryClient.invalidateQueries({ queryKey: ["violation-stats"] }),
        queryClient.invalidateQueries({ queryKey: ["stats-drill"] }),
      ]);
    },
    onError: () => toast({ title: "Не удалось удалить" }),
  });
  const sendToResponsible = useMutation(
    apiClient.sendViolationToAdminsAndResponsible,
    {
      onSuccess: () => {
        toast({ title: "Отправлено исполнителю" });
      },
      onError: () => toast({ title: "Не удалось отправить" }),
    },
  );

  // Reassign state
  const [reassignOpen, setReassignOpen] = useState(false);
  const [reassignViolationId, setReassignViolationId] = useState<string | null>(null);
  const [selectedUserId, setSelectedUserId] = useState<string>("");
  const { data: managers } = useQuery(["searchManagers-drill"], () => apiClient.searchManagers({ limit: 20000 }), { enabled: reassignOpen });

  const openDrillByResponsible = (
    row: any,
    status: "total" | "resolved" | "inProgress" | "overdue",
  ) => {

    setDrillScope("responsible");
    setDrillStatus(status);
    setDrillLabel(row.label || "—");
    setDrillResponsibleKey(row.key);
    setDrillAuthorId(undefined);
    setDrillPage(1);
    setDrillOpen(true);
  };
  const openDrillByAuthor = (
    row: any,
    status: "total" | "resolved" | "inProgress" | "overdue",
  ) => {

    setDrillScope("author");
    setDrillStatus(status);
    setDrillLabel(row.label || row.key || "—");
    setDrillAuthorId(row.key);
    setDrillResponsibleKey(undefined);
    setDrillHazardLabel(undefined);
    setDrillCategoryLabel(undefined);
    setDrillConditionLabel(undefined);
    setDrillPage(1);
    setDrillOpen(true);
  };
  const openDrillByHazard = (row: any) => {

    setDrillScope("hazard");
    setDrillStatus("total");
    setDrillLabel(row.label || "—");
    setDrillHazardLabel(row.label || "—");
    setDrillAuthorId(undefined);
    setDrillResponsibleKey(undefined);
    setDrillCategoryLabel(undefined);
    setDrillConditionLabel(undefined);
    setDrillPage(1);
    setDrillOpen(true);
  };
  const openDrillByCategory = (row: any) => {

    setDrillScope("category");
    setDrillStatus("total");
    setDrillLabel(row.label || "—");
    setDrillCategoryLabel(row.label || "—");
    setDrillAuthorId(undefined);
    setDrillResponsibleKey(undefined);
    setDrillHazardLabel(undefined);
    setDrillConditionLabel(undefined);
    setDrillPage(1);
    setDrillOpen(true);
  };
  const openDrillByCondition = (row: any) => {

    setDrillScope("condition");
    setDrillStatus("total");
    setDrillLabel(row.label || "—");
    setDrillConditionLabel(row.label || "—");
    setDrillAuthorId(undefined);
    setDrillResponsibleKey(undefined);
    setDrillHazardLabel(undefined);
    setDrillCategoryLabel(undefined);
    setDrillPage(1);
    setDrillOpen(true);
  };

  const { data: drill, isFetching: drillLoading } = useQuery<StatsDrillPage>(
    [
      "stats-drill",
      from,
      to,
      drillScope,
      drillStatus,
      drillAuthorId,
      drillResponsibleKey,
      drillHazardLabel,
      drillCategoryLabel,
      drillConditionLabel,
      drillPage,
    ],
    () =>
      apiClient.listViolationsForStatsDrilldown({
        from: from || undefined,
        to: to || undefined,
        scope: drillScope as any,
        status: drillStatus,
        authorId: drillAuthorId,
        responsibleKey: drillResponsibleKey,
        hazardLabel: drillHazardLabel,
        categoryLabel: drillCategoryLabel,
        conditionLabel: drillConditionLabel,
        page: drillPage,
        pageSize: 20,
      }),
    { enabled: drillOpen }
  );

  if (isInitialLoading) {
    return (
      <div className="max-w-4xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Загрузка…</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Проверяем статус доступа.
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }
  if (me && !me.canAccessNow) {
    return <AccessRestrictionNotice blocked={(me as any).isBlocked ?? false} />;
  }

  return (
    <div id="stats-print" className="w-full p-4 sm:p-6 space-y-4 overflow-x-auto">
      <Card className="card-elevated h-full">
        <CardHeader className="flex items-center justify-between">
          <CardTitle>Статистика нарушений</CardTitle>
          <div className="flex gap-2">
            <Input
              type="date"
              value={from}
              onChange={(e) => setFrom(e.target.value)}
            />
            <Input
              type="date"
              value={to}
              onChange={(e) => setTo(e.target.value)}
            />
          </div>{" "}
        </CardHeader>
        <CardContent className="space-y-4">
          {statsLoading && (
            <div className="text-sm text-muted-foreground">
              Загрузка статистики…
            </div>
          )}

          {stats && (
            <>
              {/* Drilldown query state is initialized above; handlers are used below */}
              <div className="grid grid-cols-2 md:grid-cols-6 gap-3">
                <div className="p-3 border rounded">
                  <div className="text-xs text-muted-foreground">Всего</div>
                  <div className="text-2xl font-semibold text-stats-total">
                    {stats.total}
                  </div>
                </div>
                <div className="p-3 border rounded">
                  <div className="text-xs text-muted-foreground">Устранено</div>
                  <div className="text-2xl font-semibold text-green-600">
                    {stats.resolved}
                  </div>
                </div>
                <div className="p-3 border rounded">
                  <div className="text-xs text-muted-foreground">В работе</div>
                  <div className="text-2xl font-semibold text-blue-600">
                    {stats.inProgress}
                  </div>
                </div>
                <div className="p-3 border rounded">
                  <div className="text-xs text-muted-foreground">
                    Просрочено
                  </div>
                  <div className="text-2xl font-semibold text-red-600">
                    {stats.overdue}
                  </div>
                </div>
                <div className="p-3 border rounded">
                  <div className="text-xs text-muted-foreground">
                    Наблюдений
                  </div>
                  <div className="text-2xl font-semibold">
                    {stats.observationsTotal}
                  </div>
                </div>
                <div className="p-3 border rounded">
                  <div className="text-xs text-muted-foreground">Аудитов</div>
                  <div className="text-2xl font-semibold">
                    {stats.auditsTotal}
                  </div>
                </div>
              </div>

              <div className="grid md:grid-cols-2 gap-6">
                <div>
                  <div className="font-medium mb-2">По ответственным</div>
                  <div className="border rounded divide-y">
                    {stats.byResponsible?.length ? (
                      stats.byResponsible.map((r: any) => (
                        <div
                          key={r.key}
                          className="px-3 py-2 flex justify-between text-sm"
                        >
                          <div className="truncate pr-2">{r.label}</div>
                          <div className="flex gap-3">
                            <span
                              role="button"
                              title="Всего"
                              className={`underline-offset-2 hover:underline cursor-pointer ${r.total ? "" : "opacity-50 pointer-events-none"}`}
                              onClick={() => openDrillByResponsible(r, "total")}
                            >
                              {r.total}
                            </span>
                            <span
                              role="button"
                              className={`text-green-600 underline-offset-2 hover:underline cursor-pointer ${r.resolved ? "" : "opacity-50 pointer-events-none"}`}
                              title="Устранено"
                              onClick={() => openDrillByResponsible(r, "resolved")}
                            >
                              {r.resolved}
                            </span>
                            <span
                              role="button"
                              className={`text-blue-600 underline-offset-2 hover:underline cursor-pointer ${r.inProgress ? "" : "opacity-50 pointer-events-none"}`}
                              title="В работе"
                              onClick={() => openDrillByResponsible(r, "inProgress")}
                            >
                              {r.inProgress}
                            </span>
                            <span
                              role="button"
                              className={`text-red-600 underline-offset-2 hover:underline cursor-pointer ${r.overdue ? "" : "opacity-50 pointer-events-none"}`}
                              title="Просрочено"
                              onClick={() => openDrillByResponsible(r, "overdue")}
                            >
                              {r.overdue}
                            </span>
                          </div>
                        </div>
                      ))
                    ) : (
                      <div className="px-3 py-4 text-sm text-muted-foreground">
                        Нет данных
                      </div>
                    )}
                  </div>
                </div>
                <div>
                  <div className="font-medium mb-2">По авторам</div>
                  <div className="border rounded divide-y">
                    {stats.byAuthor?.length ? (
                      stats.byAuthor.map((a: any) => {
                        const auditInfo = stats.auditsByAuthor?.find(
                          (x: any) => x.key === a.key,
                        );
                        const auditsCount = auditInfo?.count ?? 0;
                        const obsStats =
                          stats.observationsByAuthorDetailed?.find(
                            (x: any) => x.key === a.key,
                          ) || {
                            total: 0,
                            resolved: 0,
                            inProgress: 0,
                            overdue: 0,
                          };

                        return (
                          <div
                            key={a.key}
                            className="px-3 py-2 flex justify-between text-sm"
                          >
                            <div className="truncate pr-2">{a.label}</div>
                            <div className="flex flex-col items-end gap-1 text-right">
                              <div className="flex gap-3">
                                <span
                                  role="button"
                                  className={`underline-offset-2 hover:underline cursor-pointer ${a.total ? "" : "opacity-50 pointer-events-none"}`}
                                  title="Всего"
                                  onClick={() => openDrillByAuthor(a, "total")}
                                >
                                  {a.total}
                                </span>
                                <span
                                  role="button"
                                  className={`text-green-600 underline-offset-2 hover:underline cursor-pointer ${a.resolved ? "" : "opacity-50 pointer-events-none"}`}
                                  title="Устранено"
                                  onClick={() => openDrillByAuthor(a, "resolved")}
                                >
                                  {a.resolved}
                                </span>
                                <span
                                  role="button"
                                  className={`text-blue-600 underline-offset-2 hover:underline cursor-pointer ${a.inProgress ? "" : "opacity-50 pointer-events-none"}`}
                                  title="В работе"
                                  onClick={() => openDrillByAuthor(a, "inProgress")}
                                >
                                  {a.inProgress}
                                </span>
                                <span
                                  role="button"
                                  className={`text-red-600 underline-offset-2 hover:underline cursor-pointer ${a.overdue ? "" : "opacity-50 pointer-events-none"}`}
                                  title="Просрочено"
                                  onClick={() => openDrillByAuthor(a, "overdue")}
                                >
                                  {a.overdue}
                                </span>
                              </div>
                              <div className="flex flex-wrap justify-end gap-x-2 gap-y-1 text-xs text-muted-foreground">
                                <span>
                                  Наблюдений: {obsStats.total}
                                </span>
                                <span className="text-blue-600">
                                  в работе: {obsStats.inProgress}
                                </span>
                                <span className="text-green-600">
                                  выполнено: {obsStats.resolved}
                                </span>
                                <span className="text-red-600">
                                  просрочено: {obsStats.overdue}
                                </span>
                                <span>
                                  Аудитов: {auditsCount}
                                </span>
                              </div>
                            </div>
                          </div>
                        );
                      })
                    ) : (
                      <div className="px-3 py-4 text-sm text-muted-foreground">
                        Нет данных
                      </div>
                    )}
                  </div>
                </div>
              </div>

              <div className="flex flex-col items-center">
                <div className="font-medium mb-2 text-center">Опасные факторы</div>
                <div className="border rounded divide-y inline-block max-w-full">
                  {stats.byHazardFactor?.length ? (
                    <div className="inline-flex flex-col items-stretch">
                      {stats.byHazardFactor.map((c: any, idx: number) => (
                        <div
                          key={idx}
                          className="px-3 py-2 flex items-center justify-between text-sm gap-3 max-w-full"
                        >
                          <div className="flex items-center gap-2 min-w-0">
                            {false && (
                              <Checkbox
                                checked={selectedHazards.has(c.label)}
                                onCheckedChange={(checked: boolean) =>
                                  toggleSelected(c.label, !!checked)
                                }
                              />
                            )}
                            <div className="truncate pr-2 max-w-xs sm:max-w-sm md:max-w-md lg:max-w-lg">
                              {c.label}
                            </div>
                          </div>
                          <div className="flex items-center gap-3 justify-center">
                            <span
                              role="button"
                              title="Показать предписания"
                              className={`underline-offset-2 hover:underline cursor-pointer ${c.count ? "" : "opacity-50 pointer-events-none"}`}
                              onClick={() => openDrillByHazard(c)}
                            >
                              {c.count}
                            </span>
                            {false && (
                              <Button
                                size="sm"
                                className="hidden"
                                variant="destructive"
                                onClick={() => {
                                  if (
                                    !confirm(
                                      `Удалить все нарушения с фактором «${c.label}»?`,
                                    )
                                  )
                                    return;
                                  deleteByFactor.mutate({
                                    hazardFactor: c.label,
                                  });
                                }}
                              >
                                Удалить
                              </Button>
                            )}
                          </div>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <div className="px-3 py-4 text-sm text-muted-foreground text-center">
                      Нет данных
                    </div>
                  )}
                </div>
                {canEdit && selectedHazards.size > 0 && (
                  <div className="flex items-center justify-between mt-2 w-full max-w-md">
                    <div className="text-xs text-muted-foreground">
                      Выбрано факторов: {selectedHazards.size}
                    </div>
                    <Button
                      className="hidden"
                      variant="destructive"
                      onClick={() => {
                        if (
                          !confirm(
                            "Удалить все нарушения по выбранным факторам?",
                          )
                        )
                          return;
                        void bulkDeleteSelected();
                      }}
                    >
                      Удалить выбранные
                    </Button>
                  </div>
                )}
              </div>

              <div className="grid md:grid-cols-2 gap-6">
                <div>
                  <div className="font-medium mb-2">Наблюдения по авторам</div>
                  <div className="border rounded divide-y">
                    {stats.observationsByAuthor?.length ? (
                      stats.observationsByAuthor.map((a: any) => (
                        <div
                          key={a.key}
                          className="px-3 py-2 flex justify-between text-sm"
                        >
                          <div className="truncate pr-2">{a.label}</div>
                          <div>{a.count}</div>
                        </div>
                      ))
                    ) : (
                      <div className="px-3 py-4 text-sm text-muted-foreground">
                        Нет данных
                      </div>
                    )}
                  </div>
                </div>
                <div>
                  <div className="font-medium mb-2">Наблюдения по ответственным</div>
                  <div className="border rounded divide-y">
                    {stats.observationsByResponsible?.length ? (
                      stats.observationsByResponsible.map((r: any) => (
                        <div
                          key={r.key}
                          className="px-3 py-2 flex justify-between text-sm"
                        >
                          <div className="truncate pr-2">{r.label}</div>
                          <div>{r.count}</div>
                        </div>
                      ))
                    ) : (
                      <div className="px-3 py-4 text-sm text-muted-foreground">
                        Нет данных
                      </div>
                    )}
                  </div>
                </div>
              </div>

              <div className="grid md:grid-cols-2 gap-6">
                <div>
                  <div className="font-medium mb-2">Аудиты по авторам</div>
                  <div className="border rounded divide-y">
                    {stats.auditsByAuthor?.length ? (
                      stats.auditsByAuthor.map((a: any) => (
                        <div
                          key={a.key}
                          className="px-3 py-2 flex justify-between text-sm"
                        >
                          <div className="truncate pr-2">{a.label}</div>
                          <div>{a.count}</div>
                        </div>
                      ))
                    ) : (
                      <div className="px-3 py-4 text-sm text-muted-foreground">
                        Нет данных
                      </div>
                    )}
                  </div>
                </div>
              </div>

              <div className="grid md:grid-cols-2 gap-6">
                <div>
                  <div className="font-medium mb-2">Категории наблюдений</div>
                  <div className="border rounded divide-y">
                    {stats.byCategory?.length ? (
                      stats.byCategory.map((c: any, idx: number) => (
                        <div
                          key={idx}
                          className="px-3 py-2 flex justify-between text-sm"
                        >
                          <div className="truncate pr-2">{c.label}</div>
                          <div>
                            <span
                              role="button"
                              title="Показать предписания"
                              className={`underline-offset-2 hover:underline cursor-pointer ${c.count ? "" : "opacity-50 pointer-events-none"}`}
                              onClick={() => openDrillByCategory(c)}
                            >
                              {c.count}
                            </span>
                          </div>
                        </div>
                      ))
                    ) : (
                      <div className="px-3 py-4 text-sm text-muted-foreground">
                        Нет данных
                      </div>
                    )}
                  </div>
                </div>
                <div>
                  <div className="font-medium mb-2">
                    Виды условий и действий
                  </div>
                  <div className="border rounded divide-y">
                    {stats.byCondition?.length ? (
                      stats.byCondition.map((c: any, idx: number) => (
                        <div
                          key={idx}
                          className="px-3 py-2 flex justify-between text-sm"
                        >
                          <div className="truncate pr-2">{c.label}</div>
                          <div>
                            <span
                              role="button"
                              title="Показать предписания"
                              className={`underline-offset-2 hover:underline cursor-pointer ${c.count ? "" : "opacity-50 pointer-events-none"}`}
                              onClick={() => openDrillByCondition(c)}
                            >
                              {c.count}
                            </span>
                          </div>
                        </div>
                      ))
                    ) : (
                      <div className="px-3 py-4 text-sm text-muted-foreground">
                        Нет данных
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </>
          )}
        </CardContent>
        <CardFooter className="flex flex-col gap-3 items-stretch sm:flex-row sm:items-center sm:gap-2">
          <div className="flex gap-2">
            <Button
              variant="secondary"
              disabled={excelExport.isLoading}
              onClick={() =>
                excelExport.mutate({
                  from: from || undefined,
                  to: to || undefined,
                })
              }
            >
              Скачать Excel
            </Button>
            <Button variant="secondary" onClick={() => void exportStatsPdf()}>
              Скачать PDF
            </Button>
          </div>

          <div className="flex flex-1 items-center gap-2">
            <Button
              variant="secondary"
              disabled={saveExcel.isLoading}
              onClick={() =>
                saveExcel.mutate({
                  from: from || undefined,
                  to: to || undefined,
                  folderId: null,
                })
              }
            >
              Excel
            </Button>
          </div>

          <NavLink to="/home" className="sm:ml-auto">
            <Button variant="outline">На главную</Button>
          </NavLink>
        </CardFooter>
      </Card>

      <Dialog open={reassignOpen} onOpenChange={setReassignOpen}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle>Перенаправить предписание</DialogTitle>
            <DialogDescription>Выберите нового исполнителя</DialogDescription>
          </DialogHeader>
          <div className="space-y-3">
            <Select value={selectedUserId} onValueChange={(v) => setSelectedUserId(v)}>
              <SelectTrigger>
                <SelectValue placeholder="Выберите пользователя" />
              </SelectTrigger>
              <SelectContent>
                {managers?.map((m: any) => (
                  <SelectItem key={m.id} value={m.id}>
                    {(m.fullName || m.email || m.id) as string}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
            <div className="flex gap-2">
            <Button style={{ display: canEdit ? undefined : "none" }}
               onClick={async () => {                  if (!reassignViolationId || !selectedUserId) return;
                  try {
                    await updateViolation.mutateAsync({ id: reassignViolationId, responsibleUserId: selectedUserId });
                    sendToResponsible.mutate({ violationId: reassignViolationId });
                    setReassignOpen(false);
                    setSelectedUserId("");
                    setReassignViolationId(null);
                    await Promise.all([
                      queryClient.invalidateQueries({ queryKey: ["violation-stats"] }),
                      queryClient.invalidateQueries({ queryKey: ["stats-drill"] }),
                    ]);
                  } catch (e) {
                    /* noop */
                  }
                }}
                disabled={!selectedUserId || !reassignViolationId || updateViolation.isLoading || sendToResponsible.isLoading}
              >
                Отправить новому исполнителю
              </Button>
              <Button variant="outline" onClick={() => setReassignOpen(false)}>Отмена</Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      <Dialog open={drillOpen} onOpenChange={(v) => setDrillOpen(!!v)}>
        <DialogContent className="max-w-4xl">
          <DialogHeader>
            <DialogTitle>
              {drillScope === "responsible" ? "По ответственному" : drillScope === "author" ? "По автору" : drillScope === "hazard" ? "Опасный фактор" : drillScope === "category" ? "Категория наблюдений" : "Вид условий и действий"}
            </DialogTitle>
            <DialogDescription>
              {drillLabel} — {drillStatus === "total" ? "все" : drillStatus === "resolved" ? "устранено" : drillStatus === "inProgress" ? "в работе" : "просрочено"}
            </DialogDescription>
          </DialogHeader>

          <div className="flex items-center justify-between mb-2 text-sm text-muted-foreground">
            <div>
              Период: {from || "—"} — {to || "—"}
            </div>
            <div>
              Всего: {drill?.total ?? 0}
            </div>
          </div>

          <div className="border rounded">
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>Дата</TableHead>
                  <TableHead>Код</TableHead>
                  <TableHead>Описание</TableHead>
                  <TableHead>Ответственный</TableHead>
                  <TableHead>Автор</TableHead>
                  <TableHead>Срок</TableHead>
                  <TableHead>Статус</TableHead>
                  {canEdit && <TableHead>Действия</TableHead>}
                </TableRow>
              </TableHeader>
              <TableBody>
                {drillLoading && (
                  <TableRow>
                    <TableCell colSpan={canEdit ? 8 : 7} className="text-sm text-muted-foreground">
                      Загрузка…
                    </TableCell>
                  </TableRow>
                )}
                {!drillLoading && (drill?.items?.length ?? 0) === 0 && (
                  <TableRow>
                    <TableCell colSpan={canEdit ? 8 : 7} className="text-sm text-muted-foreground">
                      Нет данных
                    </TableCell>
                  </TableRow>
                )}
                {drill?.items?.map((v) => (
                  <TableRow key={v.id}>
                    <TableCell>{v.date ? new Date(v.date as any).toLocaleDateString("ru-RU") : "—"}</TableCell>
                    <TableCell className="whitespace-nowrap">
                      <button
                        className="underline underline-offset-2 hover:no-underline"
                        onClick={() => {
                          setPreviewItem(v as any);
                          setPreviewOpen(true);
                        }}
                      >
                        {(v as any).code || "—"}
                      </button>
                    </TableCell>
                    <TableCell className="max-w-[28rem] truncate" title={(v as any).description || ""}>
                      {(v as any).description || "—"}
                    </TableCell>
                    <TableCell className="whitespace-nowrap">{(v as any).responsibleName || (v as any).responsibleUserId || "—"}</TableCell>
                    <TableCell className="whitespace-nowrap">{(v as any).authorName || (v as any).authorId || "—"}</TableCell>
                    <TableCell className="whitespace-nowrap">{v.dueDate ? new Date(v.dueDate as any).toLocaleDateString("ru-RU") : "—"}</TableCell>
                    <TableCell className="whitespace-nowrap">{(v as any).status || "—"}</TableCell>
                               {canEdit && (                      <TableCell className="whitespace-nowrap">
                        <div className="flex items-center gap-2">
                          <DropdownMenu>
                            <DropdownMenuTrigger asChild>
                              <Button size="sm" variant="secondary">Изменить</Button>
                            </DropdownMenuTrigger>
                            <DropdownMenuContent>
                              <DropdownMenuItem onClick={() => updateViolation.mutate({ id: (v as any).id, status: "В работе" })}>В работе</DropdownMenuItem>
                              <DropdownMenuItem onClick={() => updateViolation.mutate({ id: (v as any).id, status: "Устранено" })}>Устранено</DropdownMenuItem>
                              <DropdownMenuItem onClick={() => updateViolation.mutate({ id: (v as any).id, status: "Просрочено" })}>Просрочено</DropdownMenuItem>
                            </DropdownMenuContent>
                          </DropdownMenu>
                          <Button size="sm" variant="outline" onClick={() => { setReassignViolationId((v as any).id); setReassignOpen(true); }}>Перенаправить</Button>
                          <Button size="sm" variant="destructive" onClick={() => {
                            if (!confirm("Удалить это предписание?")) return;
                            deleteViolation.mutate({ ids: [(v as any).id] });
                          }}>Удалить</Button>
                        </div>
                      </TableCell>
                    )}
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          </div>

          <div className="flex items-center justify-between mt-3">
            <div className="text-sm text-muted-foreground">
              Стр. {drillPage} из {drill ? Math.max(1, Math.ceil((drill.total ?? 0) / (drill.pageSize ?? 20))) : 1}
            </div>
            <div className="flex gap-2">
              <Button
                variant="secondary"
                onClick={() => setDrillPage((p) => Math.max(1, p - 1))}
                disabled={drillPage <= 1 || drillLoading}
              >
                Назад
              </Button>
              <Button
                variant="secondary"
                onClick={() => setDrillPage((p) => p + 1)}
                disabled={drillLoading || (drill ? drillPage >= Math.ceil((drill.total ?? 0) / (drill.pageSize ?? 20)) : true)}
              >
                Вперёд
              </Button>
            </div>
          </div>

          {/* Просмотр предписания */}
          <Dialog open={previewOpen} onOpenChange={setPreviewOpen}>
            <DialogContent className="max-w-2xl">
              <DialogHeader>
                <DialogTitle>
                  Предписание {((previewItem as any)?.code ?? "—") as string}
                </DialogTitle>
                <DialogDescription>
                  {(previewItem?.description as string) || ""}
                </DialogDescription>
              </DialogHeader>

              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
                <div>
                  <div className="text-muted-foreground">Дата</div>
                  <div>{previewItem?.date ? new Date(previewItem.date as any).toLocaleDateString("ru-RU") : "—"}</div>
                </div>
                <div>
                  <div className="text-muted-foreground">Статус</div>
                  <div>{(previewItem as any)?.status || "—"}</div>
                </div>
                <div>
                  <div className="text-muted-foreground">Ответственный</div>
                  <div>{(previewItem as any)?.responsibleName || (previewItem as any)?.responsibleUserId || "—"}</div>
                </div>
                <div>
                  <div className="text-muted-foreground">Автор</div>
                  <div>{(previewItem as any)?.authorName || (previewItem as any)?.authorId || "—"}</div>
                </div>
                <div>
                  <div className="text-muted-foreground">Срок</div>
                  <div>{previewItem?.dueDate ? new Date(previewItem.dueDate as any).toLocaleDateString("ru-RU") : "—"}</div>
                </div>
                <div>
                  <div className="text-muted-foreground">Подразделение</div>
                  <div>
                    {[(previewItem as any)?.shop, (previewItem as any)?.section]
                      .filter(Boolean)
                      .join(" /") || "—"}
                  </div>
                </div>
                <div className="sm:col-span-2">
                  <div className="text-muted-foreground">Описание</div>
                  <div className="whitespace-pre-wrap">
                    {(previewItem as any)?.description || "—"}
                  </div>
                </div>
              </div>

              {(previewItem as any)?.id && canEdit && (
                <div className="pt-3">
                  <ViolationEditDialog
                    v={previewItem as any}
                    onSaved={() => {
                      setPreviewOpen(false);
                    }}
                  />
                </div>
              )}
            </DialogContent>
          </Dialog>
        </DialogContent>
      </Dialog>
    </div>
  );
}

/* ADMIN SCREEN */
function UserAccessManager({
  user,
  onSaved,
}: {
  user: any;
  onSaved: () => void;
}) {
  const [open, setOpen] = useState(false);
  const [blocked, setBlocked] = useState<boolean>(!!user.isBlocked);
  const toDateInput = (d?: string | Date | null) => {
    if (!d) return "";
    const dt = new Date(d);
    if (isNaN(dt.getTime())) return "";
    return dt.toISOString().slice(0, 10);
  };
  const [from, setFrom] = useState<string>(toDateInput(user.accessFrom));
  const [to, setTo] = useState<string>(toDateInput(user.accessTo));
  const { toast } = useToast();
  const queryClient = useQueryClient();
  const setAccess = useMutation(apiClient.setUserAccess, {
    onSuccess: async () => {
      toast({ title: "Настройки доступа сохранены" });
      await queryClient.invalidateQueries({ queryKey: ["users"] });
      setOpen(false);
      onSaved();
    },
    onError: () => toast({ title: "Не удалось сохранить доступ" }),
  });

  return (
    <Dialog open={open} onOpenChange={setOpen}>
      <DialogTrigger asChild>
        <Button size="sm" variant="secondary">
          Доступ
        </Button>
      </DialogTrigger>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Настроить доступ</DialogTitle>
          <DialogDescription>
            Установите блокировку или окно дат, в которое разрешён вход.
          </DialogDescription>
        </DialogHeader>
        <div className="space-y-4">
          <div className="flex items-center justify-between">
            <Label>Заблокировать</Label>
            <Switch
              checked={blocked}
              onCheckedChange={(v: boolean) => setBlocked(v)}
            />
          </div>
          <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div className="space-y-1.5">
              <Label>Доступ с</Label>
              <Input
                type="date"
                value={from}
                onChange={(e) => setFrom(e.target.value)}
              />
            </div>
            <div className="space-y-1.5">
              <Label>Доступ до</Label>
              <Input
                type="date"
                value={to}
                onChange={(e) => setTo(e.target.value)}
              />
            </div>
          </div>
        </div>
        <DialogFooter>
          <Button
            onClick={() =>
              setAccess.mutate({
                userId: user.id,
                isBlocked: blocked,
                accessFrom: from || null,
                accessTo: to || null,
              } as SetUserAccessInput)
            }
          >
            Сохранить
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}

function UserEditDialog({ user, onSaved }: { user: any; onSaved: () => void }) {
  const [open, setOpen] = useState(false);
  const [fullName, setFullName] = useState<string>(user.fullName ?? "");
  const [company, setCompany] = useState<string>(user.company ?? "");
  const [department, setDepartment] = useState<string>(user.department ?? "");
  const [jobTitle, setJobTitle] = useState<string>(user.jobTitle ?? "");
  const [email, setEmail] = useState<string>(user.email ?? "");
  const { toast } = useToast();
  const queryClient = useQueryClient();
  const updateUser = useMutation(apiClient.updateUserProfileAdmin, {
    onSuccess: async () => {
      toast({ title: "Профиль обновлён" });
      await queryClient.invalidateQueries({ queryKey: ["users"] });
      setOpen(false);
      onSaved();
    },
  });
  return (
    <Dialog open={open} onOpenChange={setOpen}>
      <DialogTrigger asChild>
        <Button size="sm" variant="secondary">
          Редактировать
        </Button>
      </DialogTrigger>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Редактировать пользователя</DialogTitle>
        </DialogHeader>
        <div className="grid gap-3">
          <div className="space-y-1">
            <Label>ФИО</Label>
            <Input
              value={fullName}
              onChange={(e) => setFullName(e.target.value)}
            />
          </div>
          <div className="space-y-1">
            <Label>Компания</Label>
            <Input
              value={company}
              onChange={(e) => setCompany(e.target.value)}
            />
          </div>
          <div className="space-y-1">
            <Label>Подразделение</Label>
            <Input
              value={department}
              onChange={(e) => setDepartment(e.target.value)}
            />
          </div>
          <div className="space-y-1">
            <Label>Должность</Label>
            <Input
              value={jobTitle}
              onChange={(e) => setJobTitle(e.target.value)}
            />
          </div>
          <div className="space-y-1">
            <Label>Email</Label>
            <Input
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
            />
          </div>
        </div>
        <DialogFooter>
          <Button
            onClick={() =>
              updateUser.mutate({
                userId: user.id,
                fullName: fullName || null,
                company: company || null,
                department: department || null,
                jobTitle: jobTitle || null,
                email: email || null,
              })
            }
          >
            Сохранить
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}

function ViolationEditDialog({ v, onSaved }: { v: any; onSaved: () => void }) {
  const [open, setOpen] = useState(false);
  const [description, setDescription] = useState<string>(v.description ?? "");
  const [category, setCategory] = useState<string>(v.category ?? "");
  const [conditionType, setConditionType] = useState<string>(
    v.conditionType ?? "",
  );
  const [status, setStatus] = useState<string>(v.status ?? "");
  const [dueDate, setDueDate] = useState<string>(
    v.dueDate ? new Date(v.dueDate).toISOString().slice(0, 10) : "",
  );
  const [responsibleName, setResponsibleName] = useState<string>(
    v.responsibleName ?? "",
  );
  const [responsibleQuery, setResponsibleQuery] = useState<string>("");
  const [responsibleUserId, setResponsibleUserId] = useState<
    string | undefined
  >(v.responsibleUserId ?? undefined);
  const { toast } = useToast();
  const queryClient = useQueryClient();

  const managersQuery = useQuery(
    ["mgrs-admin", responsibleQuery],
    () => apiClient.searchManagers({ q: responsibleQuery }),
    { enabled: responsibleQuery.length >= 2 },
  );

  const extraObservations: string[] = [];

  const [catalogs, setCatalogs] = useState<Array<{ kind: string; value: string }>>([]);

  useEffect(() => {
    void (async () => {
      try {
        const res = await apiClient.getSelfLearningPABContent();
        if ((res as any)?.catalogs) {
          setCatalogs((res as any).catalogs as Array<{ kind: string; value: string }>);
        }
      } catch {
        // игнорируем ошибки каталога, форма редактирования должна работать и без них
      }
    })();
  }, []);

  const update = useMutation(apiClient.updateViolationAdmin, {
    onSuccess: async () => {
      toast({ title: "Нарушение обновлено" });
      await Promise.all([
        queryClient.invalidateQueries({ queryKey: ["violations"] }),
        queryClient.invalidateQueries({ queryKey: ["admin-stats"] }),
      ]);
      setOpen(false);
      onSaved();
    },
  });

  const baseCategories = [
    "Реакция работника (РР)",
    "Положение/поза работника, действие людей (ПР)",
    "Спецодежда и другие средства индивидуальной защиты (СИЗ)",
    "Состояние инструментов и оборудования (ИО)",
    "Инструкции, правила и процедуры (ИП)",
    "Порядок на рабочем месте (ПМ)",
    "Другое (ДР)",
  ];

  const categories = [
    ...baseCategories,
    ...catalogs
      .filter((c) => c.kind === "CATEGORY" && c.value && !baseCategories.includes(c.value))
      .map((c) => c.value),
  ];
  const conditionTypes = [
    "Безопасное действие",
    "Безопасное условие",
    "Опасное действие",
    "Опасное условие",
    "Опасная ситуация",
  ];

  return (
    <Dialog open={open} onOpenChange={setOpen}>
      <DialogTrigger asChild>
        <Button size="sm" variant="secondary">
          Изменить
        </Button>
      </DialogTrigger>
      <DialogContent className="max-w-2xl">
        <DialogHeader>
          <DialogTitle>Редактировать нарушение</DialogTitle>
          <DialogDescription>
            {new Date(v.date).toISOString().slice(0, 10)} · {v.shop}/{v.section}{" "}
            · {v.objectInspected}
          </DialogDescription>
        </DialogHeader>
        <div className="grid gap-3">
          <div className="space-y-1">
            <Label>Статус</Label>
            <Input value={status} onChange={(e) => setStatus(e.target.value)} />
          </div>
          <div className="space-y-1">
            <Label>Срок</Label>
            <Input
              type="date"
              value={dueDate}
              onChange={(e) => setDueDate(e.target.value)}
            />
          </div>
          <div className="space-y-1">
            <Label>Ответственный</Label>
            <Input
              value={responsibleName}
              onChange={(e) => setResponsibleName(e.target.value)}
              placeholder="Ф.И.О."
            />
            <div className="flex items-center gap-2 mt-1">
              <Input
                value={responsibleQuery}
                onChange={(e) => setResponsibleQuery(e.target.value)}
                placeholder="Поиск по ФИО/должности"
              />
              <Search className="h-4 w-4 text-muted-foreground" />
            </div>
            {managersQuery.data && managersQuery.data.length > 0 && (
              <div className="mt-2 border rounded-md max-h-40 overflow-auto">
                {managersQuery.data.map((u: any) => (
                  <button
                    key={u.id}
                    type="button"
                    className={`w-full text-left px-3 py-2 hover:bg-accent ${responsibleUserId === u.id ? "bg-accent" : ""}`}
                    onClick={() => {
                      setResponsibleUserId(u.id);
                      setResponsibleName(u.fullName ?? u.email ?? "");
                    }}
                  >
                    <div className="text-sm font-medium">
                      {u.fullName || "Без имени"}
                    </div>
                    <div className="text-xs text-muted-foreground">
                      {u.jobTitle || "—"}
                    </div>
                  </button>
                ))}
              </div>
            )}
          </div>
          <div className="space-y-1">
            <Label>Категория</Label>
            <select
              className="w-full border rounded h-10 px-3 bg-background"
              value={category}
              onChange={(e) => setCategory(e.target.value)}
            >
              {categories.map((c) => (
                <option key={c} value={c}>
                  {c}
                </option>
              ))}
            </select>
          </div>
          <div className="space-y-1">
            <Label>Вид условий и действий</Label>
            <select
              className="w-full border rounded h-10 px-3 bg-background"
              value={conditionType}
              onChange={(e) => setConditionType(e.target.value)}
            >
              {conditionTypes.map((c) => (
                <option key={c} value={c}>
                  {c}
                </option>
              ))}
            </select>
          </div>
          <div className="space-y-1">
            <Label>Описание</Label>
            <Textarea
              value={description}
              onChange={(e) => setDescription(e.target.value)}
            />
          </div>
        </div>
        <DialogFooter>
          <Button
            onClick={() =>
              update.mutate({
                id: v.id,
                description: [description, ...extraObservations]
                  .map((s) => s.trim())
                  .filter(Boolean)
                  .map((t, i, arr) =>
                    arr.length > 1 ? `Наблюдение №${i + 1}: ${t}` : t,
                  )
                  .join("\n\n"),
                category,
                conditionType,
                status,
                dueDate: dueDate || null,
                responsibleUserId: responsibleUserId ?? null,
                responsibleName: responsibleName || null,
              })
            }
          >
            Сохранить
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}

// (removed unused SendIllustrationLinkButton component)

function KBTProtocolsScreen() {
  useAuth({ required: true });
  const { data: me, isInitialLoading } = useQuery<Profile>(["me"], () =>
    apiClient.getMyProfile(),
  );
  const navigate = useNavigate();
  if (isInitialLoading) {
    return (
      <div className="max-w-3xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Загрузка…</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Проверяем статус доступа.
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }
  if (me && !me.canAccessNow) {
    return <AccessRestrictionNotice blocked={(me as any).isBlocked ?? false} />;
  }
  return (
    <div className="max-w-3xl mx-auto p-4 sm:p-6">
      <Card className="card-elevated h-full">
        <CardHeader>
          <CardTitle>Плановый КБТ</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="text-muted-foreground">
            Раздел в разработке. Здесь будет «Плановый КБТ»."
          </div>
        </CardContent>
        <CardFooter>
          <Button variant="secondary" onClick={() => navigate("/kbt")}>
            Назад к КБТ
          </Button>
        </CardFooter>
      </Card>
    </div>
  );
}

function KBTReportScreen() {
  useAuth({ required: true });
  const { data: me, isInitialLoading } = useQuery<Profile>(["me"], () =>
    apiClient.getMyProfile(),
  );
  const navigate = useNavigate();
  const { toast } = useToast();

  // Types
  type Merge = {
    startRow: number;
    startCol: number;
    rowSpan: number;
    colSpan: number;
  };
  type KbtSheet = {
    id: string;
    name: string;
    rows: number;
    cols: number;
    cells: string[][];
    merges: Merge[];
    dropdowns?: Record<string, string[]>; // A1 -> options
    validations?: Record<string, { kind: "notEmpty" | "number" | "date" }>;
    formats?: Record<
      string,
      { op: ">" | "<" | "=" | "contains"; value: string; color: string }
    >;
    // New: per-column settings and freezing
    colWidths?: number[]; // px
    colFormats?: ("text" | "number" | "date")[];
    colDecimals?: number[]; // for number format
    frozenHeader?: boolean;
    frozenFirstCol?: boolean;
  };

  // Helpers for IDs and naming
  const makeId = () => Math.random().toString(36).slice(2, 10);
  const defaultSheetName = (existing: string[]) => {
    let n = 1;
    while (existing.includes(`Лист${n}`)) n++;
    return `Лист${n}`;
  };

  // Book state (multiple sheets)
  const [sheets, setSheets] = useState<KbtSheet[]>(() => {
    // Try new-format book
    try {
      const raw = localStorage.getItem("kbtSheetsBook.v1");
      if (raw) {
        const parsed = JSON.parse(raw) as { sheets?: KbtSheet[] };
        if (Array.isArray(parsed?.sheets) && parsed.sheets.length)
          return parsed.sheets as KbtSheet[];
      }
    } catch {
      /* ignore */
    }
    // Migrate from legacy single-sheet draft
    try {
      const rawOld = localStorage.getItem("kbtReportDraft.v1");
      if (rawOld) {
        const d = JSON.parse(rawOld) as any;
        const rows = typeof d?.rows === "number" ? d.rows : 10;
        const cols = typeof d?.cols === "number" ? d.cols : 6;
        const cells: string[][] = Array.isArray(d?.cells)
          ? (d.cells as string[][])
          : Array.from({ length: rows }, () =>
              Array.from({ length: cols }, () => ""),
            );
        return [
          {
            id: makeId(),
            name: d?.sheetName || "Лист1",
            rows,
            cols,
            cells,
            merges: [],
            dropdowns: {},
            validations: {},
            formats: {},
          },
        ];
      }
    } catch {
      /* ignore */
    }
    // Default
    return [
      {
        id: makeId(),
        name: "Лист1",
        rows: 10,
        cols: 6,
        cells: Array.from({ length: 10 }, () =>
          Array.from({ length: 6 }, () => ""),
        ),
        merges: [],
        dropdowns: {},
        validations: {},
        formats: {},
      },
    ];
  });
  const [activeIndex, setActiveIndex] = useState<number>(() => {
    try {
      const raw = localStorage.getItem("kbtSheetsBook.v1");
      if (raw) {
        const parsed = JSON.parse(raw) as { activeIndex?: number };
        if (typeof parsed?.activeIndex === "number")
          return Math.max(
            0,
            Math.min(parsed.activeIndex!, (sheets.length || 1) - 1),
          );
      }
    } catch {
      /* ignore */
    }
    return 0;
  });
  const [fileName, setFileName] = useState<string>(() => {
    try {
      const raw = localStorage.getItem("kbtSheetsBook.v1");
      if (raw) {
        const parsed = JSON.parse(raw) as { fileName?: string };
        if (parsed?.fileName) return parsed.fileName;
      }
    } catch {
      /* ignore */
    }
    const d = new Date().toISOString().slice(0, 10);
    return `Отчёт_КБТ_${d}`;
  });

  // Convenience getters/setters for current sheet
  const current = sheets[activeIndex] as KbtSheet | undefined;
  const rows = current?.rows ?? 0;
  const cols = current?.cols ?? 0;
  const sheetName = current?.name ?? "";

  const updateCurrentSheet = (updater: (s: KbtSheet) => KbtSheet) => {
    setSheets((prev) => {
      const next = [...prev];
      const cur = next[activeIndex];
      if (!cur) return prev;
      next[activeIndex] = updater(cur);
      return next;
    });
  };

  const a1 = (r: number, c: number) => `${colToLetters(c)}${r + 1}`;

  const setRows = (update: number | ((r: number) => number)) => {
    if (!current) return;
    updateCurrentSheet((s) => {
      const newRows =
        typeof update === "function" ? (update as any)(s.rows) : update;
      const rowsClamped = Math.max(1, Math.min(500, Math.floor(newRows)));
      const newCells = s.cells
        .slice(0, rowsClamped)
        .map((row) => row.slice(0, s.cols));
      if (rowsClamped > newCells.length) {
        for (let i = newCells.length; i < rowsClamped; i++) {
          newCells.push(Array.from({ length: s.cols }, () => ""));
        }
      }
      // Clamp merges
      const newMerges = s.merges
        .map((m) => {
          if (m.startRow >= rowsClamped) return null as any;
          const rowSpan = Math.max(
            1,
            Math.min(m.rowSpan, rowsClamped - m.startRow),
          );
          return { ...m, rowSpan } as Merge;
        })
        .filter(Boolean) as Merge[];
      return { ...s, rows: rowsClamped, cells: newCells, merges: newMerges };
    });
  };

  const setCols = (update: number | ((c: number) => number)) => {
    if (!current) return;
    updateCurrentSheet((s) => {
      const newCols =
        typeof update === "function" ? (update as any)(s.cols) : update;
      const colsClamped = Math.max(1, Math.min(100, Math.floor(newCols)));
      const newCells = s.cells.map((row) => {
        const next = row.slice(0, colsClamped);
        if (colsClamped > next.length) {
          for (let j = next.length; j < colsClamped; j++) next.push("");
        }
        return next;
      });
      const newMerges = s.merges
        .map((m) => {
          if (m.startCol >= colsClamped) return null as any;
          const colSpan = Math.max(
            1,
            Math.min(m.colSpan, colsClamped - m.startCol),
          );
          return { ...m, colSpan } as Merge;
        })
        .filter(Boolean) as Merge[];
      return { ...s, cols: colsClamped, cells: newCells, merges: newMerges };
    });
  };

  const setCells = (updater: (prev: string[][]) => string[][]) => {
    if (!current) return;
    updateCurrentSheet((s) => ({ ...s, cells: updater(s.cells) }));
  };

  const merges = current?.merges ?? [];
  const setMerges = (updater: ((prev: Merge[]) => Merge[]) | Merge[]) => {
    if (!current) return;
    updateCurrentSheet((s) => ({
      ...s,
      merges:
        typeof updater === "function"
          ? (updater as any)(s.merges)
          : (updater as Merge[]),
    }));
  };

  // Selection state (UI only)
  const [anchor, setAnchor] = useState<{ r: number; c: number } | null>(null);
  const [selection, setSelection] = useState<{
    r1: number;
    c1: number;
    r2: number;
    c2: number;
  } | null>(null);
  const [isMouseDown, setIsMouseDown] = useState(false);

  const normalizeRange = (r1: number, c1: number, r2: number, c2: number) => ({
    r1: Math.min(r1, r2),
    c1: Math.min(c1, c2),
    r2: Math.max(r1, r2),
    c2: Math.max(c1, c2),
  });

  // A1 helpers
  const colToLetters = (n: number) => {
    let s = "";
    let num = n;
    while (num >= 0) {
      s = String.fromCharCode((num % 26) + 65) + s;
      num = Math.floor(num / 26) - 1;
    }
    return s;
  };
  const lettersToCol = (letters: string) => {
    const up = letters.toUpperCase();
    let n = 0;
    for (let i = 0; i < up.length; i++) n = n * 26 + (up.charCodeAt(i) - 64);
    return n - 1; // 0-based
  };
  const parseA1 = (ref: string) => {
    const m = ref.trim().match(/^([A-Za-z]+)(\d+)$/);
    if (!m) return null as any;
    const col = lettersToCol(m[1]!);
    const row = parseInt(m[2]!, 10) - 1;
    return { row, col } as { row: number; col: number };
  };

  const rangeToA1 = (r1: number, c1: number, r2: number, c2: number) => {
    const a = `${colToLetters(c1)}${r1 + 1}`;
    const b = `${colToLetters(c2)}${r2 + 1}`;
    return r1 === r2 && c1 === c2 ? a : `${a}:${b}`;
  };

  // --- Formula helpers: basic parser for SUM/AVERAGE/MIN/MAX/IF and ranges ---
  const splitArgs = (s: string) => {
    const args: string[] = [];
    let cur = "";
    let depth = 0;
    for (let i = 0; i < s.length; i++) {
      const ch = s[i]!;
      if (ch === "(") depth++;
      if (ch === ")" && depth > 0) depth--;
      if ((ch === "," || ch === ";") && depth === 0) {
        args.push(cur.trim());
        cur = "";
      } else {
        cur += ch;
      }
    }
    if (cur.trim().length) args.push(cur.trim());
    return args;
  };

  const toNumber = (v: any): number => {
    if (typeof v === "number") return v;
    if (typeof v === "string") {
      const num = parseFloat(v.replace(/,/g, "."));
      return Number.isFinite(num) ? num : NaN;
    }
    return NaN;
  };

  const getCellValue = (
    sheetIdx: number,
    token: string,
    depth: number,
  ): string => {
    // token like A1 or Sheet!B3 or 'Sheet Name'!C5
    let targetSheetIdx = sheetIdx;
    let ref = token.trim();
    if (ref.includes("!")) {
      const m = ref.match(/^('?)([^']+)\1!(.+)$/);
      if (m) {
        const name = m[2]!;
        const idx = sheets.findIndex((s) => s.name === name);
        if (idx >= 0) targetSheetIdx = idx;
        ref = m[3]!;
      }
    }
    const pos = parseA1(ref);
    if (!pos) return "";
    return getComputedValue(targetSheetIdx, pos.row, pos.col, depth + 1);
  };

  const getRangeValues = (
    sheetIdx: number,
    rng: string,
    depth: number,
  ): string[] => {
    // supports A1:B5 or A1
    const parts = rng.split(":");
    if (parts.length === 1)
      return [getCellValue(sheetIdx, parts[0]!, depth + 1)];
    const p1 = parseA1(parts[0]!);
    const p2 = parseA1(parts[1]!);
    if (!p1 || !p2) return [];
    const r1 = Math.min(p1.row, p2.row);
    const c1 = Math.min(p1.col, p2.col);
    const r2 = Math.max(p1.row, p2.row);
    const c2 = Math.max(p1.col, p2.col);
    const vals: string[] = [];
    for (let rr = r1; rr <= r2; rr++) {
      for (let cc = c1; cc <= c2; cc++) {
        vals.push(getComputedValue(sheetIdx, rr, cc, depth + 1));
      }
    }
    return vals;
  };

  const evalExpr = (sheetIdx: number, expr: string, depth: number): string => {
    const t = expr.trim();
    // quoted string
    if (
      (t.startsWith('"') && t.endsWith('"')) ||
      (t.startsWith("'") && t.endsWith("'"))
    ) {
      return t.slice(1, -1);
    }
    // number
    const num = toNumber(t);
    if (!Number.isNaN(num) && t.match(/^[0-9\.,+-]+$/)) return String(num);
    // range or cell
    if (t.match(/^[A-Za-z]+\d+(?::[A-Za-z]+\d+)?$/)) {
      const list = getRangeValues(sheetIdx, t, depth + 1);
      return list.length === 1
        ? list[0]!
        : String(
            list
              .map(toNumber)
              .filter((n) => !Number.isNaN(n))
              .reduce((a, b) => a + b, 0),
          );
    }
    // sheet!ref
    if (t.includes("!")) {
      return getCellValue(sheetIdx, t, depth + 1);
    }
    return t; // fallback raw
  };

  const computeFunction = (
    sheetIdx: number,
    nameRaw: string,
    argsRaw: string,
    depth: number,
  ): string => {
    const name = nameRaw.trim().toUpperCase();
    const map: Record<string, string> = {
      SUM: "SUM",
      СУММ: "SUM",
      AVERAGE: "AVERAGE",
      СРЗНАЧ: "AVERAGE",
      MIN: "MIN",
      МИН: "MIN",
      MAX: "MAX",
      МАКС: "MAX",
      IF: "IF",
      ЕСЛИ: "IF",
    };
    const fn = map[name] || name;
    const args = splitArgs(argsRaw);
    const expandArgToNumbers = (a: string): number[] => {
      const t = a.trim();
      if (t.match(/^[A-Za-z]+\d+:[A-Za-z]+\d+$/)) {
        return getRangeValues(sheetIdx, t, depth + 1)
          .map((v) => toNumber(v))
          .filter((n) => !Number.isNaN(n));
      }
      const v = evalExpr(sheetIdx, t, depth + 1);
      const n = toNumber(v);
      return !Number.isNaN(n) ? [n] : [];
    };

    if (fn === "SUM") {
      const nums = args.flatMap(expandArgToNumbers);
      const total = nums.reduce((a, b) => a + b, 0);
      return String(total);
    }
    if (fn === "AVERAGE") {
      const nums = args.flatMap(expandArgToNumbers);
      if (!nums.length) return "0";
      const total = nums.reduce((a, b) => a + b, 0);
      return String(total / nums.length);
    }
    if (fn === "MIN") {
      const nums = args.flatMap(expandArgToNumbers);
      if (!nums.length) return "0";
      return String(Math.min(...nums));
    }
    if (fn === "MAX") {
      const nums = args.flatMap(expandArgToNumbers);
      if (!nums.length) return "0";
      return String(Math.max(...nums));
    }
    if (fn === "IF") {
      const [condRaw, tValRaw = "", fValRaw = ""] = args;
      const condStr = (condRaw ?? "").trim();
      const opMatch = condStr.match(/(.+?)(>=|<=|<>|=|>|<)(.+)/);
      let truth = false;
      if (opMatch) {
        const left = evalExpr(sheetIdx, opMatch[1]!, depth + 1);
        const right = evalExpr(sheetIdx, opMatch[3]!, depth + 1);
        const op = opMatch[2]!;
        const ln = toNumber(left);
        const rn = toNumber(right);
        const bothNum = !Number.isNaN(ln) && !Number.isNaN(rn);
        const L = bothNum ? ln : left;
        const R = bothNum ? rn : right;
        switch (op) {
          case ">":
            truth = (L as any) > (R as any);
            break;
          case "<":
            truth = (L as any) < (R as any);
            break;
          case ">=":
            truth = (L as any) >= (R as any);
            break;
          case "<=":
            truth = (L as any) <= (R as any);
            break;
          case "=":
            truth = String(L) === String(R);
            break;
          case "<>":
            truth = String(L) !== String(R);
            break;
        }
      } else {
        const v = evalExpr(sheetIdx, condStr, depth + 1);
        const n = toNumber(v);
        truth = Number.isNaN(n) ? Boolean(v) : n !== 0;
      }
      return truth
        ? evalExpr(sheetIdx, tValRaw ?? "", depth + 1)
        : evalExpr(sheetIdx, fValRaw ?? "", depth + 1);
    }
    // Unknown - return as-is
    return `${nameRaw}(${argsRaw})`;
  };

  // Formula evaluation: supports =A1, cross-sheet refs, and basic functions with ranges
  const getComputedValue = (
    sheetIdx: number,
    r: number,
    c: number,
    depth = 0,
  ): string => {
    if (depth > 5) return "";
    const sh = sheets[sheetIdx];
    if (!sh) return "";
    const raw = String(sh.cells[r]?.[c] ?? "");
    if (!raw.startsWith("=")) return raw;
    const expr = raw.slice(1).trim();
    // function call?
    const fnMatch = expr.match(/^([A-Za-zА-Яа-я_]+)\((.*)\)$/);
    if (fnMatch) {
      try {
        return computeFunction(sheetIdx, fnMatch[1]!, fnMatch[2]!, depth + 1);
      } catch {
        // fallthrough to raw if parse error
      }
    }
    // cross-sheet single cell ref or A1
    let targetSheetIdx = sheetIdx;
    let a1 = expr;
    if (expr.startsWith("'")) {
      const end = expr.indexOf("'!", 1);
      if (end > 1) {
        const name = expr.slice(1, end);
        targetSheetIdx = Math.max(
          0,
          sheets.findIndex((s) => s.name === name),
        );
        a1 = expr.slice(end + 2);
      }
    } else if (expr.includes("!")) {
      const [name, rest] = expr.split("!", 2);
      const idx = sheets.findIndex((s) => s.name === name);
      if (idx >= 0) targetSheetIdx = idx;
      a1 = rest ?? expr;
    }
    const pos = parseA1(a1);
    if (!pos) return raw; // show formula if cannot parse
    const tv = String(sheets[targetSheetIdx]?.cells[pos.row]?.[pos.col] ?? "");
    if (
      tv.startsWith("=") &&
      !(targetSheetIdx === sheetIdx && pos.row === r && pos.col === c)
    ) {
      return getComputedValue(targetSheetIdx, pos.row, pos.col, depth + 1);
    }
    return tv;
  };

  // Autosave entire book (with validation, dropdowns, formats)
  useEffect(() => {
    try {
      localStorage.setItem(
        "kbtSheetsBook.v1",
        JSON.stringify({ sheets, activeIndex, fileName }),
      );
    } catch {
      /* ignore */
    }
  }, [sheets, activeIndex, fileName]);

  // Mouse/selection handlers
  const getMergeAt = (r: number, c: number): Merge | null => {
    for (const m of merges) {
      if (
        r >= m.startRow &&
        r < m.startRow + m.rowSpan &&
        c >= m.startCol &&
        c < m.startCol + m.colSpan
      ) {
        return m;
      }
    }
    return null;
  };
  const isStartOfMerge = (r: number, c: number) => {
    const m = merges.find((x) => x.startRow === r && x.startCol === c);
    return !!m ? m : null;
  };
  const isCoveredByMerge = (r: number, c: number) => {
    const m = getMergeAt(r, c);
    if (!m) return false;
    return !(m.startRow === r && m.startCol === c);
  };
  const doesOverlapExisting = (rng: {
    r1: number;
    c1: number;
    r2: number;
    c2: number;
  }) => {
    return merges.some((m) => {
      const mr1 = m.startRow;
      const mc1 = m.startCol;
      const mr2 = m.startRow + m.rowSpan - 1;
      const mc2 = m.startCol + m.colSpan - 1;
      const rowsOverlap = !(rng.r2 < mr1 || rng.r1 > mr2);
      const colsOverlap = !(rng.c2 < mc1 || rng.c1 > mc2);
      return rowsOverlap && colsOverlap;
    });
  };
  const onCellMouseDown = (r: number, c: number) => {
    setIsMouseDown(true);
    setAnchor({ r, c });
    setSelection({ r1: r, c1: c, r2: r, c2: c });
  };
  const onCellMouseEnter = (r: number, c: number) => {
    if (!isMouseDown || !anchor) return;
    const n = normalizeRange(anchor.r, anchor.c, r, c);
    setSelection(n);
  };
  const onMouseUp = () => setIsMouseDown(false);
  const onCellClick = (e: React.MouseEvent, r: number, c: number) => {
    if (e.shiftKey && anchor) {
      const n = normalizeRange(anchor.r, anchor.c, r, c);
      setSelection(n);
    } else {
      setAnchor({ r, c });
      setSelection({ r1: r, c1: c, r2: r, c2: c });
    }
  };

  const handleMerge = () => {
    if (!selection) return;
    const n = normalizeRange(
      selection.r1,
      selection.c1,
      selection.r2,
      selection.c2,
    );
    if (n.r1 === n.r2 && n.c1 === n.c2) return;
    if (doesOverlapExisting(n)) {
      toast({
        title: "Нельзя объединить",
        description: "Диапазон пересекается с уже объединёнными ячейками.",
      });
      return;
    }
    setMerges((prev) => [
      ...prev,
      {
        startRow: n.r1,
        startCol: n.c1,
        rowSpan: n.r2 - n.r1 + 1,
        colSpan: n.c2 - n.c1 + 1,
      },
    ]);
  };
  const handleUnmerge = () => {
    if (!selection) {
      if (anchor) {
        const m = getMergeAt(anchor.r, anchor.c);
        if (m) setMerges((prev) => prev.filter((x) => x !== m));
      }
      return;
    }
    const n = normalizeRange(
      selection.r1,
      selection.c1,
      selection.r2,
      selection.c2,
    );
    setMerges((prev) =>
      prev.filter((m) => {
        const mr1 = m.startRow;
        const mc1 = m.startCol;
        const mr2 = m.startRow + m.rowSpan - 1;
        const mc2 = m.startCol + m.colSpan - 1;
        const rowsOverlap = !(n.r2 < mr1 || n.r1 > mr2);
        const colsOverlap = !(n.c2 < mc1 || n.c1 > mc2);
        return !(rowsOverlap && colsOverlap);
      }),
    );
  };
  const isSelected = (r: number, c: number) => {
    if (!selection) return false;
    const { r1, c1, r2, c2 } = selection;
    return r >= r1 && r <= r2 && c >= c1 && c <= c2;
  };

  // Book controls
  const addSheet = () => {
    setSheets((prev) => {
      const names = prev.map((s) => s.name);
      const name = defaultSheetName(names);
      const next: KbtSheet = {
        id: makeId(),
        name,
        rows: 10,
        cols: 6,
        cells: Array.from({ length: 10 }, () =>
          Array.from({ length: 6 }, () => ""),
        ),
        merges: [],
        dropdowns: {},
        validations: {},
        formats: {},
      };
      return [...prev, next];
    });
    setActiveIndex(() => sheets.length); // select newly added
  };
  const renameSheet = () => {
    const cur = sheets[activeIndex];
    if (!cur) return;
    const name = prompt("Новое название листа", cur.name) ?? undefined;
    if (!name) return;
    setSheets((prev) => {
      const taken = new Set(prev.map((s) => s.name));
      let fixed = name.trim();
      if (!fixed) fixed = defaultSheetName([...taken]);
      if (taken.has(fixed) && fixed !== cur.name) {
        let n = 2;
        while (taken.has(`${fixed} (${n})`)) n++;
        fixed = `${fixed} (${n})`;
      }
      const next = [...prev];
      next[activeIndex] = { ...cur, name: fixed };
      return next;
    });
  };
  const deleteSheet = () => {
    if (sheets.length <= 1) {
      toast({
        title: "Нельзя удалить",
        description: "Должен остаться хотя бы один лист.",
      });
      return;
    }
    if (!confirm("Удалить текущий лист?")) return;
    setSheets((prev) => {
      const next = prev.filter((_, idx) => idx !== activeIndex);
      return next.length ? next : prev;
    });
    setActiveIndex((idx) => Math.max(0, Math.min(idx - 1, sheets.length - 2)));
  };

  // Grid helpers
  const onCellChange = (i: number, j: number, value: string) => {
    setCells((prev) => {
      const copy = prev.map((r) => [...r]);
      const rowRef = (copy[i] ??= Array.from({ length: cols }, () => ""));
      rowRef[j] = value;
      return copy as string[][];
    });
  };

  // Validation helpers
  const validateValue = (
    rule: { kind: "notEmpty" | "number" | "date" },
    v: string,
  ): boolean => {
    const val = (v ?? "").trim();
    if (rule.kind === "notEmpty") return val.length > 0;
    if (rule.kind === "number") return /^-?\d+(?:[\.,]\d+)?$/.test(val);
    if (rule.kind === "date") return /^\d{4}-\d{2}-\d{2}$/.test(val);
    return true;
  };

  const isInvalidCell = (r: number, c: number) => {
    const sh = current;
    if (!sh) return false;
    const ref = a1(r, c);
    const rule = sh.validations?.[ref];
    if (!rule) return false;
    const raw = String(sh.cells[r]?.[c] ?? "");
    const value = raw.startsWith("=")
      ? getComputedValue(activeIndex, r, c)
      : raw;
    return !validateValue(rule, value);
  };

  // Conditional formatting helpers
  const formatStyleFor = (
    r: number,
    c: number,
  ): React.CSSProperties | undefined => {
    const sh = current;
    if (!sh) return undefined;
    const ref = a1(r, c);
    const fmt = sh.formats?.[ref];
    if (!fmt) return undefined;
    const raw = String(sh.cells[r]?.[c] ?? "");
    const value = raw.startsWith("=")
      ? getComputedValue(activeIndex, r, c)
      : raw;
    let hit = false;
    if (fmt.op === "contains") {
      hit = value.toString().includes(fmt.value);
    } else {
      const num = Number(value.toString().replace(",", "."));
      const thr = Number(fmt.value.toString().replace(",", "."));
      if (!Number.isNaN(num) && !Number.isNaN(thr)) {
        if (fmt.op === ">") hit = num > thr;
        if (fmt.op === "<") hit = num < thr;
        if (fmt.op === "=") hit = num === thr;
      } else if (fmt.op === "=" && value.toString() === fmt.value) {
        hit = true;
      }
    }
    return hit ? { backgroundColor: fmt.color } : undefined;
  };

  // Table ops state: sort and filter
  const [sortCol, setSortCol] = useState<number | null>(null);
  const [sortDir, setSortDir] = useState<"asc" | "desc">("asc");
  const [filterCol, setFilterCol] = useState<number | null>(null);
  const [filterText, setFilterText] = useState<string>("");

  const visibleRow = (i: number) => {
    if (filterCol === null || filterCol < 0 || filterCol >= cols) return true;
    const raw = String(current?.cells[i]?.[filterCol] ?? "");
    const val = raw.startsWith("=")
      ? getComputedValue(activeIndex, i, filterCol)
      : raw;
    const q = filterText.trim();
    if (!q) return true;
    return val.toString().toLowerCase().includes(q.toLowerCase());
  };

  const applySort = () => {
    if (sortCol === null) return;
    if ((current?.merges?.length ?? 0) > 0) {
      toast({
        title: "Сортировка недоступна",
        description: "Сначала разъедините объединённые ячейки",
      });
      return;
    }
    updateCurrentSheet((s) => {
      const rowsCopy = s.cells.map((row) => [...row]);
      rowsCopy.sort((a, b) => {
        const ra = String(a[sortCol] ?? "");
        const rb = String(b[sortCol] ?? "");
        const va = ra.startsWith("=")
          ? getComputedValue(activeIndex, s.cells.indexOf(a), sortCol)
          : ra;
        const vb = rb.startsWith("=")
          ? getComputedValue(activeIndex, s.cells.indexOf(b), sortCol)
          : rb;
        const na = Number(String(va).replace(",", "."));
        const nb = Number(String(vb).replace(",", "."));
        let cmp = 0;
        if (!Number.isNaN(na) && !Number.isNaN(nb)) cmp = na - nb;
        else cmp = String(va).localeCompare(String(vb), "ru");
        return sortDir === "asc" ? cmp : -cmp;
      });
      return { ...s, cells: rowsCopy };
    });
  };

  // Column width & format helpers
  const setColumnWidth = (col: number, widthPx: number) => {
    updateCurrentSheet((s) => {
      const arr = [...(s.colWidths || [])];
      arr[col] = Math.max(40, Math.floor(widthPx));
      return { ...s, colWidths: arr } as any;
    });
  };
  const setColumnFormat = (
    col: number,
    type: "text" | "number" | "date",
    decimals?: number,
  ) => {
    updateCurrentSheet((s) => {
      const fmts = [...(s.colFormats || [])] as any[];
      const decs = [...(s.colDecimals || [])] as any[];
      fmts[col] = type;
      if (typeof decimals === "number") decs[col] = Math.max(0, decimals);
      return { ...(s as any), colFormats: fmts, colDecimals: decs } as any;
    });
  };

  const columnLetters = Array.from({ length: cols }, (_, j) => colToLetters(j));

  // Controls local state
  const [opsCol, setOpsCol] = useState<number>(0);
  const [widthDraft, setWidthDraft] = useState<string>("");
  const [fmtType, setFmtType] = useState<"text" | "number" | "date">("text");
  const [fmtDecimals, setFmtDecimals] = useState<string>("0");

  // Build export payload for the current sheet (compute formulas so file has values)
  const gridToExcelCells = () => {
    const out: Array<{ ref: string; v?: string; f?: string }> = [];
    for (let i = 0; i < rows; i++) {
      for (let j = 0; j < cols; j++) {
        const raw = String(current?.cells[i]?.[j] ?? "");
        const ref = `${colToLetters(j)}${i + 1}`;
        if (raw.startsWith("=")) {
          out.push({ ref, v: getComputedValue(activeIndex, i, j) });
        } else {
          out.push({ ref, v: raw });
        }
      }
    }
    return out;
  };

  const saveSheet = useMutation(apiClient.saveKbtSheetToStorage, {
    onSuccess: () => {
      toast({
        title: "Сохранено в программу",
        description: "Файл добавлен в хранилище (КБТ)",
      });
    },
    onError: () => toast({ title: "Не удалось сохранить" }),
  });
  const exportExcel = useMutation(apiClient.saveKbtSheetToStorage, {
    onSuccess: (res: { ok: boolean; url: string }) => {
      const a = document.createElement("a");
      const safe = (s: string) => s.replace(/[\\/:*?"<>|]+/g, " ").trim();
      a.href = res.url;
      a.download = `${safe(fileName || "Отчёт КБТ")}.xlsx`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    },
    onError: () => toast({ title: "Не удалось выгрузить Excel" }),
  });
  const sendReport = useMutation(apiClient.sendKbtReportToAdmin, {
    onSuccess: () => {
      toast({
        title: "Отправлено",
        description:
          "Отчёт отправлен главному администратору и сохранён в хранилище.",
      });
    },
    onError: () => toast({ title: "Не удалось отправить отчёт" }),
  });

  if (isInitialLoading) {
    return (
      <div className="max-w-6xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Загрузка…</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Проверяем статус доступа.
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }
  if (me && !me.canAccessNow) {
    return <AccessRestrictionNotice blocked={(me as any).isBlocked ?? false} />;
  }

  return (
    <div className="w-full max-w-[120rem] mx-auto px-4 sm:px-6 space-y-4">
      <Card className="card-elevated h-full">
        <CardHeader className="space-y-2">
          {me?.isAdmin && (
            <div className="text-xs text-muted-foreground">
              Вы видите все инструменты настройки таблицы. Обычным пользователям
              доступна только кнопка «Отправить».
            </div>
          )}
          <CardTitle>Отчитаться по КБТ</CardTitle>

          {/* File name */}
          <div className="grid md:grid-cols-2 gap-3">
            <div className="grid gap-1">
              <Label>Название файла</Label>
              <Input
                value={fileName}
                onChange={(e) => setFileName(e.target.value)}
                placeholder="Отчёт_КБТ_2025-10-25"
              />
            </div>
            <div className="grid gap-1">
              <Label>Название текущего листа</Label>
              <Input
                value={sheetName}
                onChange={(e) =>
                  setSheets((prev) => {
                    const next = [...prev];
                    if (next[activeIndex])
                      next[activeIndex] = {
                        ...next[activeIndex]!,
                        name: e.target.value,
                      };
                    return next;
                  })
                }
                placeholder="Лист1"
              />
            </div>
          </div>

          {/* Sheet tabs and actions */}
          <div className="flex flex-wrap items-center gap-2 pt-2">
            <div className="flex flex-wrap gap-2">
              {sheets.map((s, idx) => (
                <Button
                  key={s.id}
                  variant={idx === activeIndex ? "secondary" : "outline"}
                  onClick={() => setActiveIndex(idx)}
                  size="sm"
                >
                  {s.name}
                </Button>
              ))}
            </div>
            <div className="flex gap-2 ml-auto">
              <Button variant="secondary" size="sm" onClick={addSheet}>
                Добавить лист
              </Button>
              <Button variant="secondary" size="sm" onClick={renameSheet}>
                Переименовать
              </Button>
              <Button variant="destructive" size="sm" onClick={deleteSheet}>
                Удалить
              </Button>
            </div>
          </div>

          {/* Merge controls */}
          <div className="flex flex-wrap items-center gap-2 pt-2">
            <Button
              variant="secondary"
              onClick={handleMerge}
              disabled={
                !selection ||
                (selection &&
                  selection.r1 === selection.r2 &&
                  selection.c1 === selection.c2)
              }
            >
              Объединить ячейки
            </Button>
            <Button variant="secondary" onClick={handleUnmerge}>
              Разъединить ячейки
            </Button>
            {selection && (
              <div className="text-xs text-muted-foreground">
                Выделено:{" "}
                {rangeToA1(
                  selection.r1,
                  selection.c1,
                  selection.r2,
                  selection.c2,
                )}
              </div>
            )}
          </div>

          {/* Data tools: dropdowns, validation, conditional formatting */}
          <div className="flex flex-col gap-3 pt-2">
            {/* Dropdowns */}
            <div className="grid md:grid-cols-[1fr_auto] gap-2 items-end">
              <div className="grid gap-1">
                <Label>Выпадающий список (значения через запятую)</Label>
                <Input
                  placeholder="например: Да, Нет, Н/Д"
                  onChange={(e) => ((window as any).__kbt_dd = e.target.value)}
                />
              </div>
              <div className="flex gap-2">
                <Button
                  variant="secondary"
                  onClick={() => {
                    const text: string = (window as any).__kbt_dd || "";
                    const options = text
                      .split(",")
                      .map((s) => s.trim())
                      .filter((s) => s.length > 0);
                    if (!selection || options.length === 0) return;
                    updateCurrentSheet((s) => {
                      const dd = { ...(s.dropdowns || {}) };
                      for (let r = selection.r1; r <= selection.r2; r++) {
                        for (let c = selection.c1; c <= selection.c2; c++) {
                          dd[a1(r, c)] = options;
                        }
                      }
                      return { ...s, dropdowns: dd };
                    });
                  }}
                >
                  Применить список к выделению
                </Button>
                <Button
                  variant="ghost"
                  onClick={() => {
                    if (!selection) return;
                    updateCurrentSheet((s) => {
                      const dd = { ...(s.dropdowns || {}) };
                      for (let r = selection.r1; r <= selection.r2; r++) {
                        for (let c = selection.c1; c <= selection.c2; c++) {
                          delete dd[a1(r, c)];
                        }
                      }
                      return { ...s, dropdowns: dd };
                    });
                  }}
                >
                  Удалить список
                </Button>
              </div>
            </div>

            {/* Validation */}
            <div className="grid md:grid-cols-[200px_auto] gap-2 items-end">
              <div className="grid gap-1">
                <Label>Валидация</Label>
                <select
                  className="h-9 border rounded px-2 bg-background"
                  onChange={(e) => ((window as any).__kbt_val = e.target.value)}
                >
                  <option value="">— не задано —</option>
                  <option value="notEmpty">Обязательно</option>
                  <option value="number">Число</option>
                  <option value="date">Дата (ГГГГ-ММ-ДД)</option>
                </select>
              </div>
              <div className="flex gap-2">
                <Button
                  variant="secondary"
                  onClick={() => {
                    const kind = (window as any).__kbt_val as string;
                    if (!selection || !kind) return;
                    updateCurrentSheet((s) => {
                      const vv = { ...(s.validations || {}) };
                      for (let r = selection.r1; r <= selection.r2; r++) {
                        for (let c = selection.c1; c <= selection.c2; c++) {
                          vv[a1(r, c)] = { kind: kind as any };
                        }
                      }
                      return { ...s, validations: vv };
                    });
                  }}
                >
                  Применить валидацию
                </Button>
                <Button
                  variant="ghost"
                  onClick={() => {
                    if (!selection) return;
                    updateCurrentSheet((s) => {
                      const vv = { ...(s.validations || {}) };
                      for (let r = selection.r1; r <= selection.r2; r++) {
                        for (let c = selection.c1; c <= selection.c2; c++) {
                          delete vv[a1(r, c)];
                        }
                      }
                      return { ...s, validations: vv };
                    });
                  }}
                >
                  Удалить валидацию
                </Button>
              </div>
            </div>

            {/* Conditional formatting */}
            <div className="grid md:grid-cols-[200px_1fr_140px_auto] gap-2 items-end">
              <div className="grid gap-1">
                <Label>Условие</Label>
                <select
                  className="h-9 border rounded px-2 bg-background"
                  onChange={(e) =>
                    ((window as any).__kbt_cf_op = e.target.value)
                  }
                >
                  <option value=">">&gt;</option>
                  <option value="<">&lt;</option>
                  <option value="=">=</option>
                  <option value="contains">содержит</option>
                </select>
              </div>
              <div className="grid gap-1">
                <Label>Значение</Label>
                <Input
                  onChange={(e) =>
                    ((window as any).__kbt_cf_val = e.target.value)
                  }
                  placeholder="порог или текст"
                />
              </div>
              <div className="grid gap-1">
                <Label>Цвет</Label>
                <Input
                  type="color"
                  defaultValue="#ffeeba"
                  onChange={(e) =>
                    ((window as any).__kbt_cf_col = e.target.value)
                  }
                />
              </div>
              <div className="flex gap-2">
                <Button
                  variant="secondary"
                  onClick={() => {
                    const op = ((window as any).__kbt_cf_op as string) || ">";
                    const val = ((window as any).__kbt_cf_val as string) || "";
                    const col =
                      ((window as any).__kbt_cf_col as string) || "#ffeeba";
                    if (!selection) return;
                    updateCurrentSheet((s) => {
                      const ff = { ...(s.formats || {}) };
                      for (let r = selection.r1; r <= selection.r2; r++) {
                        for (let c = selection.c1; c <= selection.c2; c++) {
                          ff[a1(r, c)] = {
                            op: op as any,
                            value: val,
                            color: col,
                          };
                        }
                      }
                      return { ...s, formats: ff };
                    });
                  }}
                >
                  Применить формат
                </Button>
                <Button
                  variant="ghost"
                  onClick={() => {
                    if (!selection) return;
                    updateCurrentSheet((s) => {
                      const ff = { ...(s.formats || {}) };
                      for (let r = selection.r1; r <= selection.r2; r++) {
                        for (let c = selection.c1; c <= selection.c2; c++) {
                          delete ff[a1(r, c)];
                        }
                      }
                      return { ...s, formats: ff };
                    });
                  }}
                >
                  Удалить формат
                </Button>
              </div>
            </div>
          </div>
        </CardHeader>
        <CardContent className="space-y-4">
          {/* Table operations */}
          <div className="space-y-3">
            <div className="grid lg:grid-cols-2 gap-3">
              {/* Sort & filter */}
              <div className="p-3 border rounded space-y-2">
                <div className="font-medium">Сортировка и фильтр</div>
                <div className="grid sm:grid-cols-3 gap-2 items-end">
                  <div className="grid gap-1">
                    <Label>Столбец</Label>
                    <Select
                      value={sortCol?.toString() ?? ""}
                      onValueChange={(v) =>
                        setSortCol(v === "" ? null : parseInt(v, 10))
                      }
                    >
                      <SelectTrigger>
                        <SelectValue placeholder="—" />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="all">—</SelectItem>
                        {columnLetters.map((l, j) => (
                          <SelectItem key={j} value={String(j)}>
                            {l}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>
                  <div className="grid gap-1">
                    <Label>Направление</Label>
                    <Select
                      value={sortDir}
                      onValueChange={(v) => setSortDir(v as any)}
                    >
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="asc">По возрастанию</SelectItem>
                        <SelectItem value="desc">По убыванию</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                  <div className="flex gap-2">
                    <Button
                      variant="secondary"
                      onClick={applySort}
                      disabled={sortCol === null}
                    >
                      Применить сортировку
                    </Button>
                    <Button variant="ghost" onClick={() => setSortCol(null)}>
                      Сброс
                    </Button>
                  </div>
                </div>

                <div className="grid sm:grid-cols-3 gap-2 items-end pt-2">
                  <div className="grid gap-1">
                    <Label>Фильтр по столбцу</Label>
                    <Select
                      value={filterCol?.toString() ?? ""}
                      onValueChange={(v) =>
                        setFilterCol(v === "" ? null : parseInt(v, 10))
                      }
                    >
                      <SelectTrigger>
                        <SelectValue placeholder="—" />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="all">—</SelectItem>
                        {columnLetters.map((l, j) => (
                          <SelectItem key={j} value={String(j)}>
                            {l}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>
                  <div className="grid gap-1">
                    <Label>Значение</Label>
                    <Input
                      value={filterText}
                      onChange={(e) => setFilterText(e.target.value)}
                      placeholder="поиск…"
                    />
                  </div>
                  <div className="flex gap-2">
                    <Button variant="ghost" onClick={() => setFilterText("")}>
                      Очистить фильтр
                    </Button>
                  </div>
                </div>
              </div>

              {/* Columns */}
              <div className="p-3 border rounded space-y-2">
                <div className="font-medium">Столбцы</div>
                <div className="grid sm:grid-cols-4 gap-2 items-end">
                  <div className="grid gap-1">
                    <Label>Колонка</Label>
                    <Select
                      value={String(opsCol)}
                      onValueChange={(v) => setOpsCol(parseInt(v, 10))}
                    >
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        {columnLetters.map((l, j) => (
                          <SelectItem key={j} value={String(j)}>
                            {l}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>
                  <div className="grid gap-1">
                    <Label>Ширина (px)</Label>
                    <Input
                      value={widthDraft}
                      onChange={(e) => setWidthDraft(e.target.value)}
                      placeholder="120"
                    />
                  </div>
                  <div className="flex gap-2">
                    <Button
                      variant="secondary"
                      onClick={() =>
                        widthDraft &&
                        setColumnWidth(opsCol, parseInt(widthDraft, 10))
                      }
                    >
                      Задать ширину
                    </Button>
                    <Button
                      variant="ghost"
                      onClick={() => setColumnWidth(opsCol, 120)}
                    >
                      По умолчанию
                    </Button>
                  </div>
                </div>

                <div className="grid sm:grid-cols-4 gap-2 items-end">
                  <div className="grid gap-1">
                    <Label>Формат</Label>
                    <Select
                      value={fmtType}
                      onValueChange={(v) => setFmtType(v as any)}
                    >
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="text">Текст</SelectItem>
                        <SelectItem value="number">Число</SelectItem>
                        <SelectItem value="date">Дата</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                  <div className="grid gap-1">
                    <Label>Десятичные</Label>
                    <Input
                      type="number"
                      value={fmtDecimals}
                      onChange={(e) => setFmtDecimals(e.target.value)}
                    />
                  </div>
                  <div className="flex gap-2">
                    <Button
                      variant="secondary"
                      onClick={() =>
                        setColumnFormat(
                          opsCol,
                          fmtType,
                          parseInt(fmtDecimals || "0", 10),
                        )
                      }
                    >
                      Применить формат
                    </Button>
                  </div>
                </div>

                <div className="grid sm:grid-cols-2 gap-3 pt-2">
                  <div className="flex items-center gap-2">
                    <Switch
                      checked={!!current?.frozenHeader}
                      onCheckedChange={(v) =>
                        updateCurrentSheet((s) => ({ ...s, frozenHeader: !!v }))
                      }
                    />
                    <Label>Закрепить шапку</Label>
                  </div>
                  <div className="flex items-center gap-2">
                    <Switch
                      checked={!!current?.frozenFirstCol}
                      onCheckedChange={(v) =>
                        updateCurrentSheet((s) => ({
                          ...s,
                          frozenFirstCol: !!v,
                        }))
                      }
                    />
                    <Label>Закрепить первый столбец</Label>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* Grid controls */}
          <div className="flex flex-wrap items-center gap-2">
            <Button
              variant="secondary"
              onClick={() => setRows((r) => Math.min(200, r + 1))}
            >
              Добавить строку
            </Button>
            <Button
              variant="secondary"
              onClick={() => setRows((r) => Math.max(1, r - 1))}
            >
              Убрать строку
            </Button>
            <Button
              variant="secondary"
              onClick={() => setCols((c) => Math.min(50, c + 1))}
            >
              Добавить столбец
            </Button>
            <Button
              variant="secondary"
              onClick={() => setCols((c) => Math.max(1, c - 1))}
            >
              Убрать столбец
            </Button>
            <div className="text-sm text-muted-foreground">
              Размер: {rows} × {cols}
            </div>
          </div>

          {/* Grid */}
          <div className="overflow-auto border rounded" onMouseUp={onMouseUp}>
            <table className="min-w-full select-none">
              <thead>
                <tr>
                  <th className="border p-2 bg-secondary text-left text-xs sticky left-0">
                    #
                  </th>
                  {Array.from({ length: cols }).map((_, j) => (
                    <th
                      key={j}
                      className={`border p-2 bg-secondary text-left text-xs ${current?.frozenHeader ? "sticky top-0 z-10" : ""}`}
                      style={
                        current?.colWidths?.[j]
                          ? {
                              width: `${current.colWidths[j]}px`,
                              minWidth: `${current.colWidths[j]}px`,
                            }
                          : undefined
                      }
                    >
                      {colToLetters(j)}
                    </th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {Array.from({ length: rows }).map((_, i) => (
                  <tr
                    key={i}
                    style={{ display: visibleRow(i) ? undefined : "none" }}
                  >
                    <td className="border p-2 bg-secondary text-xs sticky left-0">
                      {i + 1}
                    </td>
                    {Array.from({ length: cols }).map((_, j) => {
                      if (isCoveredByMerge(i, j)) return null;
                      const m = isStartOfMerge(i, j) as Merge | null;
                      const isSel = isSelected(i, j);
                      const tdProps: any = {};
                      if (m) {
                        if (m.rowSpan > 1) tdProps.rowSpan = m.rowSpan;
                        if (m.colSpan > 1) tdProps.colSpan = m.colSpan;
                      }
                      const baseTdClass = `border p-1 align-top min-w-[160px] ${isSel ? "bg-accent/50" : ""}`;
                      const raw = String(current?.cells[i]?.[j] ?? "");
                      const computed = raw.startsWith("=")
                        ? getComputedValue(activeIndex, i, j)
                        : null;
                      const ref = `${colToLetters(j)}${i + 1}`;
                      const dd = current?.dropdowns?.[ref];
                      const invalid = isInvalidCell(i, j);
                      const fmtStyle = formatStyleFor(i, j);
                      const widthPx = current?.colWidths?.[j];
                      const stickyStyle =
                        current?.frozenFirstCol && j === 0
                          ? {
                              position: "sticky",
                              left: 44,
                              zIndex: 5,
                              background: "hsl(var(--card))",
                            }
                          : undefined;
                      const cellStyle = {
                        ...(fmtStyle || {}),
                        ...(widthPx
                          ? { width: `${widthPx}px`, minWidth: `${widthPx}px` }
                          : {}),
                        ...(stickyStyle || {}),
                      } as React.CSSProperties;
                      return (
                        <td
                          key={j}
                          className={baseTdClass}
                          {...tdProps}
                          onMouseDown={() => onCellMouseDown(i, j)}
                          onMouseEnter={() => onCellMouseEnter(i, j)}
                          onClick={(e) => onCellClick(e, i, j)}
                          title={`${colToLetters(j)}${i + 1}`}
                          style={cellStyle}
                        >
                          <div className="flex flex-col gap-1">
                            <div className="text-[10px] text-muted-foreground text-right">
                              {ref}
                            </div>
                            {Array.isArray(dd) && dd.length > 0 ? (
                              <div
                                className={`border rounded ${invalid ? "border-red-500" : "border-input"}`}
                              >
                                <Select
                                  value={raw}
                                  onValueChange={(val) => onCellChange(i, j, val)}
                                >
                                  <SelectTrigger className="w-full">
                                    <SelectValue placeholder="Выберите" />
                                  </SelectTrigger>
                                  <SelectContent>
                                    {dd.map((opt, idx2) => (
                                      <SelectItem key={idx2} value={opt}>
                                        {opt}
                                      </SelectItem>
                                    ))}
                                  </SelectContent>
                                </Select>
                              </div>
                            ) : (
                              <Textarea
                                className={`w-full resize-none whitespace-pre-wrap break-words min-h-[40px] ${invalid ? "border-red-500" : ""}`}
                                value={raw}
                                onChange={(e) => {
                                  const el = e.target as HTMLTextAreaElement;
                                  el.style.height = "auto";
                                  el.style.height = `${el.scrollHeight}px`;
                                  onCellChange(i, j, e.target.value);
                                }}
                                onFocus={(e) => {
                                  const el = e.target as HTMLTextAreaElement;
                                  el.style.height = "auto";
                                  el.style.height = `${el.scrollHeight}px`;
                                }}
                                placeholder={`${colToLetters(j)}${i + 1}`}
                              />
                            )}
                            {computed !== null && (
                              <div className="text-xs text-muted-foreground mt-1">
                                ⇒ {computed}
                              </div>
                            )}
                          </div>
                        </td>
                      );
                    })}
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          <div className="text-xs text-muted-foreground">
            Сохранённые PDF-отчёты попадают в раздел «КБТ ОТЧЕТЫ» в «Хранилище» —
            в папку вашего подразделения, которая создаётся автоматически.
            Поддерживаются ссылки между листами в виде формул (например, =A1,
            =Лист2!B3, ='Лист с пробелом'!C5).
          </div>
        </CardContent>
        <CardFooter className="flex flex-wrap gap-2">
          {/* Кнопка отправки всегда доступна */}
          <Button
            variant="outline"
            disabled={sendReport.isLoading}
            onClick={() =>
              sendReport.mutate({
                sheet: sheetName || "Лист",
                cells: gridToExcelCells(),
                fileName,
              })
            }
          >
            {sendReport.isLoading ? "Отправляем…" : "Отправить"}
          </Button>

          {/* Остальные действия только для админов */}
          {me?.isAdmin && (
            <>
              <Button
                className="btn-3d"
                disabled={saveSheet.isLoading}
                onClick={() =>
                  saveSheet.mutate({
                    sheet: sheetName || "Лист",
                    cells: gridToExcelCells(),
                    fileName,
                  })
                }
              >
                {saveSheet.isLoading ? "Сохраняем…" : "Сохранить в программу"}
              </Button>
              <Button
                variant="secondary"
                disabled={exportExcel.isLoading}
                onClick={() =>
                  exportExcel.mutate({
                    sheet: sheetName || "Лист",
                    cells: gridToExcelCells(),
                    fileName,
                  })
                }
              >
                Выгрузить Excel
              </Button>
              <Button variant="ghost" onClick={() => navigate("/kbt")}>
                Назад к КБТ
              </Button>
            </>
          )}
        </CardFooter>
      </Card>
    </div>
  );
}

function KbtHtmlReportForm({ me }: { me: Profile | null | undefined }) {
  const navigate = useNavigate();
  const { toast } = useToast();
  const [userData, setUserData] = useState<{ department: string; fullName: string }>(
    () => {
      let department = "";
      let fullName = "";
      try {
        const raw = localStorage.getItem("kbt_user_data");
        if (raw) {
          const parsed = JSON.parse(raw) as { department?: string; fullName?: string };
          department = parsed.department || "";
          fullName = parsed.fullName || "";
        }
      } catch {
        /* ignore */
      }
      if (me) {
        const anyMe = me as any;
        department = anyMe.department || anyMe.departmentName || department;
        fullName = anyMe.fullName || anyMe.name || fullName;
      }
      return { department, fullName };
    },
  );

  useEffect(() => {
    if (!me) return;
    setUserData((prev) => {
      const anyMe = me as any;
      const department =
        anyMe.department || anyMe.departmentName || prev.department || "";
      const fullName = anyMe.fullName || anyMe.name || prev.fullName || "";
      const next = { department, fullName };
      try {
        localStorage.setItem("kbt_user_data", JSON.stringify(next));
      } catch {
        /* ignore */
      }
      return next;
    });
  }, [me]);

  const savePdfToStorageMutation = useMutation(apiClient.saveKbtReportPdfToStorage, {
    onSuccess: () => {
      toast({
        title: "Сохранено в хранилище",
        description:
          "PDF отчета добавлен в раздел «КБТ ОТЧЕТЫ» в папку вашего подразделения.",
      });
    },
    onError: () => {
      toast({
        title: "Не удалось сохранить PDF в хранилище",
        description: "Попробуйте ещё раз или обратитесь к администратору.",
      });
    },
  });

  const today = new Date();
  const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
  const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
  const toInputDate = (d: Date) => {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  };

  const getFieldValue = (id: string) => {
    const el = document.getElementById(id) as
      | HTMLInputElement
      | HTMLTextAreaElement
      | null;
    return el?.value ?? "";
  };

  const setFieldValue = (id: string, value: string) => {
    const el = document.getElementById(id) as
      | HTMLInputElement
      | HTMLTextAreaElement
      | null;
    if (el) {
      el.value = value;
    }
  };

  const recomputePabDiffs = () => {
    const planDept = parseFloat(getFieldValue("pab_plan_department")) || 0;
    const factDept = parseFloat(getFieldValue("pab_fact_department")) || 0;
    setFieldValue("pab_diff_department", String(factDept - planDept));

    const planPers = parseFloat(getFieldValue("pab_plan_personal")) || 0;
    const factPers = parseFloat(getFieldValue("pab_fact_personal")) || 0;
    setFieldValue("pab_diff_personal", String(factPers - planPers));
  };

  const buildReportObject = () => {
    const ids = [
      "department",
      "head_name",
      "period_from",
      "period_to",
      "sick_count",
      "suspended",
      "injuries",
      "micro_injuries",
      "sick_leave",
      "accidents",
      "acts_count",
      "inspector",
      "violations_count",
      "responsible_person",
      "fixed_count",
      "in_progress_count",
      "overdue_count",
      "reasons",
      "actions_taken",
      "internal_checks_count",
      "internal_violations_count",
      "internal_responsible",
      "internal_fixed_count",
      "internal_in_progress_count",
      "internal_overdue_count",
      "internal_reasons",
      "internal_actions_taken",
      "gov_agency",
      "act_number",
      "gov_violations",
      "gov_responsible",
      "gov_fixed_count",
      "gov_in_progress_count",
      "gov_overdue_count",
      "gov_reasons",
      "pab_plan_department",
      "pab_fact_department",
      "pab_diff_department",
      "pab_reason_department",
      "pab_plan_personal",
      "pab_fact_personal",
      "pab_diff_personal",
      "pab_reason_personal",
      "tools_condition",
      "workplaces_condition",
      "improvement_measures",
      "involved_workers_count",
      "involved_workers_list",
      "not_involved_workers_count",
      "involved_engineers_count",
      "involved_engineers_list",
      "not_involved_engineers_count",
      "involvement_work",
    ];
    const data: Record<string, string> = {};
    ids.forEach((id) => {
      data[id] = getFieldValue(id);
    });
    data.timestamp = new Date().toISOString();
    return data;
  };

  const handleSave = () => {
    const report = buildReportObject();
    const department = report.department || userData.department || "Общее";
    try {
      const raw = localStorage.getItem("kbt_reports");
      const all = raw ? (JSON.parse(raw) as any) : {};
      if (!all["Отчеты по КБТ"]) all["Отчеты по КБТ"] = {};
      if (!all["Отчеты по КБТ"][department]) {
        all["Отчеты по КБТ"][department] = [];
      }
      all["Отчеты по КБТ"][department].push(report);
      localStorage.setItem("kbt_reports", JSON.stringify(all));
      localStorage.setItem(
        "kbt_user_data",
        JSON.stringify({ department, fullName: report.head_name || userData.fullName }),
      );
      toast({
        title: "Отчет сохранен",
        description: `Отчет сохранен в папку "${department}" в хранилище "Отчеты по КБТ" (на этом устройстве).`,
      });
    } catch {
      toast({ title: "Не удалось сохранить отчет" });
    }

    // Дополнительно сохраняем PDF-версию отчёта в общее хранилище (раздел «КБТ ОТЧЕТЫ»)
    // без открытия системного диалога сохранения файла на устройство.
    try {
      const doc = new jsPDF("p", "mm", "a4");
      doc.setFont("helvetica");
      let y = 15;
      doc.setFontSize(14);
      doc.text("Форма отчета на КБТ", 105, y, { align: "center" });
      y += 10;
      doc.setFontSize(10);
      const summaryLines = doc.splitTextToSize(
        [
          `Подразделение: ${report.department || department}`,
          `ФИО руководителя подразделения: ${report.head_name || ""}`,
          `Отчетный период: с ${report.period_from || ""} по ${report.period_to || ""}`,
        ].join("\n"),
        180,
      );
      doc.text(summaryLines, 15, y);
      const dataUrl = doc.output("datauristring");
      savePdfToStorageMutation.mutate({
        base64: dataUrl,
        department: report.department || department,
        name: "Отчет_КБТ",
      });
    } catch {
      // Ошибку тихо игнорируем, отдельный тост покажет сбой сохранения PDF при необходимости
    }
  };

  const handleExportExcel = () => {
    const report = buildReportObject();
    const data: any[][] = [];
    data.push(["АО «ГРК «Западная» Рудник «Бадран»"]);
    data.push(["Форма отчета на КБТ"]);
    data.push([]);
    data.push(["Основная информация"]);
    data.push(["Подразделение", report.department]);
    data.push([
      "ФИО руководителя подразделения",
      report.head_name,
    ]);
    data.push([
      "Отчетный период",
      `С ${report.period_from} ПО ${report.period_to}`,
    ]);
    data.push([]);
    data.push(["Медпункт"]);
    data.push(["Заболевших (чел.)", report.sick_count]);
    data.push([
      "Отстранено от работы (кол-во, диагноз)",
      report.suspended,
    ]);
    data.push(["Травм (кол-во, диагноз)", report.injuries]);
    data.push([
      "Микротравм (кол-во, диагноз)",
      report.micro_injuries,
    ]);
    data.push([
      "Больничный лист (кол-во, диагноз)",
      report.sick_leave,
    ]);
    data.push([
      "Допущено Н/С (кол-во, классификация Н/С, описание произошедшего)",
      report.accidents,
    ]);
    data.push([]);
    data.push([
      "Проверки, проведенные отделом ОТ и ПБ, руководством предприятия",
    ]);
    data.push(["Выдано АКТов (кол-во)", report.acts_count]);
    data.push([
      "ФИО и должность выдавшего предписание",
      report.inspector,
    ]);
    data.push([
      "Выдано нарушений (кол-во)",
      report.violations_count,
    ]);
    data.push([
      "Ответственный за устранение (ФИО, должность)",
      report.responsible_person,
    ]);
    data.push(["Устранено (кол-во)", report.fixed_count]);
    data.push([
      "В работе не вышел срок (кол-во)",
      report.in_progress_count,
    ]);
    data.push(["Просрочено (кол-во)", report.overdue_count]);
    data.push(["Причины не выполнения", report.reasons]);
    data.push([
      "Что предпринято к нарушителям?",
      report.actions_taken,
    ]);
    data.push([]);
    data.push([
      "Внутренние проверки, проведенные руководством подразделения",
    ]);
    data.push([
      "Проведено проверок (кол-во)",
      report.internal_checks_count,
    ]);
    data.push([
      "Выявлено нарушений (кол-во)",
      report.internal_violations_count,
    ]);
    data.push([
      "Ответственный за устранение (ФИО, должность)",
      report.internal_responsible,
    ]);
    data.push([
      "Устранено (кол-во)",
      report.internal_fixed_count,
    ]);
    data.push([
      "В работе не вышел срок (кол-во)",
      report.internal_in_progress_count,
    ]);
    data.push([
      "Просрочено (кол-во)",
      report.internal_overdue_count,
    ]);
    data.push(["Причины не выполнения", report.internal_reasons]);
    data.push([
      "Что предпринято к нарушителям?",
      report.internal_actions_taken,
    ]);
    data.push([]);
    data.push(["Проверки Госорганами"]);
    data.push(["Наименование Госоргана", report.gov_agency]);
    data.push(["Номер АКТа предписания", report.act_number]);
    data.push([
      "Выявлено нарушений (кол-во, сроки устранения)",
      report.gov_violations,
    ]);
    data.push([
      "Ответственный за устранение (ФИО, должность)",
      report.gov_responsible,
    ]);
    data.push(["Устранено (кол-во)", report.gov_fixed_count]);
    data.push([
      "В работе не вышел срок (кол-во)",
      report.gov_in_progress_count,
    ]);
    data.push(["Просрочено (кол-во)", report.gov_overdue_count]);
    data.push(["Причины не выполнения", report.gov_reasons]);
    data.push([]);
    data.push(["Поведенческий Аудит Безопасности (ПАБ)"]);
    data.push(["Выполнение показателей ПАБ по подразделению"]);
    data.push([
      "План по подразделению (кол-во)",
      report.pab_plan_department,
    ]);
    data.push([
      "Факт по подразделению (кол-во)",
      report.pab_fact_department,
    ]);
    data.push([
      "Разница (кол-во)",
      report.pab_diff_department,
    ]);
    data.push([
      "Причина не выполнения",
      report.pab_reason_department,
    ]);
    data.push(["Выполнение личных показателей ПАБ"]);
    data.push(["План (кол-во)", report.pab_plan_personal]);
    data.push(["Факт (кол-во)", report.pab_fact_personal]);
    data.push([
      "Разница (кол-во)",
      report.pab_diff_personal,
    ]);
    data.push([
      "Причина не выполнения",
      report.pab_reason_personal,
    ]);
    data.push([]);
    data.push(["Состояние инструмента, оборудования"]);
    data.push([
      "Состояние инструмента, оборудования",
      report.tools_condition,
    ]);
    data.push([
      "Состояние рабочих мест",
      report.workplaces_condition,
    ]);
    data.push([
      "Какие мероприятия были разработаны для улучшения условий и безопасности труда?",
      report.improvement_measures,
    ]);
    data.push([]);
    data.push([
      "Вовлечение рабочего персонала и ИТР в безопасность труда",
    ]);
    data.push(["Рабочий персонал"]);
    data.push([
      "Количество вовлеченных работников (чел)",
      report.involved_workers_count,
    ]);
    data.push([
      "ФИО, профессия вовлеченных работников",
      report.involved_workers_list,
    ]);
    data.push([
      "Количество не вовлеченных работников (чел)",
      report.not_involved_workers_count,
    ]);
    data.push(["ИТР"]);
    data.push([
      "Количество вовлеченных ИТР (чел)",
      report.involved_engineers_count,
    ]);
    data.push([
      "ФИО, должность вовлеченных ИТР",
      report.involved_engineers_list,
    ]);
    data.push([
      "Количество не вовлеченных ИТР (чел)",
      report.not_involved_engineers_count,
    ]);
    data.push([
      "Какая работа проводится в направлении вовлеченности?",
      report.involvement_work,
    ]);

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(data);
    (ws as any)["!cols"] = [
      { wch: 50 },
      { wch: 80 },
    ];
    XLSX.utils.book_append_sheet(wb, ws, "Отчет КБТ");
    const safeDept = (report.department || userData.department || "").replace(
      /[\\/:*?"<>|]+/g,
      " ",
    );
    const fileName = `Отчет_КБТ_${safeDept || "подразделение"}_${new Date()
      .toISOString()
      .slice(0, 10)}.xlsx`;
    XLSX.writeFile(wb, fileName);
  };

  const handleExportPdf = () => {
    const report = buildReportObject();
    const doc = new jsPDF("p", "mm", "a4");
    doc.setFont("helvetica");
    let y = 15;
    doc.setFontSize(16);
    doc.text("АО «ГРК «Западная» Рудник «Бадран»", 105, y, { align: "center" });
    y += 8;
    doc.setFontSize(14);
    doc.text("Форма отчета на КБТ", 105, y, { align: "center" });
    y += 15;
    doc.setFontSize(10);
    doc.setFont(undefined, "italic");
    const note =
      "Любое совещание всегда начинать с Контакта по безопасности. После отчета будьте готовы ответить на вопросы.";
    const noteLines = doc.splitTextToSize(note, 180);
    doc.text(noteLines, 15, y);
    y += noteLines.length * 5 + 10;
    const addSection = (title: string, lines: string[]) => {
      if (y > 250) {
        doc.addPage();
        y = 20;
      }
      doc.setFontSize(12);
      doc.setFont(undefined, "bold");
      doc.text(title, 15, y);
      y += 7;
      doc.setFontSize(10);
      doc.setFont(undefined, "normal");
      lines.forEach((line) => {
        if (y > 270) {
          doc.addPage();
          y = 20;
        }
        const wrapped = doc.splitTextToSize(line, 180);
        doc.text(wrapped, 15, y);
        y += wrapped.length * 5 + 2;
      });
      y += 5;
    };
    addSection("Основная информация", [
      `Подразделение: ${report.department}`,
      `ФИО руководителя подразделения: ${report.head_name}`,
      `Отчетный период: С ${report.period_from} ПО ${report.period_to}`,
    ]);
    addSection("Медпункт", [
      `Заболевших (чел.): ${report.sick_count}`,
      `Отстранено от работы: ${report.suspended}`,
      `Травм: ${report.injuries}`,
      `Микротравм: ${report.micro_injuries}`,
      `Больничный лист: ${report.sick_leave}`,
      `Допущено Н/С: ${report.accidents}`,
    ]);
    addSection(
      "Проверки, проведенные отделом ОТ и ПБ, руководством предприятия",
      [
        `Выдано АКТов (кол-во): ${report.acts_count}`,
        `ФИО и должность выдавшего предписание: ${report.inspector}`,
        `Выдано нарушений (кол-во): ${report.violations_count}`,
        `Ответственный за устранение: ${report.responsible_person}`,
        `Устранено (кол-во): ${report.fixed_count}`,
        `В работе не вышел срок (кол-во): ${report.in_progress_count}`,
        `Просрочено (кол-во): ${report.overdue_count}`,
        `Причины не выполнения: ${report.reasons}`,
        `Что предпринято к нарушителям: ${report.actions_taken}`,
      ],
    );
    addSection("Внутренние проверки, проведенные руководством подразделения", [
      `Проведено проверок (кол-во): ${report.internal_checks_count}`,
      `Выявлено нарушений (кол-во): ${report.internal_violations_count}`,
      `Ответственный за устранение: ${report.internal_responsible}`,
      `Устранено (кол-во): ${report.internal_fixed_count}`,
      `В работе не вышел срок (кол-во): ${report.internal_in_progress_count}`,
      `Просрочено (кол-во): ${report.internal_overdue_count}`,
      `Причины не выполнения: ${report.internal_reasons}`,
      `Что предпринято к нарушителям: ${report.internal_actions_taken}`,
    ]);
    addSection("Проверки Госорганами", [
      `Наименование Госоргана: ${report.gov_agency}`,
      `Номер АКТа предписания: ${report.act_number}`,
      `Выявлено нарушений (кол-во, сроки устранения): ${report.gov_violations}`,
      `Ответственный за устранение: ${report.gov_responsible}`,
      `Устранено (кол-во): ${report.gov_fixed_count}`,
      `В работе не вышел срок (кол-во): ${report.gov_in_progress_count}`,
      `Просрочено (кол-во): ${report.gov_overdue_count}`,
      `Причины не выполнения: ${report.gov_reasons}`,
    ]);
    addSection("Поведенческий Аудит Безопасности (ПАБ)", [
      "Выполнение показателей ПАБ по подразделению:",
      `План по подразделению (кол-во): ${report.pab_plan_department}`,
      `Факт по подразделению (кол-во): ${report.pab_fact_department}`,
      `Разница (кол-во): ${report.pab_diff_department}`,
      `Причина не выполнения: ${report.pab_reason_department}`,
      "Выполнение личных показателей ПАБ:",
      `План (кол-во): ${report.pab_plan_personal}`,
      `Факт (кол-во): ${report.pab_fact_personal}`,
      `Разница (кол-во): ${report.pab_diff_personal}`,
      `Причина не выполнения: ${report.pab_reason_personal}`,
    ]);
    addSection("Состояние инструмента, оборудования", [
      `Состояние инструмента, оборудования: ${report.tools_condition}`,
      `Состояние рабочих мест: ${report.workplaces_condition}`,
      `Какие мероприятия были разработаны для улучшения условий и безопасности труда?: ${report.improvement_measures}`,
    ]);
    addSection("Вовлечение рабочего персонала и ИТР в безопасность труда", [
      "Рабочий персонал:",
      `Количество вовлеченных работников (чел): ${report.involved_workers_count}`,
      `ФИО, профессия вовлеченных работников: ${report.involved_workers_list}`,
      `Количество не вовлеченных работников (чел): ${report.not_involved_workers_count}`,
      "ИТР:",
      `Количество вовлеченных ИТР (чел): ${report.involved_engineers_count}`,
      `ФИО, должность вовлеченных ИТР: ${report.involved_engineers_list}`,
      `Количество не вовлеченных ИТР (чел): ${report.not_involved_engineers_count}`,
      `Какая работа проводится в направлении вовлеченности?: ${report.involvement_work}`,
    ]);
    const safeDept = (report.department || userData.department || "").replace(
      /[\\/:*?"<>|]+/g,
      " ",
    );
    const fileName = `Отчет_КБТ_${safeDept || "подразделение"}_${new Date()
      .toISOString()
      .slice(0, 10)}.pdf`;

    try {
      const dataUrl = doc.output("datauristring");
      savePdfToStorageMutation.mutate({
        base64: dataUrl,
        department: report.department || userData.department || "",
        name: "Отчет_КБТ",
      });
    } catch {
      // ignore, toast will be shown from mutation onError if needed
    }

    doc.save(fileName);
  };

  return (
    <Card className="card-elevated h-full">
      <CardHeader className="space-y-2">
        <CardTitle>Форма отчета на КБТ</CardTitle>
        <div className="text-sm text-muted-foreground border-l-4 border-yellow-400 bg-yellow-50 dark:bg-yellow-900/20 px-3 py-2">
          Любое совещание всегда начинать с Контакта по безопасности. После
          отчета будьте готовы ответить на вопросы.
        </div>
      </CardHeader>
      <CardContent className="space-y-4">
        <form className="space-y-4">
          <section className="border rounded p-3 space-y-3">
            <div className="font-semibold bg-muted px-3 py-2 rounded">
              Основная информация
            </div>
            <div className="grid md:grid-cols-[1.2fr,2fr] gap-3 items-center">
              <div>Подразделение</div>
              <input
                id="department"
                name="department"
                className="w-full border px-2 py-1 rounded bg-background"
                value={userData.department}
                onChange={(e) =>
                  setUserData((prev) => ({
                    ...prev,
                    department: e.target.value,
                  }))
                }
              />
              <div>ФИО руководителя подразделения</div>
              <input
                id="head_name"
                name="head_name"
                className="w-full border px-2 py-1 rounded bg-background"
                value={userData.fullName}
                onChange={(e) =>
                  setUserData((prev) => ({
                    ...prev,
                    fullName: e.target.value,
                  }))
                }
              />
              <div>Отчетный период</div>
              <div className="flex flex-col sm:flex-row gap-2">
                <input
                  id="period_from"
                  name="period_from"
                  type="date"
                  className="border px-2 py-1 rounded w-full"
                  defaultValue={toInputDate(firstDay)}
                />
                <span className="self-center text-sm text-muted-foreground">
                  ПО
                </span>
                <input
                  id="period_to"
                  name="period_to"
                  type="date"
                  className="border px-2 py-1 rounded w-full"
                  defaultValue={toInputDate(lastDay)}
                />
              </div>
            </div>
          </section>

          <section className="border rounded p-3 space-y-3">
            <div className="font-semibold bg-muted px-3 py-2 rounded">
              Медпункт
            </div>
            <div className="overflow-x-auto">
              <table className="w-full text-sm border-separate border-spacing-y-1">
                <tbody>
                  <tr>
                    <td className="align-middle pr-3 py-1 w-1/2">
                      Заболевших (чел.)
                    </td>
                    <td className="py-1">
                      <input
                        id="sick_count"
                        name="sick_count"
                        type="number"
                        className="border px-2 py-1 rounded w-full"
                      />
                    </td>
                  </tr>
                  <tr>
                    <td className="align-top pr-3 py-1 w-1/2">
                      Отстранено от работы (кол-во, диагноз)
                    </td>
                    <td className="py-1">
                      <textarea
                        id="suspended"
                        name="suspended"
                        rows={2}
                        className="border px-2 py-1 rounded w-full resize-y"
                      />
                    </td>
                  </tr>
                  <tr>
                    <td className="align-top pr-3 py-1 w-1/2">
                      Травм (кол-во, диагноз)
                    </td>
                    <td className="py-1">
                      <textarea
                        id="injuries"
                        name="injuries"
                        rows={2}
                        className="border px-2 py-1 rounded w-full resize-y"
                      />
                    </td>
                  </tr>
                  <tr>
                    <td className="align-top pr-3 py-1 w-1/2">
                      Микротравм (кол-во, диагноз)
                    </td>
                    <td className="py-1">
                      <textarea
                        id="micro_injuries"
                        name="micro_injuries"
                        rows={2}
                        className="border px-2 py-1 rounded w-full resize-y"
                      />
                    </td>
                  </tr>
                  <tr>
                    <td className="align-top pr-3 py-1 w-1/2">
                      Больничный лист (кол-во, диагноз)
                    </td>
                    <td className="py-1">
                      <textarea
                        id="sick_leave"
                        name="sick_leave"
                        rows={2}
                        className="border px-2 py-1 rounded w-full resize-y"
                      />
                    </td>
                  </tr>
                  <tr>
                    <td className="align-top pr-3 py-1 w-1/2">
                      Допущено Н/С (кол-во, классификация Н/С, описание произошедшего)
                    </td>
                    <td className="py-1">
                      <textarea
                        id="accidents"
                        name="accidents"
                        rows={3}
                        className="border px-2 py-1 rounded w-full resize-y"
                      />
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>

          <section className="border rounded p-3 space-y-3">
            <div className="font-semibold bg-muted px-3 py-2 rounded">
              Проверки, проведенные отделом ОТ и ПБ, руководством предприятия
            </div>
            <div className="grid gap-2">
              <div className="grid md:grid-cols-[1.9fr,2fr] gap-2 items-center">
                <div>Выдано АКТов (кол-во)</div>
                <input
                  id="acts_count"
                  name="acts_count"
                  type="number"
                  className="border px-2 py-1 rounded w-full"
                />
              </div>
              <div className="grid md:grid-cols-[1.9fr,2fr] gap-2 items-start">
                <div>ФИО и должность выдавшего предписание</div>
                <textarea
                  id="inspector"
                  name="inspector"
                  rows={2}
                  className="border px-2 py-1 rounded w-full resize-y"
                />
              </div>
              <div className="grid md:grid-cols-[1.9fr,2fr] gap-2 items-center">
                <div>Выдано нарушений (кол-во)</div>
                <input
                  id="violations_count"
                  name="violations_count"
                  type="number"
                  className="border px-2 py-1 rounded w-full"
                />
              </div>
              <div className="grid md:grid-cols-[1.9fr,2fr] gap-2 items-start">
                <div>Ответственный за устранение (ФИО, должность)</div>
                <textarea
                  id="responsible_person"
                  name="responsible_person"
                  rows={2}
                  className="border px-2 py-1 rounded w-full resize-y"
                />
              </div>
              <div className="grid md:grid-cols-[1.9fr,2fr] gap-2 items-center">
                <div>Устранено (кол-во)</div>
                <input
                  id="fixed_count"
                  name="fixed_count"
                  type="number"
                  className="border px-2 py-1 rounded w-full"
                />
              </div>
              <div className="grid md:grid-cols-[1.9fr,2fr] gap-2 items-center">
                <div>В работе не вышел срок (кол-во)</div>
                <input
                  id="in_progress_count"
                  name="in_progress_count"
                  type="number"
                  className="border px-2 py-1 rounded w-full"
                />
              </div>
              <div className="grid md:grid-cols-[1.9fr,2fr] gap-2 items-center">
                <div>Просрочено (кол-во)</div>
                <input
                  id="overdue_count"
                  name="overdue_count"
                  type="number"
                  className="border px-2 py-1 rounded w-full"
                />
              </div>
              <div className="grid md:grid-cols-[1.9fr,2fr] gap-2 items-start">
                <div>Причины не выполнения</div>
                <textarea
                  id="reasons"
                  name="reasons"
                  rows={3}
                  className="border px-2 py-1 rounded w-full resize-y"
                />
              </div>
              <div className="grid md:grid-cols-[1.9fr,2fr] gap-2 items-start">
                <div>Что предпринято к нарушителям?</div>
                <textarea
                  id="actions_taken"
                  name="actions_taken"
                  rows={3}
                  className="border px-2 py-1 rounded w-full resize-y"
                />
              </div>
            </div>
          </section>

          <section className="border rounded p-3 space-y-3">
            <div className="font-semibold bg-muted px-3 py-2 rounded">
              Внутренние проверки, проведенные руководством подразделения
            </div>
            <div className="grid gap-2">
              <div className="grid md:grid-cols-[2fr,2fr] gap-2 items-center">
                <div>Проведено проверок (кол-во)</div>
                <input
                  id="internal_checks_count"
                  name="internal_checks_count"
                  type="number"
                  className="border px-2 py-1 rounded w-full"
                />
              </div>
              <div className="grid md:grid-cols-[2fr,2fr] gap-2 items-center">
                <div>Выявлено нарушений (кол-во)</div>
                <input
                  id="internal_violations_count"
                  name="internal_violations_count"
                  type="number"
                  className="border px-2 py-1 rounded w-full"
                />
              </div>
              <div className="grid md:grid-cols-[2fr,2fr] gap-2 items-start">
                <div>Ответственный за устранение (ФИО, должность)</div>
                <textarea
                  id="internal_responsible"
                  name="internal_responsible"
                  rows={2}
                  className="border px-2 py-1 rounded w-full resize-y"
                />
              </div>
              <div className="grid md:grid-cols-[2fr,2fr] gap-2 items-center">
                <div>Устранено (кол-во)</div>
                <input
                  id="internal_fixed_count"
                  name="internal_fixed_count"
                  type="number"
                  className="border px-2 py-1 rounded w-full"
                />
              </div>
              <div className="grid md:grid-cols-[2fr,2fr] gap-2 items-center">
                <div>В работе не вышел срок (кол-во)</div>
                <input
                  id="internal_in_progress_count"
                  name="internal_in_progress_count"
                  type="number"
                  className="border px-2 py-1 rounded w-full"
                />
              </div>
              <div className="grid md:grid-cols-[2fr,2fr] gap-2 items-center">
                <div>Просрочено (кол-во)</div>
                <input
                  id="internal_overdue_count"
                  name="internal_overdue_count"
                  type="number"
                  className="border px-2 py-1 rounded w-full"
                />
              </div>
              <div className="grid md:grid-cols-[2fr,2fr] gap-2 items-start">
                <div>Причины не выполнения</div>
                <textarea
                  id="internal_reasons"
                  name="internal_reasons"
                  rows={3}
                  className="border px-2 py-1 rounded w-full resize-y"
                />
              </div>
              <div className="grid md:grid-cols-[2fr,2fr] gap-2 items-start">
                <div>Что предпринято к нарушителям?</div>
                <textarea
                  id="internal_actions_taken"
                  name="internal_actions_taken"
                  rows={3}
                  className="border px-2 py-1 rounded w-full resize-y"
                />
              </div>
            </div>
          </section>

          <section className="border rounded p-3 space-y-3">
            <div className="font-semibold bg-muted px-3 py-2 rounded">
              Проверки Госорганами
            </div>
            <div className="grid gap-2">
              <div className="grid md:grid-cols-[2fr,2fr] gap-2 items-center">
                <div>Наименование Госоргана</div>
                <input
                  id="gov_agency"
                  name="gov_agency"
                  className="border px-2 py-1 rounded w-full"
                />
              </div>
              <div className="grid md:grid-cols-[2fr,2fr] gap-2 items-center">
                <div>Номер АКТа предписания</div>
                <input
                  id="act_number"
                  name="act_number"
                  className="border px-2 py-1 rounded w-full"
                />
              </div>
              <div className="grid md:grid-cols-[2fr,2fr] gap-2 items-start">
                <div>Выявлено нарушений (кол-во, сроки устранения)</div>
                <textarea
                  id="gov_violations"
                  name="gov_violations"
                  rows={3}
                  className="border px-2 py-1 rounded w-full resize-y"
                />
              </div>
              <div className="grid md:grid-cols-[2fr,2fr] gap-2 items-start">
                <div>Ответственный за устранение (ФИО, должность)</div>
                <textarea
                  id="gov_responsible"
                  name="gov_responsible"
                  rows={2}
                  className="border px-2 py-1 rounded w-full resize-y"
                />
              </div>
              <div className="grid md:grid-cols-[2fr,2fr] gap-2 items-center">
                <div>Устранено (кол-во)</div>
                <input
                  id="gov_fixed_count"
                  name="gov_fixed_count"
                  type="number"
                  className="border px-2 py-1 rounded w-full"
                />
              </div>
              <div className="grid md:grid-cols-[2fr,2fr] gap-2 items-center">
                <div>В работе не вышел срок (кол-во)</div>
                <input
                  id="gov_in_progress_count"
                  name="gov_in_progress_count"
                  type="number"
                  className="border px-2 py-1 rounded w-full"
                />
              </div>
              <div className="grid md:grid-cols-[2fr,2fr] gap-2 items-center">
                <div>Просрочено (кол-во)</div>
                <input
                  id="gov_overdue_count"
                  name="gov_overdue_count"
                  type="number"
                  className="border px-2 py-1 rounded w-full"
                />
              </div>
              <div className="grid md:grid-cols-[2fr,2fr] gap-2 items-start">
                <div>Причины не выполнения</div>
                <textarea
                  id="gov_reasons"
                  name="gov_reasons"
                  rows={3}
                  className="border px-2 py-1 rounded w-full resize-y"
                />
              </div>
            </div>
          </section>

          <section className="border rounded p-3 space-y-3">
            <div className="font-semibold bg-muted px-3 py-2 rounded">
              Поведенческий Аудит Безопасности (ПАБ)
            </div>
            <div className="space-y-3">
              <div className="font-medium">
                Выполнение показателей ПАБ по подразделению
              </div>
              <div className="grid md:grid-cols-[2fr,2fr] gap-2 items-center">
                <div>План по подразделению (кол-во)</div>
                <input
                  id="pab_plan_department"
                  name="pab_plan_department"
                  type="number"
                  className="border px-2 py-1 rounded w-full"
                  onChange={recomputePabDiffs}
                />
              </div>
              <div className="grid md:grid-cols-[2fr,2fr] gap-2 items-center">
                <div>Факт по подразделению (кол-во)</div>
                <input
                  id="pab_fact_department"
                  name="pab_fact_department"
                  type="number"
                  className="border px-2 py-1 rounded w-full"
                  onChange={recomputePabDiffs}
                />
              </div>
              <div className="grid md:grid-cols-[2fr,2fr] gap-2 items-center">
                <div>Разница (кол-во)</div>
                <input
                  id="pab_diff_department"
                  name="pab_diff_department"
                  readOnly
                  className="border px-2 py-1 rounded w-full bg-muted"
                />
              </div>
              <div className="grid md:grid-cols-[2fr,2fr] gap-2 items-start">
                <div>Причина не выполнения</div>
                <textarea
                  id="pab_reason_department"
                  name="pab_reason_department"
                  rows={2}
                  className="border px-2 py-1 rounded w-full resize-y"
                />
              </div>
              <div className="font-medium">Выполнение личных показателей ПАБ</div>
              <div className="grid md:grid-cols-[2fr,2fr] gap-2 items-center">
                <div>План (кол-во)</div>
                <input
                  id="pab_plan_personal"
                  name="pab_plan_personal"
                  type="number"
                  className="border px-2 py-1 rounded w-full"
                  onChange={recomputePabDiffs}
                />
              </div>
              <div className="grid md:grid-cols-[2fr,2fr] gap-2 items-center">
                <div>Факт (кол-во)</div>
                <input
                  id="pab_fact_personal"
                  name="pab_fact_personal"
                  type="number"
                  className="border px-2 py-1 rounded w-full"
                  onChange={recomputePabDiffs}
                />
              </div>
              <div className="grid md:grid-cols-[2fr,2fr] gap-2 items-center">
                <div>Разница (кол-во)</div>
                <input
                  id="pab_diff_personal"
                  name="pab_diff_personal"
                  readOnly
                  className="border px-2 py-1 rounded w-full bg-muted"
                />
              </div>
              <div className="grid md:grid-cols-[2fr,2fr] gap-2 items-start">
                <div>Причина не выполнения</div>
                <textarea
                  id="pab_reason_personal"
                  name="pab_reason_personal"
                  rows={2}
                  className="border px-2 py-1 rounded w-full resize-y"
                />
              </div>
            </div>
          </section>

          <section className="border rounded p-3 space-y-3">
            <div className="font-semibold bg-muted px-3 py-2 rounded">
              Состояние инструмента, оборудования
            </div>
            <div className="grid gap-2">
              <div className="grid md:grid-cols-[2fr,2fr] gap-2 items-start">
                <div>Состояние инструмента, оборудования</div>
                <textarea
                  id="tools_condition"
                  name="tools_condition"
                  rows={3}
                  className="border px-2 py-1 rounded w-full resize-y"
                />
              </div>
              <div className="grid md:grid-cols-[2fr,2fr] gap-2 items-start">
                <div>Состояние рабочих мест</div>
                <textarea
                  id="workplaces_condition"
                  name="workplaces_condition"
                  rows={3}
                  className="border px-2 py-1 rounded w-full resize-y"
                />
              </div>
              <div className="grid md:grid-cols-[2fr,2fr] gap-2 items-start">
                <div>
                  Какие мероприятия были разработаны для улучшения условий и
                  безопасности труда?
                </div>
                <textarea
                  id="improvement_measures"
                  name="improvement_measures"
                  rows={4}
                  className="border px-2 py-1 rounded w-full resize-y"
                />
              </div>
            </div>
          </section>

          <section className="border rounded p-3 space-y-3">
            <div className="font-semibold bg-muted px-3 py-2 rounded">
              Вовлечение рабочего персонала и ИТР в безопасность труда
            </div>
            <div className="space-y-3">
              <div className="font-medium">Рабочий персонал</div>
              <div className="grid md:grid-cols-[2fr,2fr] gap-2 items-center">
                <div>Количество вовлеченных работников (чел)</div>
                <input
                  id="involved_workers_count"
                  name="involved_workers_count"
                  type="number"
                  className="border px-2 py-1 rounded w-full"
                />
              </div>
              <div className="grid md:grid-cols-[2fr,2fr] gap-2 items-start">
                <div>ФИО, профессия вовлеченных работников</div>
                <textarea
                  id="involved_workers_list"
                  name="involved_workers_list"
                  rows={3}
                  className="border px-2 py-1 rounded w-full resize-y"
                />
              </div>
              <div className="grid md:grid-cols-[2fr,2fr] gap-2 items-center">
                <div>Количество не вовлеченных работников (чел)</div>
                <input
                  id="not_involved_workers_count"
                  name="not_involved_workers_count"
                  type="number"
                  className="border px-2 py-1 rounded w-full"
                />
              </div>
              <div className="font-medium">ИТР</div>
              <div className="grid md:grid-cols-[2fr,2fr] gap-2 items-center">
                <div>Количество вовлеченных ИТР (чел)</div>
                <input
                  id="involved_engineers_count"
                  name="involved_engineers_count"
                  type="number"
                  className="border px-2 py-1 rounded w-full"
                />
              </div>
              <div className="grid md:grid-cols-[2fr,2fr] gap-2 items-start">
                <div>ФИО, должность вовлеченных ИТР</div>
                <textarea
                  id="involved_engineers_list"
                  name="involved_engineers_list"
                  rows={3}
                  className="border px-2 py-1 rounded w-full resize-y"
                />
              </div>
              <div className="grid md:grid-cols-[2fr,2fr] gap-2 items-center">
                <div>Количество не вовлеченных ИТР (чел)</div>
                <input
                  id="not_involved_engineers_count"
                  name="not_involved_engineers_count"
                  type="number"
                  className="border px-2 py-1 rounded w-full"
                />
              </div>
              <div className="grid md:grid-cols-[2fr,2fr] gap-2 items-start">
                <div>Какая работа проводится в направлении вовлеченности?</div>
                <textarea
                  id="involvement_work"
                  name="involvement_work"
                  rows={4}
                  className="border px-2 py-1 rounded w-full resize-y"
                />
              </div>
            </div>
          </section>
        </form>
      </CardContent>
      <CardFooter className="flex flex-wrap gap-2 justify-center">
        <Button variant="ghost" onClick={() => navigate("/kbt")}>
          Назад
        </Button>
        <Button onClick={handleSave}>Сохранить отчет</Button>
        <Button variant="secondary" onClick={handleExportExcel}>
          Скачать в Excel
        </Button>
        <Button variant="destructive" onClick={handleExportPdf}>
          Скачать в PDF
        </Button>
        <Button
          variant="outline"
          onClick={() => {
            try {
              window.print();
            } catch {
              /* ignore */
            }
          }}
        >
          Распечатать
        </Button>
      </CardFooter>
    </Card>
  );
}

function UdReportScreen() {
  useAuth({ required: true });
  const { data: me, isInitialLoading } = useQuery<Profile>(["me"], () =>
    apiClient.getMyProfile(),
  );
  const navigate = useNavigate();
  const { toast } = useToast();
  const queryClient = useQueryClient();

  const { data: report, isInitialLoading: loading } = useQuery(
    ["ud-report"],
    () => apiClient.getUdReport(),
  );

  const [title, setTitle] = useState<string>("");
  const [colA, setColA] = useState<string>("");
  const [colB, setColB] = useState<string>("");
  const [rows, setRows] = useState<
    Array<
      | {
          __type: "row";
          id?: string;
          label: string;
          valueA?: string | null;
          valueB?: string | null;
          order: number;
          section?: string | null;
        }
      | { __type: "section"; label: string }
    >
  >([]);

  useEffect(() => {
    if (report) {
      setTitle((report as any).title || "ОТ и ПБ");
      setColA((report as any).columnA || "");
      setColB((report as any).columnB || "");
      const rws = ((report as any).rows || []) as Array<any>;
      const ui: Array<
        | { __type: "row"; id?: string; label: string; valueA?: string | null; valueB?: string | null; order: number; section?: string | null }
        | { __type: "section"; label: string }
      > = [];
      let lastSection: string | null = null;
      rws.forEach((r: any, idx: number) => {
        const s = (r.section ?? null) as string | null;
        if (s && s !== lastSection) {
          ui.push({ __type: "section", label: s });
          lastSection = s;
        }
        if (!s) {
          lastSection = null;
        }
        ui.push({
          __type: "row",
          id: r.id,
          label: r.label || "",
          valueA: r.valueA ?? "",
          valueB: r.valueB ?? "",
          order: typeof r.order === "number" ? r.order : idx,
          section: s,
        });
      });

      // Автоподстановка значений из «Безопасные дни» при открытии страницы
      if (safeStats) {
        const targetColName = (txt: string) => (txt || "").trim().toLowerCase();
        const colAName = targetColName((report as any).columnA || "");
        const colBName = targetColName((report as any).columnB || "");
        const preferCol: "valueA" | "valueB" =
          colAName === "значение" ? "valueA" : colBName === "значение" ? "valueB" : "valueA";

        const monthVal = typeof (safeStats as any).monthSafeDays === "number"
          ? String((safeStats as any).monthSafeDays)
          : "-";
        const sinceLastVal = typeof (safeStats as any).sinceLastAccidentSafeDays === "number"
          ? String((safeStats as any).sinceLastAccidentSafeDays)
          : "-";

        const norm = (s: string) => (s || "").toLowerCase();

        for (let i = 0; i < ui.length; i++) {
          const it = ui[i] as any;
          if (it.__type !== "row") continue;
          const label = norm(it.label);
          if (label.includes("со дня последнего н/с")) {
            ui[i] = { ...it, [preferCol]: sinceLastVal };
          } else if (
            label.includes("отработанных безопасных дней в месяце") ||
            label.includes("безопасных дней в месяце")
          ) {
            ui[i] = { ...it, [preferCol]: monthVal };
          }
        }
      }

      setRows(ui);
    }
  }, [report, safeStats]);

  const addRow = () => {
    setRows((prev) => {
      const lastSection = [...prev]
        .reverse()
        .find((it) => (it as any).__type === "section") as any;
      const nextOrder = prev.filter((it) => (it as any).__type === "row").length;
      return [
        ...prev,
        {
          __type: "row" as const,
          label: "Новая строка",
          valueA: "",
          valueB: "",
          order: nextOrder,
          section: lastSection?.label ?? null,
        },
      ];
    });
  };
  const addSection = () => {
    setRows((prev) => [...prev, { __type: "section" as const, label: "Новая тема" }]);
  };
  const removeRow = (idx: number) => {
    setRows((prev) => prev.filter((_, i) => i !== idx));
  };
  const removeSection = (idx: number) => {
    setRows((prev) => {
      const a = [...prev];
      a.splice(idx, 1);
      for (let i = idx; i < a.length && (a[i] as any).__type !== "section"; i++) {
        const it = a[i] as any;
        if (it.__type === "row") a[i] = { ...it, section: null } as any;
      }
      return a;
    });
  };
  const moveRow = (idx: number, dir: -1 | 1) => {
    setRows((prev) => {
      if ((prev[idx] as any).__type !== "row") return prev;
      const a = [...prev];
      let j = idx + dir;
      while (j >= 0 && j < a.length && (a[j] as any).__type !== "row") {
        j += dir;
      }
      if (j < 0 || j >= a.length || (a[j] as any).__type !== "row") return prev;
      const t = a[idx];
      a[idx] = a[j]!;
      a[j] = t!;
      return a;
    });
  };

  const save = useMutation(apiClient.upsertUdReport, {
    onSuccess: async () => {
      toast({ title: "Сохранено" });
      await queryClient.invalidateQueries({ queryKey: ["ud-report"] });
    },
    onError: () => toast({ title: "Не удалось сохранить" }),
  });

  // Экспорт в Excel
  const exportUdExcel = useMutation(apiClient.exportUdReportExcel, {
    onSuccess: (res: { url: string }) => {
      if (!res?.url) return;
      const sanitize = (s: string) =>
        (s || "")
          .replace(/[\\/:*?"<>|]+/g, " ")
          .replace(/\s+/g, " ")
          .trim();
      const dateStr = new Date().toISOString().slice(0, 10);
      const base = sanitize(title || "Отчет для УД");
      const a = document.createElement("a");
      a.href = res.url;
      a.download = `${base || "Отчет для УД"}_${dateStr}.xlsx`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    },
    onError: () => toast({ title: "Не удалось выгрузить Excel" }),
  });

  if (isInitialLoading) {
    return (
      <div className="max-w-5xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Загрузка…</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">Проверяем доступ…</div>
          </CardContent>
        </Card>
      </div>
    );
  }
  if (!me?.isAdmin) {
    return (
      <div className="max-w-4xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Доступ ограничен</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Раздел доступен только администраторам.
            </div>
          </CardContent>
          <CardFooter>
            <Button variant="secondary" onClick={() => navigate("/admin")}>
              К админ‑панели
            </Button>
          </CardFooter>
        </Card>
      </div>
    );
  }

  return (
    <div className="w-full max-w-[120rem] mx-auto px-4 sm:px-6 space-y-4">
      <Card className="card-elevated h-full">
        <CardHeader className="space-y-2">
          {me?.isAdmin && (
            <div className="text-xs text-muted-foreground">
              Вы видите все инструменты настройки таблицы. Обычным пользователям
              доступна только кнопка «Отправить».
            </div>
          )}
          <CardTitle>Отчет для УД</CardTitle>
          <div className="grid md:grid-cols-3 gap-3">
            <div className="grid gap-1">
              <Label>Заголовок</Label>
              <Input value={title} onChange={(e) => setTitle(e.target.value)} />
            </div>
            <div className="grid gap-1">
              <Label>Колонка A (левый период)</Label>
              <Input value={colA} onChange={(e) => setColA(e.target.value)} />
            </div>
            <div className="grid gap-1">
              <Label>Колонка B (правый период)</Label>
              <Input value={colB} onChange={(e) => setColB(e.target.value)} />
            </div>
          </div>
          <div className="text-xs text-muted-foreground">
            Таблица редактируемая: изменяйте значения и нажмите «Сохранить».
            Начальные данные взяты из вашего сообщения.
          </div>
        </CardHeader>
        <CardContent className="space-y-3">
          {loading ? (
            <div className="text-sm text-muted-foreground">
              Загрузка отчета…
            </div>
          ) : (
            <div className="border rounded-md overflow-x-auto">
              <Table>
                <TableHeader>
                  <TableRow>
                    <TableHead className="min-w-[360px]">ОТ и ПБ</TableHead>
                    <TableHead className="min-w-[180px]">
                      {colA || "Колонка A"}
                    </TableHead>
                    <TableHead className="min-w-[180px]">
                      {colB || "Колонка B"}
                    </TableHead>
                    <TableHead className="w-[160px]">Действия</TableHead>
                  </TableRow>
                </TableHeader>
                <TableBody>
                  {rows.length === 0 && (
                    <TableRow>
                      <TableCell
                        colSpan={4}
                        className="text-sm text-muted-foreground"
                      >
                        Нет строк. Нажмите «Добавить строку».
                      </TableCell>
                    </TableRow>
                  )}
                  {rows.map((r, idx) => {
                    if ((r as any).__type === "section") {
                      const section = r as { __type: "section"; label: string };
                      return (
                        <TableRow
                          key={`section-${idx}`}
                          className="bg-primary text-primary-foreground hover:bg-primary"
                        >
                          <TableCell colSpan={4} className="align-top">
                            <div className="flex items-center gap-2">
                              <Input
                                className="bg-primary text-primary-foreground placeholder:text-primary-foreground/80"
                                value={section.label}
                                onChange={(e) =>
                                  setRows((prev) => {
                                    const a = [...prev];
                                    a[idx] = { __type: "section", label: e.target.value } as any;
                                    for (
                                      let j = idx + 1;
                                      j < a.length && (a[j] as any).__type !== "section";
                                      j++
                                    ) {
                                      const it = a[j] as any;
                                      if (it.__type === "row") {
                                        a[j] = { ...it, section: e.target.value } as any;
                                      }
                                    }
                                    return a;
                                  })
                                }
                                placeholder="Название темы"
                              />
                              <Button size="sm" variant="destructive" onClick={() => removeSection(idx)}>
                                Удалить тему
                              </Button>
                            </div>
                          </TableCell>
                        </TableRow>
                      );
                    }
                    const row = r as {
                      __type: "row";
                      id?: string;
                      label: string;
                      valueA?: string | null;
                      valueB?: string | null;
                      section?: string | null;
                    };
                    return (
                      <TableRow key={(row.id || "new") + idx}>
                        <TableCell className="align-top">
                          <div className="grid gap-1">
                            {row.section && (
                              <div className="text-[11px] text-muted-foreground uppercase">
                                {row.section}
                              </div>
                            )}
                            <Input
                              value={row.label}
                              onChange={(e) =>
                                setRows((prev) => {
                                  const a = [...prev];
                                  a[idx] = { ...(a[idx] as any), label: e.target.value } as any;
                                  return a;
                                })
                              }
                            />
                          </div>
                        </TableCell>
                        <TableCell className="align-top">
                          <Input
                            value={row.valueA ?? ""}
                            onChange={(e) =>
                              setRows((prev) => {
                                const a = [...prev];
                                a[idx] = { ...(a[idx] as any), valueA: e.target.value } as any;
                                return a;
                              })
                            }
                          />
                        </TableCell>
                        <TableCell className="align-top">
                          <Input
                            value={row.valueB ?? ""}
                            onChange={(e) =>
                              setRows((prev) => {
                                const a = [...prev];
                                a[idx] = { ...(a[idx] as any), valueB: e.target.value } as any;
                                return a;
                              })
                            }
                          />
                        </TableCell>
                        <TableCell className="align-top">
                          <div className="flex gap-2">
                            <Button
                              size="sm"
                              variant="secondary"
                              onClick={() => moveRow(idx, -1)}
                              disabled={idx === 0}
                            >
                              ↑
                            </Button>
                            <Button
                              size="sm"
                              variant="secondary"
                              onClick={() => moveRow(idx, 1)}
                              disabled={idx === rows.length - 1}
                            >
                              ↓
                            </Button>
                            <Button
                              size="sm"
                              variant="destructive"
                              onClick={() => removeRow(idx)}
                            >
                              Удалить
                            </Button>
                          </div>
                        </TableCell>
                      </TableRow>
                    );
                  })}
                </TableBody>
              </Table>
            </div>
          )}
        </CardContent>
        <CardFooter className="flex flex-wrap gap-2">
          <Button variant="secondary" onClick={addSection}>
            Добавить тему
          </Button>
          <Button variant="secondary" onClick={addRow}>
            Добавить строку
          </Button>
          <Button
            className="btn-3d"
            disabled={save.isLoading}
            onClick={() => {
              let currentSection: string | null = null;
              const normalized = rows
                .flatMap((it) => {
                  if ((it as any).__type === "section") {
                    currentSection = (it as any).label as string;
                    return [] as any[];
                  }
                  const r = it as any;
                  return [
                    {
                      id: r.id,
                      label: r.label,
                      valueA: r.valueA ?? null,
                      valueB: r.valueB ?? null,
                      order: 0,
                      section: currentSection,
                    },
                  ];
                })
                .map((r, i) => ({ ...r, order: i }));
              save.mutate({
                title,
                columnA: colA,
                columnB: colB,
                rows: normalized,
              });
            }}
          >
            {save.isLoading ? "Сохраняем…" : "Сохранить"}
          </Button>
          <Button
            variant="secondary"
            disabled={exportUdExcel.isLoading}
            onClick={() => exportUdExcel.mutate()}
          >
            {exportUdExcel.isLoading ? "Готовим…" : "Скачать в Excel"}
          </Button>
          <Button variant="ghost" onClick={() => navigate("/admin")}>
            К админ‑панели
          </Button>
        </CardFooter>
      </Card>
    </div>
  );
}

// Heuristics to detect missing or suspicious profile data
function UdReportScreenV2() {
  const printRef = useRef<HTMLDivElement | null>(null);
  useAuth({ required: true });
  const { toast } = useToast();

  const { data: me } = useQuery<Profile>(["me"], () => apiClient.getMyProfile());
  const queryClient = useQueryClient();
  const isAdmin = !!me?.isAdmin;

  // Период по умолчанию: с первого дня текущего месяца по сегодня
  const _today = new Date();
  const _firstOfMonth = new Date(_today.getFullYear(), _today.getMonth(), 1);
  const _toIso = (d: Date) => new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0, 10);
  const [startDate, setStartDate] = useState<string>(_toIso(_firstOfMonth));
  const [endDate, setEndDate] = useState<string>(_toIso(_today));

  const formatDateRu = (isoDate: string) => {
    const d = new Date(isoDate);
    const dd = String(d.getDate()).padStart(2, "0");
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const yyyy = d.getFullYear();
    return `${dd}.${mm}.${yyyy}`;
  };

  type RowUI =
    | { __type: "row"; id?: string; label: string; valueA?: string | null; valueB?: string | null; section?: string | null }
    | { __type: "section"; label: string };

  const defaultTemplate: RowUI[] = [
    { __type: "row", label: "Количество отработанных безопасных дней в месяце", valueA: "", section: null },
    { __type: "row", label: "Количество безопасных дней со дня последнего н/с", valueA: "", section: null },
    { __type: "row", label: "Количество проведенных инструктажей", valueA: "", section: null },
    { __type: "row", label: "Количество проведенных ПАБ", valueA: "", section: null },
    { __type: "row", label: "Количество КБТ", valueA: "", section: null },
    { __type: "row", label: "Количество выданных предписаний", valueA: "", section: null },
    { __type: "row", label: "Количество замечаний", valueA: "", section: null },
    { __type: "row", label: "Количество выполненных", valueA: "", section: null },
    { __type: "row", label: "Количество в работе", valueA: "", section: null },
    { __type: "row", label: "Количество просроченных", valueA: "", section: null },
    { __type: "section", label: "Кадровые меры" },
    { __type: "row", label: "Количество человек представленных к объяснительным", valueA: "", section: "Кадровые меры" },
    { __type: "row", label: "Количество нарушителей к котором применены административные наказания", valueA: "", section: "Кадровые меры" },
    { __type: "section", label: "Проверки" },
    { __type: "row", label: "Количество проводимых проверок контролирующими органами", valueA: "", section: "Проверки" },
  ];

  const headerText = `Показатели (период: с ${formatDateRu(startDate)} по ${formatDateRu(endDate)})`;

  const { data: persisted, isInitialLoading } = useQuery(["ud-report"], () => apiClient.getUdReport());

  const [rows, setRows] = useState<RowUI[]>(defaultTemplate);
  const [autoLabels, setAutoLabels] = useState<Set<string>>(new Set());
  const [dragIndex, setDragIndex] = useState<number | null>(null);

  useEffect(() => {
    if (!persisted) return;
    const rws = ((persisted as any).rows || []) as Array<any>;
    if (!rws.length) return;
    const ui: RowUI[] = [];
    let lastSection: string | null = null;
    rws.forEach((r: any, idx: number) => {
      const s = (r.section ?? null) as string | null;
      if (s && s !== lastSection) {
        ui.push({ __type: "section", label: s });
        lastSection = s;
      }
      if (!s) lastSection = null;
      ui.push({ __type: "row", id: r.id, label: r.label || "", valueA: r.valueA ?? "", valueB: r.valueB ?? "", section: s });
    });
    setRows(ui);
  }, [persisted]);

  // Добавление/удаление
  const addRow = () => {
    setRows((prev) => {
      const lastSection = [...prev].reverse().find((it) => (it as any).__type === "section") as any;
      return [
        ...prev,
        { __type: "row", label: "Новый показатель", valueA: "", section: lastSection?.label ?? null },
      ];
    });
  };
  const addSection = () =>
    setRows((prev) => {
      const count = prev.filter((it) => (it as any).__type === "section").length + 1;
      const label = `Новая тема ${count}`;
      return [
        ...prev,
        { __type: "section", label },
        { __type: "row", label: "Новый показатель", valueA: "", section: label },
      ];
    });
  const removeRow = (idx: number) => setRows((prev) => prev.filter((_, i) => i !== idx));
  const removeSection = (idx: number) => {
    setRows((prev) => {
      const a = [...prev];
      a.splice(idx, 1);
      for (let i = idx; i < a.length && (a[i] as any).__type !== "section"; i++) {
        const it = a[i] as any;
        if (it.__type === "row") a[i] = { ...it, section: null } as any;
      }
      return a;
    });
  };

  // Drag & drop rows (within and across sections)
  const handleRowDragStart = (idx: number) => (e: React.DragEvent) => {
    setDragIndex(idx);
    e.dataTransfer.effectAllowed = "move";
    e.dataTransfer.setData("text/plain", String(idx));
  };
  const handleRowDragOver = (e: React.DragEvent) => {
    if (isAdmin) e.preventDefault();
  };
  // Drop on a ROW: insert ABOVE the target row and adopt its section
  const handleRowDrop = (targetIdx: number) => (e: React.DragEvent) => {
    e.preventDefault();
    let src = dragIndex;
    if (src == null) {
      const d = parseInt(e.dataTransfer.getData("text/plain"), 10);
      if (!Number.isNaN(d)) src = d;
    }
    if (src == null) return;
    setRows((prev) => {
      if ((prev[src!] as any).__type !== "row") return prev;
      const target = prev[targetIdx] as any;
      const targetSection =
        (target && (target as any).__type === "row") ? (target.section ?? null)
        : null;
      const a = [...prev];
      const [moved] = a.splice(src!, 1);
      let insertIndex = targetIdx;
      if (src! < targetIdx) insertIndex = targetIdx - 1;
      a.splice(insertIndex, 0, { ...(moved as any), section: targetSection } as any);
      return a;
    });
    setDragIndex(null);
  };
  // Drop on a SECTION header: place the row as the first item of that section
  const handleSectionDrop = (sectionIdx: number) => (e: React.DragEvent) => {
    e.preventDefault();
    let src = dragIndex;
    if (src == null) {
      const d = parseInt(e.dataTransfer.getData("text/plain"), 10);
      if (!Number.isNaN(d)) src = d;
    }
    if (src == null) return;
    setRows((prev) => {
      if ((prev[src!] as any).__type !== "row" || (prev[sectionIdx] as any).__type !== "section") return prev;
      const section = prev[sectionIdx] as any;
      const a = [...prev];
      let destIdx = sectionIdx + 1;
      const [moved] = a.splice(src!, 1);
      if (src! < destIdx) destIdx = destIdx - 1;
      a.splice(destIdx, 0, { ...(moved as any), section: section.label } as any);
      return a;
    });
    setDragIndex(null);
  };

  // Автозаполнение из КБТ и ПАБ
  type ListKbtMeetingsOut = inferRPCOutputType<"listKbtMeetings">;
  const { data: kbtData } = useQuery<ListKbtMeetingsOut>(
    ["ud-kbt-total", startDate, endDate],
    () => apiClient.listKbtMeetings({ from: startDate, to: endDate, type: "PLAN" }),
    { keepPreviousData: true },
  );
  useEffect(() => {
    const total = (kbtData as any)?.total ?? 0;
    setRows((prev) => {
      const idx = prev.findIndex((x) => (x as any).__type === "row" && /Количество.*КБТ/i.test((x as any).label || ""));
      if (idx < 0) return prev;
      const a = [...prev];
      const foundLabel = (a[idx] as any).label as string;
      a[idx] = { ...(a[idx] as any), valueA: String(total) } as any;
      // mark auto label
      setAutoLabels((pl) => { const s = new Set(pl); s.add(foundLabel); return s; });
      return a;
    });
  }, [kbtData?.total]);

  // Автозаполнение: "Количество человек, представленных к объяснительным" из КБТ (Нарушения/инциденты)
  useEffect(() => {
    const items = (kbtData as any)?.items as Array<{ title?: string }> | undefined;
    if (!items || !items.length) return;
    const count = items.filter((m) => (m.title || "").trim().startsWith("*")).length;
    setRows((prev) => {
      const a = [...prev];
      const idx = a.findIndex(
        (x) =>
          (x as any).__type === "row" &&
          /Количество\s+человек.*представлен.*объясн/i.test(((x as any).label || "") as string),
      );
      if (idx < 0) return prev;
      const r = a[idx] as any;
      const newVal = String(count ?? 0);
      if (r.valueA === newVal) return prev;
      a[idx] = { ...r, valueA: newVal } as any;
      const labelActual = r.label as string;
      setAutoLabels((pl) => {
        const s = new Set(pl);
        s.add(labelActual);
        return s;
      });
      return a;
    });
  }, [kbtData]);

  // Сводные данные по предписаниям / замечаниям из отчета по ПК за период
  type PcSummaryOut = inferRPCOutputType<"getPcSummaryForRange">;
  const { data: pcSummary } = useQuery<PcSummaryOut>(
    ["ud-pc-summary", startDate, endDate],
    () => apiClient.getPcSummaryForRange({ from: startDate, to: endDate }),
    { keepPreviousData: true, enabled: !!startDate && !!endDate },
  );

  useEffect(() => {
    if (!pcSummary) return;
    setRows((prev) => {
      const a = [...prev];
      let changed = false;
      const normalize = (s: string) => (s || "").toLowerCase().trim();
      const setVal = (label: string, value: number) => {
        const idx = a.findIndex((x) => {
          if ((x as any).__type !== "row") return false;
          const lbl = normalize((x as any).label || "");
          return lbl === normalize(label);
        });
        if (idx < 0) return;
        const r = a[idx] as any;
        const newVal = String(value ?? 0);
        if (r.valueA === newVal) return;
        a[idx] = { ...r, valueA: newVal } as any;
        const labelActual = r.label as string;
        setAutoLabels((pl) => {
          const s = new Set(pl);
          s.add(labelActual);
          return s;
        });
        changed = true;
      };

      setVal("Количество выданных предписаний", pcSummary.issued);
      setVal("Количество замечаний", pcSummary.found);
      setVal("Количество выполненных", pcSummary.fixed);
      setVal("Количество в работе", pcSummary.inWork);
      setVal("Количество просроченных", pcSummary.overdue);

      return changed ? a : prev;
    });
  }, [pcSummary]);

  const { data: violStats } = useQuery<any>(
    ["ud-pab-audits", startDate, endDate],
    () => apiClient.getViolationStats({ from: startDate, to: endDate }),
    { keepPreviousData: true },
  );
  useEffect(() => {
    const total = (violStats as any)?.auditsTotal ?? 0;
    setRows((prev) => {
      const idx = prev.findIndex((x) => (x as any).__type === "row" && /Количество.*ПАБ/i.test((x as any).label || ""));
      if (idx < 0) return prev;
      const a = [...prev];
      const foundLabel = (a[idx] as any).label as string;
      a[idx] = { ...(a[idx] as any), valueA: String(total) } as any;
      // mark auto label
      setAutoLabels((pl) => { const s = new Set(pl); s.add(foundLabel); return s; });
      return a;
    });
  }, [violStats?.auditsTotal]);

  // Автозаполнение: количество вводных инструктажей за период
  type IntroBriefingList = inferRPCOutputType<"listIntroBriefings">;
  const { data: introBriefings } = useQuery<IntroBriefingList>(
    ["ud-intro-briefings", startDate, endDate],
    () => apiClient.listIntroBriefings({ from: startDate, to: endDate }),
    { keepPreviousData: true },
  );
  useEffect(() => {
    const sum = (introBriefings || []).reduce(
      (acc: number, it: any) => acc + (Number(it?.count) || 0),
      0,
    );
    setRows((prev) => {
      const idx = prev.findIndex(
        (x) =>
          (x as any).__type === "row" &&
          /Количество.*инструктаж/i.test(((x as any).label || "") as string),
      );
      if (idx < 0) return prev;
      const a = [...prev];
      const foundLabel = (a[idx] as any).label as string;
      a[idx] = { ...(a[idx] as any), valueA: String(sum) } as any;
      setAutoLabels((pl) => {
        const s = new Set(pl);
        s.add(foundLabel);
        return s;
      });
      return a;
    });
  }, [introBriefings]);

  // Безопасные дни: данные (нужны выше эффектов)
  type SafeStatsOut = inferRPCOutputType<"getSafeDaysStats">;
  const { data: safeStats } = useQuery<SafeStatsOut>(
    ["ud-safe-stats", endDate],
    () => apiClient.getSafeDaysStats({ today: endDate }),
    { keepPreviousData: true }
  );

  // Автозаполнение: безопасные дни в месяце (из «Безопасные дни»)
  useEffect(() => {
    if (safeStats?.monthSafeDays == null) return;
    setRows((prev) => {
      const a = [...prev];
      const idx = a.findIndex(
        (x) =>
          (x as any).__type === "row" &&
          /безопасн.*дн.*меся/i.test((((x as any).label || "") as string).toLowerCase())
      );
      if (idx < 0) return prev;
      const foundLabel = (a[idx] as any).label as string;
      a[idx] = { ...(a[idx] as any), valueA: String(safeStats.monthSafeDays) } as any;
      setAutoLabels((pl) => { const s = new Set(pl); s.add(foundLabel); return s; });
      return a;
    });
  }, [safeStats?.monthSafeDays]);

  // Автозаполнение: безопасные дни со дня последнего Н/С (на дату конца периода)
  useEffect(() => {
    if (safeStats?.sinceLastAccidentSafeDays == null) return;
    setRows((prev) => {
      const a = [...prev];
      const idx = a.findIndex(
        (x) =>
          (x as any).__type === "row" &&
          /безопасн.*дн.*послед/i.test((((x as any).label || "") as string).toLowerCase())
      );
      if (idx < 0) return prev;
      const foundLabel = (a[idx] as any).label as string;
      a[idx] = { ...(a[idx] as any), valueA: String(safeStats.sinceLastAccidentSafeDays) } as any;
      setAutoLabels((pl) => { const s = new Set(pl); s.add(foundLabel); return s; });
      return a;
    });
  }, [safeStats?.sinceLastAccidentSafeDays]);

  // Сохранение в БД через существующий backend
  const save = useMutation(apiClient.upsertUdReport, {
    onSuccess: (data) => {
      toast({ title: "Сохранено" });
      queryClient.setQueryData(["ud-report"], data as any);
    },
    onError: () => toast({ title: "Не удалось сохранить" }),
  });

  // Выгрузка отчета в Excel (используем существующий backend-отчет УД)
  const exportUdExcel = useMutation(apiClient.exportUdReportExcel, {
    onSuccess: (res: { url: string }) => {
      if (!res?.url) return;
      const sanitize = (s: string) =>
        (s || "")
          .replace(/[\\/:*?"<>|]+/g, " ")
          .replace(/\s+/g, " ")
          .trim();
      const dateStr = new Date().toISOString().slice(0, 10);
      const base = sanitize("Отчет для УД по охране труда и промышленной безопасности");
      const a = document.createElement("a");
      a.href = res.url;
      a.download = `${base || "Отчет для УД"}_${dateStr}.xlsx`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    },
    onError: () => toast({ title: "Не удалось выгрузить Excel" }),
  });

  const handleSavePdf = async () => {
    const el = printRef.current;
    if (!el) return;
    const canvas = await html2canvas(el, { scale: 2 });
    const imgData = canvas.toDataURL("image/png");
    const pdf = new jsPDF("p", "mm", "a4");
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const imgWidth = pageWidth;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    let heightLeft = imgHeight;
    let position = 0;
    pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
    heightLeft -= pageHeight;
    while (heightLeft > 0) {
      pdf.addPage();
      position = position - pageHeight;
      pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;
    }
    const dateStr = new Date().toISOString().slice(0, 10);
    pdf.save(`otchet-ud-${dateStr}.pdf`);
  };

  const handleSaveDb = () => {
    if (save.isLoading) return;
    let currentSection: string | null = null;
    const normalized = rows
      .flatMap((it) => {
        if ((it as any).__type === "section") {
          currentSection = (it as any).label as string;
          return [] as any[];
        }
        const r = it as any;
        return [
          {
            id: r.id,
            label: r.label,
            valueA: r.valueA ?? null,
            valueB: r.valueB ?? null,
            order: 0,
            section: currentSection,
          },
        ];
      })
      .map((r, i) => ({ ...r, order: i }));

    save.mutate({
      title: "Отчет для УД по ОТ и ПБ",
      columnA: headerText,
      columnB: "Пояснение",
      rows: normalized,
    });
  };

  const handleRefresh = () => {
    queryClient.invalidateQueries(["ud-kbt-total", startDate, endDate]);
    queryClient.invalidateQueries(["ud-pab-audits", startDate, endDate]);
    queryClient.invalidateQueries(["ud-intro-briefings", startDate, endDate]);
    queryClient.invalidateQueries(["ud-safe-range", startDate, endDate]);
    queryClient.invalidateQueries(["ud-safe-stats", endDate]);
    queryClient.invalidateQueries(["ud-pc-summary", startDate, endDate]);
  };
  const handlePrint = () => window.print();
  const handleSend = () => {
    const email = prompt("Введите email для отправки отчета:");
    if (email) alert(`Отчет отправлен на адрес: ${email}`);
  };

  // UI
  return (
    <div className="max-w-5xl mx-auto p-4 sm:p-6">
      <div className="bg-card rounded-lg shadow border p-6" ref={printRef}>
        <div className="text-center border-b pb-4 mb-4">
          <h1 className="text-2xl font-bold text-primary flex items-center justify-center gap-2">
            Отчет для УД по охране труда и промышленной безопасности
          </h1>
          <div className="text-muted-foreground mt-1">
            Ежемесячный отчет о состоянии охраны труда и промышленной безопасности
          </div>
        </div>

        <div className="flex flex-col lg:flex-row gap-4 bg-muted/30 p-4 rounded-md items-start lg:items-center justify-between">
          {isAdmin && (
            <div className="flex flex-wrap items-center gap-2">
              <label className="font-semibold text-primary">Период с:</label>
              <input type="date" className="border rounded px-3 py-2" value={startDate} onChange={(e) => setStartDate(e.target.value)} />
              <label className="font-semibold text-primary">по:</label>
              <input type="date" className="border rounded px-3 py-2" value={endDate} onChange={(e) => setEndDate(e.target.value)} />
            </div>
          )}
          {isAdmin ? (
            <div className="flex flex-wrap gap-2">
              <Button id="refreshBtn" onClick={handleRefresh} className="bg-blue-600 text-white hover:opacity-90">Обновить страницу</Button>
               <Button variant="secondary" onClick={addSection}>Добавить тему</Button>
               <Button variant="secondary" onClick={addRow}>Добавить строку</Button>
               <Button id="saveBtn" onClick={handleSaveDb} disabled={save.isLoading} className="bg-blue-900 text-white hover:opacity-90">{save.isLoading ? "Сохраняю…" : "Сохранить"}</Button>
               <Button onClick={() => exportUdExcel.mutate()} disabled={exportUdExcel.isLoading} className="bg-blue-600 text-white hover:opacity-90">
                 {exportUdExcel.isLoading ? "Готовим Excel…" : "Скачать Excel"}
               </Button>
               <Button variant="secondary" onClick={handleSavePdf}>Скачать PDF</Button>
               <Button id="printBtn" onClick={handlePrint} className="bg-blue-600 text-white hover:opacity-90">Распечатать</Button>
               <Button id="sendBtn" onClick={handleSend} className="bg-green-600 text-white hover:opacity-90">Отправить</Button>            </div>
          ) : (
             <div className="flex flex-wrap gap-2">
               <Button id="refreshBtn" onClick={handleRefresh} className="bg-blue-600 text-white hover:opacity-90">Обновить страницу</Button>
               <Button variant="secondary" onClick={handleSavePdf}>Скачать PDF</Button>
               <Button id="printBtn" onClick={handlePrint} className="bg-blue-600 text-white hover:opacity-90">Распечатать</Button>
             </div>          )}
        </div>

        <div className="overflow-x-auto">
          <table className="w-full mt-3 text-sm">
            <thead>
              <tr>
                <th className="bg-blue-900 text-white font-semibold text-center px-4 py-3 w-[60%]">{headerText}</th>
                <th className="bg-blue-900 text-white font-semibold text-center px-4 py-3 w-[20%]">Значение</th>
                <th className="bg-blue-900 text-white font-semibold text-center px-4 py-3 w-[20%]">Пояснение</th>
              </tr>
            </thead>
            <tbody>
              {isInitialLoading ? (
                <tr><td colSpan={3} className="px-4 py-3 text-muted-foreground">Загрузка…</td></tr>
              ) : rows.map((it, idx) => {
                if ((it as any).__type === "section") {
                  const section = it as { __type: "section"; label: string };
                  return (
                    <tr key={`s-${idx}`} className="bg-blue-950 text-white font-bold" onDragOver={handleRowDragOver} onDrop={handleSectionDrop(idx)}>
                      <td colSpan={3} className="px-4 py-3">
                        <div className="flex items-center gap-2">
                          <Input className="bg-transparent text-white placeholder:text-white/80" value={section.label} readOnly={!isAdmin}
                            onChange={(e) => setRows((prev) => { const a = [...prev]; a[idx] = { __type: "section", label: e.target.value } as any; for (let j = idx + 1; j < a.length && (a[j] as any).__type !== "section"; j++) { const it = a[j] as any; if (it.__type === "row") a[j] = { ...it, section: e.target.value } as any; } return a; })}
                            placeholder="Название темы" />
                          {isAdmin && (<Button size="sm" variant="destructive" onClick={() => removeSection(idx)}>Удалить тему</Button>)}
                        </div>
                      </td>
                    </tr>
                  );
                }
                const row = it as { __type: "row"; id?: string; label: string; valueA?: string | null; section?: string | null };
                return (
                  <tr key={(row.id || "new") + idx} className={idx % 2 === 1 ? "bg-muted/40" : undefined} onDragOver={handleRowDragOver} onDrop={handleRowDrop(idx)}>
                    <td className="px-4 py-3 align-top">
                      <div className="grid gap-1">
                        {row.section && (<div className="text-[11px] text-muted-foreground uppercase">{row.section}</div>)}
                        <div className="flex items-center gap-2">
                          {isAdmin && (
                            <span
                              title="Перетащить"
                              className="cursor-grab select-none text-muted-foreground"
                              draggable
                              onDragStart={handleRowDragStart(idx)}
                            >
                              ⋮⋮
                            </span>
                          )}
                          <Input value={row.label} readOnly={!isAdmin || autoLabels.has(row.label)} className={autoLabels.has(row.label) ? "generated-input" : undefined} style={autoLabels.has(row.label) ? { background: "hsla(var(--success) / 0.12)", borderColor: "hsl(var(--success))" } : undefined} onChange={(e) => setRows((prev) => { const a = [...prev]; a[idx] = { ...(a[idx] as any), label: e.target.value } as any; return a; })} />
                        </div>
                      </div>
                    </td>
                    <td className="px-4 py-3 align-top">
                      <div className="flex items-center gap-2">
                        <Input value={row.valueA ?? ""} placeholder="Введите значение" readOnly={!isAdmin || autoLabels.has(row.label)} className={autoLabels.has(row.label) ? "generated-input" : undefined} style={autoLabels.has(row.label) ? { background: "hsla(var(--success) / 0.12)", borderColor: "hsl(var(--success))" } : undefined} onChange={(e) => setRows((prev) => { const a = [...prev]; a[idx] = { ...(a[idx] as any), valueA: e.target.value } as any; return a; })} />
                        {isAdmin && (<Button size="sm" variant="destructive" onClick={() => removeRow(idx)}>Удалить</Button>)}
                      </div>
                    </td>
                    <td className="px-4 py-3 align-top">
                      <Textarea
                        value={row.valueB ?? ""}
                        placeholder="Пояснение…"
                        readOnly={!isAdmin}
                        rows={1}
                        className="resize-none overflow-hidden"
                        onInput={(e) => {
                          const el = e.currentTarget as HTMLTextAreaElement;
                          el.style.height = "auto";
                          el.style.height = `${el.scrollHeight}px`;
                        }}
                        onChange={(e) => setRows((prev) => { const a = [...prev]; a[idx] = { ...(a[idx] as any), valueB: e.target.value } as any; return a; })}
                      />
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
}

function looksLikeGibberish(value?: string | null) {
  const v = (value ?? "").trim();
  if (!v) return false; // absence is handled separately
  if (/(.)\1\1/.test(v)) return true; // 3+ same chars
  if (!v.includes(" ") && /^[A-Za-zА-Яа-яЁё]+$/.test(v) && v.length <= 3)
    return true;
  return false;
}
function needsAttentionUser(u: any) {
  const emailBad = !u?.email || !/^([^@\s]+)@([^@\s]+)\.[^@\s]+$/.test(u.email);
  const nameBad = !u?.fullName || looksLikeGibberish(u.fullName);
  const companyBad = !u?.company || looksLikeGibberish(u.company);
  const jobBad = !u?.jobTitle || looksLikeGibberish(u.jobTitle);
  return emailBad || nameBad || companyBad || jobBad;
}
function UserInfoIssueDialog({ user }: { user: any }) {
  const [open, setOpen] = React.useState(false);
  const issues: string[] = [];
  if (!user?.fullName) issues.push("ФИО не заполнено.");
  else if (looksLikeGibberish(user.fullName))
    issues.push("ФИО выглядит как набор символов (проверьте корректность).");
  if (!user?.email) issues.push("Email не указан.");
  else if (!/^([^@\s]+)@([^@\s]+)\.[^@\s]+$/.test(user.email))
    issues.push("Email выглядит некорректно.");
  if (!user?.company) issues.push("Компания не указана.");
  else if (looksLikeGibberish(user.company))
    issues.push("Компания выглядит как набор символов.");
  if (!user?.jobTitle) issues.push("Должность не указана.");
  else if (looksLikeGibberish(user.jobTitle))
    issues.push("Должность выглядит как набор символов.");
  return (
    <Dialog open={open} onOpenChange={setOpen}>
      <DialogTrigger asChild>
        <Button
          size="sm"
          variant="destructive"
          className="h-7 px-2 text-xs"
          title="Пояснение по данным"
        >
          ?
        </Button>
      </DialogTrigger>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Информация по пользователю</DialogTitle>
        </DialogHeader>
        <div className="space-y-2 text-sm">
          <div>
            <span className="text-muted-foreground">ID№:</span>{" "}
            {user.shortId ?? "—"}
          </div>
          <div>
            <span className="text-muted-foreground">Email входа:</span>{" "}
            {user.email || "—"}
          </div>
          <div>
            <span className="text-muted-foreground">ФИО:</span>{" "}
            {user.fullName || "—"}
          </div>
          <div>
            <span className="text-muted-foreground">Компания:</span>{" "}
            {user.company || "—"}
          </div>
          <div>
            <span className="text-muted-foreground">Должность:</span>{" "}
            {user.jobTitle || "—"}
          </div>
          <div>
            <span className="text-muted-foreground">Статус:</span>{" "}
            {user.isBlocked ? "Заблокирован" : "Активен"}
          </div>
          {(user.accessFrom || user.accessTo) && (
            <div>
              <span className="text-muted-foreground">Окно доступа:</span>{" "}
              {user.accessFrom
                ? new Date(user.accessFrom).toISOString().slice(0, 10)
                : "—"}{" "}
              —{" "}
              {user.accessTo
                ? new Date(user.accessTo).toISOString().slice(0, 10)
                : "—"}
            </div>
          )}
          <div className="pt-2 font-medium">
            Почему показываются прочерки или странные данные
          </div>
          <ul className="list-disc list-inside space-y-1">
            {issues.length ? (
              issues.map((t, i) => <li key={i}>{t}</li>)
            ) : (
              <li>Данные были заполнены, обновите страницу.</li>
            )}
            <li>
              Заполните профиль пользователя корректными значениями, чтобы
              вместо прочерков отображалась информация.
            </li>
          </ul>
        </div>
      </DialogContent>
    </Dialog>
  );
}

function SuperAdminScreen_DuplicateDoNotUse() {
  const auth = useAuth({ required: true });
  const navigate = useNavigate();
  const { data: me } = useQuery<Profile>(
    ["me"],
    () => apiClient.getMyProfile(),
    {
      enabled: auth.status === "authenticated",
      staleTime: 10_000,
    },
  );

  const isSuper = !!(me as any)?.isSuperAdmin;

  // Protect route: show simple message if not super admin
  if (auth.status === "loading") {
    return <div className="p-4">Загрузка…</div>;
  }
  if (!isSuper) {
    return (
      <div className="max-w-3xl mx-auto p-4">
        <Card>
          <CardHeader>
            <CardTitle>Нет доступа</CardTitle>
            <CardDescription>
              Эта страница доступна только главному администратору.
            </CardDescription>
          </CardHeader>
          <CardFooter>
            <Button variant="secondary" onClick={() => navigate("/home")}>
              На главную
            </Button>
          </CardFooter>
        </Card>
      </div>
    );
  }

  function DocumentConstructorScreen() {
    useAuth({ required: true });
    const navigate = useNavigate();
    const [header, setHeader] = React.useState("");
    const [footer, setFooter] = React.useState("");
    const [blocks, setBlocks] = React.useState<string[]>([""]);
    const [copied, setCopied] = React.useState(false);

    const assembled = React.useMemo(() => {
      const parts = [
        header.trim(),
        ...blocks.map((b) => b.trim()).filter(Boolean),
        footer.trim(),
      ].filter(Boolean);
      return parts.join("\n\n");
    }, [header, blocks, footer]);

    const addBlock = () => setBlocks((prev) => [...prev, ""]);
    const removeBlock = (idx: number) =>
      setBlocks((prev) =>
        prev.length > 1 ? prev.filter((_, i) => i !== idx) : prev,
      );
    const moveUp = (idx: number) =>
      setBlocks((prev) => {
        if (idx <= 0) return prev;
        const next = [...prev];
        [next[idx - 1], next[idx]] = [next[idx], next[idx - 1]];
        return next;
      });
    const moveDown = (idx: number) =>
      setBlocks((prev) => {
        if (idx >= prev.length - 1) return prev;
        const next = [...prev];
        [next[idx + 1], next[idx]] = [next[idx], next[idx + 1]];
        return next;
      });

    const clearAll = () => {
      const ok = window.confirm("Очистить все поля конструктора?");
      if (!ok) return;
      setHeader("");
      setBlocks([""]);
      setFooter("");
      setCopied(false);
    };

    const copyAll = () => {
      try {
        // copy comes from copy-to-clipboard import at the top of the file
        // @ts-ignore - global import in this file
        const did = (
          typeof copy === "function" ? copy : (window as any).copy
        )?.(assembled);
        setCopied(!!did);
        if (!did) {
          // fallback
          navigator.clipboard
            ?.writeText?.(assembled)
            .then(() => setCopied(true))
            .catch(() => setCopied(false));
        }
        window.setTimeout(() => setCopied(false), 1500);
      } catch {
        setCopied(false);
      }
    };

    return (
      <div className="max-w-5xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated mb-4">
          <CardHeader>
            <CardTitle>КОНСТРУКТОР документа</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
              <div className="space-y-4">
                <div className="grid gap-2">
                  <Label>Шапка</Label>
                  <Textarea
                    className="pc-autosize"
                    rows={3}
                    value={header}
                    onChange={(e) => setHeader(e.target.value)}
                    placeholder="Введите шапку документа"
                  />
                </div>

                <div className="space-y-3">
                  <div className="text-sm font-medium">Блоки</div>
                  {blocks.map((val, idx) => (
                    <div key={idx} className="border rounded-md p-3 space-y-2">
                      <div className="flex items-center justify-between">
                        <div className="text-xs text-muted-foreground">
                          Блок #{idx + 1}
                        </div>
                        <div className="flex items-center gap-2">
                          <Button
                            size="sm"
                            variant="secondary"
                            onClick={() => moveUp(idx)}
                            disabled={idx === 0}
                          >
                            Вверх
                          </Button>
                          <Button
                            size="sm"
                            variant="secondary"
                            onClick={() => moveDown(idx)}
                            disabled={idx === blocks.length - 1}
                          >
                            Вниз
                          </Button>
                          <Button
                            size="sm"
                            variant="destructive"
                            onClick={() => removeBlock(idx)}
                            disabled={blocks.length <= 1}
                          >
                            Удалить
                          </Button>
                        </div>
                      </div>
                      <Textarea
                        className="pc-autosize"
                        rows={4}
                        value={val}
                        onChange={(e) =>
                          setBlocks((prev) =>
                            prev.map((b, i) =>
                              i === idx ? e.target.value : b,
                            ),
                          )
                        }
                        placeholder="Текст блока"
                      />
                    </div>
                  ))}
                  <Button className="btn-3d" onClick={addBlock}>
                    + Добавить блок
                  </Button>
                </div>

                <div className="grid gap-2">
                  <Label>Подвал</Label>
                  <Textarea
                    className="pc-autosize"
                    rows={3}
                    value={footer}
                    onChange={(e) => setFooter(e.target.value)}
                    placeholder="Введите подвал документа"
                  />
                </div>

                <div className="flex flex-wrap gap-2 pt-2">
                  <Button
                    variant="secondary"
                    onClick={() => navigate(-1 as any)}
                  >
                    Назад
                  </Button>
                  <Button
                    className="btn-3d"
                    onClick={copyAll}
                    disabled={!assembled}
                  >
                    {copied ? "Скопировано!" : "Скопировать итоговый текст"}
                  </Button>
                  <Button variant="outline" onClick={clearAll}>
                    Очистить
                  </Button>
                </div>
              </div>

              <div>
                <div className="text-sm font-medium mb-2">Предпросмотр</div>
                <div className="border rounded-md p-4 min-h-[240px] bg-white text-black">
                  {assembled ? (
                    <div className="whitespace-pre-wrap">{assembled}</div>
                  ) : (
                    <div className="text-xs text-muted-foreground">
                      Введите текст блоков — итог появится здесь
                    </div>
                  )}
                </div>
              </div>
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  function DocumentConstructorScreen() {
    useAuth({ required: true });
    const navigate = useNavigate();
    const [header, setHeader] = React.useState("");
    const [footer, setFooter] = React.useState("");
    const [blocks, setBlocks] = React.useState<string[]>([""]);
    const [copied, setCopied] = React.useState(false);

    const assembled = React.useMemo(() => {
      const parts = [
        header.trim(),
        ...blocks.map((b) => b.trim()).filter(Boolean),
        footer.trim(),
      ].filter(Boolean);
      return parts.join("\n\n");
    }, [header, blocks, footer]);

    const addBlock = () => setBlocks((prev) => [...prev, ""]);
    const removeBlock = (idx: number) =>
      setBlocks((prev) =>
        prev.length > 1 ? prev.filter((_, i) => i !== idx) : prev,
      );
    const moveUp = (idx: number) =>
      setBlocks((prev) => {
        if (idx <= 0) return prev;
        const next = [...prev];
        [next[idx - 1], next[idx]] = [next[idx], next[idx - 1]];
        return next;
      });
    const moveDown = (idx: number) =>
      setBlocks((prev) => {
        if (idx >= prev.length - 1) return prev;
        const next = [...prev];
        [next[idx + 1], next[idx]] = [next[idx], next[idx + 1]];
        return next;
      });

    const clearAll = () => {
      const ok = window.confirm("Очистить все поля конструктора?");
      if (!ok) return;
      setHeader("");
      setBlocks([""]);
      setFooter("");
      setCopied(false);
    };

    const copyAll = () => {
      try {
        // copy comes from copy-to-clipboard import at the top of the file
        // @ts-ignore - global import in this file
        const did = (
          typeof copy === "function" ? copy : (window as any).copy
        )?.(assembled);
        setCopied(!!did);
        if (!did) {
          // fallback
          navigator.clipboard
            ?.writeText?.(assembled)
            .then(() => setCopied(true))
            .catch(() => setCopied(false));
        }
        window.setTimeout(() => setCopied(false), 1500);
      } catch {
        setCopied(false);
      }
    };

    return (
      <div className="max-w-5xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated mb-4">
          <CardHeader>
            <CardTitle>КОНСТРУКТОР документа</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
              <div className="space-y-4">
                <div className="grid gap-2">
                  <Label>Шапка</Label>
                  <Textarea
                    className="pc-autosize"
                    rows={3}
                    value={header}
                    onChange={(e) => setHeader(e.target.value)}
                    placeholder="Введите шапку документа"
                  />
                </div>

                <div className="space-y-3">
                  <div className="text-sm font-medium">Блоки</div>
                  {blocks.map((val, idx) => (
                    <div key={idx} className="border rounded-md p-3 space-y-2">
                      <div className="flex items-center justify-between">
                        <div className="text-xs text-muted-foreground">
                          Блок #{idx + 1}
                        </div>
                        <div className="flex items-center gap-2">
                          <Button
                            size="sm"
                            variant="secondary"
                            onClick={() => moveUp(idx)}
                            disabled={idx === 0}
                          >
                            Вверх
                          </Button>
                          <Button
                            size="sm"
                            variant="secondary"
                            onClick={() => moveDown(idx)}
                            disabled={idx === blocks.length - 1}
                          >
                            Вниз
                          </Button>
                          <Button
                            size="sm"
                            variant="destructive"
                            onClick={() => removeBlock(idx)}
                            disabled={blocks.length <= 1}
                          >
                            Удалить
                          </Button>
                        </div>
                      </div>
                      <Textarea
                        className="pc-autosize"
                        rows={4}
                        value={val}
                        onChange={(e) =>
                          setBlocks((prev) =>
                            prev.map((b, i) =>
                              i === idx ? e.target.value : b,
                            ),
                          )
                        }
                        placeholder="Текст блока"
                      />
                    </div>
                  ))}
                  <Button className="btn-3d" onClick={addBlock}>
                    + Добавить блок
                  </Button>
                </div>

                <div className="grid gap-2">
                  <Label>Подвал</Label>
                  <Textarea
                    className="pc-autosize"
                    rows={3}
                    value={footer}
                    onChange={(e) => setFooter(e.target.value)}
                    placeholder="Введите подвал документа"
                  />
                </div>

                <div className="flex flex-wrap gap-2 pt-2">
                  <Button
                    variant="secondary"
                    onClick={() => navigate(-1 as any)}
                  >
                    Назад
                  </Button>
                  <Button
                    className="btn-3d"
                    onClick={copyAll}
                    disabled={!assembled}
                  >
                    {copied ? "Скопировано!" : "Скопировать итоговый текст"}
                  </Button>
                  <Button variant="outline" onClick={clearAll}>
                    Очистить
                  </Button>
                </div>
              </div>

              <div>
                <div className="text-sm font-medium mb-2">Предпросмотр</div>
                <div className="border rounded-md p-4 min-h-[240px] bg-white text-black">
                  {assembled ? (
                    <div className="whitespace-pre-wrap">{assembled}</div>
                  ) : (
                    <div className="text-xs text-muted-foreground">
                      Введите текст блоков — итог появится здесь
                    </div>
                  )}
                </div>
              </div>
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }
  // Load admins list
  const { data: usersPage } = useQuery(
    ["users-admins", 1],
    () => apiClient.listUsers({ page: 1, pageSize: 100 }),
    { staleTime: 30_000 },
  );
  const admins = (usersPage?.items ?? []).filter((u: any) => !!u.isAdmin);

  // Load sessions for last 24h to see activity
  const fromIso = useMemo(() => {
    const d = new Date(Date.now() - 24 * 60 * 60 * 1000);
    return d.toISOString();
  }, []);
  const { data: sessionsData } = useQuery(
    ["sessions-24h"],
    () =>
      apiClient.listVisitSessions({ from: fromIso, page: 1, pageSize: 100 }),
    { enabled: true, staleTime: 30_000 },
  );
  const sessions = (sessionsData?.items ?? []) as Array<{
    userId: string;
    fullName: string | null;
    email: string | null;
    jobTitle: string | null;
    department: string | null;
    startAt: string | Date;
    endAt: string | Date;
    durationSec: number;
    visits: number;
  }>;

  const lastByUser = useMemo(() => {
    const map = new Map<
      string,
      { lastAt: Date; visits: number; durationSec: number }
    >();
    for (const s of sessions) {
      const end = new Date(s.endAt as any);
      const cur = map.get(s.userId);
      if (!cur || end > cur.lastAt) {
        map.set(s.userId, {
          lastAt: end,
          visits: s.visits,
          durationSec: s.durationSec,
        });
      }
    }
    return map;
  }, [sessions]);

  return (
    <div className="max-w-5xl mx-auto p-4 sm:p-6">
      <div className="flex items-center justify-between mb-4">
        <div>
          <h1 className="text-xl font-semibold">Супер админ-панель</h1>
          <p className="text-muted-foreground text-sm">
            Просмотр администраторов и их активности за последние 24 часа.
          </p>
        </div>
        <div className="flex gap-2">
          <Button onClick={() => navigate("/admin")} className="shadow-md">
            Открыть админку
          </Button>
        </div>
      </div>

      <Card>
        <CardHeader>
          <CardTitle>Администраторы</CardTitle>
          <CardDescription>
            Список администраторов и их последняя активность.
          </CardDescription>
        </CardHeader>
        <CardContent>
          <div className="overflow-x-auto">
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>ФИО</TableHead>
                  <TableHead>Подразделение</TableHead>
                  <TableHead>Должность</TableHead>
                  <TableHead>Email</TableHead>
                  <TableHead>Последняя активность</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {admins.map((u: any) => {
                  const info = lastByUser.get(u.id);
                  return (
                    <TableRow key={u.id}>
                      <TableCell className="font-medium">
                        {u.fullName || "—"}
                      </TableCell>
                      <TableCell>{u.department || "—"}</TableCell>
                      <TableCell>{u.jobTitle || "—"}</TableCell>
                      <TableCell>{u.email || "—"}</TableCell>
                      <TableCell>
                        {info?.lastAt
                          ? new Date(info.lastAt).toLocaleString()
                          : "нет за 24ч"}
                      </TableCell>
                    </TableRow>
                  );
                })}
              </TableBody>
            </Table>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}

function AdminScreen() {
  const auth = useAuth({ required: true });
  const { data: me } = useQuery<Profile>(
    ["me"],
    () => apiClient.getMyProfile(),
    {
      enabled: auth.status === "authenticated",
      staleTime: 10_000,
    },
  );

  const isAdmin = !!me?.isAdmin;

  // Hidden blocks (admin UI) local state with persistence
  const [hiddenBlocks, setHiddenBlocks] = useState<Set<string>>(() => {
    try {
      const raw = localStorage.getItem("adminHiddenBlocks");
      if (raw) {
        const arr = JSON.parse(raw) as unknown;
        if (Array.isArray(arr)) return new Set(arr as string[]);
      }
    } catch {
      /* ignore */
    }
    return new Set();
  });
  const hideBlock = (key: string) => {
    setHiddenBlocks((prev) => {
      const next = new Set(prev);
      next.add(key);
      try {
        localStorage.setItem(
          "adminHiddenBlocks",
          JSON.stringify(Array.from(next)),
        );
      } catch {
        /* ignore */
      }
      return next;
    });
  };

  const { data: settings } = useQuery(
    ["appSettings"],
    () => apiClient.getAppSettings(),
    { enabled: isAdmin },
  );

  const { data: platform } = useQuery(["platformInfo"], () =>
    apiClient.health(),
  );

  // Текущее число активных пользователей (за последние 7 минут)
  const { data: presenceAdmin } = useQuery<Presence>(
    ["presence-admin"],
    () => apiClient.getPresenceSummary({ minutes: 7 }),
    {
      enabled: isAdmin,
      staleTime: 30_000,
      refetchInterval: 30_000,
      retry: (failureCount, error: any) => {
        const msg = (error as any)?.message || "";
        // Не бомбим повторными запросами при сетевых сбоях/timeout
        if (typeof msg === "string" && msg.toLowerCase().includes("fetch failed")) {
          return false;
        }
        return failureCount < 2;
      },
    },
  );

  // QR for login/registration page
  const loginUrl = useMemo(() => new URL("/", getBaseUrl()).toString(), []);
  const [qrDataUrl, setQrDataUrl] = useState<string>("");

  // Upload custom login illustration
  const uploadIllustration = useMutation(
    apiClient.setLoginIllustrationFromUpload,
    {
      onSuccess: async () => {
        await queryClient.invalidateQueries({ queryKey: ["appSettings"] });
        toast({ title: "Изображение обновлено" });
      },
      onError: () => toast({ title: "Не удалось обновить изображение" }),
    },
  );

  // Send offline link to admins
  const sendOfflineLink = useMutation(apiClient.sendOfflineLinkToAdmins, {
    onSuccess: (res: {
      ok: boolean;
      url?: string;
      successCount?: number;
      failureCount?: number;
    }) => {
      if (res?.ok) {
        toast({
          title: "Отправлено",
          description: `Ссылка разослана администраторам. Успешно: ${res.successCount ?? 0}${res.failureCount ? `, ошибок: ${res.failureCount}` : ""}`,
        });
      } else {
        toast({ title: "Не удалось отправить" });
      }
    },
    onError: () => toast({ title: "Ошибка отправки" }),
  });
  useEffect(() => {
    let mounted = true;
    (async () => {
      try {
        const dataUrl = await QRCode.toDataURL(loginUrl, {
          width: 512,
          margin: 2,
        });
        if (mounted) setQrDataUrl(dataUrl);
      } catch {
        console.error("QR gen failed");
      }
    })();
    return () => {
      mounted = false;
    };
  }, [loginUrl]);

  // Admin stats (violations)
  const [statsFrom, setStatsFrom] = useState<string>("");
  const [statsTo, setStatsTo] = useState<string>("");
  const { data: adminStats } = useQuery<Stats>(
    ["admin-stats", statsFrom, statsTo],
    () =>
      apiClient.getViolationStats({
        from: statsFrom || undefined,
        to: statsTo || undefined,
      }),
    { enabled: isAdmin },
  );
  const exportStatsExcel = useMutation(apiClient.exportReportsSafetyExcel);
  const exportStatsDocx = useMutation(apiClient.exportViolationStatsDocx);

  // Monetization state
  const [prodName, setProdName] = useState("");
  const [prodDesc, setProdDesc] = useState("");
  const [priceRub, setPriceRub] = useState<string>("");
  const [kind, setKind] = useState<"IN_APP_PURCHASE" | "SUBSCRIPTION">(
    "SUBSCRIPTION",
  );

  const { data: products } = useQuery(
    ["products"],
    () => apiClient.listPayProductsRUB(),
    { enabled: isAdmin },
  );

  const createProductMutation = useMutation(apiClient.createPayProductRUB, {
    onSuccess: async () => {
      await queryClient.invalidateQueries({ queryKey: ["products"] });
      toast({ title: "Продукт создан" });
      setProdName("");
      setProdDesc("");
      setPriceRub("");
    },
    onError: () => toast({ title: "Не удалось создать продукт" }),
  });

  const discontinueMutation = useMutation(apiClient.disablePayProduct, {
    onSuccess: async () => {
      await queryClient.invalidateQueries({ queryKey: ["products"] });
      toast({ title: "Продукт отключён" });
    },
    onError: () => toast({ title: "Не удалось отключить продукт" }),
  });

  const [userLimitDraft, setUserLimitDraft] = useState<number | undefined>(
    settings?.userLimit,
  );
  useEffect(() => {
    setUserLimitDraft(settings?.userLimit);
  }, [settings?.userLimit]);

  const queryClient = useQueryClient();
  const { toast } = useToast();

  const [repairIdentifier, setRepairIdentifier] = useState("");
  const [repairDescription, setRepairDescription] = useState("");
  const [repairMode, setRepairMode] = useState<"normal" | "restart">(
    "normal",
  );

  const accountDiag = useRealtimeMutation(apiClient.runDiagnostics);
  const repairMutation = useMutation(apiClient.repairUserAccount, {
    onSuccess: async (res: any) => {
      if (!res?.ok) {
        const code = res?.error || "UNKNOWN";
        toast({
          title: "Не удалось выполнить ремонт",
          description:
            code === "USER_NOT_FOUND"
              ? "Пользователь не найден. Проверьте email или ID№."
              : "Попробуйте ещё раз или обратитесь в поддержку.",
        });
        return;
      }

      const identifier = repairIdentifier.trim();
      if (identifier) {
        accountDiag.mutate({
          identifier,
          description:
            repairMode === "restart"
              ? repairDescription.trim() || undefined
              : undefined,
        } as any);
      }

      const fixed: string[] = (res.fixed as string[]) || [];
      const warnings: string[] = (res.warnings as string[]) || [];
      let description = "";
      if (fixed.length) {
        description += "Исправлено:\n- " + fixed.join("\n- ");
      }
      if (warnings.length) {
        description +=
          (description ? "\n\n" : "") +
          "Предупреждения:\n- " +
          warnings.join("\n- ");
      }
      toast({
        title: "Ремонт выполнен",
        description:
          description || "Явных структурных проблем не обнаружено.",
      });

      if (repairMode === "restart") {
        setTimeout(() => {
          try {
            window.location.reload();
          } catch {
            /* ignore */
          }
        }, 800);
      }
    },
    onError: () => {
      toast({
        title: "Ошибка ремонта",
        description: "Попробуйте ещё раз или обратитесь в поддержку.",
      });
    },
  });

  // --- User registration (admin) state ---
  const [regEmail, setRegEmail] = useState("");
  const [regFullName, setRegFullName] = useState("");
  const [regCompany, setRegCompany] = useState("");
  const [regDepartment, setRegDepartment] = useState("");
  const [regJobTitle, setRegJobTitle] = useState("");
  const [regSubmitted, setRegSubmitted] = useState(false);
  const [regQr, setRegQr] = useState<string>("");
  const welcomeUrl = useMemo(
    () => new URL("/welcome", getBaseUrl()).toString(),
    [],
  );
  const downloadTxt = (text: string, filename: string) => {
    const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  };
  const sendReg = useMutation(apiClient.sendRegistrationLink, {
    onSuccess: async (res: { ok: boolean; error?: string }) => {
      if (res?.ok) {
        setRegSubmitted(true);
        try {
          const dataUrl = await QRCode.toDataURL(welcomeUrl, {
            width: 512,
            margin: 2,
          });
          setRegQr(dataUrl);
        } catch {
          console.error("QR gen failed");
        }
        toast({ title: "Ссылка отправлена" });
      } else {
        toast({
          title: "Не удалось отправить",
          description:
            res?.error === "INVALID_INPUT"
              ? "Проверьте поля"
              : "Попробуйте позже",
        });
      }
    },
    onError: () => toast({ title: "Ошибка отправки" }),
  });

  const updateSettings = useMutation(apiClient.updateAppSettings, {
    onSuccess: async () => {
      await queryClient.invalidateQueries({ queryKey: ["appSettings"] });
      toast({ title: "Настройки сохранены" });
    },
    onError: () => toast({ title: "Не удалось сохранить настройки" }),
  });

  const [search, setSearch] = useState("");
  const [page, setPage] = useState(1);
  const [selectedUserIds, setSelectedUserIds] = useState<Set<string>>(
    new Set(),
  );

  const { data: users } = useQuery(
    ["users", search, page],
    () => apiClient.listUsers({ query: search || undefined, page }),
    { enabled: isAdmin },
  );

  const setAdmin = useMutation(apiClient.setUserAdmin, {
    onSuccess: async () => {
      await queryClient.invalidateQueries({ queryKey: ["users"] });
      toast({ title: "Обновлено" });
    },
    onError: () => toast({ title: "Не удалось изменить права" }),
  });

  const deleteUsers = useMutation(apiClient.deleteUsersAdmin, {
    onSuccess: async (res: {
      ok: boolean;
      deleted: number;
      blockedIds: string[];
    }) => {
      await queryClient.invalidateQueries({ queryKey: ["users"] });
      setSelectedUserIds(new Set());
      toast({
        title: "Удаление выполнено",
        description: `Удалено: ${res?.deleted ?? 0}${res?.blockedIds?.length ? `. Не удалены: ${res.blockedIds.length}` : ""}`,
      });
    },
    onError: () => toast({ title: "Не удалось удалить пользователей" }),
  });

  // Violations admin list states
  const [violationsQuery, setViolationsQuery] = useState("");
  const [searchStatus, setSearchStatus] = useState("");
  const [violationsPage, setViolationsPage] = useState(1);
  const [selectedViolationIds, setSelectedViolationIds] = useState<Set<string>>(
    new Set(),
  );
  const deleteViolations = useMutation(apiClient.deleteViolationsAdmin, {
    onSuccess: async () => {
      setSelectedViolationIds(new Set());
      await Promise.all([
        queryClient.invalidateQueries({ queryKey: ["violations"] }),
        queryClient.invalidateQueries({ queryKey: ["admin-stats"] }),
      ]);
      toast({ title: "Удалено" });
    },
    onError: () => toast({ title: "Не удалось удалить" }),
  });

  const { data: violations } = useQuery<ViolationsPage>(
    [
      "violations",
      violationsQuery,
      searchStatus,
      statsFrom,
      statsTo,
      violationsPage,
    ],
    () =>
      apiClient.listViolations({
        query: violationsQuery || undefined,
        status: searchStatus || undefined,
        from: statsFrom || undefined,
        to: statsTo || undefined,
        page: violationsPage,
        pageSize: 10,
      }),
    { enabled: isAdmin, keepPreviousData: true },
  );

  if (!isAdmin) {
    return (
      <div className="max-w-4xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Доступ ограничен</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Эта страница доступна только администраторам.
            </div>
          </CardContent>
          <CardFooter>
            <NavLink to="/home">
              <Button variant="secondary">На главную</Button>
            </NavLink>
          </CardFooter>
        </Card>
      </div>
    );
  }

  return (
    <div className="max-w-6xl mx-auto p-4 sm:p-6 space-y-6">
      {!hiddenBlocks.has("settings") && (
        <Card className="card-elevated h-full">
          <CardHeader className="flex items-center justify-between">
            <CardTitle>Настройки приложения</CardTitle>
            <Button
              size="sm"
              variant="destructive"
              onClick={() => hideBlock("settings")}
            >
              Удалить выбранный блок
            </Button>
          </CardHeader>
           <CardContent className="space-y-4">
               <div className="space-y-2 border rounded-md p-3 bg-accent/20">
                 <div className="font-medium">Ремонт учетной записи</div>
                <div className="text-sm text-muted-foreground">
                  Введите email пользователя или его короткий номер (ID№), чтобы
                  проверить и при необходимости автоматически исправить типичные
                  проблемы, влияющие на работу приложения.
                </div>
                <div className="text-xs text-muted-foreground">
                  Ниже — ссылка, которую можно отправить пользователю для
                  самостоятельной проверки работы приложения. Пользователь
                  откроет её и выполнит все шаги.
                </div>
                <div className="flex flex-col sm:flex-row gap-2 sm:items-center">
                  <Input
                    readOnly
                    value={new URL("/super-admin/diagnostics", getBaseUrl()).toString()}
                  />
                  <Button
                    type="button"
                    variant="outline"
                    size="sm"
                    onClick={() => {
                      const url = new URL("/super-admin/diagnostics", getBaseUrl()).toString();
                      copy(url);
                      toast({ title: "Ссылка скопирована" });
                    }}
                  >
                    Скопировать ссылку
                  </Button>
                </div>              <div className="flex flex-col sm:flex-row gap-2 sm:items-center">
                <Input
                  placeholder="Например: user@example.com или 1234"
                  value={repairIdentifier}
                  onChange={(e) => setRepairIdentifier(e.target.value)}
                />
                <Button
                  variant="secondary"
                  disabled={
                    accountDiag.isLoading || !repairIdentifier.trim()
                  }
                  onClick={() => {
                    const ident = repairIdentifier.trim();
                    if (!ident) {
                      toast({ title: "Укажите пользователя для проверки" });
                      return;
                    }
                    accountDiag.mutate({ identifier: ident } as any);
                  }}
                >
                  {accountDiag.isLoading ? "Проверяем…" : "Проверить"}
                </Button>
                <Button
                  variant="outline"
                  disabled={
                    repairMutation.isLoading || !repairIdentifier.trim()
                  }
                  onClick={() => {
                    const ident = repairIdentifier.trim();
                    if (!ident) {
                      toast({ title: "Укажите пользователя для ремонта" });
                      return;
                    }
                    setRepairMode("normal");
                    repairMutation.mutate({ identifier: ident } as any);
                  }}
                >
                  {repairMutation.isLoading ? "Исправляем…" : "Исправить"}
                </Button>
              </div>
              <div className="space-y-1">
                <Label className="text-xs">Ввести проблему (по желанию)</Label>
                <Textarea
                  rows={2}
                  value={repairDescription}
                  onChange={(e) => setRepairDescription(e.target.value)}
                  placeholder="Опишите, в чём проявляется проблема у этого пользователя"
                />
              </div>
              <div className="flex flex-col sm:flex-row gap-2 sm:items-center">
                <Button
                  size="sm"
                  variant="default"
                  disabled={
                    repairMutation.isLoading ||
                    !repairIdentifier.trim() ||
                    !repairDescription.trim()
                  }
                  onClick={() => {
                    const ident = repairIdentifier.trim();
                    const desc = repairDescription.trim();
                    if (!ident) {
                      toast({ title: "Укажите пользователя" });
                      return;
                    }
                    if (!desc) {
                      toast({ title: "Опишите проблему" });
                      return;
                    }
                    setRepairMode("restart");
                    repairMutation.mutate({
                      identifier: ident,
                      description: desc,
                    } as any);
                  }}
                >
                  {repairMutation.isLoading
                    ? "Проверяем и исправляем…"
                    : "Проверить, исправить и запустить"}
                </Button>
              </div>
              {accountDiag.data && (
                <div className="space-y-2">
                  <div className="flex items-center gap-2">
                    <Progress
                      value={Math.max(
                        0,
                        Math.min(
                          100,
                          Number(accountDiag.data.progress ?? 0),
                        ),
                      )}
                    />
                    <span className="text-xs text-muted-foreground">
                      {Math.round(
                        Math.max(
                          0,
                          Number(accountDiag.data.etaSeconds ?? 0),
                        ),
                      ) || 0}{" "}
                      с
                    </span>
                  </div>
                  {Array.isArray((accountDiag.data as any).steps) && (
                    <div className="space-y-1 max-h-40 overflow-auto border rounded p-2 bg-background/60">
                      {(accountDiag.data as any).steps.map(
                        (
                          s: {
                            name: string;
                            status: string;
                            details?: string;
                          },
                          idx: number,
                        ) => (
                          <div key={idx} className="text-xs">
                            <span className="font-medium">{s.name}:</span>{" "}
                            <span>{s.status}</span>
                            {s.details && (
                              <div className="text-[11px] text-muted-foreground whitespace-pre-wrap">
                                {s.details}
                              </div>
                            )}
                          </div>
                        ),
                      )}
                    </div>
                  )}
                </div>
              )}
             </div>
 
             <div className="space-y-3 border rounded-md p-3 bg-accent/10">
               <div className="font-medium">Прямая ссылка на приложение</div>
               <div className="text-xs text-muted-foreground">
                 Эта ссылка открывает приложение в обычном режиме, без дополнительных токенов.
                 Полный или ограниченный доступ по‑прежнему определяется ролями пользователей
                 и режимом проверки (техработы).
               </div>
               <div className="flex flex-col sm:flex-row gap-2 sm:items-center">
                 <Input readOnly value={getBaseUrl()} />
                 <Button
                   type="button"
                   size="sm"
                   variant="outline"
                   onClick={() => {
                     const url = getBaseUrl();
                     copy(url);
                     toast({ title: "Ссылка приложения скопирована" });
                   }}
                 >
                   Скопировать ссылку приложения
                 </Button>
               </div>
               <div className="text-xs text-muted-foreground">
                 Чтобы быстро временно ограничить доступ для обычных пользователей,
                 используйте блок «Режим проверки (техработы)» в супер‑админ‑панели.
               </div>
             </div>
 
             <div className="text-sm text-muted-foreground">              Всего пользователей: {settings?.totalUsers ?? "—"}
            </div>
            {/* Информационное окно о рекомендуемом одновременном лимите и текущих активных пользователях */}{" "}
            <div className="p-3 border rounded bg-accent/20">
              <div className="font-medium mb-1">Нагрузочная информация</div>
              <div className="text-sm">
                Рекомендуемый одновременный лимит:{" "}
                <span className="font-semibold">500</span> пользователей
              </div>
              <div className="text-sm">
                Сейчас активно (за последние 7 минут):{" "}
                <span className="font-semibold">
                  {presenceAdmin?.online ?? 0}
                </span>
              </div>
            </div>
            <div className="grid sm:grid-cols-[220px,auto] gap-3 items-center">
              <Label htmlFor="userLimit">Лимит пользователей</Label>
              <div className="flex gap-2">
                <Input
                  id="userLimit"
                  type="number"
                  value={userLimitDraft ?? ""}
                  onChange={(e) =>
                    setUserLimitDraft(parseInt(e.target.value || "0", 10))
                  }
                />
                <Button
                  onClick={() =>
                    userLimitDraft &&
                    updateSettings.mutate({ userLimit: userLimitDraft })
                  }
                  disabled={updateSettings.isLoading || !userLimitDraft}
                >
                  {updateSettings.isLoading ? "Сохраняем…" : "Сохранить"}
                </Button>
              </div>
            </div>
            <div className="hr-muted w-full h-px" />
            {/* Ссылка для рассылки (регистрация/восстановление) */}
            <div className="space-y-3">
              <div className="font-medium">
                Ссылка для регистрации/восстановления
              </div>
              <div className="text-sm text-muted-foreground">
                Эту ссылку можно безопасно отправлять новым пользователям для
                регистрации и действующим пользователям для восстановления
                доступа. Она формируется автоматически и всегда указывает на
                актуальный адрес приложения.
              </div>
              <div className="flex flex-col sm:flex-row gap-2 sm:items-center">
                <Input value={loginUrl} readOnly />
                <Button variant="secondary" asChild>
                  <a href={loginUrl} target="_blank" rel="noreferrer">
                    Открыть
                  </a>
                </Button>
                <Button
                  variant="secondary"
                  onClick={() => {
                    copy(loginUrl);
                    toast({ title: "Ссылка скопирована" });
                  }}
                >
                  Копировать
                </Button>
              </div>
            </div>
            <div className="hr-muted w-full h-px" />
            {/* Блок изображения для входа с кликом по картинке на страницу входа */}
            <div className="space-y-3">
              <div className="font-medium">Изображение для страницы входа</div>
              <div className="text-sm text-muted-foreground">
                Текущее изображение будет показано на экране «Вход /
                Регистрация» на телефонах. Нажмите на картинку ниже, чтобы
                открыть страницу входа.
              </div>
              <div className="flex items-start gap-4 flex-wrap">
                {settings?.loginIllustrationUrl ? (
                  <a
                    href={loginUrl}
                    target="_blank"
                    rel="noreferrer"
                    className="block"
                  >
                    <img
                      src={settings.loginIllustrationUrl as any}
                      alt="Изображение входа"
                      className="w-40 h-40 object-contain border rounded bg-white p-2"
                    />
                  </a>
                ) : (
                  <div className="text-sm text-muted-foreground">
                    Пока изображение не задано
                  </div>
                )}
                <div className="flex flex-col gap-2 min-w-[260px]">
                  <Input
                    type="file"
                    accept="image/*"
                    onChange={async (e) => {
                      const inputEl = e.currentTarget;
                      const file = inputEl.files?.[0];
                      if (!file) return;
                      const MAX_MB = 100;
                      if (file.size > MAX_MB * 1024 * 1024) {
                        toast({
                          title: "Файл слишком большой",
                          description: `Максимум ${MAX_MB} МБ`,
                        });
                        try {
                          inputEl.value = "";
                        } catch {
                          /* ignore */
                        }
                        return;
                      }
                      const base64 = await encodeFileAsBase64DataURL(file);
                      if (!base64) {
                        toast({ title: "Не удалось прочитать файл" });
                        try {
                          inputEl.value = "";
                        } catch {
                          /* ignore */
                        }
                        return;
                      }
                      uploadIllustration.mutate({ base64, name: file.name });
                      // Сброс инпута, чтобы можно было выбрать тот же файл повторно
                      try {
                        inputEl.value = "";
                      } catch {
                        /* ignore */
                      }
                    }}
                  />
                  <div className="text-xs text-muted-foreground">
                    Формат: любое изображение, до 100 МБ
                  </div>
                </div>
              </div>
            </div>
            <div className="hr-muted w-full h-px" />
            <div className="space-y-2">
              <div className="font-medium">Памятка: подключение домена</div>
              <ol className="list-decimal list-inside text-sm text-muted-foreground space-y-1">
                <li>
                  Откройте настройки приложения (иконка «Поделиться» вверху
                  справа).
                </li>
                <li>
                  Укажите желаемый домен в поле «Custom Domain» (например,
                  app.example.com).
                </li>
                <li>
                  В панели DNS вашего регистратора создайте CNAME запись,
                  указывающую на адрес, который покажет платформа.
                </li>
                <li>
                  Дождитесь применения DNS (обычно до 24 часов). После
                  подтверждения домен станет активным.
                </li>
              </ol>
              <div className="text-xs text-muted-foreground">
                Текущая сборка: {platform?.name ? platform.name : "—"}
              </div>

              <div className="hr-muted w-full h-px" />

              <div className="space-y-2">
                <div className="font-medium">QR-код для входа</div>
                <div className="text-sm text-muted-foreground">
                  Сканируйте код для открытия страницы входа/регистрации. Ссылка
                  одинакова для всех посетителей.
                </div>
                <div className="flex items-start gap-4 flex-wrap">
                  {qrDataUrl ? (
                    <img
                      src={qrDataUrl}
                      alt="QR для входа"
                      className="w-40 h-40 border rounded bg-white p-2"
                    />
                  ) : (
                    <div className="text-sm text-muted-foreground">
                      Генерация…
                    </div>
                  )}
                  <div className="flex flex-col gap-2 min-w-[220px]">
                    <div className="text-xs text-muted-foreground break-all max-w-[320px]">
                      {loginUrl}
                    </div>
                    <div className="flex gap-2 flex-wrap">
                      <Button
                        variant="secondary"
                        onClick={() => {
                          copy(loginUrl);
                          toast({ title: "Ссылка скопирована" });
                        }}
                      >
                        Копировать ссылку
                      </Button>
                      <Button
                        variant="secondary"
                        onClick={() => {
                          if (!qrDataUrl) return;
                          const a = document.createElement("a");
                          a.href = qrDataUrl;
                          a.download = "qr-login.png";
                          document.body.appendChild(a);
                          a.click();
                          a.remove();
                        }}
                      >
                        Скачать PNG
                      </Button>
                    </div>
                  </div>
                </div>
              </div>

                 <div className="hr-muted w-full h-px" />

              {/* Гостевые демо‑ссылки */}
              <div className="space-y-2">
                <div className="font-medium">Гостевая демо‑ссылка</div>
                <div className="text-sm text-muted-foreground">
                  Создайте ссылку для гостей без регистрации. Можно задать срок действия и ограничение по числу входов. По ссылке откроется демо‑версия главной страницы.
                </div>
                <GuestDemoLinkPanel />
              </div>

              <div className="hr-muted w-full h-px" />

               {/* Offline link block */}
               <div className="space-y-2">                <div className="font-medium">Офлайн‑ссылка для входа</div>
                <div className="text-sm text-muted-foreground">
                  Откройте ссылку при наличии интернета и добавьте страницу на
                  экран устройства — после этого её можно запускать без сети;
                  данные синхронизируются автоматически при подключении.
                </div>
                <div className="flex items-start gap-4 flex-wrap">
                  <div className="flex flex-col gap-2 min-w-[280px]">
                    <div className="text-xs text-muted-foreground break-all max-w-[420px]">
                      {new URL("/home?offline=1", getBaseUrl()).toString()}
                    </div>
                    <div className="flex gap-2 flex-wrap">
                      <Button
                        variant="secondary"
                        onClick={() => {
                          const url = new URL(
                            "/home?offline=1",
                            getBaseUrl(),
                          ).toString();
                          copy(url);
                          toast({ title: "Офлайн‑ссылка скопирована" });
                        }}
                      >
                        Копировать офлайн‑ссылку
                      </Button>
                      <Button
                        variant="secondary"
                        disabled={sendOfflineLink.isLoading}
                        onClick={() => sendOfflineLink.mutate({})}
                      >
                        {sendOfflineLink.isLoading
                          ? "Отправляем…"
                          : "Разослать админам"}
                      </Button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </CardContent>
        </Card>
      )}

      {!hiddenBlocks.has("user-registration") && (
        <Card className="card-elevated h-full">
          <CardHeader className="flex items-center justify-between">
            <CardTitle>Регистрация нового пользователя</CardTitle>
            <Button
              size="sm"
              variant="destructive"
              onClick={() => hideBlock("user-registration")}
            >
              Удалить выбранный блок
            </Button>
          </CardHeader>
          <CardContent className="space-y-3">
            <div className="grid sm:grid-cols-[220px,auto] gap-3 items-center">
              <Label>Email</Label>
              <Input
                value={regEmail}
                onChange={(e) => setRegEmail(e.target.value)}
                placeholder="user@example.com"
              />
              <Label>ФИО</Label>
              <Input
                value={regFullName}
                onChange={(e) => setRegFullName(e.target.value)}
                placeholder="Иванов Иван Иванович"
              />
              <Label>Компания</Label>
              <Input
                value={regCompany}
                onChange={(e) => setRegCompany(e.target.value)}
                placeholder="ООО «Компания»"
              />
              <Label>Подразделение</Label>
              <Input
                value={regDepartment}
                onChange={(e) => setRegDepartment(e.target.value)}
                placeholder="(необязательно)"
              />
              <Label>Должность</Label>
              <Input
                value={regJobTitle}
                onChange={(e) => setRegJobTitle(e.target.value)}
                placeholder="Инженер"
              />
            </div>
            <div className="flex gap-2 flex-wrap items-center">
              <Button
                disabled={
                  sendReg.isLoading ||
                  !regEmail ||
                  !regFullName ||
                  !regCompany ||
                  !regJobTitle
                }
                onClick={() =>
                  sendReg.mutate({
                    email: regEmail.trim(),
                    fullName: regFullName.trim(),
                    company: regCompany.trim(),
                    department: regDepartment.trim() || undefined,
                    jobTitle: regJobTitle.trim(),
                  })
                }
              >
                {sendReg.isLoading
                  ? "Отправляем…"
                  : "Зарегистрировать и отправить ссылку"}
              </Button>
              <Button
                variant="secondary"
                onClick={() => {
                  setRegEmail("");
                  setRegFullName("");
                  setRegCompany("");
                  setRegDepartment("");
                  setRegJobTitle("");
                  setRegSubmitted(false);
                  setRegQr("");
                }}
              >
                Сбросить
              </Button>
            </div>

            {regSubmitted && (
              <div className="p-3 border rounded space-y-2">
                <div className="font-medium">Ссылка для входа</div>
                <div className="text-xs text-muted-foreground break-all">
                  {welcomeUrl}
                </div>
                <div className="flex gap-2 flex-wrap">
                  <Button
                    variant="secondary"
                    onClick={() => {
                      copy(welcomeUrl);
                      toast({ title: "Ссылка скопирована" });
                    }}
                  >
                    Копировать
                  </Button>
                  <Button
                    variant="secondary"
                    onClick={() =>
                      downloadTxt(welcomeUrl + "\n", "login-link.txt")
                    }
                  >
                    Скачать .txt
                  </Button>
                  <Button
                    variant="secondary"
                    disabled={!regQr}
                    onClick={() => {
                      if (!regQr) return;
                      const a = document.createElement("a");
                      a.href = regQr;
                      a.download = "login-qr.png";
                      document.body.appendChild(a);
                      a.click();
                      a.remove();
                    }}
                  >
                    Скачать QR
                  </Button>
                  <Button
                    variant="secondary"
                    disabled={sendReg.isLoading}
                    onClick={() =>
                      sendReg.mutate({
                        email: regEmail.trim(),
                        fullName: regFullName.trim() || "(без имени)",
                        company: regCompany.trim() || "(без компании)",
                        department: regDepartment.trim() || undefined,
                        jobTitle: regJobTitle.trim() || "(без должности)",
                      })
                    }
                  >
                    Отправить на email
                  </Button>
                </div>
                {regQr ? (
                  <img
                    src={regQr}
                    alt="QR"
                    className="w-32 h-32 border rounded bg-white p-2"
                  />
                ) : (
                  <div className="text-xs text-muted-foreground">
                    Генерация QR…
                  </div>
                )}
              </div>
            )}
          </CardContent>
        </Card>
      )}

      {!hiddenBlocks.has("quick") && (
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Быстрые действия</CardTitle>
          </CardHeader>
          <CardContent>
            {(() => {
                 const actions = [
                  { label: "Пользователи", to: "/admin/users" },
                  { label: "Информация", to: "/admin/info" },                  { label: "Установочный файл", to: "/installer" },
                  { label: "Управление журналом поручений", to: "/assignments/table" },                {
                  label: "Хранение электронных документов",
                  to: "/admin/edocs",
                  _isBlue: true,
                },
                { label: "Отчет для УД", to: "/admin/ud-report" },
                { label: "Отчет для УД ЮА", to: "/admin/ud-ua-report" },
                {
                  label: "Управление главной страницей",
                  to: "/admin/home-management",
                },
                {
                  label: "Управление Графиком личных показателей ПАБ",
                  to: "/admin/pab-kpi-schedule",
                },
                { label: "Сводные диаграммы", to: "/admin/summary-charts" },
                { label: "Управление службой поддержки", to: "/admin/support" },
                { label: "Управление хранилищем", to: "/admin/storage" },
                { label: "Конструктор форм", to: "/admin/form-builder" },
                { label: "Конструктор", to: "/constructor" },
                { label: "Реестр предписаний", to: "/admin/prescriptions" },
                { label: "Создать", to: "/admin/illustration" },
                { label: "Статистика посещений ИТР", to: "/admin/itr-visits" },
                { label: "Управление Статистика нарушений", to: "/stats" },
                { label: "Обучение админ", to: "/admin/training" },
                { label: "Инструкция ПАБ", to: "/admin/pab-instruction" },
                { label: "Рассылка сообщений", to: "/admin/messaging" },
                { label: "ПК", to: "/admin/pc" },
                { label: "Электронная выдача ПК", to: "/admin/pc-akt" },
                { label: "Учет блоком ПК", to: "/admin/pc-report" },
                { label: "Сравнить", to: "/admin/compare" },
                { label: "Библиотека рабочих страниц", to: "/admin/pages-library" },
                { label: "Безопасные дни", to: "/admin/safe-days" },
              ].sort((a, b) =>
                a.label.localeCompare(b.label, "ru", { sensitivity: "base" }),
              );
              const longest = actions.reduce(
                (m, a) => Math.max(m, a.label.length),
                0,
              );
              const btnStyle: React.CSSProperties = {
                width: `calc(${Math.max(longest, 8)}ch + 2rem)`,
              };

              const columns = Array.from({ length: 3 }, (_, i) =>
                actions.slice(i * 10, i * 10 + 10),
              );
              return (
                <div className="grid grid-cols-1 md:grid-cols-3 gap-3 items-start">
                  {columns.map((col, idx) => (
                    <div key={idx} className="flex flex-col gap-2 items-start">
                      {col.map((a) => (
                        <NavLink key={a.to} to={a.to}>
                          <Button
                            variant="secondary"
                            style={btnStyle}
                            className={`justify-start ${a.to === "/admin/edocs" ? "bg-blue-600 hover:bg-blue-700 text-white" : ""} ${a.to === "/admin/compare" ? "bg-yellow-500 hover:bg-yellow-600 text-black" : ""}`}
                          >
                            {" "}
                            {a.label}
                          </Button>
                        </NavLink>
                      ))}
                    </div>
                  ))}
                </div>
              );
            })()}
          </CardContent>
        </Card>
      )}

      {/* Reports hub */}
      {!hiddenBlocks.has("reports-hub") && (
        <Card className="card-elevated h-full">
          <CardHeader className="flex items-center justify-between">
            <CardTitle>Отчеты</CardTitle>
            <Button size="sm" variant="destructive" onClick={() => hideBlock("reports-hub")}>
              Удалить выбранный блок
            </Button>
          </CardHeader>
          <CardContent>
            <div className="flex flex-wrap gap-2">
              <NavLink to="/admin/ud-report"><Button variant="secondary">Отчет для УД</Button></NavLink>
              <NavLink to="/admin/ud-ua-report"><Button variant="secondary">Отчет для УД ЮА</Button></NavLink>
              <NavLink to="/admin/medicine"><Button variant="secondary">Отчет по Медицине</Button></NavLink>
              <NavLink to="/reports"><Button variant="secondary">Промежуточные отчеты</Button></NavLink>
              <NavLink to="/kbt/report"><Button variant="secondary">Отчет КБТ</Button></NavLink>
              <NavLink to="/admin/kbt"><Button variant="secondary">Управление КБТ</Button></NavLink>
              {isAdmin && (
                <NavLink to="/admin/intro-briefings">
                  <Button variant="secondary">Учет ВВОДНЫХ ИНСТРУКТАЖЕЙ</Button>
                </NavLink>
              )}
            </div>
          </CardContent>
        </Card>
      )}
      {/* Admin violations stats block */}
      {!hiddenBlocks.has("admin-stats") && (
        <Card className="card-elevated h-full">
          {" "}
          <CardHeader className="flex items-center justify-between">
            <CardTitle>Статистика нарушений (админ)</CardTitle>
            <div className="flex gap-2">
              <Input
                type="date"
                value={statsFrom}
                onChange={(e) => setStatsFrom(e.target.value)}
              />
              <Input
                type="date"
                value={statsTo}
                onChange={(e) => setStatsTo(e.target.value)}
              />
              {/* Кнопка "Обновить" скрыта по запросу */}
            </div>
          </CardHeader>
          <CardContent className="space-y-4">
            {adminStats ? (
              <>
                <div className="grid grid-cols-2 md:grid-cols-6 gap-3">
                  <div className="p-3 border rounded">
                    <div className="text-xs text-muted-foreground">Всего</div>
                    <div className="text-2xl font-semibold text-stats-total">
                      {adminStats.total}
                    </div>
                  </div>
                  <div className="p-3 border rounded">
                    <div className="text-xs text-muted-foreground">
                      Устранено
                    </div>
                    <div className="text-2xl font-semibold text-green-600">
                      {adminStats.resolved}
                    </div>
                  </div>
                  <div className="p-3 border rounded">
                    <div className="text-xs text-muted-foreground">
                      В работе
                    </div>
                    <div className="text-2xl font-semibold text-blue-600">
                      {adminStats.inProgress}
                    </div>
                  </div>
                  <div className="p-3 border rounded">
                    <div className="text-xs text-muted-foreground">
                      Просрочено
                    </div>
                    <div className="text-2xl font-semibold text-red-600">
                      {adminStats.overdue}
                    </div>
                  </div>
                  <div className="p-3 border rounded">
                    <div className="text-xs text-muted-foreground">
                      Наблюдений
                    </div>
                    <div className="text-2xl font-semibold">
                      {adminStats.observationsTotal}
                    </div>
                  </div>
                  <div className="p-3 border rounded">
                    <div className="text-xs text-muted-foreground">Аудитов</div>
                    <div className="text-2xl font-semibold">
                      {adminStats.auditsTotal}
                    </div>
                  </div>
                </div>
              </>
            ) : (
              <div className="text-sm text-muted-foreground">Нет данных</div>
            )}
          </CardContent>
          <CardFooter className="flex gap-2">
            <Button
              variant="secondary"
              disabled={exportStatsExcel.isLoading}
              onClick={() =>
                exportStatsExcel.mutate({
                  from: statsFrom || undefined,
                  to: statsTo || undefined,
                })
              }
            >
              Скачать Excel
            </Button>
            <Button
              variant="secondary"
              disabled={exportStatsDocx.isLoading}
              onClick={() =>
                exportStatsDocx.mutate({
                  from: statsFrom || undefined,
                  to: statsTo || undefined,
                })
              }
            >
              Скачать Word
            </Button>
          </CardFooter>
        </Card>
      )}
      {/* Violations editor */}
      {!hiddenBlocks.has("violations-editor") && (
        <Card className="card-elevated h-full">
          {" "}
          <CardHeader className="flex items-center justify-between">
            <CardTitle>Нарушения (редактирование)</CardTitle>
            <div className="grid grid-cols-1 md:grid-cols-5 gap-2 w-full md:w-auto">
              <Input
                type="date"
                value={statsFrom}
                onChange={(e) => setStatsFrom(e.target.value)}
              />
              <Input
                type="date"
                value={statsTo}
                onChange={(e) => setStatsTo(e.target.value)}
              />
              <Input
                placeholder="Статус"
                value={searchStatus}
                onChange={(e) => setSearchStatus(e.target.value)}
              />
              <Input
                placeholder="Поиск"
                value={violationsQuery}
                onChange={(e) => {
                  setViolationsQuery(e.target.value);
                  setViolationsPage(1);
                }}
              />
              <Button
                variant="secondary"
                onClick={() => {
                  /* refetch via deps */
                }}
              >
                Обновить
              </Button>
            </div>
          </CardHeader>
          <CardContent className="space-y-3">
            <div className="border rounded-md overflow-hidden">
              <div className="flex items-center justify-between mb-2">
                <div className="text-sm text-muted-foreground">
                  Выбрано: {Array.from(selectedViolationIds).length}
                </div>
                <div className="flex gap-2">
                  <Button
                    variant="secondary"
                    onClick={() => {
                      if (!violations?.items) return;
                      setSelectedViolationIds(
                        new Set(violations.items.map((x: any) => x.id)),
                      );
                    }}
                  >
                    Выбрать все на странице
                  </Button>
                  <Button
                    variant="destructive"
                    disabled={
                      Array.from(selectedViolationIds).length === 0 ||
                      deleteViolations.isLoading
                    }
                    onClick={() => {
                      const ids = Array.from(selectedViolationIds);
                      if (ids.length === 0) return;
                      if (
                        !confirm(
                          "Удалить выбранные нарушения? Это действие необратимо.",
                        )
                      )
                        return;
                      deleteViolations.mutate({ ids });
                    }}
                  >
                    Удалить выбранные
                  </Button>
                </div>
              </div>
              <div className="grid grid-cols-6 gap-2 bg-secondary px-3 py-2 text-sm">
                <div>Дата</div>
                <div>Подразделение/участок</div>
                <div>Объект</div>
                <div>Статус</div>
                <div>Срок</div>
                <div>Действия</div>
              </div>
              <div>
                {violations?.items?.map((v: any) => (
                  <div
                    key={v.id}
                    className="grid grid-cols-6 gap-2 px-3 py-2 border-t text-sm items-center"
                  >
                    <div>{new Date(v.date).toISOString().slice(0, 10)}</div>
                    <div className="truncate">
                      {v.shop}/{v.section}
                    </div>
                    <div className="truncate">{v.objectInspected}</div>
                    <div className="truncate">{v.status || "—"}</div>
                    <div>
                      {v.dueDate
                        ? new Date(v.dueDate).toISOString().slice(0, 10)
                        : "—"}
                    </div>
                    <div className="flex gap-2 items-center">
                      <Checkbox
                        checked={selectedViolationIds.has(v.id)}
                        onCheckedChange={(checked: boolean) => {
                          setSelectedViolationIds((prev) => {
                            const next = new Set(prev);
                            if (checked) next.add(v.id);
                            else next.delete(v.id);
                            return next;
                          });
                        }}
                      />
                      <ViolationEditDialog
                        v={v}
                        onSaved={() =>
                          queryClient.invalidateQueries({
                            queryKey: ["violations"],
                          })
                        }
                      />
                    </div>
                  </div>
                ))}
                {!violations?.items?.length && (
                  <div className="px-3 py-6 text-sm text-muted-foreground">
                    Нет данных
                  </div>
                )}
              </div>
            </div>
            <div className="flex justify-between items-center text-sm text-muted-foreground">
              <div>Стр. {violations?.page ?? 1}</div>
              <div className="flex gap-2">
                <Button
                  variant="secondary"
                  disabled={(violations?.page ?? 1) <= 1}
                  onClick={() => setViolationsPage((p) => Math.max(1, p - 1))}
                >
                  Назад
                </Button>
                <Button
                  variant="secondary"
                  disabled={
                    !!violations &&
                    violations.page * violations.pageSize >= violations.total
                  }
                  onClick={() => setViolationsPage((p) => p + 1)}
                >
                  Вперёд
                </Button>
              </div>
            </div>
          </CardContent>
        </Card>
      )}
      {/* Monetization */}
      {!hiddenBlocks.has("monetization") && (
        <Card className="card-elevated h-full">
          {" "}
          <CardHeader>
            <CardTitle>Монетизация</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="grid sm:grid-cols-[220px,auto] gap-3 items-center">
              <Label>Название</Label>
              <Input
                value={prodName}
                onChange={(e) => setProdName(e.target.value)}
                placeholder="Например: Базовый доступ"
              />

              <Label>Описание</Label>
              <Input
                value={prodDesc}
                onChange={(e) => setProdDesc(e.target.value)}
                placeholder="Краткое описание"
              />

              <Label>Тип</Label>
              <select
                className="border rounded h-9 px-2"
                value={kind}
                onChange={(e) => setKind(e.target.value as any)}
              >
                <option value="SUBSCRIPTION">Подписка</option>
                <option value="IN_APP_PURCHASE">Разовый платёж</option>
              </select>

              <Label>Цена, ₽</Label>
              <Input
                type="number"
                step="0.01"
                value={priceRub}
                onChange={(e) => setPriceRub(e.target.value)}
                placeholder="Напр. 9.99"
              />
            </div>
            <Button
              disabled={
                createProductMutation.isLoading || !prodName || !priceRub
              }
              onClick={() => {
                const rub = parseInt(priceRub.replace(/\D/g, ""), 10);
                if (isNaN(rub) || rub <= 0) {
                  toast({ title: "Введите корректную цену" });
                  return;
                }
                createProductMutation.mutate({
                  name: prodName,
                  description: prodDesc,
                  priceRub: rub,
                  kind,
                });
              }}
            >
              {createProductMutation.isLoading ? "Создаём…" : "Создать продукт"}
            </Button>

            <div className="hr-muted w-full h-px" />

            <div>
              <div className="font-medium mb-2">Активные продукты</div>
              <div className="space-y-2">
                {products?.length ? (
                  products.map((p: any) => (
                    <div
                      key={p.id}
                      className="flex items-center justify-between px-3 py-2 border rounded"
                    >
                      <div className="min-w-0">
                        <div className="font-medium truncate">{p.name}</div>
                        <div className="text-xs text-muted-foreground truncate">
                          {p.description}
                        </div>
                        <div className="text-xs text-muted-foreground">
                          {p.kind === "SUBSCRIPTION"
                            ? "Подписка"
                            : "Разовый платёж"}{" "}
                          · {p.priceRub} ₽
                        </div>
                      </div>
                      <div className="flex items-center gap-2">
                        <span className="hidden" />
                        <Button
                          variant="secondary"
                          onClick={async () => {
                            const res = await apiClient.createPaymentLinkRUB({
                              productId: p.id,
                            });
                            if (res?.ok && res.paymentUrl) {
                              try {
                                window.open(
                                  res.paymentUrl,
                                  "_blank",
                                  "noopener",
                                );
                              } catch {
                                /* ignore */
                              }
                            } else {
                              toast({
                                title: "Оплата недоступна",
                                description:
                                  res?.error === "MISSING_CONFIG"
                                    ? "Не настроены ключи Тинькофф"
                                    : "Попробуйте позже",
                              });
                            }
                          }}
                        >
                          Ссылка на оплату
                        </Button>
                        <Button
                          variant="secondary"
                          onClick={async () => {
                            const res =
                              await apiClient.createYooKassaPaymentLinkRUB({
                                productId: p.id,
                              });
                            if (res?.ok && res.paymentUrl) {
                              try {
                                window.open(
                                  res.paymentUrl,
                                  "_blank",
                                  "noopener",
                                );
                              } catch {
                                /* ignore */
                              }
                            } else {
                              toast({
                                title: "Оплата недоступна",
                                description:
                                  res?.error === "MISSING_CONFIG"
                                    ? "Не настроены ключи YooKassa"
                                    : "Попробуйте позже",
                              });
                            }
                          }}
                        >
                          Оплатить (YooKassa)
                        </Button>
                        <Button
                          variant="outline"
                          disabled={discontinueMutation.isLoading}
                          onClick={() =>
                            discontinueMutation.mutate({ productId: p.id })
                          }
                        >
                          Отключить
                        </Button>
                      </div>
                    </div>
                  ))
                ) : (
                  <div className="text-sm text-muted-foreground">
                    Пока нет активных продуктов
                  </div>
                )}
              </div>
            </div>
          </CardContent>
        </Card>
      )}
      {!hiddenBlocks.has("users") && (
        <Card className="card-elevated h-full">
          <CardHeader className="flex items-center justify-between">
            <CardTitle>Пользователи</CardTitle>
            <Button
              size="sm"
              variant="destructive"
              onClick={() => hideBlock("users")}
            >
              Удалить выбранный блок
            </Button>
          </CardHeader>{" "}
          <CardContent className="space-y-4">
            <div className="flex gap-2">
              <Input
                placeholder="Поиск по имени, email, компании"
                value={search}
                onChange={(e) => {
                  setSearch(e.target.value);
                  setPage(1);
                }}
              />
            </div>

            <div className="border rounded-md overflow-hidden">
              <div className="flex items-center justify-between mb-2">
                <div className="text-sm text-muted-foreground">
                  Выбрано: {Array.from(selectedUserIds).length}
                </div>
                <div className="flex gap-2">
                  <Button
                    variant="secondary"
                    onClick={() => {
                      if (!users?.items) return;
                      setSelectedUserIds(
                        new Set(users.items.map((u: any) => u.id)),
                      );
                    }}
                  >
                    Выбрать все на странице
                  </Button>
                  <Button
                    variant="destructive"
                    disabled={
                      Array.from(selectedUserIds).length === 0 ||
                      deleteUsers.isLoading
                    }
                    onClick={() => {
                      const ids = Array.from(selectedUserIds);
                      if (ids.length === 0) return;
                      if (
                        !confirm(
                          "Удалить выбранных пользователей? Удалятся только те, у кого нет связанных данных.",
                        )
                      )
                        return;
                      deleteUsers.mutate({ ids });
                    }}
                  >
                    Удалить выбранных
                  </Button>
                </div>
              </div>
              <div className="grid grid-cols-4 gap-2 bg-secondary px-3 py-2 text-sm">
                <div>ФИО</div>
                <div>Email</div>
                <div>Компания</div>
                <div>Роль</div>
              </div>
              <div>
                {users?.items?.map((u: any) => (
                  <div
                    key={u.id}
                    className="grid grid-cols-4 gap-2 px-3 py-2 border-t text-sm items-center"
                  >
                    <div className="flex items-center gap-2">
                      <span className="text-muted-foreground whitespace-nowrap">
                        ID№ {u.shortId ?? "—"}
                      </span>
                      <span>{u.fullName || "—"}</span>
                    </div>
                    <div className="truncate">{u.email || "—"}</div>
                    <div>{u.company || "—"}</div>
                    <div className="flex items-center gap-2 flex-wrap print-hidden">
                      {" "}
                      <Checkbox
                        checked={selectedUserIds.has(u.id)}
                        onCheckedChange={(checked: boolean) => {
                          setSelectedUserIds((prev) => {
                            const next = new Set(prev);
                            if (checked) next.add(u.id);
                            else next.delete(u.id);
                            return next;
                          });
                        }}
                      />
                      <Badge variant={u.isAdmin ? "secondary" : "outline"}>
                        {u.isAdmin ? "Админ" : "Пользователь"}
                      </Badge>
                      {u.isBlocked && (
                        <Badge variant="destructive">Заблокирован</Badge>
                      )}
                      {!u.isBlocked && (u.accessFrom || u.accessTo) && (
                        <Badge variant="outline">Окно доступа</Badge>
                      )}
                      {u.id !== me?.id && (
                        <Button
                          size="sm"
                          variant="secondary"
                          onClick={() =>
                            setAdmin.mutate({
                              userId: u.id,
                              isAdmin: !u.isAdmin,
                            })
                          }
                          disabled={setAdmin.isLoading}
                        >
                          {u.isAdmin ? "Снять права" : "Сделать админом"}
                        </Button>
                      )}
                      <Button size="sm" variant="secondary" asChild>
                        <a
                          href={`/home?as=${u.id}`}
                          target="_blank"
                          rel="noreferrer"
                        >
                          Войти как
                        </a>
                      </Button>
                      <UserEditDialog
                        user={u}
                        onSaved={() =>
                          queryClient.invalidateQueries({ queryKey: ["users"] })
                        }
                      />
                      <UserAccessManager
                        user={u}
                        onSaved={() =>
                          queryClient.invalidateQueries({ queryKey: ["users"] })
                        }
                      />
                      {needsAttentionUser(u) && (
                        <UserInfoIssueDialog user={u} />
                      )}
                    </div>
                  </div>
                ))}
                {!users?.items?.length && (
                  <div className="px-3 py-6 text-sm text-muted-foreground">
                    Нет данных
                  </div>
                )}
              </div>
            </div>

            <div className="flex justify-between items-center text-sm text-muted-foreground">
               <div className="flex items-center gap-3">
                 <span>Стр. {users?.page ?? 1}</span>
                 <Button
                   variant="secondary"
                   onClick={async () => {
                     try {
                       const res = await apiClient.exportUsersExcel();
                       if (res?.url) {
                         window.open(res.url, "_blank");
                       }
                     } catch (e) {
                       console.error(e);
                     }
                   }}
                 >
                   Скачать Excel
                 </Button>
               </div>
               <div className="flex gap-2">                <Button
                  variant="secondary"
                  disabled={(users?.page ?? 1) <= 1}
                  onClick={() => setPage((p) => Math.max(1, p - 1))}
                >
                  Назад
                </Button>
                <Button
                  variant="secondary"
                  disabled={
                    !!users && users.page * users.pageSize >= users.total
                  }
                  onClick={() => setPage((p) => p + 1)}
                >
                  Вперёд
                </Button>
              </div>
            </div>
          </CardContent>
        </Card>
      )}
      {/* Управление хранилищем (админ) */}
      {!hiddenBlocks.has("admin-storage") && (
        <AdminStorageManager onDeleteBlock={() => hideBlock("admin-storage")} />
      )}
    </div>
  );
}

// Страница: Хранение электронных документов (админ)
function AdminElectronicDocsScreen() {
  const auth = useAuth({ required: true });
  const { data: me } = useQuery<Profile>(
    ["me"],
    () => apiClient.getMyProfile(),
    {
      enabled: auth.status === "authenticated",
    },
  );
  const isAdmin = !!me?.isAdmin;
  const { toast } = useToast();
  const [folderId, setFolderId] = useState<string | null>(null);

  const { data: listing, isInitialLoading } = useQuery(
    ["edocs-storage", folderId],
    () => apiClient.listStorage({ folderId }),
    { enabled: isAdmin, staleTime: 30_000 },
  );

  const emailDoc = useMutation(apiClient.emailElectronicDoc, {
    onSuccess: () => toast({ title: "Отправлено на email" }),
    onError: () => toast({ title: "Не удалось отправить" }),
  });

  const docs = useMemo(() => {
    const exts = [".html", ".htm", ".pdf", ".docx", ".xlsx"]; // базовый фильтр
    const items = Array.isArray((listing as any)?.files)
      ? (listing as any).files
      : [];
    return items.filter((it: any) => {
      const url: string = (it?.url || it?.fileUrl || "") as string;
      const name: string = (it?.name || it?.fileName || url) as string;
      const lower = (name || url || "").toLowerCase();
      return exts.some((e) => lower.endsWith(e));
    });
  }, [listing]);

  if (!isAdmin) {
    return (
      <div className="max-w-4xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Доступ ограничен</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Эта страница доступна только администраторам.
            </div>
          </CardContent>
          <CardFooter>
            <NavLink to="/home">
              <Button variant="secondary">На главную</Button>
            </NavLink>
          </CardFooter>
        </Card>
      </div>
    );
  }

  return (
    <div className="max-w-6xl mx-auto p-4 sm:p-6 space-y-6">
      {/* Особый блок */}
      <div className="rounded-xl border-2 border-blue-600 bg-blue-50 dark:bg-blue-950/30 p-4 sm:p-6">
        <div className="flex items-center justify-between gap-3 flex-wrap">
          <div>
            <div className="text-xl font-semibold text-blue-700 dark:text-blue-300">
              Хранение электронных документов
            </div>
            <div className="text-sm text-blue-800/80 dark:text-blue-200/80 mt-1">
              Здесь собраны HTML‑формы и электронные файлы. Их можно посмотреть,
              распечатать и отправить на почту.
            </div>
          </div>
          <div className="flex gap-2">
            <NavLink to="/admin">
              <Button variant="secondary">Назад в админку</Button>
            </NavLink>
          </div>
        </div>
      </div>

      <Card className="card-elevated">
        <CardHeader className="flex items-center justify-between">
          <CardTitle>Документы</CardTitle>
        </CardHeader>
        <CardContent className="space-y-3">
          {(listing as any)?.breadcrumbs?.length ? (
            <div className="flex flex-wrap gap-2 mb-2">
              {(listing as any).breadcrumbs.map((bc: any, i: number) => (
                <Button
                  key={i}
                  variant="ghost"
                  onClick={() => setFolderId(bc.id ?? null)}
                >
                  {bc.name}
                </Button>
              ))}
            </div>
          ) : null}
          {(listing as any)?.folders?.length ? (
            <div className="flex flex-wrap gap-2 mb-2">
              {(listing as any).folders.map((f: any) => (
                <Button
                  key={f.id}
                  variant="secondary"
                  onClick={() => setFolderId(f.id)}
                >
                  {f.name}
                  {f._count?.files ? ` (${f._count.files})` : ""}
                </Button>
              ))}
            </div>
          ) : null}
          {isInitialLoading ? (
            <div className="text-sm text-muted-foreground">Загрузка…</div>
          ) : docs.length ? (
            <div className="divide-y">
              {docs.map((d: any, idx: number) => {
                const url: string = (d?.url || d?.fileUrl || "") as string;
                const name: string = (d?.name || d?.fileName || url) as string;
                return (
                  <div
                    key={idx}
                    className="py-3 flex items-center justify-between gap-3 flex-wrap"
                  >
                    <div className="min-w-0">
                      <div className="font-medium truncate max-w-[60vw]">
                        {name}
                      </div>
                      <div className="text-xs text-muted-foreground truncate max-w-[60vw]">
                        {url}
                      </div>
                    </div>
                    <div className="flex gap-2 flex-wrap">
                      <Button
                        variant="secondary"
                        onClick={() => {
                          try {
                            window.open(url, "_blank", "noopener");
                          } catch {}
                        }}
                      >
                        Открыть
                      </Button>
                      <Button
                        variant="secondary"
                        onClick={() => {
                          try {
                            const w = window.open(url, "_blank", "noopener");
                            setTimeout(() => {
                              try {
                                w && w.print && w.print();
                              } catch {}
                            }, 1000);
                          } catch {}
                        }}
                      >
                        Печать
                      </Button>
                      <Button
                        className="bg-blue-600 hover:bg-blue-700 text-white"
                        disabled={emailDoc.isLoading}
                        onClick={() => emailDoc.mutate({ url, name })}
                      >
                        Отправить на почту
                      </Button>
                    </div>
                  </div>
                );
              })}
            </div>
          ) : (
            <div className="text-sm text-muted-foreground">
              Нет подходящих документов
            </div>
          )}
        </CardContent>
      </Card>
    </div>
  );
}

function AdminStorageManager({
  onDeleteBlock,
  showBackToHome,
}: {
  onDeleteBlock?: () => void;
  showBackToHome?: boolean;
}) {
  const { toast } = useToast();
  const navigate = useNavigate();
  const queryClient = useQueryClient();
  const [folderId, setFolderId] = useState<string | null>(null);
  const [selectedFolderIds, setSelectedFolderIds] = useState<Set<string>>(
    new Set(),
  );
  const [selectedFileIds, setSelectedFileIds] = useState<Set<string>>(
    new Set(),
  );
  const [targetFolderId, setTargetFolderId] = useState<string>("");

  const { data: listing, isFetching } = useQuery(
    ["adminStorage", folderId],
    () => apiClient.listStorage({ folderId }),
  );

  const deleteFiles = useMutation(apiClient.deleteStorageFiles, {
    onSuccess: async (res: { ok: boolean; deleted: number }) => {
      await queryClient.invalidateQueries({ queryKey: ["adminStorage"] });
      setSelectedFileIds(new Set());
      toast({ title: `Удалено файлов: ${res.deleted}` });
    },
    onError: () => toast({ title: "Не удалось удалить файлы" }),
  });

  const deleteFolders = useMutation(apiClient.deleteStorageFolders, {
    onSuccess: async (res: {
      ok: boolean;
      deleted: number;
      blockedIds: string[];
    }) => {
      await queryClient.invalidateQueries({ queryKey: ["adminStorage"] });
      setSelectedFolderIds(new Set());
      toast({
        title: `Удалено папок: ${res.deleted}`,
        description: res.blockedIds?.length
          ? `Не удалены (не пустые): ${res.blockedIds.length}`
          : undefined,
      });
    },
    onError: () => toast({ title: "Не удалось удалить папки" }),
  });

  const moveFile = useMutation(apiClient.moveStorageFile, {
    onSuccess: async () => {
      await queryClient.invalidateQueries({ queryKey: ["adminStorage"] });
    },
  });

  const bulkMoveSelected = async () => {
    const target = targetFolderId || null;
    const ids = Array.from(selectedFileIds);
    if (!ids.length) return;
    await Promise.all(
      ids.map((id) =>
        moveFile.mutateAsync({ fileId: id, targetFolderId: target }),
      ),
    );
    setSelectedFileIds(new Set());
    toast({ title: "Перемещено" });
  };

  return (
    <Card className="card-elevated h-full">
      <CardHeader className="flex items-center justify-between">
        <CardTitle>Управление хранилищем</CardTitle>
        <div className="flex items-center gap-2">
          <span className="hidden" />
          {showBackToHome && (
            <Button
              size="sm"
              variant="secondary"
              onClick={() => navigate("/home")}
            >
              Назад на главную страницу
            </Button>
          )}
          {onDeleteBlock && (
            <Button size="sm" variant="destructive" onClick={onDeleteBlock}>
              Удалить выбранный блок
            </Button>
          )}
          <Button
            size="sm"
            variant="secondary"
            onClick={() => setFolderId(null)}
          >
            Корень
          </Button>
          {listing?.breadcrumbs?.slice(1).map((b: any) => (
            <Button
              key={b.id ?? "root"}
              size="sm"
              variant="ghost"
              onClick={() => setFolderId(b.id)}
            >
              {b.name}
            </Button>
          ))}
        </div>
      </CardHeader>
      <CardContent className="space-y-4">
        <div className="grid md:grid-cols-2 gap-4">
          {/* Папки */}
          <div>
            <div className="flex items-center justify-between mb-2">
              <div className="font-medium">Папки</div>
              <div className="text-sm text-muted-foreground">
                Выбрано: {selectedFolderIds.size}
              </div>
            </div>
            <div className="space-y-2">
              {listing?.folders?.map((f: any) => (
                <div
                  key={f.id}
                  className="flex items-center justify-between px-3 py-2 border rounded"
                >
                  <div className="flex items-center gap-2 min-w-0">
                    <Checkbox
                      checked={selectedFolderIds.has(f.id)}
                      onCheckedChange={(checked: boolean) => {
                        setSelectedFolderIds((prev) => {
                          const next = new Set(prev);
                          if (checked) next.add(f.id);
                          else next.delete(f.id);
                          return next;
                        });
                      }}
                    />
                    <button
                      className="text-left truncate hover:underline"
                      onClick={() => setFolderId(f.id)}
                    >
                      <FolderIcon className="inline h-4 w-4 mr-2" />
                      {f.name}
                    </button>
                  </div>
                </div>
              ))}
              {!listing?.folders?.length && (
                <div className="text-sm text-muted-foreground">Нет папок</div>
              )}
            </div>
            <div className="mt-2 flex gap-2">
              <Button
                variant="destructive"
                disabled={!selectedFolderIds.size || deleteFolders.isLoading}
                onClick={() => {
                  const ids = Array.from(selectedFolderIds);
                  if (!ids.length) return;
                  if (
                    !confirm(
                      "Удалить выбранные папки? Удаляются только пустые.",
                    )
                  )
                    return;
                  deleteFolders.mutate({ ids });
                }}
              >
                Удалить выбранные папки
              </Button>
            </div>
          </div>

          {/* Файлы */}
          <div>
            <div className="flex items-center justify-between mb-2">
              <div className="font-medium">Файлы</div>
              <div className="text-sm text-muted-foreground">
                Выбрано: {selectedFileIds.size}
              </div>
            </div>
            <div className="space-y-2">
              {listing?.files?.map((file: any) => (
                <div
                  key={file.id}
                  className="flex items-center justify-between px-3 py-2 border rounded"
                >
                  <div className="flex items-center gap-2 min-w-0">
                    <Checkbox
                      checked={selectedFileIds.has(file.id)}
                      onCheckedChange={(checked: boolean) => {
                        setSelectedFileIds((prev) => {
                          const next = new Set(prev);
                          if (checked) next.add(file.id);
                          else next.delete(file.id);
                          return next;
                        });
                      }}
                    />
                    <a
                      href={file.url}
                      download={file.name || "file"}
                      className="truncate max-w-[60%] text-primary hover:underline"
                    >
                      {file.name}
                    </a>
                  </div>
                  <div className="flex items-center gap-2">
                    <span className="hidden" />
                    <select
                      className="border rounded h-8 px-2"
                      defaultValue={file.folderId ?? ""}
                      onChange={(e) =>
                        moveFile.mutate({
                          fileId: file.id,
                          targetFolderId: e.target.value || null,
                        })
                      }
                    >
                      <option value="">Корень</option>
                      {listing?.allFolders?.map((f: any) => (
                        <option key={f.id} value={f.id}>
                          {f.name}
                        </option>
                      ))}
                    </select>
                    <Button
                      size="sm"
                      variant="destructive"
                      onClick={() => deleteFiles.mutate({ ids: [file.id] })}
                    >
                      Удалить
                    </Button>
                  </div>
                </div>
              ))}
              {!listing?.files?.length && (
                <div className="text-sm text-muted-foreground">Нет файлов</div>
              )}
            </div>

            <div className="mt-2 flex flex-col sm:flex-row gap-2 sm:items-center">
              <div className="flex items-center gap-2">
                <span className="hidden" />
                <select
                  className="border rounded h-9 px-2"
                  value={targetFolderId}
                  onChange={(e) => setTargetFolderId(e.target.value)}
                >
                  <option value="">Корень</option>
                  {listing?.allFolders?.map((f: any) => (
                    <option key={f.id} value={f.id}>
                      {f.name}
                    </option>
                  ))}
                </select>
                <Button
                  variant="secondary"
                  onClick={bulkMoveSelected}
                  disabled={!selectedFileIds.size || isFetching}
                >
                  Переместить выбранные
                </Button>
              </div>
              <Button
                variant="destructive"
                disabled={!selectedFileIds.size || deleteFiles.isLoading}
                onClick={() => {
                  const ids = Array.from(selectedFileIds);
                  if (!ids.length) return;
                  if (!confirm("Удалить выбранные файлы?")) return;
                  deleteFiles.mutate({ ids });
                }}
              >
                Удалить выбранные файлы
              </Button>
            </div>
          </div>
        </div>
      </CardContent>
    </Card>
  );
}

function ITRVisitsScreen() {
  useAuth({ required: true });
  const { data: me, isInitialLoading } = useQuery<Profile>(["me"], () =>
    apiClient.getMyProfile(),
  );

  const [from, setFrom] = useState<string>("");
  const [to, setTo] = useState<string>("");
  const [search, setSearch] = useState<string>("");
  const [page, setPage] = useState<number>(1);

  const reportName = React.useMemo(() => {
    const base = "Статистика посещений ИТР";
    if (from && to) return `${base} ${from}—${to}`;
    if (from) return `${base} с ${from}`;
    if (to) return `${base} по ${to}`;
    return base;
  }, [from, to]);

  const isAdmin = !!me?.isAdmin;

  const { data, isInitialLoading: isDataLoading } = useQuery<VisitSessionsPage>(
    ["itr-visits-public", from, to, search, page],
    () =>
      apiClient.listVisitSessions({
        from: from || undefined,
        to: to || undefined,
        search: search || undefined,
        page,
        pageSize: 20,
      }),
    { enabled: isAdmin },
  );

  const exportExcel = useMutation(apiClient.exportVisitSessionsExcel, {
    onSuccess: (res: { url: string }) => {
      const sanitize = (s: string) =>
        (s || "")
          .replace(/[\\/:*?"<>|]+/g, " ")
          .replace(/\s+/g, " ")
          .trim()
          .slice(0, 120);
      const a = document.createElement("a");
      a.href = res.url;
      a.download = `${sanitize(reportName)}.xlsx`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    },
  });

  const fmtDur = (sec: number) => {
    const s = Math.max(0, Math.round(sec || 0));
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    const ss = s % 60;
    const pad = (n: number) => String(n).padStart(2, "0");
    return `${pad(h)}:${pad(m)}:${pad(ss)}`;
  };

  if (isInitialLoading) {
    return (
      <div className="max-w-4xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Загрузка…</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Проверяем статус доступа.
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }
  if (me && !(me as any).isAdmin) {
    return (
      <div className="max-w-4xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Доступ ограничен</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Раздел доступен только администраторам.
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }
  if (me && !me.canAccessNow) {
    return <AccessRestrictionNotice blocked={(me as any).isBlocked ?? false} />;
  }

  return (
    <div className="w-full max-w-[120rem] mx-auto px-4 sm:px-6 space-y-4">
      <Card className="card-elevated h-full">
        <CardHeader className="space-y-3">
          <CardTitle>Статистика посещений ИТР</CardTitle>
          <div className="flex flex-col gap-3 w-full">
            <div className="flex flex-wrap gap-2">
              <Input
                type="date"
                value={from}
                onChange={(e) => {
                  setFrom(e.target.value);
                  setPage(1);
                }}
              />
              <Input
                type="date"
                value={to}
                onChange={(e) => {
                  setTo(e.target.value);
                  setPage(1);
                }}
              />
              <Input
                placeholder="Поиск по ФИО/должности/подразделению"
                value={search}
                onChange={(e) => {
                  setSearch(e.target.value);
                  setPage(1);
                }}
              />
            </div>
            <div className="flex flex-col gap-2 w-full sm:max-w-xs">
              <div className="text-xs text-muted-foreground">
                Название отчёта
              </div>
              <Input value={reportName} readOnly />
              <Button
                className="rounded-none w-full"
                variant="secondary"
                onClick={() => {
                  /* deps-triggered refetch */
                }}
              >
                Обновить
              </Button>
              <Button
                className="rounded-none w-full"
                variant="secondary"
                disabled={exportExcel.isLoading}
                onClick={() =>
                  exportExcel.mutate({
                    from: from || undefined,
                    to: to || undefined,
                    search: search || undefined,
                  })
                }
              >
                Выгрузить Excel
              </Button>
              <div className="text-xs text-muted-foreground">
                Файл будет сохранён с именем выше; браузер предложит выбрать
                место сохранения.
              </div>
            </div>
          </div>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
            <div className="p-3 border rounded">
              <div className="text-xs text-muted-foreground">Сессий</div>
              <div className="text-2xl font-semibold">
                {data?.total ?? (isDataLoading ? "…" : 0)}
              </div>
            </div>
            <div className="p-3 border rounded">
              <div className="text-xs text-muted-foreground">Входов</div>
              <div className="text-2xl font-semibold">
                {data?.totalVisits ?? (isDataLoading ? "…" : 0)}
              </div>
            </div>
            <div className="p-3 border rounded">
              <div className="text-xs text-muted-foreground">
                Суммарное время
              </div>
              <div className="text-2xl font-semibold">
                {data ? fmtDur((data as any).totalDurationSec) : "00:00:00"}
              </div>
            </div>
          </div>

          <div className="border rounded-md overflow-x-auto">
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>Пользователь</TableHead>
                  <TableHead>Должность</TableHead>
                  <TableHead>Подразделение</TableHead>
                  <TableHead>Вход</TableHead>
                  <TableHead>Завершение</TableHead>
                  <TableHead>Длительность</TableHead>
                  <TableHead>Входов в сессии</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {isDataLoading && (
                  <TableRow>
                    <TableCell
                      colSpan={7}
                      className="text-sm text-muted-foreground"
                    >
                      Загрузка…
                    </TableCell>
                  </TableRow>
                )}
                {!isDataLoading && !data?.items?.length && (
                  <TableRow>
                    <TableCell
                      colSpan={7}
                      className="text-sm text-muted-foreground"
                    >
                      Нет данных
                    </TableCell>
                  </TableRow>
                )}
                {data?.items?.map((s: any, idx: number) => (
                  <TableRow key={idx}>
                    <TableCell className="min-w-[180px]">
                      {s.fullName || s.email || s.userId}
                    </TableCell>
                    <TableCell className="min-w-[160px]">
                      {s.jobTitle || "—"}
                    </TableCell>
                    <TableCell className="min-w-[160px]">
                      {s.department || "—"}
                    </TableCell>
                    <TableCell className="min-w-[200px]">
                      {new Date(s.startAt).toLocaleString("ru-RU", {
                        dateStyle: "full",
                        timeStyle: "medium",
                      })}
                    </TableCell>
                    <TableCell className="min-w-[200px]">
                      {new Date(s.endAt).toLocaleString("ru-RU", {
                        dateStyle: "full",
                        timeStyle: "medium",
                      })}
                    </TableCell>
                    <TableCell className="min-w-[140px]">
                      {fmtDur(s.durationSec)}
                    </TableCell>
                    <TableCell className="min-w-[80px]">{s.visits}</TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          </div>

          <div className="flex justify-between items-center text-sm text-muted-foreground">
            <div>Стр. {data?.page ?? page}</div>
            <div className="flex gap-2">
              <Button
                variant="secondary"
                disabled={(data?.page ?? 1) <= 1}
                onClick={() => setPage((p) => Math.max(1, p - 1))}
              >
                Назад
              </Button>
              <Button
                variant="secondary"
                disabled={
                  !!data &&
                  (data as any).page * (data as any).pageSize >=
                    (data as any).total
                }
                onClick={() => setPage((p) => p + 1)}
              >
                Вперёд
              </Button>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}

function AdminITRVisitsScreen() {
  const auth = useAuth({ required: true });
  const { data: me } = useQuery<Profile>(
    ["me"],
    () => apiClient.getMyProfile(),
    { enabled: auth.status === "authenticated" },
  );
  const isAdmin = !!me?.isAdmin;
  const navigate = useNavigate();

  const [from, setFrom] = useState<string>("");
  const [to, setTo] = useState<string>("");
  const [search, setSearch] = useState<string>("");
  const [page, setPage] = useState<number>(1);
  const [editingKey, setEditingKey] = useState<string | null>(null);
  const [startDraft, setStartDraft] = useState<string>("");
  const [endDraft, setEndDraft] = useState<string>("");
  const [durationDraft, setDurationDraft] = useState<string>("");

  const queryKey = ["itr-visits", from, to, search, page] as const;
  const { data, isInitialLoading } = useQuery<VisitSessionsPage>(
    queryKey,
    () =>
      apiClient.listVisitSessions({
        from: from || undefined,
        to: to || undefined,
        search: search || undefined,
        page,
        pageSize: 20,
      }),
    { enabled: isAdmin },
  );

  const exportExcel = useMutation(apiClient.exportVisitSessionsExcel, {
    onSuccess: (res: { url: string }) => {
      const a = document.createElement("a");
      const dateStr = new Date().toISOString().slice(0, 10);
      a.href = res.url;
      a.download = `Статистика_посещений_ИТР_${dateStr}.xlsx`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    },
  });

  // Selection state for bulk delete
  const [selectedKeys, setSelectedKeys] = useState<Set<string>>(new Set());
  const toggleSelected = (key: string, checked: boolean) => {
    setSelectedKeys((prev) => {
      const next = new Set(prev);
      if (checked) next.add(key);
      else next.delete(key);
      return next;
    });
  };

  const deleteSessions = useMutation(apiClient.deleteVisitSessionsAdmin, {
    onSuccess: async (res: { ok: boolean; deleted: number }) => {
      setSelectedKeys(new Set());
      await queryClient.invalidateQueries({ queryKey });
      toast({
        title: "Удаление выполнено",
        description: `Удалено записей: ${res.deleted}`,
      });
    },
    onError: () => toast({ title: "Не удалось удалить" }),
  });

  // Edit overrides
  const { toast } = useToast();
  const queryClient = useQueryClient();
  const upsertOverride = useMutation(apiClient.upsertVisitSessionOverride, {
    onMutate: async (variables) => {
      // Optimistic update: if visits count is changed, update the visible table immediately
      if (
        variables &&
        typeof variables.visits === "number" &&
        variables.visits > 0
      ) {
        const filter = { queryKey: ["itr-visits"] as const };
        // Cancel outgoing refetches for stability
        await queryClient.cancelQueries(filter);
        queryClient.setQueriesData<VisitSessionsPage>(filter, (prev) => {
          if (!prev) return prev as any;
          const matchKey = (x: any) => {
            const oStart = (x.originalStartAt ?? x.startAt) as any;
            const oEnd = (x.originalEndAt ?? x.endAt) as any;
            return (
              x.userId === variables.userId &&
              new Date(oStart).toISOString() ===
                new Date(variables.originalStartAt).toISOString() &&
              new Date(oEnd).toISOString() ===
                new Date(variables.originalEndAt).toISOString()
            );
          };
          let delta = 0;
          const items =
            prev.items?.map((it) => {
              if (matchKey(it)) {
                const old = Number(it.visits || 0);
                const next = variables.visits as number;
                delta = next - old;
                return { ...it, visits: next };
              }
              return it;
            }) ?? prev.items;
          const totalVisits =
            typeof prev.totalVisits === "number"
              ? prev.totalVisits + delta
              : prev.totalVisits;
          return { ...prev, items, totalVisits } as typeof prev;
        });
      }
    },
    onSuccess: async () => {
      toast({ title: "Изменения сохранены" });
      await queryClient.invalidateQueries({ queryKey: ["itr-visits"] });
    },
    onError: () => toast({ title: "Не удалось сохранить изменения" }),
    onSettled: async () => {
      await queryClient.refetchQueries({ queryKey: ["itr-visits"] });
    },
  });

  const fmtDur = (sec: number) => {
    const s = Math.max(0, Math.round(sec || 0));
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    const ss = s % 60;
    const pad = (n: number) => String(n).padStart(2, "0");
    return `${pad(h)}:${pad(m)}:${pad(ss)}`;
  };
  const rowKey = (s: any) =>
    `${s.userId}-${new Date(s.originalStartAt || s.startAt).toISOString()}-${new Date(s.originalEndAt || s.endAt).toISOString()}`;

  if (!isAdmin) {
    return (
      <div className="max-w-4xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Доступ ограничен</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Раздел доступен только администраторам.
            </div>
          </CardContent>
          <CardFooter>
            <Button variant="secondary" onClick={() => navigate("/admin")}>
              Назад
            </Button>
          </CardFooter>
        </Card>
      </div>
    );
  }

  return (
    <div className="w-full max-w-[120rem] mx-auto px-4 sm:px-6 space-y-4">
      <Card className="card-elevated h-full">
        <CardHeader className="space-y-3">
          <CardTitle>Статистика посещений ИТР</CardTitle>
          <div className="flex flex-col gap-3 w-full">
            <div className="flex flex-wrap gap-2">
              <Input
                type="date"
                value={from}
                onChange={(e) => {
                  setFrom(e.target.value);
                  setPage(1);
                }}
              />
              <Input
                type="date"
                value={to}
                onChange={(e) => {
                  setTo(e.target.value);
                  setPage(1);
                }}
              />
              <Input
                placeholder="Поиск по ФИО/должности/подразделению"
                value={search}
                onChange={(e) => {
                  setSearch(e.target.value);
                  setPage(1);
                }}
              />
            </div>
            <div className="flex flex-col gap-2 w-full sm:max-w-xs">
              <Button
                className="rounded-none w-full"
                variant="secondary"
                onClick={() => {
                  /* deps refetch */
                }}
              >
                Обновить
              </Button>
              <Button
                className="rounded-none w-full"
                variant="secondary"
                disabled={exportExcel.isLoading}
                onClick={() =>
                  exportExcel.mutate({
                    from: from || undefined,
                    to: to || undefined,
                    search: search || undefined,
                  })
                }
              >
                Выгрузить Excel
              </Button>
              <Button
                className="rounded-none w-full"
                variant="destructive"
                disabled={selectedKeys.size === 0 || deleteSessions.isLoading}
                onClick={() => {
                  if (!data?.items) return;
                  const sessions = data.items
                    .filter((s: any) => selectedKeys.has(rowKey(s)))
                    .map((s: any) => ({
                      userId: s.userId,
                      originalStartAt: new Date(
                        s.originalStartAt || s.startAt,
                      ).toISOString(),
                      originalEndAt: new Date(
                        s.originalEndAt || s.endAt,
                      ).toISOString(),
                    }));
                  if (!sessions.length) return;
                  if (
                    !confirm(
                      "Удалить выбранные записи посещений? Это действие необратимо.",
                    )
                  )
                    return;
                  deleteSessions.mutate({ sessions });
                }}
              >
                Удалить выбранное
              </Button>
              <Button
                className="rounded-none w-full"
                variant="outline"
                onClick={() => navigate("/admin")}
              >
                К админ-панели
              </Button>
            </div>
          </div>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
            <div className="p-3 border rounded">
              <div className="text-xs text-muted-foreground">Сессий</div>
              <div className="text-2xl font-semibold">
                {data?.total ?? (isInitialLoading ? "…" : 0)}
              </div>
            </div>
            <div className="p-3 border rounded">
              <div className="text-xs text-muted-foreground">Входов</div>
              <div className="text-2xl font-semibold">
                {data?.totalVisits ?? (isInitialLoading ? "…" : 0)}
              </div>
            </div>
            <div className="p-3 border rounded">
              <div className="text-xs text-muted-foreground">
                Суммарное время
              </div>
              <div className="text-2xl font-semibold">
                {data ? fmtDur(data.totalDurationSec as any) : "00:00:00"}
              </div>
            </div>
          </div>

          <div className="border rounded-md overflow-x-auto">
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>Пользователь</TableHead>
                  <TableHead>Должность</TableHead>
                  <TableHead>Подразделение</TableHead>
                  <TableHead>Вход</TableHead>
                  <TableHead>Завершение</TableHead>
                  <TableHead>Длительность</TableHead>
                  <TableHead>Входов в сессии</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {isInitialLoading && (
                  <TableRow>
                    <TableCell
                      colSpan={7}
                      className="text-sm text-muted-foreground"
                    >
                      Загрузка…
                    </TableCell>
                  </TableRow>
                )}
                {!isInitialLoading && !data?.items?.length && (
                  <TableRow>
                    <TableCell
                      colSpan={7}
                      className="text-sm text-muted-foreground"
                    >
                      Нет данных
                    </TableCell>
                  </TableRow>
                )}
                {data?.items?.map((s: any, idx: number) => (
                  <TableRow key={idx}>
                    <TableCell className="min-w-[180px]">
                      <div className="flex items-center gap-2">
                        <span className="hidden" />
                        <Checkbox
                          checked={selectedKeys.has(rowKey(s))}
                          onCheckedChange={(checked: boolean) =>
                            toggleSelected(rowKey(s), !!checked)
                          }
                        />
                        <span>{s.fullName || s.email || s.userId}</span>
                      </div>
                    </TableCell>
                    <TableCell className="min-w-[160px]">
                      {s.jobTitle || "—"}
                    </TableCell>
                    <TableCell className="min-w-[160px]">
                      {s.department || "—"}
                    </TableCell>
                    <TableCell className="min-w-[200px]">
                      {editingKey ===
                      `${s.userId}-${new Date(s.originalStartAt || s.startAt).toISOString()}-${new Date(s.originalEndAt || s.endAt).toISOString()}` ? (
                        <div className="flex items-center gap-2">
                          <span className="hidden" />
                          <Input
                            type="datetime-local"
                            value={startDraft}
                            onChange={(e) => setStartDraft(e.target.value)}
                          />
                          <Button
                            size="sm"
                            variant="secondary"
                            onClick={() => {
                              const startIso = startDraft
                                ? new Date(startDraft).toISOString()
                                : undefined;
                              const endIso = endDraft
                                ? new Date(endDraft).toISOString()
                                : undefined;
                              const parts = (durationDraft || "")
                                .split(":")
                                .map((x) => parseInt(x || "0", 10));
                              const dur =
                                parts.length >= 2
                                  ? (parts[0] || 0) * 3600 +
                                    (parts[1] || 0) * 60 +
                                    (parts[2] || 0)
                                  : undefined;
                              upsertOverride.mutate({
                                userId: s.userId,
                                originalStartAt: s.originalStartAt || s.startAt,
                                originalEndAt: s.originalEndAt || s.endAt,
                                ...(startIso ? { startAt: startIso } : {}),
                                ...(endIso ? { endAt: endIso } : {}),
                                ...(typeof dur === "number" && dur > 0
                                  ? { durationSec: dur }
                                  : {}),
                              });
                              setEditingKey(null);
                            }}
                          >
                            Сохранить
                          </Button>
                          <Button
                            size="sm"
                            variant="ghost"
                            onClick={() => setEditingKey(null)}
                          >
                            Отмена
                          </Button>
                        </div>
                      ) : (
                        <div className="flex items-center gap-2">
                          <span className="hidden" />
                          <span>
                            {new Date(s.startAt).toLocaleString("ru-RU", {
                              dateStyle: "full",
                              timeStyle: "medium",
                            })}
                          </span>
                          <Button
                            size="sm"
                            variant="secondary"
                            onClick={() => {
                              setStartDraft(
                                new Date(s.startAt).toISOString().slice(0, 16),
                              );
                              setEndDraft(
                                new Date(s.endAt).toISOString().slice(0, 16),
                              );
                              setDurationDraft(
                                (() => {
                                  const sec = Number(s.durationSec || 0);
                                  const h = Math.floor(sec / 3600);
                                  const m = Math.floor((sec % 3600) / 60);
                                  const ss = sec % 60;
                                  const pad = (n: number) =>
                                    String(n).padStart(2, "0");
                                  return `${pad(h)}:${pad(m)}:${pad(ss)}`;
                                })(),
                              );
                              setEditingKey(
                                `${s.userId}-${new Date(s.originalStartAt || s.startAt).toISOString()}-${new Date(s.originalEndAt || s.endAt).toISOString()}`,
                              );
                            }}
                          >
                            Изменить
                          </Button>
                        </div>
                      )}
                    </TableCell>
                    <TableCell className="min-w-[200px]">
                      {editingKey ===
                      `${s.userId}-${new Date(s.originalStartAt || s.startAt).toISOString()}-${new Date(s.originalEndAt || s.endAt).toISOString()}` ? (
                        <div className="flex items-center gap-2">
                          <span className="hidden" />
                          <Input
                            type="datetime-local"
                            value={endDraft}
                            onChange={(e) => setEndDraft(e.target.value)}
                          />
                        </div>
                      ) : (
                        <div className="flex items-center gap-2">
                          <span className="hidden" />
                          <span>
                            {new Date(s.endAt).toLocaleString("ru-RU", {
                              dateStyle: "full",
                              timeStyle: "medium",
                            })}
                          </span>
                        </div>
                      )}
                    </TableCell>
                    <TableCell className="min-w-[140px]">
                      {editingKey ===
                      `${s.userId}-${new Date(s.originalStartAt || s.startAt).toISOString()}-${new Date(s.originalEndAt || s.endAt).toISOString()}` ? (
                        <Input
                          value={durationDraft}
                          onChange={(e) => setDurationDraft(e.target.value)}
                          placeholder="ЧЧ:ММ:СС"
                        />
                      ) : (
                        <span>{fmtDur(s.durationSec)}</span>
                      )}
                    </TableCell>
                    <TableCell className="min-w-[80px]">
                      <Input
                        type="number"
                        key={`${s.userId}-${new Date(s.startAt).toISOString()}-${s.visits}`}
                        defaultValue={s.visits}
                        onBlur={(e) => {
                          const val = parseInt(e.target.value || "0", 10);
                          if (isNaN(val) || val <= 0) return;
                          upsertOverride.mutate({
                            userId: s.userId,
                            originalStartAt: s.originalStartAt || s.startAt,
                            originalEndAt: s.originalEndAt || s.endAt,
                            visits: val,
                          });
                        }}
                      />
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          </div>

          <div className="flex justify-between items-center text-sm text-muted-foreground">
            <div>Стр. {data?.page ?? page}</div>
            <div className="flex gap-2">
              <Button
                variant="secondary"
                disabled={(data?.page ?? 1) <= 1}
                onClick={() => setPage((p) => Math.max(1, p - 1))}
              >
                Назад
              </Button>
              <Button
                variant="secondary"
                disabled={!!data && data.page * data.pageSize >= data.total}
                onClick={() => setPage((p) => p + 1)}
              >
                Вперёд
              </Button>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}

function AdminStorageManagerPage() {
  const auth = useAuth({ required: true });
  const { data: me } = useQuery<Profile>(
    ["me"],
    () => apiClient.getMyProfile(),
    { enabled: auth.status === "authenticated" },
  );
  const isAdmin = !!me?.isAdmin;
  const navigate = useNavigate();
  if (!isAdmin) {
    return (
      <div className="max-w-4xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Доступ ограничен</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Раздел доступен только администраторам.
            </div>
          </CardContent>
          <CardFooter>
            <Button variant="secondary" onClick={() => navigate("/admin")}>
              Назад
            </Button>
          </CardFooter>
        </Card>
      </div>
    );
  }
  return (
    <div className="max-w-6xl mx-auto p-4 sm:p-6">
      <AdminStorageManager showBackToHome />
    </div>
  );
}

function PabKpiSchedulePage() {
  const auth = useAuth({ required: true });
  const { toast } = useToast();
  const navigate = useNavigate();
  const { data: me } = useQuery<Profile>(
    ["me"],
    () => apiClient.getMyProfile(),
    { enabled: auth.status === "authenticated" },
  );
  const isAdmin = !!me?.isAdmin;

  const queryClient = useQueryClient();

  type PabFiles = inferRPCOutputType<"listPabKpiFiles">;
  const { data: listing, isInitialLoading } = useQuery<PabFiles>(
    ["pabKpiFiles"],
    () => apiClient.listPabKpiFiles(),
    { enabled: isAdmin },
  );

  const uploadMutation = useMutation(apiClient.uploadPabKpiExcel, {
    onSuccess: async () => {
      await queryClient.invalidateQueries({ queryKey: ["pabKpiFiles"] });
      toast({ title: "Файл загружен" });
    },
    onError: () => toast({ title: "Не удалось загрузить файл" }),
  });

  const handleUpload = async (file: File | undefined) => {
    if (!file) return;
    const base64 = await encodeFileAsBase64DataURL(file);
    if (!base64) {
      toast({
        title: "Файл слишком большой",
        description: "Попробуйте меньший размер",
      });
      return;
    }
    uploadMutation.mutate({ base64, name: file.name });
  };

  const handleDeleteSelected = () => {
    if (selectedIds.length === 0) return;
    if (
      !window.confirm("Удалить выбранные файлы? Это действие нельзя отменить.")
    )
      return;
    deleteMutation.mutate({ ids: selectedIds });
  };

  // --- Selection state for files ---
  const [selectedIds, setSelectedIds] = useState<string[]>([]);

  const deleteMutation = useMutation(apiClient.deleteStorageFiles, {
    onSuccess: async (data, variables) => {
      const deletedIds = (variables as { ids: string[] }).ids;
      if (activeFile && deletedIds.includes(activeFile.id)) {
        setActiveFile(null);
        setSheets(null);
      }
      setSelectedIds([]);
      await queryClient.invalidateQueries({ queryKey: ["pabKpiFiles"] });
      toast({ title: `Удалено: ${data.deleted}` });
    },
    onError: () => toast({ title: "Не удалось удалить файлы" }),
  });

  // --- Save updated workbook back to Excel file ---
  const saveMutation = useMutation(apiClient.updatePabKpiExcel, {
    onSuccess: async () => {
      await queryClient.invalidateQueries({ queryKey: ["pabKpiFiles"] });
      toast({ title: "Файл обновлён" });
      setIsEditing(false);
    },
    onError: () => toast({ title: "Не удалось сохранить файл" }),
  });

  const arrayBufferToBase64DataURL = (buffer: ArrayBuffer) => {
    let binary = "";
    const bytes = new Uint8Array(buffer);
    for (let i = 0; i < bytes.length; i++)
      binary += String.fromCharCode(Number(bytes[i] ?? 0));
    const base64 = btoa(binary);
    return (
      "data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64," +
      base64
    );
  };

  const handleSave = async () => {
    if (!activeFile || !workbook) return;
    try {
      const out = XLSX.write(workbook, { bookType: "xlsx", type: "array" });
      const base64 = arrayBufferToBase64DataURL(out);
      saveMutation.mutate({ id: activeFile.id, base64, name: activeFile.name });
    } catch (_) {
      toast({ title: "Не удалось подготовить файл к сохранению" });
    }
  };

  // --- Excel preview/edit state ---
  const [activeFile, setActiveFile] = useState<any | null>(null);
  const [sheets, setSheets] = useState<
    { name: string; rows: (string | number)[][] }[] | null
  >(null);
  const [sheetIndex, setSheetIndex] = useState(0);
  const [isParsing, setIsParsing] = useState(false);
  const [workbook, setWorkbook] = useState<any | null>(null);
  const [isEditing, setIsEditing] = useState(false);

  // pick the latest file by date when list changes
  useEffect(() => {
    if (!listing?.files?.length) {
      setSelectedIds([]);
      return;
    }
    const sorted = [...listing.files].sort(
      (a: any, b: any) =>
        new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime(),
    );
    setActiveFile(sorted[0]);
    // keep only selections that still exist
    setSelectedIds((prev) =>
      prev.filter((id) => sorted.some((f: any) => f.id === id)),
    );
  }, [listing]);

  // fetch and parse xlsx -> rows[][]
  useEffect(() => {
    let cancelled = false;
    async function run() {
      if (!activeFile?.url) return;
      try {
        setIsEditing(false);
        setIsParsing(true);
        const fileRes = await apiClient.getFileBase64({ url: activeFile.url });
        const base64 = (fileRes as { base64: string }).base64;
        const binary = atob(base64);
        const len = binary.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) bytes[i] = binary.charCodeAt(i);
        const buf = bytes.buffer;
        const wb = XLSX.read(buf, { type: "array" });
        try {
          // register extra functions and recalc formulas
          (XLSX_CALC as any).import_functions?.(formulajs);
          (XLSX_CALC as any)(wb, { continue_after_error: true });
        } catch {
          /* ignore */
        }
        const parsed = wb.SheetNames.map((name) => {
          const ws = wb.Sheets[name] as XLSX.WorkSheet;
          const arr = XLSX.utils.sheet_to_json(ws, {
            header: 1,
            raw: false,
          }) as any[];
          const rows = (arr || []).map((r: any[]) => r.map((c) => c ?? ""));
          const limited = rows.slice(0, 200).map((r) => r.slice(0, 50));
          return { name, rows: limited };
        });
        if (!cancelled) {
          setWorkbook(wb);
          setSheets(parsed);
          setSheetIndex(0);
        }
      } catch {
        if (!cancelled) toast({ title: "Не удалось открыть Excel" });
      } finally {
        if (!cancelled) setIsParsing(false);
      }
    }
    run();
    return () => {
      cancelled = true;
    };
  }, [activeFile, toast]);

  const currentSheet = sheets?.[sheetIndex];

  const handleCellChange = (r: number, c: number, v: string) => {
    // Update underlying workbook if available to preserve formulas
    if (workbook && sheets) {
      const sheetName = sheets[sheetIndex]?.name;
      const ws = sheetName ? workbook.Sheets[sheetName] : undefined;
      if (ws && sheetName) {
        const addr = XLSX.utils.encode_cell({ r, c });
        if (v.startsWith("=")) {
          ws[addr] = { ...(ws[addr] ?? {}), f: v.slice(1) } as any;
          // clear old value to force recompute
          delete (ws[addr] as any).v;
        } else {
          const maybeNum = Number(v);
          const isNum = !Number.isNaN(maybeNum) && v.trim() !== "";
          const cell: any = ws[addr] ?? {};
          delete cell.f; // typed input overrides formula
          cell.v = isNum ? maybeNum : v;
          cell.t = isNum ? "n" : "s";
          ws[addr] = cell;
        }
        try {
          (XLSX_CALC as any)(workbook, { continue_after_error: true });
        } catch {
          // ignore calc errors for now
        }
        // rebuild preview arrays from workbook
        const parsed = workbook.SheetNames.map((name: string) => {
          const ws2 = workbook.Sheets[name] as XLSX.WorkSheet;
          const arr = XLSX.utils.sheet_to_json(ws2, {
            header: 1,
            raw: false,
          }) as any[];
          const rows = (arr || []).map((row: any[]) => row.map((c) => c ?? ""));
          const limited = rows.slice(0, 200).map((row) => row.slice(0, 50));
          return { name, rows: limited };
        });
        setSheets(parsed);
        return;
      }
    }
    // Fallback: local table-only state update
    setSheets((prev) => {
      if (!prev) return prev;
      return prev.map((s, i) =>
        i !== sheetIndex
          ? s
          : {
              ...s,
              rows: s.rows.map((row, ri) =>
                ri === r
                  ? row.map((cell, ci) => (ci === c ? v : (cell ?? "")))
                  : row,
              ),
            },
      );
    });
  };

  if (!isAdmin) {
    return (
      <div className="max-w-4xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Доступ ограничен</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Раздел доступен только администраторам.
            </div>
          </CardContent>
          <CardFooter>
            <Button variant="secondary" onClick={() => navigate("/admin")}>
              Назад
            </Button>
          </CardFooter>
        </Card>
      </div>
    );
  }

  return (
    <div className="max-w-5xl mx-auto p-4 sm:p-6">
      <Card className="card-elevated">
        <CardHeader className="flex items-center justify-between">
          <CardTitle>Личные показатели ПАБ</CardTitle>
          <div className="flex items-center gap-2">
            <Button variant="secondary" onClick={() => navigate("/admin")}>
              Назад
            </Button>
            <Button variant="outline" onClick={() => window.print()}>
              Печать
            </Button>
          </div>
        </CardHeader>
        <CardContent className="space-y-6">
          <div className="space-y-2">
            <div className="font-medium">Загрузка графика (Excel)</div>
            <div className="text-sm text-muted-foreground">
              Загрузите актуальный файл .xlsx или .xls. После изменений
              перезагрузите обновлённую версию.
            </div>
            <div className="flex items-center gap-2">
              <input
                type="file"
                accept=".xlsx,.xls"
                id="pab-kpi-input"
                className="hidden"
                onChange={(e) => handleUpload(e.target.files?.[0])}
              />
              <Button
                onClick={() =>
                  document.getElementById("pab-kpi-input")?.click()
                }
                disabled={uploadMutation.isLoading}
              >
                {uploadMutation.isLoading ? "Загрузка…" : "Загрузить Excel"}
              </Button>
            </div>
          </div>

          <div className="space-y-2">
            <div className="font-medium">Файлы графика</div>
            {isInitialLoading ? (
              <div className="text-sm text-muted-foreground">Загрузка…</div>
            ) : listing?.files?.length ? (
              <div className="space-y-2">
                <div className="flex items-center justify-between gap-2">
                  <label className="flex items-center gap-2 text-sm">
                    <input
                      type="checkbox"
                      checked={
                        listing.files.length > 0 &&
                        selectedIds.length === listing.files.length
                      }
                      onChange={(e) => {
                        if (e.target.checked) {
                          setSelectedIds(listing.files.map((f: any) => f.id));
                        } else {
                          setSelectedIds([]);
                        }
                      }}
                    />
                    Выбрать все
                  </label>
                  <div className="flex items-center gap-2">
                    <div className="text-xs text-muted-foreground">
                      Выбрано: {selectedIds.length}
                    </div>
                    <Button
                      variant="destructive"
                      size="sm"
                      disabled={
                        selectedIds.length === 0 || deleteMutation.isLoading
                      }
                      onClick={handleDeleteSelected}
                    >
                      {deleteMutation.isLoading
                        ? "Удаление…"
                        : "Удалить выбранные"}
                    </Button>
                  </div>
                </div>
                {listing.files.map((f: any) => (
                  <div
                    key={f.id}
                    className="flex items-center justify-between px-3 py-2 border rounded gap-3"
                  >
                    <input
                      type="checkbox"
                      checked={selectedIds.includes(f.id)}
                      onChange={(e) => {
                        setSelectedIds((prev) =>
                          e.target.checked
                            ? Array.from(new Set([...prev, f.id]))
                            : prev.filter((id) => id !== f.id),
                        );
                      }}
                    />
                    <button
                      className="text-left text-primary hover:underline truncate flex-1"
                      onClick={() => setActiveFile(f)}
                      title="Открыть для заполнения"
                    >
                      {f.name}
                    </button>
                    <div className="text-sm text-muted-foreground whitespace-nowrap">
                      {new Date(f.createdAt).toLocaleString()}
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div className="text-sm text-muted-foreground">
                Файлов пока нет
              </div>
            )}
          </div>

          <div className="space-y-2">
            <div className="flex items-center justify-between">
              <div className="font-medium">Таблица для заполнения</div>
              <div className="flex items-center gap-2">
                {sheets && (
                  <select
                    className="border rounded px-2 py-1 text-sm"
                    value={sheetIndex}
                    onChange={(e) => setSheetIndex(Number(e.target.value))}
                  >
                    {sheets.map((s, i) => (
                      <option key={s.name + i} value={i}>
                        {s.name}
                      </option>
                    ))}
                  </select>
                )}
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => setIsEditing(true)}
                  disabled={!activeFile || !workbook || isEditing}
                >
                  Редактировать текст
                </Button>
                <Button
                  variant="primary"
                  size="sm"
                  onClick={handleSave}
                  disabled={
                    !activeFile ||
                    !workbook ||
                    !isEditing ||
                    saveMutation.isLoading
                  }
                >
                  {saveMutation.isLoading ? "Сохранение…" : "Сохранить файл"}
                </Button>
              </div>
            </div>
            {activeFile && (
              <div className="text-xs text-muted-foreground">
                {isParsing
                  ? "Открываем файл…"
                  : "Формулы пересчитываются автоматически. Для скорости показаны первые 200 строк и 50 столбцов"}
              </div>
            )}
            {!activeFile && (
              <div className="text-sm text-muted-foreground">
                Выберите файл из списка выше, чтобы открыть его как таблицу
              </div>
            )}
            {!isParsing && currentSheet && (
              <div className="border rounded overflow-auto max-h-[60vh]">
                <table className="min-w-full text-sm">
                  <tbody>
                    {currentSheet.rows.map((row, ri) => (
                      <tr key={ri}>
                        {row.map((cell, ci) => (
                          <td
                            key={ci}
                            className="border px-1 py-0.5 min-w-[120px]"
                          >
                            {isEditing ? (
                              <input
                                className="w-full bg-transparent outline-none p-1"
                                value={String(cell ?? "")}
                                onChange={(e) =>
                                  handleCellChange(ri, ci, e.target.value)
                                }
                              />
                            ) : (
                              <div className="p-1">{String(cell ?? "")}</div>
                            )}
                          </td>
                        ))}
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        </CardContent>
      </Card>
    </div>
  );
}

function AdminPrescriptionRegisterScreen() {
  const auth = useAuth({ required: true });
  const { data: me } = useQuery<Profile>(
    ["me"],
    () => apiClient.getMyProfile(),
    {
      enabled: auth.status === "authenticated",
    },
  );
  const isAdmin = !!me?.isAdmin;
  const navigate = useNavigate();

  const [from, setFrom] = useState("");
  const [to, setTo] = useState("");
  const [q, setQ] = useState("");
  const [page, setPage] = useState(1);

  const { data, isInitialLoading, refetch } = useQuery<PrescriptionPage>(
    ["prescriptions", from, to, q, page],
    () =>
      apiClient.listPrescriptionRegister({
        from: from || undefined,
        to: to || undefined,
        query: q || undefined,
        page,
        pageSize: 20,
      }),
    { enabled: isAdmin, keepPreviousData: true },
  );

  const exportExcel = useMutation(apiClient.exportPrescriptionRegisterExcel);
  const exportWord = useMutation(apiClient.exportPrescriptionRegisterDocx);
  const saveExcel = useMutation(apiClient.exportPrescriptionRegisterExcel);
  const deleteSelected = useMutation(
    apiClient.deletePrescriptionRegisterEntries,
  );
  const setStatus = useMutation(apiClient.updateViolationAdmin, {
    onSuccess: async () => {
      await refetch();
    },
  });
  const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set());

  if (!isAdmin) {
    return (
      <div className="max-w-4xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Доступ ограничен</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Раздел доступен только администраторам.
            </div>
          </CardContent>
          <CardFooter>
            <Button variant="secondary" onClick={() => navigate("/admin")}>
              Назад
            </Button>
          </CardFooter>
        </Card>
      </div>
    );
  }

  return (
    <div className="w-full max-w-[120rem] mx-auto px-4 sm:px-6 space-y-4">
      <Card className="card-elevated h-full">
        <CardHeader className="space-y-3">
          <CardTitle>Реестр предписаний</CardTitle>
          <div className="flex flex-wrap gap-2 w-full">
            <Input
              type="date"
              value={from}
              onChange={(e) => {
                setFrom(e.target.value);
                setPage(1);
              }}
            />
            <Input
              type="date"
              value={to}
              onChange={(e) => {
                setTo(e.target.value);
                setPage(1);
              }}
            />
            <Input
              placeholder="Поиск по номеру, месту, объекту, ответственному"
              value={q}
              onChange={(e) => {
                setQ(e.target.value);
                setPage(1);
              }}
            />
            <Button className="btn-rect rounded-none" variant="secondary">
              Обновить
            </Button>
          </div>
        </CardHeader>
        <CardContent className="space-y-3">
          <div className="border rounded-md overflow-x-auto">
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>Создано</TableHead>
                  <TableHead>№</TableHead>
                  <TableHead>Дата</TableHead>
                  <TableHead>Где</TableHead>
                  <TableHead>Объект</TableHead>
                  <TableHead>Ответственный</TableHead>
                  <TableHead>Срок</TableHead>
                  <TableHead>Статус</TableHead>
                  <TableHead>Документ</TableHead>
                  <TableHead>Действия</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {isInitialLoading && (
                  <TableRow>
                    <TableCell
                      colSpan={9}
                      className="text-sm text-muted-foreground"
                    >
                      Загрузка…
                    </TableCell>
                  </TableRow>
                )}
                {!isInitialLoading &&
                  (!data?.items || data.items.length === 0) && (
                    <TableRow>
                      <TableCell
                        colSpan={9}
                        className="text-sm text-muted-foreground"
                      >
                        Нет данных
                      </TableCell>
                    </TableRow>
                  )}
                {data?.items?.map((r: any) => (
                  <TableRow key={r.id}>
                    <TableCell className="align-top">
                      <input
                        type="checkbox"
                        className="mr-2"
                        checked={selectedIds.has(r.id)}
                        onChange={(e) => {
                          setSelectedIds((prev) => {
                            const next = new Set(prev);
                            if (e.target.checked) next.add(r.id);
                            else next.delete(r.id);
                            return next;
                          });
                        }}
                      />
                      <span
                        className={"indicator-dot " + ((r.violation?.status || "").toLowerCase().includes("устран") ? "indicator-green" : (r.violation?.status || "").toLowerCase().includes("просроч") ? "indicator-blink-red" : r.violation?.dueDate && new Date(r.violation.dueDate).getTime() < Date.now() ? "indicator-blink-red" : "indicator-red")}
                        title={
                          (r.violation?.status || "")
                            .toLowerCase()
                            .includes("устран")
                            ? "Устранено"
                            : r.violation?.dueDate &&
                                new Date(r.violation.dueDate).getTime() <
                                  Date.now()
                              ? "Просрочено"
                              : "В работе"
                        }
                      />{" "}
                      {new Date(r.createdAt).toLocaleString("ru-RU")}
                    </TableCell>
                    <TableCell>{r.violation?.code || "—"}</TableCell>
                    <TableCell>
                      {r.violation?.date
                        ? new Date(r.violation.date).toISOString().slice(0, 10)
                        : "—"}
                    </TableCell>
                    <TableCell className="truncate max-w-[220px]">
                      {r.violation
                        ? `${r.violation.shop}/${r.violation.section}`
                        : "—"}
                    </TableCell>
                    <TableCell className="truncate max-w-[240px]">
                      {r.violation?.objectInspected || "—"}
                    </TableCell>
                    <TableCell className="truncate max-w-[220px]">
                      {r.violation?.responsibleName || "—"}
                    </TableCell>
                    <TableCell>
                      {r.violation?.dueDate
                        ? new Date(r.violation.dueDate)
                            .toISOString()
                            .slice(0, 10)
                        : "—"}
                    </TableCell>
                    <TableCell>{r.violation?.status || "—"}</TableCell>
                    <TableCell>
                      {r.docUrl ? (
                        <a
                          href={r.docUrl}
                          target="_blank"
                          rel="noreferrer"
                          className="text-primary hover:underline"
                        >
                          Открыть
                        </a>
                      ) : (
                        <span className="text-muted-foreground">—</span>
                      )}
                    </TableCell>
                    <TableCell>
                      {r.violation?.id ? (
                        <DropdownMenu>
                          <DropdownMenuTrigger asChild>
                            <Button size="sm" variant="secondary">
                              Изменить
                            </Button>
                          </DropdownMenuTrigger>
                          <DropdownMenuContent align="end">
                            {[
                              "Устранено",
                              "В работе",
                              "Новая",
                              "Просрочено",
                            ].map((label) => (
                              <DropdownMenuItem
                                key={label}
                                onClick={() =>
                                  setStatus.mutate({
                                    id: r.violation.id as string,
                                    status: label,
                                  })
                                }
                              >
                                {label}
                              </DropdownMenuItem>
                            ))}
                          </DropdownMenuContent>
                        </DropdownMenu>
                      ) : (
                        <span className="text-muted-foreground">—</span>
                      )}
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          </div>
          <div className="flex flex-col gap-3 text-sm text-muted-foreground">
            <div className="flex flex-wrap gap-2">
              <Button
                variant="secondary"
                onClick={() =>
                  exportExcel.mutate({
                    from: from || undefined,
                    to: to || undefined,
                    query: q || undefined,
                  })
                }
              >
                Скачать Excel
              </Button>
              <Button
                variant="secondary"
                onClick={() =>
                  exportWord.mutate({
                    from: from || undefined,
                    to: to || undefined,
                    query: q || undefined,
                  })
                }
              >
                Скачать Word
              </Button>
              <Button
                variant="secondary"
                onClick={() =>
                  saveExcel.mutate({
                    from: from || undefined,
                    to: to || undefined,
                    query: q || undefined,
                    folderId: null,
                  })
                }
              >
                Excel
              </Button>
              <Button
                variant="destructive"
                disabled={selectedIds.size === 0}
                onClick={async () => {
                  if (selectedIds.size === 0) return;
                  if (
                    !confirm(
                      "Удалить выбранные записи реестра? Это действие необратимо.",
                    )
                  )
                    return;
                  await deleteSelected.mutateAsync({
                    ids: Array.from(selectedIds),
                  });
                  setSelectedIds(new Set());
                  await refetch();
                }}
              >
                Удалить выбранное
              </Button>
              <div className="ml-auto" />
            </div>
            <div className="flex justify-between items-center">
              <div>Стр. {data?.page ?? page}</div>
              <div className="flex gap-2">
                <Button
                  variant="secondary"
                  disabled={(data?.page ?? 1) <= 1}
                  onClick={() => setPage((p) => Math.max(1, p - 1))}
                >
                  Назад
                </Button>
                <Button
                  variant="secondary"
                  disabled={!!data && data.page * data.pageSize >= data.total}
                  onClick={() => setPage((p) => p + 1)}
                >
                  Вперёд
                </Button>
              </div>
            </div>
          </div>
        </CardContent>
        <CardFooter>
          <Button variant="secondary" onClick={() => navigate("/admin")}>
            К админ-панели
          </Button>
        </CardFooter>
      </Card>
    </div>
  );
}

/* Root */
function StorageScreen() {
  useAuth({ required: true });
  const { data: stats } = useQuery(["storageStats"], () =>
    apiClient.getStorageStats(),
  );
  const { data: me } = useQuery<Profile>(["me"], () =>
    apiClient.getMyProfile(),
  );
  const isAdmin = !!me?.isAdmin;
  const [currentFolder, setCurrentFolder] = useState<string | null>(null);
  const { data: listing } = useQuery(["storageList", currentFolder], () =>
    apiClient.listStorage({ folderId: currentFolder }),
  );

  const queryClient = useQueryClient();
const { toast } = useToast();
  const navigate = useNavigate();
 
   const createFolder = useMutation(apiClient.createStorageFolder, {    onSuccess: async () => {
      await queryClient.invalidateQueries({ queryKey: ["storageList"] });
      toast({ title: "Папка создана" });
    },
    onError: () => toast({ title: "Не удалось создать папку" }),
  });

  const used = stats?.usedPercent ?? 0;
  const remainingPercent = 100 - used;
  const remainingGb =
    stats && stats.quotaBytes > stats.usedBytes
      ? Math.round((stats.quotaBytes - stats.usedBytes) / (1024 * 1024 * 1024))
      : 0;
  const barColor =
    used >= 95 ? "bg-red-500" : used >= 80 ? "bg-blue-500" : "bg-green-500";

  return (
    <div className="max-w-5xl mx-auto p-4 sm:p-6 space-y-4">
      <Card className="card-elevated h-full">
        <CardHeader>
          <CardTitle>Хранилище</CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div>
            <div className="h-3 w-full rounded bg-secondary overflow-hidden">
              <div
                className={`h-3 ${barColor}`}
                style={{ width: `${used}%` }}
              />
            </div>
            <div className="text-xs text-muted-foreground mt-1">
              Заполнено: {stats ? stats.usedPercent : 0}% · Свободно:{" "}
              {stats ? remainingPercent : 100}%
            </div>
            <div className="text-xs text-muted-foreground">
              Ёмкость:{" "}
              {stats ? Math.round(stats.quotaBytes / (1024 * 1024 * 1024)) : 0}{" "}
              ГБ · Свободно: {stats ? remainingGb : 0} ГБ
            </div>
          </div>

          <div className="flex items-center gap-2">
            <span className="hidden" />
            <Button size="sm" onClick={() => setCurrentFolder(null)}>
              Корень
            </Button>
            {listing?.breadcrumbs?.slice(1).map((b) => (
              <Button
                key={b.id ?? "root"}
                size="sm"
                variant="ghost"
                onClick={() => setCurrentFolder(b.id)}
              >
                {b.name}
              </Button>
            ))}
          </div>

          {isAdmin && (
            <div className="flex flex-col sm:flex-row sm:items-center gap-2">
              <div className="flex items-center gap-2">
                <span className="hidden" />
                <Button
                  size="sm"
                  onClick={() => {
                    const name = prompt("Название папки");
                    if (!name) return;
                    createFolder.mutate({
                      name,
                      parentId: currentFolder ?? null,
                    });
                  }}
                >
                  <FolderPlus className="h-4 w-4 mr-2" /> Создать папку
                </Button>
              </div>

              {/* Upload block */}
              <UploadToStorage
                allFolders={listing?.allFolders || []}
                currentFolder={currentFolder}
                onUploaded={() => {
                  queryClient.invalidateQueries({ queryKey: ["storageList"] });
                }}
              />
            </div>
          )}

          <div className="grid md:grid-cols-2 gap-4">
            <div>
              <div className="font-medium mb-2">Папки</div>
              <div className="space-y-2">
                {listing?.folders?.map((f: any) => {
                  const hasFiles = !!(f as any)?._count?.files;
                  return (
                    <div
                      key={f.id}
                      className={`flex items-center justify-between px-3 py-2 border rounded ${hasFiles ? "bg-accent" : "bg-card"}`}
                    >
                      <div className="flex items-center gap-2 min-w-0">
                        <button
                          className="text-left truncate hover:underline"
                          onClick={() => setCurrentFolder(f.id)}
                        >
                          <FolderIcon className="inline h-4 w-4 mr-2" />
                          {f.name}
                        </button>
                      </div>
                    </div>
                  );
                })}
                {!listing?.folders?.length && (
                  <div className="text-sm text-muted-foreground">Нет папок</div>
                )}
              </div>
            </div>
            <div>
              <div className="font-medium mb-2">Файлы</div>
              <div className="space-y-2">
                {listing?.files?.map((file: any) => (
                  <div
                    key={file.id}
                    className="flex items-center justify-between px-3 py-2 border rounded"
                  >
                    <button
                      onClick={() => navigate(`/storage/file/${file.id}`)}
                      className="truncate max-w-[70%] text-primary hover:underline text-left"
                    >
                      {file.name}
                    </button>
                    <div className="text-xs text-muted-foreground">
                      Скачать/просмотр
                    </div>
                  </div>
                ))}
                {!listing?.files?.length && (
                  <div className="text-sm text-muted-foreground">
                    Нет файлов
                  </div>
                )}
              </div>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}

function UploadToStorage({
  allFolders,
  currentFolder,
  onUploaded,
}: {
  allFolders: Array<{ id: string | null; name: string }> | any[];
  currentFolder: string | null;
  onUploaded: () => void;
}) {
  const [files, setFiles] = React.useState<File[]>([]);
  const [uploading, setUploading] = React.useState(false);
  const [doneCount, setDoneCount] = React.useState(0);
  const [targetFolderId, setTargetFolderId] = React.useState<string | "root" | "current">(
    currentFolder ? "current" : "root",
  );
  const [duplicateDialog, setDuplicateDialog] = React.useState<{
    file: File | null;
    strategy: "REPLACE" | "SKIP" | "DELETE_BOTH" | null;
  }>({ file: null, strategy: null });
  const { toast } = useToast();
  const queryClient = useQueryClient();

  const folders: Array<{ id: string | null; name: string }> = Array.isArray(allFolders)
    ? (allFolders as any[]).map((f) => ({ id: (f as any).id ?? null, name: (f as any).name ?? "—" }))
    : [];

  const uploadMutation = useMutation(apiClient.uploadStorageFile, {
    onSuccess: async (res: any) => {
      if (res?.ok && res?.file) {
        toast({ title: "Файл загружен" });
      }
      await queryClient.invalidateQueries({ queryKey: ["storageStats"] });
      onUploaded();
    },
    onError: (e: any) => {
       const raw = e?.message || "";
       let msg = "Не удалось загрузить файл";
       if (raw.includes("FILE_TOO_LARGE")) {
         msg = "Файл превышает лимит 100 МБ";
       } else if (raw.includes("FORBIDDEN")) {
         msg = "Нет прав на загрузку файлов. Обратитесь к администратору.";
       } else if (raw.includes("FOLDER_NOT_FOUND")) {
         msg = "Выбранная папка больше не существует. Обновите страницу и попробуйте ещё раз.";
       }
       toast({ title: msg });
     },
   });

  const handlePickMany = async (list?: FileList | null) => {
    const MAX = 100 * 1024 * 1024;
    const picked: File[] = [];
    const rejected: string[] = [];
    if (!list) {
      setFiles([]);
      return;
    }
    Array.from(list).forEach((f) => {
      if (f.size > MAX) rejected.push(`${f.name} (>100 МБ)`);
      else picked.push(f);
    });
    if (rejected.length) {
      toast({ title: "Некоторые файлы пропущены", description: rejected.join(", ") });
    }
    setFiles(picked);
  };

  const handleSingleUpload = async (
    file: File,
    folderToSend: string | null,
    strategy?: "REPLACE" | "SKIP" | "DELETE_BOTH",
  ) => {
    const base64 = await encodeFileAsBase64DataURL(file);
    if (!base64) {
      toast({ title: `Не удалось прочитать файл: ${file.name}` });
      return;
    }

    const res: any = await uploadMutation.mutateAsync({
      base64,
      name: file.name,
      targetFolderId: folderToSend as any,
      ifExistsStrategy: strategy,
    });

    if (res && !res.ok && res.error === "FILE_EXISTS" && !strategy) {
      // Ask user what to do
      setDuplicateDialog({ file, strategy: null });
      throw new Error("DUPLICATE_HANDLED");
    }

    setDoneCount((c) => c + 1);
  };

  const handleUploadMany = async () => {
    if (uploading || files.length === 0) return;
    setUploading(true);
    setDoneCount(0);
    const folderToSend =
      targetFolderId === "root" ? null : targetFolderId === "current" ? currentFolder : targetFolderId;

    try {
      for (let i = 0; i < files.length; i++) {
        const f = files[i];
        try {
          await handleSingleUpload(f, folderToSend as any);
        } catch (e: any) {
          if (e?.message !== "DUPLICATE_HANDLED") {
            // already shown toast inside
            continue;
          } else {
            // wait for user choice; stop batch
            break;
          }
        }
      }
      if (!duplicateDialog.file) {
        toast({ title: `Загрузка завершена (${files.length})` });
        setFiles([]);
        await queryClient.invalidateQueries({ queryKey: ["storageStats"] });
        onUploaded();
      }
    } finally {
      setUploading(false);
    }
  };


  return (
    <div className="flex flex-col sm:flex-row sm:items-end gap-2">
      <div className="flex-1 min-w-[220px]">
        <Label className="text-xs">Папка для загрузки</Label>
        <Select
          value={targetFolderId as string}
          onValueChange={(v) => setTargetFolderId(v as any)}
        >
          <SelectTrigger className="w-full">
            <SelectValue placeholder="Выберите папку" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="root">Корень</SelectItem>
            {currentFolder && <SelectItem value="current">Текущая папка</SelectItem>}
            <SelectItem value="divider" disabled>──────────</SelectItem>
            {folders.map((f) => (
              <SelectItem key={String(f.id)} value={String(f.id)}>
                {f.name}
              </SelectItem>
            ))}
          </SelectContent>
        </Select>
      </div>

      <div className="flex-1 min-w-[220px]">
        <Label className="text-xs">Файлы (до 100 МБ каждый)</Label>
        <div className="flex items-center gap-2">
          <Input
            type="file"
            multiple
            onChange={(e) => handlePickMany(e.target.files)}
          />
        </div>
        {files.length > 0 && (
          <div className="text-xs text-muted-foreground mt-1 truncate">
            Выбрано: {files.length} — {files.slice(0,3).map(f => f.name).join(", ")}{files.length>3 ? "…" : ""}
          </div>
        )}
      </div>

      <div className="flex items-center">
        <Button
          size="sm"
          onClick={handleUploadMany}
          disabled={files.length === 0 || uploading}
        >
          {uploading
            ? `Загрузка… ${doneCount}/${files.length}`
            : `Загрузить${files.length ? ` (${files.length})` : ""}`}
        </Button>
      </div>

      {/* Duplicate dialog */}
      {duplicateDialog.file && (
        <AlertDialog
          open={!!duplicateDialog.file}
          onOpenChange={(open) => {
            if (!open) setDuplicateDialog({ file: null, strategy: null });
          }}
        >
          <AlertDialogContent>
            <AlertDialogHeader>
              <AlertDialogTitle>
                Файл с таким названием уже существует
              </AlertDialogTitle>
              <AlertDialogDescription>
                {duplicateDialog.file.name}
              </AlertDialogDescription>
            </AlertDialogHeader>
            <AlertDialogFooter className="flex flex-col sm:flex-row gap-2 sm:gap-3">
              <Button
                variant="destructive"
                className="w-full sm:w-auto"
                onClick={async () => {
                  if (!duplicateDialog.file) return;
                  const folderToSend =
                    targetFolderId === "root"
                      ? null
                      : targetFolderId === "current"
                        ? currentFolder
                        : targetFolderId;
                  setUploading(true);
                  try {
                    await handleSingleUpload(
                      duplicateDialog.file,
                      folderToSend as any,
                      "DELETE_BOTH",
                    );
                    toast({ title: "Оба файла удалены" });
                    setFiles((prev) =>
                      prev.filter((f) => f.name !== duplicateDialog.file?.name),
                    );
                    await queryClient.invalidateQueries({
                      queryKey: ["storageStats"],
                    });
                    onUploaded();
                  } finally {
                    setUploading(false);
                    setDuplicateDialog({ file: null, strategy: null });
                  }
                }}
              >
                Удалить оба файла
              </Button>
              <Button
                variant="outline"
                className="w-full sm:w-auto"
                onClick={() => {
                  // Don't upload new one
                  setFiles((prev) =>
                    prev.filter((f) => f.name !== duplicateDialog.file?.name),
                  );
                  toast({ title: "Файл не загружен" });
                  setDuplicateDialog({ file: null, strategy: null });
                }}
              >
                Не загружать
              </Button>
              <Button
                className="w-full sm:w-auto"
                onClick={async () => {
                  if (!duplicateDialog.file) return;
                  const folderToSend =
                    targetFolderId === "root"
                      ? null
                      : targetFolderId === "current"
                        ? currentFolder
                        : targetFolderId;
                  setUploading(true);
                  try {
                    await handleSingleUpload(
                      duplicateDialog.file,
                      folderToSend as any,
                      "REPLACE",
                    );
                    toast({ title: "Файл заменён" });
                    setFiles((prev) =>
                      prev.filter((f) => f.name !== duplicateDialog.file?.name),
                    );
                    await queryClient.invalidateQueries({
                      queryKey: ["storageStats"],
                    });
                    onUploaded();
                  } finally {
                    setUploading(false);
                    setDuplicateDialog({ file: null, strategy: null });
                  }
                }}
              >
                Заменить на новый
              </Button>
            </AlertDialogFooter>
          </AlertDialogContent>
        </AlertDialog>
      )}
    </div>
  );
}


function SummaryChartsScreen() {
  useAuth({ required: true });
  const { data: me, isInitialLoading } = useQuery<Profile>(["me"], () =>
    apiClient.getMyProfile(),
  );

  const [from, setFrom] = useState<string>("");
  const [to, setTo] = useState<string>("");
  const [reportType, setReportType] = useState<string>("violations");
  const [chartType, setChartType] = useState<string>("bar");
  const [viewMode, setViewMode] = useState<string>("by-factor");

  const { data: stats, isInitialLoading: statsLoading } = useQuery<Stats>(
    ["summary-charts-stats", from, to],
    () =>
      apiClient.getViolationStats({
        from: from || undefined,
        to: to || undefined,
      }),
    {
      enabled: !isInitialLoading && !!me?.canAccessNow && reportType === "violations",
      keepPreviousData: true,
    },
  );

  if (isInitialLoading) {
    return (
      <div className="max-w-3xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Загрузка…</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Проверяем статус доступа.
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  if (me && !me.canAccessNow) {
    return <AccessRestrictionNotice blocked={(me as any).isBlocked ?? false} />;
  }


  return (
    <div className="max-w-5xl mx-auto p-4 sm:p-6 space-y-4">
      <Card className="card-elevated h-full">
        <CardHeader>
          <CardTitle>Сводные диаграммы</CardTitle>
          <CardDescription>
            Здесь вы сможете создавать сводные отчёты в виде гистограмм и диаграмм.
            Выберите период, вид диаграммы и вариант отображения, чтобы посмотреть нужный срез данных.
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          <Alert>
            <AlertTitle>Сводные диаграммы</AlertTitle>
            <AlertDescription>
              Выберите период, тип отчёта, вид диаграммы и вариант отображения. После нажатия кнопки
              ниже система построит сводный график по данным за выбранный период.
            </AlertDescription>
          </Alert>

          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div className="space-y-2">
              <Label>Период с</Label>
              <Input
                type="date"
                value={from}
                onChange={(e) => setFrom(e.target.value)}
              />
            </div>
            <div className="space-y-2">
              <Label>Период по</Label>
              <Input
                type="date"
                value={to}
                onChange={(e) => setTo(e.target.value)}
              />
            </div>
            <div className="space-y-2">
              <Label>Тип отчёта</Label>
              <Select
                value={reportType}
                onValueChange={(val) => setReportType(val)}
              >
                <SelectTrigger>
                  <SelectValue placeholder="Выберите показатель" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="violations">Нарушения / ПАБ</SelectItem>
                  <SelectItem value="presence" disabled>
                    Посещаемость (скоро)
                  </SelectItem>
                  <SelectItem value="pc" disabled>
                    Производственный контроль (скоро)
                  </SelectItem>
                </SelectContent>
              </Select>
            </div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div className="space-y-2">
              <Label>Вид диаграммы</Label>
              <Select value={chartType} onValueChange={(val) => setChartType(val)}>
                <SelectTrigger>
                  <SelectValue placeholder="Столбчатая, круговая и др." />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="bar">Гистограмма (столбчатая)</SelectItem>
                  <SelectItem value="pie">Круговая диаграмма</SelectItem>
                  <SelectItem value="line">Линейный график</SelectItem>
                </SelectContent>
              </Select>
            </div>
            <div className="space-y-2">
              <Label>Вариант отображения</Label>
              <Select value={viewMode} onValueChange={(val) => setViewMode(val)}>
                <SelectTrigger>
                  <SelectValue placeholder="По подразделениям, видам и т.п." />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="by-shop">По ответственным</SelectItem>
                  <SelectItem value="by-factor">По опасным факторам</SelectItem>
                  <SelectItem value="by-status">По статусу устранения</SelectItem>
                </SelectContent>
              </Select>
            </div>
          </div>

          <div className="flex justify-end">
            <Button
              variant="secondary"
              disabled={reportType !== "violations"}
            >
              Построить диаграмму
            </Button>
          </div>

          <div className="border rounded-md p-4 bg-muted/40 flex items-center justify-center h-64">
            {reportType !== "violations" ? (
              <div className="text-sm text-muted-foreground text-center max-w-md">
                Для выбранного типа отчёта диаграммы пока не настроены. Выберите
                «Нарушения / ПАБ», чтобы увидеть сводную диаграмму.
              </div>
            ) : statsLoading ? (
              <div className="text-sm text-muted-foreground">Загрузка данных…</div>
            ) : !stats || stats.total === 0 ? (
              <div className="text-sm text-muted-foreground text-center max-w-md">
                За выбранный период нет данных для отображения. Попробуйте изменить
                даты или настройки.
              </div>
            ) : (
              <div className="w-full h-full flex flex-col justify-center">
                {chartType === "bar" && viewMode === "by-factor" && (
                  <div className="space-y-2">
                    <div className="text-sm font-medium text-center mb-2">
                      Нарушения по опасным факторам
                    </div>
                    <div className="flex items-end gap-2 h-40">
                      {(stats.byHazardFactor || [])
                        .slice(0, 8)
                        .map((it: any, idx: number) => {
                          const max = Math.max(
                            ...((stats.byHazardFactor || []) as any[]).map(
                              (x: any) => x.count || 0,
                            ),
                            1,
                          );
                          const height = Math.max(
                            8,
                            Math.round(((it.count || 0) / max) * 100),
                          );
                          return (
                            <div
                              key={idx}
                              className="flex flex-col items-center flex-1 min-w-[32px]"
                            >
                              <div className="text-xs mb-1 text-muted-foreground">
                                {it.count}
                              </div>
                              <div
                                className="w-full bg-primary/70 rounded-t-sm"
                                style={{ height: `${height}%` }}
                              />
                              <div className="mt-1 text-[10px] text-center line-clamp-2">
                                {it.label || "—"}
                              </div>
                            </div>
                          );
                        })}
                    </div>
                  </div>
                )}

                {chartType === "bar" && viewMode === "by-shop" && (
                  <div className="space-y-2">
                    <div className="text-sm font-medium text-center mb-2">
                      Нарушения по ответственным
                    </div>
                    <div className="flex items-end gap-2 h-40 overflow-x-auto">
                      {(stats.byResponsible || [])
                        .slice(0, 10)
                        .map((it: any, idx: number) => {
                          const max = Math.max(
                            ...((stats.byResponsible || []) as any[]).map(
                              (x: any) => x.total || 0,
                            ),
                            1,
                          );
                          const height = Math.max(
                            8,
                            Math.round(((it.total || 0) / max) * 100),
                          );
                          return (
                            <div
                              key={idx}
                              className="flex flex-col items-center flex-1 min-w-[48px]"
                            >
                              <div className="text-xs mb-1 text-muted-foreground">
                                {it.total}
                              </div>
                              <div
                                className="w-full bg-primary/70 rounded-t-sm"
                                style={{ height: `${height}%` }}
                              />
                              <div className="mt-1 text-[10px] text-center line-clamp-2">
                                {it.label || "—"}
                              </div>
                            </div>
                          );
                        })}
                    </div>
                  </div>
                )}

                {chartType === "bar" && viewMode === "by-status" && (
                  <div className="space-y-2">
                    <div className="text-sm font-medium text-center mb-2">
                      Нарушения по статусу
                    </div>
                    <div className="flex items-end gap-4 h-40 justify-center">
                      {[
                        { label: "Устранено", value: stats.resolved, color: "bg-emerald-600" },
                        {
                          label: "В работе",
                          value: (stats.inProgress || 0) + (stats.overdue || 0),
                          color: "bg-sky-600",
                        },
                        { label: "Просрочено", value: stats.overdue, color: "bg-rose-600" },
                      ].map((it, idx) => {
                        const max = Math.max(
                          stats.resolved || 0,
                          (stats.inProgress || 0) + (stats.overdue || 0),
                          stats.overdue || 0,
                          1,
                        );
                        const height = Math.max(
                          8,
                          Math.round(((it.value || 0) / max) * 100),
                        );
                        return (
                          <div
                            key={idx}
                            className="flex flex-col items-center min-w-[64px]"
                          >
                            <div className="text-xs mb-1 text-muted-foreground">
                              {it.value ?? 0}
                            </div>
                            <div
                              className={`w-8 ${it.color} rounded-t-sm`}
                              style={{ height: `${height}%` }}
                            />
                            <div className="mt-1 text-[11px] text-center line-clamp-2">
                              {it.label}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                )}

                {chartType !== "bar" && (
                  <div className="text-xs text-muted-foreground text-center mt-4">
                    Для выбранного вида диаграммы пока доступна только текстовая
                    сводка. Напишите, если вам критичны именно круговые/линейные
                    диаграммы — добавлю визуализацию.
                  </div>
                )}
              </div>
            )}
          </div>        </CardContent>
      </Card>
    </div>
  );
}

function ReportsScreen() {
  useAuth({ required: true });
  const { data: me, isInitialLoading } = useQuery<Profile>(["me"], () =>
    apiClient.getMyProfile(),
  );
  const navigate = useNavigate();

  // Период отчёта
  const [from, setFrom] = useState<string>("");
  const [to, setTo] = useState<string>("");

  // Данные по безопасности труда за выбранный период
  const { data: stats, isInitialLoading: statsLoading } = useQuery<Stats>(
    ["reports-safety-stats", from, to],
    () =>
      apiClient.getViolationStats({
        from: from || undefined,
        to: to || undefined,
      }),
    {
      enabled: !isInitialLoading && !!me?.canAccessNow,
      keepPreviousData: true,
    },
  );

  // Участники проекта и распределение по должностям
  const { data: jobStats, isInitialLoading: jobsLoading } =
    useQuery<JobTitleStats>(
      ["job-title-stats"],
      () => apiClient.getJobTitleStats(),
      {
        enabled: !isInitialLoading && !!me?.canAccessNow,
        staleTime: 60_000,
      },
    );

  // KBT (Комитет Безопасности Труда) summary for the same period
  type KbtMeetings = inferRPCOutputType<"listKbtMeetings">;
  const { data: kbtPlan, isInitialLoading: kbtLoading } = useQuery<KbtMeetings>(
    ["kbt-plan-stats", from, to],
    () =>
      apiClient.listKbtMeetings({
        from: from || undefined,
        to: to || undefined,
        limit: 1000,
        type: "PLAN",
      }),
    { enabled: !isInitialLoading && !!me?.canAccessNow },
  );
  const kbtStarred = React.useMemo(
    () =>
      (kbtPlan?.items ?? []).filter((m: any) =>
        (m.title || "").trim().startsWith("*"),
      ).length,
    [kbtPlan],
  );
  const kbtNonStar = React.useMemo(
    () =>
      (kbtPlan?.items ?? []).filter(
        (m: any) => !(m.title || "").trim().startsWith("*"),
      ).length,
    [kbtPlan],
  );

  // Экспорт: Excel, Word и PDF для блока «Статистика по Безопасности труда»
  const excelExport = useMutation(apiClient.exportReportsSafetyExcel, {
    onSuccess: (res: { url: string }) => {
      if (!res?.url) return;
      const sanitize = (s: string) =>
        (s || "")
          .replace(/[\\/:*?"<>|]+/g, " ")
          .replace(/\s+/g, " ")
          .trim();
      const datePart = (() => {
        if (from && to) return `_${from}—${to}`;
        if (from) return `_с_${from}`;
        if (to) return `_по_${to}`;
        return `_${new Date().toISOString().slice(0, 10)}`;
      })();
      const a = document.createElement("a");
      a.href = res.url;
      a.download = `${sanitize("Статистика нарушений")}${datePart}.xlsx`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    },
  });

  const exportReportPdf = useCallback(async () => {
    try {
      const element = document.getElementById("reports-print");
      if (!element) return;

      element.classList.add("pdf-export-center");
      await new Promise((r) => setTimeout(r, 0));

      const canvas = await html2canvas(element as HTMLElement, {
        scale: 2,
        useCORS: true,
        backgroundColor: "#ffffff",
      });

      element.classList.remove("pdf-export-center");

      const imgData = canvas.toDataURL("image/png");
      const pdf = new jsPDF("p", "mm", "a4");
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const margin = 10;
      const imgWidth = pageWidth - margin * 2;
      const imgHeight = (canvas.height * imgWidth) / canvas.width;

      let heightLeft = imgHeight;
      let position = margin;

      pdf.addImage(imgData, "PNG", margin, position, imgWidth, imgHeight);
      heightLeft -= pageHeight - margin * 2;
      position = margin - (pageHeight - margin * 2);

      while (heightLeft > 0) {
        pdf.addPage();
        pdf.addImage(imgData, "PNG", margin, position, imgWidth, imgHeight);
        heightLeft -= pageHeight - margin * 2;
        position -= pageHeight - margin * 2;
      }

      const sanitize = (s: string) =>
        (s || "")
          .replace(/[\\/:*?"<>|]+/g, " ")
          .replace(/\s+/g, " ")
          .trim();
      const datePart = (() => {
        if (from && to) return `_${from}—${to}`;
        if (from) return `_с_${from}`;
        if (to) return `_по_${to}`;
        return `_${new Date().toISOString().slice(0, 10)}`;
      })();
      const fileName =
        sanitize(`Статистика по Безопасности труда${datePart}`) ||
        "Статистика по Безопасности труда";
      pdf.save(`${fileName}.pdf`);
    } catch {
      console.error("PDF export failed (reports)");
    }
  }, [from, to]);

  if (isInitialLoading) {
    return (
      <div className="max-w-3xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Загрузка…</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Проверяем статус доступа.
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }
  if (me && !me.canAccessNow) {
    return <AccessRestrictionNotice blocked={(me as any).isBlocked ?? false} />;
  }

  return (
    <div className="max-w-5xl mx-auto p-4 sm:p-6 space-y-4">
      <Card className="card-elevated h-full">
        <CardHeader>
          <CardTitle>Отчёты</CardTitle>
        </CardHeader>
        <CardContent id="reports-print" className="space-y-6">
          {/* Блок: Статистика по Безопасности труда */}
          <div className="space-y-3">
            <div className="text-base font-bold uppercase text-center">
              СТАТИСТИКА ПО БЕЗОПАСНОСТИ ТРУДА
            </div>

            <div className="grid grid-cols-1 sm:grid-cols-3 gap-2 items-end">
              <div className="grid gap-1">
                <Label>Период с</Label>
                <Input
                  type="date"
                  value={from}
                  onChange={(e) => setFrom(e.target.value)}
                />
              </div>
              <div className="grid gap-1">
                <Label>Период по</Label>
                <Input
                  type="date"
                  value={to}
                  onChange={(e) => setTo(e.target.value)}
                />
              </div>
              <div className="hidden sm:block" />
            </div>
            <div className="text-sm font-semibold uppercase text-center text-muted-foreground">
              ДАННЫЕ ПОВЕДЕНЧЕСКОГО АУДИТА БЕЗОПАСНОСТИ
            </div>
            <div className="text-sm font-semibold text-center text-muted-foreground">
              (Пилотный проект ПАБ запущен с 20.10.2025г.)
            </div>
            <div className="grid grid-cols-2 md:grid-cols-5 gap-3">
              <div className="p-3 border rounded">
                <div className="text-xs text-muted-foreground">Всего</div>
                <div className="text-2xl font-semibold text-stats-total">
                  {statsLoading ? "…" : (stats?.total ?? 0)}
                </div>
              </div>
              <div className="p-3 border rounded">
                <div className="text-xs text-muted-foreground">Устранено</div>
                <div className="text-2xl font-semibold text-green-600">
                  {statsLoading ? "…" : (stats?.resolved ?? 0)}
                </div>
              </div>
              <div className="p-3 border rounded">
                <div className="text-xs text-muted-foreground">В работе</div>
                <div className="text-2xl font-semibold text-blue-600">
                  {statsLoading
                    ? "…"
                    : (stats?.inProgress ?? 0) + (stats?.overdue ?? 0)}
                </div>
              </div>
              <div className="p-3 border rounded">
                <div className="text-xs text-muted-foreground">Аудитов</div>
                <div className="text-2xl font-semibold">
                  {statsLoading ? "…" : (stats?.auditsTotal ?? 0)}
                </div>
              </div>
              <div className="p-3 border rounded">
                <div className="text-xs text-muted-foreground">Наблюдений</div>
                <div className="text-2xl font-semibold">
                  {statsLoading ? "…" : (stats?.observationsTotal ?? 0)}
                </div>
              </div>
            </div>
            {/* Доп. пояснение */}
            <div className="text-xs text-muted-foreground">
              Показатели автоматически обновляются при выборе дат периода.
            </div>
            {/* Категории и Виды условий/действий */}
            <div className="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
              {/* Категории наблюдений */}
              <div className="border rounded">
                <div className="px-3 py-2 text-base md:text-lg font-bold text-primary">
                  Категории наблюдений
                </div>
                <div className="divide-y">
                  {statsLoading ? (
                    <div className="px-3 py-3 text-sm text-muted-foreground">
                      Загрузка…
                    </div>
                  ) : stats?.byCategory && stats.byCategory.length > 0 ? (
                    stats.byCategory.map((it, idx) => (
                      <div
                        key={idx}
                        className="px-3 py-2 flex justify-between text-sm"
                      >
                        <div className="truncate pr-2">{it.label}</div>
                        <div className="text-muted-foreground">{it.count}</div>
                      </div>
                    ))
                  ) : (
                    <div className="px-3 py-3 text-sm text-muted-foreground">
                      Нет данных
                    </div>
                  )}
                </div>
              </div>

              {/* Виды условий и действий */}
              <div className="border rounded">
                <div className="px-3 py-2 text-base md:text-lg font-bold text-primary">
                  Виды условий и действий
                </div>
                <div className="divide-y">
                  {statsLoading ? (
                    <div className="px-3 py-3 text-sm text-muted-foreground">
                      Загрузка…
                    </div>
                  ) : stats?.byCondition && stats.byCondition.length > 0 ? (
                    stats.byCondition.map((it, idx) => (
                      <div
                        key={idx}
                        className="px-3 py-2 flex justify-between text-sm"
                      >
                        <div className="truncate pr-2">{it.label}</div>
                        <div className="text-muted-foreground">{it.count}</div>
                      </div>
                    ))
                  ) : (
                    <div className="px-3 py-3 text-sm text-muted-foreground">
                      Нет данных
                    </div>
                  )}
                </div>
              </div>
            </div>
            {/* Опасные факторы */}
            <div className="mt-4 border rounded">
              <div className="px-3 py-2 text-base md:text-lg font-bold text-primary">
                Опасные факторы
              </div>
              <div className="divide-y">
                {statsLoading ? (
                  <div className="px-3 py-3 text-sm text-muted-foreground">
                    Загрузка…
                  </div>
                ) : stats?.byHazardFactor &&
                  (stats.byHazardFactor as any[]).length > 0 ? (
                  (
                    stats.byHazardFactor as Array<{
                      label: string;
                      count: number;
                    }>
                  ).map((it, idx) => (
                    <div
                      key={idx}
                      className="px-3 py-2 flex justify-between text-sm"
                    >
                      <div className="truncate pr-2">{it.label}</div>
                      <div className="text-muted-foreground">{it.count}</div>
                    </div>
                  ))
                ) : (
                  <div className="px-3 py-3 text-sm text-muted-foreground">
                    Нет данных
                  </div>
                )}
              </div>
            </div>
            {/* Сводка участия в проекте */}
            <div className="mt-3 grid grid-cols-1 sm:grid-cols-[1fr_auto] items-center gap-3">
              <div className="text-sm font-bold uppercase">
                В ПРОЕКТЕ УЧАСТВУЕТ (чел)
              </div>
              <div className="border rounded px-4 py-2 text-2xl font-semibold text-right min-w-[96px]">
                {jobsLoading ? "…" : (jobStats?.total ?? 0)}
              </div>
            </div>
            <div className="mt-3 text-sm font-semibold">Из них</div>
            <div className="mt-2 border rounded divide-y">
              {jobsLoading ? (
                <div className="px-3 py-3 text-sm text-muted-foreground">
                  Загрузка…
                </div>
              ) : jobStats?.items && jobStats.items.length > 0 ? (
                jobStats.items.map((it, idx) => (
                  <div
                    key={idx}
                    className="px-3 py-2 flex justify-between text-sm"
                  >
                    <div className="truncate pr-2">{it.label}</div>
                    <div className="text-muted-foreground">{it.count}</div>
                  </div>
                ))
              ) : (
                <div className="px-3 py-3 text-sm text-muted-foreground">
                  Нет данных
                </div>
              )}
            </div>
            {/* Комитет Безопасности Труда */}
            <div className="hr-muted w-full h-px mt-6" />
            <div className="space-y-3">
              <div className="text-base font-bold uppercase text-center">
                КОМИТЕТ БЕЗОПАСНОСТИ ТРУДА
              </div>
              <div className="text-xs font-semibold text-center text-muted-foreground">
                (Начало проведения 24.08.2025)
              </div>
              <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                <div className="p-3 border rounded">
                  <div className="text-xs text-muted-foreground">
                    Количество проведенных собраний
                  </div>
                  <div className="text-2xl font-semibold">
                    {kbtLoading ? "…" : (kbtPlan?.total ?? 0)}
                  </div>
                </div>
                <div className="p-3 border rounded">
                  <div className="text-xs text-muted-foreground">
                    Нарушения/инциденты
                  </div>
                  <div className="text-2xl font-semibold">
                    {kbtLoading ? "…" : kbtStarred}
                  </div>
                </div>
                <div className="p-3 border rounded">
                  <div className="text-xs text-muted-foreground">
                    Кол-во плановых собраний
                  </div>
                  <div className="text-2xl font-semibold">
                    {kbtLoading ? "…" : kbtNonStar}
                  </div>
                </div>
              </div>
            </div>

            {/* Производственный контроль */}
            <div className="hr-muted w-full h-px mt-6" />
            <div className="space-y-3">
              <div className="text-base font-bold uppercase text-center">
                ПРОИЗВОДСТВЕННЫЙ КОНТРОЛЬ
              </div>
              <div className="text-sm text-muted-foreground text-center">
                Раздел в разработке. Сообщите, какие показатели и источники
                данных нужны — добавлю.
              </div>
              <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                <div className="p-3 border rounded">
                  <div className="text-xs text-muted-foreground">
                    Показатель 1
                  </div>
                  <div className="text-2xl font-semibold">—</div>
                </div>
                <div className="p-3 border rounded">
                  <div className="text-xs text-muted-foreground">
                    Показатель 2
                  </div>
                  <div className="text-2xl font-semibold">—</div>
                </div>
                <div className="p-3 border rounded">
                  <div className="text-xs text-muted-foreground">
                    Показатель 3
                  </div>
                  <div className="text-2xl font-semibold">—</div>
                </div>
              </div>
            </div>
          </div>
        </CardContent>
        <CardFooter>
          <Button variant="secondary" onClick={() => navigate("/home")}>
            На главную
          </Button>
        </CardFooter>
      </Card>
      <div className="max-w-5xl mx-auto px-4 pb-6 mt-2">
        <div className="flex flex-col gap-3 items-stretch sm:flex-row sm:items-center sm:gap-2">
          <div className="flex gap-2">
            <Button
              variant="secondary"
              disabled={excelExport.isLoading}
              onClick={() =>
                excelExport.mutate({
                  from: from || undefined,
                  to: to || undefined,
                })
              }
            >
              Скачать Excel
            </Button>
            <Button variant="secondary" onClick={() => void exportReportPdf()}>
              Скачать PDF
            </Button>
          </div>
        </div>
      </div>
    </div>
  );
}

function ASUBTScreen() {
  useAuth({ required: true });
  const { data: me, isInitialLoading } = useQuery<Profile>(["me"], () =>
    apiClient.getMyProfile(),
  );
  const navigate = useNavigate();
  if (isInitialLoading) {
    return (
      <div className="max-w-3xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Загрузка…</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Проверяем статус доступа.
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }
  if (me && !me.canAccessNow) {
    return <AccessRestrictionNotice blocked={(me as any).isBlocked ?? false} />;
  }
  return (
    <div className="max-w-3xl mx-auto p-4 sm:p-6">
      <Card className="card-elevated h-full">
        <CardHeader>
          <CardTitle>АСУБТ</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <button
              className="w-full h-24 btn-3d text-base font-semibold touch-target flex items-center justify-center"
              onClick={() => navigate("/asubt/ppe")}
            >
              СИЗ
            </button>
            <button
              className="w-full h-24 btn-3d text-base font-semibold touch-target flex items-center justify-center"
              onClick={() => navigate("/asubt/sout")}
            >
              СОУТ
            </button>
            <button
              className="w-full h-24 btn-3d text-base font-semibold touch-target flex items-center justify-center"
              onClick={() => navigate("/asubt/mo")}
            >
              МО
            </button>
            <button
              className="w-full h-24 btn-3d text-base font-semibold touch-target flex items-center justify-center"
              onClick={() => navigate("/asubt/docs")}
            >
              Документация
            </button>
            <button
              className="w-full h-24 btn-3d text-base font-semibold touch-target flex items-center justify-center"
              onClick={() => navigate("/asubt/reports")}
            >
              Отчетность
            </button>
            <button
              className="w-full h-24 btn-3d text-base font-semibold touch-target flex items-center justify-center"
              onClick={() => navigate("/asubt/work-orders")}
            >
              Наряд-задания
            </button>
            <button
              className="w-full h-24 btn-3d text-base font-semibold touch-target flex items-center justify-center sm:col-span-2"
              onClick={() => navigate("/asubt/planning")}
            >
              Планирование мероприятий
            </button>
          </div>
        </CardContent>
        <CardFooter>
          <Button variant="secondary" onClick={() => navigate("/home")}>
            На главную
          </Button>
        </CardFooter>
      </Card>
    </div>
  );
}

function AsubtModuleScreen({
  title,
  children,
}: {
  title: string;
  children: React.ReactNode;
}) {
  useAuth({ required: true });
  const { data: me, isInitialLoading } = useQuery<Profile>(["me"], () =>
    apiClient.getMyProfile(),
  );
  const navigate = useNavigate();
  if (isInitialLoading) {
    return (
      <div className="max-w-3xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Загрузка…</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Проверяем статус доступа.
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }
  if (me && !me.canAccessNow) {
    return <AccessRestrictionNotice blocked={(me as any).isBlocked ?? false} />;
  }
  return (
    <div className="max-w-3xl mx-auto p-4 sm:p-6">
      <Card className="card-elevated h-full">
        <CardHeader>
          <CardTitle>{title}</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="text-muted-foreground whitespace-pre-line text-sm">
            {children}
          </div>
        </CardContent>
        <CardFooter>
          <Button variant="secondary" onClick={() => navigate("/asubt")}>
            Назад в АСУБТ
          </Button>
        </CardFooter>
      </Card>
    </div>
  );
}

function MoreScreen() {
  useAuth({ required: true });
  const { data: me, isInitialLoading } = useQuery<Profile>(["me"], () =>
    apiClient.getMyProfile(),
  );
  const navigate = useNavigate();
  // QR for login moved here from Home
  const loginUrlMore = useMemo(() => new URL("/", getBaseUrl()).toString(), []);
  const [qrDataUrlMore, setQrDataUrlMore] = useState<string>("");
  useEffect(() => {
    let mounted = true;
    (async () => {
      try {
        const dataUrl = await QRCode.toDataURL(loginUrlMore, {
          width: 192,
          margin: 2,
        });
        if (mounted) setQrDataUrlMore(dataUrl);
      } catch {
        console.error("QR gen failed");
      }
    })();
    return () => {
      mounted = false;
    };
  }, [loginUrlMore]);

  if (isInitialLoading) {
    return (
      <div className="max-w-3xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Загрузка…</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Проверяем статус доступа.
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }
  if (me && !me.canAccessNow) {
    return <AccessRestrictionNotice blocked={(me as any).isBlocked ?? false} />;
  }

  return (
    <div className="max-w-3xl mx-auto p-4 sm:p-6">
      {/* QR code moved here from Home: placed at the top of the page */}
      <Card className="card-elevated mb-4">
        <CardHeader>
          <CardTitle>QR‑код для входа</CardTitle>
        </CardHeader>
        <CardContent className="flex flex-col items-center gap-2">
          {qrDataUrlMore ? (
            <img
              src={qrDataUrlMore}
              alt="QR-код для входа"
              className="w-32 h-32 border rounded bg-white p-2"
            />
          ) : (
            <div className="text-xs text-muted-foreground">Генерация…</div>
          )}
          <div className="text-xs text-muted-foreground">Вход с телефона</div>
        </CardContent>
      </Card>

      <Card className="card-elevated h-full">
        <CardHeader>
          <CardTitle>Дополнительно</CardTitle>
        </CardHeader>
        <CardContent className="grid grid-cols-1 sm:grid-cols-2 gap-4">
          {/* Перенесённые разделы в их текущем состоянии */}
          <button
            className="w-full h-24 btn-3d text-base font-semibold touch-target flex items-center justify-center"
            onClick={() => navigate("/my-violations")}
          >
            Просмотр моих нарушений
          </button>
          <button
            className="w-full h-24 btn-3d-red text-base font-semibold touch-target flex items-center justify-center"
            onClick={() => navigate("/kbt")}
          >
            КБТ
          </button>
          <button
            className="w-full h-24 btn-3d text-base font-semibold touch-target flex items-center justify-center"
            onClick={() => navigate("/support")}
          >
            Техническая поддержка
          </button>
          <button
            className="w-full h-24 btn-3d text-base font-semibold touch-target flex items-center justify-center"
            onClick={() => navigate("/training")}
          >
            Обучение
          </button>
          <button
            className="w-full h-24 btn-3d text-base font-semibold touch-target flex items-center justify-center"
            onClick={() => navigate("/webinars")}
          >
            Вебинары по ОТиПБ
          </button>
          <button
            className="w-full h-24 btn-3d text-base font-semibold touch-target flex items-center justify-center"
            onClick={() => navigate("/library")}
          >
            Библиотека по ОТиПБ
          </button>
          {(me?.isAdmin || me?.isSuperAdmin) && (
            <button
              className="w-full h-24 btn-3d text-base font-semibold touch-target flex items-center justify-center"
              onClick={() => navigate("/profile-setup")}
            >
              Настройка профиля
            </button>
          )}
          <button
            className="w-full h-24 btn-3d text-base font-semibold touch-target flex items-center justify-center"
            onClick={() => navigate("/itr-attestations")}
          >
            Аттестации ИТР
          </button>
          <button
            className="w-full h-24 btn-3d text-base font-semibold touch-target flex items-center justify-center"
            onClick={() => navigate("/storage")}
          >
            Хранилище
          </button>
        </CardContent>
        <CardFooter>
          <Button variant="secondary" onClick={() => navigate("/home")}>
            На главную
          </Button>
        </CardFooter>
      </Card>
    </div>
  );
}

function OTPBScreen() {
  useAuth({ required: true });
  const { data: me, isInitialLoading } = useQuery<Profile>(["me"], () =>
    apiClient.getMyProfile(),
  );

  if (isInitialLoading) {
    return (
      <div className="max-w-3xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Загрузка…</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Проверяем доступ к разделу ОТиПБ.
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  const isAdmin = !!me?.isAdmin || (me as any)?.isSuperAdmin;
  const department = (me?.department || "").trim().toLowerCase();
  const isOtpb = department === "отипб" || department === "от ипб";

  if (!isAdmin && !isOtpb) {
    return (
      <div className="max-w-3xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Доступ ограничен</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground text-sm">
              Этот раздел предназначен только для специалистов подразделения
              «ОТиПБ» и администраторов.
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="max-w-3xl mx-auto p-4 sm:p-6">
      <Card className="card-elevated h-full">
        <CardHeader>
          <CardTitle>Блок специалистов ОТиПБ</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="text-muted-foreground text-sm whitespace-pre-line">
            Здесь будет размещён функционал для специалистов по охране труда и
            промышленной безопасности (ОТиПБ): учёт мероприятий, анализ
            показателей, подготовка отчётности и другие инструменты.
          </div>
        </CardContent>
      </Card>
    </div>
  );
}

function KBTScreen() {
  useAuth({ required: true });
  const { data: me, isInitialLoading } = useQuery<Profile>(["me"], () =>
    apiClient.getMyProfile(),
  );
  const navigate = useNavigate();

  if (isInitialLoading) {
    return (
      <div className="max-w-3xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Загрузка…</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Проверяем статус доступа.
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }
  if (me && !me.canAccessNow) {
    return <AccessRestrictionNotice blocked={(me as any).isBlocked ?? false} />;
  }

  return (
    <div className="max-w-3xl mx-auto p-4 sm:p-6">
      <Card className="card-elevated h-full">
        <CardHeader>
          <CardTitle>Комитет Безопасности Труда (КБТ)</CardTitle>
        </CardHeader>
        <CardContent className="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <button
            className="w-full h-24 btn-3d text-base font-semibold touch-target flex items-center justify-center"
            onClick={() => navigate("/kbt/protocols")}
          >
            КБТ плановый
          </button>
          <button
            className="w-full h-24 btn-3d text-base font-semibold touch-target flex items-center justify-center"
            onClick={() => navigate("/kbt/report")}
          >
            Отчитаться по КБТ
          </button>
        </CardContent>
        <CardFooter>
          <Button variant="secondary" onClick={() => navigate("/home")}>
            На главную
          </Button>
        </CardFooter>
      </Card>
    </div>
  );
}

function AttestationITRScreen() {
  useAuth({ required: true });
  const { data: me, isInitialLoading } = useQuery<Profile>(["me"], () =>
    apiClient.getMyProfile(),
  );
  const navigate = useNavigate();
  if (isInitialLoading) {
    return (
      <div className="max-w-3xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Загрузка…</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Проверяем статус доступа.
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }
  if (me && !me.canAccessNow) {
    return <AccessRestrictionNotice blocked={(me as any).isBlocked ?? false} />;
  }
  return (
    <div className="max-w-3xl mx-auto p-4 sm:p-6">
      <Card className="card-elevated h-full">
        <CardHeader>
          <CardTitle>Аттестации ИТР</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="text-muted-foreground">
            Здесь будет раздел с материалами и графиком аттестаций ИТР.
            Сообщите, что именно отобразить — добавим содержание и ссылки.
          </div>
        </CardContent>
        <CardFooter>
          <Button variant="secondary" onClick={() => navigate("/home")}>
            На главную
          </Button>
        </CardFooter>
      </Card>
    </div>
  );
}

function WebinarsScreen() {
  useAuth({ required: true });
  const { data: me, isInitialLoading } = useQuery<Profile>(["me"], () =>
    apiClient.getMyProfile(),
  );
  const navigate = useNavigate();
  const { toast } = useToast();
  const queryClient = useQueryClient();

  type WebinarList = inferRPCOutputType<"listWebinarVideos">;

  const { data: webinars, isInitialLoading: webinarsLoading } =
    useQuery<WebinarList>(["webinars"], () => apiClient.listWebinarVideos());

  const [title, setTitle] = useState("");
  const [description, setDescription] = useState("");
  const [file, setFile] = useState<File | null>(null);
  const [externalUrl, setExternalUrl] = useState("");
  const [selectedId, setSelectedId] = useState<string | null>(null);

  const createMutation = useMutation(apiClient.createWebinarVideo, {
    onSuccess: (res: { ok: boolean; error?: string }) => {
      if (res?.ok) {
        toast({ title: "Видео добавлено" });
        setTitle("");
        setDescription("");
        setFile(null);
        setExternalUrl("");
        void queryClient.invalidateQueries(["webinars"]);
      } else {
        toast({
          title: "Не удалось сохранить",
          description:
            res?.error === "TITLE_REQUIRED"
              ? "Укажите название вебинара"
              : res?.error === "FILE_TOO_LARGE"
                ? "Файл больше 100 МБ"
                : res?.error === "INVALID_URL"
                  ? "Некорректная ссылка на видео"
                  : res?.error === "NO_SOURCE"
                    ? "Выберите файл или укажите ссылку"
                    : "Произошла внутренняя ошибка",
        });
      }
    },
    onError: () => {
      toast({ title: "Не удалось сохранить" });
    },
  });

  const canEdit = Boolean(me?.isAdmin || (me as any)?.isSuperAdmin);

  if (isInitialLoading) {
    return (
      <div className="max-w-3xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Вебинары по ОТиПБ</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Проверяем статус доступа.
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }
  if (me && !me.canAccessNow) {
    return <AccessRestrictionNotice blocked={(me as any).isBlocked ?? false} />;
  }

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!title.trim()) {
      toast({ title: "Укажите название вебинара" });
      return;
    }
    if (createMutation.isLoading) return;

    const payload: inferRPCInputType<"createWebinarVideo"> = {
      title: title.trim(),
      description: description.trim() || undefined,
      base64: undefined,
      fileName: undefined,
      externalUrl: externalUrl.trim() || undefined,
    } as any;

    if (file) {
      const MAX = 100 * 1024 * 1024;
      if (file.size > MAX) {
        toast({ title: "Файл больше 100 МБ" });
        return;
      }
      try {
        const base64 = await encodeFileAsBase64DataURL(file);
        if (!base64) {
          toast({ title: "Не удалось прочитать файл" });
          return;
        }
        payload.base64 = base64;
        payload.fileName = file.name;
      } catch (err) {
        console.error("webinar file encode failed", { err });
        toast({ title: "Не удалось прочитать файл" });
        return;
      }
    }

    if (!payload.base64 && !payload.externalUrl) {
      toast({ title: "Выберите файл или укажите ссылку" });
      return;
    }

    createMutation.mutate(payload);
  };

  const selected =
    selectedId && webinars ? webinars.find((w: any) => w.id === selectedId) : null;

  return (
    <div className="max-w-3xl mx-auto p-4 sm:p-6">
      <Card className="card-elevated h-full">
        <CardHeader>
          <CardTitle>Вебинары по ОТиПБ</CardTitle>
        </CardHeader>
        <CardContent className="space-y-6">
          <div className="text-muted-foreground">
            На этой странице размещаются записи и ссылки на вебинары по ОТиПБ.
          </div>

          {canEdit && (
            <form onSubmit={handleSubmit} className="space-y-3">
              <div className="space-y-1.5">
                <Label>Название вебинара *</Label>
                <Input
                  value={title}
                  onChange={(e) => setTitle(e.target.value)}
                  placeholder="Например: Вводный инструктаж по ОТиПБ"
                />
              </div>
              <div className="space-y-1.5">
                <Label>Краткое описание</Label>
                <Textarea
                  value={description}
                  onChange={(e) => setDescription(e.target.value)}
                  rows={3}
                  placeholder="О чем вебинар, для кого предназначен"
                />
              </div>
              <div className="space-y-1.5">
                <Label>Видео-файл (до 100 МБ)</Label>
                <Input
                  type="file"
                  accept="video/*"
                  onChange={(e) => {
                    const f = e.target.files?.[0] || null;
                    setFile(f);
                  }}
                />
              </div>
              <div className="space-y-1.5">
                <Label>Ссылка на видео (YouTube, корпоративный портал и др.)</Label>
                <Input
                  value={externalUrl}
                  onChange={(e) => setExternalUrl(e.target.value)}
                  placeholder="https://..."
                />
              </div>
              <div className="text-xs text-muted-foreground">
                Можно загрузить файл или указать ссылку. Если заполнены оба варианта,
                приоритет будет у файла. Для максимальной совместимости рекомендуется загружать видео в формате MP4 (H.264 + AAC).
              </div>
              <div className="flex flex-wrap gap-2">
                <Button type="submit" disabled={createMutation.isLoading}>
                  {createMutation.isLoading ? "Сохраняем…" : "Добавить вебинар"}
                </Button>
                <Button
                  type="button"
                  variant="ghost"
                  disabled={createMutation.isLoading}
                  onClick={() => {
                    setTitle("");
                    setDescription("");
                    setFile(null);
                    setExternalUrl("");
                  }}
                >
                  Очистить
                </Button>
              </div>
            </form>
          )}

          <div className="space-y-3">
            <div className="font-medium">Доступные записи</div>
            {webinarsLoading && !webinars && (
              <div className="text-sm text-muted-foreground">Загружаем список…</div>
            )}
            {!webinarsLoading && (!webinars || webinars.length === 0) && (
              <div className="text-sm text-muted-foreground">
                Пока нет загруженных вебинаров.
              </div>
            )}
            {webinars && webinars.length > 0 && (
              <div className="grid gap-3 sm:grid-cols-2">
                {webinars.map((w: any) => (
                  <Card
                    key={w.id}
                    className="cursor-pointer hover:bg-accent transition-colors"
                    onClick={() => setSelectedId(w.id)}
                  >
                    <CardContent className="p-3 space-y-2">
                      <div className="text-sm font-medium line-clamp-2">
                        {w.title}
                      </div>
                      {w.description && (
                        <div className="text-xs text-muted-foreground line-clamp-3">
                          {w.description}
                        </div>
                      )}
                      <div className="text-xs text-muted-foreground">
                        {w.isExternal ? "Ссылка на внешнее видео" : "Загруженный файл"}
                      </div>
                    </CardContent>
                  </Card>
                ))}
              </div>
            )}
          </div>
        </CardContent>
        <CardFooter className="flex justify-between items-center">
          <Button variant="secondary" onClick={() => navigate("/home")}>
            На главную
          </Button>
          <div className="text-xs text-muted-foreground">
            Для просмотра нажмите на нужный вебинар.
          </div>
        </CardFooter>
      </Card>

      <Dialog
        open={!!selected}
        onOpenChange={(open) => {
          if (!open) setSelectedId(null);
        }}
      >
        <DialogContent className="max-w-3xl">
          {selected && (
            <>
              <DialogHeader>
                <DialogTitle>{selected.title}</DialogTitle>
                {selected.description && (
                  <DialogDescription>{selected.description}</DialogDescription>
                )}
              </DialogHeader>
              <div className="mt-3">
                {selected.isExternal ? (
                  <div className="space-y-2">
                    <div className="aspect-video w-full">
                      <iframe
                        src={selected.videoUrl}
                        className="w-full h-full rounded-md border"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen"
                      />
                    </div>
                    <div className="text-xs text-muted-foreground">
                      Если встроенный плеер не открывается, вы можете
                      <a
                        href={selected.videoUrl}
                        target="_blank"
                        rel="noreferrer"
                        className="ml-1 underline"
                      >
                        открыть видео в новой вкладке
                      </a>
                      .
                    </div>
                  </div>
                ) : (
                  <div className="space-y-2">
                    <video
                      className="w-full rounded-md"
                      src={selected.videoUrl}
                      controls
                      onError={() => {
                        console.error("webinar video playback error", selected.videoUrl);
                      }}
                    />
                    <div className="text-xs text-muted-foreground">
                      Если видео не воспроизводится, вы можете
                      <a
                        href={selected.videoUrl}
                        target="_blank"
                        rel="noreferrer"
                        className="ml-1 underline"
                      >
                        открыть или скачать файл в новой вкладке
                      </a>
                      .
                    </div>
                  </div>
                )}
              </div>
            </>
          )}
        </DialogContent>
      </Dialog>
    </div>
  );
}

function LibraryScreen() {
  useAuth({ required: true });
  const { data: me, isInitialLoading } = useQuery<Profile>(["me"], () =>
    apiClient.getMyProfile(),
  );
  const navigate = useNavigate();
  if (isInitialLoading) {
    return (
      <div className="max-w-3xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Загрузка…</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Проверяем статус доступа.
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }
  if (me && !me.canAccessNow) {
    return <AccessRestrictionNotice blocked={(me as any).isBlocked ?? false} />;
  }
  return (
    <div className="max-w-3xl mx-auto p-4 sm:p-6">
      <Card className="card-elevated h-full">
        <CardHeader>
          <CardTitle>Библиотека по ОТиПБ</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="text-muted-foreground">
            Здесь появится библиотека документов, инструкций и материалов по
            ОТиПБ. Передайте перечень и ссылки — добавим их сюда.
          </div>
        </CardContent>
        <CardFooter>
          <Button variant="secondary" onClick={() => navigate("/home")}>
            На главную
          </Button>
        </CardFooter>
      </Card>
    </div>
  );
}

function TrainingScreen() {
  useAuth({ required: true });
  const { data: me, isInitialLoading } = useQuery<Profile>(["me"], () =>
    apiClient.getMyProfile(),
  );
  const navigate = useNavigate();
  if (isInitialLoading) {
    return (
      <div className="max-w-3xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Загрузка…</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Проверяем статус доступа.
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }
  if (me && !me.canAccessNow) {
    return <AccessRestrictionNotice blocked={(me as any).isBlocked ?? false} />;
  }
  return (
    <div className="max-w-3xl mx-auto p-4 sm:p-6">
      <Card className="card-elevated h-full">
        <CardHeader>
          <CardTitle>Обучение</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="text-muted-foreground">
            Здесь будут курсы, инструкции и материалы для обучения. Если у вас
            есть готовый список тем или ссылки на внешние ресурсы, пришлите их —
            добавим на эту страницу.
          </div>
        </CardContent>
        <CardFooter className="flex gap-2 flex-wrap">
          <Button
            className="btn-3d"
            onClick={() => navigate("/training/select")}
          >
            Выбрать обучение
          </Button>
          <Button variant="secondary" onClick={() => navigate("/home")}>
            На главную
          </Button>
        </CardFooter>
      </Card>
    </div>
  );
}

function SupportScreen() {
  useAuth({ required: true });
  const { data: me, isInitialLoading } = useQuery<Profile>(["me"], () =>
    apiClient.getMyProfile(),
  );
  const navigate = useNavigate();
  const { toast } = useToast();

  const [subject, setSubject] = useState<string>("");
  const [message, setMessage] = useState<string>("");
  const [attachments, setAttachments] = useState<File[]>([]);
  const [sentInfo, setSentInfo] = useState<{ ok: boolean; details?: string }>();

  const sendMutation = useMutation(apiClient.sendSupportRequest, {
    onSuccess: (res: {
      ok: boolean;
      successCount?: number;
      failureCount?: number;
      error?: string;
    }) => {
      if (res?.ok) {
        setSentInfo({
          ok: true,
          details: `Отправлено: ${res.successCount ?? 0}${res.failureCount ? ", ошибок: " + res.failureCount : ""}`,
        });
        setMessage("");
      } else {
        setSentInfo({
          ok: false,
          details: res?.error || "Не удалось отправить",
        });
      }
    },
    onError: () => setSentInfo({ ok: false, details: "Ошибка отправки" }),
  });

  if (isInitialLoading) {
    return (
      <div className="max-w-3xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Загрузка…</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Проверяем статус доступа.
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }
  if (me && !me.canAccessNow) {
    return <AccessRestrictionNotice blocked={(me as any).isBlocked ?? false} />;
  }

  return (
    <div className="max-w-3xl mx-auto p-4 sm:p-6">
      <Card className="card-elevated h-full">
        <CardHeader>
          <CardTitle>Служба поддержки</CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <form
            onSubmit={(e) => {
              e.preventDefault();
              if (!message.trim()) {
                toast({ title: "Напишите сообщение" });
                return;
              }
              (async () => {
                const MAX = 100 * 1024 * 1024;
                const payloadAttachments: { base64: string; name: string }[] =
                  [];
                for (const f of attachments) {
                  try {
                    if (f.size > MAX) continue;
                    const base64 = await encodeFileAsBase64DataURL(f);
                    if (base64)
                      payloadAttachments.push({ base64, name: f.name });
                  } catch (err) {
                    console.error("Attachment encode failed", {
                      file: f?.name,
                      err,
                    });
                  }
                }
                sendMutation.mutate({
                  subject: subject.trim() || undefined,
                  message,
                  attachments: payloadAttachments,
                });
              })();
            }}
            className="space-y-3"
          >
            <div className="space-y-1.5">
              <Label>Тема</Label>
              <Input
                value={subject}
                onChange={(e) => setSubject(e.target.value)}
                placeholder="Кратко опишите тему обращения"
              />
            </div>
            <div className="space-y-1.5">
              <Label>Сообщение *</Label>
              <Textarea
                value={message}
                onChange={(e) => setMessage(e.target.value)}
                placeholder="Опишите проблему или задайте вопрос"
                rows={6}
              />
            </div>
            <div className="space-y-1.5">
              <Label>Вложения (до 100 МБ каждый)</Label>
              <Input
                type="file"
                multiple
                onChange={(e) =>
                  setAttachments(Array.from(e.target.files || []))
                }
              />
            </div>
            <div className="flex flex-wrap gap-2">
              <Button type="submit" disabled={sendMutation.isLoading}>
                {sendMutation.isLoading ? "Отправляем…" : "Отправить"}
              </Button>
              <Button
                variant="ghost"
                type="button"
                onClick={() => navigate("/home")}
              >
                На главную
              </Button>
            </div>
          </form>
          {sentInfo && (
            <Alert
              className="mt-2"
              variant={sentInfo.ok ? "default" : ("destructive" as any)}
            >
              <AlertTitle>
                {sentInfo.ok ? "Сообщение отправлено" : "Не удалось отправить"}
              </AlertTitle>
              {sentInfo.details && (
                <AlertDescription>{sentInfo.details}</AlertDescription>
              )}
            </Alert>
          )}
        </CardContent>
      </Card>
    </div>
  );
}

function AdminSupportScreen() {
  useAuth({ required: true });
  const { data: me, isInitialLoading } = useQuery<Profile>(["me"], () =>
    apiClient.getMyProfile(),
  );
  const navigate = useNavigate();
  const { toast } = useToast();
  const auth = useAuth();

  const [subject, setSubject] = useState<string>("");
  const [message, setMessage] = useState<string>("");
  const [attachments, setAttachments] = useState<File[]>([]);
  const [sentInfo, setSentInfo] = useState<{ ok: boolean; details?: string }>();

  const sendMutation = useMutation(apiClient.sendSupportRequest, {
    onSuccess: (res: {
      ok: boolean;
      successCount?: number;
      failureCount?: number;
      error?: string;
    }) => {
      if (res?.ok) {
        setSentInfo({
          ok: true,
          details: `Отправлено: ${res.successCount ?? 0}${res.failureCount ? ", ошибок: " + res.failureCount : ""}`,
        });
        setMessage("");
      } else {
        setSentInfo({
          ok: false,
          details: res?.error || "Не удалось отправить",
        });
      }
    },
    onError: () => setSentInfo({ ok: false, details: "Ошибка отправки" }),
  });

  if (isInitialLoading) {
    return (
      <div className="max-w-3xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Загрузка…</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Проверяем статус доступа.
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }
  if (!me?.isAdmin) {
    return (
      <div className="max-w-4xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Доступ ограничен</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Раздел доступен только администраторам.
            </div>
          </CardContent>
          <CardFooter>
            <Button variant="secondary" onClick={() => navigate("/admin")}>
              Назад
            </Button>
          </CardFooter>
        </Card>
      </div>
    );
  }

  return (
    <div className="max-w-3xl mx-auto p-4 sm:p-6">
      <Card className="card-elevated h-full">
        <CardHeader>
          <CardTitle>Служба поддержки (админ)</CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <form
            onSubmit={(e) => {
              e.preventDefault();
              if (!message.trim()) {
                toast({ title: "Напишите сообщение" });
                return;
              }
              (async () => {
                const MAX = 100 * 1024 * 1024;
                const payloadAttachments: { base64: string; name: string }[] =
                  [];
                for (const f of attachments) {
                  try {
                    if (f.size > MAX) continue;
                    const base64 = await encodeFileAsBase64DataURL(f);
                    if (base64)
                      payloadAttachments.push({ base64, name: f.name });
                  } catch (err) {
                    console.error("Attachment encode failed", {
                      file: f?.name,
                      err,
                    });
                  }
                }
                sendMutation.mutate({
                  subject: subject.trim() || undefined,
                  message,
                  attachments: payloadAttachments,
                });
              })();
            }}
            className="space-y-3"
          >
            <div className="space-y-1.5">
              <Label>Тема</Label>
              <Input
                value={subject}
                onChange={(e) => setSubject(e.target.value)}
                placeholder="Кратко опишите тему обращения"
              />
            </div>
            <div className="space-y-1.5">
              <Label>Сообщение *</Label>
              <Textarea
                value={message}
                onChange={(e) => setMessage(e.target.value)}
                placeholder="Опишите проблему или задайте вопрос"
                rows={6}
              />
            </div>
            <div className="space-y-1.5">
              <Label>Вложения (до 100 МБ каждый)</Label>
              <Input
                type="file"
                multiple
                onChange={(e) =>
                  setAttachments(Array.from(e.target.files || []))
                }
              />
            </div>
            <div className="flex flex-wrap gap-2">
              <Button type="submit" disabled={sendMutation.isLoading}>
                {sendMutation.isLoading ? "Отправляем…" : "Отправить"}
              </Button>
              <Button
                type="button"
                variant="secondary"
                onClick={() =>
                  auth.signIn({ provider: "AC1", scope: ["sendEmail"] })
                }
              >
                Разрешить отправку писем
              </Button>
              <Button
                variant="ghost"
                type="button"
                onClick={() => navigate("/home")}
              >
                На главную
              </Button>
            </div>
          </form>
          {sentInfo && (
            <Alert
              className="mt-2"
              variant={sentInfo.ok ? "default" : ("destructive" as any)}
            >
              <AlertTitle>
                {sentInfo.ok ? "Сообщение отправлено" : "Не удалось отправить"}
              </AlertTitle>
              {sentInfo.details && (
                <AlertDescription>{sentInfo.details}</AlertDescription>
              )}
            </Alert>
          )}
        </CardContent>
      </Card>
    </div>
  );
}

/* Admin Messaging Screen */
function AdminMessagingScreen() {
  useAuth({ required: true });
  const { data: me, isInitialLoading } = useQuery<Profile>(["me"], () =>
    apiClient.getMyProfile(),
  );
  const isAdmin = !!me?.isAdmin;
  const navigate = useNavigate();
  const { toast } = useToast();
  const auth = useAuth();

  // Broadcast form
  const [broadcastSubject, setBroadcastSubject] = useState("");
  const [broadcastBody, setBroadcastBody] = useState("");
  const broadcastMutation = useMutation(apiClient.sendBroadcastMessageAdmin, {
    onSuccess: (res: any) => {
      if (res?.ok) {
        toast({
          title: "Отправлено",
          description: `Успешно: ${res.successCount ?? 0}${res.failureCount ? ", ошибок: " + res.failureCount : ""}`,
        });
      } else if (res?.error === "MISSING_SEND_EMAIL_PERMISSION") {
        toast({
          title: "Нужно разрешение",
          description: "Предоставьте доступ на отправку писем, затем повторите",
        });
        try {
          auth.signIn({ provider: "AC1", scope: ["sendEmail"] });
        } catch {
          /* ignore */
        }
      } else {
        toast({ title: "Не удалось отправить" });
      }
    },
    onError: () => toast({ title: "Ошибка отправки" }),
  });

  // Individual form
  const [userQuery, setUserQuery] = useState("");
  const [selectedUserId, setSelectedUserId] = useState<string>("");
  const [individualSubject, setIndividualSubject] = useState("");
  const [individualBody, setIndividualBody] = useState("");

  // NOTE: Поиск сразу включён в общий список ниже, отдельный «userOptions» не используется и удалён

  // Preload all users for dropdown (up to 1000)
  const { data: userDropdownAll } = useQuery(
    ["mgrs-all-for-dropdown"],
    () => apiClient.searchManagers({ limit: 20000 }),
    { staleTime: 60_000 },
  );
  const filteredUserOptions = useMemo(() => {
    const arr = (userDropdownAll as any[]) || [];
    const q = (userQuery || "").trim().toLowerCase();
    if (!q) return arr;
    return arr.filter(
      (u: any) =>
        ((u.fullName || u.email || u.id || "") as string)
          .toLowerCase()
          .includes(q) ||
        ((u.jobTitle || "") as string).toLowerCase().includes(q),
    );
  }, [userDropdownAll, userQuery]);

  const individualMutation = useMutation(apiClient.sendMessageToUserAdmin, {
    onSuccess: (res: any) => {
      if (res?.ok) {
        toast({
          title:
            res?.via === "invite"
              ? "Отправлено (резервный канал)"
              : "Отправлено",
          description:
            res?.via === "invite"
              ? "Письмо отправлено через альтернативный канал на указанный email."
              : undefined,
        });
      } else if (res?.error === "MISSING_SEND_EMAIL_PERMISSION") {
        toast({
          title: "Нужно разрешение",
          description: "Предоставьте доступ на отправку писем",
        });
        try {
          auth.signIn({ provider: "AC1", scope: ["sendEmail"] });
        } catch {
          /* ignore */
        }
      } else if (res?.error === "TARGET_HAS_NO_EMAIL") {
        toast({
          title: "У пользователя не указан email",
          description:
            "Заполните email в профиле пользователя и повторите отправку.",
        });
      } else {
        toast({ title: "Не удалось отправить" });
      }
    },
    onError: () => toast({ title: "Ошибка отправки" }),
  });

  if (isInitialLoading) {
    return (
      <div className="max-w-3xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Загрузка…</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">Проверяем доступ…</div>
          </CardContent>
        </Card>
      </div>
    );
  }
  if (!isAdmin) {
    return (
      <div className="max-w-4xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Доступ ограничен</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Раздел доступен только администраторам.
            </div>
          </CardContent>
          <CardFooter>
            <Button variant="secondary" onClick={() => navigate("/admin")}>
              К админ-панели
            </Button>
          </CardFooter>
        </Card>
      </div>
    );
  }

  return (
    <div className="max-w-4xl mx-auto p-4 sm:p-6 space-y-4">
      <Card className="card-elevated h-full">
        <CardHeader>
          <CardTitle>Рассылка сообщений</CardTitle>
        </CardHeader>
        <CardContent className="space-y-6">
          {/* Общая рассылка */}
          <div className="p-3 border rounded space-y-3">
            <div className="font-medium">Общая рассылка</div>
            <div className="grid gap-2">
              <Label>Тема</Label>
              <Input
                value={broadcastSubject}
                onChange={(e) => setBroadcastSubject(e.target.value)}
                placeholder="Тема письма"
              />
            </div>
            <div className="grid gap-2">
              <Label>Сообщение (markdown)</Label>
              <Textarea
                rows={6}
                value={broadcastBody}
                onChange={(e) => setBroadcastBody(e.target.value)}
                placeholder="Текст письма"
              />
            </div>
            <div className="flex gap-2">
              <Button
                className="btn-3d"
                disabled={
                  !broadcastSubject ||
                  !broadcastBody ||
                  broadcastMutation.isLoading
                }
                onClick={() =>
                  broadcastMutation.mutate({
                    subject: broadcastSubject,
                    markdown: broadcastBody,
                  })
                }
              >
                {broadcastMutation.isLoading ? "Отправляем…" : "Отправить всем"}
              </Button>
              <Button
                variant="secondary"
                onClick={() => {
                  setBroadcastSubject("");
                  setBroadcastBody("");
                }}
              >
                Очистить
              </Button>
            </div>
          </div>

          {/* Индивидуальная рассылка */}
          <div className="p-3 border rounded space-y-3">
            <div className="font-medium">Индивидуальная рассылка</div>
            <div className="grid md:grid-cols-2 gap-3 items-end">
              <div className="grid gap-1">
                <Label>Выбрать пользователя</Label>
                <Select
                  value={selectedUserId}
                  onValueChange={(val) => setSelectedUserId(val)}
                >
                  <SelectTrigger className="w-full">
                    <SelectValue placeholder="Выберите пользователя" />
                  </SelectTrigger>
                  <SelectContent>
                    {(filteredUserOptions || []).map((u: any) => (
                      <SelectItem key={u.id} value={u.id}>
                        {u.fullName || u.email || u.id}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <div className="grid gap-1">
                <Label>Найти пользователя</Label>
                <Input
                  value={userQuery}
                  onChange={(e) => setUserQuery(e.target.value)}
                  placeholder="Минимум 2 символа для фильтрации списка"
                />
              </div>
            </div>
            <div className="grid gap-2">
              <Label>Тема</Label>
              <Input
                value={individualSubject}
                onChange={(e) => setIndividualSubject(e.target.value)}
                placeholder="Тема письма"
              />
            </div>
            <div className="grid gap-2">
              <Label>Сообщение (markdown)</Label>
              <Textarea
                rows={6}
                value={individualBody}
                onChange={(e) => setIndividualBody(e.target.value)}
                placeholder="Текст письма"
              />
            </div>
            <div className="flex gap-2">
              <Button
                className="btn-3d"
                disabled={
                  !selectedUserId ||
                  !individualSubject ||
                  !individualBody ||
                  individualMutation.isLoading
                }
                onClick={() =>
                  individualMutation.mutate({
                    toUserId: selectedUserId,
                    subject: individualSubject,
                    markdown: individualBody,
                  })
                }
              >
                {individualMutation.isLoading ? "Отправляем…" : "Отправить"}
              </Button>
              <Button
                variant="secondary"
                onClick={() => {
                  setSelectedUserId("");
                  setIndividualSubject("");
                  setIndividualBody("");
                }}
              >
                Очистить
              </Button>
            </div>
          </div>
        </CardContent>
        <CardFooter>
          <Button variant="secondary" onClick={() => navigate("/admin")}>
            К админ-панели
          </Button>
        </CardFooter>
      </Card>
    </div>
  );
}

type EditableDocxHtmlProps = {
  html: string;
  onHtmlChange: (newHtml: string) => void;
};

function EditableDocxHtml({ html, onHtmlChange }: EditableDocxHtmlProps) {
  const containerRef = React.useRef<HTMLDivElement | null>(null);
  const timerRef = React.useRef<number | undefined>(undefined);
  const uploadPhotoMutation = useMutation(apiClient.uploadProdControlImage);
  const injectedStyleId = React.useRef<string>(`pc-inline-styles`);

  React.useEffect(() => {
    const el = containerRef.current;
    if (!el) return;
    if (el.innerHTML !== html) {
      // Inject HTML
      el.innerHTML = html;

      // Hoist any <style> blocks (including @page rules) into <head> so print styles work
      try {
        const styleTags = Array.from(el.querySelectorAll("style"));
        const cssText = styleTags.map((s) => s.textContent || "").join("\n");
        if (cssText && typeof document !== "undefined") {
          const prev = document.getElementById(injectedStyleId.current);
          if (prev && prev.parentElement) prev.parentElement.removeChild(prev);
          const styleEl = document.createElement("style");
          styleEl.type = "text/css";
          styleEl.id = injectedStyleId.current;
          styleEl.appendChild(document.createTextNode(cssText));
          document.head.appendChild(styleEl);
        }
      } catch {}

      // Re-execute any <script> tags contained in provided HTML
      try {
        const scripts = Array.from(el.querySelectorAll("script"));
        scripts.forEach((old) => {
          const scr = document.createElement("script");
          // copy attributes
          Array.from(old.attributes).forEach((a) =>
            scr.setAttribute(a.name, a.value),
          );
          if (old.textContent && !old.src) {
            scr.textContent = old.textContent;
          }
          // Replace old script with new executable one
          old.parentNode?.insertBefore(scr, old.nextSibling);
        });
      } catch {}

      // Clean duplicated fixed header fragments outside injected header block
      const toRemoveTexts = [
        "РОССИЙСКАЯ ФЕДЕРАЦИЯ (РОССИЯ)",
        "РЕСПУБЛИКА САХА (ЯКУТИЯ)",
        "Акционерное Общество «Горно-рудная компания «Западная»",
        "678730, Республика Саха (Якутия), Оймяконский район, п. г. т. Усть-Нера, проезд Северный, д.12.",
        "тел. 8 (395) 225-52-88, доб.*1502",
      ];
      toRemoveTexts.forEach((txt) => {
        el.querySelectorAll("*").forEach((node) => {
          const content = (node.textContent || "").trim();
          if (
            content === txt &&
            !(node as Element).closest('[data-pc-header="true"]')
          ) {
            (node as Element).remove();
          }
        });
      });
      // Remove duplicated title lines outside the injected header
      el.querySelectorAll("*").forEach((node) => {
        const content = (node.textContent || "").trim();
        if (
          content.startsWith("ПРЕДПИСАНИЕ (АКТ)") &&
          !(node as Element).closest('[data-pc-header="true"]')
        ) {
          (node as Element).remove();
        }
      });
      // Make table cells editable for convenience
      const cells = el.querySelectorAll<HTMLTableCellElement>("td, th");
      cells.forEach((cell) => {
        cell.setAttribute("contenteditable", "true");
        cell.classList.add("focus:outline-none");
        try {
          (cell.style as any).whiteSpace = "pre-wrap";
          (cell.style as any).overflowWrap = "anywhere";
          (cell.style as any).wordBreak = "break-word";
          (cell.style as any).height = "auto";
        } catch {}
      });
    }
  }, [html]);

  React.useEffect(() => {
    const el = containerRef.current;
    if (!el) return;
    const handleInput = () => {
      if (timerRef.current) window.clearTimeout(timerRef.current);
      timerRef.current = window.setTimeout(() => {
        onHtmlChange(el.innerHTML);
      }, 250);
    };
    el.addEventListener("input", handleInput);
    return () => {
      el.removeEventListener("input", handleInput);
      if (timerRef.current) window.clearTimeout(timerRef.current);
      // cleanup injected styles on unmount
      try {
        const prev = document.getElementById(injectedStyleId.current);
        if (prev && prev.parentElement) prev.parentElement.removeChild(prev);
      } catch {}
    };
  }, [onHtmlChange]);

  return (
    <div
      ref={containerRef}
      className="max-w-full border rounded-md p-4 overflow-auto docx-html"
      role="textbox"
      aria-label="Редактируемый документ"
    />
  );
}

function ProdControlScreen() {
  useAuth({ required: true });
  const { data: me, isInitialLoading } = useQuery<Profile>(["me"], () =>
    apiClient.getMyProfile(),
  );
  const { data: template } = useQuery(["prodControl.template"], () =>
    apiClient.getProdControlTemplate(),
  );
  const { data: nextAct } = useQuery(["prodControl.nextNumber"], () =>
    apiClient.previewNextProdControlActNumber(),
  );
  const dateStr = React.useMemo(() => {
    const d = new Date();
    const months = [
      "января",
      "февраля",
      "марта",
      "апреля",
      "мая",
      "июня",
      "июля",
      "августа",
      "сентября",
      "октября",
      "ноября",
      "декабря",
    ];
    const day = String(d.getDate()).padStart(2, "0");
    return `«${day}» ${months[d.getMonth()]} ${d.getFullYear()} г.`;
  }, []);
  const actNoStr = React.useMemo(
    () => (nextAct?.code ? `№ПК ${nextAct.code}` : "№ПК __-__"),
    [nextAct?.code],
  );
  const headerHtml = React.useMemo(
    () => `
    <div data-pc-header="true" style="line-height:1.25;margin-bottom:12px;">
      <div class="header" style="text-align:center;line-height:1.2;margin-top:8px;">
        <h3 style="margin:0;">Электронная выдача АКТа производственного контроля</h3>
        <div><strong>РОССИЙСКАЯ ФЕДЕРАЦИЯ (РОССИЯ)</strong></div>
        <div><strong>РЕСПУБЛИКА САХА (ЯКУТИЯ)</strong></div>
        <div><strong>Акционерное Общество «Горно-рудная компания «Западная»</strong></div>
        <div>678730, Республика Саха (Якутия), Оймяконский район, п. г. т. Усть-Нера, проезд Северный, д.12.</div>
        <div>тел. 8 (395) 225-52-88, доб.*1502</div>
      </div>
      <div class="date-location" style="margin-top:10mm;display:flex;justify-content:space-between;align-items:center;font-size:12px;">
        <div>${dateStr}</div>
        <div>Рудник «Бадран»</div>
      </div>
      <div class="document-title" style="text-align:center;margin-top:8px;text-decoration:underline;"><strong>ПРЕДПИСАНИЕ (АКТ) ${actNoStr}</strong></div>
      <div class="document-subtitle" style="text-align:center;margin-top:6px;">Проверки по производственному контролю за состоянием ОТ и ПБ</div>
    </div>
  `,
    [dateStr, actNoStr],
  );
  const [localHtml, setLocalHtml] = React.useState<string>("");
  // Управление страницами шаблона (только для режима управления)
  type PcPage = { id: string; title: string; html: string };
  const [pages, setPages] = React.useState<PcPage[] | null>(null);
  const [currentPageIndex, setCurrentPageIndex] = React.useState(0);
  const [hasDraft, setHasDraft] = React.useState(false);
  const queryClient = useQueryClient();
  const navigate = useNavigate();

  const removeBadranDuplicateLine = (html: string) => {
    try {
      let out = html.replace(/«[^<]{0,100}?г\.\s*Рудник\s*«Бадран»/g, "");
      out = out.replace(/<p[^>]*>(\s|&nbsp;|—|-|,|\.|;|:)*<\/p>/gi, "");
      out = out.replace(/<div[^>]*>(\s|&nbsp;)*<\/div>/gi, "");
      return out;
    } catch (err) {
      return html;
    }
  };

  // Подстановка динамических значений (ФИО, должность) в загруженный HTML, если там ещё стоят примеры
  const applyDynamicFields = (html: string) => {
    try {
      const name = (me?.fullName || "").trim();
      const job = (me?.jobTitle || "").trim();
      const issued = [name, job].filter(Boolean).join(", ");
      if (!issued) return html;

      let out = html;
      // 1) Замена примера из шаблона
      out = out.replace(
        />Иванов Иван Иванович, начальник [^<]*</g,
        ">" + issued + "<",
      );
      out = out.replace(/>Иванов Иван Иванович</g, ">" + issued + "<");

      // 2) Если найдена секция "Предписание выдал:", подменяем первое поле справа от неё
      out = out.replace(
        /(>\s*Предписание\s+выдал:.*?<\/div>\s*<div[^>]*>\s*<div[^>]*>)([\s\S]*?)(<\/div>)/i,
        (_m, p1, _content, p3) => `${p1}${issued}${p3}`,
      );
      return out;
    } catch {
      return html;
    }
  };

  React.useEffect(() => {
    if (template?.id) {
      apiClient.getMyProdControlEntry({ templateId: template.id }).then((r) => {
        if (r) {
          if (typeof (r as any).toWhom === "string")
            setToWhom((r as any).toWhom);
          if (typeof (r as any).toWhom2 === "string")
            setToWhom2((r as any).toWhom2);
          if (typeof (r as any).toWhom3 === "string")
            setToWhom3((r as any).toWhom3);
          if (typeof (r as any).presenceInfo === "string")
            setPresenceInfo((r as any).presenceInfo);
          if (typeof (r as any).acceptedBy === "string")
            setAcceptedBy((r as any).acceptedBy);
          if (typeof (r as any).acceptedDate === "string")
            setAcceptedDate((r as any).acceptedDate);
          if (typeof (r as any).acceptedBy2 === "string")
            setAcceptedBy2((r as any).acceptedBy2);
          if (typeof (r as any).acceptedDate2 === "string")
            setAcceptedDate2((r as any).acceptedDate2);
          if (typeof (r as any).acceptedBy3 === "string")
            setAcceptedBy3((r as any).acceptedBy3);
          if (typeof (r as any).acceptedDate3 === "string")
            setAcceptedDate3((r as any).acceptedDate3);
          if (Array.isArray((r as any).pcPairs) && (r as any).pcPairs.length)
            setPcPairs((r as any).pcPairs);
          setFirstRowLocked(false);
        }
        if (r?.html) {
          const combined =
            (r.html?.includes('data-pc-header="true"') ? "" : headerHtml) +
            r.html;
          setLocalHtml(applyDynamicFields(removeBadranDuplicateLine(combined)));
          setHasDraft(true);
        } else if (template?.html) {
          const combined =
            (template.html?.includes('data-pc-header="true"')
              ? ""
              : headerHtml) + template.html;
          setLocalHtml(applyDynamicFields(removeBadranDuplicateLine(combined)));
        }
      });
    }
  }, [template?.id, me?.fullName, me?.jobTitle]);

  // Update placeholder number in header when real number arrives
  React.useEffect(() => {
    if (!localHtml) return;
    if (
      actNoStr &&
      actNoStr !== "№__-__" &&
      localHtml.includes('data-pc-header="true"')
    ) {
      setLocalHtml((prev) =>
        prev.replace(
          /ПРЕДПИСАНИЕ \(АКТ\) №ПК __-__/g,
          `ПРЕДПИСАНИЕ (АКТ) ${actNoStr}`,
        ),
      );
    }
  }, [actNoStr]);

  // const uploadRef = React.useRef<HTMLInputElement | null>(null);
  type PcPair = {
    left: string;
    mid: string;
    right: string;
    leftPhotoUrl?: string;
    rightPhotoUrl?: string;
  };
  const [pcPairs, setPcPairs] = React.useState<PcPair[]>([
    { left: "", mid: "", right: "" },
  ]);
  const [toWhom, setToWhom] = React.useState<string>("");
  const [toWhom2, setToWhom2] = React.useState<string>("");
  const [toWhom3, setToWhom3] = React.useState<string>("");
  // Автоподстановка «Кому» значениями текущего пользователя (ФИО, должность)
  React.useEffect(() => {
    if (!toWhom) {
      const parts = [
        me?.fullName?.trim() || "",
        me?.jobTitle?.trim() || "",
      ].filter(Boolean);
      if (parts.length) setToWhom(parts.join(", "));
    }
  }, [me?.fullName, me?.jobTitle]);

  const { data: managers } = useQuery<inferRPCOutputType<"searchManagers">>(
    ["searchManagers"],
    () => apiClient.searchManagers({}),
  );
  const toWhomOptions = React.useMemo(() => {
    const base = (managers ?? []).map((u) => {
      const parts = [u.fullName?.trim() || "", u.jobTitle?.trim() || ""].filter(
        Boolean,
      );
      const label = parts.length ? parts.join(", ") : u.email || "Без имени";
      return { value: label, label };
    });
    if (!base.find((o) => o.value === "---")) {
      base.unshift({ value: "---", label: "---" });
    }
    if (toWhom && toWhom !== "---" && !base.find((o) => o.value === toWhom)) {
      base.unshift({ value: toWhom, label: toWhom + " (ранее сохранено)" });
    }
    return base;
  }, [managers, toWhom]);
  const toWhom2Options = React.useMemo(() => {
    const base = (managers ?? []).map((u) => {
      const labelParts = [
        u.fullName?.trim() || "",
        u.jobTitle?.trim() || "",
      ].filter(Boolean);
      const label = labelParts.length
        ? labelParts.join(", ")
        : u.email || "Без имени";
      return { value: label, label };
    });
    // Ensure '---' is present and never marked as previously saved
    if (!base.find((o) => o.value === "---")) {
      base.unshift({ value: "---", label: "---" });
    }
    if (
      toWhom2 &&
      toWhom2 !== "---" &&
      !base.find((o) => o.value === toWhom2)
    ) {
      base.unshift({ value: toWhom2, label: toWhom2 + " (ранее сохранено)" });
    }
    return base;
  }, [managers, toWhom2]);
  const toWhom3Options = React.useMemo(() => {
    const base = (managers ?? []).map((u) => {
      const labelParts = [
        u.fullName?.trim() || "",
        u.jobTitle?.trim() || "",
      ].filter(Boolean);
      const label = labelParts.length
        ? labelParts.join(", ")
        : u.email || "Без имени";
      return { value: label, label };
    });
    // Ensure '---' is present and never marked as previously saved
    if (!base.find((o) => o.value === "---")) {
      base.unshift({ value: "---", label: "---" });
    }
    if (
      toWhom3 &&
      toWhom3 !== "---" &&
      !base.find((o) => o.value === toWhom3)
    ) {
      base.unshift({ value: toWhom3, label: toWhom3 + " (ранее сохранено)" });
    }
    return base;
  }, [managers, toWhom3]);
  const { data: pabDeptStats } = useQuery(["pab.departments"], () =>
    apiClient.listPabDepartmentStats(),
  );
  const departmentOptions = React.useMemo(
    () =>
      (pabDeptStats?.departments ?? []).map((d: any) => d.name).filter(Boolean),
    [pabDeptStats?.departments],
  );
  const [departmentName, setDepartmentName] = React.useState<string>("");
  React.useEffect(() => {
    if (!departmentName && (me?.department || ""))
      setDepartmentName(me?.department || "");
  }, [me?.department]);
  const [presenceInfo, setPresenceInfo] = React.useState<string>("");
  const [issuedBy, setIssuedBy] = React.useState<string>("");
  const [acceptedBy, setAcceptedBy] = React.useState<string>("");
  const [acceptedDate, setAcceptedDate] = React.useState<string>("");
  const [acceptedBy2, setAcceptedBy2] = React.useState<string>("");
  const [acceptedDate2, setAcceptedDate2] = React.useState<string>("");
  const [acceptedBy3, setAcceptedBy3] = React.useState<string>("");
  const [acceptedDate3, setAcceptedDate3] = React.useState<string>("");
  const [firstRowLocked, setFirstRowLocked] = React.useState(false);
  const pcPhotoInputRef = React.useRef<HTMLInputElement | null>(null);
  const [pendingPhoto, setPendingPhoto] = React.useState<{
    idx: number;
    side: "left" | "right";
  } | null>(null);
  const uploadPhotoMutation = useMutation(apiClient.uploadProdControlImage, {
    onSuccess: (res) => {
      if (!pendingPhoto) return;
      setPcPairs((prev) =>
        prev.map((r, i) => {
          if (i !== pendingPhoto.idx) return r;
          if (pendingPhoto.side === "left")
            return { ...r, leftPhotoUrl: (res as any).url } as PcPair;
          return { ...r, rightPhotoUrl: (res as any).url } as PcPair;
        }),
      );
      setPendingPhoto(null);
      if (pcPhotoInputRef.current) pcPhotoInputRef.current.value = "";
    },
  });

  // Ensure read-only and prefilled fields grow to fit content
  React.useEffect(() => {
    const els = document.querySelectorAll<HTMLTextAreaElement>(
      "textarea.pc-autosize",
    );
    els.forEach((el) => {
      el.style.height = "auto";
      el.style.height = el.scrollHeight + "px";
    });
  }, []);
  // Автоподстановка «Предписание выдал» из текущего профиля и автообновление при изменении профиля
  React.useEffect(() => {
    const parts = [
      me?.fullName?.trim() || "",
      me?.jobTitle?.trim() || "",
    ].filter(Boolean);
    const value = parts.join(", ");
    setIssuedBy((prev) => (prev ? prev : value));
  }, [me?.fullName, me?.jobTitle]);

  const setTemplateMutation = useMutation(apiClient.setProdControlTemplate, {
    onSuccess: () => {
      void queryClient.invalidateQueries(["prodControl.template"]);
      setHasDraft(false);
    },
  });

  const saveDraftMutation = useMutation(apiClient.saveMyProdControlEntry, {
    onSuccess: () => {
      setHasDraft(true);
      setFirstRowLocked(false);
    },
  });

  const exportDocxMutation = useMutation(apiClient.generateProdControlDocx, {
    onSuccess: (res) => {
      const url = (res as any)?.url;
      if (url) {
        try {
          window.open(url, "_blank");
        } catch {
          // no-op
        }
      }
    },
  });

  const exportPdfMutation = useMutation(apiClient.generateProdControlPdf, {
    onSuccess: (res) => {
      const url = (res as any)?.url;
      if (url) {
        try {
          window.open(url, "_blank");
        } catch {
          // no-op
        }
      }
    },
  });

  const deleteDraftMutation = useMutation(
    apiClient.deleteMyProdControlEntries,
    {
      onSuccess: () => {
        clearForm();
      },
    },
  );

  // Очистка формы: сброс всех полей, кроме авто‑даты и авто ФИО/должности
  const [vtKey, setVtKey] = React.useState(0);
  const clearForm = () => {
    const ok = window.confirm(
      "Очистить все поля формы? Это действие нельзя отменить.",
    );
    if (!ok) return;
    const userDefault = [me?.fullName?.trim() || "", me?.jobTitle?.trim() || ""]
      .filter(Boolean)
      .join(", ");
    setToWhom("---");
    setToWhom2("---");
    setToWhom3("---");
    setPresenceInfo("");
    setPcPairs([{ left: "", mid: "", right: "" }]);
    setIssuedBy(userDefault);
    setAcceptedBy("");
    setAcceptedBy2("");
    setAcceptedBy3("");
    setAcceptedDate("");
    setAcceptedDate2("");
    setAcceptedDate3("");
    setFirstRowLocked(false);
    setPendingPhoto(null);
    if (pcPhotoInputRef.current) pcPhotoInputRef.current.value = "";
    setVtKey((k) => k + 1);
  };

  // Admin manage mode helpers
  const isAdmin = !!me?.isAdmin;
  const isRestricted = false; // На этой форме все кнопки активны для всех пользователей по требованию
  const manageMode = React.useMemo(() => {
    try {
      return new URLSearchParams(window.location.search).get("manage") === "1";
    } catch {
      return false;
    }
  }, []);
  const showPicker = React.useMemo(() => {
    try {
      return new URLSearchParams(window.location.search).get("picker") === "1";
    } catch {
      return false;
    }
  }, []);
  const desiredPage = React.useMemo(() => {
    try {
      return new URLSearchParams(window.location.search).get("page") || "";
    } catch {
      return "";
    }
  }, []);
  const [pickerOpen, setPickerOpen] = React.useState(showPicker);
  React.useEffect(() => {
    setPickerOpen(showPicker);
  }, [showPicker]);

  const getEditorRoot = () =>
    document.querySelector(".docx-html") as HTMLElement | null;

  // Режим удаления блоков (для админов в режиме управления)
  const [blockDeleteMode, setBlockDeleteMode] = React.useState(true);

  const cleanupDeleteButtons = React.useCallback(() => {
    try {
      const root = getEditorRoot();
      if (!root) return;
      const btns = Array.from(
        root.querySelectorAll<HTMLElement>("[data-pc-delbtn='1']"),
      );
      btns.forEach((b) => b.remove());
      const changed = Array.from(
        root.querySelectorAll<HTMLElement>("[data-pc-pos-changed='1']"),
      );
      changed.forEach((el) => {
        el.style.position =
          (el.getAttribute("data-pc-origpos") as string) || "";
        el.removeAttribute("data-pc-origpos");
        el.removeAttribute("data-pc-pos-changed");
        el.removeAttribute("data-pc-delattached");
      });
    } catch {
      // no-op
    }
  }, []);

  const decorateDeleteButtons = React.useCallback(() => {
    try {
      if (!(isAdmin && manageMode)) return;
      const root = getEditorRoot();
      if (!root) return;
      // Навешиваем кнопки удаления только на верхнеуровневые блоки текущей страницы
      const blocks = Array.from(root.children) as HTMLElement[];
      blocks.forEach((el) => {
        if (el.getAttribute("data-pc-delattached") === "1") return;
        // Обеспечим позиционирование для абсолютной кнопки
        const computed = window.getComputedStyle(el);
        if (computed.position === "static") {
          el.setAttribute("data-pc-origpos", el.style.position || "");
          el.style.position = "relative";
          el.setAttribute("data-pc-pos-changed", "1");
        }
        const btn = document.createElement("button");
        btn.textContent = "×";
        btn.setAttribute("data-pc-delbtn", "1");
        btn.style.position = "absolute";
        btn.style.top = "-10px";
        btn.style.right = "-10px";
        btn.style.width = "22px";
        btn.style.height = "22px";
        btn.style.borderRadius = "9999px";
        btn.style.border = "none";
        btn.style.cursor = "pointer";
        btn.style.zIndex = "10";
        btn.style.background = "#ef4444"; // red-500
        btn.style.color = "#fff";
        btn.title = "Удалить блок";
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          try {
            const parent = (e.currentTarget as HTMLElement).parentElement;
            if (!parent) return;
            parent.remove();
            syncHtmlFromDom();
          } catch {
            // no-op
          }
        });
        el.appendChild(btn);
        el.setAttribute("data-pc-delattached", "1");
      });
    } catch {
      // no-op
    }
  }, [isAdmin, manageMode]);

  React.useEffect(() => {
    if (!(isAdmin && manageMode)) return;
    const root = getEditorRoot();
    if (!root) return;
    // Сначала очистим предыдущие кнопки
    cleanupDeleteButtons();
    if (!blockDeleteMode) return;
    const raf = window.requestAnimationFrame(() => {
      decorateDeleteButtons();
    });
    return () => {
      window.cancelAnimationFrame(raf);
      cleanupDeleteButtons();
    };
  }, [
    isAdmin,
    manageMode,
    blockDeleteMode,
    pages,
    currentPageIndex,
    localHtml,
    cleanupDeleteButtons,
    decorateDeleteButtons,
  ]);

  // Если в URL задана страница (?page=ПК-3), переключаемся на неё после инициализации страниц
  React.useEffect(() => {
    if (!pages || !desiredPage) return;
    const idx = pages.findIndex((p) => (p.title || "") === desiredPage);
    if (idx >= 0 && idx !== currentPageIndex) setCurrentPageIndex(idx);
  }, [pages, desiredPage]);

  // Разбивка объединенного HTML на страницы и обратная сборка
  const splitIntoPages = React.useCallback((html: string): PcPage[] => {
    try {
      const container = document.createElement("div");
      container.innerHTML = html || "";
      const pageNodes = Array.from(
        container.querySelectorAll<HTMLElement>("[data-pc-page]"),
      );
      if (pageNodes.length === 0) {
        return [{ id: "p1", title: "Страница 1", html }];
      }
      return pageNodes.map((el, idx) => {
        const title = el.getAttribute("data-pc-page") || `Страница ${idx + 1}`;
        return { id: `p${idx + 1}`, title, html: el.innerHTML };
      });
    } catch (err) {
      return [{ id: "p1", title: "Страница 1", html }];
    }
  }, []);

  const joinPages = React.useCallback((arr: PcPage[]): string => {
    try {
      return arr
        .map(
          (p) =>
            `<div class="pc-page" data-pc-page="${(p.title || "").replace(/"/g, "&quot;")}" style="page-break-after: always;">${p.html || ""}</div>`,
        )
        .join("\n");
    } catch (err) {
      return arr[0]?.html ?? "";
    }
  }, []);

  const page2TemplateHtml = `
    <div style="font-size:14px; line-height:1.5;">
      <div style="margin-bottom:12px;">
        <div><strong>Необходимо устранить следующие нарушения в указанные сроки:</strong></div>
      </div>
      <table style="width:100%; border-collapse:collapse;">
        <thead>
          <tr>
            <th style="border:1px solid #000; padding:6px; width:5%;">п/п</th>
            <th style="border:1px solid #000; padding:6px; width:47%;">Краткое изложение выявленных нарушений с указанием места обнаружения<br/>(при необходимости вкладывать фото)</th>
            <th style="border:1px solid #000; padding:6px; width:43%;">Предлагаемые меры, ответственные за выполнение и срок устранения нарушений</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td style="border:1px solid #000; padding:6px;">1.</td>
            <td style="border:1px solid #000; padding:6px;">&nbsp;</td>
            <td style="border:1px solid #000; padding:6px;">&nbsp;</td>
          </tr>
          <tr>
            <td style="border:1px solid #000; padding:6px;">2.</td>
            <td style="border:1px solid #000; padding:6px;">&nbsp;</td>
            <td style="border:1px solid #000; padding:6px;">&nbsp;</td>
          </tr>
        </tbody>
      </table>
      <div style="margin-top:20px;">
        <div><strong>О выполнении настоящего предписания прошу предоставить письменное уведомление в отдел ОТ и ПБ согласно дат, указанных в пунктах.</strong></div>
      </div>
      <div style="margin-top:28px;">
        <div><strong>Подписи</strong></div>
        <div style="margin-top:16px;">
          <div style="display:flex; justify-content:space-between; gap:24px;">
            <div style="flex:1; border-top:1px solid #000; padding-top:4px; text-align:center;">Предписание выдал</div>
            <div style="flex:1; border-top:1px solid #000; padding-top:4px; text-align:center;">Дата</div>
          </div>
        </div>
        <div style="margin-top:20px;">
          <div style="display:flex; justify-content:space-between; gap:24px;">
            <div style="flex:1; border-top:1px solid #000; padding-top:4px; text-align:center;">Предписание принял</div>
            <div style="flex:1; border-top:1px solid #000; padding-top:4px; text-align:center;">Дата</div>
          </div>
        </div>
        <div style="margin-top:20px;">
          <div style="display:flex; justify-content:space-between; gap:24px;">
            <div style="flex:1; border-top:1px solid #000; padding-top:4px; text-align:center;">Предписание принял</div>
            <div style="flex:1; border-top:1px solid #000; padding-top:4px; text-align:center;">Дата</div>
          </div>
        </div>
      </div>
    </div>
  `;
  const ensuredPage2Ref = React.useRef(false);

  const pkTemplateHtml = `
    <div style="font-size:14px; line-height:1.5;">
      <div style="text-align:center; margin-bottom:20px;">
        <div><strong>Электронная регистрация производственного контроля</strong></div>
        <div><strong>РОССИЙСКАЯ ФЕДЕРАЦИЯ (РОССИЯ)</strong></div>
        <div><strong>РЕСПУБЛИКА САХА (ЯКУТИЯ)</strong></div>
        <div>Акционерное Общество «Горно-рудная компания «Западная»</div>
        <div>678730, Республика Саха (Якутия), Оймяконский район, п. г. т. Усть-Нера, проезд Северный, д.12.</div>
        <div>тел. 8 (395) 225-52-88, доб.*1502</div>
      </div>

      <div style="margin-bottom:20px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <span style="border-bottom:1px solid #000; display:inline-block; min-width:150px; padding:0 5px;">[Дата]</span>
          <span>Рудник «Бадран»</span>
        </div>
        <div style="margin-top:6px; text-align:center;"><strong>ПРЕДПИСАНИЕ (АКТ) №ПК 24-25_______</strong></div>
        <div style="margin-top:6px;">Проверки по производственному контролю за состоянием ОТ и ПБ</div>

        <div style="margin: 12px 0;">
          <div style="font-weight:bold;">Кому:</div>
          <div style="border-bottom:1px solid #000; min-height:20px;">Иванов Иван Иванович</div>
          <div style="border-bottom:1px solid #000; min-height:20px; margin-top:5px;">(должность, Ф.И.О.)</div>
          <div style="border-bottom:1px solid #000; min-height:20px; margin-top:5px;">Подземный Горный Участок</div>
          <div style="border-bottom:1px solid #000; min-height:20px; margin-top:5px;">(наименование обследуемого подразделения общества)</div>
        </div>

        <div style="margin-top:8px;">
          <div style="font-weight:bold;">Проверка проведена в присутствии:</div>
          <div style="border-bottom:1px solid #000; min-height:20px;">Иванова Ивана Ивановича, Иванова Ивана Ивановича, Иванова Ивана Ивановича</div>
          <div style="border-bottom:1px solid #000; min-height:20px; margin-top:5px;">(должность, Ф.И.О.)</div>
        </div>
      </div>

      <div style="margin-bottom:10px;"><strong>Необходимо устранить следующие нарушения в указанные сроки:</strong></div>
      <table style="width:100%; border-collapse:collapse;">
        <thead>
          <tr>
            <th style="border:1px solid #000; padding:8px; width:5%; background:#f0f0f0;">п/п</th>
            <th style="border:1px solid #000; padding:8px; width:47%; background:#f0f0f0;">Краткое изложение выявленных нарушений с указанием места обнаружения<br/>(при необходимости вкладывать фото)</th>
            <th style="border:1px solid #000; padding:8px; width:43%; background:#f0f0f0;">Предлагаемые меры, ответственные за выполнение и срок устранения нарушений</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td style="border:1px solid #000; padding:8px;">1.</td>
            <td style="border:1px solid #000; padding:8px; min-height:80px;">&nbsp;</td>
            <td style="border:1px solid #000; padding:8px; min-height:80px;">&nbsp;</td>
          </tr>
          <tr>
            <td style="border:1px solid #000; padding:8px;">2.</td>
            <td style="border:1px solid #000; padding:8px; min-height:80px;">&nbsp;</td>
            <td style="border:1px solid #000; padding:8px; min-height:80px;">&nbsp;</td>
          </tr>
        </tbody>
      </table>

      <div>
        О выполнении настоящего предписания прошу предоставить письменное уведомление в отдел ОТ и ПБ <strong>согласно дат, указанных в пунктах.</strong>
      </div>

      <div style="margin-top:40px;">
        <div style="font-weight:bold;">Предписание выдал:</div>
        <div style="display:flex; justify-content:space-between; gap:24px; margin-top:16px;">
          <div style="flex:1; border-top:1px solid #000; padding-top:4px; text-align:center;">Иванов Иван Иванович, начальник АХО</div>
          <div style="flex:1; border-top:1px solid #000; padding-top:4px; text-align:center;">24.10.2025</div>
        </div>

        <div style="font-weight:bold; margin-top:28px;">Предписание принял:</div>
        <div style="display:flex; justify-content:space-between; gap:24px; margin-top:16px;">
          <div style="flex:1; border-top:1px solid #000; padding-top:4px; text-align:center;">Иванов Иван Иванович, начальник АХО</div>
          <div style="flex:1; border-top:1px solid #000; padding-top:4px; text-align:center;">24.10.2025</div>
        </div>
        <div style="display:flex; justify-content:space-between; gap:24px; margin-top:16px;">
          <div style="flex:1; border-top:1px solid #000; padding-top:4px; text-align:center;">Иванов Иван Иванович, начальник АХО</div>
          <div style="flex:1; border-top:1px solid #000; padding-top:4px; text-align:center;">24.10.2025</div>
        </div>
      </div>
    </div>
  `;

  // Инициализация страниц при входе в режим управления и при загрузке содержимого
  React.useEffect(() => {
    if (!(isAdmin && manageMode)) {
      setPages(null);
      setCurrentPageIndex(0);
      return;
    }

    const basePages: PcPage[] = [{ id: "p1", title: "Страница 1", html: "" }];

    if (!localHtml) {
      const withDefaults: PcPage[] = [
        ...basePages,
        { id: "p2", title: "ПК-2", html: page2TemplateHtml },
        { id: "p3", title: "ПК-3", html: "" },
        { id: "p4", title: "ПК-4", html: "" },
        { id: "p5", title: "ПК-5", html: "" },
        { id: "p6", title: "ПК-6", html: "" },
      ];
      setPages(withDefaults);
      setCurrentPageIndex(0);
      setLocalHtml(joinPages(withDefaults));
      ensuredPage2Ref.current = true;
      return;
    }

    let arr = splitIntoPages(localHtml);

    if (!ensuredPage2Ref.current) {
      // Переименуем "Страница 2" в "ПК-2", если нужно
      const legacyIdx = arr.findIndex((p) => (p.title || "") === "Страница 2");
      const hasPk2 = arr.some((p) => (p.title || "") === "ПК-2");
      if (legacyIdx !== -1 && !hasPk2) {
        arr = arr.map((p, i) =>
          i === legacyIdx ? { ...p, title: "ПК-2" } : p,
        );
      }
      // Гарантируем наличие "ПК-2" и заполняем шаблоном при пустом содержимом
      let pk2Idx = arr.findIndex((p) => (p.title || "") === "ПК-2");
      if (pk2Idx === -1) {
        arr = [
          ...arr,
          { id: `p${arr.length + 1}`, title: "ПК-2", html: page2TemplateHtml },
        ];
        pk2Idx = arr.length - 1;
      } else if (!arr[pk2Idx]?.html || arr[pk2Idx].html.trim() === "") {
        arr = arr.map((p, i) =>
          i === pk2Idx ? { ...p, html: page2TemplateHtml } : p,
        );
      }
      // Гарантируем наличие "ПК-3"…"ПК-6"
      const wanted = ["ПК-3", "ПК-4", "ПК-5", "ПК-6"];
      for (const t of wanted) {
        if (!arr.some((p) => (p.title || "") === t)) {
          arr = [...arr, { id: `p${arr.length + 1}`, title: t, html: "" }];
        }
      }
      setPages(arr);
      setCurrentPageIndex(0);
      setLocalHtml(joinPages(arr));
      ensuredPage2Ref.current = true;
      return;
    }

    setPages(arr);
    setCurrentPageIndex(0);
  }, [isAdmin, manageMode, localHtml, splitIntoPages, joinPages]);

  const syncHtmlFromDom = () => {
    const root = getEditorRoot();
    if (!root) return;
    if (isAdmin && manageMode && pages && pages[currentPageIndex]) {
      setPages((prev) => {
        if (!prev) return prev;
        const next = prev.map((p, i) =>
          i === currentPageIndex ? { ...p, html: root.innerHTML } : p,
        );
        const combined = joinPages(next);
        setLocalHtml(combined);
        return next;
      });
      return;
    }
    setLocalHtml(root.innerHTML);
  };
  const withRange = (cb: (range: Range) => void) => {
    const sel = window.getSelection();
    if (!sel || sel.rangeCount === 0) return;
    const range = sel.getRangeAt(0);
    cb(range);
    syncHtmlFromDom();
  };
  const insertTextAtCaret = () =>
    withRange((range) => {
      const node = document.createTextNode(" Текст ");
      range.deleteContents();
      range.insertNode(node);
      range.setStartAfter(node);
      range.collapse(true);
      const sel = window.getSelection();
      sel?.removeAllRanges();
      sel?.addRange(range);
    });
  const deleteSelectionAtCaret = () =>
    withRange((range) => {
      if (!range.collapsed) range.deleteContents();
    });
  const findClosest = (el: Node | null, tag: string): HTMLElement | null => {
    while (el && (el as HTMLElement)?.nodeType === 3)
      el = (el as Node).parentElement as any;
    let cur: HTMLElement | null = (el as HTMLElement) || null;
    tag = tag.toUpperCase();
    while (cur) {
      if (cur.tagName === tag) return cur;
      cur = cur.parentElement;
    }
    return null;
  };
  const addTableAtCaret = (rows = 2, cols = 2) =>
    withRange((range) => {
      const table = document.createElement("table");
      table.style.width = "100%";
      table.style.borderCollapse = "collapse";
      for (let r = 0; r < rows; r++) {
        const tr = document.createElement("tr");
        for (let c = 0; c < cols; c++) {
          const td = document.createElement("td");
          td.style.border = "1px solid #ccc";
          td.style.padding = "4px";
          td.setAttribute("contenteditable", "true");
          td.appendChild(document.createTextNode(" "));
          tr.appendChild(td);
        }
        table.appendChild(tr);
      }
      range.insertNode(table);
    });
  const deleteCurrentTable = () => {
    const sel = window.getSelection();
    const table = findClosest(sel?.anchorNode || null, "table");
    if (table?.parentElement) {
      table.parentElement.removeChild(table);
      syncHtmlFromDom();
    }
  };
  const addRowAfter = () => {
    const sel = window.getSelection();
    const tr = findClosest(sel?.anchorNode || null, "tr");
    const table = findClosest(tr || null, "table");
    if (!table) return;
    const cols = tr?.children?.length || 1;
    const newTr = document.createElement("tr");
    for (let c = 0; c < cols; c++) {
      const td = document.createElement("td");
      td.style.border = "1px solid #ccc";
      td.style.padding = "4px";
      td.setAttribute("contenteditable", "true");
      td.appendChild(document.createTextNode(" "));
      newTr.appendChild(td);
    }
    if (tr && tr.parentElement)
      tr.parentElement.insertBefore(newTr, tr.nextSibling);
    else table.appendChild(newTr);
    syncHtmlFromDom();
  };
  const deleteCurrentRow = () => {
    const sel = window.getSelection();
    const tr = findClosest(sel?.anchorNode || null, "tr");
    if (!tr) return;
    const tbody = tr.parentElement;
    const rowCount = tbody?.children.length || 0;
    if (rowCount <= 1) return;
    tbody?.removeChild(tr);
    syncHtmlFromDom();
  };
  const addColumnAfter = () => {
    const sel = window.getSelection();
    const td =
      findClosest(sel?.anchorNode || null, "td") ||
      findClosest(sel?.anchorNode || null, "th");
    const tr = td?.parentElement;
    const table = findClosest(td || null, "table");
    if (!td || !tr || !table) return;
    const cellIndex = Array.from(tr.children).indexOf(td);
    Array.from(table.querySelectorAll("tr")).forEach((row) => {
      const cells = Array.from(row.children) as HTMLElement[];
      const newCell = document.createElement((td.tagName || "TD") as any);
      newCell.style.border = "1px solid #ccc";
      newCell.style.padding = "4px";
      newCell.setAttribute("contenteditable", "true");
      newCell.appendChild(document.createTextNode(" "));
      if (cellIndex >= 0 && cellIndex < cells.length - 1) {
        row.insertBefore(newCell, cells[cellIndex + 1]);
      } else {
        row.appendChild(newCell);
      }
    });
    syncHtmlFromDom();
  };
  const deleteCurrentColumn = () => {
    const sel = window.getSelection();
    const td =
      findClosest(sel?.anchorNode || null, "td") ||
      findClosest(sel?.anchorNode || null, "th");
    const tr = td?.parentElement;
    const table = findClosest(td || null, "table");
    if (!td || !tr || !table) return;
    const cellIndex = Array.from(tr.children).indexOf(td);
    // Ensure at least one column remains
    const firstRow = table.querySelector("tr");
    if ((firstRow?.children.length || 0) <= 1) return;
    Array.from(table.querySelectorAll("tr")).forEach((row) => {
      const cells = Array.from(row.children);
      if (cellIndex >= 0 && cellIndex < cells.length)
        row.removeChild(cells[cellIndex]);
    });
    syncHtmlFromDom();
  };

  const ViolationsEditableTable: React.FC = () => {
    const addRow = () =>
      setPcPairs((prev) => {
        if (activeRow !== null && activeRow >= 0 && activeRow < prev.length) {
          const next = [...prev];
          next.splice(activeRow + 1, 0, { left: "", mid: "", right: "" });
          return next;
        }
        return [...prev, { left: "", mid: "", right: "" }];
      });
    const deleteLastRow = () =>
      setPcPairs((prev) => {
        if (prev.length <= 1) return prev;
        if (activeRow !== null && activeRow >= 0 && activeRow < prev.length) {
          return prev.filter((_, i) => i !== activeRow);
        }
        return prev.slice(0, -1);
      });
    const removeRow = (rowIdx: number) => {
      setPcPairs((prev) =>
        prev.length > 1 ? prev.filter((_, i) => i !== rowIdx) : prev,
      );
    };

    const saveAsPDF = async () => {
      try {
        await exportPdfMutation.mutateAsync({
          templateId: template?.id ?? "",
          toWhom,
          toWhom2,
          toWhom3,
          presenceInfo,
          pcPairs,
          issuedBy,
          acceptedBy,
          acceptedDate,
          acceptedBy2,
          acceptedDate2,
          acceptedBy3,
          acceptedDate3,
        });
      } catch (e) {}
    };

    const escapeHtml = (s: string) =>
      s.replace(
        /[&<>"']/g,
        (m) =>
          ({
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#039;",
          })[m] as string,
      );

    // Refs to keep caret stable across rerenders
    const textRefs = React.useRef<
      { left: HTMLTextAreaElement | null; right: HTMLTextAreaElement | null }[]
    >([]);
    const pendingCaret = React.useRef<{
      idx: number;
      side: "left" | "right";
      start: number;
      end: number;
    } | null>(null);

    React.useEffect(() => {
      const p = pendingCaret.current;
      if (!p) return;
      const el = textRefs.current[p.idx]?.[p.side] ?? null;
      if (el) {
        try {
          el.focus();
          el.setSelectionRange(p.start, p.end);
        } catch {}
      }
      pendingCaret.current = null;
    }, [pcPairs]);

    const [activeRow, setActiveRow] = React.useState<number | null>(null);

    const buildRowsHtml = () =>
      pcPairs
        .map(
          (r, idx) => `
      <tr>
        <td>${idx + 1}.</td>
        <td>
          ${r.leftPhotoUrl ? `<img src="${r.leftPhotoUrl}"/>` : ""}
          <div>${escapeHtml(r.left || "").replace(/\n/g, "<br/>") || "&nbsp;"}</div>
        </td>
        <td><div>${escapeHtml(r.right || "").replace(/\n/g, "<br/>") || "&nbsp;"}</div></td>
      </tr>
    `,
        )
        .join("");

    const handleCellChange =
      (idx: number, side: "left" | "right") =>
      (e: React.ChangeEvent<HTMLTextAreaElement>) => {
        const el = e.currentTarget as HTMLTextAreaElement;
        const start = el.selectionStart ?? e.target.value.length;
        const end = el.selectionEnd ?? e.target.value.length;
        const value = e.target.value;
        pendingCaret.current = { idx, side, start, end };
        setPcPairs((prev) =>
          prev.map((row, i) => (i === idx ? { ...row, [side]: value } : row)),
        );
        el.style.height = "auto";
        el.style.height = el.scrollHeight + "px";
      };

    const saveAsHTML = () => {
      const styles = `
      body{font-family:'Times New Roman', Times, serif; color:#000;}
      table{width:100%;border-collapse:collapse}
      th,td{border:1px solid #000;padding:8px;vertical-align:top;font-size:14px}
      th{background:#f0f0f0;text-align:center}
      img{max-width:150px;max-height:150px;border:1px solid #ccc;margin:4px}
    `;
      const html = `<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><title>Таблица предписания</title><style>${styles}</style></head><body>
      <h1 style="text-align:center;font-size:18px;margin:0 0 12px 0;">Таблица предписания</h1>
      <table>
        <thead>
          <tr>
            <th width="5%">п/п</th>
            <th width="47%">Краткое изложение выявленных нарушений с указанием места обнаружения<br/>(при необходимости вкладывать фото)</th>
            <th width="43%">Предлагаемые меры, ответственные за выполнение и срок устранения нарушений</th>
          </tr>
        </thead>
        <tbody>${buildRowsHtml()}</tbody>
      </table>
    </body></html>`;
      const blob = new Blob([html], { type: "text/html" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "таблица_предписания.html";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      void apiClient.saveHtmlToStorage({
        html,
        name: "таблица_предписания",
        folderName: "Предписания",
      });
    };

    const saveAsWORD = async () => {
      const styles = `
      body{font-family:'Times New Roman', Times, serif; color:#000;}
      table{width:100%;border-collapse:collapse}
      th,td{border:1px solid #000;padding:8px;vertical-align:top;font-size:14px}
      th{background:#f0f0f0;text-align:center}
      img{max-width:150px;max-height:150px;border:1px solid #ccc;margin:4px}
    `;
      const html = `<!DOCTYPE html><html lang=\"ru\"><head><meta charset=\"UTF-8\"><title>Таблица предписания</title><style>${styles}</style></head><body>
      <h1 style=\"text-align:center;font-size:18px;margin:0 0 12px 0;\">Таблица предписания</h1>
      <table>
        <thead>
          <tr>
            <th width=\"5%\">п/п</th>
            <th width=\"47%\">Краткое изложение выявленных нарушений с указанием места обнаружения<br/>(при необходимости вкладывать фото)</th>
            <th width=\"43%\">Предлагаемые меры, ответственные за выполнение и срок устранения нарушений</th>
          </tr>
        </thead>
        <tbody>${buildRowsHtml()}</tbody>
      </table>
    </body></html>`;

      try {
        const res = await apiClient.convertHtmlToDocxAndSave({
          html,
          name: "таблица_предписания",
          folderName: "Предписания",
        });
        if (res?.url) {
          window.open(res.url, "_blank");
        }
      } catch (e) {
        console.error("save WORD failed", e);
      }
    };

    return (
      <div className="border rounded-md p-3 bg-white shadow-sm">
        <div className="flex gap-2 mb-2 print-hidden">
          <Button size="sm" variant="secondary" onClick={addRow}>
            Добавить строку
          </Button>
          <Button size="sm" variant="destructive" onClick={deleteLastRow}>
            Удалить строку
          </Button>
          {!isRestricted && (
            <div className="ml-auto flex gap-2">
              <Button
                size="sm"
                variant="secondary"
                onClick={() => window.print()}
              >
                Распечатать
              </Button>
              <Button size="sm" variant="secondary" onClick={saveAsPDF}>
                Сохранить в PDF
              </Button>{" "}
              <Button size="sm" onClick={saveAsHTML}>
                Сохранить как HTML
              </Button>
              <Button size="sm" variant="default" onClick={saveAsWORD}>
                Сохр. WORD
              </Button>
            </div>
          )}
        </div>
        <div className="overflow-x-auto">
          <table className="w-full border-collapse">
            <thead>
              <tr>
                <th className="border border-black p-2 w-[5%] text-center bg-muted">
                  п/п
                </th>
                <th className="border border-black p-2 w-[47%] bg-muted text-left">
                  Краткое изложение выявленных нарушений с указанием места
                  обнаружения
                  <br />
                  (при необходимости вкладывать фото)
                </th>
                <th className="border border-black p-2 w-[43%] bg-muted text-left">
                  Предлагаемые меры, ответственные за выполнение и срок
                  устранения нарушений
                </th>
                {!isRestricted && (
                  <th className="border border-black p-2 w-[5%] text-center bg-muted print-hidden">
                    Действия
                  </th>
                )}
              </tr>
            </thead>
            <tbody>
              {pcPairs.map((r, idx) => (
                <tr key={idx}>
                  <td className="border border-black p-2 align-top">
                    {idx + 1}.
                  </td>
                  <td className="border border-black p-2 align-top">
                    {/* Фото слева */}
                    {r.leftPhotoUrl ? (
                      <div>
                        <img
                          src={r.leftPhotoUrl}
                          alt="Фото"
                          className="max-w-[300px] h-auto border"
                        />
                        <div className="mt-2 flex gap-2 print-hidden">
                          <Button
                            size="sm"
                            variant="secondary"
                            disabled={uploadPhotoMutation.isLoading}
                            onClick={() => {
                              setPendingPhoto({ idx, side: "left" });
                              pcPhotoInputRef.current?.click();
                            }}
                          >
                            Заменить фото
                          </Button>
                          <Button
                            size="sm"
                            variant="destructive"
                            disabled={false}
                            onClick={() =>
                              setPcPairs((prev) =>
                                prev.map((row, i) =>
                                  i === idx
                                    ? { ...row, leftPhotoUrl: undefined }
                                    : row,
                                ),
                              )
                            }
                          >
                            Удалить фото
                          </Button>
                        </div>
                      </div>
                    ) : (
                      <div className="print-hidden mb-2">
                        <Button
                          size="sm"
                          variant="secondary"
                          disabled={
                            (firstRowLocked && idx === 0) ||
                            uploadPhotoMutation.isLoading
                          }
                          onClick={() => {
                            setPendingPhoto({ idx, side: "left" });
                            pcPhotoInputRef.current?.click();
                          }}
                        >
                          Добавить фото
                        </Button>
                      </div>
                    )}

                    <div
                      contentEditable
                      role="textbox"
                      aria-multiline="true"
                      onFocus={() => setActiveRow(idx)}
                      className="whitespace-pre-wrap break-words w-full min-h-[100px] outline-none uppercase"
                      onKeyDown={(e) => {
                        if (
                          (e as React.KeyboardEvent<HTMLDivElement>).key ===
                          "Enter"
                        ) {
                          e.preventDefault();
                        }
                      }}
                      onPaste={(e) => {
                        try {
                          const items =
                            (e.clipboardData && e.clipboardData.items) || [];
                          for (let i = 0; i < items.length; i++) {
                            const it = items[i] as any;
                            if (
                              it &&
                              it.type &&
                              String(it.type).startsWith("image/")
                            ) {
                              const file = it.getAsFile ? it.getAsFile() : null;
                              if (file) {
                                e.preventDefault();
                                const reader = new FileReader();
                                reader.onload = (ev) => {
                                  const base64 =
                                    (ev.target?.result as string) || "";
                                  if (base64) {
                                    setPendingPhoto({ idx, side: "left" });
                                    uploadPhotoMutation.mutate({
                                      base64,
                                      name: file.name || "pasted.png",
                                    });
                                  }
                                };
                                reader.readAsDataURL(file);
                                return;
                              }
                            }
                          }
                          const html =
                            e.clipboardData?.getData("text/html") || "";
                          if (html && html.includes("<img")) {
                            const m = html.match(/<img[^>]+src=\"([^\"]+)\"/i);
                            const src = m && m[1];
                            if (src) {
                              e.preventDefault();
                              setPcPairs((prev) =>
                                prev.map((row, i) =>
                                  i === idx
                                    ? { ...row, leftPhotoUrl: src }
                                    : row,
                                ),
                              );
                            }
                          }
                        } catch {}
                      }}
                      onDrop={(e) => {
                        e.preventDefault();
                        try {
                          const files = e.dataTransfer?.files;
                          if (files && files.length) {
                            const file = Array.from(files).find((f) =>
                              f.type.startsWith("image/"),
                            );
                            if (file) {
                              const reader = new FileReader();
                              reader.onload = (ev) => {
                                const base64 =
                                  (ev.target?.result as string) || "";
                                if (base64) {
                                  setPendingPhoto({ idx, side: "left" });
                                  uploadPhotoMutation.mutate({
                                    base64,
                                    name: file.name || "drop.png",
                                  });
                                }
                              };
                              reader.readAsDataURL(file);
                            }
                          }
                        } catch {}
                      }}
                      onDragOver={(e) => e.preventDefault()}
                      onInput={(e) => {
                        const raw = (e.currentTarget as HTMLDivElement)
                          .innerText;
                        const text = raw
                          .replace(/\r?\n+/g, " ")
                          .replace(/\s{2,}/g, " ")
                          .toUpperCase();
                        setPcPairs((prev) =>
                          prev.map((row, i) =>
                            i === idx ? { ...row, left: text } : row,
                          ),
                        );
                      }}
                      suppressContentEditableWarning={true}
                    >
                      {r.left}
                    </div>
                  </td>
                  <td className="border border-black p-2 align-top">
                    {r.rightPhotoUrl ? (
                      <div>
                        <img
                          src={r.rightPhotoUrl}
                          alt="Фото"
                          className="max-w-[300px] h-auto border"
                        />
                        <div className="mt-2 flex gap-2 print-hidden">
                          <Button
                            size="sm"
                            variant="secondary"
                            disabled={uploadPhotoMutation.isLoading}
                            onClick={() => {
                              setPendingPhoto({ idx, side: "right" });
                              pcPhotoInputRef.current?.click();
                            }}
                          >
                            Заменить фото
                          </Button>
                          <Button
                            size="sm"
                            variant="destructive"
                            onClick={() =>
                              setPcPairs((prev) =>
                                prev.map((row, i) =>
                                  i === idx
                                    ? { ...row, rightPhotoUrl: undefined }
                                    : row,
                                ),
                              )
                            }
                          >
                            Удалить фото
                          </Button>
                        </div>
                      </div>
                    ) : (
                      <div className="print-hidden mb-2">
                        <Button
                          size="sm"
                          variant="secondary"
                          disabled={uploadPhotoMutation.isLoading}
                          onClick={() => {
                            setPendingPhoto({ idx, side: "right" });
                            pcPhotoInputRef.current?.click();
                          }}
                        >
                          Добавить фото
                        </Button>
                      </div>
                    )}
                    <div
                      contentEditable
                      role="textbox"
                      aria-multiline="true"
                      onFocus={() => setActiveRow(idx)}
                      className="whitespace-pre-wrap break-words w-full min-h-[100px] outline-none uppercase"
                      onKeyDown={(e) => {
                        if (
                          (e as React.KeyboardEvent<HTMLDivElement>).key ===
                          "Enter"
                        ) {
                          e.preventDefault();
                        }
                      }}
                      onPaste={(e) => {
                        try {
                          const items =
                            (e.clipboardData && e.clipboardData.items) || [];
                          for (let i = 0; i < items.length; i++) {
                            const it = items[i] as any;
                            if (
                              it &&
                              it.type &&
                              String(it.type).startsWith("image/")
                            ) {
                              const file = it.getAsFile ? it.getAsFile() : null;
                              if (file) {
                                e.preventDefault();
                                const reader = new FileReader();
                                reader.onload = (ev) => {
                                  const base64 =
                                    (ev.target?.result as string) || "";
                                  if (base64) {
                                    setPendingPhoto({ idx, side: "right" });
                                    uploadPhotoMutation.mutate({
                                      base64,
                                      name: file.name || "pasted.png",
                                    });
                                  }
                                };
                                reader.readAsDataURL(file);
                                return;
                              }
                            }
                          }
                          const html =
                            e.clipboardData?.getData("text/html") || "";
                          if (html && html.includes("<img")) {
                            const m = html.match(/<img[^>]+src=\"([^\"]+)\"/i);
                            const src = m && m[1];
                            if (src) {
                              e.preventDefault();
                              setPcPairs((prev) =>
                                prev.map((row, i) =>
                                  i === idx
                                    ? { ...row, rightPhotoUrl: src }
                                    : row,
                                ),
                              );
                            }
                          }
                        } catch {}
                      }}
                      onDrop={(e) => {
                        e.preventDefault();
                        try {
                          const files = e.dataTransfer?.files;
                          if (files && files.length) {
                            const file = Array.from(files).find((f) =>
                              f.type.startsWith("image/"),
                            );
                            if (file) {
                              const reader = new FileReader();
                              reader.onload = (ev) => {
                                const base64 =
                                  (ev.target?.result as string) || "";
                                if (base64) {
                                  setPendingPhoto({ idx, side: "right" });
                                  uploadPhotoMutation.mutate({
                                    base64,
                                    name: file.name || "drop.png",
                                  });
                                }
                              };
                              reader.readAsDataURL(file);
                            }
                          }
                        } catch {}
                      }}
                      onDragOver={(e) => e.preventDefault()}
                      onInput={(e) => {
                        const raw = (e.currentTarget as HTMLDivElement)
                          .innerText;
                        const text = raw
                          .replace(/\r?\n+/g, " ")
                          .replace(/\s{2,}/g, " ")
                          .toUpperCase();
                        setPcPairs((prev) =>
                          prev.map((row, i) =>
                            i === idx ? { ...row, right: text } : row,
                          ),
                        );
                      }}
                      suppressContentEditableWarning={true}
                    >
                      {r.right}
                    </div>
                  </td>
                  {!isRestricted && (
                    <td className="border border-black p-2 align-top text-center print-hidden">
                      <Button
                        size="sm"
                        variant="destructive"
                        className="print-hidden"
                        onClick={() => removeRow(idx)}
                        disabled={pcPairs.length <= 1}
                      >
                        Удалить
                      </Button>
                    </td>
                  )}
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    );
  };

  const clearCurrentEditor = () => {
    try {
      const root = getEditorRoot();
      if (!root) return;
      // Очистить содержимое текущего редактора
      root.innerHTML = "";
      // Синхронизировать состояние страниц и общий html
      syncHtmlFromDom();
    } catch {
      // no-op
    }
  };

  if (isInitialLoading) {
    return (
      <div className="max-w-3xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Загрузка…</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Проверяем статус доступа.
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }
  if (me && !me.canAccessNow) {
    return <AccessRestrictionNotice blocked={(me as any).isBlocked ?? false} />;
  }

  return (
    <div className="max-w-5xl mx-auto p-4 sm:p-6">
      <Card className="card-elevated h-full">
        <CardHeader className="flex flex-col gap-2">
          <CardTitle>Электронная выдача АКТа ПК</CardTitle>
          <div className="flex items-center gap-2 flex-wrap print-hidden">
            <Button
              size="sm"
              variant="secondary"
              onClick={() => navigate("/home")}
            >
              На главную
            </Button>
            <div className="ml-auto flex gap-2">
              {isRestricted ? (
                <>
                  <Button
                    size="sm"
                    variant="secondary"
                    onClick={async () => {
                      try {
                        await exportPdfMutation.mutateAsync({
                          templateId: template?.id ?? "",
                          toWhom,
                          toWhom2,
                          toWhom3,
                          presenceInfo,
                          pcPairs,
                          issuedBy,
                          acceptedBy,
                          acceptedDate,
                          acceptedBy2,
                          acceptedDate2,
                          acceptedBy3,
                          acceptedDate3,
                        });
                      } catch (e) {}
                      window.print();
                    }}
                  >
                    Распечатать
                  </Button>

                  <Button size="sm" variant="destructive" onClick={clearForm}>
                    Очистить форму
                  </Button>
                </>
              ) : (
                <>
                  <Button
                    size="sm"
                    variant="secondary"
                    onClick={async () => {
                      try {
                        await exportPdfMutation.mutateAsync({
                          templateId: template?.id ?? "",
                          toWhom,
                          toWhom2,
                          toWhom3,
                          presenceInfo,
                          pcPairs,
                          issuedBy,
                          acceptedBy,
                          acceptedDate,
                          acceptedBy2,
                          acceptedDate2,
                          acceptedBy3,
                          acceptedDate3,
                        });
                      } catch (e) {}
                      window.print();
                    }}
                  >
                    Распечатать
                  </Button>
                  <Button
                    size="sm"
                    variant="secondary"
                    onClick={() =>
                      exportDocxMutation.mutate({
                        templateId: template?.id ?? "",
                        toWhom,
                        toWhom2,
                        toWhom3,
                        presenceInfo,
                        pcPairs,
                        issuedBy,
                        acceptedBy,
                        acceptedDate,
                        acceptedBy2,
                        acceptedDate2,
                        acceptedBy3,
                        acceptedDate3,
                      })
                    }
                    disabled={!template?.id || exportDocxMutation.isLoading}
                  >
                    {exportDocxMutation.isLoading ? "Создание…" : "В Word"}
                  </Button>
                  <Button
                    size="sm"
                    variant="secondary"
                    onClick={() =>
                      exportPdfMutation.mutate({
                        templateId: template?.id ?? "",
                        toWhom,
                        toWhom2,
                        toWhom3,
                        presenceInfo,
                        pcPairs,
                        issuedBy,
                        acceptedBy,
                        acceptedDate,
                        acceptedBy2,
                        acceptedDate2,
                        acceptedBy3,
                        acceptedDate3,
                      })
                    }
                    disabled={!template?.id || exportPdfMutation.isLoading}
                  >
                    {exportPdfMutation.isLoading
                      ? "Создание…"
                      : "Сохранить в PDF"}
                  </Button>
                  <Button
                    size="sm"
                    onClick={() =>
                      exportPdfMutation.mutate({
                        templateId: template?.id ?? "",
                        toWhom,
                        toWhom2,
                        toWhom3,
                        presenceInfo,
                        pcPairs,
                        issuedBy,
                        acceptedBy,
                        acceptedDate,
                        acceptedBy2,
                        acceptedDate2,
                        acceptedBy3,
                        acceptedDate3,
                      })
                    }
                    disabled={!template?.id || exportPdfMutation.isLoading}
                  >
                    {exportPdfMutation.isLoading ? "Создание…" : "Сохранить"}
                  </Button>
                  <Button size="sm" variant="destructive" onClick={clearForm}>
                    Очистить форму
                  </Button>
                </>
              )}
            </div>
          </div>
        </CardHeader>
        {isAdmin && manageMode && (
          <div className="mb-4 p-3 border rounded bg-accent/20 print-hidden">
            <div className="font-medium mb-2">Режим управления (ПК)</div>

            {pickerOpen && (
              <div className="mb-3 p-2 border rounded bg-background">
                <div className="mb-2 text-sm font-medium">Выбор страницы</div>
                <div className="flex flex-wrap gap-2">
                  {["ПК-2", "ПК-3", "ПК-4", "ПК-5", "ПК-6"].map((title) => (
                    <Button
                      size="sm"
                      key={title}
                      onClick={() => {
                        setPages((prev) => {
                          const base = prev ?? [];
                          let arr = [...base];
                          let idx = arr.findIndex(
                            (p) => (p.title || "") === title,
                          );
                          if (idx === -1) {
                            const newPage: PcPage = {
                              id: `p${arr.length + 1}`,
                              title,
                              html: title === "ПК-2" ? page2TemplateHtml : "",
                            };
                            arr.push(newPage);
                            idx = arr.length - 1;
                          }
                          setCurrentPageIndex(idx);
                          const combined = joinPages(arr);
                          setLocalHtml(combined);
                          return arr;
                        });
                        try {
                          const params = new URLSearchParams(
                            window.location.search,
                          );
                          params.set("manage", "1");
                          params.set("page", title);
                          params.delete("picker");
                          navigate(`/prod-control?${params.toString()}`, {
                            replace: true,
                          });
                        } catch {}
                        setPickerOpen(false);
                      }}
                    >
                      {title}
                    </Button>
                  ))}
                  <Button
                    variant="secondary"
                    size="sm"
                    onClick={() => {
                      try {
                        const params = new URLSearchParams(
                          window.location.search,
                        );
                        params.delete("picker");
                        navigate(`/prod-control?${params.toString()}`, {
                          replace: true,
                        });
                      } catch {}
                      setPickerOpen(false);
                    }}
                  >
                    Закрыть
                  </Button>
                </div>
              </div>
            )}

            {/* Панель страниц (видна только админам в режиме управления) */}
            <div className="mb-3 p-2 border rounded bg-background">
              <div className="flex flex-wrap items-center gap-2">
                <div className="text-sm font-medium mr-2">Страницы:</div>
                {pages && pages.length > 0 ? (
                  <div className="flex flex-wrap gap-2">
                    {pages.map((p, idx) => (
                      <Button
                        key={p.id}
                        size="sm"
                        variant={
                          idx === currentPageIndex ? "default" : "secondary"
                        }
                        onClick={() => setCurrentPageIndex(idx)}
                      >
                        {p.title || `Страница ${idx + 1}`}
                      </Button>
                    ))}
                  </div>
                ) : null}
                <div className="ml-auto flex items-center gap-2">
                  <Button
                    size="sm"
                    onClick={() => {
                      setPages((prev) => {
                        const base = prev ?? [];
                        const next: PcPage = {
                          id: `p${base.length + 1}`,
                          title: `Страница ${base.length + 1}`,
                          html: "",
                        };
                        const arr = [...base, next];
                        setCurrentPageIndex(arr.length - 1);
                        const combined = joinPages(arr);
                        setLocalHtml(combined);
                        return arr;
                      });
                    }}
                  >
                    Новая страница
                  </Button>
                  <Button
                    size="sm"
                    variant="default"
                    onClick={() => {
                      setPages((prev) => {
                        const base = prev ?? [];
                        let arr = [...base];
                        let idx = arr.findIndex(
                          (p) => (p.title || "") === "ПК",
                        );
                        if (idx === -1) {
                          const newPage: PcPage = {
                            id: `p${arr.length + 1}`,
                            title: "ПК",
                            html: pkTemplateHtml,
                          };
                          arr.push(newPage);
                          idx = arr.length - 1;
                        }
                        setCurrentPageIndex(idx);
                        const combined = joinPages(arr);
                        setLocalHtml(combined);
                        return arr;
                      });
                      try {
                        const params = new URLSearchParams(
                          window.location.search,
                        );
                        params.set("manage", "1");
                        params.set("page", "ПК");
                        params.delete("picker");
                        navigate(`/prod-control?${params.toString()}`, {
                          replace: true,
                        });
                      } catch {}
                    }}
                  >
                    Создать
                  </Button>
                </div>
              </div>
              {pages && pages[currentPageIndex] ? (
                <div className="mt-2 flex items-center gap-2">
                  <div className="text-sm text-muted-foreground">Название:</div>
                  <Input
                    className="max-w-xs"
                    value={pages[currentPageIndex].title}
                    onChange={(e) => {
                      const v = e.target.value;
                      setPages((prev) => {
                        if (!prev) return prev;
                        const arr = prev.map((p, i) =>
                          i === currentPageIndex ? { ...p, title: v } : p,
                        );
                        const combined = joinPages(arr);
                        setLocalHtml(combined);
                        return arr;
                      });
                    }}
                  />
                </div>
              ) : null}
            </div>

            <div className="flex flex-wrap gap-2 mb-2">
              {" "}
              <Button size="sm" variant="secondary" onClick={insertTextAtCaret}>
                Добавить текст
              </Button>
              <Button
                size="sm"
                variant="secondary"
                onClick={deleteSelectionAtCaret}
              >
                Удалить выделенное
              </Button>
              <div className="hidden sm:block w-px h-8 bg-border" />
              <Button
                size="sm"
                variant="secondary"
                onClick={() => addTableAtCaret(2, 2)}
              >
                Добавить таблицу
              </Button>
              <Button
                size="sm"
                variant="destructive"
                onClick={deleteCurrentTable}
              >
                Удалить таблицу
              </Button>
              <div className="hidden sm:block w-px h-8 bg-border" />
              <Button size="sm" variant="secondary" onClick={addRowAfter}>
                Добавить строку
              </Button>
              <Button
                size="sm"
                variant="destructive"
                onClick={deleteCurrentRow}
              >
                Удалить строку
              </Button>
              <div className="hidden sm:block w-px h-8 bg-border" />
              <Button size="sm" variant="secondary" onClick={addColumnAfter}>
                Добавить столбец
              </Button>
              <Button
                size="sm"
                variant="destructive"
                onClick={deleteCurrentColumn}
              >
                Удалить столбец
              </Button>
              <div className="hidden sm:block w-px h-8 bg-border" />
              <Button
                size="sm"
                variant={blockDeleteMode ? "destructive" : "secondary"}
                onClick={() => setBlockDeleteMode((v) => !v)}
              >
                {blockDeleteMode
                  ? "Удаление блоков: Вкл"
                  : "Удаление блоков: Выкл"}
              </Button>
              <Button
                size="sm"
                variant="destructive"
                onClick={() => {
                  const ok = window.confirm(
                    "Очистить текущую страницу? Это действие нельзя отменить.",
                  );
                  if (ok) clearCurrentEditor();
                }}
              >
                Очистить всё
              </Button>
            </div>

            <EditableDocxHtml
              html={
                isAdmin && manageMode && pages && pages[currentPageIndex]
                  ? pages[currentPageIndex].html
                  : localHtml || ""
              }
              onHtmlChange={(h) => {
                if (isAdmin && manageMode && pages && pages[currentPageIndex]) {
                  setPages((prev) => {
                    if (!prev) return prev;
                    const next = prev.map((p, i) =>
                      i === currentPageIndex ? { ...p, html: h } : p,
                    );
                    const combined = joinPages(next);
                    setLocalHtml(combined);
                    return next;
                  });
                } else {
                  setLocalHtml(h);
                }
              }}
            />
          </div>
        )}
        <CardContent>
          {!template?.id ? (
            <div className="text-muted-foreground">Шаблон ещё не загружен.</div>
          ) : (
            <>
              <EditableDocxHtml
                html={localHtml || ""}
                onHtmlChange={(h) => setLocalHtml(h)}
              />
              <div className="hidden mt-4 text-center leading-tight">
                <div>
                  <strong>
                    Электронная регистрация производственного контроля
                  </strong>
                </div>
                <div>
                  <strong>РОССИЙСКАЯ ФЕДЕРАЦИЯ (РОССИЯ)</strong>
                </div>
                <div>
                  <strong>РЕСПУБЛИКА САХА (ЯКУТИЯ)</strong>
                </div>
                <div>
                  <strong>
                    Акционерное Общество «Горно-рудная компания «Западная»
                  </strong>
                </div>
                <div>
                  678730, Республика Саха (Якутия), Оймяконский район, п. г. т.
                  Усть-Нера, проезд Северный, д.12.
                </div>
                <div>тел. 8 (395) 225-52-88, доб.*1502</div>
                <div className="mt-2 flex items-center justify-between text-sm">
                  <span>{dateStr}</span>
                  <span>Рудник «Бадран»</span>
                </div>
                <div className="mt-1 underline">
                  <strong>ПРЕДПИСАНИЕ (АКТ) {actNoStr}</strong>
                </div>
                <div className="mt-2">
                  Проверки по производственному контролю за состоянием ОТ и ПБ
                </div>{" "}
              </div>
              <div className="mt-3">
                <div className="flex items-center gap-2">
                  <div className="font-semibold shrink-0">Кому:</div>
                  <select
                    className="flex-1 border rounded h-9 px-3 bg-background"
                    value={toWhom || ""}
                    onChange={(e) => setToWhom(e.target.value)}
                  >
                    <option value="" disabled>
                      Выберите ФИО
                    </option>
                    {toWhomOptions.map((o, i) => (
                      <option key={i} value={o.value}>
                        {o.label}
                      </option>
                    ))}
                  </select>
                </div>
                <select
                  className="mt-2 w-full border rounded h-9 px-3 bg-background"
                  value={toWhom2 || ""}
                  onChange={(e) => setToWhom2(e.target.value)}
                >
                  <option value="" disabled>
                    Выберите пользователя
                  </option>
                  {toWhom2Options.map((o, i) => (
                    <option key={i} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>
                <select
                  className="mt-2 w-full border rounded h-9 px-3 bg-background"
                  value={toWhom3 || ""}
                  onChange={(e) => setToWhom3(e.target.value)}
                >
                  <option value="" disabled>
                    Выберите пользователя
                  </option>
                  {toWhom3Options.map((o, i) => (
                    <option key={i} value={o.value}>
                      {o.label}
                    </option>
                  ))}
                </select>{" "}
                <Input
                  className="mt-2 w-full h-9"
                  placeholder="Введите наименование подразделения"
                  value={departmentName || ""}
                  onChange={(e) => setDepartmentName(e.target.value)}
                />
                <div className="text-sm text-muted-foreground">
                  (наименование обследуемого подразделения общества)
                </div>
              </div>{" "}
              <div className="mt-3">
                <div className="font-semibold">
                  Проверка проведена в присутствии:
                </div>
                <Textarea
                  className="pc-autosize whitespace-pre-wrap break-words w-full h-9 min-h-0 resize-none overflow-hidden"
                  rows={1}
                  value={presenceInfo}
                  onChange={(e) => {
                    e.currentTarget.style.height = "auto";
                    e.currentTarget.style.height =
                      e.currentTarget.scrollHeight + "px";
                    setPresenceInfo(e.target.value);
                  }}
                />
                <div className="text-sm text-muted-foreground">
                  (должность, Ф.И.О.)
                </div>
              </div>
              <div className="mt-4">
                {" "}
                <div className="text-sm font-medium mb-2">
                  Предлагается устранить следующие нарушения в указанные сроки:
                </div>
                <ViolationsEditableTable key={vtKey} />
                <div className="mt-2 text-sm">
                  О выполнении настоящего предписания прошу предоставить
                  письменное уведомление в отдел ОТ и ПБ согласно дат, указанных
                  в пунктах.
                </div>
                {/* Подписи (перенесены под новую таблицу) */}
                <div style={{ marginTop: "2cm" }}>
                  <div className="flex items-center justify-between">
                    <div className="font-semibold">Предписание выдал:</div>
                    <div className="text-sm text-muted-foreground">
                      {new Date().toLocaleDateString("ru-RU")}
                    </div>
                  </div>
                  <Textarea
                    className="pc-autosize whitespace-pre-wrap break-words w-full h-9 min-h-0 resize-none overflow-hidden"
                    rows={1}
                    value={issuedBy}
                    placeholder="Ф.И.О., должность"
                    onChange={(e) => {
                      e.currentTarget.style.height = "auto";
                      e.currentTarget.style.height =
                        e.currentTarget.scrollHeight + "px";
                      setIssuedBy(e.target.value);
                    }}
                  />
                </div>
                <div style={{ marginTop: "1cm" }}>
                  <div className="flex items-center justify-between">
                    <div className="font-semibold">Предписание принял:</div>
                    <Input
                      type="date"
                      className="w-[150px]"
                      value={acceptedDate}
                      onChange={(e) => setAcceptedDate(e.target.value)}
                    />
                  </div>
                  <Textarea
                    className="pc-autosize whitespace-pre-wrap break-words w-full h-9 min-h-0 resize-none overflow-hidden"
                    rows={1}
                    value={acceptedBy}
                    placeholder="Ф.И.О., должность"
                    onChange={(e) => {
                      e.currentTarget.style.height = "auto";
                      e.currentTarget.style.height =
                        e.currentTarget.scrollHeight + "px";
                      setAcceptedBy(e.target.value);
                    }}
                  />
                </div>
                <div style={{ marginTop: "0.6cm" }}>
                  <div className="flex items-center justify-between">
                    <div className="font-semibold opacity-0">
                      Предписание принял:
                    </div>
                    <Input
                      type="date"
                      className="w-[150px]"
                      value={acceptedDate2}
                      onChange={(e) => setAcceptedDate2(e.target.value)}
                    />
                  </div>
                  <Textarea
                    className="pc-autosize whitespace-pre-wrap break-words w-full h-9 min-h-0 resize-none overflow-hidden"
                    rows={1}
                    value={acceptedBy2}
                    placeholder="Ф.И.О., должность"
                    onChange={(e) => {
                      e.currentTarget.style.height = "auto";
                      e.currentTarget.style.height =
                        e.currentTarget.scrollHeight + "px";
                      setAcceptedBy2(e.target.value);
                    }}
                  />
                </div>
                <div style={{ marginTop: "0.6cm" }}>
                  <div className="flex items-center justify-between">
                    <div className="font-semibold opacity-0">
                      Предписание принял:
                    </div>
                    <Input
                      type="date"
                      className="w-[150px]"
                      value={acceptedDate3}
                      onChange={(e) => setAcceptedDate3(e.target.value)}
                    />
                  </div>
                  <Textarea
                    className="pc-autosize whitespace-pre-wrap break-words w-full h-9 min-h-0 resize-none overflow-hidden"
                    rows={1}
                    value={acceptedBy3}
                    placeholder="Ф.И.О., должность"
                    onChange={(e) => {
                      e.currentTarget.style.height = "auto";
                      e.currentTarget.style.height =
                        e.currentTarget.scrollHeight + "px";
                      setAcceptedBy3(e.target.value);
                    }}
                  />
                </div>
                <div className="space-y-2 pc-pairs hidden">
                  {pcPairs.map((row, idx) => (
                    <div key={idx} className="flex items-start gap-2">
                      <Textarea
                        className="pc-autosize w-[1cm] h-9 min-h-0 resize-none overflow-hidden"
                        placeholder="№"
                        rows={1}
                        readOnly={false}
                        value={row.mid}
                        onChange={(e) => {
                          e.currentTarget.style.height = "auto";
                          e.currentTarget.style.height =
                            e.currentTarget.scrollHeight + "px";
                          setPcPairs((prev) =>
                            prev.map((r, i) =>
                              i === idx ? { ...r, mid: e.target.value } : r,
                            ),
                          );
                        }}
                      />
                      {/* Left cell with optional photo + text */}
                      <div className="flex-1 space-y-2">
                        {row.leftPhotoUrl ? (
                          <div>
                            <img
                              src={row.leftPhotoUrl}
                              alt="Фото"
                              className="w-full object-cover rounded-md border"
                              style={{ aspectRatio: "1 / 1" }}
                            />
                            <div className="mt-1 flex gap-2 print-hidden">
                              <Button
                                size="sm"
                                variant="secondary"
                                disabled={
                                  (firstRowLocked && idx === 0) ||
                                  uploadPhotoMutation.isLoading
                                }
                                onClick={() => {
                                  setPendingPhoto({ idx, side: "left" });
                                  pcPhotoInputRef.current?.click();
                                }}
                              >
                                Заменить фото
                              </Button>
                              <Button
                                size="sm"
                                variant="destructive"
                                disabled={false}
                                onClick={() =>
                                  setPcPairs((prev) =>
                                    prev.map((r, i) =>
                                      i === idx
                                        ? { ...r, leftPhotoUrl: undefined }
                                        : r,
                                    ),
                                  )
                                }
                              >
                                Удалить фото
                              </Button>
                            </div>
                          </div>
                        ) : (
                          <div className="print-hidden">
                            <Button
                              size="sm"
                              variant="secondary"
                              disabled={
                                (firstRowLocked && idx === 0) ||
                                uploadPhotoMutation.isLoading
                              }
                              onClick={() => {
                                setPendingPhoto({ idx, side: "left" });
                                pcPhotoInputRef.current?.click();
                              }}
                            >
                              <span className="inline-flex items-center gap-1">
                                <ImageIcon className="w-4 h-4" />
                                Фото
                              </span>
                            </Button>
                          </div>
                        )}
                        <Textarea
                          className="pc-autosize whitespace-pre-wrap break-words w-full h-9 min-h-0 resize-none overflow-hidden uppercase"
                          placeholder="Ячейка 1"
                          rows={1}
                          readOnly={false}
                          value={row.left}
                          onChange={(e) => {
                            e.currentTarget.style.height = "auto";
                            e.currentTarget.style.height =
                              e.currentTarget.scrollHeight + "px";
                            const v = e.target.value
                              .replace(/\r?\n+/g, " ")
                              .replace(/\s{2,}/g, " ")
                              .toUpperCase();
                            setPcPairs((prev) =>
                              prev.map((r, i) =>
                                i === idx ? { ...r, left: v } : r,
                              ),
                            );
                          }}
                        />{" "}
                      </div>

                      {/* Right cell with optional photo + text */}
                      <div className="flex-1 space-y-2">
                        {row.rightPhotoUrl ? (
                          <div>
                            <img
                              src={row.rightPhotoUrl}
                              alt="Фото"
                              className="w-full object-cover rounded-md border"
                              style={{ aspectRatio: "1 / 1" }}
                            />
                            <div className="mt-1 flex gap-2 print-hidden">
                              <Button
                                size="sm"
                                variant="secondary"
                                disabled={
                                  (firstRowLocked && idx === 0) ||
                                  uploadPhotoMutation.isLoading
                                }
                                onClick={() => {
                                  setPendingPhoto({ idx, side: "right" });
                                  pcPhotoInputRef.current?.click();
                                }}
                              >
                                Заменить фото
                              </Button>
                              <Button
                                size="sm"
                                variant="destructive"
                                disabled={false}
                                onClick={() =>
                                  setPcPairs((prev) =>
                                    prev.map((r, i) =>
                                      i === idx
                                        ? { ...r, rightPhotoUrl: undefined }
                                        : r,
                                    ),
                                  )
                                }
                              >
                                Удалить фото
                              </Button>
                            </div>
                          </div>
                        ) : (
                          <div className="print-hidden">
                            <Button
                              size="sm"
                              variant="secondary"
                              disabled={
                                (firstRowLocked && idx === 0) ||
                                uploadPhotoMutation.isLoading
                              }
                              onClick={() => {
                                setPendingPhoto({ idx, side: "right" });
                                pcPhotoInputRef.current?.click();
                              }}
                            >
                              <span className="inline-flex items-center gap-1">
                                <ImageIcon className="w-4 h-4" />
                                Фото
                              </span>
                            </Button>
                          </div>
                        )}
                        <Textarea
                          className="pc-autosize whitespace-pre-wrap break-words w-full h-9 min-h-0 resize-none overflow-hidden uppercase"
                          placeholder="Ячейка 2"
                          rows={1}
                          readOnly={false}
                          value={row.right}
                          onChange={(e) => {
                            e.currentTarget.style.height = "auto";
                            e.currentTarget.style.height =
                              e.currentTarget.scrollHeight + "px";
                            const v = e.target.value
                              .replace(/\r?\n+/g, " ")
                              .replace(/\s{2,}/g, " ")
                              .toUpperCase();
                            setPcPairs((prev) =>
                              prev.map((r, i) =>
                                i === idx ? { ...r, right: v } : r,
                              ),
                            );
                          }}
                        />{" "}
                      </div>

                      <Button
                        variant="destructive"
                        size="sm"
                        disabled={false}
                        onClick={() =>
                          setPcPairs((prev) =>
                            prev.length > 1
                              ? prev.filter((_, i) => i !== idx)
                              : prev,
                          )
                        }
                      >
                        Удалить
                      </Button>
                    </div>
                  ))}
                  <div className="mt-3 text-sm">
                    О выполнении настоящего предписания прошу предоставить
                    письменное уведомление в отдел ОТ и ПБ согласно дат,
                    указанных в пунктах.
                  </div>
                  {!isRestricted && (
                    <Button
                      className="mt-2"
                      variant="secondary"
                      size="sm"
                      onClick={() =>
                        setPcPairs((prev) => [
                          ...prev,
                          { left: "", mid: "", right: "" } as PcPair,
                        ])
                      }
                    >
                      Добавить ряд
                    </Button>
                  )}
                  <div style={{ marginTop: "2cm" }}>
                    <div className="flex items-center justify-between">
                      <div className="font-semibold">Предписание выдал:</div>
                      <div className="text-sm text-muted-foreground">
                        {new Date().toLocaleDateString("ru-RU")}
                      </div>
                    </div>
                    <Textarea
                      className="pc-autosize whitespace-pre-wrap break-words w-full h-9 min-h-0 resize-none overflow-hidden"
                      rows={1}
                      value={issuedBy}
                      placeholder="Ф.И.О., должность"
                      onChange={(e) => {
                        e.currentTarget.style.height = "auto";
                        e.currentTarget.style.height =
                          e.currentTarget.scrollHeight + "px";
                        setIssuedBy(e.target.value);
                      }}
                    />
                  </div>
                  <div style={{ marginTop: "1cm" }}>
                    <div className="flex items-center justify-between">
                      <div className="font-semibold">Предписание принял:</div>
                      <Input
                        type="date"
                        className="w-[150px]"
                        value={acceptedDate}
                        onChange={(e) => setAcceptedDate(e.target.value)}
                      />
                    </div>
                    <Textarea
                      className="pc-autosize whitespace-pre-wrap break-words w-full h-9 min-h-0 resize-none overflow-hidden"
                      rows={1}
                      value={acceptedBy}
                      placeholder="Ф.И.О., должность"
                      onChange={(e) => {
                        e.currentTarget.style.height = "auto";
                        e.currentTarget.style.height =
                          e.currentTarget.scrollHeight + "px";
                        setAcceptedBy(e.target.value);
                      }}
                    />
                  </div>
                  <div style={{ marginTop: "0.6cm" }}>
                    <div className="flex items-center justify-between">
                      <div className="font-semibold opacity-0">
                        Предписание принял:
                      </div>
                      <Input
                        type="date"
                        className="w-[150px]"
                        value={acceptedDate2}
                        onChange={(e) => setAcceptedDate2(e.target.value)}
                      />
                    </div>
                    <Textarea
                      className="pc-autosize whitespace-pre-wrap break-words w-full h-9 min-h-0 resize-none overflow-hidden"
                      rows={1}
                      value={acceptedBy2}
                      placeholder="Ф.И.О., должность"
                      onChange={(e) => {
                        e.currentTarget.style.height = "auto";
                        e.currentTarget.style.height =
                          e.currentTarget.scrollHeight + "px";
                        setAcceptedBy2(e.target.value);
                      }}
                    />
                  </div>
                  <div style={{ marginTop: "0.6cm" }}>
                    <div className="flex items-center justify-between">
                      <div className="font-semibold opacity-0">
                        Предписание принял:
                      </div>
                      <Input
                        type="date"
                        className="w-[150px]"
                        value={acceptedDate3}
                        onChange={(e) => setAcceptedDate3(e.target.value)}
                      />
                    </div>
                    <Textarea
                      className="pc-autosize whitespace-pre-wrap break-words w-full h-9 min-h-0 resize-none overflow-hidden"
                      rows={1}
                      value={acceptedBy3}
                      placeholder="Ф.И.О., должность"
                      onChange={(e) => {
                        e.currentTarget.style.height = "auto";
                        e.currentTarget.style.height =
                          e.currentTarget.scrollHeight + "px";
                        setAcceptedBy3(e.target.value);
                      }}
                    />
                  </div>{" "}
                </div>
              </div>
            </>
          )}{" "}
          <input
            ref={pcPhotoInputRef}
            type="file"
            accept="image/*"
            className="hidden"
            onChange={async (e) => {
              const file = e.target.files?.[0];
              if (!file || !pendingPhoto) return;
              const base64 = await encodeFileAsBase64DataURL(file);
              if (!base64) return;
              uploadPhotoMutation.mutate({ base64, name: file.name });
            }}
          />
        </CardContent>
        <CardFooter className="justify-between">
          {template?.updatedAt ? (
            <div className="text-xs text-muted-foreground">
              Обновлено: {new Date(template.updatedAt as any).toLocaleString()}
            </div>
          ) : (
            <div />
          )}
        </CardFooter>
      </Card>
    </div>
  );
}

class AppErrorBoundary extends React.Component<
  { children: React.ReactNode },
  { hasError: boolean; message?: string }
> {
  constructor(props: { children: React.ReactNode }) {
    super(props);
    this.state = { hasError: false };
  }
  static getDerivedStateFromError(error: any) {
    return { hasError: true, message: error?.message };
  }
  componentDidCatch(error: any, info: any) {
    console.error("AppErrorBoundary caught: ", error, info);
  }
  render() {
    if (this.state.hasError) {
      return (
        <div className="min-h-[calc(100vh-3.5rem)] flex items-center justify-center p-6">
          <Card className="max-w-lg w-full card-elevated">
            <CardHeader>
              <CardTitle>Что-то пошло не так</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-sm text-muted-foreground">
                {(this.state.message && String(this.state.message)) ||
                  "Неизвестная ошибка. Попробуйте обновить страницу или вернитесь на главную."}
              </div>
            </CardContent>
            <CardFooter className="flex gap-2">
              <NavLink to="/home">
                <Button className="btn-3d">На главную</Button>
              </NavLink>
              <Button
                variant="secondary"
                onClick={() => window.location.reload()}
              >
                Обновить
              </Button>
            </CardFooter>
          </Card>
        </div>
      );
    }
    return this.props.children as any;
  }
}

function TrainingSelectScreen() {
  useAuth({ required: true });
  const { data: me, isInitialLoading } = useQuery<Profile>(["me"], () =>
    apiClient.getMyProfile(),
  );
  const navigate = useNavigate();
  if (isInitialLoading) {
    return (
      <div className="max-w-3xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Загрузка…</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">Проверяем доступ…</div>
          </CardContent>
        </Card>
      </div>
    );
  }
  if (me && !me.canAccessNow) {
    return <AccessRestrictionNotice blocked={(me as any).isBlocked ?? false} />;
  }
  return (
    <div className="max-w-3xl mx-auto p-4 sm:p-6">
      <Card className="card-elevated h-full">
        <CardHeader>
          <CardTitle>Выбор обучения</CardTitle>
        </CardHeader>
        <CardContent className="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <button
            className="w-full h-24 btn-3d text-base font-semibold touch-target flex items-center justify-center"
            onClick={() => navigate("/pab-self-learning")}
          >
            Обучение ПАБ
          </button>
        </CardContent>
        <CardFooter className="flex gap-2">
          <Button variant="secondary" onClick={() => navigate("/training")}>
            Назад
          </Button>
        </CardFooter>
      </Card>
    </div>
  );
}

function PABSelfLearningScreen() {
  useAuth({ required: true });
  const { data: me, isInitialLoading } = useQuery<Profile>(["me"], () =>
    apiClient.getMyProfile(),
  );
  type PabContent = inferRPCOutputType<"getSelfLearningPABContent">;
  const { data: pab, isInitialLoading: isPabLoading } = useQuery<PabContent>(
    ["pab-self-learning"],
    () => apiClient.getSelfLearningPABContent(),
    { enabled: !isInitialLoading },
  );
  const navigate = useNavigate();
  if (isInitialLoading) {
    return (
      <div className="max-w-3xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Загрузка…</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Проверяем статус доступа.
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }
  if (me && !me.canAccessNow) {
    return <AccessRestrictionNotice blocked={(me as any).isBlocked ?? false} />;
  }
  return (
    <div className="max-w-4xl mx-auto p-4 sm:p-6">
      <Card className="card-elevated h-full">
        <CardHeader className="flex items-center justify-between">
          <CardTitle>Самообучение ПАБ</CardTitle>
          <div className="flex gap-2">
            <Button
              variant="secondary"
              onClick={() => navigate("/instructions/pab")}
            >
              Инструкция по работе с ПАБ
            </Button>
          </div>
        </CardHeader>
        <CardContent className="space-y-4">
          {isPabLoading ? (
            <div className="text-sm text-muted-foreground">
              Загрузка материала…
            </div>
          ) : pab?.html ? (
            <>
              <div className="text-xs text-muted-foreground flex flex-wrap gap-2">
                {pab.name && (
                  <span className="truncate">Источник: {pab.name}</span>
                )}
                {pab.updatedAt && (
                  <span>
                    обновлён:{" "}
                    {new Date(pab.updatedAt as any).toLocaleString("ru-RU")}
                  </span>
                )}
                {pab.url && (
                  <a
                    href={pab.url}
                    target="_blank"
                    rel="noreferrer"
                    className="text-primary underline"
                  >
                    Открыть исходный файл
                  </a>
                )}
              </div>
              <div
                className="prose prose-neutral max-w-none"
                dangerouslySetInnerHTML={{ __html: pab.html }}
              />
            </>
          ) : (
            <div className="text-muted-foreground">
              Материал не найден. Загрузите файл в раздел «Обучение админ»
              (папка «Обучение»), имя должно содержать «ПАБ».
            </div>
          )}
        </CardContent>
        <CardFooter className="flex gap-2 flex-wrap">
          <Button variant="secondary" onClick={() => navigate("/training")}>
            К разделу «Обучение»
          </Button>
          <Button variant="secondary" onClick={() => navigate("/home")}>
            На главную
          </Button>
        </CardFooter>
      </Card>
    </div>
  );
}

function PabInstructionScreen() {
  useAuth({ required: true });
  const { data: me, isInitialLoading } = useQuery<Profile>(["me"], () =>
    apiClient.getMyProfile(),
  );
  const navigate = useNavigate();
  const { data: page, isInitialLoading: loading } = useQuery(
    ["pab-instruction"],
    () => apiClient.getSimplePageBySlug({ slug: "pab-instruction" }),
  );

  const canEdit = Boolean((me as any)?.isAdmin || (me as any)?.isSuperAdmin);

  if (isInitialLoading) {
    return (
      <div className="max-w-4xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Загрузка…</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">Проверяем доступ…</div>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="max-w-4xl mx-auto p-4 sm:p-6">
      <Card className="card-elevated h-full">
        <CardHeader className="flex items-center justify-between">
          <div>
            <CardTitle>{page?.title || "Инструкция по ПАБ"}</CardTitle>
            {page?.updatedAt && (
              <div className="text-xs text-muted-foreground mt-1">
                Обновлено:{" "}
                {new Date(page.updatedAt as any).toLocaleString("ru-RU")}
              </div>
            )}
          </div>
                     {canEdit && (            <Button
              variant="secondary"
              onClick={() => navigate("/admin/pab-instruction")}
            >
              Редактировать
            </Button>
          )}
        </CardHeader>
        <CardContent>
          {loading ? (
            <div className="text-sm text-muted-foreground">Загрузка…</div>
          ) : page ? (
            <>
              <style>{`@media print { @page { size: A4; margin: 12mm; } header { display: none !important; } .no-print { display: none !important; } .card-elevated { box-shadow: none !important; border: none !important; } .print-content *, .print-content h1, .print-content h2, .print-content h3, .print-content h4, .print-content h5, .print-content h6, .print-content p, .print-content ul, .print-content ol, .print-content li, .print-content img, .print-content table, .print-content blockquote, .print-content pre, .print-content figure, .print-content tr, .print-content td, .print-content th { break-inside: avoid !important; page-break-inside: avoid !important; } .print-content table { width: 100% !important; border-collapse: collapse; } }`}</style>
              <div className="prose prose-neutral max-w-none print-content">
                <ReactMarkdown remarkPlugins={[remarkGfm]}>
                  {page.content || ""}
                </ReactMarkdown>
              </div>
            </>
          ) : (
            <div className="text-sm text-muted-foreground">
              Инструкция пока не добавлена. Обратитесь к администратору.
            </div>
          )}
        </CardContent>
        <CardFooter className="no-print flex gap-2">
          <Button variant="secondary" onClick={() => navigate(-1 as any)}>
            Назад
          </Button>
          <Button variant="outline" onClick={() => window.print()}>
            Распечатать
          </Button>
        </CardFooter>
      </Card>
    </div>
  );
}

function AdminTrainingScreen() {
  useAuth({ required: true });
  const { data: me, isInitialLoading } = useQuery<Profile>(["me"], () =>
    apiClient.getMyProfile(),
  );
  const navigate = useNavigate();
  const { toast } = useToast();
  const queryClient = useQueryClient();

  const { data: listing, isInitialLoading: filesLoading } = useQuery(
    ["admin-training-files"],
    () => apiClient.listTrainingMaterials(),
  );

  const [selectedFile, setSelectedFile] = React.useState<File | undefined>();
  const uploadMutation = useMutation(apiClient.uploadTrainingMaterial, {
    onSuccess: async () => {
      toast({ title: "Загружено" });
      await queryClient.invalidateQueries({
        queryKey: ["admin-training-files"],
      });
      setSelectedFile(undefined);
    },
    onError: (error: any) => {
      const msg = String(error?.message || error || "");
      if (msg.includes("FILE_TOO_LARGE")) {
        toast({
          title: "Файл слишком большой",
          description: "Максимальный размер — 100 МБ. Выберите другой файл.",
        });
      } else {
        toast({ title: "Не удалось загрузить файл" });
      }
    },
  });

  if (isInitialLoading) {
    return (
      <div className="max-w-4xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Загрузка…</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Проверяем статус доступа.
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }
  if (!me?.isAdmin) {
    return (
      <div className="max-w-4xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Доступ ограничен</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Раздел доступен только администраторам.
            </div>
          </CardContent>
          <CardFooter>
            <Button variant="secondary" onClick={() => navigate("/admin")}>
              Назад
            </Button>
          </CardFooter>
        </Card>
      </div>
    );
  }

  return (
    <div className="max-w-5xl mx-auto p-4 sm:p-6 space-y-4">
      <Card className="card-elevated h-full">
        <CardHeader>
          <CardTitle>Обучение «админ»</CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="text-sm text-muted-foreground">
            Загрузите файл любого формата (до 100 МБ) — он сохранится в папке
            «Обучение» хранилища.
          </div>
          <div className="flex flex-col sm:flex-row gap-2 items-start sm:items-center">
            <Input
              type="file"
              onChange={(e) => setSelectedFile(e.target.files?.[0])}
            />
            <Button
              className="btn-3d"
              disabled={!selectedFile || uploadMutation.isLoading}
              onClick={async () => {
                if (!selectedFile) return;
                // 100MB защитa
                const MAX_MB = 100;
                if (selectedFile.size > MAX_MB * 1024 * 1024) {
                  toast({
                    title: "Файл слишком большой",
                    description: `Максимум ${MAX_MB}MB`,
                  });
                  return;
                }
                const base64 = await encodeFileAsBase64DataURL(selectedFile);
                if (!base64) {
                  toast({ title: "Не удалось прочитать файл" });
                  return;
                }
                uploadMutation.mutate({ base64, name: selectedFile.name });
              }}
            >
              Загрузить
            </Button>
          </div>

          <div className="hr-muted w-full h-px" />

          <div className="space-y-2 p-3 border rounded">
            <div className="font-medium">Обучение ПАБ</div>
            <div className="text-sm text-muted-foreground">
              Быстрый переход к разделу «Самообучение ПАБ» для проверки и
              наполнения контента.
            </div>
            <div>
              <Button
                className="btn-3d"
                onClick={() => navigate("/pab-self-learning")}
              >
                Открыть «Обучение ПАБ»
              </Button>
            </div>
          </div>

          <div>
            <div className="font-medium mb-2">Материалы</div>
            {filesLoading ? (
              <div className="text-sm text-muted-foreground">
                Загрузка списка…
              </div>
            ) : listing?.files?.length ? (
              <div className="space-y-2">
                {listing.files.map((f: any) => (
                  <div
                    key={f.id}
                    className="flex items-center justify-between px-3 py-2 border rounded"
                  >
                    <a
                      href={f.url}
                      target="_blank"
                      rel="noreferrer"
                      className="truncate max-w-[70%] text-primary hover:underline"
                    >
                      {f.name}
                    </a>
                    <div className="text-xs text-muted-foreground">
                      {new Date(f.createdAt).toLocaleString("ru-RU")}
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div className="text-sm text-muted-foreground">
                Пока нет файлов
              </div>
            )}
          </div>
        </CardContent>
        <CardFooter>
          <Button variant="secondary" onClick={() => navigate("/admin")}>
            К админ-панели
          </Button>
        </CardFooter>
      </Card>
    </div>
  );
}

function KbtTemplatePreviewScreen() {
  useAuth({ required: true });
  const { toast } = useToast();
  const navigate = useNavigate();
  const TEMPLATE_URL =
    "https://drc9vtsp.on.adaptive.ai/cdn/kNhGay3NXAezWyNLTT2pyY4BZQjLeKjh.xlsx";

  const [loading, setLoading] = useState<boolean>(true);
  const [error, setError] = useState<string | null>(null);
  const [sheetNames, setSheetNames] = useState<string[]>([]);
  const [activeSheet, setActiveSheet] = useState<string>("");
  const [cells, setCells] = useState<{ ref: string; v: any; f?: string }[]>([]);

  useEffect(() => {
    let cancelled = false;
    (async () => {
      try {
        setLoading(true);
        setError(null);
        const res = await apiClient.getKbtTemplateParsed({});
        if (cancelled) return;
        setSheetNames(res.sheetNames || []);
        setActiveSheet(res.sheet || "");
        setCells((res.cells || []) as any);
      } catch (e: any) {
        setError(e?.message || "Ошибка загрузки файла");
      } finally {
        if (!cancelled) setLoading(false);
      }
    })();
    return () => {
      cancelled = true;
    };
  }, []);

  const handleCopy = (text: string, label?: string) => {
    if (!text) return;
    try {
      copy(String(text));
      toast({
        title: "Скопировано",
        description: label || "Значение ячейки скопировано",
      });
    } catch {
      toast({ title: "Не удалось скопировать" });
    }
  };

  return (
    <div className="w-full max-w-[120rem] mx-auto px-4 sm:px-6 space-y-4">
      <Card className="card-elevated h-full">
        <CardHeader className="flex items-center justify-between">
          <CardTitle>Шаблон КБТ — просмотр и копирование</CardTitle>
          <div className="flex gap-2">
            <Button
              variant="secondary"
              onClick={() => window.open(TEMPLATE_URL, "_blank", "noopener")}
            >
              Открыть оригинал
            </Button>
            <Button variant="secondary" onClick={() => navigate("/kbt")}>
              К списку
            </Button>
          </div>
        </CardHeader>
        <CardContent className="space-y-3">
          {loading && (
            <div className="text-sm text-muted-foreground">Загрузка файла…</div>
          )}
          {error && (
            <Alert>
              <AlertTitle>Ошибка</AlertTitle>
              <AlertDescription>{error}</AlertDescription>
            </Alert>
          )}

          {!loading && !error && (
            <>
              <div className="flex flex-col sm:flex-row gap-2 sm:items-center">
                <div className="text-sm text-muted-foreground">Лист:</div>
                <select
                  className="h-9 px-2 border rounded bg-background"
                  value={activeSheet}
                  onChange={(e) => setActiveSheet(e.target.value)}
                >
                  {sheetNames.map((n) => (
                    <option key={n} value={n}>
                      {n}
                    </option>
                  ))}
                </select>
                <div className="text-xs text-muted-foreground">
                  Показаны заполненные ячейки (значение и формула, если есть).
                </div>
              </div>

              <div className="border rounded">
                <ScrollArea className="h-[480px] w-full">
                  <div className="min-w-[720px]">
                    <Table>
                      <TableHeader>
                        <TableRow>
                          <TableHead className="w-[96px]">Ячейка</TableHead>
                          <TableHead>Значение</TableHead>
                          <TableHead className="w-[240px]">Действия</TableHead>
                        </TableRow>
                      </TableHeader>
                      <TableBody>
                        {cells.length === 0 && (
                          <TableRow>
                            <TableCell
                              colSpan={3}
                              className="text-sm text-muted-foreground"
                            >
                              Нет данных на выбранном листе
                            </TableCell>
                          </TableRow>
                        )}
                        {cells.map((c, idx) => (
                          <TableRow key={c.ref + idx}>
                            <TableCell className="font-mono text-xs">
                              {c.ref}
                            </TableCell>
                            <TableCell className="align-top">
                              <div className="text-sm break-words whitespace-pre-wrap">
                                {typeof c.v === "undefined" || c.v === null
                                  ? "—"
                                  : String(c.v)}
                              </div>
                              {c.f && (
                                <div className="text-xs text-muted-foreground mt-1 font-mono">
                                  Формула: {c.f}
                                </div>
                              )}
                            </TableCell>
                            <TableCell>
                              <div className="flex flex-wrap gap-2">
                                <Button
                                  size="sm"
                                  variant="secondary"
                                  onClick={() =>
                                    handleCopy(
                                      String(
                                        typeof c.v === "undefined" ? "" : c.v,
                                      ),
                                      `${c.ref}: значение`,
                                    )
                                  }
                                >
                                  Копировать значение
                                </Button>
                                {c.f && (
                                  <Button
                                    size="sm"
                                    variant="secondary"
                                    onClick={() =>
                                      handleCopy(c.f || "", `${c.ref}: формула`)
                                    }
                                  >
                                    Копировать формулу
                                  </Button>
                                )}
                              </div>
                            </TableCell>
                          </TableRow>
                        ))}
                      </TableBody>
                    </Table>
                  </div>
                  <ScrollBar orientation="vertical" />
                </ScrollArea>
              </div>
            </>
          )}
        </CardContent>
        <CardFooter>
          <Button variant="secondary" onClick={() => navigate("/kbt")}>
            Назад
          </Button>
        </CardFooter>
      </Card>
    </div>
  );
}

function KbtEditorScreen() {
  useAuth({ required: true });
  const { toast } = useToast();
  const navigate = useNavigate();
  const [templateUrl, setTemplateUrl] = useState<string>(
    "https://drc9vtsp.on.adaptive.ai/cdn/DwVKLnbMrc4XHtGi2qc4PtJzqxC6KjXR.xlsx",
  );

  const [loading, setLoading] = useState<boolean>(true);
  const [error, setError] = useState<string | null>(null);
  const [sheetNames, setSheetNames] = useState<string[]>([]);
  const [activeSheet, setActiveSheet] = useState<string>("");
  const [cellsLocal, setCellsLocal] = useState<
    { ref: string; v?: string; f?: string }[]
  >([]);

  useEffect(() => {
    let cancelled = false;
    (async () => {
      try {
        setLoading(true);
        setError(null);
        const res = await apiClient.getKbtTemplateParsed({ url: templateUrl });
        if (cancelled) return;
        setSheetNames(res.sheetNames || []);
        setActiveSheet(res.sheet || "");
        const parsed = ((res.cells || []) as any[]).map((c) => ({
          ref: String((c as any).ref || ""),
          v: (c as any).v,
          f: (c as any).f,
        }));
        setCellsLocal(parsed);
      } catch (e: any) {
        setError(e?.message || "Ошибка загрузки файла");
      } finally {
        if (!cancelled) setLoading(false);
      }
    })();
    return () => {
      cancelled = true;
    };
  }, [templateUrl]);

  const saveSheet = useMutation(apiClient.saveKbtSheetToStorage, {
    onSuccess: (res: { ok: boolean; url: string }) => {
      toast({ title: "Сохранено", description: "Файл добавлен в хранилище" });
      const a = document.createElement("a");
      const base = (fileName || activeSheet || "КБТ")
        .replace(/[\\/:*?"<>|]+/g, " ")
        .trim();
      a.href = res.url;
      a.download = `${base}.xlsx`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    },
    onError: () => toast({ title: "Не удалось сохранить" }),
  });

  const parseRef = (ref: string) => {
    const col = (ref.match(/^[A-Z]+/i)?.[0] || "").toUpperCase();
    const row = parseInt(ref.match(/\d+/)?.[0] || "0", 10);
    return { col, row };
  };
  const uniqueCols = React.useMemo(() => {
    const set = new Set<string>();
    cellsLocal.forEach((c) => {
      const { col } = parseRef(c.ref || "");
      if (col) set.add(col);
    });
    return Array.from(set).sort((a, b) => a.localeCompare(b));
  }, [cellsLocal]);
  const rowsSet = React.useMemo(() => {
    const set = new Set<number>();
    cellsLocal.forEach((c) => {
      const { row } = parseRef(c.ref || "");
      if (row > 0) set.add(row);
    });
    return Array.from(set).sort((a, b) => a - b);
  }, [cellsLocal]);

  const [newRef, setNewRef] = useState("");
  const [newVal, setNewVal] = useState("");
  const [newFormula, setNewFormula] = useState("");
  const addCell = () => {
    const ref = newRef.trim().toUpperCase();
    if (!ref) return;
    setCellsLocal((prev) => {
      const next = prev.filter((c) => c.ref !== ref);
      next.push({ ref, v: newVal || undefined, f: newFormula || undefined });
      return next;
    });
    setNewRef("");
    setNewVal("");
    setNewFormula("");
  };

  const addRow = () => {
    const maxRow =
      rowsSet.length > 0 ? (rowsSet[rowsSet.length - 1] as number) : 0;
    const targetRow = (maxRow ?? 0) + 1;
    const toAdd = uniqueCols.map((col) => ({
      ref: `${col}${targetRow}`,
      v: "",
    }));
    setCellsLocal((prev) => {
      const exist = new Set(prev.map((c) => c.ref));
      const merged = [...prev];
      toAdd.forEach((c) => {
        if (!exist.has(c.ref)) merged.push(c);
      });
      return merged;
    });
  };

  const [newCol, setNewCol] = useState("");
  const addColumn = () => {
    const col = newCol.trim().toUpperCase();
    if (!col) return;
    const toAdd = rowsSet.map((r) => ({ ref: `${col}${r}`, v: "" }));
    setCellsLocal((prev) => {
      const exist = new Set(prev.map((c) => c.ref));
      const merged = [...prev];
      toAdd.forEach((c) => {
        if (!exist.has(c.ref)) merged.push(c);
      });
      return merged;
    });
    setNewCol("");
  };

  const goToSheet = async (name: string) => {
    try {
      setLoading(true);
      setError(null);
      const res = await apiClient.getKbtTemplateParsed({
        sheet: name,
        url: templateUrl,
      });
      setActiveSheet(res.sheet || name);
      setSheetNames(res.sheetNames || sheetNames);
      const parsed = ((res.cells || []) as any[]).map((c) => ({
        ref: String((c as any).ref || ""),
        v: (c as any).v,
        f: (c as any).f,
      }));
      setCellsLocal(parsed);
    } catch (e: any) {
      setError(e?.message || "Ошибка загрузки листа");
    } finally {
      setLoading(false);
    }
  };
  const nextSheet = () => {
    if (!sheetNames.length) return;
    const idx = sheetNames.indexOf(activeSheet);
    const nextName =
      idx >= 0 && idx < sheetNames.length - 1
        ? sheetNames[idx + 1]
        : sheetNames[0];
    if (!nextName) return;
    void goToSheet(nextName as string);
  };
  const prevSheet = () => {
    if (!sheetNames.length) return;
    const idx = sheetNames.indexOf(activeSheet);
    const prevName =
      idx > 0 ? sheetNames[idx - 1] : sheetNames[sheetNames.length - 1];
    if (!prevName) return;
    void goToSheet(prevName as string);
  };

  const [fileName, setFileName] = useState("");

  return (
    <div className="w-full max-w-[120rem] mx-auto px-4 sm:px-6 space-y-4">
      <Card className="card-elevated h-full">
        <CardHeader className="flex items-center justify-between">
          <CardTitle>Шаблон КБТ — редактор</CardTitle>
          <div className="flex gap-2">
            <Button
              variant="secondary"
              onClick={() => window.open(templateUrl, "_blank", "noopener")}
            >
              Открыть оригинал
            </Button>
            <Button variant="secondary" onClick={() => navigate("/kbt")}>
              К списку
            </Button>
          </div>
        </CardHeader>
        <CardContent className="space-y-3">
          <div className="flex flex-col sm:flex-row gap-2 sm:items-center">
            <Input
              value={templateUrl}
              onChange={(e) => setTemplateUrl(e.target.value)}
              placeholder="Ссылка на .xlsx"
            />
            <Button
              variant="secondary"
              onClick={() => setTemplateUrl(templateUrl)}
            >
              Загрузить
            </Button>
          </div>

          {loading && (
            <div className="text-sm text-muted-foreground">Загрузка файла…</div>
          )}
          {error && (
            <Alert>
              <AlertTitle>Ошибка</AlertTitle>
              <AlertDescription>{error}</AlertDescription>
            </Alert>
          )}

          {!loading && !error && (
            <>
              <div className="flex flex-wrap items-center gap-2">
                <div className="text-sm text-muted-foreground">Лист:</div>
                <select
                  className="h-9 px-2 border rounded bg-background"
                  value={activeSheet}
                  onChange={(e) => goToSheet(e.target.value)}
                >
                  {sheetNames.map((n) => (
                    <option key={n} value={n}>
                      {n}
                    </option>
                  ))}
                </select>
                <Button size="sm" variant="secondary" onClick={prevSheet}>
                  Предыдущий лист
                </Button>
                <Button size="sm" variant="secondary" onClick={nextSheet}>
                  Следующий лист
                </Button>
                <div className="ml-auto flex items-center gap-2">
                  <Input
                    className="w-40"
                    placeholder="Имя файла"
                    value={fileName}
                    onChange={(e) => setFileName(e.target.value)}
                  />
                  <Button
                    className="btn-3d"
                    disabled={saveSheet.isLoading}
                    onClick={() =>
                      saveSheet.mutate({
                        sheet: activeSheet || "Лист1",
                        cells: cellsLocal,
                        fileName: fileName || undefined,
                      })
                    }
                  >
                    Сохранить в хранилище
                  </Button>
                </div>
              </div>

              <div className="grid gap-2 md:grid-cols-3">
                <div className="p-3 border rounded space-y-2">
                  <div className="font-medium">Добавить ячейку</div>
                  <div className="grid grid-cols-3 gap-2">
                    <Input
                      placeholder="Ref (например A1)"
                      value={newRef}
                      onChange={(e) => setNewRef(e.target.value)}
                    />
                    <Input
                      placeholder="Значение"
                      value={newVal}
                      onChange={(e) => setNewVal(e.target.value)}
                    />
                    <Input
                      placeholder="Формула (без =)"
                      value={newFormula}
                      onChange={(e) => setNewFormula(e.target.value)}
                    />
                  </div>
                  <Button variant="secondary" onClick={addCell}>
                    Добавить ячейку
                  </Button>
                </div>
                <div className="p-3 border rounded space-y-2">
                  <div className="font-medium">Добавить строку</div>
                  <div className="text-xs text-muted-foreground">
                    Будут добавлены пустые ячейки во все существующие столбцы.
                  </div>
                  <Button variant="secondary" onClick={addRow}>
                    Добавить строку ниже
                  </Button>
                </div>
                <div className="p-3 border rounded space-y-2">
                  <div className="font-medium">Добавить столбец</div>
                  <div className="flex items-center gap-2">
                    <span className="hidden" />
                    <Input
                      className="w-28"
                      placeholder="Напр. AA"
                      value={newCol}
                      onChange={(e) => setNewCol(e.target.value)}
                    />
                    <Button variant="secondary" onClick={addColumn}>
                      Добавить столбец
                    </Button>
                  </div>
                </div>
              </div>

              <div className="border rounded">
                <ScrollArea className="h-[520px] w-full">
                  <div className="min-w-[840px]">
                    <Table>
                      <TableHeader>
                        <TableRow>
                          <TableHead className="w-[96px]">Ячейка</TableHead>
                          <TableHead>Значение</TableHead>
                          <TableHead>Формула</TableHead>
                          <TableHead className="w-[220px]">Действия</TableHead>
                        </TableRow>
                      </TableHeader>
                      <TableBody>
                        {cellsLocal.length === 0 && (
                          <TableRow>
                            <TableCell
                              colSpan={4}
                              className="text-sm text-muted-foreground"
                            >
                              Нет данных на выбранном листе
                            </TableCell>
                          </TableRow>
                        )}
                        {cellsLocal.map((c, idx) => (
                          <TableRow key={c.ref + idx}>
                            <TableCell className="font-mono text-xs">
                              {c.ref}
                            </TableCell>
                            <TableCell className="align-top">
                              <Input
                                value={
                                  typeof c.v === "undefined" ? "" : String(c.v)
                                }
                                onChange={(e) =>
                                  setCellsLocal((prev) => {
                                    const next = [...prev];
                                    const current = next[idx] as {
                                      ref: string;
                                      v?: string;
                                      f?: string;
                                    };
                                    next[idx] = {
                                      ref: current?.ref ?? c.ref,
                                      v: e.target.value,
                                      f: current?.f,
                                    };
                                    return next;
                                  })
                                }
                              />
                            </TableCell>
                            <TableCell className="align-top">
                              <Input
                                value={c.f || ""}
                                onChange={(e) =>
                                  setCellsLocal((prev) => {
                                    const next = [...prev];
                                    const current = next[idx] as {
                                      ref: string;
                                      v?: string;
                                      f?: string;
                                    };
                                    next[idx] = {
                                      ref: current?.ref ?? c.ref,
                                      v: current?.v,
                                      f: e.target.value,
                                    };
                                    return next;
                                  })
                                }
                              />
                            </TableCell>
                            <TableCell>
                              <div className="flex flex-wrap gap-2">
                                <Button
                                  size="sm"
                                  variant="secondary"
                                  onClick={() =>
                                    copy(
                                      String(
                                        typeof c.v === "undefined" ? "" : c.v,
                                      ),
                                    )
                                  }
                                >
                                  Копировать значение
                                </Button>
                                {c.f && (
                                  <Button
                                    size="sm"
                                    variant="secondary"
                                    onClick={() => copy(c.f || "")}
                                  >
                                    Копировать формулу
                                  </Button>
                                )}
                                <Button
                                  size="sm"
                                  variant="destructive"
                                  onClick={() =>
                                    setCellsLocal((prev) =>
                                      prev.filter((x) => x.ref !== c.ref),
                                    )
                                  }
                                >
                                  Удалить
                                </Button>
                              </div>
                            </TableCell>
                          </TableRow>
                        ))}
                      </TableBody>
                    </Table>
                  </div>
                  <ScrollBar orientation="vertical" />
                </ScrollArea>
              </div>
            </>
          )}
        </CardContent>
        <CardFooter>
          <Button variant="secondary" onClick={() => navigate("/kbt")}>
            Назад
          </Button>
        </CardFooter>
      </Card>
    </div>
  );
}

function AdminIllustrationScreen() {
  useAuth({ required: true });
  const { data: me } = useQuery<Profile>(["me"], () =>
    apiClient.getMyProfile(),
  );
  const navigate = useNavigate();
  const { toast } = useToast();
  const queryClient = useQueryClient();

  const isAdmin = !!me?.isAdmin;

  const { data: illustration, isInitialLoading } = useQuery(
    ["login-illustration-admin"],
    () => apiClient.getLoginIllustrationUrl(),
    { enabled: isAdmin },
  );

  const create = useMutation(apiClient.generateLoginIllustration, {
    onSuccess: async (res: { ok: boolean; url?: string }) => {
      if (res?.ok) {
        await queryClient.invalidateQueries({
          queryKey: ["login-illustration-admin"],
        });
        toast({ title: "Иллюстрация создана" });
      } else {
        toast({ title: "Не удалось создать иллюстрацию" });
      }
    },
    onError: () => toast({ title: "Ошибка при создании иллюстрации" }),
  });

  if (!isAdmin) {
    return (
      <div className="max-w-4xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Доступ ограничен</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Раздел доступен только администраторам.
            </div>
          </CardContent>
          <CardFooter>
            <Button variant="secondary" onClick={() => navigate("/admin")}>
              Назад
            </Button>
          </CardFooter>
        </Card>
      </div>
    );
  }

  return (
    <div className="max-w-3xl mx-auto p-4 sm:p-6 space-y-4">
      <Card className="card-elevated h-full">
        <CardHeader>
          <CardTitle>Иллюстрация экрана входа (мобайл)</CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          {isInitialLoading ? (
            <div className="text-sm text-muted-foreground">Загрузка…</div>
          ) : illustration?.url ? (
            <div className="flex justify-center">
              <img
                src={illustration.url}
                alt="Иллюстрация входа"
                className="max-w-xs w-full h-auto rounded"
              />
            </div>
          ) : (
            <div className="text-sm text-muted-foreground">
              Иллюстрация ещё не создана.
            </div>
          )}
        </CardContent>
        <CardFooter className="flex gap-2">
          <Button
            onClick={() => create.mutate()}
            disabled={create.isLoading}
            className="btn-3d"
          >
            {create.isLoading ? "Создаём…" : "Создать"}
          </Button>
          <Button variant="secondary" onClick={() => navigate("/admin")}>
            К админ-панели
          </Button>
        </CardFooter>
      </Card>
    </div>
  );
}

function FormBuilderScreen() {
  useAuth({ required: true });
  const { data: me, isInitialLoading } = useQuery<Profile>(["me"], () =>
    apiClient.getMyProfile(),
  );
  const isAdmin = !!me?.isAdmin;
  const navigate = useNavigate();
  const { toast } = useToast();
  const queryClient = useQueryClient();

  // Grid state
  const [rows, setRows] = useState<number>(3);
  const [cols, setCols] = useState<number>(3);
  const [cells, setCells] = useState<string[][]>(() =>
    Array.from({ length: 3 }, () => Array.from({ length: 3 }, () => "")),
  );

  // Ensure cells array matches rows/cols
  useEffect(() => {
    setCells((prev) => {
      const r = rows;
      const c = cols;
      const next: string[][] = Array.from({ length: r }, (_, i) => {
        const row = (prev[i] ?? []) as string[];
        return Array.from({ length: c }, (_, j) =>
          typeof row[j] === "string" ? (row[j] as string) : "",
        );
      });
      return next;
    });
  }, [rows, cols]);

  type FormButton = {
    label: string;
    actionType: "save" | "navigate";
    target?: string;
    bgColor?: string;
    textColor?: string;
    fontSize?: number; // px
  };
  const [buttons, setButtons] = useState<FormButton[]>([
    {
      label: "Сохранить",
      actionType: "save",
      bgColor: "#1f2937",
      textColor: "#ffffff",
      fontSize: 14,
    },
  ]);

  const addRow = () => setRows((r) => Math.min(50, r + 1));
  const removeRow = () => setRows((r) => Math.max(1, r - 1));
  const addCol = () => setCols((c) => Math.min(50, c + 1));
  const removeCol = () => setCols((c) => Math.max(1, c - 1));

  const updateCell = (i: number, j: number, v: string) => {
    setCells((prev) => {
      const copy: string[][] = prev.map((row) => [...row]);
      const row: string[] =
        copy[i] ?? (copy[i] = Array.from({ length: cols }, () => ""));
      if (row.length <= j) {
        const need = j + 1 - row.length;
        row.push(...Array.from({ length: need }, () => ""));
      }
      row[j] = v;
      return copy;
    });
  };

  // Page meta
  const [pageTitle, setPageTitle] = useState<string>("Новая");
  const [pageSlug, setPageSlug] = useState<string>("");
  const [makeInteractive, setMakeInteractive] = useState<boolean>(true);

  // Save page mutation
  const savePage = useMutation(apiClient.upsertSimplePage, {
    onSuccess: async (p: any) => {
      toast({ title: "Страница сохранена" });
      await queryClient.invalidateQueries({ queryKey: ["simplePages"] });
      const slug = p?.slug || pageSlug;
      if (makeInteractive) navigate(`/form-page/${slug}`);
      else navigate(`/p/${slug}`);
    },
    onError: () => toast({ title: "Не удалось сохранить страницу" }),
  });

  const buildInteractivePayload = () => {
    const payload = {
      title: pageTitle,
      grid: { rows, cols, cells },
      buttons,
      createdAt: new Date().toISOString(),
      version: 1,
      kind: "form-builder",
    };
    return JSON.stringify(payload);
  };

  const buildStaticMarkdown = () => {
    // Simple text representation
    const lines: string[] = [];
    lines.push(`# ${pageTitle}`);
    lines.push("");
    for (let i = 0; i < rows; i++) {
      const row = cells[i] || [];
      lines.push(row.map((v) => `| ${v || " "} `).join("") + "|");
    }
    lines.push("");
    if (buttons.length) {
      lines.push("Кнопки:");
      buttons.forEach((b) =>
        lines.push(
          `- ${b.label}${b.actionType === "navigate" && b.target ? ` → ${b.target}` : ""}`,
        ),
      );
    }
    return lines.join("\n");
  };

  if (isInitialLoading) {
    return (
      <div className="max-w-4xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Загрузка…</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">Проверяем доступ…</div>
          </CardContent>
        </Card>
      </div>
    );
  }
  if (!isAdmin) {
    return (
      <div className="max-w-4xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Доступ ограничен</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Раздел доступен только администраторам.
            </div>
          </CardContent>
          <CardFooter>
            <Button variant="secondary" onClick={() => navigate("/admin")}>
              Назад
            </Button>
          </CardFooter>
        </Card>
      </div>
    );
  }

  return (
    <div className="w-full max-w-[120rem] mx-auto px-4 sm:px-6 space-y-4">
      <Card className="card-elevated h-full">
        <CardHeader className="space-y-2">
          {me?.isAdmin && (
            <div className="text-xs text-muted-foreground">
              Вы видите все инструменты настройки таблицы. Обычным пользователям
              доступна только кнопка «Отправить».
            </div>
          )}
          <CardTitle>Конструктор форм</CardTitle>
          <div className="grid md:grid-cols-2 gap-3">
            <div className="grid gap-2">
              <Label>Название страницы</Label>
              <Input
                value={pageTitle}
                onChange={(e) => setPageTitle(e.target.value)}
                placeholder="Новая"
              />
            </div>
            <div className="grid gap-2">
              <Label>Slug (адрес)</Label>
              <Input
                value={pageSlug}
                onChange={(e) => setPageSlug(e.target.value)}
                placeholder="novaya-forma"
              />
            </div>
          </div>
        </CardHeader>
        <CardContent className="space-y-6">
          <div className="space-y-3">
            <div className="font-medium">Сетка ячеек</div>
            <div className="flex flex-wrap gap-2 items-center">
              <Button variant="secondary" onClick={addRow}>
                Добавить строку
              </Button>
              <Button variant="secondary" onClick={removeRow}>
                Удалить строку
              </Button>
              <Button variant="secondary" onClick={addCol}>
                Добавить столбец
              </Button>
              <Button variant="secondary" onClick={removeCol}>
                Удалить столбец
              </Button>
              <div className="text-sm text-muted-foreground">
                {rows} × {cols}
              </div>
            </div>
            <div className="overflow-auto border rounded">
              <table className="min-w-full">
                <tbody>
                  {cells.map((row, i) => (
                    <tr key={i}>
                      {Array.from({ length: cols }).map((_, j) => (
                        <td key={j} className="border p-2 align-top">
                          <Input
                            value={cells[i]?.[j] ?? ""}
                            onChange={(e) => updateCell(i, j, e.target.value)}
                            placeholder={`Ячейка ${i + 1}:${j + 1}`}
                          />
                        </td>
                      ))}
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>

          <div className="space-y-3">
            <div className="font-medium">Кнопки</div>
            <div className="space-y-2">
              {buttons.map((b, idx) => (
                <div
                  key={idx}
                  className="grid md:grid-cols-6 gap-2 items-end border rounded p-2"
                >
                  <div className="grid gap-1">
                    <Label>Текст</Label>
                    <Input
                      value={b.label}
                      onChange={(e) =>
                        setButtons((prev) =>
                          prev.map((x, i) =>
                            i === idx ? { ...x, label: e.target.value } : x,
                          ),
                        )
                      }
                    />
                  </div>
                  <div className="grid gap-1">
                    <Label>Действие</Label>
                    <select
                      className="h-9 border rounded px-2 bg-background"
                      value={b.actionType}
                      onChange={(e) =>
                        setButtons((prev) =>
                          prev.map((x, i) =>
                            i === idx
                              ? { ...x, actionType: e.target.value as any }
                              : x,
                          ),
                        )
                      }
                    >
                      <option value="save">Сохранить (демо)</option>
                      <option value="navigate">Переход</option>
                    </select>
                  </div>
                  <div className="grid gap-1">
                    <Label>Путь (если переход)</Label>
                    <Input
                      value={b.target || ""}
                      onChange={(e) =>
                        setButtons((prev) =>
                          prev.map((x, i) =>
                            i === idx ? { ...x, target: e.target.value } : x,
                          ),
                        )
                      }
                      placeholder="/home"
                    />
                  </div>
                  <div className="grid gap-1">
                    <Label>Цвет кнопки</Label>
                    <Input
                      value={b.bgColor || ""}
                      onChange={(e) =>
                        setButtons((prev) =>
                          prev.map((x, i) =>
                            i === idx ? { ...x, bgColor: e.target.value } : x,
                          ),
                        )
                      }
                      placeholder="#1f2937"
                    />
                  </div>
                  <div className="grid gap-1">
                    <Label>Цвет текста</Label>
                    <Input
                      value={b.textColor || ""}
                      onChange={(e) =>
                        setButtons((prev) =>
                          prev.map((x, i) =>
                            i === idx ? { ...x, textColor: e.target.value } : x,
                          ),
                        )
                      }
                      placeholder="#ffffff"
                    />
                  </div>
                  <div className="grid gap-1">
                    <Label>Размер текста (px)</Label>
                    <Input
                      type="number"
                      value={b.fontSize ?? 14}
                      onChange={(e) =>
                        setButtons((prev) =>
                          prev.map((x, i) =>
                            i === idx
                              ? {
                                  ...x,
                                  fontSize: parseInt(
                                    e.target.value || "14",
                                    10,
                                  ),
                                }
                              : x,
                          ),
                        )
                      }
                    />
                  </div>
                  <div className="md:col-span-6 flex gap-2">
                    <Button
                      variant="destructive"
                      onClick={() =>
                        setButtons((prev) => prev.filter((_, i) => i !== idx))
                      }
                    >
                      Удалить
                    </Button>
                  </div>
                </div>
              ))}
              <Button
                variant="secondary"
                onClick={() =>
                  setButtons((prev) => [
                    ...prev,
                    {
                      label: "Кнопка",
                      actionType: "navigate",
                      target: "/home",
                      bgColor: "#0ea5e9",
                      textColor: "#ffffff",
                      fontSize: 14,
                    },
                  ])
                }
              >
                Добавить кнопку
              </Button>
            </div>
          </div>

          <div className="space-y-2">
            <div className="font-medium">Предпросмотр кнопок</div>
            <div className="flex flex-wrap gap-2">
              {buttons.map((b, i) => (
                <button
                  key={i}
                  className="touch-target rounded-md px-4 py-2"
                  style={{
                    background: b.bgColor || "#1f2937",
                    color: b.textColor || "#ffffff",
                    fontSize: (b.fontSize ?? 14) + "px",
                  }}
                  onClick={() => {
                    if (b.actionType === "navigate" && b.target)
                      navigate(b.target);
                    else toast({ title: "Сохранено (демо)" });
                  }}
                >
                  {b.label || "Кнопка"}
                </button>
              ))}
            </div>
          </div>

          <div className="space-y-2">
            <div className="flex items-center gap-2">
              <span className="hidden" />
              <Checkbox
                checked={makeInteractive}
                onCheckedChange={(v: boolean) => setMakeInteractive(!!v)}
              />
              <Label>Сделать страницу интерактивной</Label>
            </div>
            <div className="flex flex-wrap gap-2">
              <Button
                className="btn-3d"
                onClick={() => {
                  if (!pageTitle || !pageSlug) {
                    toast({ title: "Укажите название и slug" });
                    return;
                  }
                  const content = makeInteractive
                    ? buildInteractivePayload()
                    : buildStaticMarkdown();
                  savePage.mutate({
                    slug: pageSlug,
                    title: pageTitle,
                    content,
                  });
                }}
              >
                Сохранить как страницу
              </Button>
              <Button variant="secondary" onClick={() => navigate("/admin")}>
                К админ-панели
              </Button>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}

function InteractiveFormPageViewer() {
  useAuth({ required: true });
  const { slug = "" } = useParams<{ slug: string }>();
  const navigate = useNavigate();
  const { toast } = useToast();
  const { data, isInitialLoading } = useQuery(
    ["form-page", slug],
    () => apiClient.getSimplePageBySlug({ slug }),
    { enabled: !!slug },
  );

  let cfg: any = null;
  try {
    if (data?.content) cfg = JSON.parse(String(data.content));
  } catch {
    cfg = null;
  }

  if (isInitialLoading) {
    return (
      <div className="max-w-4xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Загрузка…</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">Открываем страницу…</div>
          </CardContent>
        </Card>
      </div>
    );
  }

  if (!cfg || cfg.kind !== "form-builder") {
    return (
      <div className="max-w-4xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>{data?.title ?? "Страница"}</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-sm text-muted-foreground">
              Эта страница не является интерактивной формой.
            </div>
          </CardContent>
          <CardFooter>
            <Button variant="secondary" onClick={() => navigate(-1 as any)}>
              Назад
            </Button>
          </CardFooter>
        </Card>
      </div>
    );
  }

  const rows = Math.max(1, Number(cfg?.grid?.rows || 0));
  const cols = Math.max(1, Number(cfg?.grid?.cols || 0));
  const cells: string[][] = Array.from({ length: rows }, (_, i) =>
    Array.from({ length: cols }, (_, j) => cfg?.grid?.cells?.[i]?.[j] ?? ""),
  );
  const buttons: any[] = Array.isArray(cfg?.buttons) ? cfg.buttons : [];

  return (
    <div className="w-full max-w-[120rem] mx-auto px-4 sm:px-6 space-y-4">
      <Card className="card-elevated h-full">
        <CardHeader>
          <CardTitle>{cfg.title || data?.title || "Форма"}</CardTitle>
        </CardHeader>
        <CardContent className="space-y-6">
          <div className="overflow-auto border rounded">
            <table className="min-w-full">
              <tbody>
                {cells.map((row, i) => (
                  <tr key={i}>
                    {row.map((v, j) => (
                      <td key={j} className="border p-2 align-top">
                        {v || ""}
                      </td>
                    ))}
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
          <div className="flex flex-wrap gap-2">
            {buttons.map((b, i) => (
              <button
                key={i}
                className="touch-target rounded-md px-4 py-2"
                style={{
                  background: b.bgColor || "#1f2937",
                  color: b.textColor || "#ffffff",
                  fontSize: (b.fontSize ?? 14) + "px",
                }}
                onClick={() => {
                  if (b.actionType === "navigate" && b.target)
                    navigate(b.target);
                  else toast({ title: "Сохранено (демо)" });
                }}
              >
                {b.label || "Кнопка"}
              </button>
            ))}
          </div>
        </CardContent>
        <CardFooter>
          <Button variant="secondary" onClick={() => navigate(-1 as any)}>
            Назад
          </Button>
        </CardFooter>
      </Card>
    </div>
  );
}

function AdminHomeManagementScreen() {
  useAuth({ required: true });
  const navigate = useNavigate();
  const { toast } = useToast();
  const queryClient = useQueryClient();
  const { data: me } = useQuery<Profile>(["me"], () =>
    apiClient.getMyProfile(),
  );
  const isAdmin = !!me?.isAdmin;

  const { data: buttons, isInitialLoading: btnLoading } = useQuery(
    ["homeButtons-admin"],
    () => apiClient.listHomeButtons(),
    { enabled: isAdmin },
  );
  const { data: pages } = useQuery(
    ["simplePages"],
    () => apiClient.listSimplePages(),
    { enabled: isAdmin },
  );

  const createBtn = useMutation(apiClient.createHomeButton, {
    onSuccess: async () => {
      await queryClient.invalidateQueries({ queryKey: ["homeButtons-admin"] });
      await queryClient.invalidateQueries({ queryKey: ["homeButtons"] });
      toast({ title: "Кнопка добавлена" });
    },
  });
  const updateBtn = useMutation(apiClient.updateHomeButton, {
    onSuccess: async () => {
      await queryClient.invalidateQueries({ queryKey: ["homeButtons-admin"] });
      await queryClient.invalidateQueries({ queryKey: ["homeButtons"] });
    },
  });
  const deleteBtn = useMutation(apiClient.deleteHomeButton, {
    onSuccess: async () => {
      await queryClient.invalidateQueries({ queryKey: ["homeButtons-admin"] });
      await queryClient.invalidateQueries({ queryKey: ["homeButtons"] });
      toast({ title: "Кнопка удалена" });
    },
  });
  const reorder = useMutation(apiClient.reorderHomeButtons, {
    onSuccess: async () => {
      await queryClient.invalidateQueries({ queryKey: ["homeButtons-admin"] });
      await queryClient.invalidateQueries({ queryKey: ["homeButtons"] });
    },
  });

  const upsertPage = useMutation(apiClient.upsertSimplePage, {
    onSuccess: async () => {
      await queryClient.invalidateQueries({ queryKey: ["simplePages"] });
      toast({ title: "Страница сохранена" });
    },
  });

  const [title, setTitle] = useState("");
  const [targetType, setTargetType] = useState<"PAGE" | "ROUTE">("ROUTE");
  const [targetPath, setTargetPath] = useState("/home");
  const [targetSlug, setTargetSlug] = useState("");
  const [isHidden, setIsHidden] = useState(false);
  const [isLocked, setIsLocked] = useState(false);

  const [pageSlug, setPageSlug] = useState("");
  const [pageTitle, setPageTitle] = useState("");
  const [pageContent, setPageContent] = useState("");

  if (!isAdmin) {
    return (
      <div className="max-w-4xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Доступ ограничен</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Раздел доступен только администраторам.
            </div>
          </CardContent>
          <CardFooter>
            <NavLink to="/admin">
              <Button variant="secondary">К админ-панели</Button>
            </NavLink>
          </CardFooter>
        </Card>
      </div>
    );
  }

  const move = (id: string, dir: -1 | 1) => {
    if (!buttons) return;
    const idx = (buttons as any[]).findIndex((b: any) => b.id === id);
    if (idx < 0) return;
    const arr: any[] = [...(buttons as any[])];
    const j = idx + dir;
    if (j < 0 || j >= arr.length) return;
    const tmp: any = arr[idx] as any;
    arr[idx] = arr[j] as any;
    arr[j] = tmp;
    reorder.mutate({ idsInOrder: arr.map((b: any) => b.id) });
  };

  return (
    <div className="max-w-6xl mx-auto p-4 sm:p-6 space-y-6">
      <Card className="card-elevated h-full">
        <CardHeader className="flex items-center justify-between">
          <CardTitle>Управление главной страницей</CardTitle>
          <div className="flex gap-2">
            <Button variant="secondary" onClick={() => navigate("/home")}>
              Открыть главную
            </Button>
          </div>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="font-medium">Кнопки</div>
          {btnLoading ? (
            <div className="text-sm text-muted-foreground">Загрузка…</div>
          ) : buttons?.length ? (
            <div className="border rounded-md overflow-hidden">
              <Table>
                <TableHeader>
                  <TableRow>
                    <TableHead>Название</TableHead>
                    <TableHead>Тип</TableHead>
                    <TableHead>Цель</TableHead>
                    <TableHead>Скрыть</TableHead>
                    <TableHead>Блокировка</TableHead>
                    <TableHead>Порядок</TableHead>
                    <TableHead>Действия</TableHead>
                  </TableRow>
                </TableHeader>
                <TableBody>
                  {buttons.map((b: any, i: number) => (
                    <TableRow key={b.id}>
                      <TableCell className="min-w-[200px]">{b.title}</TableCell>
                      <TableCell>{b.targetType}</TableCell>
                      <TableCell className="truncate max-w-[200px]">
                        {b.targetType === "PAGE" ? b.targetSlug : b.targetPath}
                      </TableCell>
                      <TableCell>
                        <Switch
                          checked={!!b.isHidden}
                          onCheckedChange={(v) =>
                            updateBtn.mutate({ id: b.id, isHidden: !!v })
                          }
                        />
                      </TableCell>
                      <TableCell>
                        <Switch
                          checked={!!b.isLocked}
                          onCheckedChange={(v) =>
                            updateBtn.mutate({ id: b.id, isLocked: !!v })
                          }
                        />
                      </TableCell>
                      <TableCell>
                        <div className="flex gap-1">
                          <Button
                            size="sm"
                            variant="secondary"
                            disabled={i === 0}
                            onClick={() => move(b.id, -1)}
                          >
                            ↑
                          </Button>
                          <Button
                            size="sm"
                            variant="secondary"
                            disabled={i === (buttons?.length || 1) - 1}
                            onClick={() => move(b.id, 1)}
                          >
                            ↓
                          </Button>
                        </div>
                      </TableCell>
                      <TableCell>
                        <Button
                          size="sm"
                          variant="destructive"
                          onClick={() => deleteBtn.mutate({ id: b.id })}
                        >
                          Удалить
                        </Button>
                      </TableCell>
                    </TableRow>
                  ))}
                </TableBody>
              </Table>
            </div>
          ) : (
            <div className="text-sm text-muted-foreground">Нет кнопок</div>
          )}

          <div className="hr-muted w-full h-px" />

          <div className="grid md:grid-cols-2 gap-6">
            <div className="space-y-3">
              <div className="font-medium">Добавить кнопку</div>
              <div className="grid gap-2">
                <Label>Название</Label>
                <Input
                  value={title}
                  onChange={(e) => setTitle(e.target.value)}
                  placeholder="Например: Новости"
                />
                <Label>Тип перехода</Label>
                <select
                  className="border rounded h-9 px-2 bg-background"
                  value={targetType}
                  onChange={(e) => setTargetType(e.target.value as any)}
                >
                  <option value="ROUTE">Маршрут</option>
                  <option value="PAGE">Простая страница</option>
                </select>
                {targetType === "ROUTE" ? (
                  <>
                    <Label>Путь</Label>
                    <Input
                      value={targetPath}
                      onChange={(e) => setTargetPath(e.target.value)}
                      placeholder="/путь"
                    />
                  </>
                ) : (
                  <>
                    <Label>Slug страницы</Label>
                    <Input
                      value={targetSlug}
                      onChange={(e) => setTargetSlug(e.target.value)}
                      placeholder="naprimer"
                    />
                  </>
                )}
                <div className="flex items-center gap-4">
                  <div className="flex items-center gap-2">
                    <span className="hidden" />
                    <Switch
                      checked={isHidden}
                      onCheckedChange={(v) => setIsHidden(!!v)}
                    />
                    <Label>Скрыть</Label>
                  </div>
                  <div className="flex items-center gap-2">
                    <span className="hidden" />
                    <Switch
                      checked={isLocked}
                      onCheckedChange={(v) => setIsLocked(!!v)}
                    />
                    <Label>Заблокировать</Label>
                  </div>
                </div>
                <Button
                  className="btn-3d"
                  disabled={
                    !title ||
                    (targetType === "ROUTE" ? !targetPath : !targetSlug) ||
                    createBtn.isLoading
                  }
                  onClick={() =>
                    createBtn.mutate({
                      title,
                      targetType,
                      targetPath: targetType === "ROUTE" ? targetPath : null,
                      targetSlug: targetType === "PAGE" ? targetSlug : null,
                      isHidden,
                      isLocked,
                    })
                  }
                >
                  Добавить
                </Button>
              </div>
            </div>
            <div className="space-y-3">
              <div className="font-medium">
                Создать/обновить простую страницу
              </div>
              <div className="grid gap-2">
                <Label>Slug</Label>
                <Input
                  value={pageSlug}
                  onChange={(e) => setPageSlug(e.target.value)}
                  placeholder="naprimer"
                />
                <Label>Заголовок</Label>
                <Input
                  value={pageTitle}
                  onChange={(e) => setPageTitle(e.target.value)}
                  placeholder="Заголовок страницы"
                />
                <Label>Содержимое</Label>
                <Textarea
                  rows={8}
                  value={pageContent}
                  onChange={(e) => setPageContent(e.target.value)}
                  placeholder="Текст…"
                />
                <Button
                  variant="secondary"
                  disabled={!pageSlug || !pageTitle}
                  onClick={() =>
                    upsertPage.mutate({
                      slug: pageSlug,
                      title: pageTitle,
                      content: pageContent,
                    })
                  }
                >
                  Сохранить страницу
                </Button>
                {pages?.length ? (
                  <div className="text-xs text-muted-foreground">
                    Доступные: {pages.map((p: any) => p.slug).join(", ")}
                  </div>
                ) : null}
              </div>
            </div>
          </div>
        </CardContent>
        <CardFooter>
          <NavLink to="/admin">
            <Button variant="secondary">К админ-панели</Button>
          </NavLink>
        </CardFooter>
      </Card>
    </div>
  );
}

function SimplePageViewer() {
  useAuth({ required: true });
  const { slug = "" } = useParams<{ slug: string }>();
  const s = (slug || "").toString();
  const { data, isInitialLoading } = useQuery(
    ["simplePage", s],
    () => apiClient.getSimplePageBySlug({ slug: s }),
    { enabled: !!s },
  );
  const navigate = useNavigate();
  const previewRef = useRef<HTMLDivElement | null>(null);
  const lastClickedCellRef = useRef<HTMLElement | null>(null);

  useEffect(() => {
    const root = previewRef.current;
    if (!root) return;

    const onClick = (e: Event) => {
      const target = e.target as HTMLElement;
      const cell = target.closest(
        "td, th, div, section, article",
      ) as HTMLElement | null;
      if (cell) lastClickedCellRef.current = cell;
    };
    root.addEventListener("click", onClick, true);

    const onInput = (e: Event) => {
      const t = e.target as HTMLElement | null;
      if (!t) return;
      if (t.tagName === "TEXTAREA") {
        const ta = t as HTMLTextAreaElement;
        ta.style.height = "auto";
        ta.style.height = `${ta.scrollHeight}px`;
        const td = ta.closest("td") as HTMLElement | null;
        if (td) td.style.height = "auto";
      }
    };
    root.addEventListener("input", onInput, true);

    const findTable = (maybeId?: any): HTMLTableElement | null => {
      const r = previewRef.current;
      if (!r) return null;
      if (typeof maybeId === "string") {
        const byId = r.querySelector("#" + maybeId) as HTMLTableElement | null;
        if (byId && byId.tagName.toLowerCase() === "table") return byId;
      }
      return (r.querySelector("table[data-act-table]") ||
        r.querySelector("table")) as HTMLTableElement | null;
    };

    (window as any).addRow = (...args: any[]) => {
      const table = findTable(args[0]);
      if (!table) return;
      const tbody = (table.tBodies[0] || table) as any;
      const rowsArr = tbody.rows?.length
        ? Array.from(tbody.rows)
        : Array.from((table as any).rows || []);
      const lastRow = rowsArr[rowsArr.length - 1] as
        | HTMLTableRowElement
        | undefined;
      const newRow = lastRow
        ? (lastRow.cloneNode(true) as HTMLTableRowElement)
        : (document.createElement("tr") as HTMLTableRowElement);
      if (!lastRow) newRow.appendChild(document.createElement("td"));
      // Очистим вводимые значения, сохранив элементы управления
      newRow.querySelectorAll("input, textarea").forEach((el: any) => {
        el.value = "";
      });
      newRow.querySelectorAll('[contenteditable="true"]').forEach((el) => {
        (el as HTMLElement).innerText = "";
      });
      newRow.querySelectorAll("img").forEach((img) => {
        (img as HTMLImageElement).src = "";
      });
      // Убедимся, что в новой строке есть кнопка вставки фото и поле описания
      try {
        const cells = (newRow as HTMLTableRowElement).cells?.length
          ? Array.from((newRow as HTMLTableRowElement).cells)
          : Array.from(newRow.querySelectorAll("td"));
        const photoCell = (cells[1] || cells[0]) as HTMLElement | undefined;
        if (photoCell && !photoCell.querySelector("[data-photo-button]")) {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.setAttribute("data-photo-button", "1");
          btn.textContent = "+ Вставить фото";
          btn.style.marginTop = "6px";
          btn.style.display = "inline-block";
          btn.addEventListener("click", () => {
            (window as any).addPhotoToCell?.();
          });
          photoCell.appendChild(btn);
        }
        if (photoCell && !photoCell.querySelector("[data-photo-text]")) {
          const ta = document.createElement("textarea");
          ta.setAttribute("data-photo-text", "1");
          ta.placeholder = "Введите описание…";
          ta.style.width = "100%";
          ta.style.minHeight = "72px";
          ta.style.marginTop = "6px";
          ta.style.resize = "vertical";
          ta.style.overflow = "hidden";
          (ta as HTMLTextAreaElement).value = "";
          const autosize = (el: HTMLTextAreaElement) => {
            el.style.height = "auto";
            el.style.height = `${el.scrollHeight}px`;
          };
          ta.addEventListener("input", () => autosize(ta));
          setTimeout(() => autosize(ta), 0);
          photoCell.appendChild(ta);
        }
      } catch {}

      tbody.appendChild(newRow);

      // Перенумеруем строки после добавления
      const rows = Array.from(
        (tbody as any).rows || [],
      ) as HTMLTableRowElement[];
      let withDot = false;
      for (const r of rows) {
        const c = r.querySelector("td");
        const txt = (c?.textContent || "").trim();
        if (txt) {
          withDot = txt.endsWith(".");
          break;
        }
      }
      rows.forEach((r, idx) => {
        const firstCell = r.querySelector("td");
        if (!firstCell) return;
        firstCell.textContent = `${idx + 1}${withDot ? "." : ""}`;
      });
    };

    (window as any).deleteRow = (...args: any[]) => {
      const table = findTable(args[0]);
      if (!table) return;
      const tbody = table.tBodies[0] || table;
      const rows = (tbody as any).rows || [];
      const renumber = () => {
        const all = Array.from(
          (tbody as any).rows || [],
        ) as HTMLTableRowElement[];
        const firstTxt = (
          (tbody as any).querySelector?.("tr td")?.textContent || ""
        ).trim();
        const withDot = firstTxt.endsWith(".");
        all.forEach((r, idx) => {
          const c = r.querySelector("td");
          if (c) c.textContent = `${idx + 1}${withDot ? "." : ""}`;
        });
      };
      if (lastClickedCellRef.current) {
        const tr = lastClickedCellRef.current.closest("tr");
        if (tr && tr.parentElement === tbody && rows.length > 1) {
          (tbody as any).removeChild(tr);
          renumber();
          return;
        }
      }
      if (rows.length > 1) {
        (tbody as any).deleteRow(rows.length - 1);
        renumber();
      }
    };

    (window as any).promoteThirdRowToFirst = (...args: any[]) => {
      const table = findTable(args[0]);
      if (!table) return;
      const tbody = (table.tBodies[0] || table) as any;
      const rowsArr = Array.from(
        ((tbody as any).rows && (tbody as any).rows.length
          ? (tbody as any).rows
          : (table as any).rows) as any,
      ) as HTMLTableRowElement[];
      const dataRows: HTMLTableRowElement[] = rowsArr.filter((r) => {
        const first = r.querySelector("td");
        if (!first) return false;
        const raw = (first.textContent || "").trim();
        const num = parseInt(raw.replace(".", ""), 10);
        return !Number.isNaN(num);
      });
      if (dataRows.length >= 3) {
        const r1 = dataRows[0];
        const r2 = dataRows[1];
        if (r1 && (r1 as any).parentElement === tbody)
          (tbody as any).removeChild(r1);
        if (r2 && (r2 as any).parentElement === tbody)
          (tbody as any).removeChild(r2);
      }
      const updatedRows = Array.from(
        ((tbody as any).rows && (tbody as any).rows.length
          ? (tbody as any).rows
          : (table as any).rows) as any,
      ) as HTMLTableRowElement[];
      const newDataRows: HTMLTableRowElement[] = updatedRows.filter((r) => {
        const first = r.querySelector("td");
        if (!first) return false;
        const raw = (first.textContent || "").trim();
        const num = parseInt(raw.replace(".", ""), 10);
        return !Number.isNaN(num);
      });
      const firstDataRow = newDataRows[0];
      if (firstDataRow) {
        try {
          const cells = (firstDataRow as any).cells?.length
            ? Array.from((firstDataRow as any).cells)
            : Array.from(firstDataRow.querySelectorAll("td"));
          const photoCell = (cells[1] || cells[0]) as HTMLElement | undefined;
          if (photoCell && !photoCell.querySelector("[data-photo-button]")) {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.setAttribute("data-photo-button", "1");
            btn.textContent = "+ Вставить фото";
            btn.style.marginTop = "6px";
            btn.style.display = "inline-block";
            btn.addEventListener("click", () => {
              (window as any).addPhotoToCell?.();
            });
            photoCell.appendChild(btn);
          }
          if (photoCell && !photoCell.querySelector("[data-photo-text]")) {
            const ta = document.createElement("textarea");
            ta.setAttribute("data-photo-text", "1");
            ta.placeholder = "Введите описание…";
            ta.style.width = "100%";
            ta.style.minHeight = "72px";
            ta.style.marginTop = "6px";
            ta.style.resize = "vertical";
            ta.style.overflow = "hidden";
            ta.value = "";
            const autosize = (el: HTMLTextAreaElement) => {
              el.style.height = "auto";
              el.style.height = `${el.scrollHeight}px`;
            };
            ta.addEventListener("input", () => autosize(ta));
            setTimeout(() => autosize(ta), 0);
            photoCell.appendChild(ta);
          }
        } catch {}
      }
      const allRows = Array.from(
        ((tbody as any).rows && (tbody as any).rows.length
          ? (tbody as any).rows
          : (table as any).rows) as any,
      ) as HTMLTableRowElement[];
      let withDot = false;
      for (const r of allRows) {
        const c = r.querySelector("td");
        const txt = (c?.textContent || "").trim();
        if (txt) {
          withDot = txt.endsWith(".");
          break;
        }
      }
      const onlyData = allRows.filter((r) => r.querySelector("td"));
      onlyData.forEach((r, idx) => {
        const c = r.querySelector("td");
        if (c) c.textContent = `${idx + 1}${withDot ? "." : ""}`;
      });
    };

    (window as any).addSignatureLine = () => {
      const r = previewRef.current;
      if (!r) return;
      const container = (r.querySelector("[data-signatures]") ||
        r.querySelector("#signatures") ||
        r) as HTMLElement;
      const line = document.createElement("div");
      line.style.marginTop = "8px";
      line.style.display = "flex";
      line.style.alignItems = "center";
      line.style.gap = "12px";

      const nameInput = document.createElement("input");
      nameInput.type = "text";
      nameInput.placeholder = "ФИО, должность";
      nameInput.style.flex = "1";
      nameInput.style.border = "none";
      nameInput.style.borderBottom = "1px solid #444";
      nameInput.style.outline = "none";

      const dateInput = document.createElement("input");
      dateInput.type = "date";
      dateInput.style.width = "165px";
      const today = new Date();
      const iso = new Date(today.getTime() - today.getTimezoneOffset() * 60000)
        .toISOString()
        .slice(0, 10);
      dateInput.value = iso;

      line.appendChild(nameInput);
      line.appendChild(dateInput);
      container.appendChild(line);
    };

    (window as any).addPhotoToCell = () => {
      const target = (lastClickedCellRef.current ||
        previewRef.current) as HTMLElement | null;
      if (!target) return;
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "image/*";
      input.onchange = () => {
        const file = input.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          const img = document.createElement("img");
          img.src = String(reader.result || "");
          img.style.maxWidth = "100%";
          img.style.height = "auto";
          target.appendChild(img);
        };
        reader.readAsDataURL(file);
      };
      input.click();
    };

    (window as any).printAkt = () => {
      try {
        const w = window.open("", "_blank");
        if (!w) return;
        const css = `
          @page { size: A4; margin-top: 1cm; margin-right: 1cm; margin-bottom: 1cm; margin-left: 2cm; }
          @media print {
            button, [role=\"button\"], .no-print { display: none !important; }
            table { page-break-inside: auto; }
            tr, img { page-break-inside: avoid; }
            p { orphans: 2; widows: 2; }
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
          }
          html, body { height: 100%; }
          body { margin: 0; padding: 0; }
          .print-root { box-sizing: border-box; width: 180mm; height: 277mm; overflow: hidden; margin: 0 auto; }
          #fit-content { transform-origin: top left; }
        `;
        const content = previewRef.current?.innerHTML || "";
        w.document.write(
          `<!DOCTYPE html><html><head><meta charset=\"utf-8\"><title>Печать</title><style>${css}</style></head><body><div class=\"print-root\"><div id=\"fit-content\">${content}</div></div></body></html>`,
        );
        w.document.close();
        w.onload = () => {
          try {
            const root = w.document.querySelector(".print-root");
            const inner = w.document.getElementById("fit-content");
            if (!root || !inner) {
              w.print();
              return;
            }
            const imgs = Array.from(w.document.images || []);
            const waitImgs = Promise.all(
              imgs.map((img) =>
                img.complete
                  ? Promise.resolve()
                  : new Promise((res) => {
                      img.onload = img.onerror = () => res(undefined);
                    }),
              ),
            );
            const fitAndPrint = () => {
              try {
                (inner as HTMLElement).style.transform = "none";
                const availW = (root as HTMLElement).clientWidth || 1;
                const availH = (root as HTMLElement).clientHeight || 1;
                const rect = (inner as HTMLElement).getBoundingClientRect();
                const scale = Math.min(
                  availW / Math.max(rect.width, 1),
                  availH / Math.max(rect.height, 1),
                  1,
                );
                (inner as HTMLElement).style.transform = `scale(${scale})`;
                w.focus();
                setTimeout(() => w.print(), 50);
              } catch {
                w.print();
              }
            };
            waitImgs.then(() => setTimeout(fitAndPrint, 0));
          } catch {
            w.print();
          }
        };
      } catch (e) {
        console.error("printAkt failed", e);
      }
    };

    (window as any).printForm = () => {
      if ((window as any).printAkt) {
        (window as any).printAkt();
      } else {
        window.print();
      }
    };

    return () => {
      root.removeEventListener("click", onClick, true);
      root.removeEventListener("input", onInput, true);
      try {
        delete (window as any).addRow;
        delete (window as any).deleteRow;
        delete (window as any).promoteThirdRowToFirst;
        delete (window as any).addSignatureLine;
        delete (window as any).addPhotoToCell;
        delete (window as any).printForm;
      } catch {}
    };
  }, [data?.content]);

  return (
    <div className="max-w-3xl mx-auto p-4 sm:p-6">
      <Card className="card-elevated h-full">
        <CardHeader>
          <CardTitle>{data?.title ?? "Страница"}</CardTitle>
        </CardHeader>
        <CardContent>
          {isInitialLoading ? (
            <div className="text-sm text-muted-foreground">Загрузка…</div>
          ) : data ? (
            <div className="border rounded-md p-3 overflow-auto">
              <div className="text-xs text-muted-foreground mb-2">
                Страница активна — кнопки внутри работают.
              </div>
              <div
                ref={previewRef}
                dangerouslySetInnerHTML={{ __html: data.content || "" }}
              />
            </div>
          ) : (
            <div className="text-sm text-muted-foreground">
              Страница не найдена
            </div>
          )}
        </CardContent>
        <CardFooter>
          <Button variant="secondary" onClick={() => navigate(-1 as any)}>
            Назад
          </Button>
        </CardFooter>
      </Card>
    </div>
  );
}

function PrescriptionRegisterPublicScreen() {
  const location = useLocation();
  const isDemo = location.pathname.startsWith("/demo/") || location.pathname === "/demo";
  if (!isDemo) {
    useAuth({ required: true });
  }
  const { data: me, isInitialLoading } = useQuery<Profile>(["me"], () =>
    apiClient.getMyProfile(),
  );

  const [from, setFrom] = useState("");
  const [to, setTo] = useState("");
  const [q, setQ] = useState("");
  const [page, setPage] = useState(1);

  const reportName = React.useMemo(() => {
    const base = "Реестр предписаний";
    if (from && to) return `${base} ${from}—${to}`;
    if (from) return `${base} с ${from}`;
    if (to) return `${base} по ${to}`;
    return base;
  }, [from, to]);

  const {
    data,
    isInitialLoading: isDataLoading,
    refetch,
  } = useQuery<PrescriptionPage>(
    ["prescriptions-public", from, to, q, page],
    () =>
      apiClient.listPrescriptionRegister({
        from: from || undefined,
        to: to || undefined,
        query: q || undefined,
        page,
        pageSize: 20,
      }),
    { keepPreviousData: true },
  );

  const confirmByAuthor = useMutation(apiClient.confirmViolationByAuthor, {
    onSuccess: () => {
      void refetch();
    },
  });
  const adminSetStatus = useMutation(apiClient.updateViolationAdmin, {
    onSuccess: () => {
      void refetch();
    },
  });
  const adminDeleteEntry = useMutation(
    apiClient.deletePrescriptionRegisterEntries,
    {
      onSuccess: async () => {
        await refetch();
      },
    },
  );
 
  const exportExcel = useMutation(apiClient.exportPrescriptionRegisterExcel, {
    onSuccess: (res: { url: string }) => {
      const sanitize = (s: string) =>
        (s || "")
          .replace(/[\\/:*?"<>|]+/g, " ")
          .replace(/\s+/g, " ")
          .trim()
          .slice(0, 120);
      const a = document.createElement("a");
      a.href = res.url;
      a.download = `${sanitize(reportName)}.xlsx`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    },
  });
  const exportWord = useMutation(apiClient.exportPrescriptionRegisterDocx, {
    onSuccess: (res: { url: string }) => {
      const sanitize = (s: string) =>
        (s || "")
          .replace(/[\\/:*?"<>|]+/g, " ")
          .replace(/\s+/g, " ")
          .trim()
          .slice(0, 120);
      const a = document.createElement("a");
      a.href = res.url;
      a.download = `${sanitize(reportName)}.docx`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    },
  });
  const isAdmin = !isDemo && !!me?.isAdmin;
 
   if (!isDemo && isInitialLoading) {
    return (
      <div className="max-w-6xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Загрузка…</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Проверяем статус доступа.
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }
   if (!isDemo && me && !(me as any).canAccessNow) {
    return <AccessRestrictionNotice blocked={(me as any).isBlocked ?? false} />;
  }

  return (
    <div className="w-full max-w-[120rem] mx-auto px-4 sm:px-6 space-y-4">
      <Card className="card-elevated h-full">
        <CardHeader className="space-y-3">
          <CardTitle>Реестр предписаний</CardTitle>
          <div className="flex flex-wrap gap-2 w-full">
            <Input
              type="date"
              value={from}
              onChange={(e) => {
                setFrom(e.target.value);
                setPage(1);
              }}
            />
            <Input
              type="date"
              value={to}
              onChange={(e) => {
                setTo(e.target.value);
                setPage(1);
              }}
            />
            <Input
              placeholder="Поиск по номеру, месту, объекту, ответственному"
              value={q}
              onChange={(e) => {
                setQ(e.target.value);
                setPage(1);
              }}
            />
            <Button
              className="btn-rect rounded-none"
              variant="secondary"
              onClick={() => refetch()}
            >
              Обновить
            </Button>
            <div className="mt-2 sm:mt-0 inline-block p-3 border rounded">
              <div className="text-xs text-muted-foreground">Наблюдений</div>
              <div className="text-2xl font-semibold">
                {isDataLoading ? "…" : (data?.total ?? 0)}
              </div>
            </div>
            <div className="w-full sm:w-auto sm:ml-auto flex flex-col gap-2 sm:max-w-xs">
              <div className="text-xs text-muted-foreground">
                Название отчёта
              </div>
              <Input value={reportName} readOnly />
              <div className="flex flex-col sm:flex-row gap-2">
                {isAdmin && (
                  <div className="flex flex-col sm:flex-row gap-2">
                    <Button
                      variant="secondary"
                      onClick={() =>
                        exportExcel.mutate({
                          from: from || undefined,
                          to: to || undefined,
                          query: q || undefined,
                        })
                      }
                    >
                      Скачать Excel
                    </Button>
                    <Button
                      variant="secondary"
                      onClick={() =>
                        exportWord.mutate({
                          from: from || undefined,
                          to: to || undefined,
                          query: q || undefined,
                        })
                      }
                    >
                      Скачать Word
                    </Button>
                  </div>
                )}
              </div>
              <div className="text-xs text-muted-foreground">
                Файл сохранится с именем выше; браузер предложит место
                сохранения.
              </div>
            </div>
          </div>
        </CardHeader>
        <CardContent className="space-y-3">
          <div className="border rounded-md overflow-x-auto">
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>Создано</TableHead>
                  <TableHead>№</TableHead>
                  <TableHead>Дата</TableHead>
                  <TableHead>Где</TableHead>
                  <TableHead>Объект</TableHead>
                  <TableHead>Ответственный</TableHead>
                  <TableHead>Срок</TableHead>
                  <TableHead>Статус</TableHead>
                  <TableHead>Документ</TableHead>
                  <TableHead>Действия</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {isDataLoading && (
                  <TableRow>
                    <TableCell
                      colSpan={10}
                      className="text-sm text-muted-foreground"
                    >
                      Загрузка…
                    </TableCell>
                  </TableRow>
                )}
                {!isDataLoading &&
                  (!data?.items || data.items.length === 0) && (
                    <TableRow>
                      <TableCell
                        colSpan={10}
                        className="text-sm text-muted-foreground"
                      >
                        Нет данных
                      </TableCell>
                    </TableRow>
                  )}
                {data?.items?.map((r: any) => (
                  <TableRow key={r.id}>
                    <TableCell className="align-top">
                      {r.violation?.authorConfirmed && (
                        <ShieldCheck
                          className="inline-block h-4 w-4 text-green-600 mr-1"
                          aria-label="Подтверждено автором"
                        />
                      )}
                      <span
                        className={"indicator-dot " + ((r.violation?.status || "").toLowerCase().includes("устран") ? "indicator-green" : (r.violation?.status || "").toLowerCase().includes("просроч") ? "indicator-blink-red" : r.violation?.dueDate && new Date(r.violation.dueDate).getTime() < Date.now() ? "indicator-blink-red" : "indicator-red")}
                        title={
                          (r.violation?.status || "")
                            .toLowerCase()
                            .includes("устран")
                            ? "Устранено"
                            : r.violation?.dueDate &&
                                new Date(r.violation.dueDate).getTime() <
                                  Date.now()
                              ? "Просрочено"
                              : "В работе"
                        }
                      />{" "}
                      {new Date(r.createdAt).toLocaleString("ru-RU")}
                    </TableCell>
                    <TableCell>{r.violation?.code || "—"}</TableCell>
                    <TableCell>
                      {r.violation?.date
                        ? new Date(r.violation.date).toISOString().slice(0, 10)
                        : "—"}
                    </TableCell>
                    <TableCell className="truncate max-w-[220px]">
                      {r.violation
                        ? `${r.violation.shop}/${r.violation.section}`
                        : "—"}
                    </TableCell>
                    <TableCell className="truncate max-w-[240px]">
                      {r.violation?.objectInspected || "—"}
                    </TableCell>
                    <TableCell className="truncate max-w-[220px]">
                      {r.violation?.responsibleName || "—"}
                    </TableCell>
                    <TableCell>
                      {r.violation?.dueDate
                        ? new Date(r.violation.dueDate)
                            .toISOString()
                            .slice(0, 10)
                        : "—"}
                    </TableCell>
                    <TableCell>{r.violation?.status || "—"}</TableCell>
                    <TableCell>
                      {r.docUrl ? (
                        <a
                          href={r.docUrl}
                          target="_blank"
                          rel="noreferrer"
                          className="text-primary hover:underline"
                        >
                          Открыть
                        </a>
                      ) : (
                        <span className="text-muted-foreground">—</span>
                      )}
                    </TableCell>
                    <TableCell>
                      {!isDemo && isAdmin && r.violation?.id ? (
                        <div className="flex flex-col gap-1">
                          <div className="flex flex-wrap gap-2 items-center">
                            <DropdownMenu>
                              <DropdownMenuTrigger asChild>
                                <Button size="sm" variant="secondary">
                                  Статус
                                </Button>
                              </DropdownMenuTrigger>
                              <DropdownMenuContent align="end">
                                {[
                                  "Устранено",
                                  "В работе",
                                  "Просрочено",
                                ].map((label) => (
                                  <DropdownMenuItem
                                    key={label}
                                    onClick={() =>
                                      adminSetStatus.mutate({
                                        id: r.violation!.id as string,
                                        status: label,
                                      })
                                    }
                                  >
                                    {label}
                                  </DropdownMenuItem>
                                ))}
                              </DropdownMenuContent>
                            </DropdownMenu>
                            <Button
                              size="sm"
                              variant="destructive"
                              disabled={adminDeleteEntry.isLoading}
                              onClick={async () => {
                                if (
                                  !confirm(
                                    "Удалить предписание из реестра? Это действие необратимо.",
                                  )
                                ) {
                                  return;
                                }
                                await adminDeleteEntry.mutateAsync({
                                  ids: [r.id as string],
                                });
                              }}
                            >
                              Удалить
                            </Button>
                          </div>
                           {!isDemo && me?.id &&
                             me.id === (r.violation.authorId as string) &&
                              !r.violation.authorConfirmed && (
                               <Button                                size="sm"
                                className="btn-rect rounded-none"
                                disabled={confirmByAuthor.isLoading}
                                onClick={() =>
                                  confirmByAuthor.mutate({
                                    violationId: r.violation!.id as string,
                                  })
                                }
                              >
                                Подтверждаю
                              </Button>
                            )}
                        </div>
                      ) : me?.id &&
                        r.violation?.id &&
                        me.id === (r.violation.authorId as string) &&
                        !r.violation.authorConfirmed ? (
                        <Button
                          size="sm"
                          className="btn-rect rounded-none"
                          disabled={confirmByAuthor.isLoading}
                          onClick={() =>
                            confirmByAuthor.mutate({
                              violationId: r.violation!.id as string,
                            })
                          }
                        >
                          Подтверждаю
                        </Button>
                      ) : (
                        <span className="text-muted-foreground">—</span>
                      )}
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          </div>
          <div className="flex justify-between items-center text-sm text-muted-foreground">
            <div>Стр. {data?.page ?? page}</div>
            <div className="flex gap-2">
              <Button
                variant="secondary"
                disabled={(data?.page ?? 1) <= 1}
                onClick={() => setPage((p) => Math.max(1, p - 1))}
              >
                Назад
              </Button>
              <Button
                variant="secondary"
                disabled={!!data && data.page * data.pageSize >= data.total}
                onClick={() => setPage((p) => p + 1)}
              >
                Вперёд
              </Button>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}

function EditableKbtMeetingRow({
  meeting,
  onSaved,
}: {
  meeting: {
    id: string;
    title: string;
    date: string | Date;
    type?: "PLAN" | "INCIDENT";
  };
  onSaved: () => void;
}) {
  const [editing, setEditing] = useState(false);
  const [title, setTitle] = useState<string>(meeting.title);
  const [date, setDate] = useState<string>(
    new Date(meeting.date as any).toISOString().slice(0, 10),
  );
  const [type, setType] = useState<"PLAN" | "INCIDENT">(
    (meeting.type as any) === "INCIDENT" ? "INCIDENT" : "PLAN",
  );
  const { toast } = useToast();
  const queryClient = useQueryClient();
  const update = useMutation(apiClient.updateKbtMeeting, {
    onSuccess: async () => {
      toast({ title: "Сохранено" });
      setEditing(false);
      await queryClient.invalidateQueries({ queryKey: ["kbt-meetings"] });
      onSaved();
    },
    onError: () => toast({ title: "Не удалось сохранить" }),
  });

  return (
    <TableRow>
      <TableCell className="min-w-[260px]">
        {editing ? (
          <div className="flex flex-col gap-2">
            <Input value={title} onChange={(e) => setTitle(e.target.value)} />
            <div className="text-xs text-muted-foreground">
              Тип: {type === "PLAN" ? "План" : "Разбор"}
            </div>
          </div>
        ) : (
          `${title}`
        )}
      </TableCell>
      <TableCell className="min-w-[160px]">
        {editing ? (
          <Input
            type="date"
            value={date}
            onChange={(e) => setDate(e.target.value)}
          />
        ) : (
          new Date(date).toLocaleDateString("ru-RU")
        )}
      </TableCell>
      <TableCell className="flex gap-2">
        {editing ? (
          <>
            <Button
              size="sm"
              variant="secondary"
              onClick={() =>
                update.mutate({ id: meeting.id, title, date, type })
              }
              disabled={update.isLoading}
            >
              Сохранить
            </Button>
            <Button
              size="sm"
              variant="ghost"
              onClick={() => {
                setEditing(false);
                setTitle(meeting.title);
                setDate(
                  new Date(meeting.date as any).toISOString().slice(0, 10),
                );
              }}
            >
              Отмена
            </Button>
          </>
        ) : (
          <>
            <div className="flex items-center gap-2">
              <select
                className="h-9 border rounded px-2 bg-background"
                value={type}
                onChange={(e) => setType(e.target.value as any)}
                disabled={!editing}
                title="Тип встречи"
              >
                <option value="PLAN">План</option>
                <option value="INCIDENT">Разбор</option>
              </select>
              <Button
                size="sm"
                variant="secondary"
                onClick={() => setEditing(true)}
              >
                Изменить
              </Button>
            </div>
            <DeleteKbtMeetingButton id={meeting.id} />
          </>
        )}
      </TableCell>
    </TableRow>
  );
}

// Configure pdfjs worker (recommended setup)
try {
  // @ts-ignore - version is provided by the library at runtime
  (pdfjsLib as any).GlobalWorkerOptions.workerSrc = `https://unpkg.com/pdfjs-dist@${(pdfjsLib as any).version}/build/pdf.worker.min.js`;
} catch {
  /* ignore */
}

function AdminPabInstructionScreen() {
  useAuth({ required: true });
  const { data: me, isInitialLoading } = useQuery<Profile>(["me"], () =>
    apiClient.getMyProfile(),
  );
  const { toast } = useToast();
  const navigate = useNavigate();

  const { data: page } = useQuery(["pab-instruction-admin"], () =>
    apiClient.getSimplePageBySlug({ slug: "pab-instruction" }),
  );

  const [title, setTitle] = useState<string>("");
  const [content, setContent] = useState<string>("");
  const contentRef = useRef<HTMLTextAreaElement | null>(null);
  // Куда вставлять вложения: в начало, по курсору, в конец
  const [insertPos, setInsertPos] = useState<"start" | "cursor" | "end">(
    "cursor",
  );

  useEffect(() => {
    if (page) {
      setTitle((page as any)?.title || "Инструкция по ПАБ");
      setContent((page as any)?.content || "");
    }
  }, [page]);

  const save = useMutation(apiClient.upsertSimplePage, {
    onSuccess: async () => {
      toast({ title: "Сохранено" });
      try {
        if (fileInputRef.current) fileInputRef.current.value = "";
      } catch {
        /* ignore */
      }
    },
    onError: () => toast({ title: "Не удалось сохранить" }),
  });

  const fileInputRef = useRef<HTMLInputElement | null>(null);
  const uploadAttachment = useMutation(apiClient.uploadInstructionAttachment, {
    onSuccess: (res: { ok: boolean; url: string; name: string }) => {
      if (!res?.url) return;
      const url = res.url;
      const name = res.name || "file";
      const lower = name.toLowerCase();
      const isImage = /\.(png|jpe?g|gif|webp|svg)$/.test(lower);
      const md = isImage ? `![${name}](${url})` : `[${name}](${url})`;
      const ta = contentRef.current;
      if (ta) {
        const start = ta.selectionStart ?? content.length;
        const end = ta.selectionEnd ?? content.length;
        const next = content.slice(0, start) + md + content.slice(end);
        setContent(next);
        // place caret after inserted text
        setTimeout(() => {
          try {
            ta.focus();
            const pos = start + md.length;
            ta.setSelectionRange(pos, pos);
          } catch {
            /* ignore */
          }
        }, 0);
      } else {
        setContent((prev) => (prev ? prev + "\n" + md : md));
      }
      toast({ title: "Файл прикреплён" });
    },
    onError: (e: any) => {
      const msg = String(e?.message || e || "");
      if (msg.includes("FILE_TOO_LARGE"))
        toast({
          title: "Файл слишком большой",
          description: "Максимум 100 МБ",
        });
      else toast({ title: "Не удалось прикрепить файл" });
    },
  });

  // Вставка markdown по выбранной позиции
  const insertMarkdownAtPosition = (md: string) => {
    const ta = contentRef.current;
    const text = content;
    let start = 0;
    let end = 0;
    if (insertPos === "start") {
      start = 0;
      end = 0;
    } else if (insertPos === "end") {
      start = text.length;
      end = text.length;
    } else {
      // cursor
      if (ta) {
        start = ta.selectionStart ?? text.length;
        end = ta.selectionEnd ?? text.length;
      } else {
        start = text.length;
        end = text.length;
      }
    }

    const next = text.slice(0, start) + md + text.slice(end);
    setContent(next);
    // вернуть курсор за вставкой
    setTimeout(() => {
      try {
        if (contentRef.current) {
          contentRef.current.focus();
          const pos = start + md.length;
          contentRef.current.setSelectionRange(pos, pos);
        }
      } catch {
        /* ignore */
      }
    }, 0);
  };

  // Создание превью для PDF (первая страница) в виде data URL PNG
  const createPdfPreviewDataUrl = async (
    file: File,
  ): Promise<string | null> => {
    try {
      const arrayBuf = await file.arrayBuffer();
      const pdf = await (pdfjsLib as any).getDocument({ data: arrayBuf })
        .promise;
      const page = await pdf.getPage(1);
      const viewport = page.getViewport({ scale: 1.5 });
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");
      if (!ctx) return null;
      canvas.width = viewport.width;
      canvas.height = viewport.height;
      const renderContext = { canvasContext: ctx, viewport } as any;
      await page.render(renderContext).promise;
      const dataUrl = canvas.toDataURL("image/png");
      return dataUrl;
    } catch {
      console.error("PDF preview failed");
      return null;
    }
  };

  const handleFile = async (file?: File) => {
    if (!file) return;
    const MAX_MB = 100;
    if (file.size > MAX_MB * 1024 * 1024) {
      toast({
        title: "Файл слишком большой",
        description: `Максимум ${MAX_MB} МБ`,
      });
      return;
    }

    const isPdf = /\.pdf$/i.test(file.name) || file.type === "application/pdf";

     if (isPdf) {      // 1) Получаем превью как PNG data URL
      const previewDataUrl = await createPdfPreviewDataUrl(file);
      // 2) Загружаем сам PDF, чтобы получить ссылку
      const base64Pdf = await encodeFileAsBase64DataURL(file);
      if (!base64Pdf) {
        toast({ title: "Не удалось прочитать PDF" });
        return;
      }
      // Сначала загрузим PDF
      let pdfUrl = "";
      try {
        const res = await uploadAttachment.mutateAsync({
          base64: base64Pdf,
          name: file.name,
        });
        // mutateAsync не возвращает значение типизировано; полагаться на onSuccess нельзя здесь, поэтому параллельно получаем url из апдейта через рез-т
        // Но поскольку наш uploadInstructionAttachment возвращает { ok, url, name }, рез будет этим объектом
        // @ts-ignore
        pdfUrl = res?.url || "";
      } catch {
        toast({ title: "Не удалось загрузить PDF" });
        return;
      }

      // 3) Если есть превью — загрузим его и вставим как картинку, обёрнутую ссылкой на PDF
      if (previewDataUrl) {
        try {
          const previewName = file.name.replace(/\.pdf$/i, "_preview.png");
          // @ts-ignore
          const resPrev = await uploadAttachment.mutateAsync({
            base64: previewDataUrl,
            name: previewName,
          });
          // @ts-ignore
          const previewUrl = resPrev?.url || "";
          const md = `[![${file.name}](${previewUrl})](${pdfUrl})`;
          insertMarkdownAtPosition(md);
          toast({ title: "Превью PDF добавлено" });
          return;
        } catch {
          console.error("Upload preview failed");
          // fallback ниже
        }
      }
      // Фолбэк: вставим хотя бы ссылку-изображение напрямую (отображение может зависеть от браузера)
      const mdFallback = `![${file.name}](${pdfUrl})`;
      insertMarkdownAtPosition(mdFallback);
      toast({ title: "PDF добавлен" });
      return;
    }

    if (isExcel) {
      try {
        const arrayBuffer = await file.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: "array" });
        const firstSheetName = workbook.SheetNames[0];
        const firstSheet = workbook.Sheets[firstSheetName];
        const html = XLSX.utils.sheet_to_html(firstSheet, {
          id: "pab-excel-table",
          editable: false,
        });
        setContent(html);
        toast({ title: "Excel преобразован в HTML" });
      } catch (e) {
        console.error("Excel to HTML failed", e);
        toast({ title: "Не удалось преобразовать Excel в HTML" });
      }
      return;
    }

    // Изображения: загружаем и вставляем markdown-картинку
    const base64 = await encodeFileAsBase64DataURL(file);
    if (!base64) {
      toast({ title: "Не удалось прочитать файл" });
      return;
    }
    try {
      // @ts-ignore
      const res = await uploadAttachment.mutateAsync({
        base64,
        name: file.name,
      });
      // @ts-ignore
      const url = res?.url || "";
      const md = `![${file.name}](${url})`;
      insertMarkdownAtPosition(md);
      toast({ title: "Изображение добавлено" });
    } catch {
      toast({ title: "Не удалось загрузить изображение" });
    }
  };

  if (isInitialLoading) {
    return (
      <div className="max-w-4xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Загрузка…</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">Проверяем доступ…</div>
          </CardContent>
        </Card>
      </div>
    );
  }

  if (!me?.isAdmin) {
    return (
      <div className="max-w-4xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Доступ ограничен</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Раздел доступен только администраторам.
            </div>
          </CardContent>
          <CardFooter>
            <Button variant="secondary" onClick={() => navigate("/admin")}>
              К админ-панели
            </Button>
          </CardFooter>
        </Card>
      </div>
    );
  }

  return (
    <div className="max-w-4xl mx-auto p-4 sm:p-6">
      <Card className="card-elevated h-full">
        <CardHeader>
          <CardTitle>ПАБ — админ‑страница HTML</CardTitle>
        </CardHeader>
        <CardContent className="space-y-3">
          <div className="grid gap-1">
            <Label>Название страницы (для админов)</Label>
            <Input value={title} onChange={(e) => setTitle(e.target.value)} />
          </div>
          <div className="grid gap-1">
            <Label>HTML‑код формы ПАБ</Label>
            <Textarea
              ref={contentRef}
              rows={18}
              value={content}
              onChange={(e) => setContent(e.target.value)}
              placeholder="Вставьте сюда HTML‑код формы ПАБ без &lt;html&gt;, &lt;head&gt;, &lt;body&gt;."
            />
            <div className="text-xs text-muted-foreground space-y-1">
              <p>
                Здесь хранится HTML‑код, который будет показан пользователям на
                странице ПАБ. Внутренние кнопки и скрипты будут работать без
                перезагрузки страницы.
              </p>
              <p>
                Не вставляйте теги &lt;html&gt;, &lt;head&gt;, &lt;body&gt; — только
                содержимое формы.
              </p>
            </div>
          </div>          <div className="grid gap-1">
            <Label>Прикрепить файл (PDF/изображение/Excel)</Label>
            <div className="flex flex-col sm:flex-row gap-2 sm:items-center">
              <Input
                ref={fileInputRef}
                type="file"
                 accept="image/*,application/pdf,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel"                onChange={(e) => handleFile(e.target.files?.[0] || undefined)}
              />
              <div className="flex items-center gap-2 text-xs text-muted-foreground">
                <Label className="whitespace-nowrap">Вставлять</Label>
                <select
                  className="h-8 border rounded px-2 bg-background"
                  value={insertPos}
                  onChange={(e) => setInsertPos(e.target.value as any)}
                >
                  <option value="cursor">По курсору</option>
                  <option value="start">В начало</option>
                  <option value="end">В конец</option>
                </select>
              </div>
            </div>
          </div>
        </CardContent>
        <CardFooter className="flex gap-2">
          <Button
            className="btn-3d"
            onClick={() =>
              save.mutate({ slug: "pab", title, content })
            }
          >
            Сохранить HTML
          </Button>          <Button
            variant="outline"
            disabled={save.isLoading}
            onClick={async () => {
              try {
                await save.mutateAsync({
                  slug: "pab",
                  title,
                  content,
                });
                navigate("/p/pab");
              } catch {
                /* ignore */
              }
            }}
          >
            Сохранить и просмотреть ПАБ
          </Button>
          <Button variant="secondary" onClick={() => navigate("/admin")}>
            К админ-панели
          </Button>
        </CardFooter>
      </Card>
    </div>
  );
}

// Early global error handling to suppress known benign browser/library errors before React mounts
if (typeof window !== "undefined") {
  // avoid duplicate installs across HMR or multiple imports
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  const g = window as any;
  if (!g.__earlyErrorHandlersInstalled) {
    const __shouldIgnoreGlobalError = (text?: string) =>
      typeof text === "string" &&
      (text === "[object Event]" ||
        text.trim() === "" ||
        text.includes("ResizeObserver loop completed") ||
        text.includes("ResizeObserver loop limit exceeded") ||
        text.includes(
          "ResizeObserver loop completed with undelivered notifications",
        ) ||
        text.includes(
          "Cannot use 'in' operator to search for 'result' in null",
        ) ||
        text.includes("Failed to fetch"));

    try {
      const stopAll = (e: any) => {
        try {
          e.preventDefault?.();
          e.stopPropagation?.();
          e.stopImmediatePropagation?.();
        } catch {}
      };

      const isResourceError = (e: any) =>
        !!(
          e?.target &&
          typeof e.target === "object" &&
          (["IMG", "SCRIPT", "LINK"] as const).includes(
            (e.target as any).tagName,
          )
        );

      const onGlobalWinError = (e: any) => {
        const msg: string = e?.message || e?.error?.message || "";
        const isBareEvent = !msg && !e?.error;
        if (
          isBareEvent ||
          isResourceError(e) ||
          __shouldIgnoreGlobalError(msg)
        ) {
          stopAll(e);
        }
      };

      const onGlobalRejection = (event: PromiseRejectionEvent) => {
        const reason: any = (event as any)?.reason;
        const msg =
          typeof reason?.message === "string"
            ? reason.message
            : String(reason || "");
        if (__shouldIgnoreGlobalError(msg)) {
          stopAll(event);
        }
      };

      // Capture-phase handler to catch early
      window.addEventListener("error", onGlobalWinError as EventListener, {
        capture: true,
      });
      // Bubble-phase handler to catch uncancelable resource errors
      window.addEventListener("error", onGlobalWinError as EventListener);
      window.addEventListener("unhandledrejection", onGlobalRejection);

      g.__earlyErrorHandlersInstalled = true;
    } catch {
      /* ignore */
    }
  }
}

function QueryProviderWithPersistence({
  children,
}: {
  children: React.ReactNode;
}) {
  const [queryClient] = useState(
    () =>
      new QueryClient({
        defaultOptions: {
          queries: {
            staleTime: 1000 * 60 * 60,
            cacheTime: 1000 * 60 * 60 * 24 * 7,
            retry: 1,
            refetchOnWindowFocus: false,
            refetchOnReconnect: true,
          },
          mutations: {
            retry: 1,
          },
        },
      }),
  );

  const [hydrationState, setHydrationState] = useState<
    DehydratedState | undefined
  >(undefined);

  const detectLowNetworkQuality = useCallback(() => {
    try {
      const nav: any = navigator as any;
      const c = nav?.connection || nav?.mozConnection || nav?.webkitConnection;
      const saveData = !!c?.saveData;
      const et = c?.effectiveType || "";
      const down = typeof c?.downlink === "number" ? c.downlink : 10;
      return saveData || et === "slow-2g" || et === "2g" || down < 1.5;
    } catch {
      return false;
    }
  }, []);

  const [turboMode, setTurboMode] = useState<boolean>(
    detectLowNetworkQuality(),
  );

  useEffect(() => {
    const nav: any = navigator as any;
    const c = nav?.connection || nav?.mozConnection || nav?.webkitConnection;
    if (!c) return;
    const handler = () => setTurboMode(detectLowNetworkQuality());
    c.addEventListener?.("change", handler);
    return () => c.removeEventListener?.("change", handler);
  }, [detectLowNetworkQuality]);

  // Persisted cache hydration
  useEffect(() => {
    (async () => {
      try {
        const raw = await localforage.getItem<string>("rq.cache.v1");
        if (raw) {
          const parsed = JSON.parse(raw) as DehydratedState;
          setHydrationState(parsed);
        }
      } catch {
        // ignore
      }
    })();
  }, []);

  // Persist cache on changes (debounced)
  useEffect(() => {
    let scheduled = false;
    let timer: any;

    const scheduleSave = () => {
      if (scheduled) return;
      scheduled = true;
      timer = setTimeout(() => {
        void (async () => {
          try {
            const state = dehydrate(queryClient);
            await localforage.setItem("rq.cache.v1", JSON.stringify(state));
          } catch {
            // ignore
          } finally {
            scheduled = false;
          }
        })();
      }, 500);
    };

    const unsubQ = queryClient.getQueryCache().subscribe(scheduleSave);
    const unsubM = queryClient.getMutationCache().subscribe(scheduleSave);

    return () => {
      unsubQ();
      unsubM();
      if (timer) clearTimeout(timer);
    };
  }, [queryClient]);

  // Dynamically relax network behavior for poor connections (Turbo‑режим)
  useEffect(() => {
    const baseQueries = {
      staleTime: 1000 * 60 * 60,
      cacheTime: 1000 * 60 * 60 * 24 * 7,
      retry: 1,
      refetchOnWindowFocus: false,
      refetchOnReconnect: true,
    } as const;

    const turboQueries = {
      staleTime: 1000 * 60 * 60 * 12,
      cacheTime: 1000 * 60 * 60 * 24 * 14,
      retry: 0,
      refetchOnWindowFocus: false,
      refetchOnReconnect: false,
      refetchOnMount: false as const,
      keepPreviousData: true as const,
      networkMode: "offlineFirst" as any,
    };

    queryClient.setDefaultOptions({
      queries: (turboMode ? turboQueries : baseQueries) as any,
      mutations: {
        retry: turboMode ? 0 : 1,
        networkMode: (turboMode ? "offlineFirst" : "online") as any,
      },
    });
  }, [turboMode, queryClient]);

  return (
    <QueryClientProvider client={queryClient}>
      <Hydrate state={hydrationState}>{children}</Hydrate>
    </QueryClientProvider>
  );
}

function UdUaReportScreen() {
  useAuth({ required: true });
  const { data: me, isInitialLoading } = useQuery<Profile>(["me"], () =>
    apiClient.getMyProfile(),
  );
  const navigate = useNavigate();
  const { toast } = useToast();
  const queryClient = useQueryClient();

  const { data: report, isInitialLoading: loading } = useQuery(
    ["ud-report"],
    () => apiClient.getUdReport(),
  );

  const [title, setTitle] = useState<string>("");
  const [colA, setColA] = useState<string>("");
  const [colB, setColB] = useState<string>("");
  const [rows, setRows] = useState<
    Array<
      | {
          __type: "row";
          id?: string;
          label: string;
          valueA?: string | null;
          valueB?: string | null;
          order: number;
          section?: string | null;
        }
      | { __type: "section"; label: string }
    >
  >([]);

  useEffect(() => {
    if (report) {
      setTitle((report as any).title || "Отчет для Управляющего Директора");
      setColA((report as any).columnA || "");
      setColB((report as any).columnB || "");
      const rws = ((report as any).rows || []) as Array<any>;
      const ui: Array<
        | { __type: "row"; id?: string; label: string; valueA?: string | null; valueB?: string | null; order: number; section?: string | null }
        | { __type: "section"; label: string }
      > = [];
      let lastSection: string | null = null;
      rws.forEach((r: any, idx: number) => {
        const s = (r.section ?? null) as string | null;
        if (s && s !== lastSection) {
          ui.push({ __type: "section", label: s });
          lastSection = s;
        }
        if (!s) {
          lastSection = null;
        }
        ui.push({
          __type: "row",
          id: r.id,
          label: r.label || "",
          valueA: r.valueA ?? "",
          valueB: r.valueB ?? "",
          order: typeof r.order === "number" ? r.order : idx,
          section: s,
        });
      });
      setRows(ui);
    }
  }, [report]);

  const addRow = () => {
    setRows((prev) => {
      const lastSection = [...prev]
        .reverse()
        .find((it) => (it as any).__type === "section") as any;
      const nextOrder = prev.filter((it) => (it as any).__type === "row").length;
      return [
        ...prev,
        {
          __type: "row" as const,
          label: "Новая строка",
          valueA: "",
          valueB: "",
          order: nextOrder,
          section: lastSection?.label ?? null,
        },
      ];
    });
  };
  const addSection = () => {
    setRows((prev) => [...prev, { __type: "section" as const, label: "Новая тема" }]);
  };
  const removeRow = (idx: number) => {
    setRows((prev) => prev.filter((_, i) => i !== idx));
  };
  const removeSection = (idx: number) => {
    setRows((prev) => {
      const a = [...prev];
      a.splice(idx, 1);
      for (let i = idx; i < a.length && (a[i] as any).__type !== "section"; i++) {
        const it = a[i] as any;
        if (it.__type === "row") a[i] = { ...it, section: null } as any;
      }
      return a;
    });
  };
  const moveRow = (idx: number, dir: -1 | 1) => {
    setRows((prev) => {
      if ((prev[idx] as any).__type !== "row") return prev;
      const a = [...prev];
      let j = idx + dir;
      while (j >= 0 && j < a.length && (a[j] as any).__type !== "row") {
        j += dir;
      }
      if (j < 0 || j >= a.length || (a[j] as any).__type !== "row") return prev;
      const t = a[idx];
      a[idx] = a[j]!;
      a[j] = t!;
      return a;
    });
  };

  const save = useMutation(apiClient.upsertUdReport, {
    onSuccess: async () => {
      toast({ title: "Сохранено" });
      await queryClient.invalidateQueries({ queryKey: ["ud-report"] });
    },
    onError: () => toast({ title: "Не удалось сохранить" }),
  });

  const exportUdExcel = useMutation(apiClient.exportUdReportExcel, {
    onSuccess: (res: { url: string }) => {
      if (!res?.url) return;
      const sanitize = (s: string) =>
        (s || "")
          .replace(/[\\/:*?"<>|]+/g, " ")
          .replace(/\s+/g, " ")
          .trim();
      const dateStr = new Date().toISOString().slice(0, 10);
      const base = sanitize(title || "Отчет для Управляющего Директора");
      const a = document.createElement("a");
      a.href = res.url;
      a.download = `${base || "Отчет для Управляющего Директора"}_${dateStr}.xlsx`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    },
    onError: () => toast({ title: "Не удалось выгрузить Excel" }),
  });

  if (isInitialLoading) {
    return (
      <div className="max-w-5xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Загрузка…</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">Проверяем доступ…</div>
          </CardContent>
        </Card>
      </div>
    );
  }
  if (!me?.isAdmin) {
    return (
      <div className="max-w-4xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Доступ ограничен</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Раздел доступен только администраторам.
            </div>
          </CardContent>
          <CardFooter>
            <Button variant="secondary" onClick={() => navigate("/admin")}>
              К админ‑панели
            </Button>
          </CardFooter>
        </Card>
      </div>
    );
  }

  return (
    <div className="w-full max-w-[120rem] mx-auto px-4 sm:px-6 space-y-4">
      <Card className="card-elevated h-full">
        <CardHeader className="space-y-2">
          {me?.isAdmin && (
            <div className="text-xs text-muted-foreground">
              Вы видите все инструменты настройки таблицы. Обычным пользователям
              доступна только кнопка «Отправить».
            </div>
          )}
          <CardTitle>Отчет для Управляющего Директора</CardTitle>
          <div className="grid md:grid-cols-3 gap-3">
            <div className="grid gap-1">
              <Label>Заголовок</Label>
              <Input value={title} onChange={(e) => setTitle(e.target.value)} />
            </div>
            <div className="grid gap-1">
              <Label>Колонка A (левый период)</Label>
              <Input value={colA} onChange={(e) => setColA(e.target.value)} />
            </div>
            <div className="grid gap-1">
              <Label>Колонка B (правый период)</Label>
              <Input value={colB} onChange={(e) => setColB(e.target.value)} />
            </div>
          </div>
          <div className="text-xs text-muted-foreground">
            Таблица редактируемая: изменяйте значения и нажмите «Сохранить».
          </div>
        </CardHeader>
        <CardContent className="space-y-3">
          {loading ? (
            <div className="text-sm text-muted-foreground">
              Загрузка отчета…
            </div>
          ) : (
            <div className="border rounded-md overflow-x-auto">
              <Table>
                <TableHeader>
                  <TableRow>
                    <TableHead className="min-w-[360px]">Показатель</TableHead>
                    <TableHead className="min-w-[180px]">
                      {colA || "Колонка A"}
                    </TableHead>
                    <TableHead className="min-w-[180px]">
                      {colB || "Колонка B"}
                    </TableHead>
                    <TableHead className="w-[160px]">Действия</TableHead>
                  </TableRow>
                </TableHeader>
                <TableBody>
                  {rows.length === 0 && (
                    <TableRow>
                      <TableCell
                        colSpan={4}
                        className="text-sm text-muted-foreground"
                      >
                        Нет строк. Нажмите «Добавить строку».
                      </TableCell>
                    </TableRow>
                  )}
                  {rows.map((r, idx) => {
                    if ((r as any).__type === "section") {
                      const section = r as { __type: "section"; label: string };
                      return (
                        <TableRow
                          key={`section-${idx}`}
                          className="bg-primary text-primary-foreground hover:bg-primary"
                        >
                          <TableCell colSpan={4} className="align-top">
                            <div className="flex items-center gap-2">
                              <Input
                                className="bg-primary text-primary-foreground placeholder:text-primary-foreground/80"
                                value={section.label}
                                onChange={(e) =>
                                  setRows((prev) => {
                                    const a = [...prev];
                                    a[idx] = { __type: "section", label: e.target.value } as any;
                                    for (
                                      let j = idx + 1;
                                      j < a.length && (a[j] as any).__type !== "section";
                                      j++
                                    ) {
                                      const it = a[j] as any;
                                      if (it.__type === "row") {
                                        a[j] = { ...it, section: e.target.value } as any;
                                      }
                                    }
                                    return a;
                                  })
                                }
                                placeholder="Название темы"
                              />
                              <Button size="sm" variant="destructive" onClick={() => removeSection(idx)}>
                                Удалить тему
                              </Button>
                            </div>
                          </TableCell>
                        </TableRow>
                      );
                    }
                    const row = r as {
                      __type: "row";
                      id?: string;
                      label: string;
                      valueA?: string | null;
                      valueB?: string | null;
                      section?: string | null;
                    };
                    return (
                      <TableRow key={(row.id || "new") + idx}>
                        <TableCell className="align-top">
                          <div className="grid gap-1">
                            {row.section && (
                              <div className="text-[11px] text-muted-foreground uppercase">
                                {row.section}
                              </div>
                            )}
                            <Input
                              value={row.label}
                              onChange={(e) =>
                                setRows((prev) => {
                                  const a = [...prev];
                                  a[idx] = { ...(a[idx] as any), label: e.target.value } as any;
                                  return a;
                                })
                              }
                            />
                          </div>
                        </TableCell>
                        <TableCell className="align-top">
                          <Input
                            value={row.valueA ?? ""}
                            onChange={(e) =>
                              setRows((prev) => {
                                const a = [...prev];
                                a[idx] = { ...(a[idx] as any), valueA: e.target.value } as any;
                                return a;
                              })
                            }
                          />
                        </TableCell>
                        <TableCell className="align-top">
                          <Input
                            value={row.valueB ?? ""}
                            onChange={(e) =>
                              setRows((prev) => {
                                const a = [...prev];
                                a[idx] = { ...(a[idx] as any), valueB: e.target.value } as any;
                                return a;
                              })
                            }
                          />
                        </TableCell>
                        <TableCell className="align-top">
                          <div className="flex gap-2">
                            <Button
                              size="sm"
                              variant="secondary"
                              onClick={() => moveRow(idx, -1)}
                              disabled={idx === 0}
                            >
                              ↑
                            </Button>
                            <Button
                              size="sm"
                              variant="secondary"
                              onClick={() => moveRow(idx, 1)}
                              disabled={idx === rows.length - 1}
                            >
                              ↓
                            </Button>
                            <Button
                              size="sm"
                              variant="destructive"
                              onClick={() => removeRow(idx)}
                            >
                              Удалить
                            </Button>
                          </div>
                        </TableCell>
                      </TableRow>
                    );
                  })}
                </TableBody>
              </Table>
            </div>
          )}
        </CardContent>
        <CardFooter className="flex flex-wrap gap-2">
          <Button variant="secondary" onClick={addSection}>
            Добавить тему
          </Button>
          <Button variant="secondary" onClick={addRow}>
            Добавить строку
          </Button>
          <Button
            className="btn-3d"
            disabled={save.isLoading}
            onClick={() => {
              let currentSection: string | null = null;
              const normalized = rows
                .flatMap((it) => {
                  if ((it as any).__type === "section") {
                    currentSection = (it as any).label as string;
                    return [] as any[];
                  }
                  const r = it as any;
                  return [
                    {
                      id: r.id,
                      label: r.label,
                      valueA: r.valueA ?? null,
                      valueB: r.valueB ?? null,
                      order: 0,
                      section: currentSection,
                    },
                  ];
                })
                .map((r, i) => ({ ...r, order: i }));
              save.mutate({
                title,
                columnA: colA,
                columnB: colB,
                rows: normalized,
              });
            }}
          >
            {save.isLoading ? "Сохраняем…" : "Сохранить"}
          </Button>
          <Button
            variant="secondary"
            disabled={exportUdExcel.isLoading}
            onClick={() => exportUdExcel.mutate()}
          >
            {exportUdExcel.isLoading ? "Готовим…" : "Скачать в Excel"}
          </Button>
          <Button variant="ghost" onClick={() => navigate("/admin")}>
            К админ‑панели
          </Button>
        </CardFooter>
      </Card>
    </div>
  );
}

function AdminPCScreen() {
  const auth = useAuth({ required: true });
  const { data: me } = useQuery<Profile>(
    ["me"],
    () => apiClient.getMyProfile(),
    { enabled: auth.status === "authenticated", staleTime: 10_000 },
  );
  const isAdmin = !!me?.isAdmin;

  if (!isAdmin) {
    return (
      <div className="max-w-4xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Доступ ограничен</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Эта страница доступна только администраторам.
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  const containerRef = useRef<HTMLDivElement | null>(null);

  const [reserved, setReserved] = useState<{
    short: string;
    code: string;
  } | null>(null);
  const now = new Date();
  const yearSuffix = String(now.getFullYear()).slice(2);
  const tzOffsetMs = now.getTimezoneOffset() * 60000;
  const todayISO = new Date(now.getTime() - tzOffsetMs)
    .toISOString()
    .slice(0, 10);

  const { data: preview } = useQuery(
    ["pc-preview", todayISO],
    () => apiClient.previewNextProdControlActNumber({ date: todayISO }),
    { enabled: auth.status === "authenticated", staleTime: 10_000 },
  );

  const reserveMutation = useMutation(apiClient.reserveProdControlActNumber, {
    onSuccess: (r) => setReserved({ short: r.short, code: r.code }),
  });

  async function ensureReserved() {
    if (!reserved) {
      try {
        const r = await reserveMutation.mutateAsync({ date: todayISO });
        setReserved({ short: r.short, code: r.code });
      } catch (e) {
        /* ignore */
      }
    }
  }

  // Нумерация теперь формируется на сервере; предварительный номер берём через previewNextProdControlActNumber

  const styleString = `
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Times New Roman', Times, serif; }
        body { padding: 20px; background-color: #f5f5f5; color: #000; line-height: 1.5; font-size: 14px; }
        .container { max-width: 900px; margin: 0 auto; background-color: white; padding: 30px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 20px; padding-bottom: 15px; }
        .header h1 { font-size: 16px; font-weight: bold; margin-bottom: 5px; text-transform: uppercase; }
        .header p { font-size: 14px; margin-bottom: 5px; }
        .document-info { margin-bottom: 20px; }
        .document-info p { margin-bottom: 10px; font-size: 14px; }
        .underline { border-bottom: 1px solid #000; display: inline-block; min-width: 150px; padding: 0 5px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #000; padding: 8px; vertical-align: top; font-size: 14px; }
        th { background-color: #f0f0f0; font-weight: bold; text-align: center; }
        .signatures { margin-top: 40px; }
        .signature-line { margin-top: 20px; }
        .signature-line-inner { border-top: 1px solid #000; padding-top: 5px; display: flex; justify-content: space-between; }
        .signature { width: 30%; text-align: center; }
        textarea { width: 100%; min-height: 80px; resize: vertical; border: none; padding: 5px; font-size: 14px; font-family: inherit; }
        input[type="text"] { width: 100%; padding: 5px; border: none; border-bottom: 1px solid #000; font-size: 14px; font-family: inherit; background: transparent; }
        .actions { display: flex; justify-content: space-between; margin-top: 20px; gap: 10px; }
        button.doc-btn { padding: 8px 15px; background-color: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        button.doc-btn:hover { background-color: #34495e; }
        .photo-container { position: relative; display: inline-block; margin: 5px; }
        .photo-container img { max-width: 150px; max-height: 150px; border: 1px solid #ccc; }
        .delete-photo { position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; width: 20px; height: 20px; text-align: center; line-height: 20px; cursor: pointer; font-size: 12px; }
        .photo-upload { margin-top: 5px; }
        .table-controls { margin-bottom: 10px; display: flex; gap: 10px; }
        .delete-row-btn { background: #e74c3c; padding: 5px 10px; font-size: 12px; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
        @media print {
          body { background-color: white; padding: 0; }
          .container { box-shadow: none; padding: 0; }
          .actions, .table-controls, .photo-upload, .delete-photo, .delete-row-btn { display: none !important; }
        }
  `;

  const updateRowNumbers = () => {
    const root = containerRef.current;
    if (!root) return;
    const rows = root.querySelectorAll<HTMLTableRowElement>(
      "#violations-table tbody tr",
    );
    rows.forEach((row, idx) => {
      const cell = row.querySelector("td:first-child");
      if (cell) cell.textContent = `${idx + 1}.`;
    });
  };

  const addRow = () => {
    const root = containerRef.current;
    if (!root) return;
    const table = root.querySelector<HTMLTableElement>("#violations-table");
    if (!table) return;
    const tbody = table.querySelector("tbody");
    const firstRow = tbody?.querySelector("tr");
    if (!tbody || !firstRow) return;
    const newRow = firstRow.cloneNode(true) as HTMLTableRowElement;
    // clear
    newRow.querySelectorAll<HTMLTextAreaElement>("textarea").forEach((ta) => {
      ta.value = "";
      ta.style.height = "80px";
    });
    const photos = newRow.querySelector<HTMLElement>(".photos-container");
    if (photos) photos.innerHTML = "";
    tbody.appendChild(newRow);
    updateRowNumbers();
  };

  const deleteLastRow = () => {
    const root = containerRef.current;
    if (!root) return;
    const table = root.querySelector<HTMLTableElement>("#violations-table");
    const tbody = table?.querySelector("tbody");
    const rows = tbody?.querySelectorAll("tr");
    if (!tbody || !rows || rows.length <= 1) {
      alert("Нельзя удалить все строки таблицы");
      return;
    }
    tbody.removeChild(rows[rows.length - 1]);
    updateRowNumbers();
  };

  const saveAsHTML = async () => {
    await ensureReserved();
    const root = containerRef.current;
    if (!root) return;
    const containerClone = root
      .querySelector(".container")
      ?.cloneNode(true) as HTMLElement | null;
    if (!containerClone) return;
    containerClone
      .querySelectorAll(
        ".table-controls, .actions, .photo-upload, .delete-photo, .delete-row-btn",
      )
      .forEach((el) => el.parentElement?.removeChild(el));
    containerClone.querySelectorAll('input[type="file"]').forEach((input) => {
      const p = document.createElement("p");
      p.textContent = "[Фото прилагается]";
      (p.style as any).fontStyle = "italic";
      input.parentElement?.replaceChild(p, input);
    });

    const html = `<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8" /><title>Предписание (АКТ)</title><style>${styleString}</style></head><body>${containerClone.outerHTML}</body></html>`;
    const blob = new Blob([html], { type: "text/html" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `ПК_${reserved?.short ?? preview?.code ?? `__-${yearSuffix}`}.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    void apiClient.saveHtmlToStorage({
      html,
      name: `ПК_${reserved?.short ?? preview?.code ?? `__-${yearSuffix}`}`,
      folderName: "Предписания",
    });
  };

  const saveAsPDF = async () => {
    await ensureReserved();
    const root = containerRef.current;
    if (!root) return;
    const element = root.querySelector(".container");
    if (!element) return;
    const doc = new jsPDF("p", "mm", "a4");
    const marginLeft = 20,
      marginRight = 10,
      marginTop = 10,
      marginBottom = 20;
    const canvas = await html2canvas(element as HTMLElement, {
      scale: 2,
      useCORS: true,
      logging: false,
    });
    const imgData = canvas.toDataURL("image/png");
    const imgWidth = 210 - marginLeft - marginRight;
    const pageHeight = 297 - marginTop - marginBottom;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    let heightLeft = imgHeight;
    let position = marginTop;
    doc.addImage(imgData, "PNG", marginLeft, position, imgWidth, imgHeight);
    heightLeft -= pageHeight;
    while (heightLeft >= 0) {
      position = heightLeft - imgHeight + marginTop;
      doc.addPage();
      doc.addImage(imgData, "PNG", marginLeft, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;
    }
    doc.save(
      `ПК_${reserved?.short ?? preview?.code ?? `__-${yearSuffix}`}.pdf`,
    );
  };

  const saveToStorageOnly = async () => {
    await ensureReserved();
    const root = containerRef.current;
    if (!root) return;
    const containerClone = root
      .querySelector(".container")
      ?.cloneNode(true) as HTMLElement | null;
    if (!containerClone) return;
    containerClone
      .querySelectorAll(
        ".table-controls, .actions, .photo-upload, .delete-photo, .delete-row-btn",
      )
      .forEach((el) => el.parentElement?.removeChild(el));
    containerClone.querySelectorAll('input[type="file"]').forEach((input) => {
      const p = document.createElement("p");
      p.textContent = "[Фото прилагается]";
      (p.style as any).fontStyle = "italic";
      input.parentElement?.replaceChild(p, input);
    });

    const html = `<!DOCTYPE html><html lang=\"ru\"><head><meta charset=\"UTF-8\" /><title>Предписание (АКТ)</title><style>${styleString}</style></head><body>${containerClone.outerHTML}</body></html>`;
    try {
      await apiClient.saveHtmlToStorage({
        html,
        name: `ПК_${reserved?.short ?? preview?.code ?? `__-${yearSuffix}`}`,
        folderName: "Предписания",
      });
      alert("Сохранено");
    } catch {
      alert("Не удалось сохранить. Попробуйте ещё раз.");
    }
  };
  useEffect(() => {
    const root = containerRef.current;
    if (!root) return;

    const onClick = (e: Event) => {
      const target = e.target as HTMLElement;
      if (target?.classList?.contains("delete-row-btn")) {
        const row = target.closest("tr");
        const tbody = target.closest("tbody");
        const rows = tbody?.querySelectorAll("tr");
        if (tbody && rows && rows.length > 1 && row && row.parentElement) {
          row.parentElement.removeChild(row);
          updateRowNumbers();
        } else {
          alert("Нельзя удалить все строки таблицы");
        }
      }
      if (target?.classList?.contains("delete-photo")) {
        const photo = target.closest(".photo-container");
        photo?.parentElement?.removeChild(photo as any);
      }
    };

    const onChange = (e: Event) => {
      const input = e.target as HTMLInputElement;
      if (
        input &&
        input.classList.contains("photo-input") &&
        input.files &&
        input.files[0]
      ) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = (ev) => {
          const photosContainer = input.parentElement
            ?.nextElementSibling as HTMLElement | null;
          if (!photosContainer) return;
          const photoContainer = document.createElement("div");
          photoContainer.className = "photo-container";
          const img = document.createElement("img");
          img.src = String((ev as any).target?.result ?? "");
          const del = document.createElement("span");
          del.className = "delete-photo";
          del.textContent = "×";
          photoContainer.appendChild(img);
          photoContainer.appendChild(del);
          photosContainer.appendChild(photoContainer);
          input.value = "";
        };
        reader.readAsDataURL(file);
      }
    };

    const onInput = (e: Event) => {
      const el = e.target as HTMLElement;
      if (el && el.tagName === "TEXTAREA") {
        const ta = el as HTMLTextAreaElement;
        ta.style.height = "auto";
        ta.style.height = `${ta.scrollHeight}px`;
      }
    };

    root.addEventListener("click", onClick);
    root.addEventListener("change", onChange as any);
    root.addEventListener("input", onInput as any);

    return () => {
      root.removeEventListener("click", onClick);
      root.removeEventListener("change", onChange as any);
      root.removeEventListener("input", onInput as any);
    };
  }, []);

  return (
    <div className="max-w-[960px] mx-auto p-4 sm:p-6">
      <style>{styleString}</style>
      <div className="container" ref={containerRef}>
        <div className="header">
          <p style={{ fontWeight: "bold", marginBottom: "1cm" } as any}>
            Электронная регистрация производственного контроля
          </p>
          <h1>РОССИЙСКАЯ ФЕДЕРАЦИЯ (РОССИЯ)</h1>
          <h1>РЕСПУБЛИКА САХА (ЯКУТИЯ)</h1>
          <p>Акционерное Общество «Горно-рудная компания «Западная»</p>
          <p>
            678730, Республика Саха (Якутия), Оймяконский район, п. г. т.
            Усть-Нера, проезд Северный, д.12.
          </p>
          <p>тел. 8 (395) 225-52-88, доб.*1502</p>
        </div>

        <div className="document-info">
          <div className="flex items-center justify-between">
            <span>
              <input
                type="date"
                defaultValue={todayISO}
                className="underline"
              />
            </span>
            <span>Рудник «Бадран»</span>
          </div>
          <p className="text-center font-bold">
            ПРЕДПИСАНИЕ (АКТ) №ПК{" "}
            {reserved?.short ?? preview?.code ?? `__-${yearSuffix}`}
          </p>
          <p>Проверки по производственному контролю за состоянием ОТ и ПБ</p>

          <table style={{ border: "none", margin: "15px 0" }}>
            <tbody>
              <tr style={{ border: "none" } as any}>
                <td style={{ border: "none", width: "20%" } as any}>
                  <strong>Кому:</strong>
                </td>
                <td style={{ border: "none" } as any}>
                  <input
                    type="text"
                    defaultValue="Иванов Иван Иванович"
                    style={{ width: "100%" } as any}
                  />
                  <input
                    type="text"
                    defaultValue="(должность, Ф.И.О.)"
                    style={{ width: "100%", marginTop: 5 } as any}
                  />
                  <input
                    type="text"
                    defaultValue="Подземный Горный Участок"
                    style={{ width: "100%", marginTop: 5 } as any}
                  />
                  <input
                    type="text"
                    defaultValue="(наименование обследуемого подразделения общества)"
                    style={{ width: "100%", marginTop: 5 } as any}
                  />
                </td>
              </tr>
              <tr style={{ border: "none" } as any}>
                <td style={{ border: "none", verticalAlign: "top" } as any}>
                  <strong>Проверка проведена в присутствии:</strong>
                </td>
                <td style={{ border: "none" } as any}>
                  <input
                    type="text"
                    defaultValue="Иванова Ивана Ивановича, Иванова Ивана Ивановича, Иванова Ивана Ивановича"
                    style={{ width: "100%" } as any}
                  />
                  <input
                    type="text"
                    defaultValue="(должность, Ф.И.О.)"
                    style={{ width: "100%", marginTop: 5 } as any}
                  />
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <p>
          <strong>
            Необходимо устранить следующие нарушения в указанные сроки:
          </strong>
        </p>

        <div className="table-controls">
          <button id="add-row" className="doc-btn" onClick={addRow}>
            Добавить строку
          </button>
          <button id="delete-row" className="doc-btn" onClick={deleteLastRow}>
            Удалить строку
          </button>
        </div>

        <table id="violations-table">
          <thead>
            <tr>
              <th width="5%">п/п</th>
              <th width="47%">
                Краткое изложение выявленных нарушений с указанием места
                обнаружения
                <br />
                (при необходимости вкладывать фото)
              </th>
              <th width="43%">
                Предлагаемые меры, ответственные за выполнение и срок устранения
                нарушений
              </th>
              <th width="5%">Действия</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>1.</td>
              <td>
                <textarea
                  className="pc-autosize whitespace-pre-wrap break-words w-full h-9 min-h-0 resize-none overflow-hidden"
                  rows={1}
                  placeholder="Опишите выявленные нарушения..."
                ></textarea>
                <div className="photo-upload">
                  <input type="file" accept="image/*" className="photo-input" />
                </div>
                <div className="photos-container"></div>
              </td>
              <td>
                <textarea
                  className="pc-autosize whitespace-pre-wrap break-words w-full h-9 min-h-0 resize-none overflow-hidden"
                  rows={1}
                  placeholder="Опишите предлагаемые меры..."
                ></textarea>
              </td>
              <td>
                <button className="delete-row-btn">Удалить</button>
              </td>
            </tr>
            <tr>
              <td>2.</td>
              <td>
                <textarea
                  className="pc-autosize whitespace-pre-wrap break-words w-full h-9 min-h-0 resize-none overflow-hidden"
                  rows={1}
                  placeholder="Опишите выявленные нарушения..."
                ></textarea>
                <div className="photo-upload">
                  <input type="file" accept="image/*" className="photo-input" />
                </div>
                <div className="photos-container"></div>
              </td>
              <td>
                <textarea
                  className="pc-autosize whitespace-pre-wrap break-words w-full h-9 min-h-0 resize-none overflow-hidden"
                  rows={1}
                  placeholder="Опишите предлагаемые меры..."
                ></textarea>
              </td>
              <td>
                <button className="delete-row-btn">Удалить</button>
              </td>
            </tr>
          </tbody>
        </table>

        <p>
          О выполнении настоящего предписания прошу предоставить письменное
          уведомление в отдел ОТ и ПБ{" "}
          <strong>согласно дат, указанных в пунктах.</strong>
        </p>

        <div className="signatures">
          <p>
            <strong>Предписание выдал:</strong>
          </p>
          <div className="signature-line">
            <div className="signature-line-inner">
              <div className="signature">
                <input
                  type="text"
                  defaultValue="Иванов Иван Иванович, начальник АХО"
                  style={
                    {
                      textAlign: "center",
                      width: "100%",
                      border: "none",
                    } as any
                  }
                />
              </div>
              <div className="signature">
                <input
                  type="date"
                  defaultValue={todayISO}
                  style={
                    {
                      textAlign: "center",
                      width: "100%",
                      border: "none",
                    } as any
                  }
                />
              </div>
            </div>
          </div>

          <p style={{ marginTop: 30 } as any}>
            <strong>Предписание принял:</strong>
          </p>
          <div className="signature-line">
            <div className="signature-line-inner">
              <div className="signature">
                <input
                  type="text"
                  defaultValue="Иванов Иван Иванович, начальник АХО"
                  style={
                    {
                      textAlign: "center",
                      width: "100%",
                      border: "none",
                    } as any
                  }
                />
              </div>
              <div className="signature">
                <input
                  type="date"
                  defaultValue={todayISO}
                  style={
                    {
                      textAlign: "center",
                      width: "100%",
                      border: "none",
                    } as any
                  }
                />
              </div>
            </div>
          </div>

          <div className="signature-line">
            <div className="signature-line-inner">
              <div className="signature">
                <input
                  type="text"
                  defaultValue="Иванов Иван Иванович, начальник АХО"
                  style={
                    {
                      textAlign: "center",
                      width: "100%",
                      border: "none",
                    } as any
                  }
                />
              </div>
              <div className="signature">
                <input
                  type="date"
                  defaultValue={todayISO}
                  style={
                    {
                      textAlign: "center",
                      width: "100%",
                      border: "none",
                    } as any
                  }
                />
              </div>
            </div>
          </div>
        </div>

        <div className="actions">
          <button className="doc-btn" onClick={saveToStorageOnly}>
            Сохранить
          </button>
          <button
            className="doc-btn"
            onClick={() => {
              void (async () => {
                await ensureReserved();
                window.print();
              })();
            }}
          >
            Распечатать
          </button>
          <button className="doc-btn" onClick={saveAsPDF}>
            Сохранить как PDF
          </button>
          <button className="doc-btn" onClick={saveAsHTML}>
            Сохранить как HTML
          </button>
        </div>
      </div>
    </div>
  );
}

function PcAktIssueScreen() {
  const auth = useAuth({ required: true });
  const { data: me } = useQuery<Profile>(
    ["me"],
    () => apiClient.getMyProfile(),
    {
      enabled: auth.status === "authenticated",
      staleTime: 10_000,
    },
  );
  const isAdmin = !!me?.isAdmin;

  const { toast } = useToast();
  const [name, setName] = useState(
    () => `АКТ_ПК_${new Date().toISOString().slice(0, 10)}`,
  );
  const [html, setHtml] = useState<string>("");
  const [previewHtml, setPreviewHtml] = useState<string>("");
  const previewRef = useRef<HTMLDivElement | null>(null);
  const lastClickedCellRef = useRef<HTMLElement | null>(null);
  const queryClient = useQueryClient();
  const navigate = useNavigate();
  const { data: savedPage } = useQuery(
    ["pc-akt-new"],
    () => apiClient.getSimplePageBySlug({ slug: "pc-akt-new" }),
    { enabled: true },
  );
  useEffect(() => {
    if (!html && savedPage?.content) {
      setHtml(savedPage.content);
      setPreviewHtml(savedPage.content);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [savedPage?.content]);

  useEffect(() => {
    const saveAsPDF = async () => {
      try {
        const el = previewRef.current;
        if (!el) return;
        const canvas = await html2canvas(el, { scale: 2 });
        const imgData = canvas.toDataURL("image/png");
        const pdf = new jsPDF("p", "mm", "a4");
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        pdf.addImage(imgData, "PNG", 0, 0, pageWidth, pageHeight);
        pdf.save(`${name || "document"}.pdf`);
      } catch (e) {
        console.error("saveAsPDF failed", e);
      }
    };

    const saveAsHTML = () => {
      try {
        const blob = new Blob([previewHtml], {
          type: "text/html;charset=utf-8",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${name || "document"}.html`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (e) {
        console.error("saveAsHTML failed", e);
      }
    };

    const printAkt = () => {
      try {
        const w = window.open("", "_blank");
        if (!w) return;
        const css = `
          @page { size: A4; margin-top: 1cm; margin-right: 1cm; margin-bottom: 1cm; margin-left: 2cm; }
          @media print {
            button, [role="button"], .no-print { display: none !important; }
            table { page-break-inside: auto; }
            tr, img { page-break-inside: avoid; }
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
          }
          html, body { height: 100%; }
          body { margin: 0; padding: 0; }
          /* Область печати ровно по полю страницы с учетом @page */
          .print-root { box-sizing: border-box; width: 180mm; height: 277mm; overflow: hidden; margin: 0 auto; }
          #fit-content { transform-origin: top left; }
        `;
        w.document.write(
          `<!DOCTYPE html><html><head><meta charset=\"utf-8\"><title>Печать</title><style>${css}</style></head><body><div class=\"print-root\"><div id=\"fit-content\">${previewHtml || ""}</div></div></body></html>`,
        );
        w.document.close();
        w.onload = () => {
          try {
            const root = w.document.querySelector(".print-root");
            const content = w.document.getElementById("fit-content");
            if (!root || !content) {
              w.print();
              return;
            }
            // дождемся изображений, чтобы измерения были корректными
            const imgs = Array.from(w.document.images || []);
            const waitImgs = Promise.all(
              imgs.map((img) =>
                img.complete
                  ? Promise.resolve()
                  : new Promise((res) => {
                      img.onload = img.onerror = () => res(undefined);
                    }),
              ),
            );
            const fitAndPrint = () => {
              try {
                content.style.transform = "none";
                const availW = (root as HTMLElement).clientWidth || 1;
                const availH = (root as HTMLElement).clientHeight || 1;
                const rect = (content as HTMLElement).getBoundingClientRect();
                const scale = Math.min(
                  availW / Math.max(rect.width, 1),
                  availH / Math.max(rect.height, 1),
                  1,
                );
                (content as HTMLElement).style.transform = `scale(${scale})`;
                w.focus();
                setTimeout(() => w.print(), 50);
              } catch {
                w.print();
              }
            };
            waitImgs.then(() => setTimeout(fitAndPrint, 0));
          } catch {
            w.print();
          }
        };
      } catch (e) {
        console.error("printAkt failed", e);
      }
    };

    (window as any).saveAsPDF = saveAsPDF;
    (window as any).savePDF = saveAsPDF;
    (window as any).exportPDF = saveAsPDF;
    (window as any).saveAsHTML = saveAsHTML;
    (window as any).exportHTML = saveAsHTML;
    (window as any).downloadHTML = saveAsHTML;
    (window as any).printAkt = printAkt;

    return () => {
      try {
        delete (window as any).saveAsPDF;
        delete (window as any).savePDF;
        delete (window as any).exportPDF;
        delete (window as any).saveAsHTML;
        delete (window as any).exportHTML;
        delete (window as any).downloadHTML;
        delete (window as any).printAkt;
      } catch {}
    };
  }, [previewHtml, name]);

  useEffect(() => {
    const root = previewRef.current;
    if (!root) return;

    const onClick = (e: Event) => {
      const target = e.target as HTMLElement;
      const cell = target.closest(
        "td, th, div, section, article",
      ) as HTMLElement | null;
      if (cell) lastClickedCellRef.current = cell;
    };
    root.addEventListener("click", onClick, true);

    const onInput = (e: Event) => {
      const t = e.target as HTMLElement | null;
      if (!t) return;
      if (t.tagName === "TEXTAREA") {
        const ta = t as HTMLTextAreaElement;
        ta.style.height = "auto";
        ta.style.height = `${ta.scrollHeight}px`;
        const td = ta.closest("td") as HTMLElement | null;
        if (td) td.style.height = "auto";
      }
    };
    root.addEventListener("input", onInput, true);

    const findTable = (maybeId?: any): HTMLTableElement | null => {
      const r = previewRef.current;
      if (!r) return null;
      if (typeof maybeId === "string") {
        const byId = r.querySelector("#" + maybeId) as HTMLTableElement | null;
        if (byId && byId.tagName.toLowerCase() === "table") return byId;
      }
      return (r.querySelector("table[data-act-table]") ||
        r.querySelector("table")) as HTMLTableElement | null;
    };

    (window as any).addRow = (...args: any[]) => {
      const table = findTable(args[0]);
      if (!table) return;
      const tbody = table.tBodies[0] || table;
      const rowsArr = tbody.rows.length
        ? Array.from(tbody.rows)
        : Array.from(table.rows);
      const lastRow = rowsArr[rowsArr.length - 1] as
        | HTMLTableRowElement
        | undefined;
      const newRow = lastRow
        ? (lastRow.cloneNode(true) as HTMLTableRowElement)
        : (document.createElement("tr") as HTMLTableRowElement);
      if (!lastRow) newRow.appendChild(document.createElement("td"));
      // очистим вводимые значения, сохранив элементы управления (кнопки)
      newRow.querySelectorAll("input, textarea").forEach((el: any) => {
        el.value = "";
      });
      newRow.querySelectorAll('[contenteditable="true"]').forEach((el) => {
        (el as HTMLElement).innerText = "";
      });
      newRow.querySelectorAll("img").forEach((img) => {
        (img as HTMLImageElement).src = "";
      });
      // убедимся, что в новой строке есть кнопка вставки фото
      try {
        const cells = (newRow as HTMLTableRowElement).cells?.length
          ? Array.from((newRow as HTMLTableRowElement).cells)
          : Array.from(newRow.querySelectorAll("td"));
        const photoCell = (cells[1] || cells[0]) as HTMLElement | undefined;
        // ensure "+ Вставить фото" button exists
        if (photoCell && !photoCell.querySelector("[data-photo-button]")) {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.setAttribute("data-photo-button", "1");
          btn.textContent = "+ Вставить фото";
          btn.style.marginTop = "6px";
          btn.style.display = "inline-block";
          btn.addEventListener("click", () => {
            if ((window as any).addPhotoToCell) {
              (window as any).addPhotoToCell();
            }
          });
          photoCell.appendChild(btn);
        }
        // ensure a text input area exists under the photo button
        if (photoCell && !photoCell.querySelector("[data-photo-text]")) {
          const ta = document.createElement("textarea");
          ta.setAttribute("data-photo-text", "1");
          ta.placeholder = "Введите описание…";
          ta.style.width = "100%";
          ta.style.minHeight = "72px";
          ta.style.marginTop = "6px";
          ta.style.resize = "vertical";
          ta.style.overflow = "hidden";
          (ta as HTMLTextAreaElement).value = "";
          const autosize = (el: HTMLTextAreaElement) => {
            el.style.height = "auto";
            el.style.height = `${el.scrollHeight}px`;
          };
          ta.addEventListener("input", () => autosize(ta));
          // set initial height
          setTimeout(() => autosize(ta), 0);
          photoCell.appendChild(ta);
        }
      } catch {}

      tbody.appendChild(newRow);

      // перенумеруем строки после добавления
      const rows = Array.from(tbody.rows) as HTMLTableRowElement[];
      // определим формат нумерации (с точкой или без) по первой непустой ячейке
      let withDot = false;
      for (const r of rows) {
        const c = r.querySelector("td");
        const txt = (c?.textContent || "").trim();
        if (txt) {
          withDot = txt.endsWith(".");
          break;
        }
      }
      rows.forEach((r, idx) => {
        const firstCell = r.querySelector("td");
        if (!firstCell) return;
        firstCell.textContent = `${idx + 1}${withDot ? "." : ""}`;
      });
    };

    (window as any).deleteRow = (...args: any[]) => {
      const table = findTable(args[0]);
      if (!table) return;
      const tbody = table.tBodies[0] || table;
      const rows = tbody.rows;
      const renumber = () => {
        const all = Array.from(tbody.rows) as HTMLTableRowElement[];
        const firstTxt = (
          tbody.querySelector("tr td")?.textContent || ""
        ).trim();
        const withDot = firstTxt.endsWith(".");
        all.forEach((r, idx) => {
          const c = r.querySelector("td");
          if (c) c.textContent = `${idx + 1}${withDot ? "." : ""}`;
        });
      };
      if (lastClickedCellRef.current) {
        const tr = lastClickedCellRef.current.closest("tr");
        if (tr && tr.parentElement === tbody && rows.length > 1) {
          tbody.removeChild(tr);
          renumber();
          return;
        }
      }
      if (rows.length > 1) {
        tbody.deleteRow(rows.length - 1);
        renumber();
      }
    };

    (window as any).promoteThirdRowToFirst = (...args: any[]) => {
      const table = findTable(args[0]);
      if (!table) return;
      const tbody = (table.tBodies[0] || table) as any;
      const rowsArr = Array.from(
        (tbody.rows && tbody.rows.length ? tbody.rows : table.rows) as any,
      ) as HTMLTableRowElement[];
      const dataRows: HTMLTableRowElement[] = rowsArr.filter((r) => {
        const first = r.querySelector("td");
        if (!first) return false;
        const raw = (first.textContent || "").trim();
        const num = parseInt(raw.replace(".", ""), 10);
        return !Number.isNaN(num);
      });
      if (dataRows.length >= 3) {
        const r1 = dataRows[0];
        const r2 = dataRows[1];
        if (r1 && r1.parentElement === tbody) tbody.removeChild(r1);
        if (r2 && r2.parentElement === tbody) tbody.removeChild(r2);
      }
      const updatedRows = Array.from(
        (tbody.rows && tbody.rows.length ? tbody.rows : table.rows) as any,
      ) as HTMLTableRowElement[];
      const newDataRows: HTMLTableRowElement[] = updatedRows.filter((r) => {
        const first = r.querySelector("td");
        if (!first) return false;
        const raw = (first.textContent || "").trim();
        const num = parseInt(raw.replace(".", ""), 10);
        return !Number.isNaN(num);
      });
      const firstDataRow = newDataRows[0];
      if (firstDataRow) {
        try {
          const cells = firstDataRow.cells?.length
            ? Array.from(firstDataRow.cells)
            : Array.from(firstDataRow.querySelectorAll("td"));
          const photoCell = (cells[1] || cells[0]) as HTMLElement | undefined;
          if (photoCell && !photoCell.querySelector("[data-photo-button]")) {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.setAttribute("data-photo-button", "1");
            btn.textContent = "+ Вставить фото";
            btn.style.marginTop = "6px";
            btn.style.display = "inline-block";
            btn.addEventListener("click", () => {
              if ((window as any).addPhotoToCell)
                (window as any).addPhotoToCell();
            });
            photoCell.appendChild(btn);
          }
          if (photoCell && !photoCell.querySelector("[data-photo-text]")) {
            const ta = document.createElement("textarea");
            ta.setAttribute("data-photo-text", "1");
            ta.placeholder = "Введите описание…";
            ta.style.width = "100%";
            ta.style.minHeight = "72px";
            ta.style.marginTop = "6px";
            ta.style.resize = "vertical";
            ta.style.overflow = "hidden";
            ta.value = "";
            const autosize = (el: HTMLTextAreaElement) => {
              el.style.height = "auto";
              el.style.height = `${el.scrollHeight}px`;
            };
            ta.addEventListener("input", () => autosize(ta));
            setTimeout(() => autosize(ta), 0);
            photoCell.appendChild(ta);
          }
        } catch {}
      }
      const allRows = Array.from(
        (tbody.rows && tbody.rows.length ? tbody.rows : table.rows) as any,
      ) as HTMLTableRowElement[];
      let withDot = false;
      for (const r of allRows) {
        const c = r.querySelector("td");
        const txt = (c?.textContent || "").trim();
        if (txt) {
          withDot = txt.endsWith(".");
          break;
        }
      }
      const onlyData = allRows.filter((r) => r.querySelector("td"));
      onlyData.forEach((r, idx) => {
        const c = r.querySelector("td");
        if (c) c.textContent = `${idx + 1}${withDot ? "." : ""}`;
      });
    };

    (window as any).promoteThirdRowToFirst = (...args: any[]) => {
      const table = findTable(args[0]);
      if (!table) return;
      const tbody = (table.tBodies[0] || table) as any;
      const rowsArr = Array.from(
        ((tbody as any).rows && (tbody as any).rows.length
          ? (tbody as any).rows
          : (table as any).rows) as any,
      ) as HTMLTableRowElement[];
      const dataRows: HTMLTableRowElement[] = rowsArr.filter((r) => {
        const first = r.querySelector("td");
        if (!first) return false;
        const raw = (first.textContent || "").trim();
        const num = parseInt(raw.replace(".", ""), 10);
        return !Number.isNaN(num);
      });
      if (dataRows.length >= 3) {
        const r1 = dataRows[0];
        const r2 = dataRows[1];
        if (r1 && (r1 as any).parentElement === tbody)
          (tbody as any).removeChild(r1);
        if (r2 && (r2 as any).parentElement === tbody)
          (tbody as any).removeChild(r2);
      }
      const updatedRows = Array.from(
        ((tbody as any).rows && (tbody as any).rows.length
          ? (tbody as any).rows
          : (table as any).rows) as any,
      ) as HTMLTableRowElement[];
      const newDataRows: HTMLTableRowElement[] = updatedRows.filter((r) => {
        const first = r.querySelector("td");
        if (!first) return false;
        const raw = (first.textContent || "").trim();
        const num = parseInt(raw.replace(".", ""), 10);
        return !Number.isNaN(num);
      });
      const firstDataRow = newDataRows[0];
      if (firstDataRow) {
        try {
          const cells = (firstDataRow as any).cells?.length
            ? Array.from((firstDataRow as any).cells)
            : Array.from(firstDataRow.querySelectorAll("td"));
          const photoCell = (cells[1] || cells[0]) as HTMLElement | undefined;
          if (photoCell && !photoCell.querySelector("[data-photo-button]")) {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.setAttribute("data-photo-button", "1");
            btn.textContent = "+ Вставить фото";
            btn.style.marginTop = "6px";
            btn.style.display = "inline-block";
            btn.addEventListener("click", () => {
              (window as any).addPhotoToCell?.();
            });
            photoCell.appendChild(btn);
          }
          if (photoCell && !photoCell.querySelector("[data-photo-text]")) {
            const ta = document.createElement("textarea");
            ta.setAttribute("data-photo-text", "1");
            ta.placeholder = "Введите описание…";
            ta.style.width = "100%";
            ta.style.minHeight = "72px";
            ta.style.marginTop = "6px";
            ta.style.resize = "vertical";
            ta.style.overflow = "hidden";
            ta.value = "";
            const autosize = (el: HTMLTextAreaElement) => {
              el.style.height = "auto";
              el.style.height = `${el.scrollHeight}px`;
            };
            ta.addEventListener("input", () => autosize(ta));
            setTimeout(() => autosize(ta), 0);
            photoCell.appendChild(ta);
          }
        } catch {}
      }
      const allRows = Array.from(
        ((tbody as any).rows && (tbody as any).rows.length
          ? (tbody as any).rows
          : (table as any).rows) as any,
      ) as HTMLTableRowElement[];
      let withDot = false;
      for (const r of allRows) {
        const c = r.querySelector("td");
        const txt = (c?.textContent || "").trim();
        if (txt) {
          withDot = txt.endsWith(".");
          break;
        }
      }
      const onlyData = allRows.filter((r) => r.querySelector("td"));
      onlyData.forEach((r, idx) => {
        const c = r.querySelector("td");
        if (c) c.textContent = `${idx + 1}${withDot ? "." : ""}`;
      });
    };

    (window as any).addSignatureLine = () => {
      const r = previewRef.current;
      if (!r) return;
      const container = (r.querySelector("[data-signatures]") ||
        r.querySelector("#signatures") ||
        r) as HTMLElement;
      const line = document.createElement("div");
      line.style.marginTop = "8px";
      line.style.display = "flex";
      line.style.alignItems = "center";
      line.style.gap = "12px";

      const nameInput = document.createElement("input");
      nameInput.type = "text";
      nameInput.placeholder = "ФИО, должность";
      nameInput.style.flex = "1";
      nameInput.style.border = "none";
      nameInput.style.borderBottom = "1px solid #444";
      nameInput.style.outline = "none";

      const dateInput = document.createElement("input");
      dateInput.type = "date";
      dateInput.style.width = "165px";
      const today = new Date();
      const iso = new Date(today.getTime() - today.getTimezoneOffset() * 60000)
        .toISOString()
        .slice(0, 10);
      dateInput.value = iso;

      line.appendChild(nameInput);
      line.appendChild(dateInput);
      container.appendChild(line);
    };

    (window as any).addPhotoToCell = () => {
      const target = (lastClickedCellRef.current ||
        previewRef.current) as HTMLElement | null;
      if (!target) return;
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "image/*";
      input.onchange = () => {
        const file = input.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          const img = document.createElement("img");
          img.src = String(reader.result || "");
          img.style.maxWidth = "100%";
          img.style.height = "auto";
          target.appendChild(img);
        };
        reader.readAsDataURL(file);
      };
      input.click();
    };

    (window as any).printAkt = () => {
      try {
        const w = window.open("", "_blank");
        if (!w) return;
        const css = `
          @page { size: A4; margin-top: 1cm; margin-right: 1cm; margin-bottom: 1cm; margin-left: 2cm; }
          @media print {
            button, [role=\"button\"], .no-print { display: none !important; }
            table { page-break-inside: auto; }
            tr, img { page-break-inside: avoid; }
            p { orphans: 2; widows: 2; }
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
          }
          html, body { height: 100%; }
          body { margin: 0; padding: 0; }
          .print-root { box-sizing: border-box; width: 180mm; height: 277mm; overflow: hidden; margin: 0 auto; }
          #fit-content { transform-origin: top left; }
        `;
        const content = previewRef.current?.innerHTML || "";
        w.document.write(
          `<!DOCTYPE html><html><head><meta charset=\"utf-8\"><title>Печать</title><style>${css}</style></head><body><div class=\"print-root\"><div id=\"fit-content\">${content}</div></div></body></html>`,
        );
        w.document.close();
        w.onload = () => {
          try {
            const root = w.document.querySelector(".print-root");
            const inner = w.document.getElementById("fit-content");
            if (!root || !inner) {
              w.print();
              return;
            }
            const imgs = Array.from(w.document.images || []);
            const waitImgs = Promise.all(
              imgs.map((img) =>
                img.complete
                  ? Promise.resolve()
                  : new Promise((res) => {
                      img.onload = img.onerror = () => res(undefined);
                    }),
              ),
            );
            const fitAndPrint = () => {
              try {
                (inner as HTMLElement).style.transform = "none";
                const availW = (root as HTMLElement).clientWidth || 1;
                const availH = (root as HTMLElement).clientHeight || 1;
                const rect = (inner as HTMLElement).getBoundingClientRect();
                const scale = Math.min(
                  availW / Math.max(rect.width, 1),
                  availH / Math.max(rect.height, 1),
                  1,
                );
                (inner as HTMLElement).style.transform = `scale(${scale})`;
                w.focus();
                setTimeout(() => w.print(), 50);
              } catch {
                w.print();
              }
            };
            waitImgs.then(() => setTimeout(fitAndPrint, 0));
          } catch {
            w.print();
          }
        };
      } catch (e) {
        console.error("printAkt failed", e);
      }
    };

    (window as any).printForm = () => {
      if ((window as any).printAkt) {
        (window as any).printAkt();
      } else {
        window.print();
      }
    };

    return () => {
      root.removeEventListener("click", onClick, true);
      root.removeEventListener("input", onInput, true);
      try {
        delete (window as any).addRow;
        delete (window as any).deleteRow;
        delete (window as any).promoteThirdRowToFirst;
        delete (window as any).addSignatureLine;
        delete (window as any).addPhotoToCell;
        delete (window as any).printForm;
      } catch {}
    };
  }, [previewHtml]);

  // Глобальные хелперы навигации для кнопок внутри HTML (например, onclick="goToMainPage()")
  React.useEffect(() => {
    const goMain = () => {
      try {
        navigate(isAdmin ? "/admin" : "/");
      } catch {
        try {
          (window as any).location.href = isAdmin ? "/admin" : "/";
        } catch {}
      }
    };
    (window as any).goToMainPage = goMain;
    (window as any).goToMain = goMain;
    (window as any).goHome = goMain;
    (window as any).goHomePage = goMain;
    return () => {
      try {
        delete (window as any).goToMainPage;
        delete (window as any).goToMain;
        delete (window as any).goHome;
        delete (window as any).goHomePage;
      } catch {}
    };
  }, [isAdmin, navigate]);

  const { data: usersPage } = useQuery(
    ["users-for-who", 1],
    () => apiClient.listUsers({ page: 1, pageSize: 200 }),
    { enabled: isAdmin, staleTime: 30_000 },
  );

  React.useEffect(() => {
    try {
      const root = previewRef.current;
      const items = (usersPage as any)?.items ?? [];
      if (!root || !Array.isArray(items) || items.length === 0) return;
      const labels = Array.from(
        root.querySelectorAll("div,span,strong,b,label"),
      ).filter((el) => (el.textContent || "").trim().startsWith("Кому:"));
      labels.forEach((label) => {
        const parent = label.parentElement || root;
        if (parent.querySelector("[data-who-select]")) return;
        let valueEl = (label.nextElementSibling as HTMLElement) || null;
        if (
          !valueEl ||
          valueEl.matches("select") ||
          (valueEl.textContent || "").trim() === ""
        ) {
          const span = document.createElement("span");
          span.setAttribute("data-who-value", "1");
          span.style.display = "inline-block";
          span.style.minWidth = "220px";
          span.style.borderBottom = "1px solid #ccc";
          span.style.marginLeft = "8px";
          label.insertAdjacentElement("afterend", span);
          valueEl = span;
        }
        const select = document.createElement("select");
        select.setAttribute("data-who-select", "1");
        select.className = "no-print";
        select.style.marginLeft = "8px";
        const placeholderOption = document.createElement("option");
        placeholderOption.value = "";
        placeholderOption.textContent = "— Выбрать —";
        select.appendChild(placeholderOption);
        items.forEach((u: any) => {
          const opt = document.createElement("option");
          opt.value =
            (u as any).id || (u as any).email || (u as any).fullName || "";
          opt.textContent =
            (u as any).fullName ||
            (u as any).email ||
            ((u as any).shortId != null ? "ID " + (u as any).shortId : "");
          select.appendChild(opt);
        });
        label.insertAdjacentElement("afterend", select);
        select.addEventListener("change", () => {
          if (valueEl)
            valueEl.textContent =
              select.options[select.selectedIndex]?.text || "";
        });
      });
    } catch {}
  }, [previewHtml, usersPage]);

  // Скрываем элементы предварительного просмотра для обычных пользователей
  React.useEffect(() => {
    try {
      if (isAdmin) return;
      const root = previewRef.current;
      if (!root) return;
      // Скрыть кнопку "Сохранить в HTML" внутри содержимого
      const maybeButtons = Array.from(
        root.querySelectorAll('button, a, [role="button"]'),
      ) as HTMLElement[];
      maybeButtons.forEach((el) => {
        const text = (el.textContent || "").trim();
        if (text === "Сохранить в HTML") {
          el.style.display = "none";
        }
      });
      // На всякий случай скрыть выпадающий список получателя, если он всё же появился
      root.querySelectorAll("[data-who-select]").forEach((el) => {
        (el as HTMLElement).style.display = "none";
      });
    } catch {}
  }, [previewHtml, isAdmin]);

  // Автоприменение: делаем 3-ю строку первой и синхронизируем HTML
  const autoPromoteKeyRef = React.useRef<string | null>(null);
  React.useEffect(() => {
    try {
      const key = previewHtml || "";
      if (!key) return;
      if (autoPromoteKeyRef.current === key) return;
      setTimeout(() => {
        try {
          (window as any).promoteThirdRowToFirst?.();
          const node = previewRef.current;
          if (!node) return;
          const updated = node.innerHTML || "";
          if (updated && updated !== previewHtml) {
            setPreviewHtml(updated);
            setHtml(updated);
            autoPromoteKeyRef.current = updated;
          } else {
            autoPromoteKeyRef.current = key;
          }
        } catch {}
      }, 0);
    } catch {}
  }, [previewHtml]);

  const persist = useMutation(apiClient.upsertSimplePage, {
    onSuccess: () => {
      toast({ title: "Сохранено на странице" });
      queryClient.invalidateQueries(["pc-akt-new"]).catch(() => {});
    },
    onError: () => toast({ title: "Не удалось сохранить на странице" }),
  });
  const save = useMutation(apiClient.saveHtmlToStorage, {
    onSuccess: () => toast({ title: "Сохранено в хранилище" }),
    onError: () => toast({ title: "Не удалось сохранить в хранилище" }),
  });

  return (
    <div className="max-w-5xl mx-auto p-4 sm:p-6 space-y-4">
      <Card className="card-elevated">
        <CardHeader>
          <CardTitle>Электронная выдача АКТа ПК — новый раздел</CardTitle>
        </CardHeader>
        <CardContent className="space-y-3">
          <div
            className="grid sm:grid-cols-[180px,auto] gap-3 items-center"
            style={{ display: isAdmin ? undefined : "none" }}
          >
            <Label>Имя файла</Label>
            <Input
              value={name}
              onChange={(e) => setName(e.target.value)}
              placeholder="Имя без расширения"
            />
          </div>
          <div className="space-y-2">
            {isAdmin && (
              <>
                <Label>HTML новой страницы</Label>
                <Textarea
                  value={html}
                  onChange={(e) => setHtml(e.target.value)}
                  className="min-h-[240px]"
                  placeholder="Вставьте здесь HTML-код новой страницы"
                />
              </>
            )}
            <div className="flex gap-2 flex-wrap">
              {isAdmin && (
                <>
                  <Button
                    variant="secondary"
                    disabled={!html}
                    onClick={() => setPreviewHtml(html)}
                  >
                    Предпросмотр
                  </Button>
                  <Button
                    disabled={!html || persist.isLoading}
                    onClick={() =>
                      persist.mutate({
                        slug: "pc-akt-new",
                        title: "Электронная выдача АКТа ПК — новый раздел",
                        content: html,
                      })
                    }
                  >
                    {persist.isLoading ? "Сохраняем…" : "Сохранить"}
                  </Button>
                  <Button
                    disabled={!html || save.isLoading}
                    onClick={() =>
                      save.mutate({ html, name, folderName: "Предписания" })
                    }
                  >
                    {save.isLoading ? "Сохраняем…" : "Сохранить в хранилище"}
                  </Button>
                  <Button
                    onClick={() => {
                      if (!html) return;
                      const slug = `pc-akt-${new Date().toISOString().slice(0, 10)}-${nanoid(6)}`;
                      persist.mutate(
                        { slug, title: name || "АКТ ПК", content: html },
                        {
                          onSuccess: () => {
                            toast({ title: "Страница создана" });
                            navigate(`/p/${slug}`);
                          },
                          onError: () =>
                            toast({ title: "Не удалось создать страницу" }),
                        },
                      );
                    }}
                  >
                    Создать новую страницу
                  </Button>
                  <Button
                    variant="destructive"
                    onClick={() => {
                      setHtml("");
                      setPreviewHtml("");
                    }}
                  >
                    Очистить
                  </Button>
                  <Button
                    variant="secondary"
                    onClick={() => (window as any).promoteThirdRowToFirst?.()}
                  >
                    Сделать 3‑ю строку первой
                  </Button>
                </>
              )}
              {/* Предпросмотр следующего номера предписания */}
              {(() => {
                try {
                  // Используем уже существующий подход с React Query, без дополнительных хуков снаружи
                  // Встраиваем мини-компонент в разметку, чтобы не увеличивать файл
                  // eslint-disable-next-line react-hooks/rules-of-hooks
                  const { data: nextNum } = (function useLocalPreview() {
                    // Чтобы избежать конфликтов правил hooks, реализуем мини-хук как IIFE, который будет вызван один раз при рендере блока
                    // Здесь безопасно, так как он всегда вызывается одинаково при каждом рендере данного участка JSX
                    // eslint-disable-next-line react-hooks/rules-of-hooks
                    const q = useQuery(
                      [
                        "pc-next-act-number",
                        new Date().toISOString().slice(0, 10),
                      ],
                      () =>
                        apiClient.previewNextProdControlActNumber({
                          date: new Date().toISOString(),
                        }),
                      { staleTime: 15_000 },
                    );
                    return q;
                  })();
                  return (
                    <span className="text-xs text-muted-foreground whitespace-nowrap">
                      {nextNum
                        ? `Следующий номер: ПК-${String(nextNum.number).padStart(2, "0")}-${String(nextNum.year % 100).padStart(2, "0")}`
                        : "..."}
                    </span>
                  );
                } catch {
                  return null;
                }
              })()}
              {/* Кнопка брони номера и автоматической подстановки */}
              {(() => {
                try {
                  // eslint-disable-next-line react-hooks/rules-of-hooks
                  const reserveMutation = useMutation(
                    apiClient.reserveProdControlActNumber,
                    {
                      onSuccess: (res) => {
                        try {
                          const numberStr = res.short; // формат NN-YY
                          const display = `№ПК ${numberStr}`;
                          const replacer = (src) => {
                            if (!src) return src;
                            const r1 = src.replace(
                              /№\s*ПК[ -]?\d{1,3}-\d{2}/,
                              display,
                            );
                            if (r1 !== src) return r1;
                            const r2 = src.replace(
                              /ПК[ -]\d{1,3}-\d{2}/,
                              `ПК ${numberStr}`,
                            );
                            if (r2 !== src) return r2;
                            const r3 = src.replace(
                              /ПРЕДПИСАНИЕ\s*\(АКТ\)/i,
                              (m) => `${m} ${display}`,
                            );
                            return r3;
                          };
                          const newHtml = replacer(html);
                          const newPreview = replacer(previewHtml);
                          setHtml(newHtml);
                          setPreviewHtml(newPreview);
                          toast({ title: `Номер забронирован: ${display}` });
                        } catch (e) {
                          console.error("apply reserved act number failed", e);
                          toast({ title: "Не удалось подставить номер" });
                        }
                      },
                      onError: () =>
                        toast({ title: "Не удалось забронировать номер" }),
                    },
                  );
                  return (
                    <Button
                      variant="outline"
                      disabled={reserveMutation.isLoading}
                      onClick={() => reserveMutation.mutate({})}
                    >
                      {reserveMutation.isLoading
                        ? "Бронируем…"
                        : "Забронировать номер и подставить"}
                    </Button>
                  );
                } catch {
                  return null;
                }
              })()}{" "}
            </div>
            {isAdmin && (
              <div className="text-xs text-muted-foreground">
                HTML вставляется как есть (без обработки). Убедитесь в
                корректности кода.
              </div>
            )}
          </div>
          {previewHtml ? (
            <div className="border rounded-md p-3 overflow-auto">
              <div className="text-xs text-muted-foreground mb-2">
                Предпросмотр активен — кнопки внутри работают.
              </div>
              <div
                ref={previewRef}
                dangerouslySetInnerHTML={{ __html: previewHtml }}
              />
            </div>
          ) : (
            <div className="text-sm text-muted-foreground">
              Предпросмотр будет показан после вставки HTML.
            </div>
          )}
        </CardContent>
        <CardFooter>
          {isAdmin && (
            <NavLink to="/admin">
              <Button variant="secondary">На главную админки</Button>
            </NavLink>
          )}
        </CardFooter>
      </Card>
    </div>
  );
}

function AdminCompareScreen() {
  const navigate = useNavigate();
  const queryClient = useQueryClient();
  const { toast } = useToast();
  const [search, setSearch] = useState("");
  const [page, setPage] = useState(1);
  const [editingId, setEditingId] = useState<string | null>(null);
  const [drafts, setDrafts] = useState<
    Record<
      string,
      { fullName?: string; department?: string; jobTitle?: string }
    >
  >({});

  const {
    data: usersRes,
    isFetching: usersFetching,
    isInitialLoading,
  } = useQuery(
    ["compare-users", search, page],
    () =>
      apiClient.listUsers({ query: search || undefined, page, pageSize: 100 }),
    { keepPreviousData: true },
  );
  const { data: titlesRes } = useQuery(["pab-titles"], () =>
    apiClient.getPabJobTitles(),
  );

  const users = (usersRes as any)?.items ?? [];
  const jobTitles: string[] = ((titlesRes as any)?.titles as string[]) ?? [];

  const startEdit = (u: any) => {
    setEditingId(u.id);
    setDrafts((prev) => ({
      ...prev,
      [u.id]: {
        fullName: u.fullName || "",
        department: u.department || "",
        jobTitle: u.jobTitle || "",
      },
    }));
  };
  const updateDraftField = (
    userId: string,
    field: "fullName" | "department" | "jobTitle",
    value: string,
  ) => {
    setDrafts((prev) => ({
      ...prev,
      [userId]: { ...(prev[userId] ?? {}), [field]: value },
    }));
  };

  const saveAll = useMutation(
    async () => {
      const entries = Object.entries(drafts);
      if (entries.length === 0) return;
      await Promise.all(
        entries.map(([userId, data]) =>
          apiClient.updateUserProfileAdmin({
            userId,
            fullName: data.fullName,
            department: data.department,
            jobTitle: data.jobTitle,
          }),
        ),
      );
    },
    {
      onSuccess: async () => {
        toast({ title: "Изменения сохранены" });
        setEditingId(null);
        setDrafts({});
        await Promise.all([
          queryClient.invalidateQueries({ queryKey: ["compare-users"] }),
          queryClient.invalidateQueries({ queryKey: ["users"] }),
        ]);
      },
      onError: () => toast({ title: "Не удалось сохранить" }),
    },
  );

  return (
    <div className="w-full max-w-[120rem] mx-auto px-4 sm:px-6 space-y-4">
      <Card className="card-elevated">
        <CardHeader className="flex items-center justify-between">
          <div className="flex items-center gap-2">
            <Button variant="outline" onClick={() => navigate("/admin")}>
              Назад в админку
            </Button>
            <CardTitle>Сравнить</CardTitle>
          </div>
          <div className="flex gap-2">
            <Input
              placeholder="Поиск"
              value={search}
              onChange={(e) => {
                setSearch(e.target.value);
                setPage(1);
              }}
              className="w-56"
            />
            <Button
              variant="secondary"
              onClick={() => setPage((p) => p)}
              disabled={usersFetching}
            >
              Обновить
            </Button>
          </div>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div className="border rounded p-3">
              <div className="font-medium mb-2">Пользователи</div>
              <div className="space-y-2 max-h-[60vh] overflow-auto pr-1">
                {users.length === 0 ? (
                  <div className="text-sm text-muted-foreground">
                    {isInitialLoading ? "Загрузка..." : "Нет пользователей"}
                  </div>
                ) : (
                  users.map((u: any) => {
                    const d = drafts[u.id];
                    const isEditing = editingId === u.id;
                    return (
                      <div
                        key={u.id}
                        className={`border rounded p-2 ${isEditing ? "bg-accent/30" : ""}`}
                      >
                        <div className="flex justify-between items-start gap-2">
                          <div className="flex-1 space-y-1">
                            {isEditing ? (
                              <>
                                <Input
                                  value={d?.fullName ?? ""}
                                  onChange={(e) =>
                                    updateDraftField(
                                      u.id,
                                      "fullName",
                                      e.target.value,
                                    )
                                  }
                                  placeholder="ФИО"
                                />
                                <Input
                                  value={d?.department ?? ""}
                                  onChange={(e) =>
                                    updateDraftField(
                                      u.id,
                                      "department",
                                      e.target.value,
                                    )
                                  }
                                  placeholder="Подразделение"
                                />
                                <Input
                                  value={d?.jobTitle ?? ""}
                                  onChange={(e) =>
                                    updateDraftField(
                                      u.id,
                                      "jobTitle",
                                      e.target.value,
                                    )
                                  }
                                  placeholder="Должность"
                                />
                                <div className="text-xs text-muted-foreground">
                                  Подсказка: кликните должность справа, чтобы
                                  вставить её сюда
                                </div>
                              </>
                            ) : (
                              <>
                                <div className="font-medium">
                                  {u.fullName || "—"}
                                </div>
                                <div className="text-sm">
                                  Подразделение: {u.department || "—"}
                                </div>
                                <div className="text-sm">
                                  Должность: {u.jobTitle || "—"}
                                </div>
                              </>
                            )}
                          </div>
                          <div className="shrink-0">
                            <Button
                              size="sm"
                              variant="outline"
                              onClick={() =>
                                isEditing ? setEditingId(null) : startEdit(u)
                              }
                            >
                              {isEditing ? "Готово" : "Изменить"}
                            </Button>
                          </div>
                        </div>
                      </div>
                    );
                  })
                )}
              </div>
              <div className="mt-3 flex justify-end">
                <Button
                  onClick={() => saveAll.mutate()}
                  disabled={
                    saveAll.isLoading || Object.keys(drafts).length === 0
                  }
                >
                  {saveAll.isLoading ? "Сохранение…" : "Сохранить изменения"}
                </Button>
              </div>
            </div>

            <div className="border rounded p-3">
              <div className="font-medium mb-2">Список должностей (ПАБ)</div>
              <div className="text-xs text-muted-foreground mb-2">
                Источник: Личные показатели ПАБ → Таблица для заполнения
              </div>
              <div className="max-h-[60vh] overflow-auto pr-1 divide-y">
                {jobTitles.length === 0 ? (
                  <div className="text-sm text-muted-foreground">
                    Нет данных
                  </div>
                ) : (
                  jobTitles.map((t) => (
                    <div
                      key={t}
                      role="button"
                      tabIndex={0}
                      className="w-full text-left py-1 hover:bg-accent/50 px-2 rounded select-text cursor-text"
                      onClick={() => {
                        const sel =
                          typeof window !== "undefined" && window.getSelection
                            ? (window.getSelection()?.toString() ?? "")
                            : "";
                        if (sel.trim()) return; // не вставляем, если пользователь выделял текст
                        if (editingId) {
                          updateDraftField(editingId, "jobTitle", t);
                          toast({
                            title: "Должность вставлена",
                            description: t,
                          });
                        }
                      }}
                      onKeyDown={(e) => {
                        if ((e.key === "Enter" || e.key === " ") && editingId) {
                          updateDraftField(editingId, "jobTitle", t);
                          toast({
                            title: "Должность вставлена",
                            description: t,
                          });
                        }
                      }}
                    >
                      {t}
                    </div>
                  ))
                )}
              </div>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}

type MaintenanceStatus = inferRPCOutputType<"getMaintenanceStatus">;

function SuperAdminScreen_Alt() {
  const auth = useAuth({ required: true });
  const navigate = useNavigate();
  const { data: me } = useQuery<Profile>(
    ["me"],
    () => apiClient.getMyProfile(),
    { enabled: auth.status === "authenticated" },
  );
  const { data: superStatus } = useQuery(
    ["super-status"],
    () => apiClient.getMySuperStatus(),
    { enabled: auth.status === "authenticated" },
  );

  useEffect(() => {
    if (
      auth.status === "authenticated" &&
      superStatus &&
      !superStatus.isSuperAdmin
    ) {
      navigate("/home");
    }
  }, [auth.status, superStatus, navigate]);

  if (auth.status === "loading") return <div className="p-4">Загрузка…</div>;
  if (superStatus && !superStatus.isSuperAdmin)
    return (
      <div className="p-6 max-w-2xl mx-auto">
        <h1 className="text-xl font-semibold mb-2">Нет доступа</h1>
        <p className="text-muted-foreground">
          У вас нет прав для просмотра этой страницы.
        </p>
      </div>
    );

  return (
    <div className="max-w-6xl mx-auto p-4">
      <h1 className="text-2xl font-bold mb-4">Супер админ-панель</h1>
      <div className="grid gap-4">
        {/* Maintenance (проверка) controls */}
        <Card>
          <CardHeader>
            <CardTitle>Режим проверки (техработы)</CardTitle>
            <CardDescription>
              Включите, чтобы временно ограничить доступ для всех, кроме
              администраторов
            </CardDescription>
          </CardHeader>
          <CardContent>
            <MaintenanceControls />
          </CardContent>
        </Card>
        <Card>
          <CardHeader>
            <CardTitle>Быстрые действия</CardTitle>
            <CardDescription>
              Инструменты главного администратора
            </CardDescription>
          </CardHeader>
            <CardContent className="flex flex-wrap gap-2">
              <Button asChild variant="secondary">
                <NavLink to="/admin">Открыть админку</NavLink>
              </Button>
              <Button asChild>
                <NavLink to="/super-admin/diagnostics">
                  Диагностика приложения
                </NavLink>
              </Button>
              <Button asChild variant="outline">
                <NavLink to="/super-admin/new-assets">Новые активы</NavLink>
              </Button>
              <Button asChild variant="outline">
                <NavLink to="/super-admin/admins">Админы</NavLink>
              </Button>
            </CardContent>        </Card>
      </div>
    </div>
  );
}

function SuperAdminAdminsScreen() {
  const auth = useAuth({ required: true });
  const navigate = useNavigate();
  const { data: superStatus } = useQuery(
    ["super-status"],
    () => apiClient.getMySuperStatus(),
    { enabled: auth.status === "authenticated" },
  );
  const [q, setQ] = React.useState("");
  const [page, setPage] = React.useState(1);
  const pageSize = 20;
  const printRef = React.useRef<HTMLDivElement>(null);
  const handlePrint = () => {
    const w = window.open("", "_blank");
    if (!w) return;
    const title = "Админы";
    const now = new Date().toLocaleString();
    const content = printRef.current?.innerHTML ?? "";
    w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>${title}</title><style>body{font-family:Inter,Arial,sans-serif;padding:16px} table{width:100%;border-collapse:collapse} th,td{border:1px solid #ddd;padding:6px;text-align:left} h1{font-size:18px;margin-bottom:8px}</style></head><body><h1>${title}</h1><div style="font-size:12px;color:#666;margin-bottom:8px">${now}</div>${content}</body></html>`);
    w.document.close();
    w.focus();
    w.print();
  };
  const handleSaveExcel = () => {
    const rows = (users ?? []).map((u: any, idx: number) => ({
      "№": (page - 1) * pageSize + idx + 1,
      "ФИО": u.fullName || u.name || "Без имени",
      "ID№": u.shortId != null ? String(u.shortId).padStart(4, "0") : "",
      "Статус": u.isBlocked ? "Заблокирован" : "Активен",
      "Email": u.email || "",
      "Компания": u.company || "",
      "Админ": u.isAdmin ? "Да" : "Нет",
    }));
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, "Админы");
    XLSX.writeFile(wb, `admins-${new Date().toISOString().slice(0,10)}.xlsx`);
  };
  const handleSavePDF = async () => {
    const el = printRef.current;
    if (!el) return;
    const canvas = await html2canvas(el, { scale: 2 });
    const imgData = canvas.toDataURL("image/png");
    const pdf = new jsPDF("landscape", "pt", "a4");
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const imgWidth = pageWidth;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    let heightLeft = imgHeight;
    let position = 0;
    pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
    heightLeft -= pageHeight;
    while (heightLeft > 0) {
      pdf.addPage();
      position = position - pageHeight;
      pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;
    }
    pdf.save(`admins-${new Date().toISOString().slice(0,10)}.pdf`);
  };
  type ListUsersOut = inferRPCOutputType<"listUsers">;
  const { data, isInitialLoading, refetch, isFetching } = useQuery<ListUsersOut>(
      ["users", page, q],
      () => apiClient.listUsers({ page, pageSize, query: q || undefined }),
      { enabled: !!superStatus?.isSuperAdmin },
    );
  if (auth.status === "loading" || isInitialLoading) {
    return <div className="p-4">Загрузка…</div>;
  }
  if (!superStatus?.isSuperAdmin) {
    return (
      <div className="p-6 max-w-2xl mx-auto">
        <h1 className="text-xl font-semibold mb-2">Нет доступа</h1>
        <p className="text-muted-foreground">Эта страница доступна только супер-администратору.</p>
      </div>
    );
  }

  const users = (data?.items ?? []) as any[];

  return (
    <div className="max-w-6xl mx-auto p-4 space-y-4">
      <div className="flex items-center justify-between gap-2">
        <h1 className="text-2xl font-bold">Админы</h1>
        <div className="flex-1" />
        <div className="hidden sm:flex items-center gap-2">
          <Button variant="outline" onClick={handlePrint}>Печать</Button>
          <Button variant="outline" onClick={handleSavePDF}>Сохранить PDF</Button>
          <Button variant="outline" onClick={handleSaveExcel}>Сохранить Excel</Button>
          <Button variant="outline" onClick={() => { refetch(); }} disabled={isFetching}>{isFetching ? "Обновление…" : "Обновить"}</Button>
        </div>
        <Input
          placeholder="Поиск по ФИО или email"
          value={q}
          onChange={(e) => {
            setQ(e.target.value);
            setPage(1);
          }}
          className="max-w-sm"
        />
      </div>
      <div className="flex sm:hidden items-center gap-2">
        <Button variant="outline" onClick={handlePrint}>Печать</Button>
        <Button variant="outline" onClick={handleSavePDF}>PDF</Button>
        <Button variant="outline" onClick={handleSaveExcel}>Excel</Button>
        <Button variant="outline" onClick={() => { refetch(); }} disabled={isFetching}>{isFetching ? "Обновление…" : "Обновить"}</Button>
      </div>

      <Card className="card-elevated">
        <CardContent ref={printRef} className="p-0">
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead>ФИО</TableHead>
                <TableHead>Email</TableHead>
                <TableHead>Компания</TableHead>
                <TableHead>Админ</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {users.map((u) => (
                <TableRow key={u.id} className="cursor-pointer" onClick={() => navigate(`/super-admin/admins/${u.id}`)}>
                  <TableCell className="font-medium">
                    <div className="text-primary underline">{u.fullName || u.name || "Без имени"}</div>
                    <div className="text-xs text-muted-foreground">ID№ {u.shortId != null ? String(u.shortId).padStart(4, "0") : "—"} • {u.isBlocked ? "Заблокирован" : "Активен"}</div>
                  </TableCell>
                  <TableCell>{u.email || "—"}</TableCell>
                  <TableCell>{u.company || "—"}</TableCell>
                  <TableCell>{u.isAdmin ? "Да" : "Нет"}</TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        </CardContent>
      </Card>

      <div className="flex items-center justify-end gap-2">
        <Button variant="outline" disabled={page <= 1} onClick={() => setPage((p) => Math.max(1, p - 1))}>Назад</Button>
        <div className="text-sm text-muted-foreground">Стр. {page}</div>
        <Button variant="outline" disabled={(users?.length ?? 0) < pageSize} onClick={() => setPage((p) => p + 1)}>Вперед</Button>
      </div>
    </div>
  );
}

function AdminUsersScreen() {
  const auth = useAuth({ required: true });
  const { data: me } = useQuery<Profile>(
    ["me"],
    () => apiClient.getMyProfile(),
    { enabled: auth.status === "authenticated" },
  );
  const isAdmin = !!me?.isAdmin;

  const [search, setSearch] = useState("");
  const [page, setPage] = useState(1);

  type AdminUsersListOut = inferRPCOutputType<"listUsers">;
  const { data, isInitialLoading, isFetching } = useQuery<AdminUsersListOut>(
    ["admin-users-table", search, page],
    () => apiClient.listUsers({ query: search || undefined, page }),
    { enabled: isAdmin },
  );

  const { toast } = useToast();

  if (auth.status === "loading" || isInitialLoading) {
    return <div className="p-4">Загрузка…</div>;
  }

  if (!isAdmin) {
    return (
      <div className="max-w-4xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Доступ ограничен</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Эта страница доступна только администраторам.
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  const usersPage = data as any;
  const users = ((usersPage?.items ?? []) as any[]);

  const currentPage = usersPage?.page ?? page;
  const pageSize = usersPage?.pageSize ?? (users.length || 1);
  const total = usersPage?.total ?? users.length;

  return (
    <div className="max-w-6xl mx-auto p-4 space-y-4">
      <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-3">
        <h1 className="text-2xl font-bold">Пользователи</h1>
        <div className="flex flex-col sm:flex-row gap-2 sm:items-center">
          <Input
            placeholder="Поиск по ФИО, компании или email"
            value={search}
            onChange={(e) => {
              setSearch(e.target.value);
              setPage(1);
            }}
            className="w-full sm:w-64"
          />
          <Button
            variant="secondary"
            disabled={isFetching}
            onClick={async () => {
              try {
                const res = await apiClient.exportUsersExcel();
                if ((res as any)?.url) {
                  window.open((res as any).url as string, "_blank");
                } else {
                  toast({ title: "Не удалось сформировать файл" });
                }
              } catch (e) {
                console.error(e);
                toast({ title: "Ошибка при выгрузке" });
              }
            }}
          >
            Скачать Excel
          </Button>
        </div>
      </div>

      <Card className="card-elevated">
        <CardContent className="p-0">
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead>ID№</TableHead>
                <TableHead>ФИО</TableHead>
                <TableHead>Компания</TableHead>
                <TableHead>Подразделение</TableHead>
                <TableHead>Должность</TableHead>
                <TableHead>E-mail</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {users.map((u) => (
                <TableRow key={u.id}>
                  <TableCell>{u.shortId ?? "—"}</TableCell>
                  <TableCell>{u.fullName || u.name || "—"}</TableCell>
                  <TableCell>{u.company || "—"}</TableCell>
                  <TableCell>{u.department || "—"}</TableCell>
                  <TableCell>{u.jobTitle || "—"}</TableCell>
                  <TableCell>{u.email || "—"}</TableCell>
                </TableRow>
              ))}
              {!users.length && (
                <TableRow>
                  <TableCell colSpan={6} className="text-sm text-muted-foreground text-center py-4">
                    Нет данных
                  </TableCell>
                </TableRow>
              )}
            </TableBody>
          </Table>
        </CardContent>
      </Card>

      <div className="flex justify-between items-center text-sm text-muted-foreground">
        <span>
          Стр. {currentPage} из {Math.max(1, Math.ceil(total / pageSize || 1))}
        </span>
        <div className="flex gap-2">
          <Button
            variant="secondary"
            disabled={currentPage <= 1}
            onClick={() => setPage((p) => Math.max(1, p - 1))}
          >
            Назад
          </Button>
          <Button
            variant="secondary"
            disabled={currentPage * pageSize >= total}
            onClick={() => setPage((p) => p + 1)}
          >
            Вперёд
          </Button>
        </div>
      </div>
    </div>
  );
}

function SuperAdminAdminPermissionsScreen() {
  const auth = useAuth({ required: true });
  const navigate = useNavigate();
  const { userId } = useParams<{ userId: string }>();
  const { data: superStatus } = useQuery(
    ["super-status"],
    () => apiClient.getMySuperStatus(),
    { enabled: auth.status === "authenticated" },
  );

  type UserProfileAdminOut = inferRPCOutputType<"getUserProfileAdmin">;
  const { data: profileData } = useQuery<UserProfileAdminOut | null>(
    ["user-profile-admin", userId],
    () => apiClient.getUserProfileAdmin({ userId: String(userId) }),
    { enabled: !!userId && !!superStatus?.isSuperAdmin },
  );

  type CatalogOut = inferRPCOutputType<"listAdminPermissionCatalog">;
  const { data: catalog } = useQuery<CatalogOut>(
    ["perm-catalog"],
    () => apiClient.listAdminPermissionCatalog(),
    { enabled: !!superStatus?.isSuperAdmin },
  );

  type KeysOut = inferRPCOutputType<"listUserAdminPermissions">;
  const { data: keysOut, refetch } = useQuery<KeysOut>(
    ["user-perms", userId],
    () => apiClient.listUserAdminPermissions({ userId: String(userId) }),
    { enabled: !!userId && !!superStatus?.isSuperAdmin },
  );

  const [selected, setSelected] = React.useState<Set<string>>(new Set());
  useEffect(() => {
    if (keysOut?.keys) setSelected(new Set(keysOut.keys));
  }, [keysOut?.keys]);

  const toggle = (key: string, value?: boolean) => {
    setSelected((prev) => {
      const next = new Set(prev);
      const willSelect = typeof value === "boolean" ? value : !next.has(key);
      if (willSelect) next.add(key);
      else next.delete(key);
      return next;
    });
  };

  const selectCategory = (catId: string, on: boolean) => {
    const cat = catalog?.categories.find((c: any) => c.id === catId);
    if (!cat) return;
    setSelected((prev) => {
      const next = new Set(prev);
      for (const it of cat.items) {
        if (on) next.add(it.key);
        else next.delete(it.key);
      }
      return next;
    });
  };

  const queryClient = useQueryClient();
  const { toast } = useToast();
  const saveMutation = useMutation(apiClient.setUserAdminPermissions, {
    onSuccess: async () => {
      await refetch();
      await queryClient.invalidateQueries({ queryKey: ["user-perms", userId] });
      toast({ title: "Сохранено" });
    },
    onError: () => toast({ title: "Не удалось сохранить" }),
  });

  if (!superStatus?.isSuperAdmin) {
    return (
      <div className="p-6 max-w-2xl mx-auto">
        <h1 className="text-xl font-semibold mb-2">Нет доступа</h1>
        <p className="text-muted-foreground">Эта страница доступна только супер-администратору.</p>
      </div>
    );
  }

  const catList = (catalog as any)?.categories ?? [];

  return (
    <div className="max-w-6xl mx-auto p-4 space-y-4">
      <div className="flex items-center gap-2">
        <Button variant="ghost" onClick={() => navigate(-1)}>Назад</Button>
        <h1 className="text-2xl font-bold">
          Доступы: {profileData?.fullName || profileData?.email || userId}
        </h1>
      </div>

      <Accordion type="multiple" className="space-y-2">
        {catList.map((cat: any) => (
          <AccordionItem value={cat.id} key={cat.id} className="border rounded-md">
            <AccordionTrigger className="px-4">
                <div className="w-full text-left">{cat.title}</div>            </AccordionTrigger>
            <AccordionContent className="px-4 pb-4">
              <div className="flex items-center justify-end gap-2 mb-2">
                <Button size="sm" variant="secondary" onClick={(e) => { e.preventDefault(); selectCategory(cat.id, true); }}>Все</Button>
                <Button size="sm" variant="outline" onClick={(e) => { e.preventDefault(); selectCategory(cat.id, false); }}>Очистить</Button>
              </div>
              <div className="grid gap-2 sm:grid-cols-2">
                {cat.items.map((it: any) => (
                  <label key={it.key} className="flex items-center gap-2 p-2 rounded-md hover:bg-muted cursor-pointer">
                    <Checkbox checked={selected.has(it.key)} onCheckedChange={(v: any) => toggle(it.key, !!v)} />
                    <span className="text-sm">{it.label}</span>
                    <span className="text-xs text-muted-foreground">{it.key}</span>
                  </label>
                ))}
              </div>
            </AccordionContent>
          </AccordionItem>
        ))}
      </Accordion>

      <div className="flex items-center justify-end gap-2">
        <Button
          onClick={() => saveMutation.mutate({ userId: String(userId), keys: Array.from(selected) })}
          disabled={saveMutation.isLoading}
        >
          {saveMutation.isLoading ? "Сохранение…" : "Сохранить"}
        </Button>
      </div>
    </div>
  );
}

export function ProfileSetupScreen() {
  useAuth({ required: true });
  const { toast } = useToast();
  const navigate = useNavigate();
  const queryClient = useQueryClient();
  const [parsed, setParsed] = useState<null | {
    departments: string[];
    items: {
      dept: string;
      title: string;
      audits: number;
      observations: number;
    }[];
  }>(null);
  const [selectedDept, setSelectedDept] = useState<string | null>(null);
  const [uploadedFileId, setUploadedFileId] = useState<string | undefined>(
    undefined,
  );
  const location = useLocation();
  const autoLoadRef = useRef(false);

  type UploadOut = inferRPCOutputType<"uploadProfileSetupFile">;
  const uploadMutation = useMutation(apiClient.uploadProfileSetupFile, {
    onSuccess: (data: UploadOut) => {
      setUploadedFileId((data as any)?.file?.id ?? undefined);
      toast({ title: "Файл загружен" });
    },
    onError: () => toast({ title: "Не удалось загрузить файл" }),
    onSettled: () =>
      queryClient.invalidateQueries({ queryKey: ["profileSetupFiles"] }),
  });

  const saveMutation = useMutation(apiClient.saveProfileSetupImport, {
    onSuccess: () => toast({ title: "Сохранено" }),
    onError: () => toast({ title: "Не удалось сохранить" }),
  });
  const toNumber = (v: any) => {
    const n = Number(
      String(v)
        .replace(/,/, ".")
        .replace(/[^0-9.+-]/g, ""),
    );
    return Number.isFinite(n) ? n : 0;
  };
  const looksLikeDept = (s: string) => /подразд|отдел|цех|служб/i.test(s);
  const looksLikeTitle = (s: string) => /должн|профес/i.test(s);
  const looksLikeAudit = (s: string) => /аудит/i.test(s);
  const looksLikeObs = (s: string) => /наблюд/i.test(s);

  const parseWorkbook = (wb: any) => {
    let items: {
      dept: string;
      title: string;
      audits: number;
      observations: number;
    }[] = [];
    for (const name of wb.SheetNames) {
      const ws = wb.Sheets[name] as XLSX.WorkSheet;
      const arr = XLSX.utils.sheet_to_json(ws, {
        header: 1,
        raw: false,
      }) as any[];
      const rows = (arr || []).map((r: any[]) => r.map((c) => c ?? ""));
      let headerRowIndex = -1;
      let idxDept = -1;
      let idxTitle = -1;
      let idxAudit = -1;
      let idxObs = -1;
      for (let i = 0; i < Math.min(rows.length, 30); i++) {
        const row = rows[i] as string[];
        row.forEach((h, j) => {
          const hh = String(h).toLowerCase();
          if (idxDept === -1 && looksLikeDept(hh)) idxDept = j;
          if (idxTitle === -1 && looksLikeTitle(hh)) idxTitle = j;
          if (idxAudit === -1 && looksLikeAudit(hh)) idxAudit = j;
          if (idxObs === -1 && looksLikeObs(hh)) idxObs = j;
        });
        if (
          idxTitle !== -1 ||
          idxAudit !== -1 ||
          idxObs !== -1 ||
          idxDept !== -1
        ) {
          headerRowIndex = i;
          break;
        }
      }
      if (headerRowIndex === -1) continue;
      for (let r = headerRowIndex + 1; r < rows.length; r++) {
        const row = rows[r] || [];
        const dept =
          String(row[idxDept] ?? "Без подразделения")
            .toString()
            .trim() || "Без подразделения";
        const title = String(row[idxTitle] ?? "")
          .toString()
          .trim();
        if (!title) continue;
        const audits = idxAudit >= 0 ? toNumber(row[idxAudit]) : 0;
        const observations = idxObs >= 0 ? toNumber(row[idxObs]) : 0;
        items.push({ dept, title, audits, observations });
      }
    }
    const departments = Array.from(new Set(items.map((i) => i.dept)));
    setParsed({ departments, items });
    setSelectedDept(departments[0] ?? null);
  };

  const handleFile = async (file?: File) => {
    if (!file) return;
    const base64 = await encodeFileAsBase64DataURL(file);
    if (!base64) {
      toast({
        title: "Файл слишком большой",
        description: "Попробуйте меньший размер",
      });
      return;
    }
    uploadMutation.mutate({ base64, name: file.name });
    try {
      const buf = await file.arrayBuffer();
      const wb = XLSX.read(buf, { type: "array" });
      parseWorkbook(wb);
    } catch {
      toast({ title: "Анализ поддерживается для Excel/CSV" });
    }
  };

  const base64ToBlob = (base64: string, mime = "application/octet-stream") => {
    const byteChars = atob(base64);
    const byteNumbers = new Array(byteChars.length);
    for (let i = 0; i < byteChars.length; i++)
      byteNumbers[i] = byteChars.charCodeAt(i);
    const byteArray = new Uint8Array(byteNumbers);
    return new Blob([byteArray], { type: mime });
  };

  const handleUrl = async (url: string) => {
    try {
      const { base64 } = await apiClient.getFileBase64({ url });
      const nameFromUrl = decodeURIComponent(
        url.split("/").pop() || "import.xlsx",
      );
      const blob = base64ToBlob(
        base64,
        "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
      );
      const file = new File([blob], nameFromUrl, { type: blob.type });
      await handleFile(file);
    } catch (e) {
      toast({
        title: "Не удалось загрузить по ссылке",
        description: "Проверьте доступность ссылки",
      });
    }
  };

  useEffect(() => {
    if (autoLoadRef.current) return;
    const params = new URLSearchParams(location.search);
    const fileUrl = params.get("fileUrl");
    if (fileUrl) {
      autoLoadRef.current = true;
      void handleUrl(fileUrl);
    }
  }, [location.search]);

  const grouped = useMemo(() => {
    if (!parsed || !selectedDept)
      return [] as { title: string; audits: number; observations: number }[];
    const map = new Map<
      string,
      { title: string; audits: number; observations: number }
    >();
    parsed.items
      .filter((i) => i.dept === selectedDept)
      .forEach((i) => {
        const key = i.title;
        const prev = map.get(key) || {
          title: i.title,
          audits: 0,
          observations: 0,
        };
        prev.audits += i.audits;
        prev.observations += i.observations;
        map.set(key, prev);
      });
    return Array.from(map.values()).sort((a, b) =>
      a.title.localeCompare(b.title, "ru"),
    );
  }, [parsed, selectedDept]);

  return (
    <div className="max-w-5xl mx-auto p-4 sm:p-6">
      <Card className="card-elevated">
        <CardHeader className="flex items-center justify-between">
          <CardTitle>Настройка профиля</CardTitle>
          <Button variant="secondary" onClick={() => navigate(-1)}>
            Назад
          </Button>
        </CardHeader>
        <CardContent className="space-y-6">
          <div className="space-y-2">
            <div className="font-medium">
              Загрузите график личных показателей ПАБ
            </div>
            <div className="text-sm text-muted-foreground">
              Поддерживается загрузка любого документа; анализ должностей
              доступен для Excel/CSV.
            </div>
            <div className="flex items-center gap-2">
              <input
                id="profile-setup-file"
                type="file"
                className="hidden"
                onChange={(e) => handleFile(e.target.files?.[0])}
              />
              <Button
                onClick={() =>
                  document.getElementById("profile-setup-file")?.click()
                }
                disabled={uploadMutation.isLoading}
              >
                {uploadMutation.isLoading ? "Загрузка…" : "Выберите файл"}
              </Button>
            </div>
          </div>

          {parsed && (
            <div className="space-y-4">
              <div className="flex flex-wrap gap-2">
                {parsed.departments.map((d) => (
                  <Button
                    key={d}
                    variant={selectedDept === d ? "primary" : "secondary"}
                    size="sm"
                    onClick={() => setSelectedDept(d)}
                  >
                    {d || "Без подразделения"}
                  </Button>
                ))}
              </div>
              <div className="border rounded overflow-auto">
                <table className="min-w-full text-sm">
                  <thead>
                    <tr>
                      <th className="border px-2 py-1 text-left">Должность</th>
                      <th className="border px-2 py-1 text-right">
                        Наблюдения
                      </th>
                      <th className="border px-2 py-1 text-right">Аудиты</th>
                    </tr>
                  </thead>
                  <tbody>
                    {grouped.map((row, idx) => (
                      <tr key={idx}>
                        <td className="border px-2 py-1">{row.title}</td>
                        <td className="border px-2 py-1 text-right">
                          {row.observations}
                        </td>
                        <td className="border px-2 py-1 text-right">
                          {row.audits}
                        </td>
                      </tr>
                    ))}
                    {grouped.length === 0 && (
                      <tr>
                        <td
                          colSpan={3}
                          className="text-muted-foreground px-2 py-3"
                        >
                          Нет данных для выбранного подразделения
                        </td>
                      </tr>
                    )}
                  </tbody>
                </table>
              </div>
              <div className="flex justify-end">
                <Button
                  onClick={() =>
                    parsed &&
                    saveMutation.mutate({
                      departments: parsed.departments,
                      items: parsed.items,
                      fileId: uploadedFileId,
                    })
                  }
                  disabled={saveMutation.isLoading}
                >
                  {saveMutation.isLoading ? "Сохраняем…" : "Сохранить"}
                </Button>
              </div>
            </div>
          )}
        </CardContent>
      </Card>
    </div>
  );
}

function AdminInfoScreen() {
  return (
    <div className="max-w-3xl mx-auto p-4 space-y-4">
      <h1 className="text-2xl font-bold">Информация о переносе приложения</h1>

      <section className="space-y-2">
        <h2 className="text-lg font-semibold">На какой платформе сейчас работает приложение</h2>
        <p className="text-sm text-muted-foreground">
          В настоящий момент приложение работает на платформе Adaptive (облачная инфраструктура, управляемая сервисом adaptive.ai). Все вычисления, хранение данных и авторизация пользователей выполняются в этой среде. При переносе на платформу Российской Федерации потребуется воссоздать эквивалентные компоненты: веб‑интерфейс, серверную часть, базу данных, хранение файлов и систему аутентификации, уже в рамках выбранного российского стека технологий и дата‑центров.
        </p>
      </section>

      <section className="space-y-2">
        <h2 className="text-lg font-semibold">Пошаговая инструкция переноса приложения на платформу РФ</h2>
        <p className="text-sm text-muted-foreground">
          Ниже приведена детализированная пошаговая инструкция переноса. Она описывает общий подход и должна быть адаптирована под ваши внутренние регламенты, требования ИБ и выбранный технологический стек.
        </p>
      </section>

      <ol className="list-decimal list-inside space-y-2 text-sm text-muted-foreground">
        <li>
          Проанализируйте структуру данных и бизнес‑процессы: какие разделы есть в приложении (главная, реестр нарушений, реестр предписаний, личные показатели ПАБ, отчёты, обучение, админ‑панель), какие сущности и таблицы используются, какие отчёты и реестры критичны для ежедневной работы.
        </li>
        <li>
          Составьте перечень интеграций и внешних сервисов (почта, платёжные системы, хранилища файлов, аналитика, рассылки и т.п.) и подберите им аналоги, доступные на платформе Российской Федерации (например, российские облачные провайдеры, платёжные шлюзы, сервисы отправки почты и SMS). Зафиксируйте требования к отказоустойчивости и расположению дата‑центров.
        </li>
        <li>
          Совместно со службой ИБ и юристами определите, какие требования по защите информации, хранению персональных данных, криптографической защите, журналированию действий и доступу к сети Интернет действуют в вашей организации и на целевой платформе. Это определит, какие технологии и сертификаты могут использоваться.
        </li>
        <li>
          Спроектируйте новую целевую архитектуру: выберите тип развёртывания (on‑premise в дата‑центре организации или облако РФ), определите, где будет находиться база данных, серверная логика, веб‑интерфейс. Выберите стек технологий (например, PostgreSQL/MySQL, Java/.NET/Node.js, фронтенд‑фреймворк) с учётом импортозамещения и наличия специалистов.
        </li>
        <li>
          Настройте среду разработки и тестовый контур на новой платформе: создайте репозитории кода, CI/CD‑процессы, пустую базу данных, подготовьте сервис для хостинга веб‑части и серверной логики. Организуйте доступ разработчиков и администраторов через защищённые каналы.
        </li>
        <li>
          Реализуйте основные модули на новой платформе: реестр нарушений, реестр предписаний, личные показатели ПАБ, отчётность, обучение, поддержку и админ‑интерфейс. Опираться можно на текущие пользовательские сценарии: какие фильтры используются, какие поля заполняются, какие отчёты формируются.
        </li>
        <li>
          Подготовьте детальный план миграции данных: какие таблицы и файлы нужно перенести, какие поля сопоставить между старой и новой схемой, какие архивные данные можно оставить только в текущей системе. Определите правила анонимизации или обрезки истории, если это требуется регламентами.
        </li>
        <li>
          Выполните пробную миграцию на тестовом стенде: перенесите ограниченный объём реальных данных, проверьте корректность отчётов, реестров, прав доступа и скорость работы интерфейса. Зафиксируйте все отличия от текущей системы и доработайте логику и схему данных.
        </li>
        <li>
          После успешного тестирования согласуйте план поэтапного запуска новой версии: пилотный запуск на ограниченной группе подразделений, обучение пользователей, параллельная эксплуатация двух систем (при необходимости) и окончательный перевод в промышленную эксплуатацию с фиксированной датой остановки старой системы.
        </li>
        <li>
          Организуйте сопровождение: назначьте ответственное подразделение/подрядчика, опишите процедуры регулярных обновлений, резервного копирования и восстановления, мониторинга производительности и доступности. Настройте процесс обработки инцидентов и канал обратной связи с пользователями.
        </li>
      </ol>
      <p className="text-xs text-muted-foreground">
        В каждой конкретной организации требования и технические ограничения будут отличаться. Перед началом переноса обязательно согласуйте архитектуру и используемые технологии с ответственными за информационную безопасность и ИТ‑службой.
      </p>
    </div>
  );
}

function AdminDiagnosticsScreen() {
  const auth = useAuth({ required: true });
  const navigate = useNavigate();
  const [diagResult, setDiagResult] = React.useState<any | null>(null);

  const diag = useRealtimeMutation(apiClient.runDiagnostics, {
    // no cache invalidations required
    onSuccess: (data) => {
      setDiagResult(data as any);
    },
    onError: (error) => {
      console.error("runDiagnostics mutation error", error);
    },
  });

  const effectiveData = (diag.data as any) ?? diagResult ?? null;

  const progress = Math.max(
    0,
    Math.min(100, Number(effectiveData?.progress ?? 0)),
  );
  const eta = Math.max(0, Number(effectiveData?.etaSeconds ?? 0));
  const steps = effectiveData?.steps as
    | { name: string; status: string; details?: string; durationMs?: number }[]
    | undefined;
  const recs = effectiveData?.recommendations as
    | { id: string; title: string; description: string; action?: string }[]
    | undefined;

  const run = () => {
    console.log("AdminDiagnosticsScreen: run clicked", {
      userId: auth.userId,
    });
    setDiagResult(null);
    diag.mutate({ identifier: auth.userId || undefined } as any);
  };

  const handleAction = async (action?: string) => {
    switch (action) {
      case "reload":
        window.location.reload();
        break;
      case "clearCache":
        try {
          await localforage.clear();
        } catch {}
        window.location.reload();
        break;
      case "openAdmin":
        navigate("/admin");
        break;
      case "openSupport":
        navigate("/support");
        break;
      default:
        break;
    }
  };

  return (
    <div className="max-w-3xl mx-auto p-4">
      <h1 className="text-2xl font-bold mb-4">Диагностика</h1>

      <Card className="mb-4">
        <CardHeader>
          <CardTitle>Проверка системы</CardTitle>
          <CardDescription>
            Запускает фоновую диагностику. Проверка не мешает работе
            пользователей.
          </CardDescription>
        </CardHeader>
        <CardContent className="flex items-center gap-3">
          <Button onClick={run} disabled={diag.isLoading}>
            {diag.isLoading ? "Идёт диагностика…" : "Запустить диагностику"}
          </Button>
          <div className="flex-1">
            <div className="flex items-center justify-between mb-1 text-sm text-muted-foreground">
              <span>{progress}%</span>
              {diag.isLoading && <span>Осталось ~{eta} с</span>}
            </div>
            <Progress value={progress} />
          </div>
        </CardContent>
      </Card>

      {steps && steps.length > 0 && (
        <Card className="mb-4">
          <CardHeader>
            <CardTitle>Шаги проверки</CardTitle>
          </CardHeader>
          <CardContent className="space-y-3">
            {steps.map((s, idx) => (
              <div key={idx} className="p-3 rounded-md border">
                <div className="flex items-center justify-between">
                  <div className="font-medium">{s.name}</div>
                  <Badge
                    variant={
                      s.status === "ok"
                        ? "secondary"
                        : s.status === "warn"
                          ? "default"
                          : s.status === "error"
                            ? "destructive"
                            : "outline"
                    }
                  >
                    {s.status}
                  </Badge>
                </div>
                {s.details && (
                  <div className="text-sm text-muted-foreground mt-1 whitespace-pre-wrap">
                    {s.details}
                  </div>
                )}
              </div>
            ))}
          </CardContent>
        </Card>
      )}

      {recs && recs.length > 0 && (
        <Card>
          <CardHeader>
            <CardTitle>Рекомендации</CardTitle>
            <CardDescription>
              Выполните при необходимости для улучшения стабильности.
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-3">
            {recs.map((r) => (
              <div key={r.id} className="p-3 rounded-md border">
                <div className="font-medium mb-1">{r.title}</div>
                <div className="text-sm text-muted-foreground mb-2">
                  {r.description}
                </div>
                {r.action && r.action !== "none" && (
                  <Button size="sm" onClick={() => handleAction(r.action)}>
                    Выполнить
                  </Button>
                )}
              </div>
            ))}
          </CardContent>
        </Card>
      )}
    </div>
  );
}

function AdminPCAccountingScreen() {
  const auth = useAuth({ required: true });
  const { data: me } = useQuery<Profile>(
    ["me"],
    () => apiClient.getMyProfile(),
    { enabled: auth.status === "authenticated", staleTime: 10_000 },
  );
  const isAdmin = !!me?.isAdmin;

  const { toast } = useToast();

  type AccRow = {
    id: string;
    pcNumber: string;
    date: string;
    department: string;
    remarks: number;
    doneQty?: number;
    inProgressQty?: number;
    overdueQty?: number;
    description: string;
    responsible: string;
    dueDate: string;
    status: string;
    extras?: Record<string, string>;
  };
  const todayISO = new Date(Date.now() - new Date().getTimezoneOffset() * 60000)
    .toISOString()
    .slice(0, 10);

  const [rows, setRows] = React.useState<AccRow[]>([
    {
      id: crypto.randomUUID(),
      pcNumber: "",
      date: todayISO,
      department: "",
      remarks: 0,
      doneQty: 0,
      inProgressQty: 0,
      overdueQty: 0,
      description: "",
      responsible: "",
      dueDate: todayISO,
      status: "В работе",
      extras: {},
    },
  ]);

  // Номер ПК теперь вводится в каждой строке

  const [filter, setFilter] = React.useState<
    "ALL" | "WITH_DESCRIPTION" | "DONE" | "IN_PROGRESS" | "OVERDUE"
  >("ALL");

  // Период фильтрации
  const startOfMonth = React.useMemo(
    () => todayISO.slice(0, 8) + "01",
    [todayISO],
  );
  const [period, setPeriod] = React.useState<{ start: string; end: string }>({
    start: startOfMonth,
    end: todayISO,
  });

  const periodFilter = React.useCallback(
    (r: AccRow) => r.date >= period.start && r.date <= period.end,
    [period],
  );

  const periodRows = React.useMemo(
    () => rows.filter(periodFilter),
    [rows, periodFilter],
  );

  const issuedCount = periodRows.length;
  const remarksCount = periodRows.reduce((sum, r) => sum + (r.remarks ?? 0), 0);
  const remaining = (r: AccRow) =>
    Math.max((r.remarks ?? 0) - (r.doneQty ?? 0), 0);
  const doneCount = periodRows.filter(
    (r) => remaining(r) === 0 && (r.remarks ?? 0) > 0,
  ).length;
  const inProgressCount = periodRows.filter((r) => remaining(r) > 0).length;
  const overdueCount = periodRows.filter(
    (r) => remaining(r) > 0 && r.dueDate < todayISO,
  ).length;

  const filteredRows = React.useMemo(() => {
    const byPeriod = rows.filter(periodFilter);
    switch (filter) {
      case "WITH_DESCRIPTION":
        return byPeriod.filter((r) => (r.remarks ?? 0) > 0);
      case "DONE":
        return byPeriod.filter((r) => r.status === "Устранено");
      case "IN_PROGRESS":
        return byPeriod.filter((r) => r.status === "В работе");
      case "OVERDUE":
        return byPeriod.filter(
          (r) =>
            (r.overdueQty ?? 0) > 0 ||
            r.status === "Просрочено" ||
            (r.dueDate < todayISO && r.status !== "Устранено"),
        );
      default:
        return byPeriod;
    }
  }, [rows, filter, todayISO, periodFilter]);

  const saveMutation = useMutation(apiClient.saveHtmlToStorage);

  // Дополнительные настраиваемые столбцы
  const [extraCols, setExtraCols] = React.useState<string[]>([]);

  const handleSave = async () => {
    try {
      const savedAt = new Date().toISOString();
      await localforage.setItem(
        "pc-accounting",
        JSON.stringify({ rows, savedAt, period }),
      );

      const esc = (s: string) =>
        String(s ?? "").replace(
          /[&<>]/g,
          (ch) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;" })[ch]!,
        );

      // Построение строк таблицы с учетом расширенных колонок
      const rowsHtml = filteredRows
        .map((r, i) => {
          const rem = Math.max((r.remarks ?? 0) - (r.doneQty ?? 0), 0);
          const done = Math.max(Math.min(r.doneQty ?? 0, r.remarks ?? 0), 0);
          const open = rem > 0 ? 1 : 0;
          const overdue = rem > 0 && r.dueDate < todayISO ? 1 : 0;
          return `
                <tr>
                  <td>${i + 1}</td>
                  <td>${esc(r.pcNumber)}</td>
                  <td>${esc(r.date)}</td>
                  <td>${esc(r.dueDate)}</td>
                  <td></td>
                  <td>${esc(r.department)}</td>
                  <td>${esc(String(r.remarks ?? 0))}</td>
                  <td>${done}</td>
                  <td>${open}</td>
                  <td>${overdue}</td>
                  <td>${esc(r.description)}</td>
                  <td>${esc(r.responsible)}</td>
                  <td>${esc(r.status)}</td>
                </tr>`;
        })
        .join("");
      const html = `<!DOCTYPE html><html lang=\"ru\"><head><meta charset=\"utf-8\"/><title>Реестр учета предписаний ПК</title><style>
        body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;padding:16px}
        h1{margin:0 0 8px 0}
        .meta{color:#555;margin-bottom:12px}
        table{border-collapse:collapse;width:100%}
        th,td{border:1px solid #ddd;padding:6px;text-align:left;vertical-align:top}
        th{background:#f5f5f5}
      </style></head><body>
        <h1>Реестр учета предписаний ПК</h1>
        <div class=\"meta\">Период: с ${period.start.split("-").reverse().join(".")} по ${period.end.split("-").reverse().join(".")}</div>
        <div class=\"meta\">Сохранено: ${new Date().toLocaleString("ru-RU")}</div>
        <div class=\"meta\">Выдано предписаний: ${issuedCount}; Количество замечаний: ${remarksCount}; Выполнено: ${doneCount}; В работе: ${inProgressCount}; Просрочено: ${overdueCount}</div>
        <table>
          <thead>
            <tr>
              <th>№ ЭЛ</th><th>№ ПК</th><th>Дата</th><th>Срок устр-я</th><th></th><th>Подразделение</th><th>Выявлено</th><th>Устранено</th><th>В работе</th><th>Просрочено</th><th>Описание</th><th>Ответственный</th><th>Статус</th>
            </tr>
          </thead>
          <tbody>${rowsHtml}</tbody>
        </table>
      </body></html>`;

      await saveMutation.mutateAsync({
        html,
        name: "Реестр_учета_ПК",
        folderName: "Учет ПК",
      });
      toast({
        title: "Сохранено",
        description:
          "Данные сохранены и файл создан в Хранилище (папка «Учет ПК»).",
      });
    } catch (e) {
      toast({
        title: "Не удалось сохранить",
        description: "Попробуйте еще раз или обратитесь к администратору.",
      });
    }
  };

  if (!isAdmin) {
    return (
      <div className="max-w-4xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Доступ ограничен</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Эта страница доступна только администраторам.
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  const addRow = () =>
    setRows((prev) => [
      ...prev,
      {
        id: crypto.randomUUID(),
        pcNumber: "",
        date: todayISO,
        department: "",
        remarks: 0,
        doneQty: 0,
        description: "",
        responsible: "",
        dueDate: todayISO,
        status: "В работе",
        extras: {},
      },
    ]);

  const removeRow = (id: string) =>
    setRows((prev) =>
      prev.length > 1 ? prev.filter((r) => r.id !== id) : prev,
    );

  const updateRow = (id: string, patch: Partial<AccRow>) =>
    setRows((prev) =>
      prev.map((r) => {
        if (r.id !== id) return r;
        const merged: AccRow = { ...r, ...patch };
        // Нормализация числовых значений
        merged.remarks = Number.isFinite(merged.remarks as number)
          ? (merged.remarks ?? 0)
          : 0;
        merged.doneQty = Number.isFinite(merged.doneQty as number)
          ? (merged.doneQty ?? 0)
          : 0;
        // Если вручную выбрали статус "Устранено" — приравниваем устранено к выявлено
        if ("status" in patch && patch.status === "Устранено") {
          merged.doneQty = merged.remarks ?? 0;
        }
        // Автопересчет статуса при изменении ключевых полей
        if (
          !("status" in patch) &&
          ("remarks" in patch || "doneQty" in patch || "dueDate" in patch)
        ) {
          const rem = Math.max(
            (merged.remarks ?? 0) - (merged.doneQty ?? 0),
            0,
          );
          merged.status =
            rem <= 0 && (merged.remarks ?? 0) > 0
              ? "Устранено"
              : merged.dueDate < todayISO
                ? "Просрочено"
                : "В работе";
        }
        return merged;
      }),
    );

  const clearAll = () => {
    if (!confirm("Очистить все строки?")) return;
    setRows((_) => [
      {
        id: crypto.randomUUID(),
        pcNumber: "",
        date: todayISO,
        department: "",
        remarks: 0,
        description: "",
        responsible: "",
        dueDate: todayISO,
        status: "В работе",
        extras: {},
      },
    ]);
    toast({ title: "Таблица очищена" });
  };

  // Дополнительные столбцы (динамические)
  const [extraColumns, setExtraColumns] = React.useState<string[]>([]);

  const AddColumnControlsLegacy = () => {
    return (
      <div className="flex gap-2">
        <Button
          variant="outline"
          onClick={() => {
            const name = prompt(
              "Введите название нового столбца",
              `Доп. поле ${extraColumns.length + 1}`,
            );
            if (!name) return;
            setExtraColumns((prev) =>
              prev.includes(name) ? prev : [...prev, name],
            );
            setRows((prev) =>
              prev.map((r) => ({
                ...r,
                extras: {
                  ...(r.extras ?? {}),
                  [name]: (r.extras ?? {})[name] ?? "",
                },
              })),
            );
          }}
        >
          Добавить столбец
        </Button>
        <Button
          variant="outline"
          onClick={() => {
            if (extraColumns.length === 0) return;
            const idxStr = prompt(
              `Введите номер столбца для удаления (1..${extraColumns.length}) или оставьте пустым для удаления последнего`,
            );
            let idx = extraColumns.length - 1;
            if (idxStr && !Number.isNaN(parseInt(idxStr))) {
              idx = Math.max(
                0,
                Math.min(extraColumns.length - 1, parseInt(idxStr) - 1),
              );
            }
            const name = extraColumns[idx];
            setExtraColumns((prev) => prev.filter((_, i) => i !== idx));
            setRows((prev) =>
              prev.map((r) => {
                const { [name]: _removed, ...rest } = r.extras ?? {};
                return { ...r, extras: rest };
              }),
            );
          }}
        >
          Удалить столбец
        </Button>
      </div>
    );
  };

  const DynamicRegistryTableLegacy = () => {
    return (
      <table className="w-full text-sm">
        <thead>
          <tr className="bg-secondary">
            <th className="px-2 py-2 text-left">№ ЭЛ</th>
            <th className="px-2 py-2 text-left">№ ПК</th>
            <th className="px-2 py-2 text-left">Дата</th>
            <th className="px-2 py-2 text-left">Срок устр-я</th>
            <th className="px-2 py-2 text-left"></th>
            <th className="px-2 py-2 text-left">Подразделение</th>
            <th className="px-2 py-2 text-left">Выявлено</th>
            <th className="px-2 py-2 text-left">Устранено</th>
            <th className="px-2 py-2 text-left">В работе</th>
            <th className="px-2 py-2 text-left">Просрочено</th>
            <th className="px-2 py-2 text-left">Описание</th>
            <th className="px-2 py-2 text-left">Ответственный</th>
            <th className="px-2 py-2 text-left">Статус</th>
            {extraColumns.map((c) => (
              <th key={c} className="px-2 py-2 text-left">
                {c}
              </th>
            ))}
            <th className="px-2 py-2 text-left">Действия</th>
          </tr>
        </thead>
        <tbody>
          {filteredRows.map((r, idx) => {
            const done = r.status === "Устранено" ? 1 : 0;
            const inwork = r.status === "В работе" ? 1 : 0;
            const overdue =
              r.status === "Просрочено" ||
              (r.dueDate < todayISO && r.status !== "Устранено")
                ? 1
                : 0;
            const extras = r.extras ?? {};
            return (
              <tr key={r.id} className="border-t align-top">
                <td className="px-2 py-2 whitespace-nowrap">{idx + 1}</td>
                <td className="px-2 py-2 min-w-[120px]">
                  <Input
                    placeholder="номер"
                    value={r.pcNumber}
                    onChange={(e) =>
                      updateRow(r.id, { pcNumber: e.target.value })
                    }
                  />
                </td>
                <td className="px-2 py-2 min-w-[120px]">
                  <Input
                    type="date"
                    value={r.date}
                    onChange={(e) => updateRow(r.id, { date: e.target.value })}
                  />
                </td>
                <td className="px-2 py-2 min-w-[120px]">
                  <Input
                    type="date"
                    value={r.dueDate}
                    onChange={(e) =>
                      updateRow(r.id, { dueDate: e.target.value })
                    }
                  />
                </td>
                <td className="px-2 py-2 w-4" />
                <td className="px-2 py-2 min-w-[180px]">
                  <Input
                    placeholder="Подразделение"
                    value={r.department}
                    onChange={(e) =>
                      updateRow(r.id, { department: e.target.value })
                    }
                  />
                </td>
                <td className="px-2 py-2 min-w-[120px]">
                  <Input
                    type="number"
                    value={String(r.remarks ?? 0)}
                    onChange={(e) => {
                      const v = parseInt(e.target.value || "0", 10);
                      updateRow(r.id, { remarks: Number.isNaN(v) ? 0 : v });
                    }}
                  />
                </td>
                <td className="px-2 py-2 min-w-[100px]">
                  <Input type="number" value={String(done)} disabled />
                </td>
                <td className="px-2 py-2 min-w-[100px]">
                  <Input type="number" value={String(inwork)} disabled />
                </td>
                <td className="px-2 py-2 min-w-[100px]">
                  <Input type="number" value={String(overdue)} disabled />
                </td>
                <td className="px-2 py-2 min-w-[260px]">
                  <Textarea
                    placeholder="Краткое описание выявленных нарушений"
                    value={r.description}
                    onChange={(e) =>
                      updateRow(r.id, { description: e.target.value })
                    }
                  />
                </td>
                <td className="px-2 py-2 min-w-[180px]">
                  <Input
                    placeholder="Ответственный"
                    value={r.responsible}
                    onChange={(e) =>
                      updateRow(r.id, { responsible: e.target.value })
                    }
                  />
                </td>
                <td className="px-2 py-2 min-w-[160px]">
                  <Select
                    value={r.status}
                    onValueChange={(v) => updateRow(r.id, { status: v })}
                  >
                    <SelectTrigger>
                      <SelectValue placeholder="Статус" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="В работе">В работе</SelectItem>
                      <SelectItem value="Устранено">Устранено</SelectItem>
                      <SelectItem value="Просрочено">Просрочено</SelectItem>
                    </SelectContent>
                  </Select>
                </td>
                {extraColumns.map((name) => (
                  <td key={name} className="px-2 py-2 min-w-[160px]">
                    <Input
                      value={extras[name] ?? ""}
                      onChange={(e) => {
                        const current =
                          rows.find((x) => x.id === r.id)?.extras ?? {};
                        updateRow(r.id, {
                          extras: { ...current, [name]: e.target.value },
                        });
                      }}
                      placeholder={name}
                    />
                  </td>
                ))}
                <td className="px-2 py-2">
                  <Button
                    variant="destructive"
                    size="sm"
                    onClick={() => removeRow(r.id)}
                    disabled={rows.length <= 1}
                  >
                    Удалить
                  </Button>
                </td>
              </tr>
            );
          })}
        </tbody>
      </table>
    );
  };

  return (
    <div className="w-full max-w-[120rem] mx-auto px-4 sm:px-6 space-y-4">
      <Card className="card-elevated h-full">
        <CardHeader className="flex items-center justify-between">
          <CardTitle>Учет ПК</CardTitle>
          <div className="flex gap-2">
            <Button onClick={handleSave} disabled={saveMutation.isLoading}>
              {saveMutation.isLoading ? "Сохранение…" : "Сохранить"}
            </Button>
            <Button variant="outline" onClick={() => window.print?.()}>
              Распечатать
            </Button>
            <Button
              variant="outline"
              onClick={() => {
                const email = prompt("Введите email для отправки реестра:");
                if (email)
                  toast({
                    title: "Отправлено",
                    description: `Реестр будет отправлен на ${email}`,
                  });
              }}
            >
              Отправить
            </Button>
            <Button variant="secondary" onClick={addRow}>
              Добавить строку
            </Button>
            <Button variant="destructive" onClick={clearAll}>
              Очистить
            </Button>
          </div>
        </CardHeader>
        <CardContent className="space-y-3">
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3">
            <button
              type="button"
              className={`flex flex-col items-start gap-1 border rounded-md p-3 transition-colors ${filter === "ALL" ? "bg-accent" : "bg-card hover:bg-accent/50"}`}
              onClick={() => setFilter("ALL")}
            >
              <span className="text-xs text-muted-foreground">
                Выдано предписаний
              </span>
              <span className="text-2xl font-semibold">{issuedCount}</span>
            </button>
            <button
              type="button"
              className={`flex flex-col items-start gap-1 border rounded-md p-3 transition-colors ${filter === "WITH_DESCRIPTION" ? "bg-accent" : "bg-card hover:bg-accent/50"}`}
              onClick={() => setFilter("WITH_DESCRIPTION")}
            >
              <span className="text-xs text-muted-foreground">
                Количество замечаний
              </span>
              <span className="text-2xl font-semibold">{remarksCount}</span>
            </button>
            <button
              type="button"
              className={`flex flex-col items-start gap-1 border rounded-md p-3 transition-colors ${filter === "DONE" ? "bg-accent" : "bg-card hover:bg-accent/50"}`}
              onClick={() => setFilter("DONE")}
            >
              <span className="text-xs text-muted-foreground">Выполнено</span>
              <span className="text-2xl font-semibold text-green-600">
                {doneCount}
              </span>
            </button>
            <button
              type="button"
              className={`flex flex-col items-start gap-1 border rounded-md p-3 transition-colors ${filter === "IN_PROGRESS" ? "bg-accent" : "bg-card hover:bg-accent/50"}`}
              onClick={() => setFilter("IN_PROGRESS")}
            >
              <span className="text-xs text-muted-foreground">В работе</span>
              <span className="text-2xl font-semibold text-blue-600">
                {inProgressCount}
              </span>
            </button>
            <button
              type="button"
              className={`flex flex-col items-start gap-1 border rounded-md p-3 transition-colors ${filter === "OVERDUE" ? "bg-accent" : "bg-card hover:bg-accent/50"}`}
              onClick={() => setFilter("OVERDUE")}
            >
              <span className="text-xs text-muted-foreground">Просрочено</span>
              <span className="text-2xl font-semibold text-red-600">
                {overdueCount}
              </span>
            </button>
          </div>
          <div className="text-sm text-muted-foreground">
            Ведите учет проверок по производственному контролю: добавляйте
            записи, редактируйте поля, отмечайте статус. Нажмите «Сохранить»,
            чтобы зафиксировать текущее состояние: данные сохранятся локально на
            этом устройстве, а в «Хранилище» автоматически создастся папка «Учет
            ПК» с файлом отчета.
          </div>

          {/* Панель управления периодом и столбцами */}
          <div className="flex flex-col gap-3 bg-accent/30 border rounded-md p-3">
            <div className="flex flex-wrap items-center gap-3 justify-between">
              <div className="flex items-center gap-2 flex-wrap">
                <span className="text-sm font-medium">Период с:</span>
                <Input
                  type="date"
                  value={period.start}
                  onChange={(e) =>
                    setPeriod((p) => ({ ...p, start: e.target.value }))
                  }
                  className="w-[160px]"
                />
                <span className="text-sm font-medium">по:</span>
                <Input
                  type="date"
                  value={period.end}
                  onChange={(e) =>
                    setPeriod((p) => ({ ...p, end: e.target.value }))
                  }
                  className="w-[160px]"
                />
              </div>
              <div className="flex flex-wrap gap-2">
                <AddColumnControls />
              </div>
            </div>
          </div>

          <div className="border rounded-md overflow-x-auto">
            <DynamicRegistryTable />
          </div>
        </CardContent>
      </Card>
    </div>
  );

  // --- Вспомогательные локальные компоненты новой таблицы ---
  function AddColumnControls() {
    return (
      <div className="flex gap-2">
        <Button
          variant="secondary"
          onClick={() => {
            const name = prompt("Введите название нового столбца:")?.trim();
            if (!name) return;
            setExtraCols((prev) =>
              prev.includes(name) ? prev : [...prev, name],
            );
            setRows((prev) =>
              prev.map((r) => ({
                ...r,
                extras: { ...(r.extras ?? {}), [name]: r.extras?.[name] ?? "" },
              })),
            );
          }}
        >
          Добавить столбец
        </Button>
        <Button
          variant="destructive"
          onClick={() => {
            if (extraCols.length === 0) return;
            const val = prompt(
              `Введите номер столбца для удаления (1-${extraCols.length}) по дополнительным столбцам:`,
              "1",
            );
            const idx = val ? parseInt(val, 10) : NaN;
            if (!idx || Number.isNaN(idx) || idx < 1 || idx > extraCols.length)
              return;
            const key = extraCols[idx - 1];
            setExtraCols((prev) => prev.filter((_, i) => i !== idx - 1));
            setRows((prev) =>
              prev.map((r) => {
                const { [key]: _omit, ...rest } = r.extras ?? {};
                return { ...r, extras: rest } as AccRow;
              }),
            );
          }}
        >
          Удалить столбец
        </Button>
      </div>
    );
  }

  function DynamicRegistryTable() {
    return (
      <table className="w-full text-sm min-w-[1200px]">
        <thead>
          <tr className="bg-secondary">
            <th className="px-2 py-2 text-left">№ ЭЛ</th>
            <th className="px-2 py-2 text-left">№ ПК</th>
            <th className="px-2 py-2 text-left">Дата</th>
            <th className="px-2 py-2 text-left">Срок устр-я</th>
            <th className="px-2 py-2 text-left w-6"></th>
            <th className="px-2 py-2 text-left">Подразделение</th>
            <th className="px-2 py-2 text-left">Выявлено</th>
            <th className="px-2 py-2 text-left">Устранено</th>
            <th className="px-2 py-2 text-left">В работе</th>
            <th className="px-2 py-2 text-left">Просрочено</th>
            <th className="px-2 py-2 text-left">Описание</th>
            <th className="px-2 py-2 text-left">Ответственный</th>
            <th className="px-2 py-2 text-left">Статус</th>
            {extraCols.map((name) => (
              <th key={name} className="px-2 py-2 text-left">
                {name}
              </th>
            ))}
            <th className="px-2 py-2 text-left">Действия</th>
          </tr>
        </thead>
        <tbody>
          {filteredRows.map((r, idx) => {
            const rem = Math.max((r.remarks ?? 0) - (r.doneQty ?? 0), 0);
            const open = rem > 0 ? 1 : 0;
            const done = Math.max(Math.min(r.doneQty ?? 0, r.remarks ?? 0), 0);
            const overdue = rem > 0 && r.dueDate < todayISO ? 1 : 0;
            return (
              <tr key={r.id} className="border-t align-top">
                <td className="px-2 py-2 whitespace-nowrap">{idx + 1}</td>
                <td className="px-2 py-2 min-w-[120px]">
                  <Input
                    placeholder="номер"
                    value={r.pcNumber}
                    onChange={(e) =>
                      updateRow(r.id, { pcNumber: e.target.value })
                    }
                  />
                </td>
                <td className="px-2 py-2 min-w-[120px]">
                  <Input
                    type="date"
                    value={r.date}
                    onChange={(e) => updateRow(r.id, { date: e.target.value })}
                  />
                </td>
                <td className="px-2 py-2 min-w-[120px]">
                  <Input
                    type="date"
                    value={r.dueDate}
                    onChange={(e) =>
                      updateRow(r.id, { dueDate: e.target.value })
                    }
                  />
                </td>
                <td className="px-2 py-2"></td>
                <td className="px-2 py-2 min-w-[180px]">
                  <Input
                    placeholder="Подразделение"
                    value={r.department}
                    onChange={(e) =>
                      updateRow(r.id, { department: e.target.value })
                    }
                  />
                </td>
                <td className="px-2 py-2 min-w-[100px]">
                  <Input
                    type="number"
                    value={String(r.remarks ?? 0)}
                    onChange={(e) => {
                      const v = parseInt(e.target.value || "0", 10);
                      updateRow(r.id, { remarks: Number.isNaN(v) ? 0 : v });
                    }}
                  />
                </td>
                <td className="px-2 py-2 min-w-[100px]">
                  <Input
                    type="number"
                    value={String(r.doneQty ?? 0)}
                    onChange={(e) => {
                      const v = parseInt(e.target.value || "0", 10);
                      updateRow(r.id, {
                        doneQty: Number.isNaN(v) ? 0 : Math.max(0, v),
                      });
                    }}
                  />
                </td>
                <td className="px-2 py-2 min-w-[100px]">{open}</td>
                <td className="px-2 py-2 min-w-[100px]">{overdue}</td>
                <td className="px-2 py-2 min-w-[260px]">
                  <Textarea
                    placeholder="Краткое описание выявленных нарушений"
                    value={r.description}
                    onChange={(e) =>
                      updateRow(r.id, { description: e.target.value })
                    }
                  />
                </td>
                <td className="px-2 py-2 min-w-[180px]">
                  <Input
                    placeholder="Ответственный"
                    value={r.responsible}
                    onChange={(e) =>
                      updateRow(r.id, { responsible: e.target.value })
                    }
                  />
                </td>
                <td className="px-2 py-2 min-w-[140px]">
                  <Select
                    value={r.status}
                    onValueChange={(v) => updateRow(r.id, { status: v })}
                  >
                    <SelectTrigger>
                      <SelectValue placeholder="Статус" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="В работе">В работе</SelectItem>
                      <SelectItem value="Устранено">Устранено</SelectItem>
                      <SelectItem value="Просрочено">Просрочено</SelectItem>
                    </SelectContent>
                  </Select>
                </td>
                {extraCols.map((name) => (
                  <td key={name} className="px-2 py-2 min-w-[160px]">
                    <Input
                      value={(r.extras?.[name] ?? "") as string}
                      onChange={(e) => {
                        const val = e.target.value;
                        setRows((prev) =>
                          prev.map((row) =>
                            row.id === r.id
                              ? {
                                  ...row,
                                  extras: {
                                    ...(row.extras ?? {}),
                                    [name]: val,
                                  },
                                }
                              : row,
                          ),
                        );
                      }}
                    />
                  </td>
                ))}
                <td className="px-2 py-2">
                  <Button
                    variant="destructive"
                    size="sm"
                    onClick={() => removeRow(r.id)}
                    disabled={rows.length <= 1}
                  >
                    Удалить
                  </Button>
                </td>
              </tr>
            );
          })}
        </tbody>
      </table>
    );
  }
}

function MaintenanceControls() {
  const { data: initial } = useQuery<MaintenanceStatus>(["maintenance"], () =>
    apiClient.getMaintenanceStatus(),
  );
  const [state, setState] = useRealtimeStore<MaintenanceStatus>(
    "app:maintenance",
    initial ?? {
      maintenanceMode: false,
      maintenanceSince: null,
      maintenanceByUserId: null,
    },
  );
  const queryClient = useQueryClient();
  const mutation = useMutation(apiClient.setMaintenanceMode, {
    onSuccess: (res) => {
      setState({
        maintenanceMode: !!res.maintenanceMode,
        maintenanceSince: res.maintenanceSince ?? null,
        maintenanceByUserId: res.maintenanceByUserId ?? null,
      });
      void queryClient.invalidateQueries(["maintenance"]);
    },
  });

  const enabled = !!state?.maintenanceMode;

  return (
    <div className="flex flex-col gap-3">
      <div className="flex items-center gap-3">
        <div
          className={`h-3 w-3 rounded-full ${enabled ? "bg-red-500" : "bg-green-500"}`}
          aria-label={enabled ? "Проверка включена" : "Проверка выключена"}
        />
        <span className="text-sm text-muted-foreground">
          {enabled
            ? "Проверка включена: доступ ограничен для пользователей"
            : "Проверка выключена: доступ открыт"}
        </span>
      </div>
      <div className="flex flex-wrap gap-2">
        <Button
          variant={enabled ? "secondary" : "default"}
          disabled={enabled || mutation.isLoading}
          onClick={() => mutation.mutate({ enabled: true })}
        >
          Включить проверку
        </Button>
        <Button
          variant={!enabled ? "secondary" : "default"}
          disabled={!enabled || mutation.isLoading}
          onClick={() => mutation.mutate({ enabled: false })}
        >
          Выключить проверку
        </Button>
      </div>
    </div>
  );
}

// Early global error suppression before React mounts to stop generic "[object Event]" errors from reaching the platform logger
if (typeof window !== "undefined") {
  const earlyShouldIgnore = (text?: string) =>
    typeof text === "string" &&
    (text.includes("ResizeObserver loop completed") ||
      text.includes("ResizeObserver loop limit exceeded") ||
      text.includes(
        "ResizeObserver loop completed with undelivered notifications",
      ) ||
      text === "[object Event]" ||
      (text ?? "").trim() === "" ||
      text.includes("Failed to fetch") ||
      text.includes("Cannot use 'in' operator to search for 'result' in null"));

  const onEarlyError = (e: any) => {
    const msg: string = e?.message || e?.error?.message || "";
    const isBareEvent = !msg && !e?.error;
    if (isBareEvent || earlyShouldIgnore(msg)) {
      try {
        e.preventDefault?.();
        e.stopPropagation?.();
        e.stopImmediatePropagation?.();
      } catch {}
      console.log("[early window.error:ignored]", {
        msg,
        resourceTag: (e?.target as any)?.tagName,
      });
      return;
    }
  };

  const onEarlyRejection = (event: PromiseRejectionEvent) => {
    const reason: any = event?.reason;
    const msg =
      (reason && typeof reason?.message === "string" && reason.message) ||
      (typeof reason === "string" ? reason : "");
    const isGenericObject =
      reason &&
      typeof reason === "object" &&
      !("message" in reason) &&
      !("stack" in reason);
    if (isGenericObject || !msg || earlyShouldIgnore(msg)) {
      event.preventDefault?.();
      console.log("[early unhandledrejection:ignored]", { msg });
      return;
    }
  };

  try {
    window.addEventListener("error", onEarlyError as EventListener, {
      capture: true,
    });
    window.addEventListener("unhandledrejection", onEarlyRejection);
  } catch {}

  const prevOnError =
    typeof window !== "undefined" ? (window.onerror as any) : null;
  // Returning true from window.onerror tells the browser the error was handled
  // and prevents bubbling to global client error logger
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  (window as any).onerror = function (
    message: any,
    source?: any,
    lineno?: any,
    colno?: any,
    error?: any,
  ): boolean | void {
    const msgText: string | undefined =
      typeof message === "string" ? message : error?.message;
    const isEventString =
      typeof message === "string" && message === "[object Event]";
    const isEmpty = !msgText || msgText.trim() === "";
    if (earlyShouldIgnore(msgText) || isEventString || isEmpty) {
      try {
        console.log("[early window.onerror:ignored]", {
          message,
          source,
          lineno,
          colno,
        });
      } catch {}
      return true;
    }
    if (typeof prevOnError === "function") {
      try {
        return prevOnError(message as any, source, lineno, colno, error) as any;
      } catch {}
    }
    return false;
  } as any;
}

// Filter spammy client-side error logs that arrive as generic Event objects or plain "[object Event]"
(() => {
  try {
    const originalError = console.error;
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    console.error = function patchedConsoleError(...args: any[]) {
      try {
        const isEventObj = (v: any) =>
          v &&
          (v instanceof Event ||
            Object.prototype.toString.call(v) === "[object Event]");
        const hasOnlyEventish =
          args.length > 0 &&
          args.every((a) => isEventObj(a) || a === "[object Event]");
        const first = args[0];
        const firstMsg =
          typeof first === "string"
            ? first
            : (first?.message as string | undefined);
        const isKnownNoise =
          firstMsg === "[object Event]" ||
          !firstMsg ||
          (typeof firstMsg === "string" && firstMsg.trim() === "");
        const failedToFetch =
          typeof firstMsg === "string" && firstMsg.includes("Failed to fetch");
        const inOperatorResultNull = false;
        if (hasOnlyEventish || isKnownNoise || failedToFetch || inOperatorResultNull) {
          // downgrade to info to avoid polluting error logs while keeping minimal trace
          return console.log("[console.error:ignored]", ...args);
        }
      } catch {
        // fallthrough to original on any parsing failure
      }
      return (originalError as any).apply(console, args as any);
    } as any;
  } catch {}
})();

function AdminPCInteractiveEditorScreen() {
  const iframeRef = React.useRef<HTMLIFrameElement | null>(null);
  const { data: latest } = useQuery(
    ["latestInteractiveExcel"],
    () => apiClient.getLatestInteractiveEditorExcel(),
    {
      staleTime: 60 * 1000,
    },
  );
  const { data: latestFileBase64 } = useQuery(
    ["latestInteractiveExcelBase64", latest?.url],
    () => apiClient.getFileBase64({ url: latest!.url! }),
    { enabled: !!latest?.url },
  );

  const saveMutation = useMutation(apiClient.saveInteractiveEditorExcel);

  React.useEffect(() => {
    const onMessage = (e: MessageEvent) => {
      const d: any = e.data;
      if (!d || typeof d !== "object") return;
      if (d.type === "interactive-editor:save") {
        const name = (d.name as string) || "interactive-editor.xlsx";
        const base64 = d.base64 as string;
        saveMutation.mutate({ name, base64 });
      }
    };
    window.addEventListener("message", onMessage);
    return () => window.removeEventListener("message", onMessage);
  }, [saveMutation]);

  React.useEffect(() => {
    if (saveMutation.isSuccess) {
      try {
        iframeRef.current?.contentWindow?.postMessage(
          { type: "interactive-editor:saved" },
          "*",
        );
      } catch {}
    }
  }, [saveMutation.isSuccess]);

  React.useEffect(() => {
    if (latestFileBase64?.base64) {
      try {
        iframeRef.current?.contentWindow?.postMessage(
          {
            type: "interactive-editor:load-file",
            base64: latestFileBase64.base64,
            name: latest?.name || "interactive-editor.xlsx",
          },
          "*",
        );
      } catch {}
    }
  }, [latestFileBase64?.base64, latest?.name]);

  return (
    <div className="max-w-6xl mx-auto p-4 sm:p-6">
      <iframe
        ref={iframeRef}
        title="Интерактивный редактор"
        style={{ width: "100%", height: "80vh", border: 0 }}
        srcDoc={`<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Интерактивный редактор</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/handsontable/dist/handsontable.full.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/handsontable/dist/handsontable.full.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { margin: 0; padding: 20px; background-color: #f5f7fa; color: #333; }
        .container { max-width: 1400px; margin: 0 auto; background-color: white; padding: 25px; border-radius: 10px; box-shadow: 0 0 20px rgba(0, 0, 0, 0.1); }
        .header { text-align: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #2c5aa0; }
        h1 { color: #2c5aa0; margin: 0; font-size: 28px; }
        .subtitle { color: #666; font-size: 16px; margin-top: 5px; }
        .indicators { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 25px; }
        .indicator { background-color: #f8fafd; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #2c5aa0; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .indicator h3 { margin: 0 0 10px 0; font-size: 14px; color: #555; font-weight: 600; }
        .indicator-value { font-size: 24px; font-weight: bold; color: #2c5aa0; }
        .indicator.overdue .indicator-value { color: #e74c3c; }
        .controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px; background-color: #f8fafd; padding: 15px; border-radius: 8px; }
        .file-controls { display: flex; gap: 10px; flex-wrap: wrap; }
        .table-controls { display: flex; gap: 10px; flex-wrap: wrap; }
        button { padding: 10px 18px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: all 0.3s; display: flex; align-items: center; gap: 8px; font-weight: 600; }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); }
        #loadBtn { background-color: #2c5aa0; color: white; }
        #saveBtn { background-color: #27ae60; color: white; }
        #saveAsBtn { background-color: #3498db; color: white; }
        #printBtn { background-color: #e67e22; color: white; }
        #sendBtn { background-color: #9b59b6; color: white; }
        #backBtn { background-color: #95a5a6; color: white; }
        #addRowBtn { background-color: #1abc9c; color: white; }
        #addColBtn { background-color: #f39c12; color: white; }
        #delRowBtn { background-color: #e74c3c; color: white; }
        #delColBtn { background-color: #34495e; color: white; }
        .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; }
        .file-input-wrapper input[type=file] { position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
        .file-input-label { display: inline-block; padding: 10px 18px; background-color: #2c5aa0; color: white; border-radius: 5px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .file-info { margin-top: 10px; font-size: 14px; color: #666; }
        #hot-container { margin-top: 20px; overflow: auto; border: 1px solid #ddd; border-radius: 5px; }
        .status-bar { margin-top: 15px; padding: 10px; background-color: #f8fafd; border-radius: 5px; font-size: 14px; color: #666; display: flex; justify-content: space-between; }
        @media (max-width: 768px) { .controls { flex-direction: column; align-items: flex-start; } .file-controls, .table-controls { width: 100%; justify-content: center; } .indicators { grid-template-columns: repeat(2, 1fr); } }
        @media print { body { background-color: white; padding: 0; } .container { box-shadow: none; padding: 10px; } .controls { display: none; } button { display: none; } .status-bar { display: none; } .indicators { display: none; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-file-excel"></i> Интерактивный редактор</h1>
            <div class="subtitle">Загружайте, редактируйте и сохраняйте Excel файлы с сохранением формул и функций</div>
        </div>
        
        <div class="indicators">
            <div class="indicator">
                <h3>Выдано предписаний</h3>
                <div class="indicator-value" id="indicator-prescriptions">0</div>
            </div>
            <div class="indicator">
                <h3>Замечаний Выявлено</h3>
                <div class="indicator-value" id="indicator-found">0</div>
            </div>
            <div class="indicator">
                <h3>Замечаний Устранено</h3>
                <div class="indicator-value" id="indicator-fixed">0</div>
            </div>
            <div class="indicator">
                <h3>Замечаний В работе</h3>
                <div class="indicator-value" id="indicator-in-progress">0</div>
            </div>
            <div class="indicator overdue">
                <h3>Замечаний ПРОСРОЧЕНО</h3>
                <div class="indicator-value" id="indicator-overdue">0</div>
            </div>
        </div>
        
        <div class="controls">
            <div class="file-controls">
                <div class="file-input-wrapper">
                    <input type="file" id="fileInput" accept=".xlsx, .xls">
                    <label for="fileInput" class="file-input-label"><i class="fas fa-upload"></i> Загрузить Excel</label>
                </div>
                <button id="saveBtn"><i class="fas fa-save"></i> Сохранить</button>
                <button id="saveAsBtn"><i class="fas fa-save"></i> Сохранить как</button>
                <button id="printBtn"><i class="fas fa-print"></i> Печать</button>
                <button id="sendBtn"><i class="fas fa-paper-plane"></i> Отправить</button>
                <button id="backBtn"><i class="fas fa-arrow-left"></i> Назад</button>
            </div>
            
            <div class="table-controls">
                <button id="addRowBtn"><i class="fas fa-plus"></i> Добавить строку</button>
                <button id="addColBtn"><i class="fas fa-columns"></i> Добавить столбец</button>
                <button id="delRowBtn"><i class="fas fa-minus"></i> Удалить строку</button>
                <button id="delColBtn"><i class="fas fa-columns"></i> Удалить столбец</button>
            </div>
        </div>
        
        <div class="file-info" id="fileInfo">Файл не загружен</div>
        
        <div id="hot-container"></div>
        
        <div class="status-bar">
            <div id="cellInfo">Выберите ячейку</div>
            <div id="formulaInfo">Формула: нет</div>
        </div>
    </div>

    <script>
        const container = document.getElementById('hot-container');
        let hot = null;
        let currentData = [];
        let fileName = '';
        let columnMapping = { 'found': -1, 'fixed': -1, 'inProgress': -1, 'overdue': -1, 'dueDate': -1 };

        function initTable(data) {
            if (hot) { hot.destroy(); }
            
            hot = new Handsontable(container, {
                data: data,
                rowHeaders: true,
                colHeaders: true,
                filters: true,
                dropdownMenu: true,
                contextMenu: true,
                manualRowResize: true,
                manualColumnResize: true,
                manualRowMove: true,
                manualColumnMove: true,
                comments: true,
                customBorders: true,
                mergeCells: true,
                licenseKey: 'non-commercial-and-evaluation',
                height: 'auto',
                width: 'auto',
                afterChange: function(changes, source) { if (source === 'loadData') { return; } updateStatusBar(); updateIndicators(); },
                afterSelection: function(r, c, r2, c2) { updateStatusBar(); }
            });
            
            updateStatusBar();
            updateIndicators();
        }

        function updateStatusBar() {
            if (!hot) return;
            
            const selected = hot.getSelected();
            if (selected && selected.length > 0) {
                const s = selected[0];
                const row = s[0], col = s[1];
                const cellInfo = 'Выбрано: ' + (row + 1) + ':' + (col + 1);
                document.getElementById('cellInfo').textContent = cellInfo;
                
                const cellMeta = hot.getCellMeta(row, col);
                if (cellMeta && cellMeta.formula) {
                    document.getElementById('formulaInfo').textContent = 'Формула: ' + cellMeta.formula;
                } else {
                    document.getElementById('formulaInfo').textContent = 'Формула: нет';
                }
            }
        }

        function updateIndicators() {
            if (!hot) return;
            
            const data = hot.getData();
            const headers = data[0] || [];
            
            if (headers.length > 0) {
                columnMapping.found = headers.findIndex(function(h){ return h && h.toString().toLowerCase().includes('выявлено'); });
                columnMapping.fixed = headers.findIndex(function(h){ return h && h.toString().toLowerCase().includes('устранено'); });
                columnMapping.inProgress = headers.findIndex(function(h){ return h && h.toString().toLowerCase().includes('в работе'); });
                columnMapping.overdue = headers.findIndex(function(h){ return h && h.toString().toLowerCase().includes('просрочено'); });
                columnMapping.dueDate = headers.findIndex(function(h){ return h && (h.toString().toLowerCase().includes('срок') || h.toString().toLowerCase().includes('исполнения')); });
            }
            
            let totalPrescriptions = 0;
            let totalFound = 0;
            let totalFixed = 0;
            let totalInProgress = 0;
            let totalOverdue = 0;
            
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (row && row.length > 0 && row.some(function(cell){ return cell !== '' && cell != null; })) {
                    totalPrescriptions++;
                    if (columnMapping.found >= 0 && row[columnMapping.found] !== undefined && row[columnMapping.found] !== '') { totalFound += parseFloat(row[columnMapping.found]) || 0; }
                    if (columnMapping.fixed >= 0 && row[columnMapping.fixed] !== undefined && row[columnMapping.fixed] !== '') { totalFixed += parseFloat(row[columnMapping.fixed]) || 0; }
                    if (columnMapping.inProgress >= 0 && row[columnMapping.inProgress] !== undefined && row[columnMapping.inProgress] !== '') { totalInProgress += parseFloat(row[columnMapping.inProgress]) || 0; }
                    if (columnMapping.overdue >= 0 && row[columnMapping.overdue] !== undefined && row[columnMapping.overdue] !== '') { totalOverdue += parseFloat(row[columnMapping.overdue]) || 0; }
                }
            }
            
            document.getElementById('indicator-prescriptions').textContent = totalPrescriptions;
            document.getElementById('indicator-found').textContent = totalFound;
            document.getElementById('indicator-fixed').textContent = totalFixed;
            document.getElementById('indicator-in-progress').textContent = totalInProgress;
            document.getElementById('indicator-overdue').textContent = totalOverdue;
        }

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            fileName = file.name;
            document.getElementById('fileInfo').textContent = 'Загружен файл: ' + fileName;
            
            const reader = new FileReader();
            reader.onload = function(ev) {
                try {
                    var resAny = (reader && reader.result) ? reader.result : (ev && ev.target ? ev.target.result : null);
                    if (!resAny) { console.warn('FileReader returned empty result'); return; }
                    const data = new Uint8Array(resAny);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    
                    let worksheet = workbook.Sheets['Реестр учета'];
                    if (!worksheet) { worksheet = workbook.Sheets[workbook.SheetNames[0]]; }
                    
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false, dateNF: "dd.mm.yyyy" });
                    
                    let startRowIndex = 0;
                    for (let i = 0; i < jsonData.length; i++) {
                        if (jsonData[i] && jsonData[i][0] === '№ в АСУБТ') { startRowIndex = i; break; }
                    }
                    
                    const tableData = jsonData.slice(startRowIndex);
                    
                    const maxCols = Math.max.apply(null, tableData.map(function(row){ return row.length; }));
                    const filledData = tableData.map(function(row){ while (row.length < maxCols) { row.push(''); } return row; });
                    
                    currentData = filledData;
                    initTable(currentData);
                } catch (e) {
                    console.error('[interactive-excel] Failed to parse file', e);
                }
            };
            reader.readAsArrayBuffer(file);
        });

        document.getElementById('saveBtn').addEventListener('click', function() {
            if (!hot) { alert('Нет данных для сохранения'); return; }
            const data = hot.getData();
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Реестр учета');
            const base64 = XLSX.write(wb, { bookType: 'xlsx', type: 'base64' });
            const payload = { type: 'interactive-editor:save', base64: base64, name: fileName || 'interactive-editor.xlsx' };
            try { window.parent.postMessage(payload, '*'); } catch (e) { console.error(e); }
        });

        document.getElementById('saveAsBtn').addEventListener('click', function() {
            if (!hot) { alert('Нет данных для сохранения'); return; }
            const data = hot.getData();
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Реестр учета');
            const saveName = prompt('Введите имя файла для сохранения:', fileName || 'Реестр учета предписаний');
            if (saveName) {
                const base64 = XLSX.write(wb, { bookType: 'xlsx', type: 'base64' });
                fileName = saveName.endsWith('.xlsx') ? saveName : (saveName + '.xlsx');
                document.getElementById('fileInfo').textContent = 'Текущий файл: ' + fileName;
                try { window.parent.postMessage({ type: 'interactive-editor:save', base64, name: fileName }, '*'); } catch (e) { console.error(e); }
            }
        });

        document.getElementById('printBtn').addEventListener('click', function() { window.print(); });

        document.getElementById('sendBtn').addEventListener('click', function() {
            const email = prompt('Введите email для отправки таблицы:');
            if (email) { alert('Таблица отправлена на адрес: ' + email); }
        });

        document.getElementById('backBtn').addEventListener('click', function() {
            if (confirm('Вы уверены, что хотите вернуться назад? Несохраненные изменения будут потеряны.')) { window.history.back(); }
        });

        document.getElementById('addRowBtn').addEventListener('click', function() {
            if (hot) { hot.alter('insert_row'); updateStatusBar(); updateIndicators(); }
        });

        document.getElementById('addColBtn').addEventListener('click', function() {
            if (hot) { hot.alter('insert_col'); updateStatusBar(); updateIndicators(); }
        });

        document.getElementById('delRowBtn').addEventListener('click', function() {
            if (hot) {
                const selected = hot.getSelected();
                if (selected && selected.length > 0) {
                    const s = selected[0];
                    const row = Math.min(s[0], s[2]);
                    const count = Math.abs(s[2] - s[0]) + 1;
                    hot.alter('remove_row', row, count);
                    updateStatusBar();
                    updateIndicators();
                } else { alert('Выберите строку для удаления'); }
            }
        });

        document.getElementById('delColBtn').addEventListener('click', function() {
            if (hot) {
                const selected = hot.getSelected();
                if (selected && selected.length > 0) {
                    const s = selected[0];
                    const col = Math.min(s[1], s[3]);
                    const count = Math.abs(s[3] - s[1]) + 1;
                    hot.alter('remove_col', col, count);
                    updateStatusBar();
                    updateIndicators();
                } else { alert('Выберите столбец для удаления'); }
            }
        });

        window.addEventListener('message', function(event){
            const d = event.data || {};
            if (d.type === 'interactive-editor:load-file' && d.base64) {
                try {
                    const wb = XLSX.read(d.base64, { type: 'base64', cellDates: true });
                    let ws = wb.Sheets['Реестр учета'];
                    if (!ws) { ws = wb.Sheets[wb.SheetNames[0]]; }
                    const jsonData = XLSX.utils.sheet_to_json(ws, { header: 1, raw: false, dateNF: "dd.mm.yyyy" });
                    const maxCols = Math.max.apply(null, jsonData.map(function(r){ return r.length; }));
                    const filled = jsonData.map(function(r){ while (r.length < maxCols) r.push(''); return r; });
                    currentData = filled;
                    initTable(currentData);
                    fileName = d.name || 'interactive-editor.xlsx';
                    document.getElementById('fileInfo').textContent = 'Загружен файл: ' + fileName;
                } catch(e) { console.error(e); }
            } else if (d.type === 'interactive-editor:saved') {
                try { 
                  const el = document.getElementById('fileInfo');
                  if (el) el.textContent = (fileName ? ('Сохранено: ' + fileName) : 'Сохранено');
                } catch (e) {}
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            const sampleData = [
                ['№ в АСУБТ', '№ документа', 'Выданные АКТы', 'Кол-во замечаний (Выявлено)', 'Кол-во замечаний (Устранено)', 'Кол-во замечаний (В работе не вышел срок)', 'Кол-во замечаний (ПРОСРОЧЕНО)', 'Подразделение', 'Ответственный', 'Дата проверки', 'Срок исполнения', 'Статус'],
                ['', '01-25', 'Предписание (АКТ) № 01-25 от 09.08.2025', 18, 16, 2, 2, 'ПГУ', 'Изварин В.Г.', '2025-08-09', '2025-08-15', ''],
                ['', '02-25', 'Предписание (АКТ) № 02-25 от 09.08.2026', 5, 5, 0, 0, 'ПГУ', 'Изварин В.Г.', '2025-08-16', '2025-08-20', ''],
                ['', '03-25', 'Предписание (АКТ) № 03-25 от 17.08.2025', 8, 0, 8, 8, 'ЗИФ', 'Сафронов В.Ю.', '2025-08-17', '2025-08-21', ''],
                ['', '04-25', 'Предписание (АКТ) № 04-25 от 22.08.2025', 10, 10, 0, 0, 'СГЭ', 'Смирнов В.В.', '2025-08-22', '2025-08-28', ''],
                ['', '05-25', 'Предписание (АКТ) № 05-25 от 19.08.2025', 8, 7, 1, 0, 'ОКС', 'Сорокин Р.Ю.', '2025-08-20', '2025-12-31', ''],
                ['', '06-25', 'Предписание (АКТ) № 06-25 от 24.08.2025', 8, 0, 8, 8, 'ОГМ', 'Арменинов С.М.', '2025-08-18', '2025-08-30', ''],
                ['', '07-25', 'Предписание (АКТ) № 07-25 от 24.08.2025', 12, 0, 12, 12, 'РПО', 'Кишенько С.М.', '2025-08-23', '2025-08-28', ''],
                ['', '08-25', 'Предписание (АКТ) № 08-25 от 29.08.2026', 40, 40, 0, 0, 'СГЭ', 'Смирнов В.В.', '2025-08-26', '2025-09-06', ''],
                ['', '09-25', 'Предписание (АКТ) № 09-25 от 30.08.2025', 19, 18, 1, 1, 'ССУ', 'Егоров В.И.', '2025-09-09', '2025-09-16', ''],
                ['', '10-25', 'Предписание (АКТ) № 10-25 от 01.09.2025', 5, 5, 0, 0, 'ПГУ', 'Изварин В.Г.', '2025-09-01', '2025-09-06', '']
            ];
            
            initTable(sampleData);
            fileName = 'Реестр учета предписаний.xlsx';
            document.getElementById('fileInfo').textContent = 'Загружен файл: ' + fileName;
        });
    </script>
</body>
</html>`}
      />
    </div>
  );
}

function QuickDocConstructorScreen() {
  useAuth({ required: true });
  const navigate = useNavigate();
  const [header, setHeader] = React.useState("");
  const [blocks, setBlocks] = React.useState<string[]>([""]);
  const [footer, setFooter] = React.useState("");
  const assembled = React.useMemo(
    () =>
      [header, ...blocks, footer]
        .filter((s) => (s || "").trim() !== "")
        .join("\n\n"),
    [header, blocks, footer],
  );
  return (
    <div className="max-w-5xl mx-auto p-4 sm:p-6">
      <Card className="card-elevated mb-4">
        <CardHeader>
          <CardTitle>КОНСТРУКТОР документа</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <div className="space-y-4">
              <div className="grid gap-2">
                <Label>Шапка</Label>
                <Textarea
                  rows={3}
                  className="pc-autosize"
                  value={header}
                  onChange={(e) => setHeader(e.target.value)}
                  placeholder="Введите шапку"
                />
              </div>
              <div className="space-y-3">
                <div className="text-sm font-medium">Блоки</div>
                {blocks.map((v, i) => (
                  <div key={i} className="border rounded-md p-3 space-y-2">
                    <Textarea
                      rows={4}
                      className="pc-autosize"
                      value={v}
                      onChange={(e) =>
                        setBlocks((prev) =>
                          prev.map((b, idx) =>
                            idx === i ? e.target.value : b,
                          ),
                        )
                      }
                      placeholder={`Текст блока #${i + 1}`}
                    />
                    <div className="flex gap-2">
                      <Button
                        size="sm"
                        variant="secondary"
                        onClick={() =>
                          setBlocks((prev) =>
                            prev.filter((_, idx) => idx !== i),
                          )
                        }
                        disabled={blocks.length <= 1}
                      >
                        Удалить
                      </Button>
                    </div>
                  </div>
                ))}
                <Button
                  className="btn-3d"
                  onClick={() => setBlocks((prev) => [...prev, ""])}
                >
                  + Добавить блок
                </Button>
              </div>
              <div className="grid gap-2">
                <Label>Подвал</Label>
                <Textarea
                  rows={3}
                  className="pc-autosize"
                  value={footer}
                  onChange={(e) => setFooter(e.target.value)}
                  placeholder="Введите подвал"
                />
              </div>
              <div className="flex flex-wrap gap-2 pt-2">
                <Button variant="secondary" onClick={() => navigate(-1 as any)}>
                  Назад
                </Button>
                <Button
                  className="btn-3d"
                  onClick={() => copy(assembled)}
                  disabled={!assembled}
                >
                  Скопировать итог
                </Button>
              </div>
            </div>
            <div>
              <div className="text-sm font-medium mb-2">Предпросмотр</div>
              <div className="border rounded-md p-4 min-h-[240px] bg-white text-black">
                {assembled ? (
                  <div className="whitespace-pre-wrap">{assembled}</div>
                ) : (
                  <div className="text-xs text-muted-foreground">
                    Добавьте текст — итог появится здесь
                  </div>
                )}
              </div>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}

function DemoHomeScreen() {
  const location = useLocation();
  const params = useMemo(() => new URLSearchParams(location.search), [location.search]);
  const token = params.get("token") || "";

  // Всегда вызывать все хуки в одном и том же порядке на каждом рендере
  const navigate = useNavigate();
  const [selectedPrescFilter, setSelectedPrescFilter] = useState<"all" | "open" | "overdue" | null>(null);
  const [showOnline, setShowOnline] = useState(false);
  const [showOffline, setShowOffline] = useState(false);

  const { data, isInitialLoading } = useQuery(
    ["demo-link", token],
    () => apiClient.resolveGuestDemoLink({ token, consume: true }),
    { enabled: !!token }
  );

  const { data: demo, isInitialLoading: loadingDemo } = useQuery(
    ["demo-home", token],
    () => apiClient.getDemoHomeData(),
    { enabled: !!(token && data?.ok) }
  );

  // Ранние возвраты ниже безопасны, т.к. все хуки уже вызваны выше в фиксированном порядке
  if (!token) {
    return (
      <div className="max-w-3xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated">
          <CardHeader>
            <CardTitle>Демо</CardTitle>
            <CardDescription>Отсутствует токен ссылки.</CardDescription>
          </CardHeader>
          <CardContent>
            <div className="text-sm text-muted-foreground">Проверьте адрес ссылки.</div>
          </CardContent>
        </Card>
      </div>
    );
  }

  if (isInitialLoading) {
    return (
      <div className="max-w-3xl mx-auto p-6 text-sm text-muted-foreground">Проверяем ссылку…</div>
    );
  }

  if (!data?.ok) {
    const map: Record<string, string> = {
      invalid_token: "Неверная ссылка",
      not_found: "Ссылка не найдена",
      disabled: "Ссылка отключена",
      expired: "Срок действия ссылки истёк",
      exhausted: "Лимит входов исчерпан",
      server_error: "Ошибка сервера при проверке",
    };
    return (
      <div className="max-w-3xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated">
          <CardHeader>
            <CardTitle>Демо</CardTitle>
            <CardDescription>Ссылка недоступна</CardDescription>
          </CardHeader>
          <CardContent>
            <div className="text-sm text-muted-foreground">{map[(data as any)?.reason] || "Ссылка недоступна"}</div>
          </CardContent>
        </Card>
      </div>
    );
  }

  if (loadingDemo || !demo) {
    return <div className="max-w-3xl mx-auto p-6 text-sm text-muted-foreground">Загрузка демо-данных…</div>;
  }

  return (
    <div className="min-h-[calc(100vh-3.5rem)]">
      <div className="max-w-5xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated mb-6">
          <CardHeader className="flex items-center justify-between">
            <CardTitle className="text-lg">Мои личные показатели ПАБ</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="flex flex-col sm:flex-row sm:items-center gap-2">
              <div className="text-sm text-muted-foreground">ФИО</div>
              <div className="text-sm font-medium">{demo.profile?.fullName || "—"}</div>
            </div>
            <div className="flex flex-col sm:flex-row sm:items-center gap-2">
              <div className="text-sm text-muted-foreground">Должность</div>
              <div className="text-sm font-medium">{demo.profile?.jobTitle || "—"}</div>
            </div>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
              <div className="p-3 border rounded">
                <div className="text-xs text-muted-foreground">План — Аудиты</div>
                <div className="text-2xl font-semibold">{demo.pabPlan?.planAudits ?? "—"}</div>
              </div>
              <div className="p-3 border rounded">
                <div className="text-xs text-muted-foreground">План — Наблюдения</div>
                <div className="text-2xl font-semibold">{demo.pabPlan?.planObservations ?? "—"}</div>
              </div>
              <button className="p-3 border rounded text-left hover:bg-accent" onClick={() => navigate("/demo/stats")}>
                <div className="text-xs text-muted-foreground">Факт — Аудиты</div>
                <div className="text-2xl font-semibold text-blue-600">{demo.pabFact?.factAudits ?? 0}</div>
              </button>
              <button className="p-3 border rounded text-left hover:bg-accent" onClick={() => navigate("/demo/stats")}>
                <div className="text-xs text-muted-foreground">Факт — Наблюдения</div>
                <div className="text-2xl font-semibold text-blue-600">{demo.pabFact?.factObservations ?? 0}</div>
              </button>
            </div>
          </CardContent>
        </Card>

        <Card className="card-elevated mb-6">
          <CardHeader className="flex items-center justify-between">
            <CardTitle className="text-lg">Мне выписаны предписания</CardTitle>
            <div className="flex gap-2">
              <Button variant="secondary" onClick={() => navigate("/prescriptions")}>Реестр</Button>
              <Button variant="secondary" onClick={() => navigate("/demo/stats")}>Статистика</Button>
            </div>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
              <button className="p-3 border rounded text-left hover:bg-accent" onClick={() => setSelectedPrescFilter((f) => (f === "all" ? null : "all"))}>
                <div className="text-xs text-muted-foreground">Назначено</div>
                <div className="text-2xl font-semibold">{demo.assigned?.totalAssigned ?? 0}</div>
              </button>
              <button className="p-3 border rounded text-left hover:bg-accent" onClick={() => setSelectedPrescFilter((f) => (f === "open" ? null : "open"))}>
                <div className="text-xs text-muted-foreground">В работе</div>
                <div className="text-2xl font-semibold text-blue-600">{demo.assigned?.open ?? 0}</div>
              </button>
              <button
                className={`p-3 border rounded text-left hover:bg-accent ${demo.assigned?.overdue > 0 ? "blink-red-white" : ""}`}
                onClick={() => setSelectedPrescFilter((f) => (f === "overdue" ? null : "overdue"))}
              >
                <div className="text-xs text-muted-foreground">Просрочено</div>
                <div className={`text-2xl font-semibold ${demo.assigned?.overdue > 0 ? "text-red-600" : "text-green-600"}`}>{demo.assigned?.overdue ?? 0}</div>
              </button>
              <div className="p-3 border rounded">
                <div className="text-xs text-muted-foreground">Ближайший срок</div>
                <div className="text-base">{demo.assigned?.nextDue ? new Date(demo.assigned.nextDue).toLocaleDateString("ru-RU") : "—"}</div>
              </div>
            </div>
            {selectedPrescFilter && (
              <div className="mt-4 border rounded p-3">
                <div className="flex items-center justify-between mb-2">
                  <div className="text-sm font-medium">
                    {selectedPrescFilter === "all"
                      ? "Все мои предписания"
                      : selectedPrescFilter === "open"
                      ? "В работе"
                      : "Просроченные"}
                  </div>
                  <Button variant="ghost" onClick={() => setSelectedPrescFilter(null)}>Скрыть</Button>
                </div>
                {(demo.myPrescriptions?.length ?? 0) === 0 ? (
                  <div className="text-sm text-muted-foreground">Ничего не найдено</div>
                ) : (
                  <div className="space-y-2">
                    {demo.myPrescriptions.map((it: any) => (
                      <div key={it.id} className="p-3 rounded border">
                        <div className="flex flex-wrap gap-2 justify-between">
                          <div className="text-sm font-medium">{it.violation?.code ? `№ ${it.violation.code}` : "Без номера"}</div>
                          <div className="text-xs text-muted-foreground">{new Date(it.createdAt).toLocaleDateString("ru-RU")}</div>
                        </div>
                        <div className="mt-1 text-sm">{it.violation?.shop || "—"} · {it.violation?.section || "—"} · {it.violation?.objectInspected || "—"}</div>
                        <div className="mt-1 text-sm line-clamp-2">{it.violation?.description || "Описание отсутствует"}</div>
                        <div className="mt-2 text-xs text-muted-foreground flex gap-4">
                          <span>Выдал(а): {it.violation?.auditor || "—"}</span>
                          <span>Срок: {it.violation?.dueDate ? new Date(it.violation.dueDate).toLocaleDateString("ru-RU") : "—"}</span>
                          <span>Статус: {it.violation?.status || "—"}</span>
                        </div>
                      </div>
                    ))}
                    <div className="pt-1">
                      <Button variant="link" onClick={() => navigate("/prescriptions")}>Перейти в реестр</Button>
                    </div>
                  </div>
                )}
              </div>
            )}
          </CardContent>
        </Card>

        <Card className="card-elevated mb-6">
          <CardHeader className="flex items-center justify-between">
            <CardTitle className="text-lg">Состояние пользователей</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-3">
              <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                <div className="p-3 border rounded">
                  <div className="text-xs text-muted-foreground">Зарегистрировано в системе</div>
                  <div className="text-2xl font-semibold">{demo.presence?.total ?? 0}</div>
                </div>
                <button className="p-3 border rounded text-left hover:bg-accent" onClick={() => setShowOnline((v) => !v)}>
                  <div className="text-xs text-muted-foreground">Онлайн</div>
                  <div className="text-2xl font-semibold text-green-600">{demo.presence?.online ?? 0}</div>
                </button>
                <button className="p-3 border rounded text-left hover:bg-accent" onClick={() => setShowOffline((v) => !v)}>
                  <div className="text-xs text-muted-foreground">Офлайн</div>
                  <div className="text-2xl font-semibold text-muted-foreground">{demo.presence?.offline ?? 0}</div>
                </button>
              </div>
              {showOnline && (
                <div className="border rounded p-3">
                  <div className="text-sm font-medium mb-2">Сейчас онлайн</div>
                  {demo.presence?.onlineUsers?.length ? (
                    <ul className="list-disc pl-5 space-y-1">
                      {demo.presence.onlineUsers.map((u: any) => (
                        <li key={u.id} className="text-sm">{u.name}</li>
                      ))}
                    </ul>
                  ) : (
                    <div className="text-sm text-muted-foreground">Никого нет онлайн</div>
                  )}
                </div>
              )}
              {showOffline && (
                <div className="border rounded p-3">
                  <div className="text-sm font-medium mb-2">Сейчас офлайн</div>
                  {demo.presence?.offlineUsers?.length ? (
                    <ul className="list-disc pl-5 space-y-1">
                      {demo.presence.offlineUsers.map((u: any) => (
                        <li key={u.id} className="text-sm">{u.name}</li>
                      ))}
                    </ul>
                  ) : (
                    <div className="text-sm text-muted-foreground">Все в онлайне</div>
                  )}
                </div>
              )}
            </div>
          </CardContent>
        </Card>

        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 content-start">
          <button
            className="w-full h-24 btn-3d-red text-base font-semibold touch-target flex flex-col items-center justify-center gap-2"
            onClick={() => navigate("/demo/register-violation")}
          >
            Регистрация ПАБ
          </button>
          <button
            className="w-full h-24 btn-3d-red text-base font-semibold touch-target flex flex-col items-center justify-center gap-2"
            onClick={() => navigate("/demo/prod-control")}
          >
            Производственный контроль
          </button>
          <button
            className="w-full h-24 btn-3d text-base font-semibold touch-target flex flex-col items-center justify-center gap-2"
            onClick={() => navigate("/prescriptions")}
          >
            Реестр предписаний
          </button>
          <button
            className="w-full h-24 btn-3d text-base font-semibold touch-target flex flex-col items-center justify-center gap-2"
            onClick={() => navigate("/demo/stats")}
          >
            Статистика нарушений
          </button>
          <button
            className="w-full h-24 btn-3d-brown text-base font-semibold touch-target flex flex-col items-center justify-center gap-2"
            onClick={() => navigate("/demo/support")}
          >
            Служба поддержки
          </button>
          <button
            className="w-full h-24 btn-3d-yellow sm:col-span-2 text-base font-semibold touch-target flex flex-col items-center justify-center gap-2"
            onClick={() => navigate("/demo/support")}
          >
            Дополнительно
          </button>
        </div>
      </div>
    </div>
  );
}

function GuestDemoLinkPanel() {
  const { toast } = useToast();
  const queryClient = useQueryClient();
  const [days, setDays] = useState<string>("7");
  const [uses, setUses] = useState<string>("50");
  const [generatedUrl, setGeneratedUrl] = useState<string>("");

  const createLink = useMutation(apiClient.createGuestDemoLink, {
    onSuccess: (res: { url: string }) => {
      setGeneratedUrl(res.url);
      void queryClient.invalidateQueries({ queryKey: ["guest-links"] });
      toast({ title: "Ссылка создана" });
    },
    onError: () => toast({ title: "Не удалось создать ссылку" }),
  });

  const { data: links, isFetching } = useQuery(
    ["guest-links"],
    () => apiClient.listGuestDemoLinks({ limit: 10 }),
    { staleTime: 30_000 }
  );

  const disableLink = useMutation(apiClient.disableGuestDemoLink, {
    onSuccess: async () => {
      await queryClient.invalidateQueries({ queryKey: ["guest-links"] });
      toast({ title: "Ссылка отключена" });
    },
  });

  return (
    <div className="space-y-3">
      <div className="grid sm:grid-cols-[220px,auto] gap-3 items-center">
        <Label>Срок действия (дней)</Label>
        <div className="flex gap-2">
          <Input
            type="number"
            value={days}
            onChange={(e) => setDays(e.target.value)}
            min={1}
          />
          <Label className="sr-only">Лимит входов</Label>
          <Input
            type="number"
            value={uses}
            onChange={(e) => setUses(e.target.value)}
            min={1}
            placeholder="Лимит входов"
          />
          <Button
            disabled={createLink.isLoading}
            onClick={() => {
              const d = parseInt(days || "0", 10);
              const u = parseInt(uses || "0", 10);
              createLink.mutate({ daysValid: Number.isFinite(d) && d > 0 ? d : undefined, maxUses: Number.isFinite(u) && u > 0 ? u : undefined });
            }}
          >
            {createLink.isLoading ? "Создаём…" : "Создать ссылку"}
          </Button>
        </div>
      </div>
      {generatedUrl && (
        <div className="p-3 border rounded">
          <div className="text-xs text-muted-foreground mb-2">Созданная ссылка</div>
          <div className="flex flex-col sm:flex-row gap-2 sm:items-center">
            <Input value={generatedUrl} readOnly />
            <Button variant="secondary" asChild>
              <a href={generatedUrl} target="_blank" rel="noreferrer">Открыть</a>
            </Button>
            <Button
              variant="secondary"
              onClick={() => {
                copy(generatedUrl);
                toast({ title: "Ссылка скопирована" });
              }}
            >
              Копировать
            </Button>
          </div>
        </div>
      )}

      <div className="space-y-2">
        <div className="font-medium">Последние ссылки</div>
        {isFetching ? (
          <div className="text-sm text-muted-foreground">Загрузка…</div>
        ) : !links?.length ? (
          <div className="text-sm text-muted-foreground">Ссылок пока нет</div>
        ) : (
          <div className="overflow-x-auto">
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>Ссылка</TableHead>
                  <TableHead>Действует до</TableHead>
                  <TableHead>Ост. входов</TableHead>
                  <TableHead>Статус</TableHead>
                  <TableHead></TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {links.map((g: any) => {
                  const url = g.url as string;
                  const rem = g.remainingUses ?? null;
                  const expired = g.expiresAt ? new Date(g.expiresAt).getTime() < Date.now() : false;
                  const status = g.isDisabled ? "Отключена" : expired ? "Истекла" : "Активна";
                  return (
                    <TableRow key={g.token}>
                      <TableCell className="max-w-[240px]">
                        <div className="truncate" title={url}>{url}</div>
                      </TableCell>
                      <TableCell>
                        {g.expiresAt ? new Date(g.expiresAt).toLocaleString("ru-RU") : "—"}
                      </TableCell>
                      <TableCell>{rem === null ? "—" : rem}</TableCell>
                      <TableCell>{status}</TableCell>
                      <TableCell className="text-right">
                        <div className="flex gap-2 justify-end">
                          <Button variant="secondary" size="sm" onClick={() => { copy(url); toast({ title: "Скопировано" }); }}>Копировать</Button>
                          {!g.isDisabled && (
                            <Button
                              variant="destructive"
                              size="sm"
                              onClick={() => disableLink.mutate({ token: g.token as string })}
                            >
                              Отключить
                            </Button>
                          )}
                        </div>
                      </TableCell>
                    </TableRow>
                  );
                })}
              </TableBody>
            </Table>
          </div>
        )}
      </div>
    </div>
  );
}

function DemoRegisterViolationScreen() {
  const navigate = useNavigate();
  const { toast } = useToast();
  const [date, setDate] = useState<string>(() => new Date().toISOString().slice(0, 10));
  const [auditorName, setAuditorName] = useState("");
  const [auditorJobTitle, setAuditorJobTitle] = useState("");
  const [section, setSection] = useState("");
  const [objectInspected, setObjectInspected] = useState("");
  const [description, setDescription] = useState("");
  const [actions, setActions] = useState("");
  const [responsibleName, setResponsibleName] = useState("");
  const [dueDate, setDueDate] = useState("");
  return (
    <div className="max-w-3xl mx-auto p-4 sm:p-6">
      <Card className="card-elevated h-full">
        <CardHeader>
          <CardTitle>Регистрация ПАБ — демо</CardTitle>
          <CardDescription>Можно заполнить поля, сохранение отключено</CardDescription>
        </CardHeader>
        <CardContent className="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div className="space-y-1.5">
            <Label>Дата</Label>
            <Input type="date" value={date} onChange={(e) => setDate(e.target.value)} />
          </div>
          <div className="space-y-1.5">
            <Label>ФИО проверяющего</Label>
            <Input value={auditorName} onChange={(e) => setAuditorName(e.target.value)} placeholder="Иванов Иван Иванович" />
          </div>
          <div className="sm:col-span-2 space-y-1.5">
            <Label>Должность проверяющего</Label>
            <Input value={auditorJobTitle} onChange={(e) => setAuditorJobTitle(e.target.value)} placeholder="Инженер по охране труда" />
          </div>
          <div className="space-y-1.5">
            <Label>Секция</Label>
            <Input value={section} onChange={(e) => setSection(e.target.value)} />
          </div>
          <div className="space-y-1.5">
            <Label>Проверяемый объект</Label>
            <Input value={objectInspected} onChange={(e) => setObjectInspected(e.target.value)} />
          </div>
          <div className="sm:col-span-2 space-y-1.5">
            <Label>Описание наблюдения</Label>
            <Textarea value={description} onChange={(e) => setDescription(e.target.value)} placeholder="Кратко опишите ситуацию…" />
          </div>
          <div className="sm:col-span-2 space-y-1.5">
            <Label>Мероприятия</Label>
            <Textarea value={actions} onChange={(e) => setActions(e.target.value)} placeholder="Что нужно сделать…" />
          </div>
          <div className="space-y-1.5">
            <Label>Ответственный</Label>
            <Input value={responsibleName} onChange={(e) => setResponsibleName(e.target.value)} placeholder="Ф.И.О." />
          </div>
          <div className="space-y-1.5">
            <Label>Срок</Label>
            <Input type="date" value={dueDate} onChange={(e) => setDueDate(e.target.value)} />
          </div>
        </CardContent>
        <CardFooter className="flex gap-2">
          <Button variant="secondary" onClick={() => navigate(-1)}>Назад</Button>
          <Button
            onClick={() => toast({ title: "Сохранение недоступно в демо", description: "Зарегистрируйтесь, чтобы сохранять записи" })}
          >
            Сохранить (демо)
          </Button>
        </CardFooter>
      </Card>
    </div>
  );
}

function DemoProdControlScreen() {
  const navigate = useNavigate();
  const { toast } = useToast();
  const [title, setTitle] = useState("");
  const [place, setPlace] = useState("");
  const [notes, setNotes] = useState("");
  return (
    <div className="max-w-3xl mx-auto p-4 sm:p-6">
      <Card className="card-elevated">
        <CardHeader>
          <CardTitle>Производственный контроль — демо</CardTitle>
          <CardDescription>Можно заполнить поля, сохранение отключено</CardDescription>
        </CardHeader>
        <CardContent className="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div className="space-y-1.5">
            <Label>Наименование проверки</Label>
            <Input value={title} onChange={(e) => setTitle(e.target.value)} placeholder="Например, проверка ППА" />
          </div>
          <div className="space-y-1.5">
            <Label>Место</Label>
            <Input value={place} onChange={(e) => setPlace(e.target.value)} placeholder="Цех/участок" />
          </div>
          <div className="sm:col-span-2 space-y-1.5">
            <Label>Примечания</Label>
            <Textarea value={notes} onChange={(e) => setNotes(e.target.value)} placeholder="Краткие заметки…" />
          </div>
        </CardContent>
        <CardFooter className="flex gap-2">
          <Button variant="secondary" onClick={() => navigate(-1)}>Назад</Button>
          <Button onClick={() => toast({ title: "Сохранение недоступно в демо" })}>Сохранить (демо)</Button>
        </CardFooter>
      </Card>
    </div>
  );
}

function DemoStatsScreen() {
  const { data } = useQuery(["demo-home"], () => apiClient.getDemoHomeData());
  return (
    <div className="max-w-5xl mx-auto p-4 sm:p-6">
      <Card className="card-elevated mb-6">
        <CardHeader>
          <CardTitle className="text-lg">Статистика нарушений — демо</CardTitle>
          <CardDescription>Пример сводных показателей</CardDescription>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
            <div className="p-3 border rounded">
              <div className="text-xs text-muted-foreground">Выдано</div>
              <div className="text-2xl font-semibold">{data?.allStats?.total ?? 0}</div>
            </div>
            <div className="p-3 border rounded">
              <div className="text-xs text-muted-foreground">В работе</div>
              <div className="text-2xl font-semibold text-blue-600">{data?.allStats?.inProgress ?? 0}</div>
            </div>
            <div className="p-3 border rounded">
              <div className="text-xs text-muted-foreground">Устранено</div>
              <div className="text-2xl font-semibold text-green-600">{data?.allStats?.resolved ?? 0}</div>
            </div>
            <div className="p-3 border rounded">
              <div className="text-xs text-muted-foreground">Просрочено</div>
              <div className="text-2xl font-semibold text-muted-foreground">{data?.allStats?.overdue ?? 0}</div>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}

function DemoSupportScreen() {
  return (
    <div className="max-w-3xl mx-auto p-4 sm:p-6">
      <Card className="card-elevated">
        <CardHeader>
          <CardTitle>Служба поддержки — демо</CardTitle>
          <CardDescription>Напишите нам после регистрации, чтобы мы помогли перенести демо в рабочий доступ</CardDescription>
        </CardHeader>
      </Card>
    </div>
  );
}

function SuperAdminNewAssetsScreen() {
  const auth = useAuth({ required: true });
  const navigate = useNavigate();
  const { toast } = useToast();
  const { data: superStatus } = useQuery(
    ["super-status"],
    () => apiClient.getMySuperStatus(),
    { enabled: auth.status === "authenticated" },
  );

  useEffect(() => {
    if (auth.status === "authenticated" && superStatus && !superStatus.isSuperAdmin) {
      navigate("/home");
    }
  }, [auth.status, superStatus, navigate]);



  type Asset = { id: string; name: string; kind: "страница" | "блок"; suggestedPrice: number };
  const defaultAssets: Asset[] = [
    { id: "violations", name: "Реестр нарушений", kind: "страница", suggestedPrice: 900 },
    { id: "stats", name: "Статистика", kind: "страница", suggestedPrice: 700 },
    { id: "prod-control", name: "Производственный контроль", kind: "страница", suggestedPrice: 1200 },
    { id: "support", name: "Поддержка/обращения", kind: "страница", suggestedPrice: 400 },
    { id: "training", name: "Обучение", kind: "страница", suggestedPrice: 800 },
    { id: "pab", name: "ПАБ: инструкции и KPI", kind: "блок", suggestedPrice: 600 },
  ];

  const [clientName, setClientName] = React.useState("");
  const [clientCode, setClientCode] = React.useState("");
  const [clientEmail, setClientEmail] = React.useState("");
  const [selection, setSelection] = React.useState<Record<string, { checked: boolean; price: number }>>(
    Object.fromEntries(defaultAssets.map(a => [a.id, { checked: false, price: a.suggestedPrice }]))
  );

  const [expiryPreset, setExpiryPreset] = React.useState<string>("24h");
  const [customExpiry, setCustomExpiry] = React.useState<string>(""); // ISO from datetime-local
  const [loginLink, setLoginLink] = React.useState<string>("");

  const sendLink = useMutation(apiClient.sendNewClientLoginLink, {
    onSuccess: (res: any) => {
      if (res?.ok) {
        if (res.link) setLoginLink(res.link);
        toast({ title: "Ссылка отправлена", description: "Мы отправили письмо с входом новому клиенту." });
      } else {
        toast({ title: "Не удалось отправить", description: "Проверьте email и попробуйте ещё раз." });
      }
    },
    onError: () => toast({ title: "Ошибка отправки", description: "Попробуйте позже." }),
  });

  const buildExpiryTs = React.useCallback(() => {
    const now = Date.now();
    if (expiryPreset === "custom" && customExpiry) {
      const t = new Date(customExpiry).getTime();
      return isNaN(t) ? now + 24 * 60 * 60 * 1000 : t;
    }
    const map: Record<string, number> = { "24h": 24, "3d": 72, "7d": 168, "30d": 720 };
    const hours = map[expiryPreset] ?? 24;
    return now + hours * 60 * 60 * 1000;
  }, [expiryPreset, customExpiry]);

  const generateLink = React.useCallback(() => {
    const params = new URLSearchParams();
    if (clientCode) params.set("org", clientCode);
    const exp = buildExpiryTs();
    params.set("exp", String(exp));
    const url = new URL(`/welcome?${params.toString()}`, getBaseUrl()).toString();
    setLoginLink(url);
    return url;
  }, [clientCode, buildExpiryTs]);

  const total = Object.entries(selection).reduce((sum, [_id, s]) => sum + (s.checked ? (Number(s.price) || 0) : 0), 0);

  const isSuperLoading = auth.status === "loading" || superStatus === undefined;
  const forbidden = !!(superStatus && !superStatus.isSuperAdmin);
  if (isSuperLoading) return <div className="p-4">Загрузка прав…</div>;
  if (forbidden)
    return (
      <div className="p-6 max-w-2xl mx-auto">
        <h1 className="text-xl font-semibold mb-2">Нет доступа</h1>
        <p className="text-muted-foreground">У вас нет прав для просмотра этой страницы.</p>
      </div>
    );

  return (
    <div className="max-w-5xl mx-auto p-4 space-y-6">
      <div>
        <h1 className="text-2xl font-bold">Новые активы</h1>
        <p className="text-muted-foreground mt-1">Создайте нового клиента и выберите страницы/блоки, которыми он сможет пользоваться без ограничений. Главный администратор задает состав и стоимость.</p>
      </div>

      <Card>
        <CardHeader>
          <CardTitle>Данные клиента</CardTitle>
          <CardDescription>Эта информация появится в настройках выделенного пространства клиента.</CardDescription>
        </CardHeader>
        <CardContent className="grid gap-3 md:grid-cols-3">
          <div className="space-y-2">
            <Label>Название предприятия</Label>
            <Input value={clientName} onChange={(e) => setClientName(e.target.value)} placeholder="ООО «Пример»" />
          </div>
          <div className="space-y-2">
            <Label>Код/ярлык</Label>
            <Input value={clientCode} onChange={(e) => setClientCode(e.target.value)} placeholder="primer" />
          </div>
          <div className="space-y-2">
            <Label>Email для связи</Label>
            <Input type="email" value={clientEmail} onChange={(e) => setClientEmail(e.target.value)} placeholder="admin@company.ru" />
          </div>
        </CardContent>
        <div className="flex justify-end gap-2 px-6 pb-4">
          <CreateClientButtons clientName={clientName} clientCode={clientCode} clientEmail={clientEmail} canCreate={!!superStatus?.isSuperAdmin} />
          <Button
            variant="secondary"
            onClick={() => {
              navigate("/super-admin/clients");
            }}
          >
            К новым клиентам
          </Button>
          <Button variant="outline" asChild>
            <NavLink to={`/super-admin/login-preview?name=${encodeURIComponent(clientName || 'Новый клиент')}&code=${encodeURIComponent(clientCode || '')}`}>Просмотр стр. входа</NavLink>
          </Button>
        </div>
      </Card>

      <div className="flex flex-col gap-3">

        <Card>
          <CardHeader>
            <CardTitle>Пригласительная ссылка</CardTitle>
            <CardDescription>Сформируйте ссылку на вход и отправьте её на email клиента.</CardDescription>
          </CardHeader>
          <CardContent className="grid gap-3 md:grid-cols-3 items-end">
            <div className="space-y-2 md:col-span-1">
              <Label>Срок действия</Label>
              <Select value={expiryPreset} onValueChange={setExpiryPreset}>
                <SelectTrigger>
                  <SelectValue placeholder="Выберите срок" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="24h">24 часа</SelectItem>
                  <SelectItem value="3d">3 дня</SelectItem>
                  <SelectItem value="7d">7 дней</SelectItem>
                  <SelectItem value="30d">30 дней</SelectItem>
                  <SelectItem value="custom">Своя дата/время</SelectItem>
                </SelectContent>
              </Select>
            </div>
            {expiryPreset === "custom" && (
              <div className="space-y-2 md:col-span-1">
                <Label>Выберите дату и время</Label>
                <Input type="datetime-local" value={customExpiry} onChange={(e) => setCustomExpiry(e.target.value)} />
              </div>
            )}
            <div className="flex gap-2 md:col-span-1">
              <Button
                variant="secondary"
                onClick={() => {
                  const url = generateLink();
                  toast({ title: "Ссылка создана", description: "Теперь её можно скопировать или отправить." });
                }}
              >
                Сформировать ссылку
              </Button>
              <Button
                variant="outline"
                onClick={() => {
                  const url = loginLink || generateLink();
                  copy(url);
                  toast({ title: "Скопировано" });
                }}
                disabled={!clientCode && !loginLink}
              >
                Копировать
              </Button>
            </div>

            <div className="md:col-span-3 grid gap-2">
              <Label>Ссылка</Label>
              <div className="flex gap-2">
                <Input value={loginLink} readOnly placeholder="Нажмите «Сформировать ссылку»" />
                <Button asChild variant="link" disabled={!loginLink}>
                  <a href={loginLink || "#"} target="_blank" rel="noreferrer">Открыть</a>
                </Button>
              </div>
            </div>

            <div className="md:col-span-3 flex flex-col md:flex-row gap-2 items-start md:items-center">
              <div className="grow">
                <div className="text-sm text-muted-foreground">Отправить на email: {clientEmail || "—"}</div>
              </div>
              <Button
                onClick={() => {
                  const email = (clientEmail || "").trim();
                  const valid = /\S+@\S+\.\S+/.test(email);
                  if (!valid) {
                    toast({ title: "Некорректный email", description: "Укажите email клиента в поле выше." });
                    return;
                  }
                  sendLink.mutate({
                    email,
                    clientName: clientName || undefined,
                    clientCode: clientCode || undefined,
                    expiresAt: buildExpiryTs(),
                  } as any);
                }}
                disabled={sendLink.isLoading}
              >
                {sendLink.isLoading ? "Отправка…" : "Отправить ссылку"}
              </Button>
            </div>
          </CardContent>
        </Card>
      </div>

      <Card>
        <CardHeader>
          <CardTitle>Страницы и блоки</CardTitle>
          <CardDescription>Отметьте доступные элементы и при необходимости укажите цену.</CardDescription>
        </CardHeader>
        <CardContent className="space-y-3">
          {defaultAssets.map((a) => (
            <div key={a.id} className="flex items-center gap-3">
              <Checkbox
                id={`asset-${a.id}`}
                checked={selection[a.id]?.checked}
                onCheckedChange={(v) =>
                  setSelection((prev) => ({
                    ...prev,
                    [a.id]: { checked: Boolean(v), price: prev[a.id]?.price ?? a.suggestedPrice },
                  }))
                }
              />
              <Label htmlFor={`asset-${a.id}`} className="flex-1">
                {a.name} <span className="text-muted-foreground">({a.kind})</span>
              </Label>
              <div className="w-36">
                <Input
                  type="number"
                  value={selection[a.id]?.price ?? a.suggestedPrice}
                  onChange={(e) =>
                    setSelection((prev) => ({
                      ...prev,
                      [a.id]: { checked: prev[a.id]?.checked ?? false, price: Number(e.target.value) },
                    }))
                  }
                />
              </div>
              <span className="text-sm text-muted-foreground">₽/мес</span>
            </div>
          ))}
        </CardContent>
      </Card>

      <Card>
        <CardHeader>
          <CardTitle>Итоги</CardTitle>
          <CardDescription>Клиент получит безлимитный доступ к отмеченным страницам и блокам.</CardDescription>
        </CardHeader>
        <CardContent className="flex items-center justify-between">
          <div className="text-lg font-semibold">Итого: {(total || 0).toLocaleString("ru-RU")} ₽/мес</div>
          <div className="flex gap-2">
            <Button variant="secondary" asChild>
              <NavLink to="/super-admin">Назад</NavLink>
            </Button>
            <Button disabled title="Сохранение будет доступно после подключения хранилища">Сохранить (скоро)</Button>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}

function SuperAdminLoginPreviewScreen() {
  const auth = useAuth({ required: true });
  const navigate = useNavigate();
  const { toast } = useToast();
  const { data: superStatus } = useQuery(
    ["super-status"],
    () => apiClient.getMySuperStatus(),
    { enabled: auth.status === "authenticated" },
  );
  const location = useLocation();

  useEffect(() => {
    if (auth.status === "authenticated" && superStatus && !superStatus.isSuperAdmin) {
      navigate("/home");
    }
  }, [auth.status, superStatus, navigate]);

  const params = new URLSearchParams(location.search);
  const initialName = params.get("name") || "Новый клиент";
  const code = params.get("code") || "";

  const [name, setName] = React.useState(initialName);
  const [html, setHtml] = React.useState<string>("");

  const { data: existing, isFetching } = useQuery(
    ["client-login-page", code],
    () => apiClient.getClientLoginPage({ orgCode: code }),
    { enabled: auth.status === "authenticated" && !!code }
  );

  useEffect(() => {
    if (existing) {
      if (existing.name) setName(existing.name);
      setHtml(existing.html || "");
    }
    // only run when existing changes
  }, [existing]);

  const save = useMutation(apiClient.upsertClientLoginPage, {
    onSuccess: () => {
      toast({ title: "Сохранено", description: "Страница входа обновлена." });
    },
    onError: () => {
      toast({ title: "Не удалось сохранить", description: "Попробуйте позже." });
    },
  });

  const previewUrl = React.useMemo(() => {
    const sp = new URLSearchParams();
    if (code) sp.set("org", code);
    return `/welcome${sp.toString() ? `?${sp.toString()}` : ""}`;
  }, [code]);

  return (
    <div className="max-w-5xl mx-auto p-4 space-y-4">
      <div>
        <h1 className="text-2xl font-bold">Предпросмотр страницы входа</h1>
        <p className="text-muted-foreground mt-1">
          Вставьте HTML-код, чтобы увидеть, как будет выглядеть страница входа для клиента. Затем сохраните.
        </p>
      </div>

      <Card>
        <CardHeader>
          <CardTitle>{name || "Новый клиент"}</CardTitle>
          <CardDescription>Код/ярлык: {code || "—"}</CardDescription>
        </CardHeader>
        <CardContent className="grid gap-4 md:grid-cols-2">
          <div className="space-y-3">
            <Label>Название (для внутреннего учета)</Label>
            <Input value={name} onChange={(e) => setName(e.target.value)} placeholder="ООО «Пример»" />

            <Label>HTML-код</Label>
            <Textarea
              className="min-h-[260px] font-mono text-sm"
              placeholder="<!DOCTYPE html>\n<div>Ваш HTML здесь…</div>"
              value={html}
              onChange={(e) => setHtml(e.target.value)}
            />
            <div className="flex gap-2">
              <Button
                onClick={() => {
                  if (!code) {
                    toast({ title: "Укажите код клиента", description: "Вернитесь на предыдущий экран и заполните поле Код." });
                    return;
                  }
                  save.mutate({ orgCode: code, name: name || undefined, html });
                }}
                disabled={save.isLoading || !code || !html.trim()}
              >
                {save.isLoading ? "Сохранение…" : "Сохранить"}
              </Button>
              <Button variant="outline" asChild>
                <a href={previewUrl} target="_blank" rel="noreferrer">Открыть /welcome</a>
              </Button>
            </div>
          </div>

          <div className="rounded-lg border p-4 bg-muted/30 overflow-auto">
            <div className="text-sm text-muted-foreground mb-2">Предпросмотр</div>
            {isFetching && !existing ? (
              <div className="text-muted-foreground">Загрузка…</div>
            ) : html.trim() ? (
              <div className="prose max-w-none" dangerouslySetInnerHTML={{ __html: html }} />
            ) : (
              <div className="text-muted-foreground">Вставьте HTML в поле слева — здесь появится предпросмотр.</div>
            )}
          </div>
        </CardContent>
        <CardFooter className="flex gap-2 justify-between">
          <Button variant="secondary" asChild>
            <NavLink to="/super-admin/new-assets">Назад</NavLink>
          </Button>
          <Button variant="outline" asChild>
            <a href="/welcome" target="_blank" rel="noreferrer">Открыть текущую страницу входа</a>
          </Button>
        </CardFooter>
      </Card>
    </div>
  );
}

// ——— Добавлено: кнопка создания клиента и экран настроек клиента ———
function CreateClientButtons({ clientName, clientCode, clientEmail, canCreate }: { clientName: string; clientCode: string; clientEmail: string; canCreate?: boolean; }) {
  const navigate = useNavigate();
  const { toast } = useToast();
  const code = (clientCode || '').trim();
  const name = (clientName || '').trim();
  const email = (clientEmail || '').trim();

  const { data: existing } = useQuery(
    ["client", code],
    () => apiClient.getClient({ code }),
    { enabled: !!code }
  );

  const createClient = useMutation(apiClient.createClient, {
    onSuccess: (c: any) => {
      toast({ title: "Клиент создан" });
      navigate(`/super-admin/client/${encodeURIComponent(c.code)}`);
    },
    onError: (err: any) => {
      const text = typeof err?.message === 'string' ? err.message : '';
      const msg = text.includes("FORBIDDEN") ? "Нет прав" : text.includes("CODE_EXISTS") ? "Код уже занят" : "Не удалось создать";
      toast({ title: msg, description: "Проверьте поля и попробуйте снова." });
    }
  });

  return (
    <div className="flex gap-2">
      <Button
        onClick={() => {
          if (!canCreate) {
            toast({ title: "Нет прав", description: "У вас нет прав на создание клиента." });
            return;
          }
          if (!name || !code) {
            toast({ title: "Заполните название и код" });
            return;
          }
          createClient.mutate({ name, code, email: email || undefined } as any);
        }}
        disabled={!canCreate || createClient.isLoading}
      >
        {createClient.isLoading ? "Создание…" : "Создать"}
      </Button>

      {existing && (
        <Button variant="secondary" onClick={() => navigate(`/super-admin/client/${encodeURIComponent(existing.code)}`)}>
          Настройки клиента
        </Button>
      )}
    </div>
  );
}

function SuperAdminClientSettingsScreen() {
  const auth = useAuth({ required: true });
  const navigate = useNavigate();
  const params = useParams<{ code: string }>();
  const code = (params.code || '').toLowerCase();
  const { data: superStatus } = useQuery(["super-status"], () => apiClient.getMySuperStatus(), { enabled: auth.status === 'authenticated' });
  useEffect(() => {
    if (auth.status === 'authenticated' && superStatus && !superStatus.isSuperAdmin) navigate('/home');
  }, [auth.status, superStatus, navigate]);

  const { data: client, isInitialLoading } = useQuery(["client", code], () => apiClient.getClient({ code }), { enabled: !!code });

  const previewUrl = React.useMemo(() => `/welcome?org=${encodeURIComponent(code)}`, [code]);

  if (isInitialLoading) return <div className="p-4">Загрузка…</div>;
  if (!client) return (
    <div className="p-6 max-w-3xl mx-auto space-y-4">
      <h1 className="text-2xl font-bold">Клиент не найден</h1>
      <Button variant="secondary" asChild><NavLink to="/super-admin/new-assets">Назад</NavLink></Button>
    </div>
  );

  return (
    <div className="max-w-5xl mx-auto p-4 space-y-6">
      <div>
        <h1 className="text-2xl font-bold">Настройки клиента</h1>
        <p className="text-muted-foreground mt-1">Редактируйте страницу входа и управляйте доступными разделами.</p>
      </div>

      <Card>
        <CardHeader>
          <CardTitle>{client.name}</CardTitle>
          <CardDescription>Код: {client.code} • Email: {client.email || '—'}</CardDescription>
        </CardHeader>
        <CardContent className="flex flex-wrap gap-2">
          <Button asChild>
            <NavLink to={`/super-admin/login-preview?name=${encodeURIComponent(client.name)}&code=${encodeURIComponent(client.code)}`}>Редактировать страницу входа</NavLink>
          </Button>
          <Button variant="outline" asChild>
            <a href={previewUrl} target="_blank" rel="noreferrer">Открыть /welcome</a>
          </Button>
          <Button variant="secondary" asChild>
            <NavLink to="/super-admin/new-assets">Выбрать страницы и блоки</NavLink>
          </Button>
        </CardContent>
      </Card>
    </div>
  );
}

function SuperAdminClientsListScreen() {
  const auth = useAuth({ required: true });
  const navigate = useNavigate();
  const { data: superStatus } = useQuery(
    ["super-status"],
    () => apiClient.getMySuperStatus(),
    { enabled: auth.status === "authenticated" },
  );

  useEffect(() => {
    if (auth.status === 'authenticated' && superStatus && !superStatus.isSuperAdmin) {
      navigate('/home');
    }
  }, [auth.status, superStatus, navigate]);

  const [q, setQ] = React.useState("");

  const { data: clients, isInitialLoading, isError } = useQuery(
    ["clients", q],
    () => apiClient.listClients({ query: q.trim() || undefined } as any),
    { enabled: auth.status === 'authenticated' && !!superStatus?.isSuperAdmin }
  );

  if (isInitialLoading) return <div className="p-4">Загрузка…</div>;
  if (isError) return (
    <div className="p-6 max-w-3xl mx-auto space-y-4">
      <h1 className="text-2xl font-bold">Нет доступа</h1>
      <Button variant="secondary" asChild><NavLink to="/super-admin/new-assets">Назад</NavLink></Button>
    </div>
  );

  return (
    <div className="max-w-6xl mx-auto p-4 space-y-6">
      <div className="flex items-center justify-between gap-2">
        <div>
          <h1 className="text-2xl font-bold">Новые клиенты</h1>
          <p className="text-muted-foreground mt-1">Папки всех созданных клиентов</p>
        </div>
        <Button variant="secondary" asChild>
          <NavLink to="/super-admin/new-assets">Создать клиента</NavLink>
        </Button>
      </div>

      <div className="flex gap-2">
        <Input
          placeholder="Поиск по названию, коду, email"
          value={q}
          onChange={(e) => setQ(e.target.value)}
        />
      </div>

      {!clients || (clients as any[]).length === 0 ? (
        <div className="text-muted-foreground">Пока нет клиентов</div>
      ) : (
        <div className="grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
          {(clients as any[]).map((c: any) => (
            <Card key={c.id} className="cursor-pointer hover:bg-accent/50" onClick={() => navigate(`/super-admin/client/${encodeURIComponent(c.code)}`)}>
              <CardHeader className="pb-2">
                <CardTitle className="text-base">{c.name || c.code}</CardTitle>
                <CardDescription>Код: {c.code} • {c.email || '—'}</CardDescription>
              </CardHeader>
              <CardContent className="pt-0 text-sm text-muted-foreground">
                <div>Создан: {new Date(c.createdAt).toLocaleString('ru-RU')}</div>
              </CardContent>
            </Card>
          ))}
        </div>
      )}
    </div>
  );
}

function AssignmentsSummaryPanel({ onOpenList }: { onOpenList?: (type: 'issued' | 'new' | 'completed' | 'inProgress' | 'overdue') => void }) {
  const navigate = useNavigate();
  const { data: tableData, isFetching: statsLoading } = useQuery<any>(
    ["my-assignments-summary-from-table"],
    () => apiClient.getAssignmentsTable(),
    { staleTime: 30_000 }
  );

  const rows = (tableData?.rows ?? []) as string[][];
  const filledRows = rows.filter((r) => Array.isArray(r) && r.some((c) => String(c ?? '').trim() !== ''));

  const parse = (s?: string | null) => {
    const t = (s || '').trim();
    const m = t.match(/^(\d{1,2})[.](\d{1,2})[.](\d{4})$/);
    if (m) {
      const d = new Date(Number(m[3]), Number(m[2]) - 1, Number(m[1]));
      return isNaN(d.getTime()) ? null : d;
    }
    const d = new Date(t);
    return isNaN(d.getTime()) ? null : d;
  };
  const endOfToday = (() => { const d = new Date(); d.setHours(23,59,59,999); return d; })();
  const last7 = (() => { const d = new Date(); d.setDate(d.getDate() - 7); d.setHours(0,0,0,0); return d; })();

  const items = filledRows.map((r) => ({
    dateIssued: r[0] || '',
    description: r[1] || '',
    category: r[2] || '',
    source: r[3] || '',
    responsible: r[4] || '',
    dueDate: r[5] || '',
    status: r[6] || '',
    dateCompleted: r[7] || '',
  }));

  const isCompleted = (it: any) => {
    const s = (it.status || '').toLowerCase();
    return s.includes('выполн') || s.includes('заверш') || Boolean((it.dateCompleted || '').trim());
  };
  const isOverdue = (it: any) => {
    const d = parse(it.dueDate);
    return !isCompleted(it) && !!d && d < endOfToday;
  };
  const isInProgress = (it: any) => !isCompleted(it) && !isOverdue(it);

  const issued = items.length;
  const news = items.filter((it) => { const d = parse(it.dateIssued); return !!d && d >= last7; }).length;
  const completed = items.filter(isCompleted).length;
  const overdue = items.filter(isOverdue).length;
  const inProgress = items.filter(isInProgress).length;

  const Tile = ({ label, value, color, onClick, blink }: { label: string; value: number; color?: string; onClick?: () => void; blink?: boolean }) => (
    <button
      className={`p-3 border rounded text-left hover:bg-accent ${blink ? "blink-red-white" : ""}`}
      onClick={onClick}
    >
      <div className="text-xs text-muted-foreground">{label}</div>
      <div className={`text-2xl font-semibold ${color ?? ""}`}>{statsLoading ? "…" : value}</div>
    </button>
  );

  return (
    <div className="grid grid-cols-2 md:grid-cols-5 gap-3 mb-4">
      <Tile label="Выдано" value={issued} onClick={() => onOpenList ? onOpenList('issued') : navigate("/prescriptions")} />
      <Tile label="Новых" value={news} color="text-blue-600" onClick={() => onOpenList ? onOpenList('new') : navigate("/prescriptions")} />
      <Tile label="Выполнено" value={completed} color="text-green-600" onClick={() => onOpenList ? onOpenList('completed') : navigate("/prescriptions")} />
      <Tile label="В работе" value={inProgress} color="text-blue-600" onClick={() => onOpenList ? onOpenList('inProgress') : navigate("/prescriptions")} />
      <Tile label="Просрочено" value={overdue} blink={overdue > 0} onClick={() => onOpenList ? onOpenList('overdue') : navigate("/prescriptions")} />
    </div>
  );
}

function AssignmentsJournalScreen() {
  useAuth({ required: true });

  const fileInputRef = React.useRef<HTMLInputElement | null>(null);
  const navigate = useNavigate();
  const { isOnline } = useOffline();
  const { toast } = useToast();  const queryClient = useQueryClient();

  type ImportItem = {
    code?: string | null;
    shop?: string | null;
    section?: string | null;
    objectInspected?: string | null;
    description?: string | null;
    auditor?: string | null;
    category?: string | null;
    conditionType?: string | null;
    responsibleName?: string | null;
    dueDate?: string | null;
    status?: string | null;
  };

  const [previewItems, setPreviewItems] = React.useState<ImportItem[]>([]);
  const [htmlDialogOpen, setHtmlDialogOpen] = React.useState(false);
  const [htmlCode, setHtmlCode] = React.useState("");
  const [selectedSavedIds, setSelectedSavedIds] = React.useState<Set<string>>(new Set());
  const [saved, setSaved] = React.useState(false);
  const [selectedRow, setSelectedRow] = React.useState<ImportItem | null>(null);
  const excelInputRef = React.useRef<HTMLInputElement | null>(null);
  const [savedExcelUrl, setSavedExcelUrl] = React.useState<string>("");
  const [listType, setListType] = React.useState<null | 'issued' | 'new' | 'completed' | 'inProgress' | 'overdue'>(null);
  const [selectedEntry, setSelectedEntry] = React.useState<any | null>(null);
  const [supportFileUrl, setSupportFileUrl] = React.useState<string>("");
  const [recipientEmail, setRecipientEmail] = React.useState<string>("");
  const [recipientUserId, setRecipientUserId] = React.useState<string>("");
  const [excelBase64, setExcelBase64] = React.useState<string>("");

  const from7 = React.useMemo(() => {
    const d = new Date();
    d.setDate(d.getDate() - 7);
    const pad = (n: number) => String(n).padStart(2, "0");
    return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
  }, []);

  const { data: usersForSend } = useQuery(['users-for-send'], () => apiClient.searchManagers({ q: '', limit: 500 }), { staleTime: 60_000 });

  const tableQuery = useQuery(['assignmentsTable'], () => apiClient.getAssignmentsTable());

  const displayedItems = React.useMemo(() => {
    const rows = (tableQuery.data?.rows ?? []) as string[][];
    const filled = rows.filter((r) => Array.isArray(r) && r.some((c) => String(c ?? '').trim() !== ''));

    const parse = (s?: string | null) => {
      const t = (s || '').trim();
      const m = t.match(/^(\d{1,2})[.](\d{1,2})[.](\d{4})$/);
      if (m) {
        const d = new Date(Number(m[3]), Number(m[2]) - 1, Number(m[1]));
        return isNaN(d.getTime()) ? null : d;
      }
      const d = new Date(t);
      return isNaN(d.getTime()) ? null : d;
    };
    const endOfToday = (() => { const d = new Date(); d.setHours(23,59,59,999); return d; })();
    const from7d = new Date(from7);

    type TableItem = { id: string; dateIssued?: string; description?: string; category?: string; source?: string; responsible?: string; dueDate?: string; status?: string; dateCompleted?: string; regular?: string; report?: string };

    const items: TableItem[] = filled.map((r, idx) => ({
      id: String(idx),
      dateIssued: r[0] || '',
      description: r[1] || '',
      category: r[2] || '',
      source: r[3] || '',
      responsible: r[4] || '',
      dueDate: r[5] || '',
      status: r[6] || '',
      dateCompleted: r[7] || '',
      regular: r[8] || '',
      report: r[9] || '',
    }));

    const isCompleted = (it: TableItem) => {
      const s = (it.status || '').toLowerCase();
      return s.includes('выполн') || s.includes('заверш') || Boolean((it.dateCompleted || '').trim());
    };
    const isOverdue = (it: TableItem) => {
      const d = parse(it.dueDate);
      return !isCompleted(it) && !!d && d < endOfToday;
    };
    const isInProgress = (it: TableItem) => !isCompleted(it) && !isOverdue(it);

    switch (listType) {
      case 'completed':
        return items.filter((r) => isCompleted(r));
      case 'inProgress':
        return items.filter((r) => isInProgress(r));
      case 'overdue':
        return items.filter((r) => isOverdue(r));
      case 'new':
        return items.filter((r) => { const d = parse(r.dateIssued); return !!d && d >= from7d; });
      case 'issued':
      default:
        return items;
    }
  }, [listType, tableQuery.data, from7]);

  const uploadSupportMutation = useMutation(apiClient.uploadSupportFile, {
    onSuccess: (res: any) => {
      const url = res?.file?.url as string | undefined;
      if (url) {
        setSupportFileUrl(url);
        toast({ title: 'Файл загружен', description: 'Ссылка добавлена в письмо' });
      } else {
        toast({ title: 'Ошибка', description: 'URL файла не получен' });
      }
    },
    onError: () => toast({ title: 'Ошибка загрузки', description: 'Попробуйте другой файл' })
  });

  const sendSupportMutation = useMutation(apiClient.sendSupportFileLink, {
    onSuccess: () => toast({ title: 'Отправлено', description: 'Ссылка отправлена получателю' }),
    onError: () => toast({ title: 'Не удалось отправить', description: 'Проверьте доступ к отправке писем' })
  });
  const [excelFileName, setExcelFileName] = React.useState<string>("");

  function onChooseFile() {
    fileInputRef.current?.click();
  }

  function normalizeKey(k: string) {
    return k.toLowerCase().replace(/[^a-zA-Zа-яА-Я0-9]/g, "");
  }

  // Smart value coercion: detect dates and numbers from Excel/HTML
  function pickField(obj: Record<string, any>, keys: string[]): string | null {
    const isExcelSerialDate = (n: number) => n > 25569 && n < 60000; // ~1970..2130
    const toLocalDate = (d: Date) => d.toString() === "Invalid Date" ? null : d.toLocaleDateString();
    const parseDateLikeString = (s: string): string | null => {
      const t = s.trim();
      // yyyy-mm-dd or yyyy/mm/dd
      if (/^\d{4}[-\/]\d{2}[-\/]\d{2}$/.test(t)) {
        const d = new Date(t);
        const out = toLocalDate(d);
        return out ?? t;
      }
      // dd.mm.yyyy
      const m = t.match(/^(\d{2})[.](\d{2})[.](\d{4})$/);
      if (m) {
        const d = new Date(Number(m[3]), Number(m[2]) - 1, Number(m[1]));
        const out = toLocalDate(d);
        return out ?? t;
      }
      return null;
    };

    const coerce = (v: any): string | null => {
      if (v === undefined || v === null) return null;
      if (v instanceof Date) {
        const out = toLocalDate(v);
        return out ?? String(v);
      }
      if (typeof v === "number") {
        if (isExcelSerialDate(v)) {
          const ms = (v - 25569) * 86400 * 1000; // Excel serial to JS time (UTC)
          const out = toLocalDate(new Date(ms));
          return out ?? String(v);
        }
        return String(v);
      }
      const s = String(v).trim();
      // If pure digits, check as possible Excel serial date too
      if (/^\d{5}$/.test(s)) {
        const n = Number(s);
        if (isExcelSerialDate(n)) {
          const ms = (n - 25569) * 86400 * 1000;
          const out = toLocalDate(new Date(ms));
          if (out) return out;
        }
      }
      const maybeDate = parseDateLikeString(s);
      return maybeDate ?? s;
    };

    for (const k of Object.keys(obj)) {
      const nk = normalizeKey(k);
      if (keys.includes(nk)) {
        return coerce(obj[k]);
      }
    }
    return null;
  }

  function mapRowToItem(row: Record<string, any>): ImportItem {
    const m = {
      code: ["код", "code"],
      shop: ["цех", "shop"],
      section: ["участок", "section"],
      objectInspected: ["объект", "объектпроверки", "object", "objectinspected"],
      description: ["описание", "описаниепоручения", "задание", "assignment", "description"],
      auditor: ["проверяющий", "инициатор", "auditor"],
      category: ["категория", "category"],
      conditionType: ["виднарушения", "type", "conditiontype"],
      responsibleName: ["ответственный", "фио", "responsible", "responsiblename"],
      dueDate: ["срок", "срокисполнения", "duedate", "deadline", "дата"],
      status: ["статус", "status"],
    } as const;

    const mapped: ImportItem = {
      code: pickField(row, m.code.map(normalizeKey)),
      shop: pickField(row, m.shop.map(normalizeKey)),
      section: pickField(row, m.section.map(normalizeKey)),
      objectInspected: pickField(row, m.objectInspected.map(normalizeKey)),
      description: pickField(row, m.description.map(normalizeKey)),
      auditor: pickField(row, m.auditor.map(normalizeKey)),
      category: pickField(row, m.category.map(normalizeKey)),
      conditionType: pickField(row, m.conditionType.map(normalizeKey)),
      responsibleName: pickField(row, m.responsibleName.map(normalizeKey)),
      dueDate: pickField(row, m.dueDate.map(normalizeKey)),
      status: pickField(row, m.status.map(normalizeKey)),
    };

    return mapped;
  }

  function mapSavedToItem(v: any): ImportItem {
    return {
      code: v?.code ?? null,
      shop: v?.shop ?? null,
      section: v?.section ?? null,
      objectInspected: v?.objectInspected ?? null,
      description: v?.description ?? null,
      auditor: v?.auditor ?? null,
      category: v?.category ?? null,
      conditionType: v?.conditionType ?? null,
      responsibleName: v?.responsibleName ?? null,
      dueDate: v?.dueDate ? new Date(v.dueDate).toLocaleDateString() : null,
      status: v?.status ?? null,
    };
  }

  async function parseHtmlString(text: string): Promise<ImportItem[]> {
    try {
      const parser = new DOMParser();
      const doc = parser.parseFromString(text, "text/html");
      const table = doc.querySelector("table");
      if (!table) return [];

      const headRow = table.querySelector("thead tr") || table.querySelector("tr");
      const headerCells = headRow ? Array.from(headRow.querySelectorAll("th,td")) : [];
      const headers = headerCells.map((c) => (c.textContent || "").trim());

      const bodyRows = Array.from(table.querySelectorAll("tbody tr"));
      const rows = bodyRows.length
        ? bodyRows
        : Array.from(table.querySelectorAll("tr")).slice(1);

      const plainRows: Array<Record<string, string>> = rows.map((row) => {
        const cells = Array.from(row.querySelectorAll("td,th"));
        const obj: Record<string, string> = {};
        cells.forEach((cell, idx) => {
          const key = headers[idx] ?? `col${idx + 1}`;
          obj[key] = (cell.textContent || "").trim();
        });
        return obj;
      });

      return plainRows
        .map(mapRowToItem)
        .filter((it) => Object.values(it).some(Boolean));
    } catch {
      return [];
    }
  }

  async function parseFile(file: File): Promise<ImportItem[]> {
    const name = file.name.toLowerCase();
    const isExcel = name.endsWith(".xlsx") || name.endsWith(".xls");
    const isJson = name.endsWith(".json");
    const isHtml = name.endsWith(".html") || name.endsWith(".htm");

    if (isExcel) {
      const buf = await file.arrayBuffer();
      const wb = XLSX.read(buf, { type: "array", cellDates: true });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json<Record<string, any>>(ws, {
        raw: false,
        defval: null,
        dateNF: "yyyy-mm-dd",
      });
      return rows.map(mapRowToItem).filter((it) => Object.values(it).some(Boolean));
    }

    const text = await file.text();
    if (isJson) {
      try {
        const data = JSON.parse(text) as unknown as Array<Record<string, any>>;
        if (Array.isArray(data)) {
          return data.map(mapRowToItem).filter((it) => Object.values(it).some(Boolean));
        }
      } catch (e) {
        /* ignore and fallback */
      }
    }

    if (isHtml) {
      const items = await parseHtmlString(text);
      return items;
    }

    // CSV/TSV/TXT via XLSX
    const wb = XLSX.read(text, { type: "string" });
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json<Record<string, any>>(ws, {
      raw: false,
      defval: null,
    });
    return rows.map(mapRowToItem).filter((it) => Object.values(it).some(Boolean));
  }

  async function handleFile(file: File) {
    try {
      const name = file.name.toLowerCase();
      const allowed = [".xlsx", ".xls", ".csv", ".tsv", ".json", ".txt", ".html", ".htm"];
      const ok = allowed.some((ext) => name.endsWith(ext));
      if (!ok) {
        toast({ title: "Неподдерживаемый формат", description: "Используйте Excel, CSV/TSV/TXT, JSON или HTML" });
        return;
      }

      const items = await parseFile(file);
      if (!items.length) {
        toast({ title: "Данные не найдены", description: "Проверьте содержимое файла" });
        setPreviewItems([]);
        setSaved(false);
        return;
      }
      setPreviewItems(items);
      setSaved(false);
      toast({ title: "Файл загружен", description: `Найдено записей: ${items.length}` });
    } catch {
      toast({ title: "Ошибка чтения файла", description: "Попробуйте другой файл" });
    }
  }

  const saveMutation = useMutation(apiClient.importAssignments, {
    onSuccess: (res) => {
      setSaved(true);
      toast({ title: "Сохранено", description: `Создано записей: ${(res as any)?.created ?? 0}` });
      void queryClient.invalidateQueries(['prescriptionRegister']);
    },
    onError: () => {
      toast({ title: "Ошибка сохранения", description: "Попробуйте ещё раз" });
    },
  });

  const savedQuery = useQuery(['prescriptionRegister'], () => apiClient.listPrescriptionRegister({ page: 1, pageSize: 200 }));

  const deleteSavedMutation = useMutation(apiClient.deletePrescriptionRegisterEntries, {
    onSuccess: (res) => {
      setSelectedSavedIds(new Set());
      toast({ title: 'Удалено', description: `Удалено записей: ${(res as any)?.deleted ?? 0}` });
      void queryClient.invalidateQueries(['prescriptionRegister']);
    },
    onError: () => toast({ title: 'Ошибка удаления', description: 'Недостаточно прав или ошибка сервера' }),
  });

  const saveExcelMutation = useMutation(apiClient.saveExcelToStorage, {
    onSuccess: (res: any) => {
      const url = res?.url as string | undefined;
      if (url) {
        setSavedExcelUrl(url);
        toast({ title: "Сохранено", description: "Excel загружен и открыт ниже" });
      } else {
        toast({ title: "Сохранено", description: "URL не получен, проверьте файл в хранилище" });
      }
    },
    onError: () => toast({ title: "Ошибка", description: "Не удалось сохранить Excel" }),
  });

  function onPickExcel() {
    excelInputRef.current?.click();
  }

  async function onExcelChange(e: React.ChangeEvent<HTMLInputElement>) {
    const el = e.currentTarget as HTMLInputElement;
    const f = el.files?.[0];
    el.value = '';
    if (!f) return;
    const lower = f.name.toLowerCase();
    if (!(lower.endsWith(".xlsx") || lower.endsWith(".xls"))) {
      toast({ title: "Неподдерживаемый формат", description: "Выберите Excel (.xlsx или .xls)" });
      return;
    }
    try {
      const b64 = await encodeFileAsBase64DataURL(f);
      if (!b64) {
        toast({ title: "Файл слишком большой", description: "Не удалось прочитать файл" });
        return;
      }
      setExcelFileName(f.name);
      setExcelBase64(b64);
      saveExcelMutation.mutate({ base64: b64, name: f.name, folderName: "Журнал поручений", fileId: activeFile?.id });
      toast({ title: "Excel выбран", description: f.name });
    } catch {
      toast({ title: "Ошибка чтения файла" });
    }
  }

  function onSaveAll() {
    if (excelBase64 && excelFileName) {
      saveExcelMutation.mutate({ base64: excelBase64, name: excelFileName, folderName: "Журнал поручений", fileId: activeFile?.id });
    }
    if (previewItems.length > 0) {
      saveMutation.mutate({ items: previewItems });
    }
  }

  const { data: journalFolderFiles } = useQuery(
    ["assignmentsJournalExcel"],
    async () => {
      const root: any = await apiClient.listStorage();
      const target = (root?.allFolders || []).find((f: any) => f.name === "Журнал поручений");
      if (target?.id) {
        const inFolder: any = await apiClient.listStorage({ folderId: target.id });
        const files = (inFolder?.files || []) as any[];
        return files.filter((f) => /\.(xlsx|xls)(?:$|\?)/i.test((f?.url as string) || (f?.name as string) || ""));
      }
      return [] as any[];
    },
    { staleTime: 60_000 }
  );

  useEffect(() => {
    if (!savedExcelUrl && Array.isArray(journalFolderFiles) && journalFolderFiles.length > 0) {
      setSavedExcelUrl((journalFolderFiles[0] as any).url as string);
    }
  }, [journalFolderFiles, savedExcelUrl]);

  const columns: Array<{ key: keyof ImportItem; title: string }> = [
    { key: "code", title: "Код" },
    { key: "shop", title: "Цех" },
    { key: "section", title: "Участок" },
    { key: "objectInspected", title: "Объект" },
    { key: "description", title: "Описание" },
    { key: "auditor", title: "Инициатор" },
    { key: "category", title: "Категория" },
    { key: "conditionType", title: "Вид" },
    { key: "responsibleName", title: "Ответственный" },
    { key: "dueDate", title: "Срок" },
    { key: "status", title: "Статус" },
  ];

  return (
    <div className="max-w-6xl mx-auto p-4 space-y-4">
      <h1 className="text-xl sm:text-2xl font-bold">Личные показатели поручений</h1>

      {/* Интерактивные окна со сводкой */}
      <AssignmentsSummaryPanel onOpenList={(t) => setListType(t)} />

      <div className="hidden flex flex-wrap items-center gap-2">
        <Button size="sm" variant="secondary" onClick={onChooseFile} className="hidden">
          Загрузить список поручений
        </Button>
        <input
          ref={fileInputRef}
          type="file"
          accept=".xlsx,.xls,.csv,.tsv,.json,.txt,.html,.htm"
          className="hidden"
          onChange={(e) => {
            const f = e.target.files?.[0];
            if (f) void handleFile(f);
            if (e.target) e.target.value = "";
          }}
        />

        <Button size="sm" variant="secondary" onClick={onPickExcel}>
          Загрузить Excel
        </Button>
        <input
          ref={excelInputRef}
          type="file"
          accept=".xlsx,.xls"
          className="hidden"
          onChange={onExcelChange}
        />

        <Button size="sm" variant="outline" onClick={() => setHtmlDialogOpen(true)} className="hidden">
          Вставить HTML код
        </Button>

      {false && (          <Button
            size="sm"
            variant="default"
            onClick={onSaveAll}
            disabled={saveMutation.isLoading || saveExcelMutation.isLoading || saved}
          >
            {saved ? "Сохранено" : (saveMutation.isLoading || saveExcelMutation.isLoading) ? "Сохраняем…" : "Сохранить изменения"}
          </Button>
        )}
      </div>

      {false && (
        <div className="space-y-2">
          <div className="flex flex-wrap items-center gap-3 mb-2">
            <Button asChild variant="link" className="p-0 h-auto">
              <a href={savedExcelUrl} target="_blank" rel="noreferrer">Открыть Excel в новой вкладке</a>
            </Button>
            <Button asChild variant="secondary" size="sm">
              {/* Windows/Office: открывает прямо в настольном Excel, если доступен */}
              <a href={`ms-excel:ofe|u|${savedExcelUrl}`}>Открыть в Excel на компьютере</a>
            </Button>
            <Button asChild variant="outline" size="sm">
              <a href={savedExcelUrl} download>Скачать файл</a>
            </Button>
            <Badge variant="secondary">Оригинальный файл</Badge>
          </div>
          <iframe
            title="Загруженный Excel"
            src={`https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(savedExcelUrl)}`}
            style={{ width: "100%", height: "70vh", border: 0 }}
          />
        </div>
      )}

       {false && (        <div className="rounded-md border overflow-auto">
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead className="w-10">
                  <Checkbox
                    checked={(savedQuery.data.items ?? []).length > 0 && (savedQuery.data.items ?? []).every((r: any) => selectedSavedIds.has(r.id))}
                    onCheckedChange={() => {
                      const all = (savedQuery.data.items ?? []).map((r: any) => r.id);
                      const allSelected = all.length > 0 && all.every((id: string) => selectedSavedIds.has(id));
                      setSelectedSavedIds(() => allSelected ? new Set() : new Set(all));
                    }}
                  />
                </TableHead>
                {columns.map((c) => (
                  <TableHead key={String(c.key)}>{c.title}</TableHead>
                ))}
              </TableRow>
            </TableHeader>
            <TableBody>
              {(savedQuery.data.items ?? []).map((row: any) => {
                const item = mapSavedToItem(row.violation);
                return (
                  <TableRow key={row.id} className="hover:bg-accent cursor-pointer" onClick={() => setSelectedRow(item)}>
                    <TableCell onClick={(e) => e.stopPropagation()}>
                      <Checkbox
                        checked={selectedSavedIds.has(row.id)}
                        onCheckedChange={() => {
                          setSelectedSavedIds((prev) => {
                            const next = new Set(prev);
                            if (next.has(row.id)) next.delete(row.id); else next.add(row.id);
                            return next;
                          });
                        }}
                      />
                    </TableCell>
                    {columns.map((c) => (
                      <TableCell key={String(c.key)}>{(item as any)[c.key] ?? '—'}</TableCell>
                    ))}
                  </TableRow>
                );
              })}
            </TableBody>
          </Table>
        </div>
      )}

      {false && (
        <div className="flex items-center gap-2">
          <Button size="sm" variant="destructive" disabled={deleteSavedMutation.isLoading} onClick={() => deleteSavedMutation.mutate({ ids: Array.from(selectedSavedIds) })}>
            Удалить отмеченные
          </Button>
        </div>
      )}

      {false && (        <div className="rounded-md border overflow-auto">
          <Table>
            <TableHeader>
              <TableRow>
                {columns.map((c) => (
                  <TableHead key={c.key as string}>{c.title}</TableHead>
                ))}
              </TableRow>
            </TableHeader>
            <TableBody>
              {previewItems.map((row, idx) => (
                <TableRow key={idx} className="cursor-pointer hover:bg-accent" onClick={() => setSelectedRow(row)}>
                  {columns.map((c) => (
                    <TableCell key={c.key as string}>
                      {row[c.key] ?? "—"}
                    </TableCell>
                  ))}
                </TableRow>
              ))}
            </TableBody>
          </Table>
        </div>
      )}

      <Dialog open={htmlDialogOpen} onOpenChange={setHtmlDialogOpen}>
        <DialogContent className="max-w-2xl">
          <DialogHeader>
            <DialogTitle>Вставить HTML с таблицей</DialogTitle>
            <DialogDescription>Вставьте HTML-код, содержащий таблицу Excel/HTML. Мы распознаем первую таблицу на странице.</DialogDescription>
          </DialogHeader>
          <Textarea
            value={htmlCode}
            onChange={(e) => setHtmlCode(e.target.value)}
            placeholder="<table>..."
            className="min-h-[240px]"
          />
          <DialogFooter>
            <Button
              variant="default"
              onClick={async () => {
                const items = await parseHtmlString(htmlCode);
                if (!items.length) {
                  toast({ title: "Таблица не найдена", description: "Проверьте HTML-код" });
                  return;
                }
                setPreviewItems(items);
                setSaved(false);
                setHtmlDialogOpen(false);
                toast({ title: "Загружено из HTML", description: `Найдено записей: ${items.length}` });
              }}
            >
              Предпросмотр
            </Button>
            <DialogClose asChild>
              <Button variant="secondary">Отмена</Button>
            </DialogClose>
          </DialogFooter>
        </DialogContent>
      </Dialog>

       <Dialog open={!!selectedRow} onOpenChange={(open) => !open && setSelectedRow(null)}>        <DialogContent className="max-w-xl">
          <DialogHeader>
            <DialogTitle>Подробности поручения</DialogTitle>
            <DialogDescription>
              Полная информация по выбранной записи
            </DialogDescription>
          </DialogHeader>
          {selectedRow && (
            <div className="space-y-2 text-sm">
              {columns.map((c) => (
                <div key={c.key as string} className="flex gap-2">
                  <div className="w-40 text-muted-foreground">{c.title}</div>
                  <div className="flex-1 break-words">{selectedRow[c.key] ?? "—"}</div>
                </div>
              ))}
            </div>
          )}
          <DialogFooter>
            <DialogClose asChild>
              <Button variant="secondary">Закрыть</Button>
            </DialogClose>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Список поручений по выбранному типу */}
      <Dialog open={!!listType} onOpenChange={(open) => !open && setListType(null)}>
        <DialogContent className="max-w-3xl">
          <DialogHeader>
            <DialogTitle>
              {listType === 'issued' && 'Все поручения'}
              {listType === 'new' && 'Новые за 7 дней'}
              {listType === 'completed' && 'Выполненные'}
              {listType === 'inProgress' && 'В работе'}
              {listType === 'overdue' && 'Просроченные'}
            </DialogTitle>
            <DialogDescription>Кликните запись, чтобы открыть детали и загрузить подтверждающие документы.</DialogDescription>
          </DialogHeader>
          <div className="max-h-[60vh] overflow-auto">
            {tableQuery.isFetching && <div className="text-sm text-muted-foreground p-2">Загрузка…</div>}
            {(!tableQuery.isFetching && displayedItems.length === 0) && <div className="text-sm text-muted-foreground p-2">Нет записей</div>}
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>Описание</TableHead>
                  <TableHead>Срок</TableHead>
                  <TableHead>Статус</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {displayedItems.map((row: any) => (
                  <TableRow key={row.id} className="cursor-pointer hover:bg-accent" onClick={() => { setSelectedEntry(row); setListType(null); }}>
                    <TableCell className="max-w-[480px] truncate">{row.description ?? '—'}</TableCell>
                    <TableCell>{row.dueDate || '—'}</TableCell>
                    <TableCell>{row.status || '—'}</TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          </div>
          <DialogFooter>
            <DialogClose asChild>
              <Button variant="secondary">Закрыть</Button>
            </DialogClose>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Детали поручения + загрузка подтверждений и отправка */}
      <Dialog open={!!selectedEntry} onOpenChange={(open) => { if (!open) { setSelectedEntry(null); setSupportFileUrl(''); setRecipientEmail(''); setRecipientUserId(''); } }}>
        <DialogContent className="max-w-2xl">
          <DialogHeader>
            <DialogTitle>Поручение</DialogTitle>
            <DialogDescription>Полная информация и отправка подтверждений</DialogDescription>
          </DialogHeader>
              {selectedEntry && (
                <div className="space-y-3">
                  <div>
                    <div className="text-sm text-muted-foreground">Описание</div>
                    <div className="text-sm whitespace-pre-wrap">{selectedEntry.description ?? '—'}</div>
                  </div>
                  <div className="grid grid-cols-2 gap-3 text-sm">
                    <div><span className="text-muted-foreground">Дата выдачи:</span> {selectedEntry.dateIssued || '—'}</div>
                    <div><span className="text-muted-foreground">Срок:</span> {selectedEntry.dueDate || '—'}</div>
                    <div><span className="text-muted-foreground">Ответственный:</span> {selectedEntry.responsible || '—'}</div>
                    <div><span className="text-muted-foreground">Категория:</span> {selectedEntry.category || '—'}</div>
                    <div><span className="text-muted-foreground">Источник:</span> {selectedEntry.source || '—'}</div>
                    <div><span className="text-muted-foreground">Дата исполнения:</span> {selectedEntry.dateCompleted || '—'}</div>
                    <div><span className="text-muted-foreground">Статус:</span> {selectedEntry.status || '—'}</div>
                  </div>

                  <div className="pt-2 space-y-2">
                    <div className="font-medium">Загрузить подтверждающие документы</div>
                    <Input type="file" onChange={async (e) => {
                      const el = e.currentTarget as HTMLInputElement;
                      const f = el.files?.[0];
                      el.value = '';
                      if (!f) return;
                      try {
                        const b64 = await encodeFileAsBase64DataURL(f);
                        if (!b64) { toast({ title: 'Файл слишком большой', description: 'Лимит 100MB' }); return; }
                        uploadSupportMutation.mutate({ base64: b64, name: f.name, folderName: 'Подтверждающие документы' });
                      } catch {
                        toast({ title: 'Ошибка чтения файла' });
                      }
                    }} />
                    {supportFileUrl && (
                      <div className="text-xs text-green-700">Файл загружен. Ссылка готова к отправке.</div>
                    )}
                  </div>

                  <div className="pt-2 grid gap-2">
                    <div className="font-medium">Отправить ссылку</div>
                    <div className="grid md:grid-cols-2 gap-2">
                      <div>
                        <div className="text-xs text-muted-foreground mb-1">Выбрать пользователя</div>
                        <Select value={recipientUserId} onValueChange={(v) => setRecipientUserId(v)}>
                          <SelectTrigger className="w-full">
                            <SelectValue placeholder="Выберите пользователя" />
                          </SelectTrigger>
                          <SelectContent>
                            {(usersForSend ?? []).map((u: any) => (
                              <SelectItem key={u.id} value={u.id}>{u.fullName || u.email || u.id}</SelectItem>
                            ))}
                          </SelectContent>
                        </Select>
                      </div>
                      <div>
                        <div className="text-xs text-muted-foreground mb-1">Или указать email</div>
                        <Input type="email" placeholder="name@example.com" value={recipientEmail} onChange={(e) => setRecipientEmail(e.target.value)} />
                      </div>
                    </div>
                    <div className="flex gap-2">
                      <Button disabled={!supportFileUrl || sendSupportMutation.isLoading} onClick={() => {
                        if (!supportFileUrl) { toast({ title: 'Сначала загрузите файл' }); return; }
                        if (!recipientUserId && !recipientEmail) { toast({ title: 'Укажите получателя', description: 'Выберите пользователя или введите email' }); return; }
                        sendSupportMutation.mutate({ url: supportFileUrl, name: 'Поручение', toUserId: recipientUserId || undefined, email: recipientEmail || undefined });
                      }}>Отправить</Button>
                      <Button variant="secondary" onClick={() => { setSupportFileUrl(''); setRecipientEmail(''); setRecipientUserId(''); }}>Сбросить</Button>
                    </div>
                  </div>
                </div>
              )}          <DialogFooter>
            <DialogClose asChild>
              <Button variant="secondary">Закрыть</Button>
            </DialogClose>
          </DialogFooter>
        </DialogContent>
      </Dialog>

    </div>
  );
}

function AssignmentsTableManager() {
  useAuth({ required: true });
  const { toast } = useToast();

  // локальные данные таблицы (10 полей, № рассчитывается автоматически)
  const [rows, setRows] = useState<string[][]>([]);
  const [editMode, setEditMode] = useState(false);
  const [fullscreen, setFullscreen] = useState(false);
  const [locked, setLocked] = useState(false);
  const excelRef = useRef<HTMLInputElement | null>(null);
  const [excelB64, setExcelB64] = useState<string>("");
  const [excelName, setExcelName] = useState<string>("");

  // Загрузка сохранённых данных при открытии
  const loadQuery = useQuery(['assignmentsTable'], () => apiClient.getAssignmentsTable());
  useEffect(() => {
    const data = loadQuery.data as unknown as { rows?: string[][]; locked?: boolean } | undefined;
    if (data?.locked) {
      setLocked(true);
      setEditMode(false);
    }
    if (data && Array.isArray(data.rows) && data.rows.length > 0) {
      setRows(
        data.rows.map((row) => row.map((v, idx) => ([0,5,7].includes(idx) ? formatDDMMYYYY(String(v ?? '')) : String(v ?? ''))))
      );
    }
  }, [loadQuery.data]);

  const saveTableMutation = useMutation(apiClient.saveAssignmentsTable, {
    onSuccess: (res: any) => {
      if (res && (res as any).locked) {
        setLocked(true);
        setEditMode(false);
      }
      toast({ title: 'Таблица сохранена' });
    },
    onError: () => toast({ title: 'Не удалось сохранить', description: 'Попробуйте ещё раз' }),
  });

  const saveExcelMutation = useMutation(apiClient.saveExcelToStorage, {
    onSuccess: () => toast({ title: 'Excel сохранён' }),
    onError: () => toast({ title: 'Не удалось сохранить Excel' }),
  });

  // Инициализация примерами (5 строк), как в предоставленном шаблоне
  useEffect(() => {
    const initial: string[][] = Array.from({ length: 5 }, () => Array(10).fill(""));
    if (initial.length > 0) {
      // Первая строка примера из ТЗ
      initial[0][0] = "15.10.2023"; // Дата выдачи поручения
      initial[0][1] = "Разработать план мероприятий на следующий квартал"; // Решение
      initial[0][2] = "План"; // Категория
      initial[0][3] = "Внутренний"; // Источник
      initial[0][4] = "Иванов И.И."; // Ответственный
      initial[0][5] = "30.11.2023"; // Срок
      initial[0][6] = "В работе"; // Статус
      initial[0][7] = ""; // Дата исполнения
      initial[0][8] = "Нет"; // Регулярное мероприятие
      initial[0][9] = ""; // Отчет об исполнении
    }
    setRows(initial);
  }, []);

  const addRow = () => setRows((prev) => [...prev, Array(10).fill("")]);
  const removeRow = () => setRows((prev) => (prev.length ? prev.slice(0, -1) : prev));
  const saveChanges = () => {
    const normalizedRows = rows.map((row) =>
      row.map((v, idx) => ([0,5,7].includes(idx) ? formatDDMMYYYY(String(v ?? '')) : String(v ?? '')))
    );
    saveTableMutation.mutate({ rows: normalizedRows });
    if (excelB64 && excelName) {
      saveExcelMutation.mutate({ base64: excelB64, name: excelName, folderName: 'Журнал поручений' });
    }
  };

  const onPickExcel = () => excelRef.current?.click();
  const onExcelChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;
    try {
      const buf = await file.arrayBuffer();
      const wb = XLSX.read(new Uint8Array(buf), { type: 'array', cellDates: true });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(ws, { header: 1, raw: false, defval: "", dateNF: "dd.mm.yyyy" }) as any[];
      const next: string[][] = [];
      for (let i = 1; i < json.length; i++) {
        const r = json[i] as any[];
        const row: string[] = [];
        for (let j = 0; j < 10; j++) {
          const cell = r[j];
          let val: string = "";
          if (cell instanceof Date) {
            val = cell.toLocaleDateString("ru-RU");
          } else if (typeof cell === "string") {
            const m = cell.match(/^(\d{4})-(\d{2})-(\d{2})/);
            if (m) val = `${m[3]}.${m[2]}.${m[1]}`; else val = cell;
          } else if (typeof cell === "number") {
            const epoch = new Date(Date.UTC(1899, 11, 30));
            const ms = Math.round(cell * 86400000);
            const dt = new Date(epoch.getTime() + ms);
            if (!isNaN(dt.getTime()) && cell > 20000 && cell < 80000) {
              val = dt.toLocaleDateString("ru-RU");
            } else {
              val = String(cell ?? "");
            }
          } else {
            val = String(cell ?? "");
          }
          row[j] = formatDDMMYYYY(String(val ?? ''));
        }
        next.push(row);
      }
       setRows(next);
       // Сохраняем файл для последующей загрузки в хранилище при сохранении
       const b64 = await encodeFileAsBase64DataURL(file);
       if (b64) {
         setExcelB64(b64);
         setExcelName(file.name);
         // Мгновенно сохраняем файл в хранилище
         saveExcelMutation.mutate({ base64: b64, name: file.name, folderName: 'Журнал поручений' });
       }
       // Автосохранение таблицы и фиксация (lock)
       saveTableMutation.mutate({ rows: next, lock: true } as any);
       setLocked(true);
       setEditMode(false);
       toast({ title: "Файл загружен", description: "Данные сохранены и зафиксированы" });    } catch {
      toast({ title: "Не удалось открыть Excel" });
    } finally {
      if (e.target) e.target.value = "";
    }
  };

  const updateCell = (ri: number, dataIndex: number, value: string) => {
    setRows((prev) => prev.map((r, i) => (i === ri ? r.map((c, j) => (j === dataIndex ? value : c)) : r)));
  };

  const statusBg = (text: string) => {
    const s = (text || "").toLowerCase();
    if (s.includes('ожидание') || s.includes('ожидает')) return 'bg-yellow-100';
    if (s.includes('работе') || s.includes('выполн')) return 'bg-blue-100';
    if (s.includes('заверш') || s.includes('выполнен')) return 'bg-green-100';
    if (s.includes('просроч')) return 'bg-red-100';
    return '';
  };

  // Формат dd.mm.yyyy для отображения дат
  const formatDDMMYYYY = (input: string): string => {
    const t = (input || '').trim();
    if (!t) return '';
    const pad = (n: number) => (n < 10 ? `0${n}` : String(n));

    // Уже dd.mm.yyyy или d.m.yyyy
    const m1 = t.match(/^(\d{1,2})[.](\d{1,2})[.](\d{4})$/);
    if (m1) {
      const d = Number(m1[1]);
      const m = Number(m1[2]);
      const y = Number(m1[3]);
      return `${pad(d)}.${pad(m)}.${y}`;
    }

    // yyyy-mm-dd или yyyy/mm/dd
    const m2 = t.match(/^(\d{4})[-\/.](\d{1,2})[-\/.](\d{1,2})$/);
    if (m2) {
      const y = Number(m2[1]);
      const m = Number(m2[2]);
      const d = Number(m2[3]);
      return `${pad(d)}.${pad(m)}.${y}`;
    }

    // Excel serial (пять цифр)
    if (/^\d{5}$/.test(t)) {
      const n = Number(t);
      if (n > 20000 && n < 80000) {
        const epoch = new Date(Date.UTC(1899, 11, 30));
        const ms = Math.round(n * 86400000);
        const dt = new Date(epoch.getTime() + ms);
        if (!isNaN(dt.getTime())) {
          return `${pad(dt.getUTCDate())}.${pad(dt.getUTCMonth() + 1)}.${dt.getUTCFullYear()}`;
        }
      }
    }

    // Попытка распарсить как дату
    const d = new Date(t);
    if (!isNaN(d.getTime())) {
      return `${pad(d.getDate())}.${pad(d.getMonth() + 1)}.${d.getFullYear()}`;
    }

    return t;
  };

  return (
    <div className="container mx-auto p-4">
      <h1 className="text-xl sm:text-2xl font-bold mb-2">ТАБЛИЦА УЧЕТА  ПОРУЧЕНИЙ</h1>
      {/* Панель управления */}
      <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-3">
        <div className="flex gap-2">
          {!locked && (
            <>
              <Button className="btn" onClick={addRow}>Добавить строку</Button>
              <Button className="btn btn-danger" variant="destructive" onClick={removeRow}>Удалить строку</Button>
              <Button className="btn btn-success" onClick={saveChanges} disabled={saveTableMutation.isLoading || saveExcelMutation.isLoading}>
                {(saveTableMutation.isLoading || saveExcelMutation.isLoading) ? 'Сохраняем…' : 'Сохранить изменения'}
              </Button>
            </>
          )}
        </div>
        <div className="flex items-center gap-2">
          {!locked && (
            <>
              <Button onClick={onPickExcel}>Загрузить из Excel</Button>
              <input ref={excelRef} type="file" accept=".xlsx,.xls" className="hidden" onChange={onExcelChange} />
            </>
          )}
        </div>
        <div className="flex items-center gap-4">
          <label className="flex items-center gap-2 text-sm">
            <input type="checkbox" checked={editMode && !locked} disabled={locked} onChange={(e) => setEditMode(e.target.checked)} />Режим редактирования
          </label>
          <label className="flex items-center gap-2 text-sm"><input type="checkbox" checked={fullscreen} onChange={(e) => setFullscreen(e.target.checked)} />Полный экран</label>
        </div>
      </div>

      {/* Таблица */}
      <div className={fullscreen ? "fixed inset-0 z-50 p-4 bg-background" : ""}>
        {fullscreen && (
          <>
            <div className="absolute top-4 left-4 z-50 text-lg sm:text-xl font-semibold">
              ТАБЛИЦА УЧЕТА  ПОРУЧЕНИЙ
            </div>
            <div className="absolute top-4 right-4 z-50">
              <Button variant="secondary" onClick={() => setFullscreen(false)}>
                Свернуть полноэкранный режим
              </Button>
            </div>
          </>
        )}
        <div className="bg-card rounded shadow overflow-auto">
          <table className="w-full border-collapse text-sm">
            <thead className="sticky top-0 z-10 bg-muted">
              <tr>
                <th style={{width:'2cm'}} className="border p-2 text-left">№</th>
                <th style={{width:'3cm'}} className="border p-2 text-left">Дата выдачи поручения</th>
                <th style={{width:'10cm'}} className="border p-2 text-left">Решение</th>
                <th style={{width:'3cm'}} className="border p-2 text-left">Категория</th>
                <th style={{width:'5cm'}} className="border p-2 text-left">Источник</th>
                <th style={{width:'10cm'}} className="border p-2 text-left">Ответственный</th>
                <th style={{width:'3cm'}} className="border p-2 text-left">Срок</th>
                <th style={{width:'4cm'}} className="border p-2 text-left">Статус</th>
                <th style={{width:'3cm'}} className="border p-2 text-left">Дата исполнения</th>
                <th style={{width:'2cm'}} className="border p-2 text-left">Регулярное мероприятие</th>
                <th style={{width:'10cm'}} className="border p-2 text-left">Отчет об исполнении</th>
              </tr>
            </thead>
            <tbody>
              {rows.map((r, ri) => (
                <tr key={ri}>
                  {Array.from({ length: 11 }).map((_, colIndex) => {
                    if (colIndex === 0) {
                      return <td key={colIndex} className="border p-2 align-top">{ri + 1}</td>;
                    }
                    const dataIndex = colIndex - 1; // 0..9
                    const isStatus = colIndex === 7; // колонка "Статус"
                    const extraBg = isStatus ? statusBg(r[6]) : '';
                    return (
                      <td key={colIndex} className={`border p-2 align-top ${extraBg}`}>
                         {(editMode && !locked) ? (
                           <input
                             className="w-full bg-transparent outline-none"
                             value={r[dataIndex] ?? ''}
                             onChange={(e) => updateCell(ri, dataIndex, e.target.value)}
                           />
                         ) : (
                           <div>{[0,5,7].includes(dataIndex) ? formatDDMMYYYY(String(r[dataIndex] ?? '')) : (r[dataIndex] ?? '')}</div>
                         )}                      </td>
                    );
                  })}
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
}

function AdminWorkPagesLibraryScreen() {
  useAuth({ required: true });
  const navigate = useNavigate();
  const { toast } = useToast();
  const queryClient = useQueryClient();
  const { data: me } = useQuery<Profile>(["me"], () => apiClient.getMyProfile());
  const isAdmin = !!(me as any)?.isAdmin || !!(me as any)?.isSuperAdmin;
  const { data: pages, isInitialLoading } = useQuery(
    ["simplePages"],
    () => apiClient.listSimplePages(),
    { enabled: isAdmin }
  );

  const createPage = useMutation(apiClient.upsertSimplePage, {
    onSuccess: async () => {
      await queryClient.invalidateQueries({ queryKey: ["simplePages"] });
      toast({ title: "Страница сохранена" });
      setNewTitle("");
      setNewSlug("");
      setNewContent("");
    },
    onError: () => toast({ title: "Не удалось сохранить страницу" }),
  });

  const delPage = useMutation(apiClient.deleteSimplePage, {
    onSuccess: async () => {
      await queryClient.invalidateQueries({ queryKey: ["simplePages"] });
      toast({ title: "Страница удалена" });
    },
    onError: () => toast({ title: "Не удалось удалить страницу" }),
  });

  const [newTitle, setNewTitle] = useState("");
  const [newSlug, setNewSlug] = useState("");
  const [newContent, setNewContent] = useState("");

  if (!isAdmin) {
    return (
      <div className="max-w-4xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Доступ ограничен</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">Раздел доступен только администраторам.</div>
          </CardContent>
          <CardFooter>
            <NavLink to="/admin">
              <Button variant="secondary">К админ-панели</Button>
            </NavLink>
          </CardFooter>
        </Card>
      </div>
    );
  }

  return (
    <div className="max-w-6xl mx-auto p-4 sm:p-6 space-y-6">
      <Card className="card-elevated h-full">
        <CardHeader className="flex items-center justify-between">
          <CardTitle>Библиотека рабочих страниц</CardTitle>
          <div className="flex gap-2">
            <Button variant="secondary" onClick={() => navigate(-1 as any)}>Назад</Button>
            <NavLink to="/admin">
              <Button variant="secondary">К админ-панели</Button>
            </NavLink>
          </div>
        </CardHeader>
        <CardContent className="space-y-6">
          <div className="text-sm text-muted-foreground">
            Создавайте и храните рабочие страницы для дальнейшего выбора в приложении.
          </div>

          <div className="space-y-3">
            <div className="font-medium">Создать простую страницу</div>
            <div className="grid md:grid-cols-2 gap-4">
              <div className="grid gap-2">
                <Label>Название</Label>
                <Input value={newTitle} onChange={(e) => setNewTitle(e.target.value)} placeholder="Например: Инструкции" />
              </div>
              <div className="grid gap-2">
                <Label>Slug (адрес)</Label>
                <Input value={newSlug} onChange={(e) => setNewSlug(e.target.value)} placeholder="naprimer-instrukcii" />
              </div>
            </div>
            <div className="grid gap-2">
              <Label>Содержимое (Markdown)</Label>
              <Textarea value={newContent} onChange={(e) => setNewContent(e.target.value)} rows={6} placeholder="# Заголовок\nТекст страницы…" />
            </div>
            <div className="flex gap-2">
              <Button
                onClick={() => {
                  if (!newTitle.trim()) {
                    toast({ title: "Введите название страницы" });
                    return;
                  }
                  createPage.mutate({ title: newTitle.trim(), slug: newSlug.trim(), content: newContent });
                }}
                disabled={createPage.isLoading}
              >
                Сохранить страницу
              </Button>
              <Button
                variant="secondary"
                onClick={() => {
                  setNewTitle("");
                  setNewSlug("");
                  setNewContent("");
                }}
              >
                Очистить
              </Button>
              <NavLink to="/admin/form-builder">
                <Button variant="secondary">Открыть конструктор форм</Button>
              </NavLink>
            </div>
          </div>

          <div className="hr-muted w-full h-px" />

          <div className="space-y-2">
            <div className="font-medium">Сохранённые страницы</div>
            {isInitialLoading ? (
              <div className="text-sm text-muted-foreground">Загрузка…</div>
            ) : (pages && (pages as any[])?.length ? (
              <div className="border rounded-md overflow-hidden">
                <Table>
                  <TableHeader>
                    <TableRow>
                      <TableHead>Название</TableHead>
                      <TableHead>Слаг</TableHead>
                      <TableHead>Действия</TableHead>
                    </TableRow>
                  </TableHeader>
                  <TableBody>
                    {(pages as any[]).map((p: any) => (
                      <TableRow key={p.id}>
                        <TableCell className="min-w-[240px]">{p.title || p.slug}</TableCell>
                        <TableCell className="font-mono text-xs">{p.slug}</TableCell>
                        <TableCell>
                          <div className="flex gap-2">
                            <NavLink to={`/p/${p.slug}`}>
                              <Button size="sm" variant="secondary">Открыть</Button>
                            </NavLink>
                            <Button size="sm" variant="destructive" onClick={() => delPage.mutate({ id: p.id })}>Удалить</Button>
                          </div>
                        </TableCell>
                      </TableRow>
                    ))}
                  </TableBody>
                </Table>
              </div>
            ) : (
              <div className="text-sm text-muted-foreground">Пока нет сохранённых страниц</div>
            ))}
          </div>
        </CardContent>
      </Card>
    </div>
  );
}

function ChartsSelectionScreen() {
  useAuth({ required: true });
  const navigate = useNavigate();

  return (
    <div className="max-w-5xl mx-auto p-4 sm:p-6">
      <Card className="card-elevated">
        <CardHeader>
          <CardTitle>Выбор графиков</CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <Button
            className="w-full h-16 btn-3d text-base font-semibold touch-target flex items-center justify-center"
            onClick={() => navigate("/charts/pab-personal")}
          >
            График личных показателей ПАБ
          </Button>
        </CardContent>
      </Card>
    </div>
  );
}

function PabPersonalChartsScreen() {
  const auth = useAuth({ required: true });

  const { data: me } = useQuery<Profile>(
    ["me"],
    () => apiClient.getMyProfile(),
    { enabled: auth.status === "authenticated" },
  );

  type PabDeptStats = inferRPCOutputType<"listPabDepartmentStats">;
  const { data: deptStats, isInitialLoading } = useQuery<PabDeptStats>(
    ["pab.departments.personal"],
    () => apiClient.listPabDepartmentStats(),
    { staleTime: 60_000 },
  );

  const departments = (deptStats?.departments ?? []) as any[];

  const [selectedDept, setSelectedDept] = useState<string>("");

  // По умолчанию выбираем подразделение из профиля пользователя, если оно есть
  useEffect(() => {
    if (!selectedDept && me?.department) {
      setSelectedDept(me.department);
    }
  }, [me?.department, selectedDept]);

  // Если у пользователя не задано подразделение, берём первое из списка
  useEffect(() => {
    if (!selectedDept && departments.length) {
      const firstName = String(departments[0]?.name ?? "");
      if (firstName) setSelectedDept(firstName);
    }
  }, [departments, selectedDept]);

  const currentDept = departments.find((d: any) => d.name === selectedDept) as
    | { name: string; titles?: { name: string; planAudits: number | null; planObservations: number | null }[] }
    | undefined;

  const titles = (currentDept?.titles ?? []) as
    { name: string; planAudits: number | null; planObservations: number | null }[];

  return (
    <div className="max-w-3xl mx-auto p-4 sm:p-6">
      <Card className="card-elevated">
        <CardHeader className="flex items-center justify-between">
          <CardTitle>Личные показатели ПАБ</CardTitle>
          <Button variant="outline" onClick={() => window.print()}>
            Печать
          </Button>
        </CardHeader>
        <CardContent className="space-y-6">
          <div className="space-y-2">
            <div className="text-sm text-muted-foreground">Выберите подразделение.</div>
            {isInitialLoading ? (
              <div className="text-sm text-muted-foreground">Загрузка…</div>
            ) : departments.length === 0 ? (
              <div className="text-sm text-muted-foreground">
                Нет данных по подразделениям. Обратитесь к администратору.
              </div>
            ) : (
              <select
                className="border rounded px-2 py-1 text-sm min-w-[240px]"
                value={selectedDept}
                onChange={(e) => setSelectedDept(e.target.value)}
              >
                {departments.map((d: any) => (
                  <option key={d.name} value={d.name}>
                    {d.name}
                  </option>
                ))}
              </select>
            )}
          </div>

          {titles.length > 0 && (
            <div className="space-y-2">
              <div className="font-medium">Личные показатели выбранного подразделения</div>
              <div className="border rounded overflow-auto max-h-[60vh]">
                <table className="min-w-full text-sm">
                  <thead>
                    <tr>
                      <th className="border px-2 py-1 text-left bg-muted">Должность</th>
                      <th className="border px-2 py-1 text-right bg-muted">План аудитов</th>
                      <th className="border px-2 py-1 text-right bg-muted">План наблюдений</th>
                    </tr>
                  </thead>
                  <tbody>
                    {titles.map((t) => (
                      <tr key={t.name}>
                        <td className="border px-2 py-1">{t.name}</td>
                        <td className="border px-2 py-1 text-right">
                          {t.planAudits ?? "—"}
                        </td>
                        <td className="border px-2 py-1 text-right">
                          {t.planObservations ?? "—"}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}
        </CardContent>
      </Card>
    </div>
  );
}

export default function App() {
  // Global capture for unhandled promise rejections to aid debugging rare runtime issues
  useEffect(() => {
    const onRejection = (event: PromiseRejectionEvent) => {
      try {
        const reason: any = event?.reason;
        const details = {
          message:
            typeof reason?.message === "string"
              ? reason.message
              : typeof reason === "string"
                ? reason
                : "",
          name: reason?.name,
          stack: reason?.stack,
          keys: reason && typeof reason === "object" ? Object.keys(reason) : [],
        };
        const msg = details.message || "";
        const isBenignGenericObject =
          reason &&
          typeof reason === "object" &&
          !("message" in reason) &&
          !("stack" in reason);
        // Avoid flooding logs with known benign browser/runtime messages or generic non-error objects
        if (
          isBenignGenericObject ||
          msg === "" ||
          msg.includes("ResizeObserver loop completed") ||
          msg.includes("ResizeObserver loop limit exceeded") ||
          msg.includes(
            "ResizeObserver loop completed with undelivered notifications",
          ) ||
          msg.includes(
            "Cannot use 'in' operator to search for 'result' in null",
          ) ||
          msg.includes("Failed to fetch")
        ) {
          event.preventDefault?.();
          // downgrade to info log for diagnostic trace without polluting error channel
          console.log("[unhandledrejection:ignored]", {
            reasonType: typeof reason,
            details,
          });
          return;
        }
        console.error("[unhandledrejection]", details);
      } catch {
        console.error("[unhandledrejection] (failed to log details)");
      }
    };
    window.addEventListener("unhandledrejection", onRejection);
    return () => window.removeEventListener("unhandledrejection", onRejection);
  }, []);
  // removed pre-warm health query to speed up initial load

  // Silence benign browser error seen in some environments (ResizeObserver loop)
  useEffect(() => {
    const shouldIgnore = (text?: string) =>
      typeof text === "string" &&
      (text.includes("ResizeObserver loop completed") ||
        text.includes("ResizeObserver loop limit exceeded") ||
        text.includes(
          "ResizeObserver loop completed with undelivered notifications",
        ) ||
        text.includes(
          "Cannot use 'in' operator to search for 'result' in null",
        ) ||
        text.includes("Failed to fetch"));

    const handler = (e: any) => {
      const msg: string = e?.message || e?.error?.message || "";
      const isResourceError = !!(
        e?.target &&
        typeof e.target === "object" &&
        ((e.target as any).tagName === "IMG" ||
          (e.target as any).tagName === "SCRIPT" ||
          (e.target as any).tagName === "LINK")
      );
      const isEmptyEvent = !msg && !e?.error;
      if (shouldIgnore(msg) || isResourceError || isEmptyEvent) {
        try {
          e.preventDefault?.();
          e.stopPropagation?.();
          e.stopImmediatePropagation?.();
        } catch {}
        // keep a light trace for diagnostics without failing the app
        console.log("[window.error:ignored]", {
          msg,
          resourceTag: (e?.target as any)?.tagName,
        });
      }
    };

    const prevOnError = window.onerror;

    window.addEventListener("error", handler as EventListener, {
      capture: true,
    });

    // Additionally override window.onerror to fully suppress logging of this known benign browser quirk
    // Returning true tells the browser the error was handled
    window.onerror = function (
      message: any,
      source?: any,
      lineno?: any,
      colno?: any,
      error?: any,
    ): boolean | void {
      const msgText: string | undefined =
        typeof message === "string" ? message : error?.message;

      // Cases to ignore:
      // 1) Known benign messages (ResizeObserver, etc.)
      // 2) Bare event objects or empty messages with no real Error
      // 3) Platforms reporting the event itself as "[object Event]"
      const isBareEvent = typeof message !== "string" && !error;
      const isEmpty = !msgText || msgText.trim() === "";
      const isEventString =
        typeof message === "string" && message === "[object Event]";

      if (shouldIgnore(msgText) || isBareEvent || isEmpty || isEventString) {
        // keep a light trace for diagnostics without polluting error channel
        try {
          console.log("[window.onerror:ignored]", {
            message,
            source,
            lineno,
            colno,
          });
        } catch {}
        return true;
      }

      if (typeof prevOnError === "function") {
        try {
          return prevOnError(
            message as any,
            source,
            lineno,
            colno,
            error,
          ) as any;
        } catch {
          // ignore
        }
      }
      return false;
    } as any;

    return () => {
      window.removeEventListener("error", handler as EventListener, true);
      // Restore previous handler
      // @ts-ignore - window.onerror accepts null
      window.onerror = (prevOnError as any) || null;
    };
  }, []);

  // Global autosize for all textareas with .pc-autosize
  useEffect(() => {
    const resize = (el: HTMLTextAreaElement) => {
      try {
        el.style.height = "auto";
        el.style.height = el.scrollHeight + "px";
      } catch {}
    };
    const onInput = (e: Event) => {
      const t = e.target as HTMLElement | null;
      if (
        t &&
        t.tagName === "TEXTAREA" &&
        (t as HTMLTextAreaElement).classList.contains("pc-autosize")
      ) {
        resize(t as HTMLTextAreaElement);
      }
    };
    document.addEventListener("input", onInput, true);
    // initial sync after mount
    try {
      const els = document.querySelectorAll<HTMLTextAreaElement>(
        "textarea.pc-autosize",
      );
      els.forEach(resize);
    } catch {}
    return () => document.removeEventListener("input", onInput, true);
  }, []);

  return (
    <QueryProviderWithPersistence>
      <OfflineProvider>
        <Router>
          <AppShell />
        </Router>
      </OfflineProvider>
    </QueryProviderWithPersistence>
  );
}

function AppShell() {
  const auth = useAuth();

  // Глобальный режим просмотра от имени пользователя (админ «Войти как»)
  const [impersonatedUserId, setImpersonatedUserId] = useState<string | null>(() => {
    try {
      return sessionStorage.getItem("impersonateUserId");
    } catch {
      return null;
    }
  });

  // Синхронизируем параметр ?as= в URL с sessionStorage
  const location = useLocation();
  const navigate = useNavigate();
  useEffect(() => {
    try {
      const params = new URLSearchParams(location.search);
      const as = params.get("as");
      if (as) {
        sessionStorage.setItem("impersonateUserId", as);
        if (impersonatedUserId !== as) {
          setImpersonatedUserId(as);
        }
      } else if (impersonatedUserId) {
        // если в URL нет as, но в сессии он есть — дописываем его, чтобы не потерять режим
        const next = new URLSearchParams(location.search);
        next.set("as", impersonatedUserId);
        navigate({ pathname: location.pathname, search: `?${next.toString()}` }, { replace: true });
      }
    } catch {
      /* ignore */
    }
  }, [location.pathname, location.search, impersonatedUserId, navigate]);

  // Выход из режима просмотра от имени пользователя при переходе на страницу входа
  useEffect(() => {
    if (location.pathname === "/") {
      try {
        sessionStorage.removeItem("impersonateUserId");
        setImpersonatedUserId(null);
      } catch {
        /* ignore */
      }
    }
  }, [location.pathname]);

  const { data: maintenanceInitial } = useQuery<MaintenanceStatus>(
    ["maintenance"],
    () => apiClient.getMaintenanceStatus(),
  );
  const [maintenance] = useRealtimeStore<MaintenanceStatus>(
    "app:maintenance",
    maintenanceInitial ?? {
      maintenanceMode: false,
      maintenanceSince: null,
      maintenanceByUserId: null,
    },
  );
  const { data: me } = useQuery<Profile>(
    ["me"],
    () => apiClient.getMyProfile(),
    {
      enabled: auth.status === "authenticated",
    },
  );
  const allowAccess =
    auth.status === "authenticated" &&
    ((me as any)?.isAdmin || (me as any)?.isSuperAdmin);
  const maintenanceBlocked = !!maintenance?.maintenanceMode && !allowAccess;

  return (
    <div className="min-h-screen bg-background text-foreground pt-14">
      <AppHeader />
      {maintenanceBlocked && (
        <div className="fixed inset-0 z-50 bg-black/60 flex items-center justify-center p-4">
          <div className="bg-card text-card-foreground w-full max-w-lg rounded-lg shadow-lg p-6 text-center">
            <div className="flex items-center justify-center mb-4">
              <div className="h-3 w-3 rounded-full bg-red-500 mr-2" />
              <span className="text-sm text-muted-foreground">Техработы</span>
            </div>
            <p className="text-base leading-relaxed">
              Добрый день! Вход в систему временно приостановлен, ведется
              настройка системы. Просим извинить за временные неудобства.
            </p>
          </div>
        </div>
      )}
      <AppErrorBoundary>
        <Routes>
          <Route path="/" element={<AuthScreen />} />
          <Route path="/home" element={<HomeScreen />} />
          <Route path="/demo" element={<DemoHomeScreen />} />
          <Route
            path="/demo/register-violation"
            element={<DemoRegisterViolationScreen />}
          />
          <Route path="/demo/prod-control" element={<DemoProdControlScreen />} />
          <Route path="/demo/stats" element={<DemoStatsScreen />} />
          <Route path="/demo/support" element={<DemoSupportScreen />} />
          <Route path="/welcome" element={<WelcomeLoginScreen />} />
          <Route path="/register-violation" element={<RegisterViolationScreen />} />
          <Route
            path="/compose-pab"
            element={<RegisterViolationScreen title="Составление ПАБ" />}
          />
          <Route path="/my-violations" element={<MyViolationsScreen />} />
          <Route path="/stats" element={<StatsScreen />} />
          <Route path="/admin" element={<AdminScreen />} />
          <Route path="/admin/edocs" element={<AdminElectronicDocsScreen />} />
          <Route path="/admin/pc" element={<AdminPCScreen />} />
          <Route path="/admin/pc-report" element={<AdminPCReportScreen />} />
          <Route path="/admin/medicine" element={<AdminMedicineReportScreen />} />
          <Route
            path="/admin/pc-accounting"
            element={<AdminPCAccountingScreen />}
          />
          <Route path="/admin/pc-akt" element={<PcAktIssueScreen />} />
          <Route path="/admin/ud-report" element={<UdReportScreenV2 />} />
          <Route path="/admin/ud-ua-report" element={<UdUaReportScreen />} />
          <Route path="/admin/storage" element={<AdminStorageManagerPage />} />
          <Route path="/admin/itr-visits" element={<AdminITRVisitsScreen />} />
          <Route path="/itr-visits" element={<ITRVisitsScreen />} />
          <Route
            path="/prescriptions"
            element={<PrescriptionRegisterPublicScreen />}
          />
          <Route path="/admin/training" element={<AdminTrainingScreen />} />
          <Route
            path="/admin/pab-instruction"
            element={<AdminPabInstructionScreen />}
          />
          <Route
            path="/admin/prescriptions"
            element={<AdminPrescriptionRegisterScreen />}
          />
          <Route
            path="/admin/illustration"
            element={<AdminIllustrationScreen />}
          />
          <Route path="/admin/kbt" element={<AdminKBTScreen />} />
          <Route
            path="/admin/home-management"
            element={<AdminHomeManagementScreen />}
          />
          <Route path="/p/:slug" element={<SimplePageViewer />} />
          <Route path="/storage" element={<StorageScreen />} />
          <Route path="/storage/file/:id" element={<StorageFilePreview />} />
          <Route path="/profile-setup" element={<ProfileSetupScreen />} />
          <Route path="/admin/form-builder" element={<FormBuilderScreen />} />
          <Route
            path="/form-page/:slug"
            element={<InteractiveFormPageViewer />}
          />
          <Route path="/asubt" element={<ASUBTScreen />} />
          <Route path="/otpb" element={<OTPBScreen />} />
          <Route
            path="/asubt/ppe"
            element={
              <AsubtModuleScreen title="СИЗ">
                <p>Модуль «Средства индивидуальной защиты».</p>
                <p>Функционал будет добавлен позже.</p>
              </AsubtModuleScreen>
            }
          />
          <Route
            path="/asubt/sout"
            element={
              <AsubtModuleScreen title="СОУТ">
                <p>Модуль «Специальная оценка условий труда».</p>
                <p>Функционал будет добавлен позже.</p>
              </AsubtModuleScreen>
            }
          />
          <Route
            path="/asubt/mo"
            element={
              <AsubtModuleScreen title="МО">
                <p>Модуль «Медицинские осмотры».</p>
                <p>Функционал будет добавлен позже.</p>
              </AsubtModuleScreen>
            }
          />
          <Route
            path="/asubt/docs"
            element={
              <AsubtModuleScreen title="Документация">
                <p>Модуль управления документацией.</p>
                <p>Функционал будет добавлен позже.</p>
              </AsubtModuleScreen>
            }
          />
          <Route
            path="/asubt/reports"
            element={
              <AsubtModuleScreen title="Отчетность">
                <p>Блок «Отчетность в системе».</p>
                <p>
                  Здесь будут формы: 7‑травматизм, отчеты по СОУТ, условиям и
                  охране труда, аналитические отчеты по проверкам и планы
                  мероприятий.
                </p>
              </AsubtModuleScreen>
            }
          />
          <Route
            path="/asubt/work-orders"
            element={
              <AsubtModuleScreen title="Наряд-задания">
                <p>
                  Блок выдачи наряд-заданий работникам горного предприятия.
                </p>
                <p>Функционал будет добавлен позже.</p>
              </AsubtModuleScreen>
            }
          />
          <Route
            path="/asubt/planning"
            element={
              <AsubtModuleScreen title="Планирование мероприятий">
                <p>
                  Блок планирования мероприятий на год, два и три года.
                </p>
                <p>Функционал будет добавлен позже.</p>
              </AsubtModuleScreen>
            }
          />
          <Route path="/more" element={<MoreScreen />} />
          <Route path="/assignments" element={<AssignmentsJournalScreen />} />
          <Route path="/reports" element={<ReportsScreen />} />
          <Route path="/admin/summary-charts" element={<SummaryChartsScreen />} />
          <Route path="/assignments/table" element={<AssignmentsTableManager />} />
          <Route path="/installer" element={<InstallerScreen />} />
          <Route path="/constructor" element={<QuickDocConstructorScreen />} />
          <Route path="/kbt" element={<KBTScreen />} />
          <Route path="/kbt/protocols" element={<KBTProtocolsScreen />} />
          <Route path="/kbt/report" element={<KbtHtmlReportForm me={me} />} />
          <Route path="/kbt/template" element={<KbtTemplatePreviewScreen />} />
          <Route path="/kbt/editor" element={<KbtEditorScreen />} />
          <Route path="/prod-control" element={<ProdControlScreen />} />
          <Route path="/support" element={<SupportScreen />} />
          <Route path="/admin/support" element={<AdminSupportScreen />} />
          <Route path="/super-admin" element={<SuperAdminScreen_Alt />} />
          <Route
            path="/super-admin/diagnostics"
            element={<AdminDiagnosticsScreen />}
          />
          <Route
            path="/super-admin/new-assets"
            element={<SuperAdminNewAssetsScreen />}
          />
          <Route
            path="/super-admin/clients"
            element={<SuperAdminClientsListScreen />}
          />
          <Route
            path="/super-admin/login-preview"
            element={<SuperAdminLoginPreviewScreen />}
          />
          <Route
            path="/super-admin/client/:code"
            element={<SuperAdminClientSettingsScreen />}
          />
          <Route
            path="/super-admin/admins"
            element={<SuperAdminAdminsScreen />}
          />
          <Route
            path="/super-admin/admins/:userId"
            element={<SuperAdminAdminPermissionsScreen />}
          />
          <Route path="/admin/messaging" element={<AdminMessagingScreen />} />
          <Route
            path="/admin/pab-kpi-schedule"
            element={<PabKpiSchedulePage />}
          />
          <Route path="/charts" element={<ChartsSelectionScreen />} />
          <Route
            path="/charts/pab-personal"
            element={<PabPersonalChartsScreen />}
          />
          <Route path="/webinars" element={<WebinarsScreen />} />
          <Route path="/itr-attestations" element={<AttestationITRScreen />} />
          <Route path="/library" element={<LibraryScreen />} />
          <Route path="/training" element={<TrainingScreen />} />
          <Route path="/training/select" element={<TrainingSelectScreen />} />
          <Route path="/pab-self-learning" element={<PABSelfLearningScreen />} />
          <Route path="/instructions/pab" element={<PabInstructionScreen />} />
          <Route path="/admin/compare" element={<AdminCompareScreen />} />
      <Route path="/admin/info" element={<AdminInfoScreen />} />
          <Route path="/admin/users" element={<AdminUsersScreen />} />
          <Route
            path="/admin/pages-library"
            element={<AdminWorkPagesLibraryScreen />}
          />
          <Route path="/admin/safe-days" element={<AdminSafeDaysScreen />} />
          <Route
            path="/admin/intro-briefings"
            element={<AdminIntroBriefingsScreen />}
          />
        </Routes>
      </AppErrorBoundary>
    </div>
  );
}

type ListUsersOutForStorage = inferRPCOutputType<"listUsers">;

function StorageFilePreview() {
  useAuth({ required: true });
  const { toast } = useToast();
  const queryClient = useQueryClient();
  const { id } = useParams<{ id: string }>();

  const { data, isInitialLoading } = useQuery([
    "storage-file",
    id,
  ], () => apiClient.getStorageFile({ id: id as string }), { enabled: !!id });
  const file = (data as any)?.file;
  const canPreviewInline = !!file?.url && /\.(pdf|png|jpg|jpeg|gif|webp|txt)$/i.test(file.name || "");

  const { data: usersPage } = useQuery<ListUsersOutForStorage>(
    ["users-for-storage-email"],
    () => apiClient.listUsers({ page: 1, pageSize: 200 }),
    { staleTime: 30_000 },
  );
  const users = (usersPage?.items ?? []) as any[];

  const emailDocMutation = useMutation(apiClient.emailElectronicDoc, {
    onSuccess: (res: any) => {
      if (res?.ok) {
        toast({ title: "Ссылка отправлена" });
      } else {
        toast({
          title: "Не удалось отправить",
          description:
            "Проверьте корректность адреса получателя или повторите попытку позже.",
        });
      }
    },
    onError: () => {
      toast({
        title: "Ошибка отправки",
        description: "Попробуйте ещё раз позже.",
      });
    },
    onSettled: () => {
      queryClient.invalidateQueries(["storage-file", id]);
    },
  });

  const [selectedUserId, setSelectedUserId] = React.useState<string>("");
  const [manualEmail, setManualEmail] = React.useState<string>("");

  const handleSend = React.useCallback(
    (e: React.FormEvent) => {
      e.preventDefault();
      if (!file?.url) return;
      const trimmedEmail = manualEmail.trim();
      const payload: any = {
        url: file.url as string,
        name: (file.name as string) || "Документ",
      };
      if (selectedUserId) {
        payload.toUserId = selectedUserId;
      } else if (trimmedEmail) {
        payload.email = trimmedEmail;
      }
      if (!payload.toUserId && !payload.email) {
        toast({
          title: "Укажите получателя",
          description:
            "Выберите пользователя или введите адрес электронной почты.",
        });
        return;
      }
      emailDocMutation.mutate(payload);
    },
    [emailDocMutation, file, manualEmail, selectedUserId, toast],
  );

  if (isInitialLoading) {
    return (
      <div className="max-w-5xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated">
          <CardHeader>
            <CardTitle>Открытие файла…</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-sm text-muted-foreground">Пожалуйста, подождите</div>
          </CardContent>
        </Card>
      </div>
    );
  }

  if (!file) {
    return (
      <div className="max-w-5xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated">
          <CardHeader>
            <CardTitle>Файл не найден</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-sm text-muted-foreground">Проверьте ссылку или вернитесь в Хранилище.</div>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="max-w-5xl mx-auto p-4 sm:p-6 space-y-4">
      <Card className="card-elevated">
        <CardHeader>
          <CardTitle className="truncate">{file.name}</CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          {canPreviewInline ? (
            <div className="w-full">
              {/\.pdf$/i.test(file.name || "") ? (
                <iframe src={file.url} className="w-full h-[70vh] border rounded" />
              ) : (
                <img src={file.url} alt={file.name} className="max-h-[70vh] object-contain mx-auto" />
              )}
            </div>
          ) : (
            <div className="text-sm text-muted-foreground">Предпросмотр недоступен для этого типа файла. Вы можете скачать его ниже.</div>
          )}

          <div className="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
            <div className="flex items-center gap-2">
              <Button asChild>
                <a href={file.url} download={file.name || "file"}>Скачать</a>
              </Button>
              <Button variant="secondary" asChild>
                <a href={file.url} target="_blank" rel="noreferrer">Открыть в новой вкладке</a>
              </Button>
            </div>

            <form
              onSubmit={handleSend}
              className="flex flex-col gap-2 sm:flex-row sm:items-center"
            >
              <select
                className="border rounded px-2 py-1 text-sm min-w-[180px]"
                value={selectedUserId}
                onChange={(e) => setSelectedUserId(e.target.value)}
              >
                <option value="">Кому (список пользователей)</option>
                {users.map((u: any) => (
                  <option key={u.id} value={u.id}>
                    {u.fullName || u.email || "Без имени"}
                  </option>
                ))}
              </select>
              <span className="text-xs text-muted-foreground">или</span>
              <Input
                className="sm:w-56"
                placeholder="Email вручную"
                value={manualEmail}
                onChange={(e) => setManualEmail(e.target.value)}
              />
              <Button
                type="submit"
                size="sm"
                disabled={emailDocMutation.isLoading}
              >
                {emailDocMutation.isLoading ? "Отправка…" : "Отправить ссылку"}
              </Button>
            </form>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}

function AdminIntroBriefingsScreen() {
  useAuth({ required: true });
  const { toast } = useToast();
  const { data: me } = useQuery<Profile>(["me"], () => apiClient.getMyProfile());
  const isSuper = !!(me as any)?.isSuperAdmin;
  const isAdmin = !!me?.isAdmin || isSuper;
  const queryClient = useQueryClient();

  const [date, setDate] = React.useState<string>(() => new Date().toISOString().slice(0, 10));
  const [count, setCount] = React.useState<string>("");

  type IntroBriefingList = inferRPCOutputType<"listIntroBriefings">;
  const { data: items, isInitialLoading } = useQuery<IntroBriefingList>(
    ["intro-briefings"],
    () => apiClient.listIntroBriefings(),
    { enabled: isAdmin, keepPreviousData: true }
  );

  const save = useMutation(apiClient.upsertIntroBriefing, {
    onSuccess: async (res: any) => {
      if (res?.ok) {
        toast({ title: "Сохранено" });
        await queryClient.invalidateQueries({ queryKey: ["intro-briefings"] });
        setCount("");
      } else if (res?.error === "INVALID_DATE") {
        toast({ title: "Некорректная дата" });
      } else {
        toast({ title: "Не удалось сохранить" });
      }
    },
    onError: () => toast({ title: "Ошибка сохранения" }),
  });



  const handleSave = (e: React.FormEvent) => {
    e.preventDefault();
    if (!date) {
      toast({ title: "Выберите дату" });
      return;
    }
    const n = parseInt((count || "0").trim(), 10);
    if (Number.isNaN(n) || n < 0) {
      toast({ title: "Введите корректное количество" });
      return;
    }
    if (save.isLoading) return;
    save.mutate({ date, count: n });
  };

  const startEdit = (it: any) => {
    const d = new Date(it.date);
    const ds = new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()))
      .toISOString()
      .slice(0, 10);
    setDate(ds);
    setCount(String(it.count ?? ""));
  };

  const deleteAll = useMutation(apiClient.deleteAllIntroBriefings, {
    onSuccess: async (res: any) => {
      if (res?.ok) {
        toast({ title: "Все записи удалены" });
        await queryClient.invalidateQueries({ queryKey: ["intro-briefings"] });
      } else {
        toast({ title: "Не удалось очистить" });
      }
    },
    onError: () => toast({ title: "Ошибка очистки" }),
  });

  const resetForm = () => {
    setDate(new Date().toISOString().slice(0, 10));
    setCount("");
  };

  const formatDateDMY = (iso: string) => {
    const d = new Date(iso);
    const dd = String(d.getUTCDate()).padStart(2, "0");
    const mm = String(d.getUTCMonth() + 1).padStart(2, "0");
    const yyyy = d.getUTCFullYear();
    return `${dd}.${mm}.${yyyy}`;
  };

  if (!isAdmin) {
    return (
      <div className="max-w-3xl mx-auto p-4 sm:p-6 space-y-4">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Доступ ограничен</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">Страница доступна только администраторам.</div>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="max-w-3xl mx-auto p-4 sm:p-6 space-y-4">
      <Card className="card-elevated h-full">
          <CardHeader>
            <div className="flex items-center justify-between gap-3">
              <div>
                <CardTitle>Учет вводных инструктажей</CardTitle>
                <CardDescription>Введите дату и количество проведенных вводных инструктажей. Записи по одной дате перезаписываются.</CardDescription>
              </div>
              {isSuper && (
                <AlertDialog>
                  <AlertDialogTrigger asChild>
                    <Button variant="destructive">Очистить все записи</Button>
                  </AlertDialogTrigger>
                  <AlertDialogContent>
                    <AlertDialogHeader>
                      <AlertDialogTitle>Очистить все записи?</AlertDialogTitle>
                      <AlertDialogDescription>
                        Это удалит все сохраненные даты и количества. Действие доступно только главному администратору и не может быть отменено.
                      </AlertDialogDescription>
                    </AlertDialogHeader>
                    <AlertDialogFooter>
                      <AlertDialogCancel>Отмена</AlertDialogCancel>
                      <AlertDialogAction onClick={() => deleteAll.mutate()}>Удалить</AlertDialogAction>
                    </AlertDialogFooter>
                  </AlertDialogContent>
                </AlertDialog>
              )}
            </div>
          </CardHeader>        <CardContent className="space-y-4">
          <div className="rounded-md bg-muted px-3 py-2 text-sm mb-3">
            Всего загруженных позиций: {(items as any)?.length ?? 0}
          </div>

          <form className="grid grid-cols-1 sm:grid-cols-[1fr_1fr_auto_auto] gap-3 items-end" onSubmit={handleSave}>
            <div className="grid gap-1">
              <Label>Дата</Label>
              <Input type="date" value={date} onChange={(e) => setDate(e.target.value)} />
            </div>
            <div className="grid gap-1">
              <Label>Количество</Label>
              <Input type="number" min={0} inputMode="numeric" value={count} onChange={(e) => setCount(e.target.value)} placeholder="Напр. 12" />
            </div>
            <div className="flex gap-2">
              <Button type="submit" disabled={save.isLoading}>{save.isLoading ? "Сохраняем…" : "Сохранить"}</Button>
              <Button type="button" variant="secondary" onClick={resetForm} disabled={save.isLoading}>Очистить</Button>
            </div>
          </form>

          <div className="hr-muted w-full h-px" />

          <div className="space-y-2">
            <div className="font-medium">Все записи</div>
            <div className="border rounded overflow-hidden">
              <div className="grid grid-cols-3 bg-secondary px-3 py-2 text-sm font-medium sticky top-0 z-10">
                <div>Дата</div>
                <div className="text-right">Количество</div>
                <div className="text-right">Действия</div>
              </div>
              <div className="max-h-[60vh] overflow-y-auto">
                {isInitialLoading ? (
                  <div className="px-3 py-3 text-sm text-muted-foreground">Загрузка…</div>
                ) : (items as any)?.length ? (
                  (items as any).map((it: any) => (
                    <div key={it.id} className="grid grid-cols-3 px-3 py-2 border-t text-sm items-center">
                      <div>{formatDateDMY(it.date)}</div>
                      <div className="text-right font-semibold">{it.count}</div>
                      <div className="text-right">
                        <Button size="sm" variant="outline" onClick={() => startEdit(it)}>Править</Button>
                      </div>
                    </div>
                  ))
                ) : (
                  <div className="px-3 py-3 text-sm text-muted-foreground">Нет данных</div>
                )}
              </div>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}

function AdminSafeDaysScreen() {
  useAuth({ required: true });
  const queryClient = useQueryClient();
  const { data, isInitialLoading, isFetching, refetch, error } = useQuery(
    ["safe-days"],
    () => apiClient.getSafeDaysStats({}),
    { keepPreviousData: true, staleTime: 5 * 60 * 1000 },
  );

  // Accidents registry: list and create minimal form
  const { data: accidents, isFetching: isFetchingAcc } = useQuery(
    ["accidents"],
    () => apiClient.listAccidents({ take: 50 }),
    { keepPreviousData: true, staleTime: 5 * 60 * 1000 },
  );

  const createAccident = useMutation(apiClient.createAccident, {
    onSuccess: () => {
      void queryClient.invalidateQueries(["accidents"]);
      void queryClient.invalidateQueries(["safe-days"]);
    },
  });

  const todayIso = (() => {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  })();

  const startOfMonthIso = (() => {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    return `${yyyy}-${mm}-01`;
  })();

  const [period, setPeriod] = React.useState({ from: startOfMonthIso, to: todayIso });
  const getRange = useMutation(apiClient.getSafeDaysForRange);
  const onCalcPeriod: React.FormEventHandler<HTMLFormElement> = (e) => {
    e.preventDefault();
    if (!period.from || !period.to) return;
    getRange.mutate({ from: period.from, to: period.to });
  };

  const [form, setForm] = React.useState({
    date: todayIso,
    title: "",
    department: "",
    severity: "",
  });

  const onSubmitAccident: React.FormEventHandler<HTMLFormElement> = (e) => {
    e.preventDefault();
    if (!form.date) return;
    createAccident.mutate({
      date: form.date,
      title: form.title?.trim() || undefined,
      department: form.department?.trim() || undefined,
      severity: form.severity?.trim() || undefined,
    });
  };

  const SummaryItem = ({
    label,
    value,
    icon,
    accent,
  }: {
    label: string;
    value: React.ReactNode;
    icon: React.ReactNode;
    accent: "primary" | "secondary" | "accent";
  }) => (
    <Card className="flex flex-col">
      <CardHeader className="flex flex-row items-center justify-between pb-2">
        <CardTitle className="text-sm font-medium text-muted-foreground">
          {label}
        </CardTitle>
        <div
          className={
            "rounded-full p-2 " +
            (accent === "primary"
              ? "bg-primary text-primary-foreground"
              : accent === "secondary"
                ? "bg-secondary text-secondary-foreground"
                : "bg-accent text-accent-foreground")
          }
        >
          {icon}
        </div>
      </CardHeader>
      <CardContent>
        <div className="text-3xl font-bold">
          {isInitialLoading ? "…" : value}
        </div>
      </CardContent>
    </Card>
  );

  const fmtDate = (iso?: string | null) => {
    if (!iso) return "—";
    const d = new Date(iso);
    const dd = String(d.getDate()).padStart(2, "0");
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const yyyy = d.getFullYear();
    return `${dd}.${mm}.${yyyy}`;
  };

  return (
    <div className="p-4 sm:p-6">
      <div className="flex items-center justify-between mb-4">
        <div>
          <h1 className="text-xl sm:text-2xl font-semibold">Безопасные дни</h1>
          <p className="text-sm text-muted-foreground">
            Обновлено: {data?.asOf ? fmtDate(data.asOf) : "—"}
            {isFetching && " • обновляется…"}
          </p>
        </div>
        <div className="flex gap-2">
          <Button
            variant="secondary"
            onClick={() => refetch()}
            disabled={isFetching}
          >
            {isFetching ? "Обновляем…" : "Обновить"}
          </Button>
        </div>
      </div>

      {error && (
        <Alert variant="destructive" className="mb-4">
          <AlertTriangle className="h-4 w-4" />
          <AlertTitle>Не удалось загрузить</AlertTitle>
          <AlertDescription>
            Проверьте подключение к интернету и попробуйте снова.
          </AlertDescription>
        </Alert>
      )}

      {getRange.data && (
        <div className="text-sm text-muted-foreground mb-2">
          Показатели за период: {fmtDate(getRange.data.period.from)} — {fmtDate(getRange.data.period.to)}
        </div>
      )}
      <div className="grid gap-4 sm:gap-6 sm:grid-cols-3">
        <SummaryItem
          label="Безопасных дней в месяце"
          value={(getRange.data ? getRange.data.safeDays : data?.monthSafeDays) ?? "—"}
          icon={<CalendarDays className="h-4 w-4" />}
          accent="primary"
        />
        <SummaryItem
          label="Безопасных дней с начала года"
          value={(getRange.data ? getRange.data.safeDays : data?.yearSafeDays) ?? "—"}
          icon={<CalendarRange className="h-4 w-4" />}
          accent="secondary"
        />
        <SummaryItem
          label="Со дня последнего н/с"
          value={getRange.data ? getRange.data.safeDays : (data?.sinceLastAccidentSafeDays ?? "—")}
          icon={<TimerReset className="h-4 w-4" />}
          accent="accent"
        />
      </div>

      <Card className="mt-6">
        <CardHeader>
          <CardTitle>Сводка</CardTitle>
          <CardDescription>
            Последний н/с: {fmtDate(data?.lastAccidentDate)} · В этом месяце:{" "}
            {data?.accidentsThisMonth ?? 0} · В этом году:{" "}
            {data?.accidentsThisYear ?? 0}
          </CardDescription>
        </CardHeader>
          <CardContent>
            <form onSubmit={onCalcPeriod} className="grid grid-cols-1 sm:grid-cols-[1fr_1fr_auto] gap-3 items-end mb-4">
              <div className="space-y-1">
                <Label>С даты</Label>
                <Input
                  type="date"
                  value={period.from}
                  onChange={(e) => setPeriod((s) => ({ ...s, from: e.target.value }))}
                />
              </div>
              <div className="space-y-1">
                <Label>По дату</Label>
                <Input
                  type="date"
                  value={period.to}
                  onChange={(e) => setPeriod((s) => ({ ...s, to: e.target.value }))}
                />
              </div>
              <div>
                <Button type="submit" disabled={getRange.isLoading}>
                  {getRange.isLoading ? "Считаем…" : "Показать"}
                </Button>
              </div>
            </form>

            {getRange.data && (
              <div className="rounded-lg bg-muted p-4 mb-4">
                <div className="text-sm text-muted-foreground mb-1">
                  Период: {fmtDate(getRange.data.period.from)} — {fmtDate(getRange.data.period.to)}
                </div>
                <div className="text-2xl font-bold">
                  {getRange.data.safeDays} безопасных дней
                </div>
                <div className="text-sm text-muted-foreground mt-1">
                  Последний н/с в периоде: {fmtDate(getRange.data.lastAccidentDateInRange)} · Н/с в периоде: {getRange.data.accidentsCount}
                </div>
              </div>
            )}

            {data?.totalAccidentsConsidered === 0 ? (
              <div className="text-sm text-muted-foreground">
                В базе ещё нет зарегистрированных несчастных случаев. Показатели
                за месяц и год считаются от начала соответствующего периода.
              </div>
            ) : (
              <div className="text-sm text-muted-foreground">
                Безопасные дни считаются от даты последнего н/с в пределах
                периода.
              </div>
            )}
          </CardContent>      </Card>

      <div className="grid gap-4 sm:gap-6 sm:grid-cols-2 mt-6">
        <Card>
          <CardHeader>
            <CardTitle>Добавить несчастный случай</CardTitle>
            <CardDescription>
              Дата обязательна, остальное — по желанию. После добавления
              показатели пересчитаются автоматически.
            </CardDescription>
          </CardHeader>
          <CardContent>
            <form onSubmit={onSubmitAccident} className="space-y-3">
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div className="space-y-1">
                  <Label>Дата</Label>
                  <Input
                    type="date"
                    value={form.date}
                    onChange={(e) =>
                      setForm((s) => ({ ...s, date: e.target.value }))
                    }
                    required
                  />
                </div>
                <div className="space-y-1">
                  <Label>Подразделение</Label>
                  <Input
                    placeholder="Цех / участок"
                    value={form.department}
                    onChange={(e) =>
                      setForm((s) => ({ ...s, department: e.target.value }))
                    }
                  />
                </div>
              </div>
              <div className="space-y-1">
                <Label>Краткое описание</Label>
                <Input
                  placeholder="Например: травма руки"
                  value={form.title}
                  onChange={(e) => setForm((s) => ({ ...s, title: e.target.value }))}
                />
              </div>
              <div className="space-y-1">
                <Label>Тяжесть (опционально)</Label>
                <Input
                  placeholder="лёгкая / средняя / тяжёлая"
                  value={form.severity}
                  onChange={(e) =>
                    setForm((s) => ({ ...s, severity: e.target.value }))
                  }
                />
              </div>
              {createAccident.isError && (
                <Alert variant="destructive">
                  <AlertTriangle className="h-4 w-4" />
                  <AlertTitle>Не удалось сохранить</AlertTitle>
                  <AlertDescription>
                    Проверьте данные и подключение к интернету и попробуйте снова.
                  </AlertDescription>
                </Alert>
              )}
              <div className="flex gap-2">
                <Button type="submit" disabled={createAccident.isLoading}>
                  {createAccident.isLoading ? "Сохраняем…" : "Добавить"}
                </Button>
                <Button
                  type="button"
                  variant="secondary"
                  onClick={() =>
                    setForm({ date: todayIso, title: "", department: "", severity: "" })
                  }
                >
                  Сбросить
                </Button>
              </div>
            </form>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle>Журнал несчастных случаев</CardTitle>
            <CardDescription>
              Показаны последние записи. {isFetchingAcc && "Обновление…"}
            </CardDescription>
          </CardHeader>
          <CardContent>
            {!accidents || accidents.length === 0 ? (
              <div className="text-sm text-muted-foreground">
                Записей пока нет.
              </div>
            ) : (
              <div className="overflow-x-auto -mx-2 sm:mx-0">
                <Table>
                  <TableHeader>
                    <TableRow>
                      <TableHead>Дата</TableHead>
                      <TableHead>Подразделение</TableHead>
                      <TableHead>Описание</TableHead>
                      <TableHead>Тяжесть</TableHead>
                    </TableRow>
                  </TableHeader>
                  <TableBody>
                    {accidents.map((a: any) => (
                      <TableRow key={a.id}>
                        <TableCell className="whitespace-nowrap">{fmtDate(a.date)}</TableCell>
                        <TableCell>{a.department ?? "—"}</TableCell>
                        <TableCell>{a.title ?? "—"}</TableCell>
                        <TableCell>{a.severity ?? "—"}</TableCell>
                      </TableRow>
                    ))}
                  </TableBody>
                </Table>
              </div>
            )}
          </CardContent>
        </Card>
      </div>
    </div>
  );
}

function CreateKbtMeetingForm({ onCreated }: { onCreated: () => void }) {
  const queryClient = useQueryClient();
  const { toast } = useToast();
  const [title, setTitle] = useState("");
  const [date, setDate] = useState("");
  const create = useMutation(apiClient.createKbtMeeting, {
    onSuccess: async () => {
      setTitle("");
      setDate("");
      await queryClient.invalidateQueries({ queryKey: ["kbt-meetings"] });
      toast({ title: "Добавлено" });
      onCreated();
    },
    onError: () => toast({ title: "Не удалось добавить" }),
  });
  return (
    <div className="mt-3 border rounded p-3">
      <div className="font-medium mb-2">Добавить собрание</div>
      <div className="grid sm:grid-cols-3 gap-2 items-end">
        <div className="grid gap-1">
          <Label>Тема</Label>
          <Input
            value={title}
            onChange={(e) => setTitle(e.target.value)}
            placeholder="Наименование темы"
          />
        </div>
        <div className="grid gap-1">
          <Label>Дата проведения</Label>
          <Input
            type="date"
            value={date}
            onChange={(e) => setDate(e.target.value)}
          />
        </div>
        <Button
          className="btn-3d"
          disabled={!title || !date || create.isLoading}
          onClick={() => create.mutate({ title, date })}
        >
          {create.isLoading ? "Сохраняем…" : "Добавить"}
        </Button>
      </div>
    </div>
  );
}

function DeleteKbtMeetingButton({ id }: { id: string }) {
  const queryClient = useQueryClient();
  const { toast } = useToast();
  const del = useMutation(apiClient.deleteKbtMeeting, {
    onSuccess: async () => {
      await queryClient.invalidateQueries({ queryKey: ["kbt-meetings"] });
      toast({ title: "Удалено" });
    },
    onError: () => toast({ title: "Не удалось удалить" }),
  });
  return (
    <Button
      size="sm"
      variant="destructive"
      disabled={del.isLoading}
      onClick={() => {
        if (!confirm("Удалить запись?")) return;
        del.mutate({ id });
      }}
    >
      Удалить
    </Button>
  );
}

function InstallerScreen() {
  const navigate = useNavigate();
  const { toast } = useToast();
  const appUrl = useMemo(() => new URL("/", getBaseUrl()).toString(), []);
  const [qr, setQr] = useState<string>("");
  const [isStandalone, setIsStandalone] = useState<boolean>(false);
  const [deferredPrompt, setDeferredPrompt] = useState<any>(null);

  useEffect(() => {
    let mounted = true;
    (async () => {
      try {
        const dataUrl = await QRCode.toDataURL(appUrl, { width: 320, margin: 1 });
        if (mounted) setQr(dataUrl);
      } catch {
        /* ignore */
      }
    })();

    const media = window.matchMedia("(display-mode: standalone)");
    const updateStandalone = () => setIsStandalone(media.matches || (window as any).navigator?.standalone);
    updateStandalone();
    media.addEventListener?.("change", updateStandalone);

    const handler = (e: any) => {
      e.preventDefault();
      setDeferredPrompt(e);
    };
    window.addEventListener("beforeinstallprompt", handler as any);

    return () => {
      mounted = false;
      media.removeEventListener?.("change", updateStandalone);
      window.removeEventListener("beforeinstallprompt", handler as any);
    };
  }, [appUrl]);

  const download = (filename: string, content: string, mime = "text/plain;charset=utf-8") => {
    const blob = new Blob([content], { type: mime });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  };

  const downloadWindowsShortcut = () => {
    const text = `[InternetShortcut]\nURL=${appUrl}\n`;
    download("АСУБТ.url", text);
  };
  const downloadMacWebloc = () => {
    const xml = `<?xml version="1.0" encoding="UTF-8"?>\n<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">\n<plist version="1.0"><dict><key>URL</key><string>${appUrl}</string></dict></plist>`;
    download("АСУБТ.webloc", xml, "application/xml;charset=utf-8");
  };
  const downloadLinuxDesktop = () => {
    const ini = `[Desktop Entry]\nVersion=1.0\nType=Link\nName=АСУБТ\nURL=${appUrl}\n`;
    download("asubt.desktop", ini);
  };

  const downloadWindowsInstallerPs1 = () => {
    const ps1 = `# ASUBT Setup v2.1.5
$ErrorActionPreference = 'SilentlyContinue'
$AppName = 'АСУБТ'
$AppUrl = '${appUrl}'
$edge = @(
  "$Env:ProgramFiles (x86)\Microsoft\Edge\Application\msedge.exe",
  "$Env:ProgramFiles\Microsoft\Edge\Application\msedge.exe"
)
$chrome = @(
  "$Env:ProgramFiles\Google\Chrome\Application\chrome.exe",
  "$Env:ProgramFiles (x86)\Google\Chrome\Application\chrome.exe"
)
$browser = @($edge + $chrome) | Where-Object { Test-Path $_ } | Select-Object -First 1
if (-not $browser) {
  Write-Host 'Не найден Edge или Chrome. Откройте сайт в браузере.'
  Start-Process $AppUrl
  exit 0
}
$appArgs = "--app=\"$AppUrl\" --new-window"
$w = New-Object -ComObject WScript.Shell
$desktop = [Environment]::GetFolderPath('Desktop')
$startMenu = Join-Path $Env:AppData 'Microsoft\\Windows\\Start Menu\\Programs'
$links = @(
  (Join-Path $desktop 'АСУБТ.lnk'),
  (Join-Path $startMenu 'АСУБТ.lnk')
)
foreach ($p in $links) {
  $s = $w.CreateShortcut($p)
  $s.TargetPath = $browser
  $s.Arguments = $appArgs
  $s.WindowStyle = 1
  $s.IconLocation = "$browser,0"
  $s.Description = 'АСУБТ (онлайн/офлайн)'
  $s.Save()
}
Start-Process -FilePath $browser -ArgumentList $appArgs
Write-Host 'Готово: ярлык создан и приложение запущено.'
`;
    download('ASUBT_Setup_v2.1.5.ps1', ps1, 'application/octet-stream');
  };

  const downloadWindowsInstallerCmd = () => {
    const cmd = `@echo off
setlocal
set "URL=${appUrl}"
set "BROWSER="
if exist "%ProgramFiles(x86)%\Microsoft\Edge\Application\msedge.exe" set "BROWSER=%ProgramFiles(x86)%\Microsoft\Edge\Application\msedge.exe"
if exist "%ProgramFiles%\Microsoft\Edge\Application\msedge.exe" set "BROWSER=%ProgramFiles%\Microsoft\Edge\Application\msedge.exe"
if exist "%ProgramFiles%\Google\Chrome\Application\chrome.exe" set "BROWSER=%ProgramFiles%\Google\Chrome\Application\chrome.exe"
if exist "%ProgramFiles(x86)%\Google\Chrome\Application\chrome.exe" set "BROWSER=%ProgramFiles(x86)%\Google\Chrome\Application\chrome.exe"
if "%BROWSER%"=="" (
  echo Не найден Edge/Chrome. Открываю сайт...
  start "" "%URL%"
  exit /b 0
)
set "ASUBT_BROWSER=%BROWSER%"
set "ASUBT_URL=%URL%"
powershell -NoProfile -ExecutionPolicy Bypass -Command ^
  "$browser=$env:ASUBT_BROWSER; $url=$env:ASUBT_URL; $args='--app=\"'+$url+'\" --new-window';" ^
  "$w=New-Object -ComObject WScript.Shell; $d=[Environment]::GetFolderPath('Desktop'); $s=Join-Path $env:AppData 'Microsoft\Windows\Start Menu\Programs';" ^
  "foreach($p in @((Join-Path $d 'АСУБТ.lnk'), (Join-Path $s 'АСУБТ.lnk'))){$c=$w.CreateShortcut($p);$c.TargetPath=$browser;$c.Arguments=$args;$c.IconLocation=$browser+',0';$c.Save()};" ^
  "Start-Process -FilePath $browser -ArgumentList $args"
endlocal
`;
    download('ASUBT_Setup_v2.1.5.cmd', cmd, 'application/octet-stream');
  };

  return (
    <div className="max-w-3xl mx-auto p-4 sm:p-6">
      <Card className="card-elevated">
        <CardHeader className="flex items-center justify-between">
          <CardTitle>Установочный файл</CardTitle>
          <Button variant="ghost" onClick={() => navigate(-1)}>Назад</Button>
        </CardHeader>
        <CardContent className="space-y-6">
          <div className="flex items-center gap-3">
            <div className="w-12 h-12 rounded-full bg-primary text-primary-foreground flex items-center justify-center text-lg font-bold">А</div>
            <div>
              <div className="text-base font-semibold">АСУБТ</div>
              <div className="text-xs text-muted-foreground">Онлайн и офлайн режим</div>
            </div>
          </div>

          {isStandalone ? (
            <Alert>
              <div className="text-sm">Приложение установлено. Обновления применяются при подключении к сети. Офлайн‑данные сохраняются автоматически.</div>
            </Alert>
          ) : (
            <div className="space-y-2">
              <div className="text-sm text-muted-foreground">Быстрая установка как приложение в браузере</div>
              <Button
                disabled={!deferredPrompt}
                onClick={async () => {
                  if (!deferredPrompt) {
                    toast({ title: "Установка недоступна", description: "Браузер не предложил установку. Используйте ярлык или добавьте на главный экран." });
                    return;
                  }
                  try {
                    await deferredPrompt.prompt();
                    await deferredPrompt.userChoice;
                    setDeferredPrompt(null);
                  } catch {
                    /* ignore */
                  }
                }}
              >
                Установить как приложение
              </Button>
              <div className="text-xs text-muted-foreground">Если кнопка недоступна, вы можете добавить ярлык с помощью файлов ниже или через меню браузера «Добавить на главный экран/Установить приложение».</div>
            </div>
          )}

          <div className="space-y-2">
            <div className="font-medium">Установщик для Windows</div>
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 items-start">
              <div className="space-y-2">
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                  <Button variant="default" onClick={downloadWindowsInstallerCmd}>ASUBT_Setup_v2.1.5.cmd</Button>
                  <Button variant="secondary" onClick={downloadWindowsInstallerPs1}>ASUBT_Setup_v2.1.5.ps1</Button>
                </div>
                <div className="text-xs text-muted-foreground">CMD запускает PowerShell‑скрипт, который создаёт ярлык на рабочем столе и в меню «Пуск» и открывает АСУБТ как отдельное окно через Edge/Chrome. Если CMD заблокирован политиками, используйте .ps1.</div>
              </div>
              <div className="rounded-lg border p-4 bg-muted/30">
                <div className="text-xs text-muted-foreground mb-2">Пример ярлыка на рабочем столе</div>
                <div className="flex items-center gap-3">
                  <div className="relative inline-flex flex-col items-center gap-2">
                    <div className="relative w-14 h-14 rounded-md bg-primary text-primary-foreground flex items-center justify-center text-xl font-bold shadow select-none">
                      А
                      <span className="absolute -bottom-1 -right-1 w-5 h-5 rounded bg-white text-foreground border flex items-center justify-center text-[10px] leading-none shadow">↗</span>
                    </div>
                    <div className="text-[11px]">АСУБТ</div>
                  </div>
                </div>
                <div className="mt-3">
                  <div className="text-xs font-medium mb-1">Если ярлык не появился</div>
                  <ul className="list-disc pl-5 space-y-1 text-xs text-muted-foreground">
                    <li>Запустите файл .ps1 «От имени администратора».</li>
                    <li>Откройте Свойства скачанного файла и снимите «Разблокировать», если есть.</li>
                    <li>Разрешите запуск скриптов на время: PowerShell (Адм.) → Set-ExecutionPolicy -Scope CurrentUser RemoteSigned.</li>
                    <li>Проверьте, что папка «Рабочий стол» вашего профиля доступна. Ярлык также создаётся в меню «Пуск».</li>
                    <li>Используйте альтернативу ниже: «Windows (.url)», либо кнопку «Установить как приложение» выше.</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>

          <div className="space-y-2">
            <div className="font-medium">Ярлык для рабочего стола (альтернатива)</div>
            <div className="grid grid-cols-1 sm:grid-cols-3 gap-2">
              <Button variant="secondary" onClick={downloadWindowsShortcut}>Windows (.url)</Button>
              <Button variant="secondary" onClick={downloadMacWebloc}>macOS (.webloc)</Button>
              <Button variant="secondary" onClick={downloadLinuxDesktop}>Linux (.desktop)</Button>
            </div>
            <div className="text-xs text-muted-foreground">Откройте файл после скачивания — ярлык появится в вашей системе и будет запускать АСУБТ. Приложение работает офлайн и синхронизируется при появлении сети.</div>
          </div>

          <div className="space-y-2">
            <div className="font-medium">Открыть на телефоне</div>
            <div className="flex items-center gap-4">
              {qr ? (
                <img src={qr} alt="QR" className="w-28 h-28 bg-white p-1 border rounded" />
              ) : (
                <div className="text-sm text-muted-foreground">Генерация QR…</div>
              )}
              <div className="text-xs text-muted-foreground">Сканируйте QR‑код камерой смартфона и добавьте АСУБТ на главный экран через меню браузера.</div>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}

function AdminPCReportScreen() {
  const auth = useAuth({ required: true });
  const { data: me } = useQuery<Profile>(["me"], () => apiClient.getMyProfile());
  const isAdmin = !!me?.isAdmin;
  const queryClient = useQueryClient();
  const { toast } = useToast();

  type Row = {
    id: string;
    asubtNumber: string;
    docNumber: string;
    issuedActs: string;
    foundQty: string;
    fixedQty: string;
    inWorkQty: string;
    overdueQty: string;
    department: string;
    responsible: string;
    status: string;
    checkDate: string;
    dueDate: string;
    extra?: string[]; // дополнительные ячейки, если в Excel колонок больше
  };

  const todayISO = new Date(Date.now() - new Date().getTimezoneOffset() * 60000)
    .toISOString()
    .slice(0, 10);

  const makeEmptyRow = (): Row => ({
    id: crypto.randomUUID(),
    asubtNumber: "",
    docNumber: "",
    issuedActs: "",
    foundQty: "",
    fixedQty: "",
    inWorkQty: "",
    overdueQty: "",
    department: "",
    responsible: "",
    status: "В работе",
    checkDate: todayISO,
    dueDate: todayISO,
    extra: [],
  });

  const [rows, setRows] = React.useState<Row[]>([makeEmptyRow()]);

  // Загрузка сохраненных данных
  const pcQuery = useQuery(["pcReport"], () => apiClient.getPcReport(), {
    staleTime: 60_000,
  });

  const arrayToRow = (a: string[]): Row => {
    const safe = (i: number) => (a?.[i] ?? "") as string;
    const base: Row = {
      id: crypto.randomUUID(),
      asubtNumber: safe(0),
      docNumber: safe(1),
      issuedActs: safe(2),
      foundQty: safe(3),
      fixedQty: safe(4),
      inWorkQty: safe(5),
      overdueQty: safe(6),
      department: safe(7),
      responsible: safe(8),
      status: safe(9) || "В работе",
      checkDate: (safe(10) || todayISO).slice(0, 10),
      dueDate: (safe(11) || todayISO).slice(0, 10),
      extra: [],
    };
    const extra = a.slice(12).map((v) => (v ?? "") as string);
    return { ...base, extra };
  };

  const rowToArray = (r: Row): string[] => [
    r.asubtNumber,
    r.docNumber,
    r.issuedActs,
    r.foundQty,
    r.fixedQty,
    r.inWorkQty,
    r.overdueQty,
    r.department,
    r.responsible,
    r.status,
    r.checkDate,
    r.dueDate,
    ...(r.extra ?? []),
  ];

  React.useEffect(() => {
    const data = pcQuery.data as { rows: string[][] } | undefined;
    if (data) {
      const mapped = (data.rows ?? []).map(arrayToRow);
      if (mapped.length > 0) setRows(mapped);
    }
  }, [pcQuery.data]);

  const addRow = () => setRows((prev) => [...prev, makeEmptyRow()]);

  const updateCell = (id: string, key: keyof Row, value: string) =>
    setRows((prev) => prev.map((r) => (r.id === id ? { ...r, [key]: value } : r)));

  const updateExtraCell = (id: string, idx: number, value: string) =>
    setRows((prev) =>
      prev.map((r) =>
        r.id === id
          ? { ...r, extra: Object.assign([], r.extra ?? [], { [idx]: value }) as string[] }
          : r,
      ),
    );

  const removeRow = (id: string) => setRows((prev) => prev.filter((r) => r.id !== id));

  const extraColCount = React.useMemo(
    () => Math.max(0, ...rows.map((r) => (r.extra?.length ?? 0))),
    [rows],
  );

  // Сохранение
  const saveMutation = useMutation(apiClient.savePcReport, {
    onSuccess: () => {
      toast({ title: "Сохранено" });
      void queryClient.invalidateQueries(["pcReport"]);
    },
    onError: () => {
      toast({ title: "Не удалось сохранить", description: "Попробуйте ещё раз" });
    },
  });

  const handleSave = () => {
    const payload = rows.map(rowToArray);
    saveMutation.mutate({ rows: payload });
  };

  // Импорт из Excel
  const fileRef = React.useRef<HTMLInputElement>(null);
  const onPickExcel = () => fileRef.current?.click();

  const onExcelChange: React.ChangeEventHandler<HTMLInputElement> = async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    try {
      const buf = await file.arrayBuffer();
      const wb = XLSX.read(buf, { type: "array" });
      const sheet = wb.Sheets[wb.SheetNames[0]];
      const aoa = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false }) as (string | number | null)[][];
      const cleaned = aoa
        .map((row) => (row ?? []).map((v) => (v == null ? "" : String(v))))
        .filter((row) => row.some((v) => v && String(v).trim() !== ""));
      // Отбросить строку заголовка, если она похожа на нашу шапку
      const looksLikeHeader = (r: string[]) =>
        r.join(" ").toLowerCase().includes("асубт") || r.join(" ").toLowerCase().includes("документ");
      const rowsOnly = cleaned.length && looksLikeHeader(cleaned[0] as string[])
        ? cleaned.slice(1)
        : cleaned;
      const mapped = rowsOnly.map((r) => arrayToRow(r as string[]));
      setRows(mapped.length ? mapped : [makeEmptyRow()]);
      toast({ title: "Импорт завершён", description: `Строк: ${mapped.length}` });
    } catch {
      toast({ title: "Ошибка импорта", description: "Проверьте файл Excel" });
    } finally {
      // сбросить input, чтобы можно было выбрать тот же файл снова
      if (fileRef.current) fileRef.current.value = "";
    }
  };

  if (!isAdmin) {
    return (
      <div className="max-w-6xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Доступ ограничен</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">Эта страница доступна только администраторам.</div>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="max-w-full mx-auto p-4 sm:p-6">
      <Card className="card-elevated">
        <CardHeader className="flex items-center justify-between gap-2">
          <CardTitle>Для отчета по ПК</CardTitle>
          <div className="flex flex-wrap gap-2">
            <Button variant="secondary" onClick={addRow}>Добавить строку</Button>
            <Button variant="outline" onClick={onPickExcel}>Импорт из Excel</Button>
            <Button onClick={() => pcQuery.refetch()} variant="outline">Загрузить</Button>
            <Button onClick={handleSave} disabled={saveMutation.isLoading}>
              {saveMutation.isLoading ? "Сохранение…" : "Сохранить"}
            </Button>
            <input ref={fileRef} type="file" className="hidden" accept=".xlsx,.xls,.csv" onChange={onExcelChange} />
          </div>
        </CardHeader>
        <CardContent>
          {/* Summary tiles */}
          <div className="grid grid-cols-2 md:grid-cols-5 gap-3 mb-4">
            {/* Всего выдано предписаний */}
            <div className="card-elevated rounded p-3">
              <div className="text-xs text-muted-foreground">Всего выдано предписаний</div>
              <div className="text-2xl font-bold text-metric-brown">
                {rows.filter(r => (r.issuedActs ?? "").trim() !== "").length}
              </div>
            </div>
            {/* Выявлено замечаний */}
            <div className="card-elevated rounded p-3">
              <div className="text-xs text-muted-foreground">Выявлено замечаний</div>
              <div className="text-2xl font-bold text-metric-blue">
                {rows.reduce((sum, r) => sum + (Number(r.foundQty || 0) || 0), 0)}
              </div>
            </div>
            {/* Устранено */}
            <div className="card-elevated rounded p-3">
              <div className="text-xs text-muted-foreground">Устранено</div>
              <div className="text-2xl font-bold text-metric-green">
                {rows.reduce((sum, r) => sum + (Number(r.fixedQty || 0) || 0), 0)}
              </div>
            </div>
            {/* Замечаний в работе */}
            <div className="card-elevated rounded p-3">
              <div className="text-xs text-muted-foreground">Замечаний в работе</div>
              <div className="text-2xl font-bold text-metric-black">
                {rows.reduce((sum, r) => sum + (Number(r.inWorkQty || 0) || 0), 0)}
              </div>
            </div>
            {/* Просрочено замечаний */}
            <div className="card-elevated rounded p-3 blink-red-white">
              <div className="text-xs text-muted-foreground">Просрочено замечаний</div>
              <div className="text-2xl font-bold text-metric-red">
                {rows.reduce((sum, r) => sum + (Number(r.overdueQty || 0) || 0), 0)}
              </div>
            </div>
          </div>

          <div className="w-full overflow-auto">
            <table className="w-full border-collapse">
              <thead>
                <tr>
                  <th className="border px-2 py-1 text-left">№ в АСУБТ</th>
                  <th className="border px-2 py-1 text-left">№ документа</th>
                  <th className="border px-2 py-1 text-left">Выданные АКТы</th>
                  <th className="border px-2 py-1 text-left">Кол-во замечаний (Выявлено)</th>
                  <th className="border px-2 py-1 text-left">Кол-во замечаний (Устранено)</th>
                  <th className="border px-2 py-1 text-left">Кол-во замечаний (В работе не вышел срок)</th>
                  <th className="border px-2 py-1 text-left">Кол-во замечаний (ПРОСРОЧЕНО)</th>
                  <th className="border px-2 py-1 text-left">Подразделение</th>
                  <th className="border px-2 py-1 text-left">Ответственный</th>
                  <th className="border px-2 py-1 text-left">Статус</th>
                  <th className="border px-2 py-1 text-left">Дата проверки</th>
                  <th className="border px-2 py-1 text-left">Срок исполнения</th>
                  {Array.from({ length: extraColCount }).map((_, i) => (
                    <th key={i} className="border px-2 py-1 text-left">Доп. поле {i + 1}</th>
                  ))}
                  <th className="border px-2 py-1 text-left">Действия</th>
                </tr>
              </thead>
              <tbody>
                {rows.map((r) => (
                  <tr key={r.id}>
                    <td className="border px-1 py-1 min-w-[9rem]">
                      <Input value={r.asubtNumber} onChange={(e) => updateCell(r.id, "asubtNumber", e.target.value)} />
                    </td>
                    <td className="border px-1 py-1 min-w-[8rem]">
                      <Input value={r.docNumber} onChange={(e) => updateCell(r.id, "docNumber", e.target.value)} />
                    </td>
                    <td className="border px-1 py-1 min-w-[14rem]">
                      <Input value={r.issuedActs} onChange={(e) => updateCell(r.id, "issuedActs", e.target.value)} placeholder="Ссылка на документ или примечание" />
                    </td>
                    <td className="border px-1 py-1 min-w-[10rem]">
                      <Input type="number" value={r.foundQty} onChange={(e) => updateCell(r.id, "foundQty", e.target.value)} />
                    </td>
                    <td className="border px-1 py-1 min-w-[10rem]">
                      <Input type="number" value={r.fixedQty} onChange={(e) => updateCell(r.id, "fixedQty", e.target.value)} />
                    </td>
                    <td className="border px-1 py-1 min-w-[14rem]">
                      <Input type="number" value={r.inWorkQty} onChange={(e) => updateCell(r.id, "inWorkQty", e.target.value)} />
                    </td>
                    <td className="border px-1 py-1 min-w-[10rem]">
                      <Input type="number" value={r.overdueQty} onChange={(e) => updateCell(r.id, "overdueQty", e.target.value)} />
                    </td>
                    <td className="border px-1 py-1 min-w-[12rem]">
                      <Input value={r.department} onChange={(e) => updateCell(r.id, "department", e.target.value)} />
                    </td>
                    <td className="border px-1 py-1 min-w-[12rem]">
                      <Input value={r.responsible} onChange={(e) => updateCell(r.id, "responsible", e.target.value)} />
                    </td>
                    <td className="border px-1 py-1 min-w-[10rem]">
                      <Input value={r.status} onChange={(e) => updateCell(r.id, "status", e.target.value)} />
                    </td>
                    <td className="border px-1 py-1 min-w-[10rem]">
                      <Input type="date" value={r.checkDate} onChange={(e) => updateCell(r.id, "checkDate", e.target.value)} />
                    </td>
                    <td className="border px-1 py-1 min-w-[10rem]">
                      <Input type="date" value={r.dueDate} onChange={(e) => updateCell(r.id, "dueDate", e.target.value)} />
                    </td>
                    {Array.from({ length: extraColCount }).map((_, i) => (
                      <td key={i} className="border px-1 py-1 min-w-[10rem]">
                        <Input
                          value={(r.extra?.[i] ?? "")}
                          onChange={(e) => updateExtraCell(r.id, i, e.target.value)}
                        />
                      </td>
                    ))}
                    <td className="border px-1 py-1">
                      <Button variant="secondary" size="sm" onClick={() => removeRow(r.id)} disabled={rows.length === 1}>Удалить</Button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}

function AdminMedicineReportScreen() {
  const auth = useAuth({ required: true });
  const { data: me } = useQuery<Profile>(["me"], () => apiClient.getMyProfile());
  const isAdmin = !!me?.isAdmin;
  const queryClient = useQueryClient();
  const { toast } = useToast();

  const today = new Date();
  const defaultMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, "0")}`;
  const [month, setMonth] = React.useState(defaultMonth);

  const headerDates = React.useMemo(() => {
    const [yearStr, monthStr] = month.split("-");
    const year = Number(yearStr);
    const monthNum = Number(monthStr);
    if (!year || !monthNum) return [];
    const daysInMonth = new Date(year, monthNum, 0).getDate();
    const result: string[] = [];
    for (let day = 1; day <= daysInMonth; day++) {
      const dayStr = String(day).padStart(2, "0");
      const monthStrPadded = String(monthNum).padStart(2, "0");
      result.push(`${dayStr}.${monthStrPadded}.${year}`);
    }
    return result;
  }, [month]);

  type MedRow = {
    id: string;
    activity: string;
    values: string[];
    customDate: string;
    total: string;
  };

  const makeEmptyRow = React.useCallback(
    (): MedRow => ({
      id: crypto.randomUUID(),
      activity: "",
      values: Array(headerDates.length).fill(""),
      customDate: "",
      total: "",
    }),
    [headerDates.length],
  );

  const syncRowsWithHeader = React.useCallback(
    (inputRows: MedRow[], daysCount: number): MedRow[] =>
      inputRows.map((row) => {
        const values = [...(row.values ?? [])];
        if (values.length < daysCount) {
          values.push(...Array(daysCount - values.length).fill(""));
        } else if (values.length > daysCount) {
          values.length = daysCount;
        }
        return { ...row, values };
      }),
    [],
  );

  const [rows, setRows] = React.useState<MedRow[]>(() => [makeEmptyRow()]);

  const medQuery = useQuery(["medicine-report"], () => apiClient.getMedicineReport(), {
    staleTime: 60_000,
  });

  const arrayToRow = (a: string[]): MedRow => {
    const safe = (i: number) => (a?.[i] ?? "") as string;
    const activity = safe(0);
    const rest = (a ?? []).slice(1);
    let customDate = "";
    let total = "";
    let values: string[] = [];
    if (rest.length >= 2) {
      customDate = (rest[rest.length - 2] ?? "") as string;
      total = (rest[rest.length - 1] ?? "") as string;
      values = rest.slice(0, rest.length - 2).map((v) => (v ?? "") as string);
    } else {
      values = rest.map((v) => (v ?? "") as string);
    }
    return {
      id: crypto.randomUUID(),
      activity,
      values,
      customDate,
      total,
    };
  };

  const rowToArray = (r: MedRow): string[] => [
    r.activity,
    ...(r.values ?? []),
    r.customDate,
    r.total,
  ];

  React.useEffect(() => {
    const data = medQuery.data as { rows: string[][] } | undefined;
    if (data) {
      const mappedRaw = (data.rows ?? []).map((row) => arrayToRow(row));
      const baseRows = mappedRaw.length ? mappedRaw : [makeEmptyRow()];
      setRows(syncRowsWithHeader(baseRows, headerDates.length));
    }
  }, [medQuery.data, headerDates.length, makeEmptyRow, syncRowsWithHeader]);

  React.useEffect(() => {
    setRows((prev) => syncRowsWithHeader(prev, headerDates.length));
  }, [headerDates.length, syncRowsWithHeader]);

  const addRow = () => setRows((prev) => [...prev, makeEmptyRow()]);

  const updateRowField = (id: string, key: "activity" | "customDate" | "total", value: string) =>
    setRows((prev) => prev.map((r) => (r.id === id ? { ...r, [key]: value } : r)));

  const updateDayValue = (id: string, idx: number, value: string) =>
    setRows((prev) =>
      prev.map((r) =>
        r.id === id
          ? { ...r, values: Object.assign([], r.values ?? [], { [idx]: value }) as string[] }
          : r,
      ),
    );

  const removeRow = (id: string) => setRows((prev) => prev.filter((r) => r.id !== id));

  const saveMutation = useMutation(apiClient.saveMedicineReport, {
    onSuccess: () => {
      toast({ title: "Сохранено" });
      void queryClient.invalidateQueries(["medicine-report"]);
    },
    onError: () => {
      toast({ title: "Не удалось сохранить", description: "Попробуйте ещё раз" });
    },
  });

  const handleSave = () => {
    const payload = rows.map(rowToArray);
    saveMutation.mutate({ rows: payload });
  };

  const fileRef = React.useRef<HTMLInputElement>(null);
  const onPickExcel = () => fileRef.current?.click();

  const onExcelChange: React.ChangeEventHandler<HTMLInputElement> = async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    try {
      const buf = await file.arrayBuffer();
      const wb = XLSX.read(buf, { type: "array" });
      const sheet = wb.Sheets[wb.SheetNames[0]];
      const aoa = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false }) as (string | number | null)[][];
      const cleaned = aoa
        .map((row) => (row ?? []).map((v) => (v == null ? "" : String(v))))
        .filter((row) => row.some((v) => v && String(v).trim() !== ""));
      const rowsOnly = cleaned;
      const mapped = rowsOnly.map((r) => arrayToRow(r as string[]));
      const baseRows = mapped.length ? mapped : [makeEmptyRow()];
      setRows(syncRowsWithHeader(baseRows, headerDates.length));
      toast({ title: "Импорт завершён", description: `Строк: ${mapped.length}` });
    } catch {
      toast({ title: "Ошибка импорта", description: "Проверьте файл Excel" });
    } finally {
      if (fileRef.current) fileRef.current.value = "";
    }
  };

  if (!isAdmin) {
    return (
      <div className="max-w-6xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Доступ ограничен</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">Эта страница доступна только администраторам.</div>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="max-w-full mx-auto p-4 sm:p-6">
      <Card className="card-elevated">
          <CardHeader className="flex items-center justify-between gap-2">
          <CardTitle>Отчет по Медицине</CardTitle>
          <div className="flex flex-wrap items-center gap-2">
            <div className="flex items-center gap-2">
              <span className="text-sm text-muted-foreground">Месяц:</span>
              <Input
                type="month"
                className="w-[9.5rem]"
                value={month}
                onChange={(e) => setMonth(e.target.value || defaultMonth)}
              />
            </div>
            <Button variant="secondary" onClick={addRow}>Добавить строку</Button>
            <Button variant="outline" onClick={onPickExcel}>Импорт из Excel</Button>
            <Button onClick={() => medQuery.refetch()} variant="outline">Загрузить</Button>
            <Button onClick={handleSave} disabled={saveMutation.isLoading}>
              {saveMutation.isLoading ? "Сохранение…" : "Сохранить"}
            </Button>
            <input
              ref={fileRef}
              type="file"
              className="hidden"
              accept=".xlsx,.xls,.csv"
              onChange={onExcelChange}
            />
          </div>
        </CardHeader>
        <CardContent>
          <div className="w-full overflow-auto">
            <table className="w-full border-collapse">
              <thead>
                <tr>
                  <th className="border px-2 py-1 text-left whitespace-nowrap">
                    Деятельность медпунктов
                  </th>
                  {headerDates.map((d) => (
                    <th
                      key={d}
                      className="border px-2 py-1 text-center whitespace-nowrap"
                    >
                      {d}
                    </th>
                  ))}
                  <th className="border px-2 py-1 text-left whitespace-nowrap">дд.мм.год</th>
                  <th className="border px-2 py-1 text-left whitespace-nowrap">Итого</th>
                  <th className="border px-2 py-1 text-left">Действия</th>
                </tr>
              </thead>
              <tbody>
                {rows.map((r) => (
                  <tr key={r.id}>
                    <td className="border px-1 py-1 min-w-[16rem]">
                      <Input
                        value={r.activity}
                        onChange={(e) => updateRowField(r.id, "activity", e.target.value)}
                      />
                    </td>
                    {headerDates.map((_, idx) => (
                      <td key={idx} className="border px-1 py-1 min-w-[4rem]">
                        <Input
                          value={r.values?.[idx] ?? ""}
                          onChange={(e) => updateDayValue(r.id, idx, e.target.value)}
                        />
                      </td>
                    ))}
                    <td className="border px-1 py-1 min-w-[9rem]">
                      <Input
                        type="text"
                        placeholder="дд.мм.гггг"
                        value={r.customDate}
                        onChange={(e) => updateRowField(r.id, "customDate", e.target.value)}
                      />
                    </td>
                    <td className="border px-1 py-1 min-w-[6rem]">
                      <Input
                        value={r.total}
                        onChange={(e) => updateRowField(r.id, "total", e.target.value)}
                      />
                    </td>
                    <td className="border px-1 py-1">
                      <Button
                        variant="secondary"
                        size="sm"
                        onClick={() => removeRow(r.id)}
                        disabled={rows.length === 1}
                      >
                        Удалить
                      </Button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}

function AdminKBTScreen() {
  useAuth({ required: true });
  const { data: me, isInitialLoading } = useQuery<Profile>(["me"], () =>
    apiClient.getMyProfile(),
  );
  const navigate = useNavigate();
  const isAdmin = !!me?.isAdmin;
  const queryClient = useQueryClient();

  // Плановые собрания: период и загрузка
  type KbtMeetings = inferRPCOutputType<"listKbtMeetings">;
  const [from, setFrom] = useState<string>("");
  const [to, setTo] = useState<string>("");
  const { data: meetings, isInitialLoading: meetingsLoading } =
    useQuery<KbtMeetings>(
      ["kbt-meetings", from, to],
      () =>
        apiClient.listKbtMeetings({
          from: from || undefined,
          to: to || undefined,
          limit: 200,
          type: "PLAN",
        }),
      { enabled: isAdmin },
    );

  const starredPlanCount = React.useMemo(() => {
    const items = (meetings?.items ?? []) as Array<{ title: string }>;
    return items.filter((m) => (m.title || "").trim().startsWith("*")).length;
  }, [meetings]);

  // Количество плановых собраний без звёздочки (*)
  const nonStarPlanCount = React.useMemo(() => {
    const items = (meetings?.items ?? []) as Array<{ title: string }>;
    return items.filter((m) => !(m.title || "").trim().startsWith("*")).length;
  }, [meetings]);

  // Разбор нарушений/инцидентов
  const [fromInc, setFromInc] = useState<string>("");
  const [toInc, setToInc] = useState<string>("");
  const { data: incidents, isInitialLoading: incidentsLoading } =
    useQuery<KbtMeetings>(
      ["kbt-incidents", fromInc, toInc],
      () =>
        apiClient.listKbtMeetings({
          from: fromInc || undefined,
          to: toInc || undefined,
          limit: 200,
          type: "INCIDENT",
        }),
      { enabled: isAdmin },
    );

  if (isInitialLoading) {
    return (
      <div className="max-w-4xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Загрузка…</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Проверяем статус доступа.
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  if (!me?.isAdmin) {
    return (
      <div className="max-w-4xl mx-auto p-4 sm:p-6">
        <Card className="card-elevated h-full">
          <CardHeader>
            <CardTitle>Доступ ограничен</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-muted-foreground">
              Раздел доступен только администраторам.
            </div>
          </CardContent>
          <CardFooter>
            <Button variant="secondary" onClick={() => navigate("/admin")}>
              К админ-панели
            </Button>
          </CardFooter>
        </Card>
      </div>
    );
  }

  return (
    <div className="max-w-5xl mx-auto p-4 sm:p-6 space-y-4">
      <Card className="card-elevated h-full">
        <CardHeader>
          <CardTitle>Данные по КБТ</CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="text-muted-foreground">
            Здесь будут сводные данные и управление разделом КБТ. Сообщите,
            какие показатели и выгрузки нужны — добавим.
          </div>

          {/* Плановые собрания */}
          <div className="space-y-3">
            <div className="text-base font-semibold">Плановые собрания</div>
            <div className="flex flex-wrap gap-2 items-end">
              <div className="grid gap-1">
                <Label>Период с</Label>
                <Input
                  type="date"
                  value={from}
                  onChange={(e) => setFrom(e.target.value)}
                />
              </div>
              <div className="grid gap-1">
                <Label>Период по</Label>
                <Input
                  type="date"
                  value={to}
                  onChange={(e) => setTo(e.target.value)}
                />
              </div>
            </div>

            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
              <div className="p-3 border rounded">
                <div className="text-xs text-muted-foreground">
                  Количество проведенных собраний
                </div>
                <div className="text-2xl font-semibold">
                  {meetingsLoading ? "…" : (meetings?.total ?? 0)}
                </div>
              </div>
              <div className="p-3 border rounded">
                <div className="text-xs text-muted-foreground">
                  Нарушения/инциденты
                </div>
                <div className="text-2xl font-semibold">
                  {meetingsLoading ? "…" : starredPlanCount}
                </div>
              </div>
              <div className="p-3 border rounded">
                <div className="text-xs text-muted-foreground">
                  Кол-во плановых собраний
                </div>
                <div className="text-2xl font-semibold">
                  {meetingsLoading ? "…" : nonStarPlanCount}
                </div>
              </div>
            </div>

            <div className="border rounded-md overflow-x-auto">
              <Table>
                <TableHeader>
                  <TableRow>
                    <TableHead>Наименование темы</TableHead>
                    <TableHead>Дата проведения</TableHead>
                    {isAdmin && <TableHead>Действия</TableHead>}
                  </TableRow>
                </TableHeader>
                <TableBody>
                  {meetingsLoading && (
                    <TableRow>
                      <TableCell
                        colSpan={isAdmin ? 3 : 2}
                        className="text-sm text-muted-foreground"
                      >
                        Загрузка…
                      </TableCell>
                    </TableRow>
                  )}
                  {!meetingsLoading &&
                    (!meetings?.items || meetings.items.length === 0) && (
                      <TableRow>
                        <TableCell
                          colSpan={isAdmin ? 3 : 2}
                          className="text-sm text-muted-foreground"
                        >
                          Нет данных
                        </TableCell>
                      </TableRow>
                    )}
                  {meetings?.items?.map((m) => (
                    <EditableKbtMeetingRow
                      key={m.id}
                      meeting={m as any}
                      onSaved={() =>
                        queryClient.invalidateQueries({
                          queryKey: ["kbt-meetings"],
                        })
                      }
                    />
                  ))}
                </TableBody>
              </Table>
            </div>

            {/* Разбор нарушений/инцидентов */}
            <div className="hr-muted w-full h-px" />
            <div className="space-y-3">
              <div className="text-base font-semibold">
                Разбор нарушений/инцидентов
              </div>
              <div className="flex flex-wrap gap-2 items-end">
                <div className="grid gap-1">
                  <Label>Период с</Label>
                  <Input
                    type="date"
                    value={fromInc}
                    onChange={(e) => setFromInc(e.target.value)}
                  />
                </div>
                <div className="grid gap-1">
                  <Label>Период по</Label>
                  <Input
                    type="date"
                    value={toInc}
                    onChange={(e) => setToInc(e.target.value)}
                  />
                </div>
              </div>

              <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                <div className="p-3 border rounded">
                  <div className="text-xs text-muted-foreground">
                    Количество разборов
                  </div>
                  <div className="text-2xl font-semibold">
                    {incidentsLoading ? "…" : (incidents?.total ?? 0)}
                  </div>
                </div>
                <div className="p-3 border rounded">
                  <div className="text-xs text-muted-foreground">
                    Всего разборов
                  </div>
                  <div className="text-2xl font-semibold">
                    {incidentsLoading ? "…" : (incidents?.grandTotal ?? 0)}
                  </div>
                </div>
              </div>

              <div className="border rounded-md overflow-x-auto">
                <Table>
                  <TableHeader>
                    <TableRow>
                      <TableHead>Наименование темы</TableHead>
                      <TableHead>Дата проведения</TableHead>
                    </TableRow>
                  </TableHeader>
                  <TableBody>
                    {incidentsLoading && (
                      <TableRow>
                        <TableCell
                          colSpan={2}
                          className="text-sm text-muted-foreground"
                        >
                          Загрузка…
                        </TableCell>
                      </TableRow>
                    )}
                    {!incidentsLoading &&
                      (!incidents?.items || incidents.items.length === 0) && (
                        <TableRow>
                          <TableCell
                            colSpan={2}
                            className="text-sm text-muted-foreground"
                          >
                            Нет данных
                          </TableCell>
                        </TableRow>
                      )}
                    {incidents?.items?.map((m) => (
                      <TableRow key={m.id}>
                        <TableCell className="min-w-[260px]">
                          {m.title}
                        </TableCell>
                        <TableCell className="min-w-[160px]">
                          {new Date(m.date as any).toLocaleDateString("ru-RU")}
                        </TableCell>
                      </TableRow>
                    ))}
                  </TableBody>
                </Table>
              </div>
            </div>
          </div>
          {isAdmin && (
            <CreateKbtMeetingForm
              onCreated={() =>
                queryClient.invalidateQueries({ queryKey: ["kbt-meetings"] })
              }
            />
          )}
        </CardContent>
        <CardFooter>
          <Button variant="secondary" onClick={() => navigate("/admin")}>
            К админ-панели
          </Button>
        </CardFooter>
      </Card>
    </div>
  );
}
